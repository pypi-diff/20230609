# Comparing `tmp/distributed-2023.5.1.tar.gz` & `tmp/distributed-2023.6.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2023.5.1.tar", last modified: Fri May 26 20:09:35 2023, max compression
+gzip compressed data, was "distributed-2023.6.0.tar", last modified: Fri Jun  9 16:34:14 2023, max compression
```

## Comparing `distributed-2023.5.1.tar` & `distributed-2023.6.0.tar`

### file list

```diff
@@ -1,295 +1,296 @@
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.757368 distributed-2023.5.1/
--rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.5.1/AUTHORS.md
--rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.5.1/LICENSE.txt
--rw-r--r--   0 james      (501) staff       (20)      633 2023-04-26 17:04:39.000000 distributed-2023.5.1/MANIFEST.in
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-05-26 20:09:35.756573 distributed-2023.5.1/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.5.1/README.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.758180 distributed-2023.5.1/distributed/
--rw-r--r--   0 james      (501) staff       (20)     4219 2023-05-24 16:57:27.000000 distributed-2023.5.1/distributed/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/_signals.py
--rw-r--r--   0 james      (501) staff       (20)     1399 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/_stories.py
--rw-r--r--   0 james      (501) staff       (20)      500 2023-05-26 20:09:35.758339 distributed-2023.5.1/distributed/_version.py
--rw-r--r--   0 james      (501) staff       (20)    29243 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/active_memory_manager.py
--rw-r--r--   0 james      (501) staff       (20)    10564 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/actor.py
--rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/batched.py
--rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/bokeh.py
--rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/cfexecutor.py
--rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/chaos.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.560457 distributed-2023.5.1/distributed/cli/
--rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.5.1/distributed/cli/__init__.py
--rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_scheduler.py
--rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_spec.py
--rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/cli/dask_worker.py
--rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/cli/utils.py
--rw-r--r--   0 james      (501) staff       (20)   202329 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/client.py
--rw-r--r--   0 james      (501) staff       (20)    10960 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     6673 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/collections.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.568374 distributed-2023.5.1/distributed/comm/
--rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/comm/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/comm/addressing.py
--rw-r--r--   0 james      (501) staff       (20)    37224 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/comm/asyncio_tcp.py
--rw-r--r--   0 james      (501) staff       (20)    13369 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/core.py
--rw-r--r--   0 james      (501) staff       (20)    10321 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/inproc.py
--rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.5.1/distributed/comm/registry.py
--rw-r--r--   0 james      (501) staff       (20)    24054 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/comm/tcp.py
--rw-r--r--   0 james      (501) staff       (20)    22962 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/ucx.py
--rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/comm/utils.py
--rw-r--r--   0 james      (501) staff       (20)    14868 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/comm/ws.py
--rw-r--r--   0 james      (501) staff       (20)     7416 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/compatibility.py
--rw-r--r--   0 james      (501) staff       (20)     7357 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/config.py
--rw-r--r--   0 james      (501) staff       (20)    59300 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/core.py
--rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/counter.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.577285 distributed-2023.5.1/distributed/dashboard/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.5.1/distributed/dashboard/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.581170 distributed-2023.5.1/distributed/dashboard/components/
--rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/components/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/dashboard/components/nvml.py
--rw-r--r--   0 james      (501) staff       (20)     7055 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/dashboard/components/rmm.py
--rw-r--r--   0 james      (501) staff       (20)   158511 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/components/shared.py
--rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/components/worker.py
--rw-r--r--   0 james      (501) staff       (20)     1786 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/dashboard/core.py
--rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.5.1/distributed/dashboard/export_tool.js
--rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/export_tool.py
--rw-r--r--   0 james      (501) staff       (20)     5834 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.582298 distributed-2023.5.1/distributed/dashboard/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.5.1/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/dashboard/theme.yaml
--rw-r--r--   0 james      (501) staff       (20)     1668 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/dashboard/utils.py
--rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/dashboard/worker.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.588305 distributed-2023.5.1/distributed/deploy/
--rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/deploy/adaptive.py
--rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/adaptive_core.py
--rw-r--r--   0 james      (501) staff       (20)    21248 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/deploy/cluster.py
--rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/local.py
--rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/deploy/old_ssh.py
--rw-r--r--   0 james      (501) staff       (20)    23732 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/deploy/spec.py
--rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/deploy/ssh.py
--rw-r--r--   0 james      (501) staff       (20)     7656 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/deploy/subprocess.py
--rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/deploy/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.597620 distributed-2023.5.1/distributed/diagnostics/
--rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/eventstream.py
--rw-r--r--   0 james      (501) staff       (20)     4994 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 james      (501) staff       (20)     6972 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/nvml.py
--rw-r--r--   0 james      (501) staff       (20)    28172 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/diagnostics/plugin.py
--rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/progress.py
--rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.5.1/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/progressbar.py
--rw-r--r--   0 james      (501) staff       (20)     1124 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/diagnostics/rmm.py
--rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diagnostics/task_stream.py
--rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/diagnostics/websocket.py
--rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/diskutils.py
--rw-r--r--   0 james      (501) staff       (20)    46226 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/distributed-schema.yaml
--rw-r--r--   0 james      (501) staff       (20)    14146 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/distributed.yaml
--rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/event.py
--rw-r--r--   0 james      (501) staff       (20)      586 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/exceptions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.601567 distributed-2023.5.1/distributed/http/
--rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/health.py
--rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/prometheus.py
--rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/proxy.py
--rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/routing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.604606 distributed-2023.5.1/distributed/http/scheduler/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/scheduler/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2899 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/api.py
--rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/scheduler/info.py
--rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/scheduler/json.py
--rw-r--r--   0 james      (501) staff       (20)      625 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.606899 distributed-2023.5.1/distributed/http/scheduler/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.607854 distributed-2023.5.1/distributed/http/static/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.613916 distributed-2023.5.1/distributed/http/static/css/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/css/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/static/css/base.css
--rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.5.1/distributed/http/static/css/gpu.css
--rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/css/status.css
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.624224 distributed-2023.5.1/distributed/http/static/images/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/images/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/static/images/favicon.ico
--rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/numpy.png
--rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/pandas.png
--rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/http/static/images/python.png
--rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.630625 distributed-2023.5.1/distributed/http/static/js/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/static/js/__init__.py
--rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/anime.min.js
--rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/statics.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.645655 distributed-2023.5.1/distributed/http/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/http/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/http/templates/base.html
--rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/call-stack.html
--rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/exceptions.html
--rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.5.1/distributed/http/templates/gpu.html
--rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/json-index.html
--rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/logs.html
--rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/main.html
--rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/simple.html
--rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.5.1/distributed/http/templates/status.html
--rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/task.html
--rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/worker-table.html
--rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/templates/worker.html
--rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/templates/workers.html
--rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/http/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.646769 distributed-2023.5.1/distributed/http/worker/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.5.1/distributed/http/worker/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.647758 distributed-2023.5.1/distributed/http/worker/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.5.1/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     9973 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/lock.py
--rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/metrics.py
--rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/multi_lock.py
--rw-r--r--   0 james      (501) staff       (20)    33721 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/nanny.py
--rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/node.py
--rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/objects.py
--rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/preloading.py
--rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/process.py
--rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/proctitle.py
--rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/profile.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.659565 distributed-2023.5.1/distributed/protocol/
--rw-r--r--   0 james      (501) staff       (20)     3363 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/protocol/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/arrow.py
--rw-r--r--   0 james      (501) staff       (20)     6671 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/protocol/compression.py
--rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/core.py
--rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/cuda.py
--rw-r--r--   0 james      (501) staff       (20)     2945 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/protocol/cupy.py
--rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/h5py.py
--rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/keras.py
--rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/netcdf4.py
--rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/numba.py
--rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/numpy.py
--rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/pickle.py
--rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/rmm.py
--rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/scipy.py
--rw-r--r--   0 james      (501) staff       (20)    29121 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/protocol/serialize.py
--rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/protocol/sparse.py
--rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/torch.py
--rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/protocol/utils.py
--rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/publish.py
--rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/pubsub.py
--rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/py.typed
--rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/queues.py
--rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/recreate_tasks.py
--rw-r--r--   0 james      (501) staff       (20)   302645 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/security.py
--rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/semaphore.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.666310 distributed-2023.5.1/distributed/shuffle/
--rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2948 2023-05-15 17:01:30.000000 distributed-2023.5.1/distributed/shuffle/_arrow.py
--rw-r--r--   0 james      (501) staff       (20)     9206 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_buffer.py
--rw-r--r--   0 james      (501) staff       (20)     2526 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_comms.py
--rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/_disk.py
--rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/shuffle/_limiter.py
--rw-r--r--   0 james      (501) staff       (20)    11881 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_merge.py
--rw-r--r--   0 james      (501) staff       (20)     6012 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_rechunk.py
--rw-r--r--   0 james      (501) staff       (20)    12861 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_scheduler_extension.py
--rw-r--r--   0 james      (501) staff       (20)     8209 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_shuffle.py
--rw-r--r--   0 james      (501) staff       (20)    34047 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/shuffle/_worker_extension.py
--rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/sizeof.py
--rw-r--r--   0 james      (501) staff       (20)    13519 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/spill.py
--rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/stealing.py
--rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.5.1/distributed/system.py
--rw-r--r--   0 james      (501) staff       (20)     8532 2023-04-28 16:00:56.000000 distributed-2023.5.1/distributed/system_monitor.py
--rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/threadpoolexecutor.py
--rw-r--r--   0 james      (501) staff       (20)    55458 2023-04-26 17:04:43.000000 distributed-2023.5.1/distributed/utils.py
--rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/utils_comm.py
--rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/utils_perf.py
--rw-r--r--   0 james      (501) staff       (20)    80577 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/utils_test.py
--rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.5.1/distributed/variable.py
--rw-r--r--   0 james      (501) staff       (20)     5165 2023-05-19 17:56:01.000000 distributed-2023.5.1/distributed/versions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.668135 distributed-2023.5.1/distributed/widgets/
--rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/widgets/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.680771 distributed-2023.5.1/distributed/widgets/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-05-15 17:01:34.000000 distributed-2023.5.1/distributed/widgets/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.5.1/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1270 2023-04-26 17:04:39.000000 distributed-2023.5.1/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.5.1/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.5.1/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)   124896 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker.py
--rw-r--r--   0 james      (501) staff       (20)     2276 2023-04-25 18:34:44.000000 distributed-2023.5.1/distributed/worker_client.py
--rw-r--r--   0 james      (501) staff       (20)    21215 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker_memory.py
--rw-r--r--   0 james      (501) staff       (20)   141499 2023-05-26 15:20:04.000000 distributed-2023.5.1/distributed/worker_state_machine.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.556642 distributed-2023.5.1/distributed.egg-info/
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     8573 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 james      (501) staff       (20)      335 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/entry_points.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-05-26 20:09:33.000000 distributed-2023.5.1/distributed.egg-info/not-zip-safe
--rw-r--r--   0 james      (501) staff       (20)      227 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/requires.txt
--rw-r--r--   0 james      (501) staff       (20)       12 2023-05-26 20:09:35.000000 distributed-2023.5.1/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.491740 distributed-2023.5.1/docs/
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.753828 distributed-2023.5.1/docs/source/
--rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.5.1/docs/source/active_memory_manager.rst
--rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/actors.rst
--rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/api.rst
--rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/asynchronous.rst
--rw-r--r--   0 james      (501) staff       (20)   256075 2023-05-26 19:56:59.000000 distributed-2023.5.1/docs/source/changelog.rst
--rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.5.1/docs/source/client.rst
--rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/communications.rst
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-05-26 15:20:04.000000 distributed-2023.5.1/docs/source/develop.rst
--rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/diagnosing-performance.rst
--rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/efficiency.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-05-26 20:09:35.755231 distributed-2023.5.1/docs/source/examples/
--rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/examples/word-count.rst
--rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.5.1/docs/source/examples-overview.rst
--rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/faq.rst
--rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/foundations.rst
--rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/http_services.rst
--rw-r--r--   0 james      (501) staff       (20)     4423 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/index.rst
--rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.5.1/docs/source/install.rst
--rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/journey.rst
--rw-r--r--   0 james      (501) staff       (20)     6470 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/killed.rst
--rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/limitations.rst
--rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/locality.rst
--rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/logging.rst
--rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.5.1/docs/source/manage-computation.rst
--rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/memory.rst
--rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.5.1/docs/source/plugins.rst
--rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.5.1/docs/source/priority.rst
--rw-r--r--   0 james      (501) staff       (20)     7481 2023-04-26 17:04:39.000000 distributed-2023.5.1/docs/source/prometheus.rst
--rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/protocol.rst
--rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.5.1/docs/source/publish.rst
--rw-r--r--   0 james      (501) staff       (20)      402 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/queues.rst
--rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/quickstart.rst
--rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/related-work.rst
--rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/resilience.rst
--rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/resources.rst
--rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/scheduling-policies.rst
--rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.5.1/docs/source/scheduling-state.rst
--rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/serialization.rst
--rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.5.1/docs/source/task-launch.rst
--rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/tls.rst
--rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.5.1/docs/source/work-stealing.rst
--rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/worker-memory.rst
--rw-r--r--   0 james      (501) staff       (20)    22542 2023-04-25 18:34:44.000000 distributed-2023.5.1/docs/source/worker-state.rst
--rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.5.1/docs/source/worker.rst
--rw-r--r--   0 james      (501) staff       (20)     8925 2023-05-26 19:52:47.000000 distributed-2023.5.1/pyproject.toml
--rw-r--r--   0 james      (501) staff       (20)       38 2023-05-26 20:09:35.757557 distributed-2023.5.1/setup.cfg
--rw-r--r--   0 james      (501) staff       (20)      171 2023-04-26 17:04:39.000000 distributed-2023.5.1/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.909867 distributed-2023.6.0/
+-rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.6.0/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.6.0/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-06-02 19:58:01.000000 distributed-2023.6.0/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-09 16:34:14.909329 distributed-2023.6.0/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.6.0/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.910571 distributed-2023.6.0/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4219 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1399 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2023-06-09 16:34:14.910730 distributed-2023.6.0/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29196 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)    10564 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.736356 distributed-2023.6.0/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.6.0/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   203544 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10960 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     6673 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.742392 distributed-2023.6.0/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    37224 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/comm/asyncio_tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    13369 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10321 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.6.0/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    24054 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    22962 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14868 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)     7416 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7357 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    59300 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.748884 distributed-2023.6.0/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.6.0/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.752977 distributed-2023.6.0/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7055 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   160410 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1786 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.6.0/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5834 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.754042 distributed-2023.6.0/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.6.0/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1668 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.759480 distributed-2023.6.0/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21248 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23732 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     7656 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.767274 distributed-2023.6.0/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     4994 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     6913 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    28291 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.6.0/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    46226 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    14146 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.771150 distributed-2023.6.0/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.774801 distributed-2023.6.0/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2899 2023-06-07 19:06:41.000000 distributed-2023.6.0/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.777066 distributed-2023.6.0/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:06:41.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.778130 distributed-2023.6.0/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.784026 distributed-2023.6.0/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.6.0/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.793149 distributed-2023.6.0/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.802015 distributed-2023.6.0/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.816461 distributed-2023.6.0/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.6.0/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.6.0/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.817537 distributed-2023.6.0/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.6.0/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.818494 distributed-2023.6.0/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.6.0/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     9973 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    12252 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    33721 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.829905 distributed-2023.6.0/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3363 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2931 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    29121 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   304785 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.836836 distributed-2023.6.0/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2575 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9206 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2526 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)    12505 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     6012 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    12715 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_scheduler_extension.py
+-rw-r--r--   0 james      (501) staff       (20)     8462 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    33727 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/shuffle/_worker_extension.py
+-rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    15106 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/spans.py
+-rw-r--r--   0 james      (501) staff       (20)    13519 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.6.0/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8532 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    55458 2023-06-07 19:11:17.000000 distributed-2023.6.0/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.6.0/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    81119 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.6.0/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.837731 distributed-2023.6.0/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.852653 distributed-2023.6.0/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.6.0/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-06-02 19:58:01.000000 distributed-2023.6.0/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.6.0/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.6.0/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   125799 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2568 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21215 2023-06-07 19:29:49.000000 distributed-2023.6.0/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   142040 2023-06-09 16:15:56.000000 distributed-2023.6.0/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.733047 distributed-2023.6.0/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8594 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-06-09 16:34:13.000000 distributed-2023.6.0/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2023-06-09 16:34:14.000000 distributed-2023.6.0/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.683792 distributed-2023.6.0/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.906831 distributed-2023.6.0/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.6.0/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   257884 2023-06-09 16:24:48.000000 distributed-2023.6.0/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.6.0/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:29:49.000000 distributed-2023.6.0/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-06-09 16:34:14.908466 distributed-2023.6.0/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.6.0/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4423 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.6.0/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.6.0/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.6.0/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.6.0/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7481 2023-06-07 19:06:41.000000 distributed-2023.6.0/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.6.0/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.6.0/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.6.0/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.6.0/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.6.0/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-06-02 19:58:01.000000 distributed-2023.6.0/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.6.0/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)     8950 2023-06-09 16:25:53.000000 distributed-2023.6.0/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2023-06-09 16:34:14.910036 distributed-2023.6.0/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-06-02 19:58:01.000000 distributed-2023.6.0/setup.py
```

### Comparing `distributed-2023.5.1/LICENSE.txt` & `distributed-2023.6.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/MANIFEST.in` & `distributed-2023.6.0/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/PKG-INFO` & `distributed-2023.6.0/PKG-INFO`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.5.1
+Version: 2023.6.0
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.5.1/README.rst` & `distributed-2023.6.0/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/__init__.py` & `distributed-2023.6.0/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/_concurrent_futures_thread.py` & `distributed-2023.6.0/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/_signals.py` & `distributed-2023.6.0/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/_stories.py` & `distributed-2023.6.0/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/active_memory_manager.py` & `distributed-2023.6.0/distributed/active_memory_manager.py`

 * *Files 0% similar despite different names*

```diff
@@ -104,15 +104,14 @@
             raise ValueError(
                 "distributed.scheduler.active-memory-manager.measure "
                 "must be one of " + ", ".join(sorted(measure_domain))
             )
         self.measure = measure
 
         if register:
-            scheduler.extensions["amm"] = self
             scheduler.handlers["amm_handler"] = self.amm_handler
 
         if interval is None:
             interval = parse_timedelta(
                 dask.config.get("distributed.scheduler.active-memory-manager.interval")
             )
         self.interval = interval
```

### Comparing `distributed-2023.5.1/distributed/actor.py` & `distributed-2023.6.0/distributed/actor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/batched.py` & `distributed-2023.6.0/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cfexecutor.py` & `distributed-2023.6.0/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/chaos.py` & `distributed-2023.6.0/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cli/dask_scheduler.py` & `distributed-2023.6.0/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cli/dask_spec.py` & `distributed-2023.6.0/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cli/dask_ssh.py` & `distributed-2023.6.0/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cli/dask_worker.py` & `distributed-2023.6.0/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/cli/utils.py` & `distributed-2023.6.0/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/client.py` & `distributed-2023.6.0/distributed/client.py`

 * *Files 1% similar despite different names*

```diff
@@ -21,15 +21,15 @@
 from concurrent.futures._base import DoneAndNotDoneFutures
 from contextlib import asynccontextmanager, contextmanager, suppress
 from contextvars import ContextVar
 from functools import partial
 from importlib.metadata import PackageNotFoundError, version
 from numbers import Number
 from queue import Queue as pyQueue
-from typing import Any, ClassVar, Literal, TypedDict
+from typing import Any, ClassVar, Literal, NamedTuple, TypedDict
 
 from packaging.version import parse as parse_version
 from tlz import first, groupby, keymap, merge, partition_all, valmap
 
 import dask
 from dask.base import collections_to_dsk, normalize_token, tokenize
 from dask.core import flatten
@@ -44,15 +44,15 @@
     stringify,
     typename,
 )
 from dask.widgets import get_template
 
 from distributed.core import ErrorMessage
 from distributed.protocol.serialize import _is_dumpable
-from distributed.utils import wait_for
+from distributed.utils import Deadline, wait_for
 
 try:
     from dask.delayed import single_key
 except ImportError:
     single_key = first
 from tornado import gen
 from tornado.ioloop import IOLoop
@@ -126,14 +126,21 @@
 DEFAULT_EXTENSIONS = {
     "pubsub": PubSubClientExtension,
 }
 
 TOPIC_PREFIX_FORWARDED_LOG_RECORD = "forwarded-log-record"
 
 
+class SourceCode(NamedTuple):
+    code: str
+    lineno_frame: int
+    lineno_relative: int
+    filename: str
+
+
 def _get_global_client() -> Client | None:
     c = _current_client.get()
     if c:
         return c
     L = sorted(list(_global_clients), reverse=True)
     for k in L:
         c = _global_clients[k]
@@ -2350,17 +2357,17 @@
                 "Dask no longer supports gathering over Iterators and Queues. "
                 "Consider using a normal for loop and Client.submit/gather"
             )
 
         elif isinstance(futures, Iterator):
             return (self.gather(f, errors=errors, direct=direct) for f in futures)
         else:
-            if hasattr(thread_state, "execution_state"):  # within worker task
-                local_worker = thread_state.execution_state["worker"]
-            else:
+            try:
+                local_worker = get_worker()
+            except ValueError:
                 local_worker = None
             return self.sync(
                 self._gather,
                 futures,
                 errors=errors,
                 direct=direct,
                 local_worker=local_worker,
@@ -2575,17 +2582,17 @@
             timeout = self._timeout
         if isinstance(data, pyQueue) or isinstance(data, Iterator):
             raise TypeError(
                 "Dask no longer supports mapping over Iterators or Queues."
                 "Consider using a normal for loop and Client.submit"
             )
 
-        if hasattr(thread_state, "execution_state"):  # within worker task
-            local_worker = thread_state.execution_state["worker"]
-        else:
+        try:
+            local_worker = get_worker()
+        except ValueError:
             local_worker = None
         return self.sync(
             self._scatter,
             data,
             workers=workers,
             broadcast=broadcast,
             direct=direct,
@@ -2988,15 +2995,15 @@
             on_error=on_error,
             **kwargs,
         )
 
     @staticmethod
     def _get_computation_code(
         stacklevel: int | None = None, nframes: int = 1
-    ) -> tuple[str, ...]:
+    ) -> tuple[SourceCode, ...]:
         """Walk up the stack to the user code and extract the code surrounding
         the compute/submit/persist call. All modules encountered which are
         ignored through the option
         `distributed.diagnostics.computations.ignore-modules` will be ignored.
         This can be used to exclude commonly used libraries which wrap
         dask/distributed compute calls.
 
@@ -3017,35 +3024,44 @@
         if stacklevel is None:
             if ignore_modules:
                 pattern = re.compile("|".join([f"(?:{mod})" for mod in ignore_modules]))
         else:
             # stacklevel 0 or less - shows dask internals which likely isn't helpful
             stacklevel = stacklevel if stacklevel > 0 else 1
 
-        code: list[str] = []
-        for i, (fr, _) in enumerate(traceback.walk_stack(sys._getframe().f_back), 1):
+        code: list[SourceCode] = []
+        for i, (fr, lineno_frame) in enumerate(
+            traceback.walk_stack(sys._getframe().f_back), 1
+        ):
             if len(code) >= nframes:
                 break
             elif stacklevel is not None and i != stacklevel:
                 continue
             elif pattern is not None and (
                 pattern.match(fr.f_globals.get("__name__", ""))
                 or fr.f_code.co_name in ("<listcomp>", "<dictcomp>")
             ):
                 continue
+
+            kwargs = dict(
+                lineno_frame=lineno_frame,
+                lineno_relative=lineno_frame - fr.f_code.co_firstlineno,
+                filename=fr.f_code.co_filename,
+            )
+
             try:
-                code.append(inspect.getsource(fr))
+                code.append(SourceCode(code=inspect.getsource(fr), **kwargs))  # type: ignore
             except OSError:
                 try:
                     from IPython import get_ipython
 
                     ip = get_ipython()
                     if ip is not None:
                         # The current cell
-                        code.append(ip.history_manager._i00)
+                        code.append(SourceCode(code=ip.history_manager._i00, **kwargs))  # type: ignore
                 except ImportError:
                     pass  # No IPython
 
                 break
 
             # Ignore IPython related wrapping functions to user code
             if hasattr(fr.f_back, "f_globals"):
@@ -3107,29 +3123,29 @@
             nbytes = len(header) + sum(map(len, frames))
             if nbytes > 10_000_000:
                 warnings.warn(
                     f"Sending large graph of size {format_bytes(nbytes)}.\n"
                     "This may cause some slowdown.\n"
                     "Consider scattering data ahead of time and using futures."
                 )
+
+            computations = self._get_computation_code(
+                nframes=dask.config.get("distributed.diagnostics.computations.nframes")
+            )
             self._send_to_scheduler(
                 {
                     "op": "update-graph",
                     "graph_header": header,
                     "graph_frames": frames,
                     "keys": list(map(stringify, keys)),
                     "internal_priority": internal_priority,
                     "submitting_task": getattr(thread_state, "key", None),
                     "fifo_timeout": fifo_timeout,
                     "actors": actors,
-                    "code": self._get_computation_code(
-                        nframes=dask.config.get(
-                            "distributed.diagnostics.computations.nframes"
-                        )
-                    ),
+                    "code": ToPickle(computations),
                     "annotations": ToPickle(annotations),
                 }
             )
             return futures
 
     def get(
         self,
@@ -3710,45 +3726,46 @@
 
             return len(dask_worker.data[key])
 
         response = await self._run(dump_to_file)
 
         assert all(len(data) == v for v in response.values())
 
-    def upload_file(self, filename, **kwargs):
-        """Upload local package to workers
+    def upload_file(self, filename, load: bool = True):
+        """Upload local package to scheduler and workers
 
-        This sends a local file up to all worker nodes.  This file is placed
-        into the working directory of the running worker, see config option
+        This sends a local file up to the scheduler and all worker nodes.
+        This file is placed into the working directory of each node, see config option
         ``temporary-directory`` (defaults to :py:func:`tempfile.gettempdir`).
 
-        This directory will be added to the Python's system path so any .py,
-        .egg or .zip  files will be importable.
+        This directory will be added to the Python's system path so any ``.py``,
+        ``.egg`` or ``.zip``  files will be importable.
 
         Parameters
         ----------
         filename : string
-            Filename of .py, .egg or .zip file to send to workers
-        **kwargs : dict
-            Optional keyword arguments for the function
+            Filename of ``.py``, ``.egg``, or ``.zip`` file to send to workers
+        load : bool, optional
+            Whether or not to import the module as part of the upload process.
+            Defaults to ``True``.
 
         Examples
         --------
         >>> client.upload_file('mylibrary.egg')  # doctest: +SKIP
         >>> from mylibrary import myfunc  # doctest: +SKIP
         >>> L = client.map(myfunc, seq)  # doctest: +SKIP
         """
         name = filename + str(uuid.uuid4())
 
         async def _():
             results = await asyncio.gather(
                 self.register_scheduler_plugin(
-                    SchedulerUploadFile(filename), name=name
+                    SchedulerUploadFile(filename, load=load), name=name
                 ),
-                self.register_worker_plugin(UploadFile(filename), name=name),
+                self.register_worker_plugin(UploadFile(filename, load=load), name=name),
             )
             return results[1]  # Results from workers upload
 
         return self.sync(_)
 
     async def _rebalance(self, futures=None, workers=None):
         if futures is not None:
@@ -5233,18 +5250,24 @@
     Parameters
     ----------
     futures: Collection of futures
         A list of Future objects to be iterated over in the order in which they
         complete
     with_results: bool (False)
         Whether to wait and include results of futures as well;
-        in this case `as_completed` yields a tuple of (future, result)
+        in this case ``as_completed`` yields a tuple of (future, result)
     raise_errors: bool (True)
         Whether we should raise when the result of a future raises an
-        exception; only affects behavior when `with_results=True`.
+        exception; only affects behavior when ``with_results=True``.
+    timeout: int (optional)
+        The returned iterator raises a ``dask.distributed.TimeoutError``
+        if ``__next__()`` or ``__anext__()`` is called and the result
+        isn't available after timeout seconds from the original call to
+        ``as_completed()``. If timeout is not specified or ``None``, there is no limit
+        to the wait time.
 
     Examples
     --------
     >>> x, y, z = client.map(inc, [1, 2, 3])  # doctest: +SKIP
     >>> for future in as_completed([x, y, z]):  # doctest: +SKIP
     ...     print(future.result())  # doctest: +SKIP
     3
@@ -5273,24 +5296,33 @@
     >>> for future, result in ac:  # doctest: +SKIP
     ...     print(result)  # doctest: +SKIP
     2
     4
     3
     """
 
-    def __init__(self, futures=None, loop=None, with_results=False, raise_errors=True):
+    def __init__(
+        self,
+        futures=None,
+        loop=None,
+        with_results=False,
+        raise_errors=True,
+        *,
+        timeout=None,
+    ):
         if futures is None:
             futures = []
         self.futures = defaultdict(lambda: 0)
         self.queue = pyQueue()
         self.lock = threading.Lock()
         self.loop = loop or default_client().loop
         self.thread_condition = threading.Condition()
         self.with_results = with_results
         self.raise_errors = raise_errors
+        self._deadline = Deadline.after(parse_timedelta(timeout))
 
         if futures:
             self.update(futures)
 
     @property
     def condition(self):
         try:
@@ -5381,21 +5413,28 @@
                 raise exc.with_traceback(tb)
             elif future.status == "cancelled":
                 res = (res[0], CancelledError(future.key))
         return res
 
     def __next__(self):
         while self.queue.empty():
+            if self._deadline.expired:
+                raise TimeoutError()
             if self.is_empty():
                 raise StopIteration()
             with self.thread_condition:
                 self.thread_condition.wait(timeout=0.100)
         return self._get_and_raise()
 
     async def __anext__(self):
+        if not self._deadline.expires:
+            return await self._anext()
+        return await wait_for(self._anext(), self._deadline.remaining)
+
+    async def _anext(self):
         if not self.futures and self.queue.empty():
             raise StopAsyncIteration
         while self.queue.empty():
             if not self.futures:
                 raise StopAsyncIteration
             async with self.condition:
                 await self.condition.wait()
@@ -5752,30 +5791,30 @@
 
     async def __aexit__(self, exc_type, exc_value, traceback, code=None):
         import fsspec
 
         client = get_client()
         if code is None:
             frames = client._get_computation_code(self._stacklevel + 1, nframes=1)
-            code = frames[0] if frames else "<Code not available>"
+            code = frames[0].code if frames else "<Code not available>"
         data = await client.scheduler.performance_report(
             start=self.start, last_count=self.last_count, code=code, mode=self.mode
         )
         with fsspec.open(
             self.filename, mode="w", compression="infer", **self.storage_options
         ) as f:
             f.write(data)
 
     def __enter__(self):
         get_client().sync(self.__aenter__)
 
     def __exit__(self, exc_type, exc_value, traceback):
         client = get_client()
         frames = client._get_computation_code(self._stacklevel + 1, nframes=1)
-        code = frames[0] if frames else "<Code not available>"
+        code = frames[0].code if frames else "<Code not available>"
         client.sync(self.__aexit__, exc_type, exc_value, traceback, code=code)
 
 
 class get_task_metadata:
     """Collect task metadata within a context block
 
     This gathers ``TaskState`` metadata and final state from the scheduler
```

### Comparing `distributed-2023.5.1/distributed/cluster_dump.py` & `distributed-2023.6.0/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/collections.py` & `distributed-2023.6.0/distributed/collections.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/__init__.py` & `distributed-2023.6.0/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/addressing.py` & `distributed-2023.6.0/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/asyncio_tcp.py` & `distributed-2023.6.0/distributed/comm/asyncio_tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/core.py` & `distributed-2023.6.0/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/inproc.py` & `distributed-2023.6.0/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/registry.py` & `distributed-2023.6.0/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/tcp.py` & `distributed-2023.6.0/distributed/comm/tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/ucx.py` & `distributed-2023.6.0/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/utils.py` & `distributed-2023.6.0/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/comm/ws.py` & `distributed-2023.6.0/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/compatibility.py` & `distributed-2023.6.0/distributed/compatibility.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/config.py` & `distributed-2023.6.0/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/core.py` & `distributed-2023.6.0/distributed/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/counter.py` & `distributed-2023.6.0/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/components/__init__.py` & `distributed-2023.6.0/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/components/nvml.py` & `distributed-2023.6.0/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/components/rmm.py` & `distributed-2023.6.0/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/components/scheduler.py` & `distributed-2023.6.0/distributed/dashboard/components/scheduler.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,9901 +7,10020 @@
 00000060: 6c6c 6563 7469 6f6e 7320 696d 706f 7274  llections import
 00000070: 204f 7264 6572 6564 4469 6374 2c20 6465   OrderedDict, de
 00000080: 6661 756c 7464 6963 740a 6672 6f6d 2063  faultdict.from c
 00000090: 6f6c 6c65 6374 696f 6e73 2e61 6263 2069  ollections.abc i
 000000a0: 6d70 6f72 7420 4974 6572 6162 6c65 0a66  mport Iterable.f
 000000b0: 726f 6d20 6461 7465 7469 6d65 2069 6d70  rom datetime imp
 000000c0: 6f72 7420 6461 7465 7469 6d65 2c20 7469  ort datetime, ti
-000000d0: 6d65 6465 6c74 610a 6672 6f6d 206e 756d  medelta.from num
-000000e0: 6265 7273 2069 6d70 6f72 7420 4e75 6d62  bers import Numb
-000000f0: 6572 0a66 726f 6d20 7479 7069 6e67 2069  er.from typing i
-00000100: 6d70 6f72 7420 416e 792c 2054 7970 6556  mport Any, TypeV
-00000110: 6172 0a0a 696d 706f 7274 206e 756d 7079  ar..import numpy
-00000120: 2061 7320 6e70 0a66 726f 6d20 626f 6b65   as np.from boke
-00000130: 682e 636f 7265 2e70 726f 7065 7274 6965  h.core.propertie
-00000140: 7320 696d 706f 7274 2076 616c 7565 2c20  s import value, 
-00000150: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-00000160: 5f76 616c 6964 6174 696f 6e0a 6672 6f6d  _validation.from
-00000170: 2062 6f6b 6568 2e69 6f20 696d 706f 7274   bokeh.io import
-00000180: 2063 7572 646f 630a 6672 6f6d 2062 6f6b   curdoc.from bok
-00000190: 6568 2e6c 6179 6f75 7473 2069 6d70 6f72  eh.layouts impor
-000001a0: 7420 636f 6c75 6d6e 2c20 726f 770a 6672  t column, row.fr
-000001b0: 6f6d 2062 6f6b 6568 2e6d 6f64 656c 7320  om bokeh.models 
-000001c0: 696d 706f 7274 2028 0a20 2020 2041 6461  import (.    Ada
-000001d0: 7074 6976 6554 6963 6b65 722c 0a20 2020  ptiveTicker,.   
-000001e0: 2041 7272 6f77 2c0a 2020 2020 4261 7369   Arrow,.    Basi
-000001f0: 6354 6963 6b65 722c 0a20 2020 2042 6f78  cTicker,.    Box
-00000200: 5365 6c65 6374 546f 6f6c 2c0a 2020 2020  SelectTool,.    
-00000210: 426f 785a 6f6f 6d54 6f6f 6c2c 0a20 2020  BoxZoomTool,.   
-00000220: 2043 4453 5669 6577 2c0a 2020 2020 436f   CDSView,.    Co
-00000230: 6c6f 7242 6172 2c0a 2020 2020 436f 6c75  lorBar,.    Colu
-00000240: 6d6e 4461 7461 536f 7572 6365 2c0a 2020  mnDataSource,.  
-00000250: 2020 4375 7374 6f6d 4a53 486f 7665 722c    CustomJSHover,
-00000260: 0a20 2020 2044 6174 6152 616e 6765 3164  .    DataRange1d
-00000270: 2c0a 2020 2020 4661 6374 6f72 5261 6e67  ,.    FactorRang
-00000280: 652c 0a20 2020 2047 726f 7570 4669 6c74  e,.    GroupFilt
-00000290: 6572 2c0a 2020 2020 4865 6c70 546f 6f6c  er,.    HelpTool
-000002a0: 2c0a 2020 2020 486f 7665 7254 6f6f 6c2c  ,.    HoverTool,
-000002b0: 0a20 2020 2048 544d 4c54 656d 706c 6174  .    HTMLTemplat
-000002c0: 6546 6f72 6d61 7474 6572 2c0a 2020 2020  eFormatter,.    
-000002d0: 4d75 6c74 6943 686f 6963 652c 0a20 2020  MultiChoice,.   
-000002e0: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-000002f0: 2c0a 2020 2020 4e75 6d65 7261 6c54 6963  ,.    NumeralTic
-00000300: 6b46 6f72 6d61 7474 6572 2c0a 2020 2020  kFormatter,.    
-00000310: 4f70 656e 5552 4c2c 0a20 2020 2050 616e  OpenURL,.    Pan
-00000320: 546f 6f6c 2c0a 2020 2020 5261 6e67 6531  Tool,.    Range1
-00000330: 642c 0a20 2020 2052 6573 6574 546f 6f6c  d,.    ResetTool
-00000340: 2c0a 2020 2020 5365 6c65 6374 2c0a 2020  ,.    Select,.  
-00000350: 2020 5461 6273 2c0a 2020 2020 5461 7054    Tabs,.    TapT
-00000360: 6f6f 6c2c 0a20 2020 2054 6974 6c65 2c0a  ool,.    Title,.
-00000370: 2020 2020 5665 6548 6561 642c 0a20 2020      VeeHead,.   
-00000380: 2057 6865 656c 5a6f 6f6d 546f 6f6c 2c0a   WheelZoomTool,.
-00000390: 290a 6672 6f6d 2062 6f6b 6568 2e6d 6f64  ).from bokeh.mod
-000003a0: 656c 732e 7769 6467 6574 7320 696d 706f  els.widgets impo
-000003b0: 7274 2044 6174 6154 6162 6c65 2c20 5461  rt DataTable, Ta
-000003c0: 626c 6543 6f6c 756d 6e0a 6672 6f6d 2062  bleColumn.from b
-000003d0: 6f6b 6568 2e6d 6f64 656c 732e 7769 6467  okeh.models.widg
-000003e0: 6574 732e 6d61 726b 7570 7320 696d 706f  ets.markups impo
-000003f0: 7274 2044 6976 0a66 726f 6d20 626f 6b65  rt Div.from boke
-00000400: 682e 7061 6c65 7474 6573 2069 6d70 6f72  h.palettes impor
-00000410: 7420 5669 7269 6469 7331 312c 2073 6d61  t Viridis11, sma
-00000420: 6c6c 5f70 616c 6574 7465 730a 6672 6f6d  ll_palettes.from
-00000430: 2062 6f6b 6568 2e70 6c6f 7474 696e 6720   bokeh.plotting 
-00000440: 696d 706f 7274 2066 6967 7572 650a 6672  import figure.fr
-00000450: 6f6d 2062 6f6b 6568 2e74 6865 6d65 7320  om bokeh.themes 
-00000460: 696d 706f 7274 2054 6865 6d65 0a66 726f  import Theme.fro
-00000470: 6d20 626f 6b65 682e 7472 616e 7366 6f72  m bokeh.transfor
-00000480: 6d20 696d 706f 7274 2063 756d 7375 6d2c  m import cumsum,
-00000490: 2066 6163 746f 725f 636d 6170 2c20 6c69   factor_cmap, li
-000004a0: 6e65 6172 5f63 6d61 702c 2073 7461 636b  near_cmap, stack
-000004b0: 0a66 726f 6d20 6a69 6e6a 6132 2069 6d70  .from jinja2 imp
-000004c0: 6f72 7420 456e 7669 726f 6e6d 656e 742c  ort Environment,
-000004d0: 2046 696c 6553 7973 7465 6d4c 6f61 6465   FileSystemLoade
-000004e0: 720a 6672 6f6d 2074 6c7a 2069 6d70 6f72  r.from tlz impor
-000004f0: 7420 6375 7272 792c 2070 6970 652c 2076  t curry, pipe, v
-00000500: 616c 6d61 700a 6672 6f6d 2074 6c7a 2e63  almap.from tlz.c
-00000510: 7572 7269 6564 2069 6d70 6f72 7420 636f  urried import co
-00000520: 6e63 6174 2c20 6772 6f75 7062 792c 206d  ncat, groupby, m
-00000530: 6170 0a66 726f 6d20 746f 726e 6164 6f20  ap.from tornado 
-00000540: 696d 706f 7274 2065 7363 6170 650a 0a69  import escape..i
-00000550: 6d70 6f72 7420 6461 736b 0a66 726f 6d20  mport dask.from 
-00000560: 6461 736b 2069 6d70 6f72 7420 636f 6e66  dask import conf
-00000570: 6967 0a66 726f 6d20 6461 736b 2e75 7469  ig.from dask.uti
-00000580: 6c73 2069 6d70 6f72 7420 280a 2020 2020  ls import (.    
-00000590: 666f 726d 6174 5f62 7974 6573 2c0a 2020  format_bytes,.  
-000005a0: 2020 666f 726d 6174 5f74 696d 652c 0a20    format_time,. 
-000005b0: 2020 2066 756e 636e 616d 652c 0a20 2020     funcname,.   
-000005c0: 206b 6579 5f73 706c 6974 2c0a 2020 2020   key_split,.    
-000005d0: 7061 7273 655f 6279 7465 732c 0a20 2020  parse_bytes,.   
-000005e0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-000005f0: 2c0a 290a 0a66 726f 6d20 6469 7374 7269  ,.)..from distri
-00000600: 6275 7465 642e 636f 7265 2069 6d70 6f72  buted.core impor
-00000610: 7420 5374 6174 7573 0a66 726f 6d20 6469  t Status.from di
-00000620: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
-00000630: 6172 642e 636f 6d70 6f6e 656e 7473 2069  ard.components i
-00000640: 6d70 6f72 7420 6164 645f 7065 7269 6f64  mport add_period
-00000650: 6963 5f63 616c 6c62 6163 6b0a 6672 6f6d  ic_callback.from
-00000660: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-00000670: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
-00000680: 732e 7368 6172 6564 2069 6d70 6f72 7420  s.shared import 
-00000690: 280a 2020 2020 4461 7368 626f 6172 6443  (.    DashboardC
-000006a0: 6f6d 706f 6e65 6e74 2c0a 2020 2020 5072  omponent,.    Pr
-000006b0: 6f66 696c 6553 6572 7665 722c 0a20 2020  ofileServer,.   
-000006c0: 2050 726f 6669 6c65 5469 6d65 506c 6f74   ProfileTimePlot
-000006d0: 2c0a 2020 2020 5379 7374 656d 4d6f 6e69  ,.    SystemMoni
-000006e0: 746f 722c 0a29 0a66 726f 6d20 6469 7374  tor,.).from dist
-000006f0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-00000700: 642e 636f 7265 2069 6d70 6f72 7420 5461  d.core import Ta
-00000710: 6250 616e 656c 0a66 726f 6d20 6469 7374  bPanel.from dist
-00000720: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-00000730: 642e 7574 696c 7320 696d 706f 7274 2028  d.utils import (
-00000740: 0a20 2020 205f 4441 5441 5441 424c 455f  .    _DATATABLE_
-00000750: 5354 594c 4553 4845 4554 535f 4b57 4152  STYLESHEETS_KWAR
-00000760: 4753 2c0a 2020 2020 424f 4b45 485f 5645  GS,.    BOKEH_VE
-00000770: 5253 494f 4e2c 0a20 2020 2050 524f 4649  RSION,.    PROFI
-00000780: 4c49 4e47 2c0a 2020 2020 7472 616e 7370  LING,.    transp
-00000790: 6f73 652c 0a20 2020 2075 7064 6174 652c  ose,.    update,
-000007a0: 0a29 0a66 726f 6d20 6469 7374 7269 6275  .).from distribu
-000007b0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
-000007c0: 6772 6170 685f 6c61 796f 7574 2069 6d70  graph_layout imp
-000007d0: 6f72 7420 4772 6170 684c 6179 6f75 740a  ort GraphLayout.
-000007e0: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-000007f0: 2e64 6961 676e 6f73 7469 6373 2e70 726f  .diagnostics.pro
-00000800: 6772 6573 7320 696d 706f 7274 2047 726f  gress import Gro
-00000810: 7570 5469 6d69 6e67 0a66 726f 6d20 6469  upTiming.from di
-00000820: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
-00000830: 7374 6963 732e 7072 6f67 7265 7373 5f73  stics.progress_s
-00000840: 7472 6561 6d20 696d 706f 7274 2063 6f6c  tream import col
-00000850: 6f72 5f6f 662c 2070 726f 6772 6573 735f  or_of, progress_
-00000860: 7175 6164 730a 6672 6f6d 2064 6973 7472  quads.from distr
-00000870: 6962 7574 6564 2e64 6961 676e 6f73 7469  ibuted.diagnosti
-00000880: 6373 2e74 6173 6b5f 7374 7265 616d 2069  cs.task_stream i
-00000890: 6d70 6f72 7420 5461 736b 5374 7265 616d  mport TaskStream
-000008a0: 506c 7567 696e 0a66 726f 6d20 6469 7374  Plugin.from dist
-000008b0: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
-000008c0: 6963 732e 7461 736b 5f73 7472 6561 6d20  ics.task_stream 
-000008d0: 696d 706f 7274 2063 6f6c 6f72 5f6f 6620  import color_of 
-000008e0: 6173 2074 735f 636f 6c6f 725f 6f66 0a66  as ts_color_of.f
-000008f0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000900: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
-00000910: 5f73 7472 6561 6d20 696d 706f 7274 2063  _stream import c
-00000920: 6f6c 6f72 7320 6173 2074 735f 636f 6c6f  olors as ts_colo
-00000930: 725f 6c6f 6f6b 7570 0a66 726f 6d20 6469  r_lookup.from di
-00000940: 7374 7269 6275 7465 642e 6d65 7472 6963  stributed.metric
-00000950: 7320 696d 706f 7274 2074 696d 650a 6672  s import time.fr
-00000960: 6f6d 2064 6973 7472 6962 7574 6564 2e73  om distributed.s
-00000970: 6368 6564 756c 6572 2069 6d70 6f72 7420  cheduler import 
-00000980: 5363 6865 6475 6c65 720a 6672 6f6d 2064  Scheduler.from d
-00000990: 6973 7472 6962 7574 6564 2e75 7469 6c73  istributed.utils
-000009a0: 2069 6d70 6f72 7420 4c6f 672c 206c 6f67   import Log, log
-000009b0: 5f65 7272 6f72 730a 0a69 6620 6461 736b  _errors..if dask
-000009c0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-000009d0: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
-000009e0: 7264 2e65 7870 6f72 742d 746f 6f6c 2229  rd.export-tool")
-000009f0: 3a0a 2020 2020 6672 6f6d 2064 6973 7472  :.    from distr
-00000a00: 6962 7574 6564 2e64 6173 6862 6f61 7264  ibuted.dashboard
-00000a10: 2e65 7870 6f72 745f 746f 6f6c 2069 6d70  .export_tool imp
-00000a20: 6f72 7420 4578 706f 7274 546f 6f6c 0a65  ort ExportTool.e
-00000a30: 6c73 653a 0a20 2020 2045 7870 6f72 7454  lse:.    ExportT
-00000a40: 6f6f 6c20 3d20 4e6f 6e65 2020 2320 7479  ool = None  # ty
-00000a50: 7065 3a20 6967 6e6f 7265 0a0a 5420 3d20  pe: ignore..T = 
-00000a60: 5479 7065 5661 7228 2254 2229 0a0a 6c6f  TypeVar("T")..lo
-00000a70: 6767 6572 203d 206c 6f67 6769 6e67 2e67  gger = logging.g
-00000a80: 6574 4c6f 6767 6572 285f 5f6e 616d 655f  etLogger(__name_
-00000a90: 5f29 0a0a 656e 7620 3d20 456e 7669 726f  _)..env = Enviro
-00000aa0: 6e6d 656e 7428 0a20 2020 206c 6f61 6465  nment(.    loade
-00000ab0: 723d 4669 6c65 5379 7374 656d 4c6f 6164  r=FileSystemLoad
-00000ac0: 6572 280a 2020 2020 2020 2020 6f73 2e70  er(.        os.p
-00000ad0: 6174 682e 6a6f 696e 286f 732e 7061 7468  ath.join(os.path
-00000ae0: 2e64 6972 6e61 6d65 285f 5f66 696c 655f  .dirname(__file_
-00000af0: 5f29 2c20 222e 2e22 2c20 222e 2e22 2c20  _), "..", "..", 
-00000b00: 2268 7474 7022 2c20 2274 656d 706c 6174  "http", "templat
-00000b10: 6573 2229 0a20 2020 2029 0a29 0a0a 424f  es").    ).)..BO
-00000b20: 4b45 485f 5448 454d 4520 3d20 5468 656d  KEH_THEME = Them
-00000b30: 6528 0a20 2020 2066 696c 656e 616d 653d  e(.    filename=
-00000b40: 6f73 2e70 6174 682e 6a6f 696e 286f 732e  os.path.join(os.
-00000b50: 7061 7468 2e64 6972 6e61 6d65 285f 5f66  path.dirname(__f
-00000b60: 696c 655f 5f29 2c20 222e 2e22 2c20 2274  ile__), "..", "t
-00000b70: 6865 6d65 2e79 616d 6c22 290a 290a 5449  heme.yaml").).TI
-00000b80: 434b 535f 3130 3234 203d 207b 2262 6173  CKS_1024 = {"bas
-00000b90: 6522 3a20 3130 3234 2c20 226d 616e 7469  e": 1024, "manti
-00000ba0: 7373 6173 223a 205b 312c 2032 2c20 342c  ssas": [1, 2, 4,
-00000bb0: 2038 2c20 3136 2c20 3332 2c20 3634 2c20   8, 16, 32, 64, 
-00000bc0: 3132 382c 2032 3536 2c20 3531 325d 7d0a  128, 256, 512]}.
-00000bd0: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
-00000be0: 4f4e 203d 202d 6d61 7468 2e70 6920 2f20  ON = -math.pi / 
-00000bf0: 3920 2023 2073 6c61 6e74 6564 2064 6f77  9  # slanted dow
-00000c00: 6e77 6172 6473 2032 3020 6465 6772 6565  nwards 20 degree
-00000c10: 730a 0a0a 6c6f 676f 735f 6469 6374 203d  s...logos_dict =
-00000c20: 207b 0a20 2020 2022 6e75 6d70 7922 3a20   {.    "numpy": 
-00000c30: 2273 7461 7469 6373 2f69 6d61 6765 732f  "statics/images/
-00000c40: 6e75 6d70 792e 706e 6722 2c0a 2020 2020  numpy.png",.    
-00000c50: 2270 616e 6461 7322 3a20 2273 7461 7469  "pandas": "stati
-00000c60: 6373 2f69 6d61 6765 732f 7061 6e64 6173  cs/images/pandas
-00000c70: 2e70 6e67 222c 0a20 2020 2022 6275 696c  .png",.    "buil
-00000c80: 7469 6e73 223a 2022 7374 6174 6963 732f  tins": "statics/
-00000c90: 696d 6167 6573 2f70 7974 686f 6e2e 706e  images/python.pn
-00000ca0: 6722 2c0a 7d0a 0a0a 636c 6173 7320 4f63  g",.}...class Oc
-00000cb0: 6375 7061 6e63 7928 4461 7368 626f 6172  cupancy(Dashboar
-00000cc0: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00000cd0: 2022 2222 4f63 6375 7061 6e63 7920 2869   """Occupancy (i
-00000ce0: 6e20 7469 6d65 2920 7065 7220 776f 726b  n time) per work
-00000cf0: 6572 2222 220a 0a20 2020 2040 6c6f 675f  er"""..    @log_
-00000d00: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
-00000d10: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-00000d20: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
-00000d30: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-00000d40: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
-00000d50: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
-00000d60: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
-00000d70: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-00000d80: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00000d90: 2020 2020 2020 2020 2020 2020 2022 6f63               "oc
-00000da0: 6375 7061 6e63 7922 3a20 5b30 2c20 305d  cupancy": [0, 0]
-00000db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00000dc0: 2020 2277 6f72 6b65 7222 3a20 5b22 6122    "worker": ["a"
-00000dd0: 2c20 2262 225d 2c0a 2020 2020 2020 2020  , "b"],.        
-00000de0: 2020 2020 2020 2020 2278 223a 205b 302e          "x": [0.
-00000df0: 302c 2030 2e31 5d2c 0a20 2020 2020 2020  0, 0.1],.       
-00000e00: 2020 2020 2020 2020 2022 7922 3a20 5b31           "y": [1
-00000e10: 2c20 325d 2c0a 2020 2020 2020 2020 2020  , 2],.          
-00000e20: 2020 2020 2020 226d 7322 3a20 5b31 2c20        "ms": [1, 
-00000e30: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
-00000e40: 2020 2020 2263 6f6c 6f72 223a 205b 2272      "color": ["r
-00000e50: 6564 222c 2022 626c 7565 225d 2c0a 2020  ed", "blue"],.  
-00000e60: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00000e70: 7363 6170 6564 5f77 6f72 6b65 7222 3a20  scaped_worker": 
-00000e80: 5b22 6122 2c20 2262 225d 2c0a 2020 2020  ["a", "b"],.    
-00000e90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00000ea0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00000eb0: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
-00000ec0: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-00000ed0: 6c65 3d22 4f63 6375 7061 6e63 7922 2c0a  le="Occupancy",.
-00000ee0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00000ef0: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
-00000f00: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
-00000f10: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
-00000f20: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
-00000f30: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
-00000f40: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-00000f50: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
-00000f60: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00000f70: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-00000f80: 290a 2020 2020 2020 2020 7265 6374 203d  ).        rect =
-00000f90: 2073 656c 662e 726f 6f74 2e72 6563 7428   self.root.rect(
-00000fa0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00000fb0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00000fc0: 2078 3d22 7822 2c20 7769 6474 683d 226d   x="x", width="m
-00000fd0: 7322 2c20 793d 2279 222c 2068 6569 6768  s", y="y", heigh
-00000fe0: 743d 302e 392c 2063 6f6c 6f72 3d22 636f  t=0.9, color="co
-00000ff0: 6c6f 7222 0a20 2020 2020 2020 2029 0a20  lor".        ). 
-00001000: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
-00001010: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
-00001020: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-00001030: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
-00001040: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
-00001050: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
-00001060: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-00001070: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-00001080: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00001090: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
-000010a0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000010b0: 2023 2066 6967 2e78 6178 6973 5b30 5d2e   # fig.xaxis[0].
-000010c0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
-000010d0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
-000010e0: 2866 6f72 6d61 743d 2730 2e30 7327 290a  (format='0.0s').
-000010f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00001100: 742e 785f 7261 6e67 652e 7374 6172 7420  t.x_range.start 
-00001110: 3d20 300a 0a20 2020 2020 2020 2074 6170  = 0..        tap
-00001120: 203d 2054 6170 546f 6f6c 2863 616c 6c62   = TapTool(callb
-00001130: 6163 6b3d 4f70 656e 5552 4c28 7572 6c3d  ack=OpenURL(url=
-00001140: 222e 2f69 6e66 6f2f 776f 726b 6572 2f40  "./info/worker/@
-00001150: 6573 6361 7065 645f 776f 726b 6572 2e68  escaped_worker.h
-00001160: 746d 6c22 2929 0a0a 2020 2020 2020 2020  tml"))..        
-00001170: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
-00001180: 6c28 290a 2020 2020 2020 2020 686f 7665  l().        hove
-00001190: 722e 746f 6f6c 7469 7073 203d 2022 4077  r.tooltips = "@w
-000011a0: 6f72 6b65 7220 3a20 406f 6363 7570 616e  orker : @occupan
-000011b0: 6379 2073 2e22 0a20 2020 2020 2020 2068  cy s.".        h
-000011c0: 6f76 6572 2e70 6f69 6e74 5f70 6f6c 6963  over.point_polic
-000011d0: 7920 3d20 2266 6f6c 6c6f 775f 6d6f 7573  y = "follow_mous
-000011e0: 6522 0a20 2020 2020 2020 2073 656c 662e  e".        self.
-000011f0: 726f 6f74 2e61 6464 5f74 6f6f 6c73 2868  root.add_tools(h
-00001200: 6f76 6572 2c20 7461 7029 0a0a 2020 2020  over, tap)..    
-00001210: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-00001220: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-00001230: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00001240: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
-00001250: 293a 0a20 2020 2020 2020 2077 6f72 6b65  ):.        worke
-00001260: 7273 203d 2073 656c 662e 7363 6865 6475  rs = self.schedu
-00001270: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-00001280: 6573 2829 0a0a 2020 2020 2020 2020 7920  es()..        y 
-00001290: 3d20 6c69 7374 2872 616e 6765 286c 656e  = list(range(len
-000012a0: 2877 6f72 6b65 7273 2929 290a 2020 2020  (workers))).    
-000012b0: 2020 2020 6f63 6375 7061 6e63 7920 3d20      occupancy = 
-000012c0: 5b77 732e 6f63 6375 7061 6e63 7920 666f  [ws.occupancy fo
-000012d0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
-000012e0: 0a20 2020 2020 2020 206d 7320 3d20 5b6f  .        ms = [o
-000012f0: 6363 202a 2031 3030 3020 666f 7220 6f63  cc * 1000 for oc
-00001300: 6320 696e 206f 6363 7570 616e 6379 5d0a  c in occupancy].
-00001310: 2020 2020 2020 2020 7820 3d20 5b6f 6363          x = [occ
-00001320: 202f 2035 3030 2066 6f72 206f 6363 2069   / 500 for occ i
-00001330: 6e20 6f63 6375 7061 6e63 795d 0a20 2020  n occupancy].   
-00001340: 2020 2020 2074 6f74 616c 203d 2073 756d       total = sum
-00001350: 286f 6363 7570 616e 6379 290a 2020 2020  (occupancy).    
-00001360: 2020 2020 636f 6c6f 7220 3d20 5b5d 0a20      color = []. 
-00001370: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
-00001380: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
-00001390: 2020 2020 2020 6966 2077 7320 696e 2073        if ws in s
-000013a0: 656c 662e 7363 6865 6475 6c65 722e 6964  elf.scheduler.id
-000013b0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-000013c0: 2020 2020 636f 6c6f 722e 6170 7065 6e64      color.append
-000013d0: 2822 7265 6422 290a 2020 2020 2020 2020  ("red").        
-000013e0: 2020 2020 656c 6966 2077 7320 696e 2073      elif ws in s
-000013f0: 656c 662e 7363 6865 6475 6c65 722e 7361  elf.scheduler.sa
-00001400: 7475 7261 7465 643a 0a20 2020 2020 2020  turated:.       
-00001410: 2020 2020 2020 2020 2063 6f6c 6f72 2e61           color.a
-00001420: 7070 656e 6428 2267 7265 656e 2229 0a20  ppend("green"). 
-00001430: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00001440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001450: 2063 6f6c 6f72 2e61 7070 656e 6428 2262   color.append("b
-00001460: 6c75 6522 290a 0a20 2020 2020 2020 2069  lue")..        i
-00001470: 6620 746f 7461 6c3a 0a20 2020 2020 2020  f total:.       
-00001480: 2020 2020 2073 656c 662e 726f 6f74 2e74       self.root.t
-00001490: 6974 6c65 2e74 6578 7420 3d20 280a 2020  itle.text = (.  
-000014a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000014b0: 4f63 6375 7061 6e63 7920 2d2d 2074 6f74  Occupancy -- tot
-000014c0: 616c 2074 696d 653a 207b 666f 726d 6174  al time: {format
-000014d0: 5f74 696d 6528 746f 7461 6c29 7d20 220a  _time(total)} ".
-000014e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014f0: 6622 7761 6c6c 2074 696d 653a 207b 666f  f"wall time: {fo
-00001500: 726d 6174 5f74 696d 6528 746f 7461 6c20  rmat_time(total 
-00001510: 2f20 7365 6c66 2e73 6368 6564 756c 6572  / self.scheduler
-00001520: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
-00001530: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00001540: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00001550: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00001560: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
-00001570: 3d20 224f 6363 7570 616e 6379 220a 0a20  = "Occupancy".. 
-00001580: 2020 2020 2020 2069 6620 6f63 6375 7061         if occupa
-00001590: 6e63 793a 0a20 2020 2020 2020 2020 2020  ncy:.           
-000015a0: 2072 6573 756c 7420 3d20 7b0a 2020 2020   result = {.    
-000015b0: 2020 2020 2020 2020 2020 2020 226f 6363              "occ
-000015c0: 7570 616e 6379 223a 206f 6363 7570 616e  upancy": occupan
-000015d0: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
-000015e0: 2020 2020 2277 6f72 6b65 7222 3a20 5b77      "worker": [w
-000015f0: 732e 6164 6472 6573 7320 666f 7220 7773  s.address for ws
-00001600: 2069 6e20 776f 726b 6572 735d 2c0a 2020   in workers],.  
-00001610: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00001620: 7322 3a20 6d73 2c0a 2020 2020 2020 2020  s": ms,.        
-00001630: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
-00001640: 2063 6f6c 6f72 2c0a 2020 2020 2020 2020   color,.        
-00001650: 2020 2020 2020 2020 2265 7363 6170 6564          "escaped
-00001660: 5f77 6f72 6b65 7222 3a20 5b65 7363 6170  _worker": [escap
-00001670: 652e 7572 6c5f 6573 6361 7065 2877 732e  e.url_escape(ws.
-00001680: 6164 6472 6573 7329 2066 6f72 2077 7320  address) for ws 
-00001690: 696e 2077 6f72 6b65 7273 5d2c 0a20 2020  in workers],.   
-000016a0: 2020 2020 2020 2020 2020 2020 2022 7822               "x"
-000016b0: 3a20 782c 0a20 2020 2020 2020 2020 2020  : x,.           
-000016c0: 2020 2020 2022 7922 3a20 792c 0a20 2020       "y": y,.   
-000016d0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-000016e0: 2020 2020 2020 2020 7570 6461 7465 2873          update(s
-000016f0: 656c 662e 736f 7572 6365 2c20 7265 7375  elf.source, resu
-00001700: 6c74 290a 0a0a 636c 6173 7320 5072 6f63  lt)...class Proc
-00001710: 6573 7369 6e67 4869 7374 6f67 7261 6d28  essingHistogram(
-00001720: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-00001730: 6e74 293a 0a20 2020 2022 2222 486f 7720  nt):.    """How 
-00001740: 6d61 6e79 2074 6173 6b73 2061 7265 206f  many tasks are o
-00001750: 6e20 6561 6368 2077 6f72 6b65 7222 2222  n each worker"""
-00001760: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-00001770: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
-00001780: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00001790: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-000017a0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-000017b0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-000017c0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-000017d0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-000017e0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
-000017f0: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
-00001800: 2020 2020 2020 2020 2020 2020 7b22 6c65              {"le
-00001810: 6674 223a 205b 312c 2032 5d2c 2022 7269  ft": [1, 2], "ri
-00001820: 6768 7422 3a20 5b31 302c 2031 305d 2c20  ght": [10, 10], 
-00001830: 2274 6f70 223a 205b 302c 2030 5d7d 0a20  "top": [0, 0]}. 
-00001840: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00001850: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00001860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00001870: 2020 7469 746c 653d 2254 6173 6b73 2050    title="Tasks P
-00001880: 726f 6365 7373 696e 6720 2863 6f75 6e74  rocessing (count
-00001890: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-000018a0: 6e61 6d65 3d22 7072 6f63 6573 7369 6e67  name="processing
-000018b0: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-000018c0: 5f61 7869 735f 6c61 6265 6c3d 2266 7265  _axis_label="fre
-000018d0: 7175 656e 6379 222c 0a20 2020 2020 2020  quency",.       
-000018e0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-000018f0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-00001900: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
-00001910: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00001920: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
-00001930: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
-00001940: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
-00001950: 6f6f 742e 7967 7269 642e 7669 7369 626c  oot.ygrid.visibl
-00001960: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-00001970: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
-00001980: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
-00001990: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
-000019a0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-000019b0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-000019c0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-000019d0: 2020 2020 2020 2020 2020 6c65 6674 3d22            left="
-000019e0: 6c65 6674 222c 0a20 2020 2020 2020 2020  left",.         
-000019f0: 2020 2072 6967 6874 3d22 7269 6768 7422     right="right"
-00001a00: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
-00001a10: 7474 6f6d 3d30 2c0a 2020 2020 2020 2020  ttom=0,.        
-00001a20: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
-00001a30: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00001a40: 3d22 6465 6570 736b 7962 6c75 6522 2c0a  ="deepskyblue",.
-00001a50: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
-00001a60: 5f61 6c70 6861 3d30 2e35 2c0a 2020 2020  _alpha=0.5,.    
-00001a70: 2020 2020 290a 0a20 2020 2040 7769 7468      )..    @with
-00001a80: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
-00001a90: 6964 6174 696f 6e0a 2020 2020 6465 6620  idation.    def 
-00001aa0: 7570 6461 7465 2873 656c 6629 3a0a 2020  update(self):.  
-00001ab0: 2020 2020 2020 4c20 3d20 5b6c 656e 2877        L = [len(w
-00001ac0: 732e 7072 6f63 6573 7369 6e67 2920 666f  s.processing) fo
-00001ad0: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
-00001ae0: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
-00001af0: 616c 7565 7328 295d 0a20 2020 2020 2020  alues()].       
-00001b00: 2063 6f75 6e74 732c 2078 203d 206e 702e   counts, x = np.
-00001b10: 6869 7374 6f67 7261 6d28 4c2c 2062 696e  histogram(L, bin
-00001b20: 733d 3430 290a 2020 2020 2020 2020 7365  s=40).        se
-00001b30: 6c66 2e73 6f75 7263 652e 6461 7461 2e75  lf.source.data.u
-00001b40: 7064 6174 6528 7b22 6c65 6674 223a 2078  pdate({"left": x
-00001b50: 5b3a 2d31 5d2c 2022 7269 6768 7422 3a20  [:-1], "right": 
-00001b60: 785b 313a 5d2c 2022 746f 7022 3a20 636f  x[1:], "top": co
-00001b70: 756e 7473 7d29 0a0a 0a63 6c61 7373 204d  unts})...class M
-00001b80: 656d 6f72 7943 6f6c 6f72 3a0a 2020 2020  emoryColor:.    
-00001b90: 2222 2243 6861 6e67 6520 7468 6520 636f  """Change the co
-00001ba0: 6c6f 7220 6f66 2074 6865 206d 656d 6f72  lor of the memor
-00001bb0: 7920 6261 7273 2066 726f 6d20 626c 7565  y bars from blue
-00001bc0: 2074 6f20 6f72 616e 6765 2077 6865 6e20   to orange when 
-00001bd0: 7072 6f63 6573 7320 6d65 6d6f 7279 2067  process memory g
-00001be0: 6f65 730a 2020 2020 6162 6f76 6520 7468  oes.    above th
-00001bf0: 6520 6060 7461 7267 6574 6060 2074 6872  e ``target`` thr
-00001c00: 6573 686f 6c64 2061 6e64 2074 6f20 7265  eshold and to re
-00001c10: 6420 7768 656e 2074 6865 2077 6f72 6b65  d when the worke
-00001c20: 7220 7061 7573 6573 2e0a 2020 2020 576f  r pauses..    Wo
-00001c30: 726b 6572 7320 696e 2060 6063 6c6f 7369  rkers in ``closi
-00001c40: 6e67 5f67 7261 6365 6675 6c6c 7960 6020  ng_gracefully`` 
-00001c50: 7374 6174 6520 7769 6c6c 2061 6c73 6f20  state will also 
-00001c60: 6265 206f 7261 6e67 652e 0a0a 2020 2020  be orange...    
-00001c70: 4966 2060 6074 6172 6765 7460 6020 6973  If ``target`` is
-00001c80: 2064 6973 6162 6c65 642c 2063 6861 6e67   disabled, chang
-00001c90: 6520 746f 206f 7261 6e67 6520 6f6e 2060  e to orange on `
-00001ca0: 6073 7069 6c6c 6060 2069 6e73 7465 6164  `spill`` instead
-00001cb0: 2e0a 2020 2020 4966 2073 7069 6c6c 696e  ..    If spillin
-00001cc0: 6720 6973 2063 6f6d 706c 6574 656c 7920  g is completely 
-00001cd0: 6469 7361 626c 6564 2c20 6e65 7665 7220  disabled, never 
-00001ce0: 7475 726e 206f 7261 6e67 652e 0a0a 2020  turn orange...  
-00001cf0: 2020 4966 2070 6175 7369 6e67 2069 7320    If pausing is 
-00001d00: 6469 7361 626c 6564 2c20 6368 616e 6765  disabled, change
-00001d10: 2074 6f20 7265 6420 7768 656e 2070 6173   to red when pas
-00001d20: 7369 6e67 2074 6865 2060 6074 6572 6d69  sing the ``termi
-00001d30: 6e61 7465 6060 2074 6872 6573 686f 6c64  nate`` threshold
-00001d40: 0a20 2020 2069 6e73 7465 6164 2e20 4966  .    instead. If
-00001d50: 2062 6f74 6820 7061 7573 6520 616e 6420   both pause and 
-00001d60: 7465 726d 696e 6174 6520 6172 6520 6469  terminate are di
-00001d70: 7361 626c 6564 2c20 7475 726e 2072 6564  sabled, turn red
-00001d80: 2077 6865 6e20 7061 7373 696e 670a 2020   when passing.  
-00001d90: 2020 6060 6d65 6d6f 7279 5f6c 696d 6974    ``memory_limit
-00001da0: 6060 2e0a 0a20 2020 204e 6f74 650a 2020  ``...    Note.  
-00001db0: 2020 2d2d 2d2d 0a20 2020 2041 2077 6f72    ----.    A wor
-00001dc0: 6b65 7220 7769 6c6c 2073 7461 7274 2073  ker will start s
-00001dd0: 7069 6c6c 696e 6720 7768 656e 206d 616e  pilling when man
-00001de0: 6167 6564 206d 656d 6f72 7920 616c 6f6e  aged memory alon
-00001df0: 6520 7061 7373 6573 2074 6865 2074 6172  e passes the tar
-00001e00: 6765 7420 7468 7265 7368 6f6c 642e 0a20  get threshold.. 
-00001e10: 2020 2048 6f77 6576 6572 2c20 6865 7265     However, here
-00001e20: 2077 6527 7265 2073 7769 7463 6869 6e67   we're switching
-00001e30: 2074 6f20 6f72 616e 6765 2077 6865 6e20   to orange when 
-00001e40: 7468 6520 7072 6f63 6573 7320 6d65 6d6f  the process memo
-00001e50: 7279 2067 6f65 7320 6265 796f 6e64 2074  ry goes beyond t
-00001e60: 6172 6765 742c 0a20 2020 2077 6869 6368  arget,.    which
-00001e70: 2069 7320 7573 7561 6c6c 7920 6561 726c   is usually earl
-00001e80: 6965 722e 0a20 2020 2054 6869 7320 6973  ier..    This is
-00001e90: 2064 656c 6962 6572 6174 6520 666f 7220   deliberate for 
-00001ea0: 7468 6520 7361 6b65 206f 6620 7369 6d70  the sake of simp
-00001eb0: 6c69 6369 7479 2061 6e64 2061 6c73 6f20  licity and also 
-00001ec0: 6265 6361 7573 652c 2077 6865 6e20 7468  because, when th
-00001ed0: 6520 7072 6f63 6573 730a 2020 2020 6d65  e process.    me
-00001ee0: 6d6f 7279 2070 6173 7365 7320 7468 6520  mory passes the 
-00001ef0: 7370 696c 6c20 7468 7265 7368 6f6c 642c  spill threshold,
-00001f00: 2069 7420 7769 6c6c 206b 6565 7020 7370   it will keep sp
-00001f10: 696c 6c69 6e67 2075 6e74 696c 2069 7420  illing until it 
-00001f20: 6661 6c6c 7320 6265 6c6f 7720 7468 650a  falls below the.
-00001f30: 2020 2020 7461 7267 6574 2074 6872 6573      target thres
-00001f40: 686f 6c64 202d 2073 6f20 6974 2773 206e  hold - so it's n
-00001f50: 6f74 2063 6f6d 706c 6574 656c 7920 7772  ot completely wr
-00001f60: 6f6e 672e 2041 6761 696e 2c20 7765 2064  ong. Again, we d
-00001f70: 6f6e 2774 2077 616e 7420 746f 2074 7261  on't want to tra
-00001f80: 636b 0a20 2020 2074 6865 2068 7973 7465  ck.    the hyste
-00001f90: 7265 7369 7320 6379 636c 6520 6f66 2074  resis cycle of t
-00001fa0: 6865 2073 7069 6c6c 2073 7973 7465 6d20  he spill system 
-00001fb0: 6865 7265 2066 6f72 2074 6865 2073 616b  here for the sak
-00001fc0: 6520 6f66 2073 696d 706c 6963 6974 792e  e of simplicity.
-00001fd0: 0a0a 2020 2020 496e 2073 686f 7274 2c20  ..    In short, 
-00001fe0: 6f72 616e 6765 2073 686f 756c 6420 6265  orange should be
-00001ff0: 2074 7265 6174 6564 2061 7320 2274 6865   treated as "the
-00002000: 2077 6f72 6b65 7220 2a6d 6179 2a20 6265   worker *may* be
-00002010: 2073 7069 6c6c 696e 6722 2e0a 2020 2020   spilling"..    
-00002020: 2222 220a 0a20 2020 206f 7261 6e67 653a  """..    orange:
-00002030: 2066 6c6f 6174 0a20 2020 2072 6564 3a20   float.    red: 
-00002040: 666c 6f61 740a 0a20 2020 2064 6566 205f  float..    def _
-00002050: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
-00002060: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
-00002070: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-00002080: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
-00002090: 6b65 722e 6d65 6d6f 7279 2e74 6172 6765  ker.memory.targe
-000020a0: 7422 290a 2020 2020 2020 2020 7370 696c  t").        spil
-000020b0: 6c20 3d20 6461 736b 2e63 6f6e 6669 672e  l = dask.config.
-000020c0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-000020d0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e73  .worker.memory.s
-000020e0: 7069 6c6c 2229 0a20 2020 2020 2020 2074  pill").        t
-000020f0: 6572 6d69 6e61 7465 203d 2064 6173 6b2e  erminate = dask.
-00002100: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-00002110: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-00002120: 656d 6f72 792e 7465 726d 696e 6174 6522  emory.terminate"
-00002130: 290a 2020 2020 2020 2020 2320 5468 6573  ).        # Thes
-00002140: 6520 7661 6c75 6573 2063 616e 2062 6520  e values can be 
-00002150: 4661 6c73 652e 2049 7427 7320 616c 736f  False. It's also
-00002160: 2063 6f6d 6d6f 6e20 746f 2063 6f6e 6669   common to confi
-00002170: 6775 7265 2074 6865 6d20 746f 2069 6d70  gure them to imp
-00002180: 6f73 7369 626c 790a 2020 2020 2020 2020  ossibly.        
-00002190: 2320 6869 6768 2076 616c 7565 7320 746f  # high values to
-000021a0: 2061 6368 6965 7665 2074 6865 2073 616d   achieve the sam
-000021b0: 6520 6566 6665 6374 2e0a 2020 2020 2020  e effect..      
-000021c0: 2020 7365 6c66 2e6f 7261 6e67 6520 3d20    self.orange = 
-000021d0: 6d69 6e28 7461 7267 6574 206f 7220 6d61  min(target or ma
-000021e0: 7468 2e69 6e66 2c20 7370 696c 6c20 6f72  th.inf, spill or
-000021f0: 206d 6174 682e 696e 6629 0a20 2020 2020   math.inf).     
-00002200: 2020 2073 656c 662e 7265 6420 3d20 6d69     self.red = mi
-00002210: 6e28 7465 726d 696e 6174 6520 6f72 206d  n(terminate or m
-00002220: 6174 682e 696e 662c 2031 2e30 290a 0a20  ath.inf, 1.0).. 
-00002230: 2020 2064 6566 205f 6d65 6d6f 7279 5f63     def _memory_c
-00002240: 6f6c 6f72 2873 656c 662c 2063 7572 7265  olor(self, curre
-00002250: 6e74 3a20 696e 742c 206c 696d 6974 3a20  nt: int, limit: 
-00002260: 696e 742c 2073 7461 7475 733a 2053 7461  int, status: Sta
-00002270: 7475 7329 202d 3e20 7374 723a 0a20 2020  tus) -> str:.   
-00002280: 2020 2020 2069 6620 7374 6174 7573 2021       if status !
-00002290: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-000022a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000022b0: 7475 726e 2022 7265 6422 0a20 2020 2020  turn "red".     
-000022c0: 2020 2069 6620 6e6f 7420 6c69 6d69 743a     if not limit:
-000022d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000022e0: 7572 6e20 2262 6c75 6522 0a20 2020 2020  urn "blue".     
-000022f0: 2020 2069 6620 6375 7272 656e 7420 3e3d     if current >=
-00002300: 206c 696d 6974 202a 2073 656c 662e 7265   limit * self.re
-00002310: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
-00002320: 6574 7572 6e20 2272 6564 220a 2020 2020  eturn "red".    
-00002330: 2020 2020 6966 2063 7572 7265 6e74 203e      if current >
-00002340: 3d20 6c69 6d69 7420 2a20 7365 6c66 2e6f  = limit * self.o
-00002350: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
-00002360: 2020 2072 6574 7572 6e20 226f 7261 6e67     return "orang
-00002370: 6522 0a20 2020 2020 2020 2072 6574 7572  e".        retur
-00002380: 6e20 2262 6c75 6522 0a0a 0a63 6c61 7373  n "blue"...class
-00002390: 2043 6c75 7374 6572 4d65 6d6f 7279 2844   ClusterMemory(D
-000023a0: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
-000023b0: 742c 204d 656d 6f72 7943 6f6c 6f72 293a  t, MemoryColor):
-000023c0: 0a20 2020 2022 2222 546f 7461 6c20 6d65  .    """Total me
-000023d0: 6d6f 7279 2075 7361 6765 206f 6e20 7468  mory usage on th
-000023e0: 6520 636c 7573 7465 7222 2222 0a0a 2020  e cluster"""..  
-000023f0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-00002400: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00002410: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-00002420: 7769 6474 683d 3630 302c 202a 2a6b 7761  width=600, **kwa
-00002430: 7267 7329 3a0a 2020 2020 2020 2020 4461  rgs):.        Da
-00002440: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00002450: 2e5f 5f69 6e69 745f 5f28 7365 6c66 290a  .__init__(self).
-00002460: 2020 2020 2020 2020 4d65 6d6f 7279 436f          MemoryCo
-00002470: 6c6f 722e 5f5f 696e 6974 5f5f 2873 656c  lor.__init__(sel
-00002480: 6629 0a0a 2020 2020 2020 2020 7365 6c66  f)..        self
-00002490: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
-000024a0: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
-000024b0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
-000024c0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-000024d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000024e0: 2020 2020 2020 2020 2020 2020 2022 7769               "wi
-000024f0: 6474 6822 3a20 5b30 5d20 2a20 342c 0a20  dth": [0] * 4,. 
-00002500: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00002510: 7822 3a20 5b30 5d20 2a20 342c 0a20 2020  x": [0] * 4,.   
-00002520: 2020 2020 2020 2020 2020 2020 2022 7922               "y"
-00002530: 3a20 5b30 5d20 2a20 342c 0a20 2020 2020  : [0] * 4,.     
-00002540: 2020 2020 2020 2020 2020 2022 636f 6c6f             "colo
-00002550: 7222 3a20 5b22 626c 7565 222c 2022 626c  r": ["blue", "bl
-00002560: 7565 222c 2022 626c 7565 222c 2022 6772  ue", "blue", "gr
-00002570: 6579 225d 2c0a 2020 2020 2020 2020 2020  ey"],.          
-00002580: 2020 2020 2020 2261 6c70 6861 223a 205b        "alpha": [
-00002590: 312c 2030 2e37 2c20 302e 342c 2031 5d2c  1, 0.7, 0.4, 1],
-000025a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000025b0: 2022 7072 6f63 5f6d 656d 6f72 7922 3a20   "proc_memory": 
-000025c0: 5b30 5d20 2a20 342c 0a20 2020 2020 2020  [0] * 4,.       
-000025d0: 2020 2020 2020 2020 2022 6d61 6e61 6765           "manage
-000025e0: 6422 3a20 5b30 5d20 2a20 342c 0a20 2020  d": [0] * 4,.   
-000025f0: 2020 2020 2020 2020 2020 2020 2022 756e               "un
-00002600: 6d61 6e61 6765 645f 6f6c 6422 3a20 5b30  managed_old": [0
-00002610: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
-00002620: 2020 2020 2020 2022 756e 6d61 6e61 6765         "unmanage
-00002630: 645f 7265 6365 6e74 223a 205b 305d 202a  d_recent": [0] *
-00002640: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-00002650: 2020 2020 2273 7069 6c6c 6564 223a 205b      "spilled": [
-00002660: 305d 202a 2034 2c0a 2020 2020 2020 2020  0] * 4,.        
-00002670: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
-00002680: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00002690: 6f74 203d 2066 6967 7572 6528 0a20 2020  ot = figure(.   
-000026a0: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
-000026b0: 4279 7465 7320 7374 6f72 6564 206f 6e20  Bytes stored on 
-000026c0: 636c 7573 7465 7222 2c0a 2020 2020 2020  cluster",.      
-000026d0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-000026e0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-000026f0: 683d 696e 7428 7769 6474 6820 2f20 3229  h=int(width / 2)
-00002700: 2c0a 2020 2020 2020 2020 2020 2020 6e61  ,.            na
-00002710: 6d65 3d22 636c 7573 7465 725f 6d65 6d6f  me="cluster_memo
-00002720: 7279 222c 0a20 2020 2020 2020 2020 2020  ry",.           
-00002730: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
-00002740: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
-00002750: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-00002760: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00002770: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
-00002780: 7265 6374 280a 2020 2020 2020 2020 2020  rect(.          
-00002790: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-000027a0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-000027b0: 2020 783d 2278 222c 0a20 2020 2020 2020    x="x",.       
-000027c0: 2020 2020 2079 3d22 7922 2c0a 2020 2020       y="y",.    
-000027d0: 2020 2020 2020 2020 7769 6474 683d 2277          width="w
-000027e0: 6964 7468 222c 0a20 2020 2020 2020 2020  idth",.         
-000027f0: 2020 2068 6569 6768 743d 302e 392c 0a20     height=0.9,. 
-00002800: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00002810: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-00002820: 2020 2020 2020 616c 7068 613d 2261 6c70        alpha="alp
-00002830: 6861 222c 0a20 2020 2020 2020 2029 0a20  ha",.        ). 
-00002840: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
-00002850: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
-00002860: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-00002870: 656c 662e 726f 6f74 2e61 7869 735b 305d  elf.root.axis[0]
-00002880: 2e74 6963 6b65 7220 3d20 4261 7369 6354  .ticker = BasicT
-00002890: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
-000028a0: 3234 290a 2020 2020 2020 2020 7365 6c66  24).        self
-000028b0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
-000028c0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-000028d0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-000028e0: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-000028f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00002900: 742e 7861 7869 732e 6d61 6a6f 725f 6c61  t.xaxis.major_la
-00002910: 6265 6c5f 6f72 6965 6e74 6174 696f 6e20  bel_orientation 
-00002920: 3d20 584c 4142 454c 5f4f 5249 454e 5441  = XLABEL_ORIENTA
-00002930: 5449 4f4e 0a20 2020 2020 2020 2073 656c  TION.        sel
-00002940: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
-00002950: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-00002960: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-00002970: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
-00002980: 203d 2052 616e 6765 3164 2873 7461 7274   = Range1d(start
-00002990: 3d30 290a 2020 2020 2020 2020 7365 6c66  =0).        self
-000029a0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
-000029b0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-000029c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7967      self.root.yg
-000029d0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-000029e0: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
-000029f0: 662e 726f 6f74 2e74 6f6f 6c62 6172 5f6c  f.root.toolbar_l
-00002a00: 6f63 6174 696f 6e20 3d20 2261 626f 7665  ocation = "above
-00002a10: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
-00002a20: 6f6f 742e 7961 7869 732e 7669 7369 626c  oot.yaxis.visibl
-00002a30: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-00002a40: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
-00002a50: 546f 6f6c 280a 2020 2020 2020 2020 2020  Tool(.          
-00002a60: 2020 706f 696e 745f 706f 6c69 6379 3d22    point_policy="
-00002a70: 666f 6c6c 6f77 5f6d 6f75 7365 222c 0a20  follow_mouse",. 
-00002a80: 2020 2020 2020 2020 2020 2074 6f6f 6c74             toolt
-00002a90: 6970 733d 2222 220a 2020 2020 2020 2020  ips=""".        
-00002aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ab0: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
+000000d0: 6d65 6465 6c74 610a 6672 6f6d 2069 7465  medelta.from ite
+000000e0: 7274 6f6f 6c73 2069 6d70 6f72 7420 6368  rtools import ch
+000000f0: 6169 6e0a 6672 6f6d 206e 756d 6265 7273  ain.from numbers
+00000100: 2069 6d70 6f72 7420 4e75 6d62 6572 0a66   import Number.f
+00000110: 726f 6d20 7479 7069 6e67 2069 6d70 6f72  rom typing impor
+00000120: 7420 416e 792c 2054 7970 6556 6172 0a0a  t Any, TypeVar..
+00000130: 696d 706f 7274 206e 756d 7079 2061 7320  import numpy as 
+00000140: 6e70 0a66 726f 6d20 626f 6b65 682e 636f  np.from bokeh.co
+00000150: 7265 2e70 726f 7065 7274 6965 7320 696d  re.properties im
+00000160: 706f 7274 2076 616c 7565 2c20 7769 7468  port value, with
+00000170: 6f75 745f 7072 6f70 6572 7479 5f76 616c  out_property_val
+00000180: 6964 6174 696f 6e0a 6672 6f6d 2062 6f6b  idation.from bok
+00000190: 6568 2e69 6f20 696d 706f 7274 2063 7572  eh.io import cur
+000001a0: 646f 630a 6672 6f6d 2062 6f6b 6568 2e6c  doc.from bokeh.l
+000001b0: 6179 6f75 7473 2069 6d70 6f72 7420 636f  ayouts import co
+000001c0: 6c75 6d6e 2c20 726f 770a 6672 6f6d 2062  lumn, row.from b
+000001d0: 6f6b 6568 2e6d 6f64 656c 7320 696d 706f  okeh.models impo
+000001e0: 7274 2028 0a20 2020 2041 6461 7074 6976  rt (.    Adaptiv
+000001f0: 6554 6963 6b65 722c 0a20 2020 2041 7272  eTicker,.    Arr
+00000200: 6f77 2c0a 2020 2020 4261 7369 6354 6963  ow,.    BasicTic
+00000210: 6b65 722c 0a20 2020 2042 6f78 5365 6c65  ker,.    BoxSele
+00000220: 6374 546f 6f6c 2c0a 2020 2020 426f 785a  ctTool,.    BoxZ
+00000230: 6f6f 6d54 6f6f 6c2c 0a20 2020 2043 4453  oomTool,.    CDS
+00000240: 5669 6577 2c0a 2020 2020 436f 6c6f 7242  View,.    ColorB
+00000250: 6172 2c0a 2020 2020 436f 6c75 6d6e 4461  ar,.    ColumnDa
+00000260: 7461 536f 7572 6365 2c0a 2020 2020 4375  taSource,.    Cu
+00000270: 7374 6f6d 4a53 486f 7665 722c 0a20 2020  stomJSHover,.   
+00000280: 2044 6174 6152 616e 6765 3164 2c0a 2020   DataRange1d,.  
+00000290: 2020 4661 6374 6f72 5261 6e67 652c 0a20    FactorRange,. 
+000002a0: 2020 2047 726f 7570 4669 6c74 6572 2c0a     GroupFilter,.
+000002b0: 2020 2020 4865 6c70 546f 6f6c 2c0a 2020      HelpTool,.  
+000002c0: 2020 486f 7665 7254 6f6f 6c2c 0a20 2020    HoverTool,.   
+000002d0: 2048 544d 4c54 656d 706c 6174 6546 6f72   HTMLTemplateFor
+000002e0: 6d61 7474 6572 2c0a 2020 2020 4d75 6c74  matter,.    Mult
+000002f0: 6943 686f 6963 652c 0a20 2020 204e 756d  iChoice,.    Num
+00000300: 6265 7246 6f72 6d61 7474 6572 2c0a 2020  berFormatter,.  
+00000310: 2020 4e75 6d65 7261 6c54 6963 6b46 6f72    NumeralTickFor
+00000320: 6d61 7474 6572 2c0a 2020 2020 4f70 656e  matter,.    Open
+00000330: 5552 4c2c 0a20 2020 2050 616e 546f 6f6c  URL,.    PanTool
+00000340: 2c0a 2020 2020 5261 6e67 6531 642c 0a20  ,.    Range1d,. 
+00000350: 2020 2052 6573 6574 546f 6f6c 2c0a 2020     ResetTool,.  
+00000360: 2020 5365 6c65 6374 2c0a 2020 2020 5461    Select,.    Ta
+00000370: 6273 2c0a 2020 2020 5461 7054 6f6f 6c2c  bs,.    TapTool,
+00000380: 0a20 2020 2054 6974 6c65 2c0a 2020 2020  .    Title,.    
+00000390: 5665 6548 6561 642c 0a20 2020 2057 6865  VeeHead,.    Whe
+000003a0: 656c 5a6f 6f6d 546f 6f6c 2c0a 290a 6672  elZoomTool,.).fr
+000003b0: 6f6d 2062 6f6b 6568 2e6d 6f64 656c 732e  om bokeh.models.
+000003c0: 7769 6467 6574 7320 696d 706f 7274 2044  widgets import D
+000003d0: 6174 6154 6162 6c65 2c20 5461 626c 6543  ataTable, TableC
+000003e0: 6f6c 756d 6e0a 6672 6f6d 2062 6f6b 6568  olumn.from bokeh
+000003f0: 2e6d 6f64 656c 732e 7769 6467 6574 732e  .models.widgets.
+00000400: 6d61 726b 7570 7320 696d 706f 7274 2044  markups import D
+00000410: 6976 0a66 726f 6d20 626f 6b65 682e 7061  iv.from bokeh.pa
+00000420: 6c65 7474 6573 2069 6d70 6f72 7420 5669  lettes import Vi
+00000430: 7269 6469 7331 312c 2059 6c47 6e42 7539  ridis11, YlGnBu9
+00000440: 2c20 696e 7465 7270 5f70 616c 6574 7465  , interp_palette
+00000450: 0a66 726f 6d20 626f 6b65 682e 706c 6f74  .from bokeh.plot
+00000460: 7469 6e67 2069 6d70 6f72 7420 6669 6775  ting import figu
+00000470: 7265 0a66 726f 6d20 626f 6b65 682e 7468  re.from bokeh.th
+00000480: 656d 6573 2069 6d70 6f72 7420 5468 656d  emes import Them
+00000490: 650a 6672 6f6d 2062 6f6b 6568 2e74 7261  e.from bokeh.tra
+000004a0: 6e73 666f 726d 2069 6d70 6f72 7420 6375  nsform import cu
+000004b0: 6d73 756d 2c20 6661 6374 6f72 5f63 6d61  msum, factor_cma
+000004c0: 702c 206c 696e 6561 725f 636d 6170 2c20  p, linear_cmap, 
+000004d0: 7374 6163 6b0a 6672 6f6d 206a 696e 6a61  stack.from jinja
+000004e0: 3220 696d 706f 7274 2045 6e76 6972 6f6e  2 import Environ
+000004f0: 6d65 6e74 2c20 4669 6c65 5379 7374 656d  ment, FileSystem
+00000500: 4c6f 6164 6572 0a66 726f 6d20 746c 7a20  Loader.from tlz 
+00000510: 696d 706f 7274 2063 7572 7279 2c20 7069  import curry, pi
+00000520: 7065 2c20 7661 6c6d 6170 0a66 726f 6d20  pe, valmap.from 
+00000530: 746c 7a2e 6375 7272 6965 6420 696d 706f  tlz.curried impo
+00000540: 7274 2063 6f6e 6361 742c 2067 726f 7570  rt concat, group
+00000550: 6279 2c20 6d61 700a 6672 6f6d 2074 6f72  by, map.from tor
+00000560: 6e61 646f 2069 6d70 6f72 7420 6573 6361  nado import esca
+00000570: 7065 0a0a 696d 706f 7274 2064 6173 6b0a  pe..import dask.
+00000580: 6672 6f6d 2064 6173 6b20 696d 706f 7274  from dask import
+00000590: 2063 6f6e 6669 670a 6672 6f6d 2064 6173   config.from das
+000005a0: 6b2e 7574 696c 7320 696d 706f 7274 2028  k.utils import (
+000005b0: 0a20 2020 2066 6f72 6d61 745f 6279 7465  .    format_byte
+000005c0: 732c 0a20 2020 2066 6f72 6d61 745f 7469  s,.    format_ti
+000005d0: 6d65 2c0a 2020 2020 6675 6e63 6e61 6d65  me,.    funcname
+000005e0: 2c0a 2020 2020 6b65 795f 7370 6c69 742c  ,.    key_split,
+000005f0: 0a20 2020 2070 6172 7365 5f62 7974 6573  .    parse_bytes
+00000600: 2c0a 2020 2020 7061 7273 655f 7469 6d65  ,.    parse_time
+00000610: 6465 6c74 612c 0a29 0a0a 6672 6f6d 2064  delta,.)..from d
+00000620: 6973 7472 6962 7574 6564 2e63 6f72 6520  istributed.core 
+00000630: 696d 706f 7274 2053 7461 7475 730a 6672  import Status.fr
+00000640: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00000650: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
+00000660: 6e74 7320 696d 706f 7274 2061 6464 5f70  nts import add_p
+00000670: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00000680: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000690: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
+000006a0: 6f6e 656e 7473 2e73 6861 7265 6420 696d  onents.shared im
+000006b0: 706f 7274 2028 0a20 2020 2044 6173 6862  port (.    Dashb
+000006c0: 6f61 7264 436f 6d70 6f6e 656e 742c 0a20  oardComponent,. 
+000006d0: 2020 2050 726f 6669 6c65 5365 7276 6572     ProfileServer
+000006e0: 2c0a 2020 2020 5072 6f66 696c 6554 696d  ,.    ProfileTim
+000006f0: 6550 6c6f 742c 0a20 2020 2053 7973 7465  ePlot,.    Syste
+00000700: 6d4d 6f6e 6974 6f72 2c0a 290a 6672 6f6d  mMonitor,.).from
+00000710: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00000720: 6862 6f61 7264 2e63 6f72 6520 696d 706f  hboard.core impo
+00000730: 7274 2054 6162 5061 6e65 6c0a 6672 6f6d  rt TabPanel.from
+00000740: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00000750: 6862 6f61 7264 2e75 7469 6c73 2069 6d70  hboard.utils imp
+00000760: 6f72 7420 280a 2020 2020 5f44 4154 4154  ort (.    _DATAT
+00000770: 4142 4c45 5f53 5459 4c45 5348 4545 5453  ABLE_STYLESHEETS
+00000780: 5f4b 5741 5247 532c 0a20 2020 2042 4f4b  _KWARGS,.    BOK
+00000790: 4548 5f56 4552 5349 4f4e 2c0a 2020 2020  EH_VERSION,.    
+000007a0: 5052 4f46 494c 494e 472c 0a20 2020 2074  PROFILING,.    t
+000007b0: 7261 6e73 706f 7365 2c0a 2020 2020 7570  ranspose,.    up
+000007c0: 6461 7465 2c0a 290a 6672 6f6d 2064 6973  date,.).from dis
+000007d0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
+000007e0: 7469 6373 2e67 7261 7068 5f6c 6179 6f75  tics.graph_layou
+000007f0: 7420 696d 706f 7274 2047 7261 7068 4c61  t import GraphLa
+00000800: 796f 7574 0a66 726f 6d20 6469 7374 7269  yout.from distri
+00000810: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
+00000820: 732e 7072 6f67 7265 7373 2069 6d70 6f72  s.progress impor
+00000830: 7420 4772 6f75 7054 696d 696e 670a 6672  t GroupTiming.fr
+00000840: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00000850: 6961 676e 6f73 7469 6373 2e70 726f 6772  iagnostics.progr
+00000860: 6573 735f 7374 7265 616d 2069 6d70 6f72  ess_stream impor
+00000870: 7420 636f 6c6f 725f 6f66 2c20 7072 6f67  t color_of, prog
+00000880: 7265 7373 5f71 7561 6473 0a66 726f 6d20  ress_quads.from 
+00000890: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
+000008a0: 6e6f 7374 6963 732e 7461 736b 5f73 7472  nostics.task_str
+000008b0: 6561 6d20 696d 706f 7274 2054 6173 6b53  eam import TaskS
+000008c0: 7472 6561 6d50 6c75 6769 6e0a 6672 6f6d  treamPlugin.from
+000008d0: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
+000008e0: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
+000008f0: 7265 616d 2069 6d70 6f72 7420 636f 6c6f  ream import colo
+00000900: 725f 6f66 2061 7320 7473 5f63 6f6c 6f72  r_of as ts_color
+00000910: 5f6f 660a 6672 6f6d 2064 6973 7472 6962  _of.from distrib
+00000920: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
+00000930: 2e74 6173 6b5f 7374 7265 616d 2069 6d70  .task_stream imp
+00000940: 6f72 7420 636f 6c6f 7273 2061 7320 7473  ort colors as ts
+00000950: 5f63 6f6c 6f72 5f6c 6f6f 6b75 700a 6672  _color_lookup.fr
+00000960: 6f6d 2064 6973 7472 6962 7574 6564 2e6d  om distributed.m
+00000970: 6574 7269 6373 2069 6d70 6f72 7420 7469  etrics import ti
+00000980: 6d65 0a66 726f 6d20 6469 7374 7269 6275  me.from distribu
+00000990: 7465 642e 7363 6865 6475 6c65 7220 696d  ted.scheduler im
+000009a0: 706f 7274 2053 6368 6564 756c 6572 0a66  port Scheduler.f
+000009b0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000009c0: 7574 696c 7320 696d 706f 7274 204c 6f67  utils import Log
+000009d0: 2c20 6c6f 675f 6572 726f 7273 0a0a 6966  , log_errors..if
+000009e0: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+000009f0: 2822 6469 7374 7269 6275 7465 642e 6461  ("distributed.da
+00000a00: 7368 626f 6172 642e 6578 706f 7274 2d74  shboard.export-t
+00000a10: 6f6f 6c22 293a 0a20 2020 2066 726f 6d20  ool"):.    from 
+00000a20: 6469 7374 7269 6275 7465 642e 6461 7368  distributed.dash
+00000a30: 626f 6172 642e 6578 706f 7274 5f74 6f6f  board.export_too
+00000a40: 6c20 696d 706f 7274 2045 7870 6f72 7454  l import ExportT
+00000a50: 6f6f 6c0a 656c 7365 3a0a 2020 2020 4578  ool.else:.    Ex
+00000a60: 706f 7274 546f 6f6c 203d 204e 6f6e 6520  portTool = None 
+00000a70: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+00000a80: 0a54 203d 2054 7970 6556 6172 2822 5422  .T = TypeVar("T"
+00000a90: 290a 0a6c 6f67 6765 7220 3d20 6c6f 6767  )..logger = logg
+00000aa0: 696e 672e 6765 744c 6f67 6765 7228 5f5f  ing.getLogger(__
+00000ab0: 6e61 6d65 5f5f 290a 0a65 6e76 203d 2045  name__)..env = E
+00000ac0: 6e76 6972 6f6e 6d65 6e74 280a 2020 2020  nvironment(.    
+00000ad0: 6c6f 6164 6572 3d46 696c 6553 7973 7465  loader=FileSyste
+00000ae0: 6d4c 6f61 6465 7228 0a20 2020 2020 2020  mLoader(.       
+00000af0: 206f 732e 7061 7468 2e6a 6f69 6e28 6f73   os.path.join(os
+00000b00: 2e70 6174 682e 6469 726e 616d 6528 5f5f  .path.dirname(__
+00000b10: 6669 6c65 5f5f 292c 2022 2e2e 222c 2022  file__), "..", "
+00000b20: 2e2e 222c 2022 6874 7470 222c 2022 7465  ..", "http", "te
+00000b30: 6d70 6c61 7465 7322 290a 2020 2020 290a  mplates").    ).
+00000b40: 290a 0a42 4f4b 4548 5f54 4845 4d45 203d  )..BOKEH_THEME =
+00000b50: 2054 6865 6d65 280a 2020 2020 6669 6c65   Theme(.    file
+00000b60: 6e61 6d65 3d6f 732e 7061 7468 2e6a 6f69  name=os.path.joi
+00000b70: 6e28 6f73 2e70 6174 682e 6469 726e 616d  n(os.path.dirnam
+00000b80: 6528 5f5f 6669 6c65 5f5f 292c 2022 2e2e  e(__file__), "..
+00000b90: 222c 2022 7468 656d 652e 7961 6d6c 2229  ", "theme.yaml")
+00000ba0: 0a29 0a54 4943 4b53 5f31 3032 3420 3d20  .).TICKS_1024 = 
+00000bb0: 7b22 6261 7365 223a 2031 3032 342c 2022  {"base": 1024, "
+00000bc0: 6d61 6e74 6973 7361 7322 3a20 5b31 2c20  mantissas": [1, 
+00000bd0: 322c 2034 2c20 382c 2031 362c 2033 322c  2, 4, 8, 16, 32,
+00000be0: 2036 342c 2031 3238 2c20 3235 362c 2035   64, 128, 256, 5
+00000bf0: 3132 5d7d 0a58 4c41 4245 4c5f 4f52 4945  12]}.XLABEL_ORIE
+00000c00: 4e54 4154 494f 4e20 3d20 2d6d 6174 682e  NTATION = -math.
+00000c10: 7069 202f 2039 2020 2320 736c 616e 7465  pi / 9  # slante
+00000c20: 6420 646f 776e 7761 7264 7320 3230 2064  d downwards 20 d
+00000c30: 6567 7265 6573 0a0a 0a6c 6f67 6f73 5f64  egrees...logos_d
+00000c40: 6963 7420 3d20 7b0a 2020 2020 226e 756d  ict = {.    "num
+00000c50: 7079 223a 2022 7374 6174 6963 732f 696d  py": "statics/im
+00000c60: 6167 6573 2f6e 756d 7079 2e70 6e67 222c  ages/numpy.png",
+00000c70: 0a20 2020 2022 7061 6e64 6173 223a 2022  .    "pandas": "
+00000c80: 7374 6174 6963 732f 696d 6167 6573 2f70  statics/images/p
+00000c90: 616e 6461 732e 706e 6722 2c0a 2020 2020  andas.png",.    
+00000ca0: 2262 7569 6c74 696e 7322 3a20 2273 7461  "builtins": "sta
+00000cb0: 7469 6373 2f69 6d61 6765 732f 7079 7468  tics/images/pyth
+00000cc0: 6f6e 2e70 6e67 222c 0a7d 0a0a 0a63 6c61  on.png",.}...cla
+00000cd0: 7373 204f 6363 7570 616e 6379 2844 6173  ss Occupancy(Das
+00000ce0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+00000cf0: 3a0a 2020 2020 2222 224f 6363 7570 616e  :.    """Occupan
+00000d00: 6379 2028 696e 2074 696d 6529 2070 6572  cy (in time) per
+00000d10: 2077 6f72 6b65 7222 2222 0a0a 2020 2020   worker"""..    
+00000d20: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00000d30: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00000d40: 662c 2073 6368 6564 756c 6572 2c20 2a2a  f, scheduler, **
+00000d50: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00000d60: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+00000d70: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+00000d80: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+00000d90: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00000da0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00000db0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00000dc0: 2020 226f 6363 7570 616e 6379 223a 205b    "occupancy": [
+00000dd0: 302c 2030 5d2c 0a20 2020 2020 2020 2020  0, 0],.         
+00000de0: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
+00000df0: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
+00000e00: 2020 2020 2020 2020 2020 2020 2022 7822               "x"
+00000e10: 3a20 5b30 2e30 2c20 302e 315d 2c0a 2020  : [0.0, 0.1],.  
+00000e20: 2020 2020 2020 2020 2020 2020 2020 2279                "y
+00000e30: 223a 205b 312c 2032 5d2c 0a20 2020 2020  ": [1, 2],.     
+00000e40: 2020 2020 2020 2020 2020 2022 6d73 223a             "ms":
+00000e50: 205b 312c 2032 5d2c 0a20 2020 2020 2020   [1, 2],.       
+00000e60: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
+00000e70: 3a20 5b22 7265 6422 2c20 2262 6c75 6522  : ["red", "blue"
+00000e80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00000e90: 2020 2022 6573 6361 7065 645f 776f 726b     "escaped_work
+00000ea0: 6572 223a 205b 2261 222c 2022 6222 5d2c  er": ["a", "b"],
+00000eb0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00000ec0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00000ed0: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00000ee0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+00000ef0: 2020 7469 746c 653d 224f 6363 7570 616e    title="Occupan
+00000f00: 6379 222c 0a20 2020 2020 2020 2020 2020  cy",.           
+00000f10: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+00000f20: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
+00000f30: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
+00000f40: 0a20 2020 2020 2020 2020 2020 2078 5f61  .            x_a
+00000f50: 7869 735f 7479 7065 3d22 6461 7465 7469  xis_type="dateti
+00000f60: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+00000f70: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
+00000f80: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
+00000f90: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00000fa0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00000fb0: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
+00000fc0: 7265 6374 280a 2020 2020 2020 2020 2020  rect(.          
+00000fd0: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+00000fe0: 7572 6365 2c20 783d 2278 222c 2077 6964  urce, x="x", wid
+00000ff0: 7468 3d22 6d73 222c 2079 3d22 7922 2c20  th="ms", y="y", 
+00001000: 6865 6967 6874 3d30 2e39 2c20 636f 6c6f  height=0.9, colo
+00001010: 723d 2263 6f6c 6f72 220a 2020 2020 2020  r="color".      
+00001020: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
+00001030: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
+00001040: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
+00001050: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+00001060: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
+00001070: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
+00001080: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00001090: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
+000010a0: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+000010b0: 6c66 2e72 6f6f 742e 7967 7269 642e 7669  lf.root.ygrid.vi
+000010c0: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+000010d0: 2020 2020 2020 2320 6669 672e 7861 7869        # fig.xaxi
+000010e0: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
+000010f0: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
+00001100: 6174 7465 7228 666f 726d 6174 3d27 302e  atter(format='0.
+00001110: 3073 2729 0a20 2020 2020 2020 2073 656c  0s').        sel
+00001120: 662e 726f 6f74 2e78 5f72 616e 6765 2e73  f.root.x_range.s
+00001130: 7461 7274 203d 2030 0a0a 2020 2020 2020  tart = 0..      
+00001140: 2020 7461 7020 3d20 5461 7054 6f6f 6c28    tap = TapTool(
+00001150: 6361 6c6c 6261 636b 3d4f 7065 6e55 524c  callback=OpenURL
+00001160: 2875 726c 3d22 2e2f 696e 666f 2f77 6f72  (url="./info/wor
+00001170: 6b65 722f 4065 7363 6170 6564 5f77 6f72  ker/@escaped_wor
+00001180: 6b65 722e 6874 6d6c 2229 290a 0a20 2020  ker.html"))..   
+00001190: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
+000011a0: 6572 546f 6f6c 2829 0a20 2020 2020 2020  erTool().       
+000011b0: 2068 6f76 6572 2e74 6f6f 6c74 6970 7320   hover.tooltips 
+000011c0: 3d20 2240 776f 726b 6572 203a 2040 6f63  = "@worker : @oc
+000011d0: 6375 7061 6e63 7920 732e 220a 2020 2020  cupancy s.".    
+000011e0: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
+000011f0: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
+00001200: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
+00001210: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
+00001220: 6f6c 7328 686f 7665 722c 2074 6170 290a  ols(hover, tap).
+00001230: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+00001240: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+00001250: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+00001260: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+00001270: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00001280: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
+00001290: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+000012a0: 2e76 616c 7565 7328 290a 0a20 2020 2020  .values()..     
+000012b0: 2020 2079 203d 206c 6973 7428 7261 6e67     y = list(rang
+000012c0: 6528 6c65 6e28 776f 726b 6572 7329 2929  e(len(workers)))
+000012d0: 0a20 2020 2020 2020 206f 6363 7570 616e  .        occupan
+000012e0: 6379 203d 205b 7773 2e6f 6363 7570 616e  cy = [ws.occupan
+000012f0: 6379 2066 6f72 2077 7320 696e 2077 6f72  cy for ws in wor
+00001300: 6b65 7273 5d0a 2020 2020 2020 2020 6d73  kers].        ms
+00001310: 203d 205b 6f63 6320 2a20 3130 3030 2066   = [occ * 1000 f
+00001320: 6f72 206f 6363 2069 6e20 6f63 6375 7061  or occ in occupa
+00001330: 6e63 795d 0a20 2020 2020 2020 2078 203d  ncy].        x =
+00001340: 205b 6f63 6320 2f20 3530 3020 666f 7220   [occ / 500 for 
+00001350: 6f63 6320 696e 206f 6363 7570 616e 6379  occ in occupancy
+00001360: 5d0a 2020 2020 2020 2020 746f 7461 6c20  ].        total 
+00001370: 3d20 7375 6d28 6f63 6375 7061 6e63 7929  = sum(occupancy)
+00001380: 0a20 2020 2020 2020 2063 6f6c 6f72 203d  .        color =
+00001390: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+000013a0: 7773 2069 6e20 776f 726b 6572 733a 0a20  ws in workers:. 
+000013b0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
+000013c0: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+000013d0: 6572 2e69 646c 653a 0a20 2020 2020 2020  er.idle:.       
+000013e0: 2020 2020 2020 2020 2063 6f6c 6f72 2e61           color.a
+000013f0: 7070 656e 6428 2272 6564 2229 0a20 2020  ppend("red").   
+00001400: 2020 2020 2020 2020 2065 6c69 6620 7773           elif ws
+00001410: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+00001420: 6572 2e73 6174 7572 6174 6564 3a0a 2020  er.saturated:.  
+00001430: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00001440: 6c6f 722e 6170 7065 6e64 2822 6772 6565  lor.append("gree
+00001450: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
+00001460: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001470: 2020 2020 2020 636f 6c6f 722e 6170 7065        color.appe
+00001480: 6e64 2822 626c 7565 2229 0a0a 2020 2020  nd("blue")..    
+00001490: 2020 2020 6966 2074 6f74 616c 3a0a 2020      if total:.  
+000014a0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+000014b0: 6f6f 742e 7469 746c 652e 7465 7874 203d  oot.title.text =
+000014c0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000014d0: 2020 2066 224f 6363 7570 616e 6379 202d     f"Occupancy -
+000014e0: 2d20 746f 7461 6c20 7469 6d65 3a20 7b66  - total time: {f
+000014f0: 6f72 6d61 745f 7469 6d65 2874 6f74 616c  ormat_time(total
+00001500: 297d 2022 0a20 2020 2020 2020 2020 2020  )} ".           
+00001510: 2020 2020 2066 2277 616c 6c20 7469 6d65       f"wall time
+00001520: 3a20 7b66 6f72 6d61 745f 7469 6d65 2874  : {format_time(t
+00001530: 6f74 616c 202f 2073 656c 662e 7363 6865  otal / self.sche
+00001540: 6475 6c65 722e 746f 7461 6c5f 6e74 6872  duler.total_nthr
+00001550: 6561 6473 297d 220a 2020 2020 2020 2020  eads)}".        
+00001560: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00001570: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00001580: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
+00001590: 7465 7874 203d 2022 4f63 6375 7061 6e63  text = "Occupanc
+000015a0: 7922 0a0a 2020 2020 2020 2020 6966 206f  y"..        if o
+000015b0: 6363 7570 616e 6379 3a0a 2020 2020 2020  ccupancy:.      
+000015c0: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
+000015d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000015e0: 2022 6f63 6375 7061 6e63 7922 3a20 6f63   "occupancy": oc
+000015f0: 6375 7061 6e63 792c 0a20 2020 2020 2020  cupancy,.       
+00001600: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
+00001610: 223a 205b 7773 2e61 6464 7265 7373 2066  ": [ws.address f
+00001620: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
+00001630: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00001640: 2020 2022 6d73 223a 206d 732c 0a20 2020     "ms": ms,.   
+00001650: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00001660: 6c6f 7222 3a20 636f 6c6f 722c 0a20 2020  lor": color,.   
+00001670: 2020 2020 2020 2020 2020 2020 2022 6573               "es
+00001680: 6361 7065 645f 776f 726b 6572 223a 205b  caped_worker": [
+00001690: 6573 6361 7065 2e75 726c 5f65 7363 6170  escape.url_escap
+000016a0: 6528 7773 2e61 6464 7265 7373 2920 666f  e(ws.address) fo
+000016b0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
+000016c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000016d0: 2020 2278 223a 2078 2c0a 2020 2020 2020    "x": x,.      
+000016e0: 2020 2020 2020 2020 2020 2279 223a 2079            "y": y
+000016f0: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00001700: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
+00001710: 6174 6528 7365 6c66 2e73 6f75 7263 652c  ate(self.source,
+00001720: 2072 6573 756c 7429 0a0a 0a63 6c61 7373   result)...class
+00001730: 2050 726f 6365 7373 696e 6748 6973 746f   ProcessingHisto
+00001740: 6772 616d 2844 6173 6862 6f61 7264 436f  gram(DashboardCo
+00001750: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
+00001760: 2248 6f77 206d 616e 7920 7461 736b 7320  "How many tasks 
+00001770: 6172 6520 6f6e 2065 6163 6820 776f 726b  are on each work
+00001780: 6572 2222 220a 0a20 2020 2040 6c6f 675f  er"""..    @log_
+00001790: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
+000017a0: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+000017b0: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+000017c0: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+000017d0: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
+000017e0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+000017f0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+00001800: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+00001810: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+00001820: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+00001830: 207b 226c 6566 7422 3a20 5b31 2c20 325d   {"left": [1, 2]
+00001840: 2c20 2272 6967 6874 223a 205b 3130 2c20  , "right": [10, 
+00001850: 3130 5d2c 2022 746f 7022 3a20 5b30 2c20  10], "top": [0, 
+00001860: 305d 7d0a 2020 2020 2020 2020 290a 0a20  0]}.        ).. 
+00001870: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00001880: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+00001890: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
+000018a0: 736b 7320 5072 6f63 6573 7369 6e67 2028  sks Processing (
+000018b0: 636f 756e 7429 222c 0a20 2020 2020 2020  count)",.       
+000018c0: 2020 2020 206e 616d 653d 2270 726f 6365       name="proce
+000018d0: 7373 696e 6722 2c0a 2020 2020 2020 2020  ssing",.        
+000018e0: 2020 2020 795f 6178 6973 5f6c 6162 656c      y_axis_label
+000018f0: 3d22 6672 6571 7565 6e63 7922 2c0a 2020  ="frequency",.  
+00001900: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00001910: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00001920: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00001930: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00001940: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
+00001950: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+00001960: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+00001970: 656c 662e 726f 6f74 2e79 6772 6964 2e76  elf.root.ygrid.v
+00001980: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+00001990: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+000019a0: 742e 746f 6f6c 6261 725f 6c6f 6361 7469  t.toolbar_locati
+000019b0: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
+000019c0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
+000019d0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+000019e0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+000019f0: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
+00001a00: 6566 743d 226c 6566 7422 2c0a 2020 2020  eft="left",.    
+00001a10: 2020 2020 2020 2020 7269 6768 743d 2272          right="r
+00001a20: 6967 6874 222c 0a20 2020 2020 2020 2020  ight",.         
+00001a30: 2020 2062 6f74 746f 6d3d 302c 0a20 2020     bottom=0,.   
+00001a40: 2020 2020 2020 2020 2074 6f70 3d22 746f           top="to
+00001a50: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
+00001a60: 636f 6c6f 723d 2264 6565 7073 6b79 626c  color="deepskybl
+00001a70: 7565 222c 0a20 2020 2020 2020 2020 2020  ue",.           
+00001a80: 2066 696c 6c5f 616c 7068 613d 302e 352c   fill_alpha=0.5,
+00001a90: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00001aa0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00001ab0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00001ac0: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+00001ad0: 293a 0a20 2020 2020 2020 204c 203d 205b  ):.        L = [
+00001ae0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
+00001af0: 6729 2066 6f72 2077 7320 696e 2073 656c  g) for ws in sel
+00001b00: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+00001b10: 6572 732e 7661 6c75 6573 2829 5d0a 2020  ers.values()].  
+00001b20: 2020 2020 2020 636f 756e 7473 2c20 7820        counts, x 
+00001b30: 3d20 6e70 2e68 6973 746f 6772 616d 284c  = np.histogram(L
+00001b40: 2c20 6269 6e73 3d34 3029 0a20 2020 2020  , bins=40).     
+00001b50: 2020 2073 656c 662e 736f 7572 6365 2e64     self.source.d
+00001b60: 6174 612e 7570 6461 7465 287b 226c 6566  ata.update({"lef
+00001b70: 7422 3a20 785b 3a2d 315d 2c20 2272 6967  t": x[:-1], "rig
+00001b80: 6874 223a 2078 5b31 3a5d 2c20 2274 6f70  ht": x[1:], "top
+00001b90: 223a 2063 6f75 6e74 737d 290a 0a0a 636c  ": counts})...cl
+00001ba0: 6173 7320 4d65 6d6f 7279 436f 6c6f 723a  ass MemoryColor:
+00001bb0: 0a20 2020 2022 2222 4368 616e 6765 2074  .    """Change t
+00001bc0: 6865 2063 6f6c 6f72 206f 6620 7468 6520  he color of the 
+00001bd0: 6d65 6d6f 7279 2062 6172 7320 6672 6f6d  memory bars from
+00001be0: 2062 6c75 6520 746f 206f 7261 6e67 6520   blue to orange 
+00001bf0: 7768 656e 2070 726f 6365 7373 206d 656d  when process mem
+00001c00: 6f72 7920 676f 6573 0a20 2020 2061 626f  ory goes.    abo
+00001c10: 7665 2074 6865 2060 6074 6172 6765 7460  ve the ``target`
+00001c20: 6020 7468 7265 7368 6f6c 6420 616e 6420  ` threshold and 
+00001c30: 746f 2072 6564 2077 6865 6e20 7468 6520  to red when the 
+00001c40: 776f 726b 6572 2070 6175 7365 732e 0a20  worker pauses.. 
+00001c50: 2020 2057 6f72 6b65 7273 2069 6e20 6060     Workers in ``
+00001c60: 636c 6f73 696e 675f 6772 6163 6566 756c  closing_graceful
+00001c70: 6c79 6060 2073 7461 7465 2077 696c 6c20  ly`` state will 
+00001c80: 616c 736f 2062 6520 6f72 616e 6765 2e0a  also be orange..
+00001c90: 0a20 2020 2049 6620 6060 7461 7267 6574  .    If ``target
+00001ca0: 6060 2069 7320 6469 7361 626c 6564 2c20  `` is disabled, 
+00001cb0: 6368 616e 6765 2074 6f20 6f72 616e 6765  change to orange
+00001cc0: 206f 6e20 6060 7370 696c 6c60 6020 696e   on ``spill`` in
+00001cd0: 7374 6561 642e 0a20 2020 2049 6620 7370  stead..    If sp
+00001ce0: 696c 6c69 6e67 2069 7320 636f 6d70 6c65  illing is comple
+00001cf0: 7465 6c79 2064 6973 6162 6c65 642c 206e  tely disabled, n
+00001d00: 6576 6572 2074 7572 6e20 6f72 616e 6765  ever turn orange
+00001d10: 2e0a 0a20 2020 2049 6620 7061 7573 696e  ...    If pausin
+00001d20: 6720 6973 2064 6973 6162 6c65 642c 2063  g is disabled, c
+00001d30: 6861 6e67 6520 746f 2072 6564 2077 6865  hange to red whe
+00001d40: 6e20 7061 7373 696e 6720 7468 6520 6060  n passing the ``
+00001d50: 7465 726d 696e 6174 6560 6020 7468 7265  terminate`` thre
+00001d60: 7368 6f6c 640a 2020 2020 696e 7374 6561  shold.    instea
+00001d70: 642e 2049 6620 626f 7468 2070 6175 7365  d. If both pause
+00001d80: 2061 6e64 2074 6572 6d69 6e61 7465 2061   and terminate a
+00001d90: 7265 2064 6973 6162 6c65 642c 2074 7572  re disabled, tur
+00001da0: 6e20 7265 6420 7768 656e 2070 6173 7369  n red when passi
+00001db0: 6e67 0a20 2020 2060 606d 656d 6f72 795f  ng.    ``memory_
+00001dc0: 6c69 6d69 7460 602e 0a0a 2020 2020 4e6f  limit``...    No
+00001dd0: 7465 0a20 2020 202d 2d2d 2d0a 2020 2020  te.    ----.    
+00001de0: 4120 776f 726b 6572 2077 696c 6c20 7374  A worker will st
+00001df0: 6172 7420 7370 696c 6c69 6e67 2077 6865  art spilling whe
+00001e00: 6e20 6d61 6e61 6765 6420 6d65 6d6f 7279  n managed memory
+00001e10: 2061 6c6f 6e65 2070 6173 7365 7320 7468   alone passes th
+00001e20: 6520 7461 7267 6574 2074 6872 6573 686f  e target thresho
+00001e30: 6c64 2e0a 2020 2020 486f 7765 7665 722c  ld..    However,
+00001e40: 2068 6572 6520 7765 2772 6520 7377 6974   here we're swit
+00001e50: 6368 696e 6720 746f 206f 7261 6e67 6520  ching to orange 
+00001e60: 7768 656e 2074 6865 2070 726f 6365 7373  when the process
+00001e70: 206d 656d 6f72 7920 676f 6573 2062 6579   memory goes bey
+00001e80: 6f6e 6420 7461 7267 6574 2c0a 2020 2020  ond target,.    
+00001e90: 7768 6963 6820 6973 2075 7375 616c 6c79  which is usually
+00001ea0: 2065 6172 6c69 6572 2e0a 2020 2020 5468   earlier..    Th
+00001eb0: 6973 2069 7320 6465 6c69 6265 7261 7465  is is deliberate
+00001ec0: 2066 6f72 2074 6865 2073 616b 6520 6f66   for the sake of
+00001ed0: 2073 696d 706c 6963 6974 7920 616e 6420   simplicity and 
+00001ee0: 616c 736f 2062 6563 6175 7365 2c20 7768  also because, wh
+00001ef0: 656e 2074 6865 2070 726f 6365 7373 0a20  en the process. 
+00001f00: 2020 206d 656d 6f72 7920 7061 7373 6573     memory passes
+00001f10: 2074 6865 2073 7069 6c6c 2074 6872 6573   the spill thres
+00001f20: 686f 6c64 2c20 6974 2077 696c 6c20 6b65  hold, it will ke
+00001f30: 6570 2073 7069 6c6c 696e 6720 756e 7469  ep spilling unti
+00001f40: 6c20 6974 2066 616c 6c73 2062 656c 6f77  l it falls below
+00001f50: 2074 6865 0a20 2020 2074 6172 6765 7420   the.    target 
+00001f60: 7468 7265 7368 6f6c 6420 2d20 736f 2069  threshold - so i
+00001f70: 7427 7320 6e6f 7420 636f 6d70 6c65 7465  t's not complete
+00001f80: 6c79 2077 726f 6e67 2e20 4167 6169 6e2c  ly wrong. Again,
+00001f90: 2077 6520 646f 6e27 7420 7761 6e74 2074   we don't want t
+00001fa0: 6f20 7472 6163 6b0a 2020 2020 7468 6520  o track.    the 
+00001fb0: 6879 7374 6572 6573 6973 2063 7963 6c65  hysteresis cycle
+00001fc0: 206f 6620 7468 6520 7370 696c 6c20 7379   of the spill sy
+00001fd0: 7374 656d 2068 6572 6520 666f 7220 7468  stem here for th
+00001fe0: 6520 7361 6b65 206f 6620 7369 6d70 6c69  e sake of simpli
+00001ff0: 6369 7479 2e0a 0a20 2020 2049 6e20 7368  city...    In sh
+00002000: 6f72 742c 206f 7261 6e67 6520 7368 6f75  ort, orange shou
+00002010: 6c64 2062 6520 7472 6561 7465 6420 6173  ld be treated as
+00002020: 2022 7468 6520 776f 726b 6572 202a 6d61   "the worker *ma
+00002030: 792a 2062 6520 7370 696c 6c69 6e67 222e  y* be spilling".
+00002040: 0a20 2020 2022 2222 0a0a 2020 2020 6f72  .    """..    or
+00002050: 616e 6765 3a20 666c 6f61 740a 2020 2020  ange: float.    
+00002060: 7265 643a 2066 6c6f 6174 0a0a 2020 2020  red: float..    
+00002070: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00002080: 6629 3a0a 2020 2020 2020 2020 7461 7267  f):.        targ
+00002090: 6574 203d 2064 6173 6b2e 636f 6e66 6967  et = dask.config
+000020a0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+000020b0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+000020c0: 7461 7267 6574 2229 0a20 2020 2020 2020  target").       
+000020d0: 2073 7069 6c6c 203d 2064 6173 6b2e 636f   spill = dask.co
+000020e0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+000020f0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+00002100: 6f72 792e 7370 696c 6c22 290a 2020 2020  ory.spill").    
+00002110: 2020 2020 7465 726d 696e 6174 6520 3d20      terminate = 
+00002120: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+00002130: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
+00002140: 6b65 722e 6d65 6d6f 7279 2e74 6572 6d69  ker.memory.termi
+00002150: 6e61 7465 2229 0a20 2020 2020 2020 2023  nate").        #
+00002160: 2054 6865 7365 2076 616c 7565 7320 6361   These values ca
+00002170: 6e20 6265 2046 616c 7365 2e20 4974 2773  n be False. It's
+00002180: 2061 6c73 6f20 636f 6d6d 6f6e 2074 6f20   also common to 
+00002190: 636f 6e66 6967 7572 6520 7468 656d 2074  configure them t
+000021a0: 6f20 696d 706f 7373 6962 6c79 0a20 2020  o impossibly.   
+000021b0: 2020 2020 2023 2068 6967 6820 7661 6c75       # high valu
+000021c0: 6573 2074 6f20 6163 6869 6576 6520 7468  es to achieve th
+000021d0: 6520 7361 6d65 2065 6666 6563 742e 0a20  e same effect.. 
+000021e0: 2020 2020 2020 2073 656c 662e 6f72 616e         self.oran
+000021f0: 6765 203d 206d 696e 2874 6172 6765 7420  ge = min(target 
+00002200: 6f72 206d 6174 682e 696e 662c 2073 7069  or math.inf, spi
+00002210: 6c6c 206f 7220 6d61 7468 2e69 6e66 290a  ll or math.inf).
+00002220: 2020 2020 2020 2020 7365 6c66 2e72 6564          self.red
+00002230: 203d 206d 696e 2874 6572 6d69 6e61 7465   = min(terminate
+00002240: 206f 7220 6d61 7468 2e69 6e66 2c20 312e   or math.inf, 1.
+00002250: 3029 0a0a 2020 2020 6465 6620 5f6d 656d  0)..    def _mem
+00002260: 6f72 795f 636f 6c6f 7228 7365 6c66 2c20  ory_color(self, 
+00002270: 6375 7272 656e 743a 2069 6e74 2c20 6c69  current: int, li
+00002280: 6d69 743a 2069 6e74 2c20 7374 6174 7573  mit: int, status
+00002290: 3a20 5374 6174 7573 2920 2d3e 2073 7472  : Status) -> str
+000022a0: 3a0a 2020 2020 2020 2020 6966 2073 7461  :.        if sta
+000022b0: 7475 7320 213d 2053 7461 7475 732e 7275  tus != Status.ru
+000022c0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
+000022d0: 2020 2072 6574 7572 6e20 2272 6564 220a     return "red".
+000022e0: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
+000022f0: 696d 6974 3a0a 2020 2020 2020 2020 2020  imit:.          
+00002300: 2020 7265 7475 726e 2022 626c 7565 220a    return "blue".
+00002310: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
+00002320: 6e74 203e 3d20 6c69 6d69 7420 2a20 7365  nt >= limit * se
+00002330: 6c66 2e72 6564 3a0a 2020 2020 2020 2020  lf.red:.        
+00002340: 2020 2020 7265 7475 726e 2022 7265 6422      return "red"
+00002350: 0a20 2020 2020 2020 2069 6620 6375 7272  .        if curr
+00002360: 656e 7420 3e3d 206c 696d 6974 202a 2073  ent >= limit * s
+00002370: 656c 662e 6f72 616e 6765 3a0a 2020 2020  elf.orange:.    
+00002380: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00002390: 6f72 616e 6765 220a 2020 2020 2020 2020  orange".        
+000023a0: 7265 7475 726e 2022 626c 7565 220a 0a0a  return "blue"...
+000023b0: 636c 6173 7320 436c 7573 7465 724d 656d  class ClusterMem
+000023c0: 6f72 7928 4461 7368 626f 6172 6443 6f6d  ory(DashboardCom
+000023d0: 706f 6e65 6e74 2c20 4d65 6d6f 7279 436f  ponent, MemoryCo
+000023e0: 6c6f 7229 3a0a 2020 2020 2222 2254 6f74  lor):.    """Tot
+000023f0: 616c 206d 656d 6f72 7920 7573 6167 6520  al memory usage 
+00002400: 6f6e 2074 6865 2063 6c75 7374 6572 2222  on the cluster""
+00002410: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
+00002420: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
+00002430: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+00002440: 6c65 722c 2077 6964 7468 3d36 3030 2c20  ler, width=600, 
+00002450: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00002460: 2020 2044 6173 6862 6f61 7264 436f 6d70     DashboardComp
+00002470: 6f6e 656e 742e 5f5f 696e 6974 5f5f 2873  onent.__init__(s
+00002480: 656c 6629 0a20 2020 2020 2020 204d 656d  elf).        Mem
+00002490: 6f72 7943 6f6c 6f72 2e5f 5f69 6e69 745f  oryColor.__init_
+000024a0: 5f28 7365 6c66 290a 0a20 2020 2020 2020  _(self)..       
+000024b0: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+000024c0: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+000024d0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
+000024e0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+000024f0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+00002500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00002510: 2020 2277 6964 7468 223a 205b 305d 202a    "width": [0] *
+00002520: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
+00002530: 2020 2020 2278 223a 205b 305d 202a 2034      "x": [0] * 4
+00002540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002550: 2020 2279 223a 205b 305d 202a 2034 2c0a    "y": [0] * 4,.
+00002560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002570: 2263 6f6c 6f72 223a 205b 2262 6c75 6522  "color": ["blue"
+00002580: 2c20 2262 6c75 6522 2c20 2262 6c75 6522  , "blue", "blue"
+00002590: 2c20 2267 7265 7922 5d2c 0a20 2020 2020  , "grey"],.     
+000025a0: 2020 2020 2020 2020 2020 2022 616c 7068             "alph
+000025b0: 6122 3a20 5b31 2c20 302e 372c 2030 2e34  a": [1, 0.7, 0.4
+000025c0: 2c20 315d 2c0a 2020 2020 2020 2020 2020  , 1],.          
+000025d0: 2020 2020 2020 2270 726f 635f 6d65 6d6f        "proc_memo
+000025e0: 7279 223a 205b 305d 202a 2034 2c0a 2020  ry": [0] * 4,.  
+000025f0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00002600: 616e 6167 6564 223a 205b 305d 202a 2034  anaged": [0] * 4
+00002610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002620: 2020 2275 6e6d 616e 6167 6564 5f6f 6c64    "unmanaged_old
+00002630: 223a 205b 305d 202a 2034 2c0a 2020 2020  ": [0] * 4,.    
+00002640: 2020 2020 2020 2020 2020 2020 2275 6e6d              "unm
+00002650: 616e 6167 6564 5f72 6563 656e 7422 3a20  anaged_recent": 
+00002660: 5b30 5d20 2a20 342c 0a20 2020 2020 2020  [0] * 4,.       
+00002670: 2020 2020 2020 2020 2022 7370 696c 6c65           "spille
+00002680: 6422 3a20 5b30 5d20 2a20 342c 0a20 2020  d": [0] * 4,.   
+00002690: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000026a0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+000026b0: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
+000026c0: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
+000026d0: 746c 653d 2242 7974 6573 2073 746f 7265  tle="Bytes store
+000026e0: 6420 6f6e 2063 6c75 7374 6572 222c 0a20  d on cluster",. 
+000026f0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+00002700: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+00002710: 2077 6964 7468 3d69 6e74 2877 6964 7468   width=int(width
+00002720: 202f 2032 292c 0a20 2020 2020 2020 2020   / 2),.         
+00002730: 2020 206e 616d 653d 2263 6c75 7374 6572     name="cluster
+00002740: 5f6d 656d 6f72 7922 2c0a 2020 2020 2020  _memory",.      
+00002750: 2020 2020 2020 6d69 6e5f 626f 7264 6572        min_border
+00002760: 5f62 6f74 746f 6d3d 3530 2c0a 2020 2020  _bottom=50,.    
+00002770: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00002780: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00002790: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
+000027a0: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
+000027b0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+000027c0: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+000027d0: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
+000027e0: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
+000027f0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00002800: 7468 3d22 7769 6474 6822 2c0a 2020 2020  th="width",.    
+00002810: 2020 2020 2020 2020 6865 6967 6874 3d30          height=0
+00002820: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
+00002830: 636f 6c6f 723d 2263 6f6c 6f72 222c 0a20  color="color",. 
+00002840: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
+00002850: 3d22 616c 7068 6122 2c0a 2020 2020 2020  ="alpha",.      
+00002860: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
+00002870: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
+00002880: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
+00002890: 2020 2020 7365 6c66 2e72 6f6f 742e 6178      self.root.ax
+000028a0: 6973 5b30 5d2e 7469 636b 6572 203d 2042  is[0].ticker = B
+000028b0: 6173 6963 5469 636b 6572 282a 2a54 4943  asicTicker(**TIC
+000028c0: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
+000028d0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+000028e0: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
+000028f0: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
+00002900: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00002910: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
+00002920: 662e 726f 6f74 2e78 6178 6973 2e6d 616a  f.root.xaxis.maj
+00002930: 6f72 5f6c 6162 656c 5f6f 7269 656e 7461  or_label_orienta
+00002940: 7469 6f6e 203d 2058 4c41 4245 4c5f 4f52  tion = XLABEL_OR
+00002950: 4945 4e54 4154 494f 4e0a 2020 2020 2020  IENTATION.      
+00002960: 2020 7365 6c66 2e72 6f6f 742e 7861 7869    self.root.xaxi
+00002970: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
+00002980: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+00002990: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
+000029a0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
+000029b0: 7374 6172 743d 3029 0a20 2020 2020 2020  start=0).       
+000029c0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+000029d0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+000029e0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000029f0: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
+00002a00: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+00002a10: 2020 7365 6c66 2e72 6f6f 742e 746f 6f6c    self.root.tool
+00002a20: 6261 725f 6c6f 6361 7469 6f6e 203d 2022  bar_location = "
+00002a30: 6162 6f76 6522 0a20 2020 2020 2020 2073  above".        s
+00002a40: 656c 662e 726f 6f74 2e79 6178 6973 2e76  elf.root.yaxis.v
+00002a50: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+00002a60: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
+00002a70: 486f 7665 7254 6f6f 6c28 0a20 2020 2020  HoverTool(.     
+00002a80: 2020 2020 2020 2070 6f69 6e74 5f70 6f6c         point_pol
+00002a90: 6963 793d 2266 6f6c 6c6f 775f 6d6f 7573  icy="follow_mous
+00002aa0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00002ab0: 746f 6f6c 7469 7073 3d22 2222 0a20 2020  tooltips=""".   
 00002ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ad0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00002ae0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00002af0: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-00002b00: 6768 743a 2062 6f6c 643b 223e 5072 6f63  ght: bold;">Proc
-00002b10: 6573 7320 6d65 6d6f 7279 2028 5253 5329  ess memory (RSS)
-00002b20: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-00002b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b40: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00002b50: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00002b60: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-00002b70: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-00002b80: 2c20 6d6f 6e6f 7370 6163 653b 223e 4070  , monospace;">@p
-00002b90: 726f 635f 6d65 6d6f 7279 7b30 2e30 3020  roc_memory{0.00 
-00002ba0: 627d 3c2f 7370 616e 3e0a 2020 2020 2020  b}</span>.      
-00002bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bc0: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00002ad0: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
+00002ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002af0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00002b00: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+00002b10: 2d73 697a 653a 2031 3270 783b 2066 6f6e  -size: 12px; fon
+00002b20: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+00002b30: 3e50 726f 6365 7373 206d 656d 6f72 7920  >Process memory 
+00002b40: 2852 5353 293a 3c2f 7370 616e 3e26 6e62  (RSS):</span>&nb
+00002b50: 7370 3b0a 2020 2020 2020 2020 2020 2020  sp;.            
+00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b70: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00002b80: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+00002b90: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+00002ba0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+00002bb0: 3b22 3e40 7072 6f63 5f6d 656d 6f72 797b  ;">@proc_memory{
+00002bc0: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
 00002bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002be0: 2020 2020 2020 2020 203c 6469 7620 7374           <div st
-00002bf0: 796c 653d 226d 6172 6769 6e2d 6c65 6674  yle="margin-left
-00002c00: 3a20 3165 6d3b 223e 0a20 2020 2020 2020  : 1em;">.       
-00002c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c20: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00002c30: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00002c40: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
-00002c50: 6874 3a20 626f 6c64 3b22 3e4d 616e 6167  ht: bold;">Manag
-00002c60: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
-00002c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c90: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00002ca0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00002cb0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00002cc0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00002cd0: 406d 616e 6167 6564 7b30 2e30 3020 627d  @managed{0.00 b}
-00002ce0: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-00002cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d00: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+00002be0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00002bf0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00002c00: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+00002c10: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
+00002c20: 2d6c 6566 743a 2031 656d 3b22 3e0a 2020  -left: 1em;">.  
+00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c40: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00002c50: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00002c60: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
+00002c70: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
+00002c80: 4d61 6e61 6765 643a 3c2f 7370 616e 3e26  Managed:</span>&
+00002c90: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00002ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002cb0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00002cc0: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00002cd0: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+00002ce0: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+00002cf0: 6365 3b22 3e40 6d61 6e61 6765 647b 302e  ce;">@managed{0.
+00002d00: 3030 2062 7d3c 2f73 7061 6e3e 0a20 2020  00 b}</span>.   
 00002d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d20: 2020 2020 2020 203c 6469 7620 7374 796c         <div styl
-00002d30: 653d 226d 6172 6769 6e2d 6c65 6674 3a20  e="margin-left: 
-00002d40: 3165 6d3b 223e 0a20 2020 2020 2020 2020  1em;">.         
-00002d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d60: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00002d70: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00002d80: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
-00002d90: 3a20 626f 6c64 3b22 3e55 6e6d 616e 6167  : bold;">Unmanag
-00002da0: 6564 2028 6f6c 6429 3a3c 2f73 7061 6e3e  ed (old):</span>
-00002db0: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
-00002dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002dd0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00002de0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00002df0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00002e00: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00002e10: 6163 653b 223e 4075 6e6d 616e 6167 6564  ace;">@unmanaged
-00002e20: 5f6f 6c64 7b30 2e30 3020 627d 3c2f 7370  _old{0.00 b}</sp
-00002e30: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-00002e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e50: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+00002d20: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+00002d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d40: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00002d50: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
+00002d60: 6566 743a 2031 656d 3b22 3e0a 2020 2020  eft: 1em;">.    
+00002d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d80: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00002d90: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00002da0: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00002db0: 6569 6768 743a 2062 6f6c 643b 223e 556e  eight: bold;">Un
+00002dc0: 6d61 6e61 6765 6420 286f 6c64 293a 3c2f  managed (old):</
+00002dd0: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+00002de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002df0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00002e00: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00002e10: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+00002e20: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00002e30: 6f6e 6f73 7061 6365 3b22 3e40 756e 6d61  onospace;">@unma
+00002e40: 6e61 6765 645f 6f6c 647b 302e 3030 2062  naged_old{0.00 b
+00002e50: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
 00002e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e70: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
-00002e80: 6172 6769 6e2d 6c65 6674 3a20 3165 6d3b  argin-left: 1em;
-00002e90: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
-00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002eb0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00002ec0: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00002ed0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00002ee0: 6c64 3b22 3e55 6e6d 616e 6167 6564 2028  ld;">Unmanaged (
-00002ef0: 7265 6365 6e74 293a 3c2f 7370 616e 3e26  recent):</span>&
-00002f00: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-00002f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f20: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00002f30: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-00002f40: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-00002f50: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-00002f60: 6365 3b22 3e40 756e 6d61 6e61 6765 645f  ce;">@unmanaged_
-00002f70: 7265 6365 6e74 7b30 2e30 3020 627d 3c2f  recent{0.00 b}</
-00002f80: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-00002f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fa0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+00002e70: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00002e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002e90: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
+00002ea0: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
+00002eb0: 2031 656d 3b22 3e0a 2020 2020 2020 2020   1em;">.        
+00002ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ed0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00002ee0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+00002ef0: 3132 7078 3b20 666f 6e74 2d77 6569 6768  12px; font-weigh
+00002f00: 743a 2062 6f6c 643b 223e 556e 6d61 6e61  t: bold;">Unmana
+00002f10: 6765 6420 2872 6563 656e 7429 3a3c 2f73  ged (recent):</s
+00002f20: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
+00002f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f40: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+00002f50: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+00002f60: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+00002f70: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+00002f80: 6e6f 7370 6163 653b 223e 4075 6e6d 616e  nospace;">@unman
+00002f90: 6167 6564 5f72 6563 656e 747b 302e 3030  aged_recent{0.00
+00002fa0: 2062 7d3c 2f73 7061 6e3e 0a20 2020 2020   b}</span>.     
 00002fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fc0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+00002fc0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
 00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fe0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00002ff0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00003000: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00003010: 6967 6874 3a20 626f 6c64 3b22 3e53 7069  ight: bold;">Spi
-00003020: 6c6c 6564 2074 6f20 6469 736b 3a3c 2f73  lled to disk:</s
-00003030: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
-00003040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003050: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00003060: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00003070: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-00003080: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-00003090: 6e6f 7370 6163 653b 223e 4073 7069 6c6c  nospace;">@spill
-000030a0: 6564 7b30 2e30 3020 627d 3c2f 7370 616e  ed{0.00 b}</span
-000030b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000030c0: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-000030d0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+00002fe0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+00002ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003010: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00003020: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00003030: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00003040: 223e 5370 696c 6c65 6420 746f 2064 6973  ">Spilled to dis
+00003050: 6b3a 3c2f 7370 616e 3e26 6e62 7370 3b0a  k:</span>&nbsp;.
+00003060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003080: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00003090: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+000030a0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+000030b0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+000030c0: 7370 696c 6c65 647b 302e 3030 2062 7d3c  spilled{0.00 b}<
+000030d0: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
 000030e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030f0: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
-00003100: 2020 2020 2020 2020 6865 6c70 5f20 3d20          help_ = 
-00003110: 4865 6c70 546f 6f6c 280a 2020 2020 2020  HelpTool(.      
-00003120: 2020 2020 2020 7265 6469 7265 6374 3d22        redirect="
-00003130: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
-00003140: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
-00003150: 6461 7368 626f 6172 642e 6874 6d6c 2362  dashboard.html#b
-00003160: 7974 6573 2d73 746f 7265 642d 616e 642d  ytes-stored-and-
-00003170: 6279 7465 732d 7065 722d 776f 726b 6572  bytes-per-worker
-00003180: 222c 0a20 2020 2020 2020 2020 2020 2064  ",.            d
-00003190: 6573 6372 6970 7469 6f6e 3d22 4465 7363  escription="Desc
-000031a0: 7269 7074 696f 6e20 6f66 2062 7974 6573  ription of bytes
-000031b0: 2073 746f 7265 6420 706c 6f74 7322 2c0a   stored plots",.
-000031c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000031d0: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-000031e0: 746f 6f6c 7328 686f 7665 722c 2068 656c  tools(hover, hel
-000031f0: 705f 290a 0a20 2020 2064 6566 205f 636c  p_)..    def _cl
-00003200: 7573 7465 725f 6d65 6d6f 7279 5f63 6f6c  uster_memory_col
-00003210: 6f72 2873 656c 6629 202d 3e20 7374 723a  or(self) -> str:
-00003220: 0a20 2020 2020 2020 2063 6f6c 6f72 7320  .        colors 
-00003230: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00003240: 7365 6c66 2e5f 6d65 6d6f 7279 5f63 6f6c  self._memory_col
-00003250: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00003260: 2020 2020 6375 7272 656e 743d 7773 2e6d      current=ws.m
-00003270: 656d 6f72 792e 7072 6f63 6573 732c 0a20  emory.process,. 
-00003280: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00003290: 696d 6974 3d67 6574 6174 7472 2877 732c  imit=getattr(ws,
-000032a0: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
-000032b0: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
-000032c0: 2020 2020 2073 7461 7475 733d 7773 2e73       status=ws.s
-000032d0: 7461 7475 732c 0a20 2020 2020 2020 2020  tatus,.         
-000032e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000032f0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00003300: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-00003310: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
-00003320: 2020 207d 0a0a 2020 2020 2020 2020 6173     }..        as
-00003330: 7365 7274 2063 6f6c 6f72 732e 6973 7375  sert colors.issu
-00003340: 6273 6574 287b 2272 6564 222c 2022 6f72  bset({"red", "or
-00003350: 616e 6765 222c 2022 626c 7565 227d 290a  ange", "blue"}).
-00003360: 2020 2020 2020 2020 6966 2022 7265 6422          if "red"
-00003370: 2069 6e20 636f 6c6f 7273 3a0a 2020 2020   in colors:.    
-00003380: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-00003390: 7265 6422 0a20 2020 2020 2020 2065 6c69  red".        eli
-000033a0: 6620 226f 7261 6e67 6522 2069 6e20 636f  f "orange" in co
-000033b0: 6c6f 7273 3a0a 2020 2020 2020 2020 2020  lors:.          
-000033c0: 2020 7265 7475 726e 2022 6f72 616e 6765    return "orange
-000033d0: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
-000033e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000033f0: 726e 2022 626c 7565 220a 0a20 2020 2040  rn "blue"..    @
-00003400: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-00003410: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-00003420: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00003430: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-00003440: 3a0a 2020 2020 2020 2020 6c69 6d69 7420  :.        limit 
-00003450: 3d20 7375 6d28 7773 2e6d 656d 6f72 795f  = sum(ws.memory_
-00003460: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
-00003470: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00003480: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
-00003490: 0a20 2020 2020 2020 206d 656d 696e 666f  .        meminfo
-000034a0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
-000034b0: 722e 6d65 6d6f 7279 0a20 2020 2020 2020  r.memory.       
-000034c0: 2063 6f6c 6f72 203d 2073 656c 662e 5f63   color = self._c
-000034d0: 6c75 7374 6572 5f6d 656d 6f72 795f 636f  luster_memory_co
-000034e0: 6c6f 7228 290a 0a20 2020 2020 2020 2077  lor()..        w
-000034f0: 6964 7468 203d 205b 0a20 2020 2020 2020  idth = [.       
-00003500: 2020 2020 206d 656d 696e 666f 2e6d 616e       meminfo.man
-00003510: 6167 6564 2c0a 2020 2020 2020 2020 2020  aged,.          
-00003520: 2020 6d65 6d69 6e66 6f2e 756e 6d61 6e61    meminfo.unmana
-00003530: 6765 645f 6f6c 642c 0a20 2020 2020 2020  ged_old,.       
-00003540: 2020 2020 206d 656d 696e 666f 2e75 6e6d       meminfo.unm
-00003550: 616e 6167 6564 5f72 6563 656e 742c 0a20  anaged_recent,. 
-00003560: 2020 2020 2020 2020 2020 206d 656d 696e             memin
-00003570: 666f 2e73 7069 6c6c 6564 2c0a 2020 2020  fo.spilled,.    
-00003580: 2020 2020 5d0a 0a20 2020 2020 2020 2072      ]..        r
-00003590: 6573 756c 7420 3d20 7b0a 2020 2020 2020  esult = {.      
-000035a0: 2020 2020 2020 2277 6964 7468 223a 2077        "width": w
-000035b0: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-000035c0: 2020 2278 223a 205b 7375 6d28 7769 6474    "x": [sum(widt
-000035d0: 685b 3a69 5d29 202b 2077 202f 2032 2066  h[:i]) + w / 2 f
-000035e0: 6f72 2069 2c20 7720 696e 2065 6e75 6d65  or i, w in enume
-000035f0: 7261 7465 2877 6964 7468 295d 2c0a 2020  rate(width)],.  
-00003600: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
-00003610: 223a 205b 636f 6c6f 722c 2063 6f6c 6f72  ": [color, color
-00003620: 2c20 636f 6c6f 722c 2022 6772 6579 225d  , color, "grey"]
-00003630: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
-00003640: 726f 635f 6d65 6d6f 7279 223a 205b 6d65  roc_memory": [me
-00003650: 6d69 6e66 6f2e 7072 6f63 6573 735d 202a  minfo.process] *
-00003660: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-00003670: 226d 616e 6167 6564 223a 205b 6d65 6d69  "managed": [memi
-00003680: 6e66 6f2e 6d61 6e61 6765 645d 202a 2034  nfo.managed] * 4
-00003690: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-000036a0: 6e6d 616e 6167 6564 5f6f 6c64 223a 205b  nmanaged_old": [
-000036b0: 6d65 6d69 6e66 6f2e 756e 6d61 6e61 6765  meminfo.unmanage
-000036c0: 645f 6f6c 645d 202a 2034 2c0a 2020 2020  d_old] * 4,.    
-000036d0: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
-000036e0: 6564 5f72 6563 656e 7422 3a20 5b6d 656d  ed_recent": [mem
-000036f0: 696e 666f 2e75 6e6d 616e 6167 6564 5f72  info.unmanaged_r
-00003700: 6563 656e 745d 202a 2034 2c0a 2020 2020  ecent] * 4,.    
-00003710: 2020 2020 2020 2020 2273 7069 6c6c 6564          "spilled
-00003720: 223a 205b 6d65 6d69 6e66 6f2e 7370 696c  ": [meminfo.spil
-00003730: 6c65 645d 202a 2034 2c0a 2020 2020 2020  led] * 4,.      
-00003740: 2020 7d0a 0a20 2020 2020 2020 2078 5f65    }..        x_e
-00003750: 6e64 203d 206d 6178 286c 696d 6974 2c20  nd = max(limit, 
-00003760: 6d65 6d69 6e66 6f2e 7072 6f63 6573 7320  meminfo.process 
-00003770: 2b20 6d65 6d69 6e66 6f2e 7370 696c 6c65  + meminfo.spille
-00003780: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
-00003790: 726f 6f74 2e78 5f72 616e 6765 2e65 6e64  root.x_range.end
-000037a0: 203d 2078 5f65 6e64 0a0a 2020 2020 2020   = x_end..      
-000037b0: 2020 7469 746c 6520 3d20 6622 4279 7465    title = f"Byte
-000037c0: 7320 7374 6f72 6564 3a20 7b66 6f72 6d61  s stored: {forma
-000037d0: 745f 6279 7465 7328 6d65 6d69 6e66 6f2e  t_bytes(meminfo.
-000037e0: 7072 6f63 6573 7329 7d22 0a20 2020 2020  process)}".     
-000037f0: 2020 2069 6620 6d65 6d69 6e66 6f2e 7370     if meminfo.sp
-00003800: 696c 6c65 643a 0a20 2020 2020 2020 2020  illed:.         
-00003810: 2020 2074 6974 6c65 202b 3d20 6622 202b     title += f" +
-00003820: 207b 666f 726d 6174 5f62 7974 6573 286d   {format_bytes(m
-00003830: 656d 696e 666f 2e73 7069 6c6c 6564 297d  eminfo.spilled)}
-00003840: 2073 7069 6c6c 6564 2074 6f20 6469 736b   spilled to disk
-00003850: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
-00003860: 6f6f 742e 7469 746c 652e 7465 7874 203d  oot.title.text =
-00003870: 2074 6974 6c65 0a0a 2020 2020 2020 2020   title..        
-00003880: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
-00003890: 6365 2c20 7265 7375 6c74 290a 0a0a 636c  ce, result)...cl
-000038a0: 6173 7320 576f 726b 6572 734d 656d 6f72  ass WorkersMemor
-000038b0: 7928 4461 7368 626f 6172 6443 6f6d 706f  y(DashboardCompo
-000038c0: 6e65 6e74 2c20 4d65 6d6f 7279 436f 6c6f  nent, MemoryColo
-000038d0: 7229 3a0a 2020 2020 2222 224d 656d 6f72  r):.    """Memor
-000038e0: 7920 7573 6167 6520 666f 7220 7369 6e67  y usage for sing
-000038f0: 6c65 2077 6f72 6b65 7273 2222 220a 0a20  le workers""".. 
-00003900: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-00003910: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00003920: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
-00003930: 2077 6964 7468 3d36 3030 2c20 2a2a 6b77   width=600, **kw
-00003940: 6172 6773 293a 0a20 2020 2020 2020 2044  args):.        D
-00003950: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
-00003960: 742e 5f5f 696e 6974 5f5f 2873 656c 6629  t.__init__(self)
-00003970: 0a20 2020 2020 2020 204d 656d 6f72 7943  .        MemoryC
-00003980: 6f6c 6f72 2e5f 5f69 6e69 745f 5f28 7365  olor.__init__(se
-00003990: 6c66 290a 0a20 2020 2020 2020 2073 656c  lf)..        sel
-000039a0: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-000039b0: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-000039c0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
-000039d0: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
-000039e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000039f0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-00003a00: 6964 7468 223a 205b 5d2c 0a20 2020 2020  idth": [],.     
-00003a10: 2020 2020 2020 2020 2020 2022 7822 3a20             "x": 
-00003a20: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00003a30: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
-00003a40: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-00003a50: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
-00003a60: 2020 2020 2020 2020 2020 2261 6c70 6861            "alpha
-00003a70: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00003a80: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
-00003a90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00003aa0: 2020 2020 2022 6573 6361 7065 645f 776f       "escaped_wo
-00003ab0: 726b 6572 223a 205b 5d2c 0a20 2020 2020  rker": [],.     
-00003ac0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
-00003ad0: 5f6d 656d 6f72 7922 3a20 5b5d 2c0a 2020  _memory": [],.  
-00003ae0: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00003af0: 616e 6167 6564 223a 205b 5d2c 0a20 2020  anaged": [],.   
-00003b00: 2020 2020 2020 2020 2020 2020 2022 756e               "un
-00003b10: 6d61 6e61 6765 645f 6f6c 6422 3a20 5b5d  managed_old": []
+000030f0: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+00003100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003110: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
+00003120: 2020 2029 0a20 2020 2020 2020 2068 656c     ).        hel
+00003130: 705f 203d 2048 656c 7054 6f6f 6c28 0a20  p_ = HelpTool(. 
+00003140: 2020 2020 2020 2020 2020 2072 6564 6972             redir
+00003150: 6563 743d 2268 7474 7073 3a2f 2f64 6f63  ect="https://doc
+00003160: 732e 6461 736b 2e6f 7267 2f65 6e2f 7374  s.dask.org/en/st
+00003170: 6162 6c65 2f64 6173 6862 6f61 7264 2e68  able/dashboard.h
+00003180: 746d 6c23 6279 7465 732d 7374 6f72 6564  tml#bytes-stored
+00003190: 2d61 6e64 2d62 7974 6573 2d70 6572 2d77  -and-bytes-per-w
+000031a0: 6f72 6b65 7222 2c0a 2020 2020 2020 2020  orker",.        
+000031b0: 2020 2020 6465 7363 7269 7074 696f 6e3d      description=
+000031c0: 2244 6573 6372 6970 7469 6f6e 206f 6620  "Description of 
+000031d0: 6279 7465 7320 7374 6f72 6564 2070 6c6f  bytes stored plo
+000031e0: 7473 222c 0a20 2020 2020 2020 2029 0a20  ts",.        ). 
+000031f0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00003200: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+00003210: 2c20 6865 6c70 5f29 0a0a 2020 2020 6465  , help_)..    de
+00003220: 6620 5f63 6c75 7374 6572 5f6d 656d 6f72  f _cluster_memor
+00003230: 795f 636f 6c6f 7228 7365 6c66 2920 2d3e  y_color(self) ->
+00003240: 2073 7472 3a0a 2020 2020 2020 2020 636f   str:.        co
+00003250: 6c6f 7273 203d 207b 0a20 2020 2020 2020  lors = {.       
+00003260: 2020 2020 2073 656c 662e 5f6d 656d 6f72       self._memor
+00003270: 795f 636f 6c6f 7228 0a20 2020 2020 2020  y_color(.       
+00003280: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+00003290: 3d77 732e 6d65 6d6f 7279 2e70 726f 6365  =ws.memory.proce
+000032a0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+000032b0: 2020 2020 6c69 6d69 743d 6765 7461 7474      limit=getatt
+000032c0: 7228 7773 2c20 226d 656d 6f72 795f 6c69  r(ws, "memory_li
+000032d0: 6d69 7422 2c20 3029 2c0a 2020 2020 2020  mit", 0),.      
+000032e0: 2020 2020 2020 2020 2020 7374 6174 7573            status
+000032f0: 3d77 732e 7374 6174 7573 2c0a 2020 2020  =ws.status,.    
+00003300: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003310: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+00003320: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+00003330: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
+00003340: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00003350: 2020 2061 7373 6572 7420 636f 6c6f 7273     assert colors
+00003360: 2e69 7373 7562 7365 7428 7b22 7265 6422  .issubset({"red"
+00003370: 2c20 226f 7261 6e67 6522 2c20 2262 6c75  , "orange", "blu
+00003380: 6522 7d29 0a20 2020 2020 2020 2069 6620  e"}).        if 
+00003390: 2272 6564 2220 696e 2063 6f6c 6f72 733a  "red" in colors:
+000033a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000033b0: 7572 6e20 2272 6564 220a 2020 2020 2020  urn "red".      
+000033c0: 2020 656c 6966 2022 6f72 616e 6765 2220    elif "orange" 
+000033d0: 696e 2063 6f6c 6f72 733a 0a20 2020 2020  in colors:.     
+000033e0: 2020 2020 2020 2072 6574 7572 6e20 226f         return "o
+000033f0: 7261 6e67 6522 0a20 2020 2020 2020 2065  range".        e
+00003400: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00003410: 2072 6574 7572 6e20 2262 6c75 6522 0a0a   return "blue"..
+00003420: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+00003430: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+00003440: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+00003450: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
+00003460: 7365 6c66 293a 0a20 2020 2020 2020 206c  self):.        l
+00003470: 696d 6974 203d 2073 756d 2877 732e 6d65  imit = sum(ws.me
+00003480: 6d6f 7279 5f6c 696d 6974 2066 6f72 2077  mory_limit for w
+00003490: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
+000034a0: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
+000034b0: 6573 2829 290a 2020 2020 2020 2020 6d65  es()).        me
+000034c0: 6d69 6e66 6f20 3d20 7365 6c66 2e73 6368  minfo = self.sch
+000034d0: 6564 756c 6572 2e6d 656d 6f72 790a 2020  eduler.memory.  
+000034e0: 2020 2020 2020 636f 6c6f 7220 3d20 7365        color = se
+000034f0: 6c66 2e5f 636c 7573 7465 725f 6d65 6d6f  lf._cluster_memo
+00003500: 7279 5f63 6f6c 6f72 2829 0a0a 2020 2020  ry_color()..    
+00003510: 2020 2020 7769 6474 6820 3d20 5b0a 2020      width = [.  
+00003520: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
+00003530: 6f2e 6d61 6e61 6765 642c 0a20 2020 2020  o.managed,.     
+00003540: 2020 2020 2020 206d 656d 696e 666f 2e75         meminfo.u
+00003550: 6e6d 616e 6167 6564 5f6f 6c64 2c0a 2020  nmanaged_old,.  
+00003560: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
+00003570: 6f2e 756e 6d61 6e61 6765 645f 7265 6365  o.unmanaged_rece
+00003580: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00003590: 6d65 6d69 6e66 6f2e 7370 696c 6c65 642c  meminfo.spilled,
+000035a0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
+000035b0: 2020 2020 7265 7375 6c74 203d 207b 0a20      result = {. 
+000035c0: 2020 2020 2020 2020 2020 2022 7769 6474             "widt
+000035d0: 6822 3a20 7769 6474 682c 0a20 2020 2020  h": width,.     
+000035e0: 2020 2020 2020 2022 7822 3a20 5b73 756d         "x": [sum
+000035f0: 2877 6964 7468 5b3a 695d 2920 2b20 7720  (width[:i]) + w 
+00003600: 2f20 3220 666f 7220 692c 2077 2069 6e20  / 2 for i, w in 
+00003610: 656e 756d 6572 6174 6528 7769 6474 6829  enumerate(width)
+00003620: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+00003630: 636f 6c6f 7222 3a20 5b63 6f6c 6f72 2c20  color": [color, 
+00003640: 636f 6c6f 722c 2063 6f6c 6f72 2c20 2267  color, color, "g
+00003650: 7265 7922 5d2c 0a20 2020 2020 2020 2020  rey"],.         
+00003660: 2020 2022 7072 6f63 5f6d 656d 6f72 7922     "proc_memory"
+00003670: 3a20 5b6d 656d 696e 666f 2e70 726f 6365  : [meminfo.proce
+00003680: 7373 5d20 2a20 342c 0a20 2020 2020 2020  ss] * 4,.       
+00003690: 2020 2020 2022 6d61 6e61 6765 6422 3a20       "managed": 
+000036a0: 5b6d 656d 696e 666f 2e6d 616e 6167 6564  [meminfo.managed
+000036b0: 5d20 2a20 342c 0a20 2020 2020 2020 2020  ] * 4,.         
+000036c0: 2020 2022 756e 6d61 6e61 6765 645f 6f6c     "unmanaged_ol
+000036d0: 6422 3a20 5b6d 656d 696e 666f 2e75 6e6d  d": [meminfo.unm
+000036e0: 616e 6167 6564 5f6f 6c64 5d20 2a20 342c  anaged_old] * 4,
+000036f0: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
+00003700: 6d61 6e61 6765 645f 7265 6365 6e74 223a  managed_recent":
+00003710: 205b 6d65 6d69 6e66 6f2e 756e 6d61 6e61   [meminfo.unmana
+00003720: 6765 645f 7265 6365 6e74 5d20 2a20 342c  ged_recent] * 4,
+00003730: 0a20 2020 2020 2020 2020 2020 2022 7370  .            "sp
+00003740: 696c 6c65 6422 3a20 5b6d 656d 696e 666f  illed": [meminfo
+00003750: 2e73 7069 6c6c 6564 5d20 2a20 342c 0a20  .spilled] * 4,. 
+00003760: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00003770: 2020 785f 656e 6420 3d20 6d61 7828 6c69    x_end = max(li
+00003780: 6d69 742c 206d 656d 696e 666f 2e70 726f  mit, meminfo.pro
+00003790: 6365 7373 202b 206d 656d 696e 666f 2e73  cess + meminfo.s
+000037a0: 7069 6c6c 6564 290a 2020 2020 2020 2020  pilled).        
+000037b0: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
+000037c0: 652e 656e 6420 3d20 785f 656e 640a 0a20  e.end = x_end.. 
+000037d0: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
+000037e0: 2242 7974 6573 2073 746f 7265 643a 207b  "Bytes stored: {
+000037f0: 666f 726d 6174 5f62 7974 6573 286d 656d  format_bytes(mem
+00003800: 696e 666f 2e70 726f 6365 7373 297d 220a  info.process)}".
+00003810: 2020 2020 2020 2020 6966 206d 656d 696e          if memin
+00003820: 666f 2e73 7069 6c6c 6564 3a0a 2020 2020  fo.spilled:.    
+00003830: 2020 2020 2020 2020 7469 746c 6520 2b3d          title +=
+00003840: 2066 2220 2b20 7b66 6f72 6d61 745f 6279   f" + {format_by
+00003850: 7465 7328 6d65 6d69 6e66 6f2e 7370 696c  tes(meminfo.spil
+00003860: 6c65 6429 7d20 7370 696c 6c65 6420 746f  led)} spilled to
+00003870: 2064 6973 6b22 0a20 2020 2020 2020 2073   disk".        s
+00003880: 656c 662e 726f 6f74 2e74 6974 6c65 2e74  elf.root.title.t
+00003890: 6578 7420 3d20 7469 746c 650a 0a20 2020  ext = title..   
+000038a0: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
+000038b0: 2e73 6f75 7263 652c 2072 6573 756c 7429  .source, result)
+000038c0: 0a0a 0a63 6c61 7373 2057 6f72 6b65 7273  ...class Workers
+000038d0: 4d65 6d6f 7279 2844 6173 6862 6f61 7264  Memory(Dashboard
+000038e0: 436f 6d70 6f6e 656e 742c 204d 656d 6f72  Component, Memor
+000038f0: 7943 6f6c 6f72 293a 0a20 2020 2022 2222  yColor):.    """
+00003900: 4d65 6d6f 7279 2075 7361 6765 2066 6f72  Memory usage for
+00003910: 2073 696e 676c 6520 776f 726b 6572 7322   single workers"
+00003920: 2222 0a0a 2020 2020 406c 6f67 5f65 7272  ""..    @log_err
+00003930: 6f72 730a 2020 2020 6465 6620 5f5f 696e  ors.    def __in
+00003940: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+00003950: 756c 6572 2c20 7769 6474 683d 3630 302c  uler, width=600,
+00003960: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00003970: 2020 2020 4461 7368 626f 6172 6443 6f6d      DashboardCom
+00003980: 706f 6e65 6e74 2e5f 5f69 6e69 745f 5f28  ponent.__init__(
+00003990: 7365 6c66 290a 2020 2020 2020 2020 4d65  self).        Me
+000039a0: 6d6f 7279 436f 6c6f 722e 5f5f 696e 6974  moryColor.__init
+000039b0: 5f5f 2873 656c 6629 0a0a 2020 2020 2020  __(self)..      
+000039c0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+000039d0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+000039e0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+000039f0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+00003a00: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+00003a10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00003a20: 2020 2022 7769 6474 6822 3a20 5b5d 2c0a     "width": [],.
+00003a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a40: 2278 223a 205b 5d2c 0a20 2020 2020 2020  "x": [],.       
+00003a50: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
+00003a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003a70: 2020 2263 6f6c 6f72 223a 205b 5d2c 0a20    "color": [],. 
+00003a80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00003a90: 616c 7068 6122 3a20 5b5d 2c0a 2020 2020  alpha": [],.    
+00003aa0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
+00003ab0: 6b65 7222 3a20 5b5d 2c0a 2020 2020 2020  ker": [],.      
+00003ac0: 2020 2020 2020 2020 2020 2265 7363 6170            "escap
+00003ad0: 6564 5f77 6f72 6b65 7222 3a20 5b5d 2c0a  ed_worker": [],.
+00003ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003af0: 2270 726f 635f 6d65 6d6f 7279 223a 205b  "proc_memory": [
+00003b00: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00003b10: 2020 2022 6d61 6e61 6765 6422 3a20 5b5d     "managed": []
 00003b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003b30: 2020 2275 6e6d 616e 6167 6564 5f72 6563    "unmanaged_rec
-00003b40: 656e 7422 3a20 5b5d 2c0a 2020 2020 2020  ent": [],.      
-00003b50: 2020 2020 2020 2020 2020 2273 7069 6c6c            "spill
-00003b60: 6564 223a 205b 5d2c 0a20 2020 2020 2020  ed": [],.       
-00003b70: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
-00003b80: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00003b90: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
-00003ba0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00003bb0: 2242 7974 6573 2073 746f 7265 6420 7065  "Bytes stored pe
-00003bc0: 7220 776f 726b 6572 222c 0a20 2020 2020  r worker",.     
-00003bd0: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-00003be0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-00003bf0: 7468 3d69 6e74 2877 6964 7468 202f 2032  th=int(width / 2
-00003c00: 292c 0a20 2020 2020 2020 2020 2020 206e  ),.            n
-00003c10: 616d 653d 2277 6f72 6b65 7273 5f6d 656d  ame="workers_mem
-00003c20: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
-00003c30: 2020 6d69 6e5f 626f 7264 6572 5f62 6f74    min_border_bot
-00003c40: 746f 6d3d 3530 2c0a 2020 2020 2020 2020  tom=50,.        
-00003c50: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-00003c60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00003c70: 7265 6374 203d 2073 656c 662e 726f 6f74  rect = self.root
-00003c80: 2e72 6563 7428 0a20 2020 2020 2020 2020  .rect(.         
-00003c90: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
-00003ca0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
-00003cb0: 2020 2078 3d22 7822 2c0a 2020 2020 2020     x="x",.      
-00003cc0: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
-00003cd0: 2020 2020 2020 2020 2077 6964 7468 3d22           width="
-00003ce0: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
-00003cf0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
-00003d00: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00003d10: 723d 2263 6f6c 6f72 222c 0a20 2020 2020  r="color",.     
-00003d20: 2020 2020 2020 2066 696c 6c5f 616c 7068         fill_alph
-00003d30: 613d 2261 6c70 6861 222c 0a20 2020 2020  a="alpha",.     
-00003d40: 2020 2020 2020 206c 696e 655f 7769 6474         line_widt
-00003d50: 683d 302c 0a20 2020 2020 2020 2029 0a20  h=0,.        ). 
-00003d60: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
-00003d70: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
-00003d80: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-00003d90: 656c 662e 726f 6f74 2e61 7869 735b 305d  elf.root.axis[0]
-00003da0: 2e74 6963 6b65 7220 3d20 4261 7369 6354  .ticker = BasicT
-00003db0: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
-00003dc0: 3234 290a 2020 2020 2020 2020 7365 6c66  24).        self
-00003dd0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
-00003de0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-00003df0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-00003e00: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-00003e10: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00003e20: 742e 7861 7869 732e 6d61 6a6f 725f 6c61  t.xaxis.major_la
-00003e30: 6265 6c5f 6f72 6965 6e74 6174 696f 6e20  bel_orientation 
-00003e40: 3d20 584c 4142 454c 5f4f 5249 454e 5441  = XLABEL_ORIENTA
-00003e50: 5449 4f4e 0a20 2020 2020 2020 2073 656c  TION.        sel
-00003e60: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
-00003e70: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-00003e80: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-00003e90: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
-00003ea0: 203d 2052 616e 6765 3164 2873 7461 7274   = Range1d(start
-00003eb0: 3d30 290a 2020 2020 2020 2020 7365 6c66  =0).        self
-00003ec0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
-00003ed0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00003ee0: 2020 2020 7365 6c66 2e72 6f6f 742e 7967      self.root.yg
-00003ef0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-00003f00: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00003f10: 2e72 6f6f 742e 746f 6f6c 6261 725f 6c6f  .root.toolbar_lo
-00003f20: 6361 7469 6f6e 203d 204e 6f6e 650a 0a20  cation = None.. 
-00003f30: 2020 2020 2020 2074 6170 203d 2054 6170         tap = Tap
-00003f40: 546f 6f6c 2863 616c 6c62 6163 6b3d 4f70  Tool(callback=Op
-00003f50: 656e 5552 4c28 7572 6c3d 222e 2f69 6e66  enURL(url="./inf
-00003f60: 6f2f 776f 726b 6572 2f40 6573 6361 7065  o/worker/@escape
-00003f70: 645f 776f 726b 6572 2e68 746d 6c22 2929  d_worker.html"))
-00003f80: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00003f90: 6f74 2e61 6464 5f74 6f6f 6c73 2874 6170  ot.add_tools(tap
-00003fa0: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
-00003fb0: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-00003fc0: 2020 2020 2020 2020 2020 706f 696e 745f            point_
-00003fd0: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
-00003fe0: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
-00003ff0: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
-00004000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004010: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-00004020: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00003b30: 2020 2275 6e6d 616e 6167 6564 5f6f 6c64    "unmanaged_old
+00003b40: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00003b50: 2020 2020 2020 2022 756e 6d61 6e61 6765         "unmanage
+00003b60: 645f 7265 6365 6e74 223a 205b 5d2c 0a20  d_recent": [],. 
+00003b70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00003b80: 7370 696c 6c65 6422 3a20 5b5d 2c0a 2020  spilled": [],.  
+00003b90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00003ba0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00003bb0: 656c 662e 726f 6f74 203d 2066 6967 7572  elf.root = figur
+00003bc0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
+00003bd0: 6974 6c65 3d22 4279 7465 7320 7374 6f72  itle="Bytes stor
+00003be0: 6564 2070 6572 2077 6f72 6b65 7222 2c0a  ed per worker",.
+00003bf0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00003c00: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+00003c10: 2020 7769 6474 683d 696e 7428 7769 6474    width=int(widt
+00003c20: 6820 2f20 3229 2c0a 2020 2020 2020 2020  h / 2),.        
+00003c30: 2020 2020 6e61 6d65 3d22 776f 726b 6572      name="worker
+00003c40: 735f 6d65 6d6f 7279 222c 0a20 2020 2020  s_memory",.     
+00003c50: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+00003c60: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+00003c70: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00003c80: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+00003c90: 2020 2020 2072 6563 7420 3d20 7365 6c66       rect = self
+00003ca0: 2e72 6f6f 742e 7265 6374 280a 2020 2020  .root.rect(.    
+00003cb0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00003cc0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+00003cd0: 2020 2020 2020 2020 783d 2278 222c 0a20          x="x",. 
+00003ce0: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
+00003cf0: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
+00003d00: 6474 683d 2277 6964 7468 222c 0a20 2020  dth="width",.   
+00003d10: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+00003d20: 302e 392c 0a20 2020 2020 2020 2020 2020  0.9,.           
+00003d30: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
+00003d40: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+00003d50: 5f61 6c70 6861 3d22 616c 7068 6122 2c0a  _alpha="alpha",.
+00003d60: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00003d70: 5f77 6964 7468 3d30 2c0a 2020 2020 2020  _width=0,.      
+00003d80: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
+00003d90: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
+00003da0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
+00003db0: 2020 2020 7365 6c66 2e72 6f6f 742e 6178      self.root.ax
+00003dc0: 6973 5b30 5d2e 7469 636b 6572 203d 2042  is[0].ticker = B
+00003dd0: 6173 6963 5469 636b 6572 282a 2a54 4943  asicTicker(**TIC
+00003de0: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
+00003df0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+00003e00: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
+00003e10: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
+00003e20: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00003e30: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
+00003e40: 662e 726f 6f74 2e78 6178 6973 2e6d 616a  f.root.xaxis.maj
+00003e50: 6f72 5f6c 6162 656c 5f6f 7269 656e 7461  or_label_orienta
+00003e60: 7469 6f6e 203d 2058 4c41 4245 4c5f 4f52  tion = XLABEL_OR
+00003e70: 4945 4e54 4154 494f 4e0a 2020 2020 2020  IENTATION.      
+00003e80: 2020 7365 6c66 2e72 6f6f 742e 7861 7869    self.root.xaxi
+00003e90: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
+00003ea0: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+00003eb0: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
+00003ec0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
+00003ed0: 7374 6172 743d 3029 0a20 2020 2020 2020  start=0).       
+00003ee0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+00003ef0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+00003f00: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00003f10: 6f74 2e79 6772 6964 2e76 6973 6962 6c65  ot.ygrid.visible
+00003f20: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00003f30: 2073 656c 662e 726f 6f74 2e74 6f6f 6c62   self.root.toolb
+00003f40: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
+00003f50: 6e65 0a0a 2020 2020 2020 2020 7461 7020  ne..        tap 
+00003f60: 3d20 5461 7054 6f6f 6c28 6361 6c6c 6261  = TapTool(callba
+00003f70: 636b 3d4f 7065 6e55 524c 2875 726c 3d22  ck=OpenURL(url="
+00003f80: 2e2f 696e 666f 2f77 6f72 6b65 722f 4065  ./info/worker/@e
+00003f90: 7363 6170 6564 5f77 6f72 6b65 722e 6874  scaped_worker.ht
+00003fa0: 6d6c 2229 290a 2020 2020 2020 2020 7365  ml")).        se
+00003fb0: 6c66 2e72 6f6f 742e 6164 645f 746f 6f6c  lf.root.add_tool
+00003fc0: 7328 7461 7029 0a0a 2020 2020 2020 2020  s(tap)..        
+00003fd0: 686f 7665 7220 3d20 486f 7665 7254 6f6f  hover = HoverToo
+00003fe0: 6c28 0a20 2020 2020 2020 2020 2020 2070  l(.            p
+00003ff0: 6f69 6e74 5f70 6f6c 6963 793d 2266 6f6c  oint_policy="fol
+00004000: 6c6f 775f 6d6f 7573 6522 2c0a 2020 2020  low_mouse",.    
+00004010: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
+00004020: 3d22 2222 0a20 2020 2020 2020 2020 2020  =""".           
 00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004040: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00004050: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
-00004060: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
-00004070: 643b 223e 576f 726b 6572 3a3c 2f73 7061  d;">Worker:</spa
-00004080: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040a0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000040b0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-000040c0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-000040d0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-000040e0: 7370 6163 653b 223e 4077 6f72 6b65 723c  space;">@worker<
-000040f0: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
-00004100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004110: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+00004040: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
+00004050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004060: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00004070: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00004080: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
+00004090: 3a20 626f 6c64 3b22 3e57 6f72 6b65 723a  : bold;">Worker:
+000040a0: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+000040b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040c0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+000040d0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+000040e0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+000040f0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+00004100: 206d 6f6e 6f73 7061 6365 3b22 3e40 776f   monospace;">@wo
+00004110: 726b 6572 3c2f 7370 616e 3e0a 2020 2020  rker</span>.    
 00004120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004130: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00004130: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
 00004140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004150: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00004160: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00004170: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
-00004180: 6569 6768 743a 2062 6f6c 643b 223e 5072  eight: bold;">Pr
-00004190: 6f63 6573 7320 6d65 6d6f 7279 2028 5253  ocess memory (RS
-000041a0: 5329 3a3c 2f73 7061 6e3e 266e 6273 703b  S):</span>&nbsp;
-000041b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000041c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041d0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-000041e0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-000041f0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00004200: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00004210: 4070 726f 635f 6d65 6d6f 7279 7b30 2e30  @proc_memory{0.0
-00004220: 3020 627d 3c2f 7370 616e 3e0a 2020 2020  0 b}</span>.    
-00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004240: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-00004250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004260: 2020 2020 2020 2020 2020 203c 6469 7620             <div 
-00004270: 7374 796c 653d 226d 6172 6769 6e2d 6c65  style="margin-le
-00004280: 6674 3a20 3165 6d3b 223e 0a20 2020 2020  ft: 1em;">.     
-00004290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042a0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-000042b0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-000042c0: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-000042d0: 6967 6874 3a20 626f 6c64 3b22 3e4d 616e  ight: bold;">Man
-000042e0: 6167 6564 3a3c 2f73 7061 6e3e 266e 6273  aged:</span>&nbs
-000042f0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004310: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00004320: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-00004330: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00004340: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00004350: 223e 406d 616e 6167 6564 7b30 2e30 3020  ">@managed{0.00 
-00004360: 627d 3c2f 7370 616e 3e0a 2020 2020 2020  b}</span>.      
-00004370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004380: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00004150: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00004160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004180: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00004190: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
+000041a0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+000041b0: 3b22 3e50 726f 6365 7373 206d 656d 6f72  ;">Process memor
+000041c0: 7920 2852 5353 293a 3c2f 7370 616e 3e26  y (RSS):</span>&
+000041d0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+000041e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041f0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00004200: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00004210: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+00004220: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+00004230: 6365 3b22 3e40 7072 6f63 5f6d 656d 6f72  ce;">@proc_memor
+00004240: 797b 302e 3030 2062 7d3c 2f73 7061 6e3e  y{0.00 b}</span>
+00004250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004260: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+00004270: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+00004280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004290: 3c64 6976 2073 7479 6c65 3d22 6d61 7267  <div style="marg
+000042a0: 696e 2d6c 6566 743a 2031 656d 3b22 3e0a  in-left: 1em;">.
+000042b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042d0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+000042e0: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+000042f0: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00004300: 223e 4d61 6e61 6765 643a 3c2f 7370 616e  ">Managed:</span
+00004310: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004330: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00004340: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+00004350: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+00004360: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+00004370: 7061 6365 3b22 3e40 6d61 6e61 6765 647b  pace;">@managed{
+00004380: 302e 3030 2062 7d3c 2f73 7061 6e3e 0a20  0.00 b}</span>. 
 00004390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043a0: 2020 2020 2020 2020 203c 6469 7620 7374           <div st
-000043b0: 796c 653d 226d 6172 6769 6e2d 6c65 6674  yle="margin-left
-000043c0: 3a20 3165 6d3b 223e 0a20 2020 2020 2020  : 1em;">.       
-000043d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000043e0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000043f0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00004400: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
-00004410: 6874 3a20 626f 6c64 3b22 3e55 6e6d 616e  ht: bold;">Unman
-00004420: 6167 6564 2028 6f6c 6429 3a3c 2f73 7061  aged (old):</spa
-00004430: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00004440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004450: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00004460: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00004470: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-00004480: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-00004490: 7370 6163 653b 223e 4075 6e6d 616e 6167  space;">@unmanag
-000044a0: 6564 5f6f 6c64 7b30 2e30 3020 627d 3c2f  ed_old{0.00 b}</
-000044b0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-000044c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044d0: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+000043a0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+000043b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000043c0: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+000043d0: 6976 2073 7479 6c65 3d22 6d61 7267 696e  iv style="margin
+000043e0: 2d6c 6566 743a 2031 656d 3b22 3e0a 2020  -left: 1em;">.  
+000043f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004400: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00004410: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00004420: 7369 7a65 3a20 3132 7078 3b20 666f 6e74  size: 12px; font
+00004430: 2d77 6569 6768 743a 2062 6f6c 643b 223e  -weight: bold;">
+00004440: 556e 6d61 6e61 6765 6420 286f 6c64 293a  Unmanaged (old):
+00004450: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00004460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004470: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00004480: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00004490: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+000044a0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+000044b0: 206d 6f6e 6f73 7061 6365 3b22 3e40 756e   monospace;">@un
+000044c0: 6d61 6e61 6765 645f 6f6c 647b 302e 3030  managed_old{0.00
+000044d0: 2062 7d3c 2f73 7061 6e3e 0a20 2020 2020   b}</span>.     
 000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044f0: 2020 2020 203c 6469 7620 7374 796c 653d       <div style=
-00004500: 226d 6172 6769 6e2d 6c65 6674 3a20 3165  "margin-left: 1e
-00004510: 6d3b 223e 0a20 2020 2020 2020 2020 2020  m;">.           
-00004520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004530: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00004540: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
-00004550: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-00004560: 626f 6c64 3b22 3e55 6e6d 616e 6167 6564  bold;">Unmanaged
-00004570: 2028 7265 6365 6e74 293a 3c2f 7370 616e   (recent):</span
-00004580: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-00004590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045a0: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-000045b0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-000045c0: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
-000045d0: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
-000045e0: 7061 6365 3b22 3e40 756e 6d61 6e61 6765  pace;">@unmanage
-000045f0: 645f 7265 6365 6e74 7b30 2e30 3020 627d  d_recent{0.00 b}
-00004600: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-00004610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004620: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+000044f0: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+00004500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004510: 2020 2020 2020 2020 2020 3c64 6976 2073            <div s
+00004520: 7479 6c65 3d22 6d61 7267 696e 2d6c 6566  tyle="margin-lef
+00004530: 743a 2031 656d 3b22 3e0a 2020 2020 2020  t: 1em;">.      
+00004540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004550: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00004560: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00004570: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
+00004580: 6768 743a 2062 6f6c 643b 223e 556e 6d61  ght: bold;">Unma
+00004590: 6e61 6765 6420 2872 6563 656e 7429 3a3c  naged (recent):<
+000045a0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045c0: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+000045d0: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+000045e0: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
+000045f0: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
+00004600: 6d6f 6e6f 7370 6163 653b 223e 4075 6e6d  monospace;">@unm
+00004610: 616e 6167 6564 5f72 6563 656e 747b 302e  anaged_recent{0.
+00004620: 3030 2062 7d3c 2f73 7061 6e3e 0a20 2020  00 b}</span>.   
 00004630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004640: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
+00004640: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
 00004650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004660: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-00004670: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-00004680: 697a 653a 2031 3270 783b 2066 6f6e 742d  ize: 12px; font-
-00004690: 7765 6967 6874 3a20 626f 6c64 3b22 3e53  weight: bold;">S
-000046a0: 7069 6c6c 6564 2074 6f20 6469 736b 3a3c  pilled to disk:<
-000046b0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
-000046c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046d0: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-000046e0: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-000046f0: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
-00004700: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
-00004710: 6d6f 6e6f 7370 6163 653b 223e 4073 7069  monospace;">@spi
-00004720: 6c6c 6564 7b30 2e30 3020 627d 3c2f 7370  lled{0.00 b}</sp
-00004730: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004750: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+00004660: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00004670: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00004680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004690: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+000046a0: 6f6e 742d 7369 7a65 3a20 3132 7078 3b20  ont-size: 12px; 
+000046b0: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
+000046c0: 643b 223e 5370 696c 6c65 6420 746f 2064  d;">Spilled to d
+000046d0: 6973 6b3a 3c2f 7370 616e 3e26 6e62 7370  isk:</span>&nbsp
+000046e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000046f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004700: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00004710: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+00004720: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+00004730: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+00004740: 3e40 7370 696c 6c65 647b 302e 3030 2062  >@spilled{0.00 b
+00004750: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
 00004760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004770: 2020 2022 2222 2c0a 2020 2020 2020 2020     """,.        
-00004780: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-00004790: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
-000047a0: 7665 7229 0a0a 2020 2020 4077 6974 686f  ver)..    @witho
-000047b0: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-000047c0: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-000047d0: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-000047e0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-000047f0: 2020 2020 2064 6566 2071 7561 646c 6973       def quadlis
-00004800: 7428 693a 2049 7465 7261 626c 655b 545d  t(i: Iterable[T]
-00004810: 2920 2d3e 206c 6973 745b 545d 3a0a 2020  ) -> list[T]:.  
-00004820: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00004830: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-00004840: 6f72 2069 6920 696e 2069 3a0a 2020 2020  or ii in i:.    
-00004850: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
-00004860: 2b3d 205b 6969 2c20 6969 2c20 6969 2c20  += [ii, ii, ii, 
-00004870: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
-00004880: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
-00004890: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-000048a0: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
-000048b0: 6b65 7273 2e76 616c 7565 7328 290a 0a20  kers.values().. 
-000048c0: 2020 2020 2020 2077 6964 7468 203d 205b         width = [
-000048d0: 5d0a 2020 2020 2020 2020 7820 3d20 5b5d  ].        x = []
-000048e0: 0a20 2020 2020 2020 2063 6f6c 6f72 203d  .        color =
-000048f0: 205b 5d0a 2020 2020 2020 2020 6d61 785f   [].        max_
-00004900: 6c69 6d69 7420 3d20 300a 2020 2020 2020  limit = 0.      
-00004910: 2020 7072 6f63 6d65 6d6f 7279 203d 205b    procmemory = [
-00004920: 5d0a 2020 2020 2020 2020 6d61 6e61 6765  ].        manage
-00004930: 6420 3d20 5b5d 0a20 2020 2020 2020 2073  d = [].        s
-00004940: 7069 6c6c 6564 203d 205b 5d0a 2020 2020  pilled = [].    
-00004950: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
-00004960: 6420 3d20 5b5d 0a20 2020 2020 2020 2075  d = [].        u
-00004970: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
-00004980: 3d20 5b5d 0a0a 2020 2020 2020 2020 666f  = []..        fo
-00004990: 7220 7773 2069 6e20 776f 726b 6572 733a  r ws in workers:
-000049a0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-000049b0: 696e 666f 203d 2077 732e 6d65 6d6f 7279  info = ws.memory
-000049c0: 0a20 2020 2020 2020 2020 2020 206c 696d  .            lim
-000049d0: 6974 203d 2067 6574 6174 7472 2877 732c  it = getattr(ws,
-000049e0: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
-000049f0: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-00004a00: 6d61 785f 6c69 6d69 7420 3d20 6d61 7828  max_limit = max(
-00004a10: 6d61 785f 6c69 6d69 742c 206c 696d 6974  max_limit, limit
-00004a20: 2c20 6d65 6d69 6e66 6f2e 7072 6f63 6573  , meminfo.proces
-00004a30: 7320 2b20 6d65 6d69 6e66 6f2e 7370 696c  s + meminfo.spil
-00004a40: 6c65 6429 0a20 2020 2020 2020 2020 2020  led).           
-00004a50: 2063 6f6c 6f72 5f69 203d 2073 656c 662e   color_i = self.
-00004a60: 5f6d 656d 6f72 795f 636f 6c6f 7228 6d65  _memory_color(me
-00004a70: 6d69 6e66 6f2e 7072 6f63 6573 732c 206c  minfo.process, l
-00004a80: 696d 6974 2c20 7773 2e73 7461 7475 7329  imit, ws.status)
-00004a90: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
-00004aa0: 6474 6820 2b3d 205b 0a20 2020 2020 2020  dth += [.       
-00004ab0: 2020 2020 2020 2020 206d 656d 696e 666f           meminfo
-00004ac0: 2e6d 616e 6167 6564 2c0a 2020 2020 2020  .managed,.      
-00004ad0: 2020 2020 2020 2020 2020 6d65 6d69 6e66            meminf
-00004ae0: 6f2e 756e 6d61 6e61 6765 645f 6f6c 642c  o.unmanaged_old,
-00004af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004b00: 206d 656d 696e 666f 2e75 6e6d 616e 6167   meminfo.unmanag
-00004b10: 6564 5f72 6563 656e 742c 0a20 2020 2020  ed_recent,.     
-00004b20: 2020 2020 2020 2020 2020 206d 656d 696e             memin
-00004b30: 666f 2e73 7069 6c6c 6564 2c0a 2020 2020  fo.spilled,.    
-00004b40: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00004b50: 2020 2020 2020 7820 2b3d 205b 7375 6d28        x += [sum(
-00004b60: 7769 6474 685b 2d34 3a69 5d29 202b 2077  width[-4:i]) + w
-00004b70: 6964 7468 5b69 5d20 2f20 3220 666f 7220  idth[i] / 2 for 
-00004b80: 6920 696e 2072 616e 6765 282d 342c 2030  i in range(-4, 0
-00004b90: 295d 0a20 2020 2020 2020 2020 2020 2063  )].            c
-00004ba0: 6f6c 6f72 202b 3d20 5b63 6f6c 6f72 5f69  olor += [color_i
-00004bb0: 2c20 636f 6c6f 725f 692c 2063 6f6c 6f72  , color_i, color
-00004bc0: 5f69 2c20 2267 7265 7922 5d0a 0a20 2020  _i, "grey"]..   
-00004bd0: 2020 2020 2020 2020 2023 206d 656d 6f72           # memor
-00004be0: 7920 696e 666f 0a20 2020 2020 2020 2020  y info.         
-00004bf0: 2020 2070 726f 636d 656d 6f72 792e 6170     procmemory.ap
-00004c00: 7065 6e64 286d 656d 696e 666f 2e70 726f  pend(meminfo.pro
-00004c10: 6365 7373 290a 2020 2020 2020 2020 2020  cess).          
-00004c20: 2020 6d61 6e61 6765 642e 6170 7065 6e64    managed.append
-00004c30: 286d 656d 696e 666f 2e6d 616e 6167 6564  (meminfo.managed
-00004c40: 290a 2020 2020 2020 2020 2020 2020 756e  ).            un
-00004c50: 6d61 6e61 6765 645f 6f6c 642e 6170 7065  managed_old.appe
-00004c60: 6e64 286d 656d 696e 666f 2e75 6e6d 616e  nd(meminfo.unman
-00004c70: 6167 6564 5f6f 6c64 290a 2020 2020 2020  aged_old).      
-00004c80: 2020 2020 2020 756e 6d61 6e61 6765 645f        unmanaged_
-00004c90: 7265 6365 6e74 2e61 7070 656e 6428 6d65  recent.append(me
-00004ca0: 6d69 6e66 6f2e 756e 6d61 6e61 6765 645f  minfo.unmanaged_
-00004cb0: 7265 6365 6e74 290a 2020 2020 2020 2020  recent).        
-00004cc0: 2020 2020 7370 696c 6c65 642e 6170 7065      spilled.appe
-00004cd0: 6e64 286d 656d 696e 666f 2e73 7069 6c6c  nd(meminfo.spill
-00004ce0: 6564 290a 0a20 2020 2020 2020 2072 6573  ed)..        res
-00004cf0: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
-00004d00: 2020 2020 2277 6964 7468 223a 2077 6964      "width": wid
-00004d10: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-00004d20: 2278 223a 2078 2c0a 2020 2020 2020 2020  "x": x,.        
-00004d30: 2020 2020 2263 6f6c 6f72 223a 2063 6f6c      "color": col
-00004d40: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00004d50: 2261 6c70 6861 223a 205b 312c 2030 2e37  "alpha": [1, 0.7
-00004d60: 2c20 302e 342c 2031 5d20 2a20 6c65 6e28  , 0.4, 1] * len(
-00004d70: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
-00004d80: 2020 2020 2020 2277 6f72 6b65 7222 3a20        "worker": 
-00004d90: 7175 6164 6c69 7374 2877 732e 6164 6472  quadlist(ws.addr
-00004da0: 6573 7320 666f 7220 7773 2069 6e20 776f  ess for ws in wo
-00004db0: 726b 6572 7329 2c0a 2020 2020 2020 2020  rkers),.        
-00004dc0: 2020 2020 2265 7363 6170 6564 5f77 6f72      "escaped_wor
-00004dd0: 6b65 7222 3a20 7175 6164 6c69 7374 2865  ker": quadlist(e
-00004de0: 7363 6170 652e 7572 6c5f 6573 6361 7065  scape.url_escape
-00004df0: 2877 732e 6164 6472 6573 7329 2066 6f72  (ws.address) for
-00004e00: 2077 7320 696e 2077 6f72 6b65 7273 292c   ws in workers),
-00004e10: 0a20 2020 2020 2020 2020 2020 2022 7922  .            "y"
-00004e20: 3a20 7175 6164 6c69 7374 2872 616e 6765  : quadlist(range
-00004e30: 286c 656e 2877 6f72 6b65 7273 2929 292c  (len(workers))),
-00004e40: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
-00004e50: 6f63 5f6d 656d 6f72 7922 3a20 7175 6164  oc_memory": quad
-00004e60: 6c69 7374 2870 726f 636d 656d 6f72 7929  list(procmemory)
-00004e70: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00004e80: 616e 6167 6564 223a 2071 7561 646c 6973  anaged": quadlis
-00004e90: 7428 6d61 6e61 6765 6429 2c0a 2020 2020  t(managed),.    
-00004ea0: 2020 2020 2020 2020 2275 6e6d 616e 6167          "unmanag
-00004eb0: 6564 5f6f 6c64 223a 2071 7561 646c 6973  ed_old": quadlis
-00004ec0: 7428 756e 6d61 6e61 6765 645f 6f6c 6429  t(unmanaged_old)
-00004ed0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-00004ee0: 6e6d 616e 6167 6564 5f72 6563 656e 7422  nmanaged_recent"
-00004ef0: 3a20 7175 6164 6c69 7374 2875 6e6d 616e  : quadlist(unman
-00004f00: 6167 6564 5f72 6563 656e 7429 2c0a 2020  aged_recent),.  
-00004f10: 2020 2020 2020 2020 2020 2273 7069 6c6c            "spill
-00004f20: 6564 223a 2071 7561 646c 6973 7428 7370  ed": quadlist(sp
-00004f30: 696c 6c65 6429 2c0a 2020 2020 2020 2020  illed),.        
-00004f40: 7d0a 2020 2020 2020 2020 2320 5265 6d6f  }.        # Remo
-00004f50: 7665 2072 6563 7461 6e67 6c65 7320 7769  ve rectangles wi
-00004f60: 7468 2077 6964 7468 3d30 0a20 2020 2020  th width=0.     
-00004f70: 2020 2072 6573 756c 7420 3d20 7b6b 3a20     result = {k: 
-00004f80: 5b76 6920 666f 7220 7669 2c20 7720 696e  [vi for vi, w in
-00004f90: 207a 6970 2876 2c20 7769 6474 6829 2069   zip(v, width) i
-00004fa0: 6620 775d 2066 6f72 206b 2c20 7620 696e  f w] for k, v in
-00004fb0: 2072 6573 756c 742e 6974 656d 7328 297d   result.items()}
-00004fc0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00004fd0: 6f6f 742e 785f 7261 6e67 652e 656e 6420  oot.x_range.end 
-00004fe0: 3d20 6d61 785f 6c69 6d69 740a 2020 2020  = max_limit.    
-00004ff0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-00005000: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
-00005010: 0a0a 636c 6173 7320 576f 726b 6572 734d  ..class WorkersM
-00005020: 656d 6f72 7948 6973 746f 6772 616d 2844  emoryHistogram(D
-00005030: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
-00005040: 7429 3a0a 2020 2020 2222 2248 6973 746f  t):.    """Histo
-00005050: 6772 616d 206f 6620 6d65 6d6f 7279 2075  gram of memory u
-00005060: 7361 6765 2c20 7368 6f77 696e 6720 686f  sage, showing ho
-00005070: 7720 6d61 6e79 2077 6f72 6b65 7273 2074  w many workers t
-00005080: 6865 7265 2061 7265 2069 6e20 6561 6368  here are in each
-00005090: 2062 7563 6b65 7420 6f66 0a20 2020 2075   bucket of.    u
-000050a0: 7361 6765 2e20 5265 706c 6163 6573 2074  sage. Replaces t
-000050b0: 6865 2070 6572 2d77 6f72 6b65 7220 6772  he per-worker gr
-000050c0: 6170 6820 7768 656e 2074 6865 7265 2061  aph when there a
-000050d0: 7265 203e 3d20 3530 2077 6f72 6b65 7273  re >= 50 workers
-000050e0: 2e0a 2020 2020 2222 220a 0a20 2020 2040  ..    """..    @
-000050f0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-00005100: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00005110: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-00005120: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00005130: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
-00005140: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-00005150: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
-00005160: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-00005170: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-00005180: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
-00005190: 2020 2020 207b 226c 6566 7422 3a20 5b31       {"left": [1
-000051a0: 2c20 325d 2c20 2272 6967 6874 223a 205b  , 2], "right": [
-000051b0: 3130 2c20 3130 5d2c 2022 746f 7022 3a20  10, 10], "top": 
-000051c0: 5b30 2c20 305d 7d0a 2020 2020 2020 2020  [0, 0]}.        
-000051d0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000051e0: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-000051f0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-00005200: 3d22 4279 7465 7320 7374 6f72 6564 2070  ="Bytes stored p
-00005210: 6572 2077 6f72 6b65 7222 2c0a 2020 2020  er worker",.    
-00005220: 2020 2020 2020 2020 6e61 6d65 3d22 776f          name="wo
-00005230: 726b 6572 735f 6d65 6d6f 7279 222c 0a20  rkers_memory",. 
-00005240: 2020 2020 2020 2020 2020 2079 5f61 7869             y_axi
-00005250: 735f 6c61 6265 6c3d 2266 7265 7175 656e  s_label="frequen
-00005260: 6379 222c 0a20 2020 2020 2020 2020 2020  cy",.           
-00005270: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00005280: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-00005290: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-000052a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-000052b0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-000052c0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-000052d0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-000052e0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
-000052f0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
-00005300: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
-00005310: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
-00005320: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
-00005330: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
-00005340: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
-00005350: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
-00005360: 5249 454e 5441 5449 4f4e 0a0a 2020 2020  RIENTATION..    
-00005370: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00005380: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
-00005390: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
-000053a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-000053b0: 7967 7269 642e 7669 7369 626c 6520 3d20  ygrid.visible = 
-000053c0: 4661 6c73 650a 0a20 2020 2020 2020 2073  False..        s
-000053d0: 656c 662e 726f 6f74 2e74 6f6f 6c62 6172  elf.root.toolbar
-000053e0: 5f6c 6f63 6174 696f 6e20 3d20 4e6f 6e65  _location = None
-000053f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00005400: 6f6f 742e 7175 6164 280a 2020 2020 2020  oot.quad(.      
-00005410: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-00005420: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-00005430: 2020 2020 2020 6c65 6674 3d22 6c65 6674        left="left
-00005440: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
-00005450: 6967 6874 3d22 7269 6768 7422 2c0a 2020  ight="right",.  
-00005460: 2020 2020 2020 2020 2020 626f 7474 6f6d            bottom
-00005470: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
-00005480: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
-00005490: 2020 2020 2020 2063 6f6c 6f72 3d22 6465         color="de
-000054a0: 6570 736b 7962 6c75 6522 2c0a 2020 2020  epskyblue",.    
-000054b0: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
-000054c0: 6861 3d30 2e35 2c0a 2020 2020 2020 2020  ha=0.5,.        
-000054d0: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-000054e0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-000054f0: 696f 6e0a 2020 2020 6465 6620 7570 6461  ion.    def upda
-00005500: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-00005510: 2020 6e62 7974 6573 203d 206e 702e 6173    nbytes = np.as
-00005520: 6172 7261 7928 0a20 2020 2020 2020 2020  array(.         
-00005530: 2020 205b 7773 2e6d 6574 7269 6373 5b22     [ws.metrics["
-00005540: 6d65 6d6f 7279 225d 2066 6f72 2077 7320  memory"] for ws 
-00005550: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
-00005560: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-00005570: 2829 5d0a 2020 2020 2020 2020 290a 2020  ()].        ).  
-00005580: 2020 2020 2020 636f 756e 7473 2c20 7820        counts, x 
-00005590: 3d20 6e70 2e68 6973 746f 6772 616d 286e  = np.histogram(n
-000055a0: 6279 7465 732c 2062 696e 733d 3430 290a  bytes, bins=40).
-000055b0: 2020 2020 2020 2020 6420 3d20 7b22 6c65          d = {"le
-000055c0: 6674 223a 2078 5b3a 2d31 5d2c 2022 7269  ft": x[:-1], "ri
-000055d0: 6768 7422 3a20 785b 313a 5d2c 2022 746f  ght": x[1:], "to
-000055e0: 7022 3a20 636f 756e 7473 7d0a 2020 2020  p": counts}.    
-000055f0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-00005600: 736f 7572 6365 2c20 6429 0a0a 0a63 6c61  source, d)...cla
-00005610: 7373 2057 6f72 6b65 7273 5472 616e 7366  ss WorkersTransf
-00005620: 6572 4279 7465 7328 4461 7368 626f 6172  erBytes(Dashboar
-00005630: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00005640: 2022 2222 5369 7a65 206f 6620 6f70 656e   """Size of open
-00005650: 2064 6174 6120 7472 616e 7366 6572 7320   data transfers 
-00005660: 6672 6f6d 2f74 6f20 6f74 6865 7220 776f  from/to other wo
-00005670: 726b 6572 7320 7065 7220 776f 726b 6572  rkers per worker
-00005680: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
-00005690: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
-000056a0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-000056b0: 6475 6c65 722c 2077 6964 7468 3d36 3030  duler, width=600
-000056c0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000056d0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-000056e0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-000056f0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00005700: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
-00005710: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
-00005720: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00005730: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
-00005740: 6f72 6b65 7222 3a20 5b5d 2c0a 2020 2020  orker": [],.    
-00005750: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
-00005760: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
-00005770: 7974 6573 223a 205b 5d2c 0a20 2020 2020  ytes": [],.     
-00005780: 2020 2020 2020 2020 2020 2022 7472 616e             "tran
-00005790: 7366 6572 5f6f 7574 676f 696e 675f 6279  sfer_outgoing_by
-000057a0: 7465 7322 3a20 5b5d 2c0a 2020 2020 2020  tes": [],.      
-000057b0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-000057c0: 7222 3a20 5b5d 2c0a 2020 2020 2020 2020  r": [],.        
-000057d0: 2020 2020 2020 2020 2279 5f69 6e63 6f6d          "y_incom
-000057e0: 696e 6722 3a20 5b5d 2c0a 2020 2020 2020  ing": [],.      
-000057f0: 2020 2020 2020 2020 2020 2279 5f6f 7574            "y_out
-00005800: 676f 696e 6722 3a20 5b5d 2c0a 2020 2020  going": [],.    
-00005810: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00005820: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00005830: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
-00005840: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-00005850: 6c65 3d66 2242 7974 6573 2074 7261 6e73  le=f"Bytes trans
-00005860: 6665 7272 696e 673a 207b 666f 726d 6174  ferring: {format
-00005870: 5f62 7974 6573 2830 297d 222c 0a20 2020  _bytes(0)}",.   
-00005880: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
-00005890: 222c 0a20 2020 2020 2020 2020 2020 2077  ",.            w
-000058a0: 6964 7468 3d69 6e74 2877 6964 7468 202f  idth=int(width /
-000058b0: 2032 292c 0a20 2020 2020 2020 2020 2020   2),.           
-000058c0: 206e 616d 653d 2277 6f72 6b65 7273 5f74   name="workers_t
-000058d0: 7261 6e73 6665 725f 6279 7465 7322 2c0a  ransfer_bytes",.
-000058e0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-000058f0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
-00005900: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00005910: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-00005920: 290a 0a20 2020 2020 2020 2023 2074 7261  )..        # tra
-00005930: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
-00005940: 7974 6573 0a20 2020 2020 2020 2073 656c  ytes.        sel
-00005950: 662e 726f 6f74 2e68 6261 7228 0a20 2020  f.root.hbar(.   
-00005960: 2020 2020 2020 2020 206e 616d 653d 2274           name="t
-00005970: 7261 6e73 6665 725f 696e 636f 6d69 6e67  ransfer_incoming
-00005980: 5f62 7974 6573 222c 0a20 2020 2020 2020  _bytes",.       
-00005990: 2020 2020 2079 3d22 795f 696e 636f 6d69       y="y_incomi
-000059a0: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
-000059b0: 2072 6967 6874 3d22 7472 616e 7366 6572   right="transfer
-000059c0: 5f69 6e63 6f6d 696e 675f 6279 7465 7322  _incoming_bytes"
-000059d0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-000059e0: 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20  ne_color=None,. 
-000059f0: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-00005a00: 302c 0a20 2020 2020 2020 2020 2020 2068  0,.            h
-00005a10: 6569 6768 743d 302e 352c 0a20 2020 2020  eight=0.5,.     
-00005a20: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
-00005a30: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
-00005a40: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00005a50: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00005a60: 2029 0a0a 2020 2020 2020 2020 2320 7472   )..        # tr
-00005a70: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
-00005a80: 6279 7465 730a 2020 2020 2020 2020 7365  bytes.        se
-00005a90: 6c66 2e72 6f6f 742e 6862 6172 280a 2020  lf.root.hbar(.  
-00005aa0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
-00005ab0: 7472 616e 7366 6572 5f6f 7574 676f 696e  transfer_outgoin
-00005ac0: 675f 6279 7465 7322 2c0a 2020 2020 2020  g_bytes",.      
-00005ad0: 2020 2020 2020 793d 2279 5f6f 7574 676f        y="y_outgo
-00005ae0: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
-00005af0: 2020 7269 6768 743d 2274 7261 6e73 6665    right="transfe
-00005b00: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
-00005b10: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
-00005b20: 696e 655f 636f 6c6f 723d 4e6f 6e65 2c0a  ine_color=None,.
-00005b30: 2020 2020 2020 2020 2020 2020 6c65 6674              left
-00005b40: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
-00005b50: 6865 6967 6874 3d30 2e35 2c0a 2020 2020  height=0.5,.    
-00005b60: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
-00005b70: 6f72 3d22 626c 7565 222c 0a20 2020 2020  or="blue",.     
-00005b80: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00005b90: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-00005ba0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00005bb0: 6c66 2e72 6f6f 742e 6178 6973 5b30 5d2e  lf.root.axis[0].
-00005bc0: 7469 636b 6572 203d 2042 6173 6963 5469  ticker = BasicTi
-00005bd0: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
-00005be0: 3429 0a20 2020 2020 2020 2073 656c 662e  4).        self.
-00005bf0: 726f 6f74 2e78 6178 6973 5b30 5d2e 666f  root.xaxis[0].fo
-00005c00: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
-00005c10: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
-00005c20: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
-00005c30: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00005c40: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
-00005c50: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
-00005c60: 2058 4c41 4245 4c5f 4f52 4945 4e54 4154   XLABEL_ORIENTAT
-00005c70: 494f 4e0a 2020 2020 2020 2020 7365 6c66  ION.        self
-00005c80: 2e72 6f6f 742e 7861 7869 732e 6d69 6e6f  .root.xaxis.mino
-00005c90: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
-00005ca0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
-00005cb0: 6c66 2e72 6f6f 742e 785f 7261 6e67 6520  lf.root.x_range 
-00005cc0: 3d20 5261 6e67 6531 6428 7374 6172 743d  = Range1d(start=
-00005cd0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-00005ce0: 726f 6f74 2e79 6178 6973 2e76 6973 6962  root.yaxis.visib
-00005cf0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-00005d00: 2020 2073 656c 662e 726f 6f74 2e79 6772     self.root.ygr
-00005d10: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
-00005d20: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-00005d30: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
-00005d40: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-00005d50: 2020 2020 2020 7461 7020 3d20 5461 7054        tap = TapT
-00005d60: 6f6f 6c28 6361 6c6c 6261 636b 3d4f 7065  ool(callback=Ope
-00005d70: 6e55 524c 2875 726c 3d22 2e2f 696e 666f  nURL(url="./info
-00005d80: 2f77 6f72 6b65 722f 4065 7363 6170 6564  /worker/@escaped
-00005d90: 5f77 6f72 6b65 722e 6874 6d6c 2229 290a  _worker.html")).
-00005da0: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
-00005db0: 486f 7665 7254 6f6f 6c28 0a20 2020 2020  HoverTool(.     
-00005dc0: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
-00005dd0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00005de0: 2020 2822 576f 726b 6572 222c 2022 4077    ("Worker", "@w
-00005df0: 6f72 6b65 7222 292c 0a20 2020 2020 2020  orker"),.       
-00005e00: 2020 2020 2020 2020 2028 2249 6e63 6f6d           ("Incom
-00005e10: 696e 6722 2c20 2240 7472 616e 7366 6572  ing", "@transfer
-00005e20: 5f69 6e63 6f6d 696e 675f 6279 7465 737b  _incoming_bytes{
-00005e30: 302e 3030 2062 7d22 292c 0a20 2020 2020  0.00 b}"),.     
-00005e40: 2020 2020 2020 2020 2020 2028 224f 7574             ("Out
-00005e50: 676f 696e 6722 2c20 2240 7472 616e 7366  going", "@transf
-00005e60: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
-00005e70: 737b 302e 3030 2062 7d22 292c 0a20 2020  s{0.00 b}"),.   
-00005e80: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-00005e90: 2020 2020 2020 2020 706f 696e 745f 706f          point_po
-00005ea0: 6c69 6379 3d22 666f 6c6c 6f77 5f6d 6f75  licy="follow_mou
-00005eb0: 7365 222c 0a20 2020 2020 2020 2029 0a20  se",.        ). 
-00005ec0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00005ed0: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
-00005ee0: 2c20 7461 7029 0a0a 2020 2020 4077 6974  , tap)..    @wit
-00005ef0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-00005f00: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-00005f10: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-00005f20: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-00005f30: 2020 2020 2020 2077 7373 203d 2073 656c         wss = sel
-00005f40: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-00005f50: 6572 732e 7661 6c75 6573 2829 0a0a 2020  ers.values()..  
-00005f60: 2020 2020 2020 6820 3d20 302e 310a 2020        h = 0.1.  
-00005f70: 2020 2020 2020 795f 696e 636f 6d69 6e67        y_incoming
-00005f80: 203d 205b 6920 2b20 302e 3735 202b 2069   = [i + 0.75 + i
-00005f90: 202a 2068 2066 6f72 2069 2069 6e20 7261   * h for i in ra
-00005fa0: 6e67 6528 6c65 6e28 7773 7329 295d 0a20  nge(len(wss))]. 
-00005fb0: 2020 2020 2020 2079 5f6f 7574 676f 696e         y_outgoin
-00005fc0: 6720 3d20 5b69 202b 2030 2e32 3520 2b20  g = [i + 0.25 + 
-00005fd0: 6920 2a20 6820 666f 7220 6920 696e 2072  i * h for i in r
-00005fe0: 616e 6765 286c 656e 2877 7373 2929 5d0a  ange(len(wss))].
-00005ff0: 0a20 2020 2020 2020 2074 7261 6e73 6665  .        transfe
-00006000: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
-00006010: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00006020: 2077 732e 6d65 7472 6963 735b 2274 7261   ws.metrics["tra
-00006030: 6e73 6665 7222 5d5b 2269 6e63 6f6d 696e  nsfer"]["incomin
-00006040: 675f 6279 7465 7322 5d20 666f 7220 7773  g_bytes"] for ws
-00006050: 2069 6e20 7773 730a 2020 2020 2020 2020   in wss.        
-00006060: 5d0a 2020 2020 2020 2020 7472 616e 7366  ].        transf
-00006070: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
-00006080: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00006090: 2020 7773 2e6d 6574 7269 6373 5b22 7472    ws.metrics["tr
-000060a0: 616e 7366 6572 225d 5b22 6f75 7467 6f69  ansfer"]["outgoi
-000060b0: 6e67 5f62 7974 6573 225d 2066 6f72 2077  ng_bytes"] for w
-000060c0: 7320 696e 2077 7373 0a20 2020 2020 2020  s in wss.       
-000060d0: 205d 0a20 2020 2020 2020 2077 6f72 6b65   ].        worke
-000060e0: 7273 203d 205b 7773 2e61 6464 7265 7373  rs = [ws.address
-000060f0: 2066 6f72 2077 7320 696e 2077 7373 5d0a   for ws in wss].
-00006100: 2020 2020 2020 2020 6573 6361 7065 645f          escaped_
-00006110: 776f 726b 6572 7320 3d20 5b65 7363 6170  workers = [escap
-00006120: 652e 7572 6c5f 6573 6361 7065 2877 6f72  e.url_escape(wor
-00006130: 6b65 7229 2066 6f72 2077 6f72 6b65 7220  ker) for worker 
-00006140: 696e 2077 6f72 6b65 7273 5d0a 0a20 2020  in workers]..   
-00006150: 2020 2020 2069 6620 7773 733a 0a20 2020       if wss:.   
-00006160: 2020 2020 2020 2020 2078 5f6c 696d 6974           x_limit
-00006170: 203d 206d 6178 280a 2020 2020 2020 2020   = max(.        
-00006180: 2020 2020 2020 2020 6d61 7828 7472 616e          max(tran
-00006190: 7366 6572 5f69 6e63 6f6d 696e 675f 6279  sfer_incoming_by
-000061a0: 7465 7329 2c0a 2020 2020 2020 2020 2020  tes),.          
-000061b0: 2020 2020 2020 6d61 7828 7472 616e 7366        max(transf
-000061c0: 6572 5f6f 7574 676f 696e 675f 6279 7465  er_outgoing_byte
-000061d0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000061e0: 2020 2020 6d61 7828 7773 2e6d 656d 6f72      max(ws.memor
-000061f0: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
-00006200: 6e20 7773 7329 2c0a 2020 2020 2020 2020  n wss),.        
-00006210: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00006220: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006230: 785f 6c69 6d69 7420 3d20 300a 2020 2020  x_limit = 0.    
-00006240: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
-00006250: 7261 6e67 652e 656e 6420 3d20 785f 6c69  range.end = x_li
-00006260: 6d69 740a 0a20 2020 2020 2020 2072 6573  mit..        res
-00006270: 756c 7420 3d20 7b0a 2020 2020 2020 2020  ult = {.        
-00006280: 2020 2020 2265 7363 6170 6564 5f77 6f72      "escaped_wor
-00006290: 6b65 7222 3a20 6573 6361 7065 645f 776f  ker": escaped_wo
-000062a0: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
-000062b0: 2020 2022 7472 616e 7366 6572 5f69 6e63     "transfer_inc
-000062c0: 6f6d 696e 675f 6279 7465 7322 3a20 7472  oming_bytes": tr
-000062d0: 616e 7366 6572 5f69 6e63 6f6d 696e 675f  ansfer_incoming_
-000062e0: 6279 7465 732c 0a20 2020 2020 2020 2020  bytes,.         
-000062f0: 2020 2022 7472 616e 7366 6572 5f6f 7574     "transfer_out
-00006300: 676f 696e 675f 6279 7465 7322 3a20 7472  going_bytes": tr
-00006310: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
-00006320: 6279 7465 732c 0a20 2020 2020 2020 2020  bytes,.         
-00006330: 2020 2022 776f 726b 6572 223a 2077 6f72     "worker": wor
-00006340: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
-00006350: 2020 2279 5f69 6e63 6f6d 696e 6722 3a20    "y_incoming": 
-00006360: 795f 696e 636f 6d69 6e67 2c0a 2020 2020  y_incoming,.    
-00006370: 2020 2020 2020 2020 2279 5f6f 7574 676f          "y_outgo
-00006380: 696e 6722 3a20 795f 6f75 7467 6f69 6e67  ing": y_outgoing
-00006390: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-000063a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7469      self.root.ti
-000063b0: 746c 652e 7465 7874 203d 2028 0a20 2020  tle.text = (.   
-000063c0: 2020 2020 2020 2020 2066 2242 7974 6573           f"Bytes
-000063d0: 2074 7261 6e73 6665 7272 696e 673a 207b   transferring: {
-000063e0: 666f 726d 6174 5f62 7974 6573 2873 756d  format_bytes(sum
-000063f0: 2874 7261 6e73 6665 725f 696e 636f 6d69  (transfer_incomi
-00006400: 6e67 5f62 7974 6573 2929 7d22 0a20 2020  ng_bytes))}".   
-00006410: 2020 2020 2029 0a20 2020 2020 2020 2075       ).        u
-00006420: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
-00006430: 652c 2072 6573 756c 7429 0a0a 0a63 6c61  e, result)...cla
-00006440: 7373 2048 6172 6477 6172 6528 4461 7368  ss Hardware(Dash
-00006450: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
-00006460: 0a20 2020 2022 2222 4f63 6375 7061 6e63  .    """Occupanc
-00006470: 7920 2869 6e20 7469 6d65 2920 7065 7220  y (in time) per 
-00006480: 776f 726b 6572 2222 220a 0a20 2020 2040  worker"""..    @
-00006490: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-000064a0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000064b0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-000064c0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-000064d0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-000064e0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
-000064f0: 2020 2023 2044 6973 6b0a 2020 2020 2020     # Disk.      
-00006500: 2020 7365 6c66 2e64 6973 6b5f 736f 7572    self.disk_sour
-00006510: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-00006520: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-00006530: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00006540: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
-00006550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006560: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
-00006570: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00006580: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00006590: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
-000065a0: 7572 6520 3d20 6669 6775 7265 280a 2020  ure = figure(.  
-000065b0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-000065c0: 2244 6973 6b20 4261 6e64 7769 6474 6820  "Disk Bandwidth 
-000065d0: 2d2d 2043 6f6d 7075 7469 6e67 202e 2e2e  -- Computing ...
-000065e0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-000065f0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-00006600: 2020 2020 2074 6f6f 6c62 6172 5f6c 6f63       toolbar_loc
-00006610: 6174 696f 6e3d 2261 626f 7665 222c 0a20  ation="above",. 
-00006620: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-00006630: 6765 3d46 6163 746f 7252 616e 6765 2866  ge=FactorRange(f
-00006640: 6163 746f 7273 3d5b 5d29 2c0a 2020 2020  actors=[]),.    
-00006650: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00006660: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00006670: 2020 2020 7365 6c66 2e64 6973 6b5f 6669      self.disk_fi
-00006680: 6775 7265 2e76 6261 7228 0a20 2020 2020  gure.vbar(.     
-00006690: 2020 2020 2020 2078 3d22 7369 7a65 222c         x="size",
-000066a0: 2074 6f70 3d22 6261 6e64 7769 6474 6822   top="bandwidth"
-000066b0: 2c20 7769 6474 683d 302e 392c 2073 6f75  , width=0.9, sou
-000066c0: 7263 653d 7365 6c66 2e64 6973 6b5f 736f  rce=self.disk_so
-000066d0: 7572 6365 0a20 2020 2020 2020 2029 0a20  urce.        ). 
-000066e0: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-000066f0: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
-00006700: 2020 2020 2020 6d6f 6465 3d22 766c 696e        mode="vlin
-00006710: 6522 2c20 746f 6f6c 7469 7073 3d5b 2822  e", tooltips=[("
-00006720: 4261 6e64 7769 6474 6822 2c20 2240 6261  Bandwidth", "@ba
-00006730: 6e64 7769 6474 687b 302e 3030 2062 7d2f  ndwidth{0.00 b}/
-00006740: 7322 295d 0a20 2020 2020 2020 2029 0a20  s")].        ). 
-00006750: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-00006760: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
-00006770: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
-00006780: 2073 656c 662e 6469 736b 5f66 6967 7572   self.disk_figur
-00006790: 652e 7961 7869 735b 305d 2e66 6f72 6d61  e.yaxis[0].forma
-000067a0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
-000067b0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
-000067c0: 6174 3d22 302e 3020 6222 290a 2020 2020  at="0.0 b").    
-000067d0: 2020 2020 7365 6c66 2e64 6973 6b5f 6669      self.disk_fi
-000067e0: 6775 7265 2e78 6772 6964 2e76 6973 6962  gure.xgrid.visib
-000067f0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
-00006800: 2020 2020 2320 4d65 6d6f 7279 0a20 2020      # Memory.   
-00006810: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-00006820: 5f73 6f75 7263 6520 3d20 436f 6c75 6d6e  _source = Column
-00006830: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
-00006840: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00006850: 2020 2020 2020 2020 2020 2273 697a 6522            "size"
-00006860: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00006870: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-00006880: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00006890: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
-000068a0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-000068b0: 6f72 795f 6669 6775 7265 203d 2066 6967  ory_figure = fig
-000068c0: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-000068d0: 2074 6974 6c65 3d22 4d65 6d6f 7279 2042   title="Memory B
-000068e0: 616e 6477 6964 7468 202d 2d20 436f 6d70  andwidth -- Comp
-000068f0: 7574 696e 6720 2e2e 2e22 2c0a 2020 2020  uting ...",.    
-00006900: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-00006910: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00006920: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
-00006930: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
-00006940: 2020 2020 785f 7261 6e67 653d 4661 6374      x_range=Fact
-00006950: 6f72 5261 6e67 6528 6661 6374 6f72 733d  orRange(factors=
-00006960: 5b5d 292c 0a20 2020 2020 2020 2020 2020  []),.           
-00006970: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00006980: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00006990: 6c66 2e6d 656d 6f72 795f 6669 6775 7265  lf.memory_figure
-000069a0: 2e76 6261 7228 0a20 2020 2020 2020 2020  .vbar(.         
-000069b0: 2020 2078 3d22 7369 7a65 222c 2074 6f70     x="size", top
-000069c0: 3d22 6261 6e64 7769 6474 6822 2c20 7769  ="bandwidth", wi
-000069d0: 6474 683d 302e 392c 2073 6f75 7263 653d  dth=0.9, source=
-000069e0: 7365 6c66 2e6d 656d 6f72 795f 736f 7572  self.memory_sour
-000069f0: 6365 0a20 2020 2020 2020 2029 0a20 2020  ce.        ).   
-00006a00: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-00006a10: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
-00006a20: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
-00006a30: 2c20 746f 6f6c 7469 7073 3d5b 2822 4261  , tooltips=[("Ba
-00006a40: 6e64 7769 6474 6822 2c20 2240 6261 6e64  ndwidth", "@band
-00006a50: 7769 6474 687b 302e 3030 2062 7d2f 7322  width{0.00 b}/s"
-00006a60: 295d 0a20 2020 2020 2020 2029 0a20 2020  )].        ).   
-00006a70: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-00006a80: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
-00006a90: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
-00006aa0: 2073 656c 662e 6d65 6d6f 7279 5f66 6967   self.memory_fig
-00006ab0: 7572 652e 7961 7869 735b 305d 2e66 6f72  ure.yaxis[0].for
-00006ac0: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
-00006ad0: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
-00006ae0: 726d 6174 3d22 302e 3020 6222 290a 2020  rmat="0.0 b").  
-00006af0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-00006b00: 795f 6669 6775 7265 2e78 6772 6964 2e76  y_figure.xgrid.v
-00006b10: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-00006b20: 2020 2020 2020 2020 2320 4e65 7477 6f72          # Networ
-00006b30: 6b0a 2020 2020 2020 2020 7365 6c66 2e6e  k.        self.n
-00006b40: 6574 776f 726b 5f73 6f75 7263 6520 3d20  etwork_source = 
-00006b50: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-00006b60: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-00006b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b80: 2273 697a 6522 3a20 5b5d 2c0a 2020 2020  "size": [],.    
-00006b90: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-00006ba0: 6477 6964 7468 223a 205b 5d2c 0a20 2020  dwidth": [],.   
-00006bb0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00006bc0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00006bd0: 6c66 2e6e 6574 776f 726b 5f66 6967 7572  lf.network_figur
-00006be0: 6520 3d20 6669 6775 7265 280a 2020 2020  e = figure(.    
-00006bf0: 2020 2020 2020 2020 7469 746c 653d 224e          title="N
-00006c00: 6574 776f 726b 2042 616e 6477 6964 7468  etwork Bandwidth
-00006c10: 202d 2d20 436f 6d70 7574 696e 6720 2e2e   -- Computing ..
-00006c20: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
-00006c30: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-00006c40: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
-00006c50: 6361 7469 6f6e 3d22 6162 6f76 6522 2c0a  cation="above",.
-00006c60: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
-00006c70: 6e67 653d 4661 6374 6f72 5261 6e67 6528  nge=FactorRange(
-00006c80: 6661 6374 6f72 733d 5b5d 292c 0a20 2020  factors=[]),.   
-00006c90: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00006ca0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00006cb0: 2020 2020 2020 7365 6c66 2e6e 6574 776f        self.netwo
-00006cc0: 726b 5f66 6967 7572 652e 7662 6172 280a  rk_figure.vbar(.
-00006cd0: 2020 2020 2020 2020 2020 2020 783d 2273              x="s
-00006ce0: 697a 6522 2c20 746f 703d 2262 616e 6477  ize", top="bandw
-00006cf0: 6964 7468 222c 2077 6964 7468 3d30 2e39  idth", width=0.9
-00006d00: 2c20 736f 7572 6365 3d73 656c 662e 6e65  , source=self.ne
-00006d10: 7477 6f72 6b5f 736f 7572 6365 0a20 2020  twork_source.   
-00006d20: 2020 2020 2029 0a20 2020 2020 2020 2068       ).        h
-00006d30: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-00006d40: 280a 2020 2020 2020 2020 2020 2020 6d6f  (.            mo
-00006d50: 6465 3d22 766c 696e 6522 2c20 746f 6f6c  de="vline", tool
-00006d60: 7469 7073 3d5b 2822 4261 6e64 7769 6474  tips=[("Bandwidt
-00006d70: 6822 2c20 2240 6261 6e64 7769 6474 687b  h", "@bandwidth{
-00006d80: 302e 3030 2062 7d2f 7322 295d 0a20 2020  0.00 b}/s")].   
-00006d90: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00006da0: 656c 662e 6e65 7477 6f72 6b5f 6669 6775  elf.network_figu
-00006db0: 7265 2e61 6464 5f74 6f6f 6c73 2868 6f76  re.add_tools(hov
-00006dc0: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
-00006dd0: 2e6e 6574 776f 726b 5f66 6967 7572 652e  .network_figure.
-00006de0: 7961 7869 735b 305d 2e66 6f72 6d61 7474  yaxis[0].formatt
-00006df0: 6572 203d 204e 756d 6572 616c 5469 636b  er = NumeralTick
-00006e00: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
-00006e10: 3d22 302e 3020 6222 290a 2020 2020 2020  ="0.0 b").      
-00006e20: 2020 7365 6c66 2e6e 6574 776f 726b 5f66    self.network_f
-00006e30: 6967 7572 652e 7867 7269 642e 7669 7369  igure.xgrid.visi
-00006e40: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
-00006e50: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
-00006e60: 2072 6f77 280a 2020 2020 2020 2020 2020   row(.          
-00006e70: 2020 7365 6c66 2e6d 656d 6f72 795f 6669    self.memory_fi
-00006e80: 6775 7265 2c0a 2020 2020 2020 2020 2020  gure,.          
-00006e90: 2020 7365 6c66 2e64 6973 6b5f 6669 6775    self.disk_figu
-00006ea0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-00006eb0: 7365 6c66 2e6e 6574 776f 726b 5f66 6967  self.network_fig
-00006ec0: 7572 652c 0a20 2020 2020 2020 2029 0a0a  ure,.        )..
-00006ed0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-00006ee0: 6f72 795f 6461 7461 203d 207b 0a20 2020  ory_data = {.   
-00006ef0: 2020 2020 2020 2020 2022 7369 7a65 223a           "size":
-00006f00: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00006f10: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
-00006f20: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-00006f30: 2020 2020 7365 6c66 2e64 6973 6b5f 6461      self.disk_da
-00006f40: 7461 203d 207b 0a20 2020 2020 2020 2020  ta = {.         
-00006f50: 2020 2022 7369 7a65 223a 205b 5d2c 0a20     "size": [],. 
-00006f60: 2020 2020 2020 2020 2020 2022 6261 6e64             "band
-00006f70: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
-00006f80: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-00006f90: 6c66 2e6e 6574 776f 726b 5f64 6174 6120  lf.network_data 
-00006fa0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00006fb0: 2273 697a 6522 3a20 5b5d 2c0a 2020 2020  "size": [],.    
-00006fc0: 2020 2020 2020 2020 2262 616e 6477 6964          "bandwid
-00006fd0: 7468 223a 205b 5d2c 0a20 2020 2020 2020  th": [],.       
-00006fe0: 207d 0a0a 2020 2020 2020 2020 6173 796e   }..        asyn
-00006ff0: 6320 6465 6620 6628 293a 0a20 2020 2020  c def f():.     
-00007000: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00007010: 6177 6169 7420 7365 6c66 2e73 6368 6564  await self.sched
-00007020: 756c 6572 2e62 656e 6368 6d61 726b 5f68  uler.benchmark_h
-00007030: 6172 6477 6172 6528 290a 0a20 2020 2020  ardware()..     
-00007040: 2020 2020 2020 2066 6f72 2073 697a 6520         for size 
-00007050: 696e 2073 6f72 7465 6428 7265 7375 6c74  in sorted(result
-00007060: 5b22 6469 736b 225d 2c20 6b65 793d 7061  ["disk"], key=pa
-00007070: 7273 655f 6279 7465 7329 3a0a 2020 2020  rse_bytes):.    
-00007080: 2020 2020 2020 2020 2020 2020 6261 6e64              band
-00007090: 7769 6474 6820 3d20 7265 7375 6c74 5b22  width = result["
-000070a0: 6469 736b 225d 5b73 697a 655d 0a20 2020  disk"][size].   
-000070b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000070c0: 662e 6469 736b 5f64 6174 615b 2273 697a  f.disk_data["siz
-000070d0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
-000070e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000070f0: 2073 656c 662e 6469 736b 5f64 6174 615b   self.disk_data[
-00007100: 2262 616e 6477 6964 7468 225d 2e61 7070  "bandwidth"].app
-00007110: 656e 6428 6261 6e64 7769 6474 6829 0a0a  end(bandwidth)..
-00007120: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00007130: 7369 7a65 2069 6e20 736f 7274 6564 2872  size in sorted(r
-00007140: 6573 756c 745b 226d 656d 6f72 7922 5d2c  esult["memory"],
-00007150: 206b 6579 3d70 6172 7365 5f62 7974 6573   key=parse_bytes
-00007160: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007170: 2020 2062 616e 6477 6964 7468 203d 2072     bandwidth = r
-00007180: 6573 756c 745b 226d 656d 6f72 7922 5d5b  esult["memory"][
-00007190: 7369 7a65 5d0a 2020 2020 2020 2020 2020  size].          
-000071a0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-000071b0: 795f 6461 7461 5b22 7369 7a65 225d 2e61  y_data["size"].a
-000071c0: 7070 656e 6428 7369 7a65 290a 2020 2020  ppend(size).    
-000071d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000071e0: 2e6d 656d 6f72 795f 6461 7461 5b22 6261  .memory_data["ba
-000071f0: 6e64 7769 6474 6822 5d2e 6170 7065 6e64  ndwidth"].append
-00007200: 2862 616e 6477 6964 7468 290a 0a20 2020  (bandwidth)..   
-00007210: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
-00007220: 6520 696e 2073 6f72 7465 6428 7265 7375  e in sorted(resu
-00007230: 6c74 5b22 6e65 7477 6f72 6b22 5d2c 206b  lt["network"], k
-00007240: 6579 3d70 6172 7365 5f62 7974 6573 293a  ey=parse_bytes):
-00007250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007260: 2062 616e 6477 6964 7468 203d 2072 6573   bandwidth = res
-00007270: 756c 745b 226e 6574 776f 726b 225d 5b73  ult["network"][s
-00007280: 697a 655d 0a20 2020 2020 2020 2020 2020  ize].           
-00007290: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
-000072a0: 6b5f 6461 7461 5b22 7369 7a65 225d 2e61  k_data["size"].a
-000072b0: 7070 656e 6428 7369 7a65 290a 2020 2020  ppend(size).    
-000072c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000072d0: 2e6e 6574 776f 726b 5f64 6174 615b 2262  .network_data["b
-000072e0: 616e 6477 6964 7468 225d 2e61 7070 656e  andwidth"].appen
-000072f0: 6428 6261 6e64 7769 6474 6829 0a0a 2020  d(bandwidth)..  
-00007300: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-00007310: 756c 6572 2e6c 6f6f 702e 6164 645f 6361  uler.loop.add_ca
-00007320: 6c6c 6261 636b 2866 290a 0a20 2020 2064  llback(f)..    d
-00007330: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
-00007340: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
-00007350: 2020 2020 2020 2020 2020 6e6f 7420 7365            not se
-00007360: 6c66 2e64 6973 6b5f 6461 7461 5b22 7369  lf.disk_data["si
-00007370: 7a65 225d 0a20 2020 2020 2020 2020 2020  ze"].           
-00007380: 206f 7220 7365 6c66 2e64 6973 6b5f 6669   or self.disk_fi
-00007390: 6775 7265 2e74 6974 6c65 2e74 6578 7420  gure.title.text 
-000073a0: 3d3d 2022 4469 736b 2042 616e 6477 6964  == "Disk Bandwid
-000073b0: 7468 220a 2020 2020 2020 2020 293a 0a20  th".        ):. 
-000073c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000073d0: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
-000073e0: 6e65 7477 6f72 6b5f 6669 6775 7265 2e78  network_figure.x
-000073f0: 5f72 616e 6765 2e66 6163 746f 7273 203d  _range.factors =
-00007400: 2073 656c 662e 6e65 7477 6f72 6b5f 6461   self.network_da
-00007410: 7461 5b22 7369 7a65 225d 0a20 2020 2020  ta["size"].     
-00007420: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
-00007430: 7572 652e 785f 7261 6e67 652e 6661 6374  ure.x_range.fact
-00007440: 6f72 7320 3d20 7365 6c66 2e64 6973 6b5f  ors = self.disk_
-00007450: 6461 7461 5b22 7369 7a65 225d 0a20 2020  data["size"].   
-00007460: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
-00007470: 5f66 6967 7572 652e 785f 7261 6e67 652e  _figure.x_range.
-00007480: 6661 6374 6f72 7320 3d20 7365 6c66 2e6d  factors = self.m
-00007490: 656d 6f72 795f 6461 7461 5b22 7369 7a65  emory_data["size
-000074a0: 225d 0a20 2020 2020 2020 2075 7064 6174  "].        updat
-000074b0: 6528 7365 6c66 2e64 6973 6b5f 736f 7572  e(self.disk_sour
-000074c0: 6365 2c20 7365 6c66 2e64 6973 6b5f 6461  ce, self.disk_da
-000074d0: 7461 290a 2020 2020 2020 2020 7570 6461  ta).        upda
-000074e0: 7465 2873 656c 662e 6d65 6d6f 7279 5f73  te(self.memory_s
-000074f0: 6f75 7263 652c 2073 656c 662e 6d65 6d6f  ource, self.memo
-00007500: 7279 5f64 6174 6129 0a20 2020 2020 2020  ry_data).       
-00007510: 2075 7064 6174 6528 7365 6c66 2e6e 6574   update(self.net
-00007520: 776f 726b 5f73 6f75 7263 652c 2073 656c  work_source, sel
-00007530: 662e 6e65 7477 6f72 6b5f 6461 7461 290a  f.network_data).
-00007540: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-00007550: 6f72 795f 6669 6775 7265 2e74 6974 6c65  ory_figure.title
-00007560: 2e74 6578 7420 3d20 224d 656d 6f72 7920  .text = "Memory 
-00007570: 4261 6e64 7769 6474 6822 0a20 2020 2020  Bandwidth".     
-00007580: 2020 2073 656c 662e 6469 736b 5f66 6967     self.disk_fig
-00007590: 7572 652e 7469 746c 652e 7465 7874 203d  ure.title.text =
-000075a0: 2022 4469 736b 2042 616e 6477 6964 7468   "Disk Bandwidth
-000075b0: 220a 2020 2020 2020 2020 7365 6c66 2e6e  ".        self.n
-000075c0: 6574 776f 726b 5f66 6967 7572 652e 7469  etwork_figure.ti
-000075d0: 746c 652e 7465 7874 203d 2022 4e65 7477  tle.text = "Netw
-000075e0: 6f72 6b20 4261 6e64 7769 6474 6822 0a0a  ork Bandwidth"..
-000075f0: 0a63 6c61 7373 2042 616e 6477 6964 7468  .class Bandwidth
-00007600: 5479 7065 7328 4461 7368 626f 6172 6443  Types(DashboardC
-00007610: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00007620: 2222 4261 7220 6368 6172 7420 7368 6f77  ""Bar chart show
-00007630: 696e 6720 6261 6e64 7769 6474 6820 7065  ing bandwidth pe
-00007640: 7220 7479 7065 2222 220a 0a20 2020 2040  r type"""..    @
-00007650: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-00007660: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00007670: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-00007680: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00007690: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
-000076a0: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-000076b0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
-000076c0: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-000076d0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-000076e0: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
-000076f0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00007700: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
-00007710: 6822 3a20 5b31 2c20 325d 2c0a 2020 2020  h": [1, 2],.    
+00004770: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00004780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004790: 2020 2020 2020 2020 2222 222c 0a20 2020          """,.   
+000047a0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+000047b0: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
+000047c0: 6c73 2868 6f76 6572 290a 0a20 2020 2040  ls(hover)..    @
+000047d0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
+000047e0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
+000047f0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00004800: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
+00004810: 3a0a 2020 2020 2020 2020 6465 6620 7175  :.        def qu
+00004820: 6164 6c69 7374 2869 3a20 4974 6572 6162  adlist(i: Iterab
+00004830: 6c65 5b54 5d29 202d 3e20 6c69 7374 5b54  le[T]) -> list[T
+00004840: 5d3a 0a20 2020 2020 2020 2020 2020 206f  ]:.            o
+00004850: 7574 203d 205b 5d0a 2020 2020 2020 2020  ut = [].        
+00004860: 2020 2020 666f 7220 6969 2069 6e20 693a      for ii in i:
+00004870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004880: 206f 7574 202b 3d20 5b69 692c 2069 692c   out += [ii, ii,
+00004890: 2069 692c 2069 695d 0a20 2020 2020 2020   ii, ii].       
+000048a0: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
+000048b0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+000048c0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+000048d0: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+000048e0: 2829 0a0a 2020 2020 2020 2020 7769 6474  ()..        widt
+000048f0: 6820 3d20 5b5d 0a20 2020 2020 2020 2078  h = [].        x
+00004900: 203d 205b 5d0a 2020 2020 2020 2020 636f   = [].        co
+00004910: 6c6f 7220 3d20 5b5d 0a20 2020 2020 2020  lor = [].       
+00004920: 206d 6178 5f6c 696d 6974 203d 2030 0a20   max_limit = 0. 
+00004930: 2020 2020 2020 2070 726f 636d 656d 6f72         procmemor
+00004940: 7920 3d20 5b5d 0a20 2020 2020 2020 206d  y = [].        m
+00004950: 616e 6167 6564 203d 205b 5d0a 2020 2020  anaged = [].    
+00004960: 2020 2020 7370 696c 6c65 6420 3d20 5b5d      spilled = []
+00004970: 0a20 2020 2020 2020 2075 6e6d 616e 6167  .        unmanag
+00004980: 6564 5f6f 6c64 203d 205b 5d0a 2020 2020  ed_old = [].    
+00004990: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
+000049a0: 6365 6e74 203d 205b 5d0a 0a20 2020 2020  cent = []..     
+000049b0: 2020 2066 6f72 2077 7320 696e 2077 6f72     for ws in wor
+000049c0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+000049d0: 2020 6d65 6d69 6e66 6f20 3d20 7773 2e6d    meminfo = ws.m
+000049e0: 656d 6f72 790a 2020 2020 2020 2020 2020  emory.          
+000049f0: 2020 6c69 6d69 7420 3d20 6765 7461 7474    limit = getatt
+00004a00: 7228 7773 2c20 226d 656d 6f72 795f 6c69  r(ws, "memory_li
+00004a10: 6d69 7422 2c20 3029 0a20 2020 2020 2020  mit", 0).       
+00004a20: 2020 2020 206d 6178 5f6c 696d 6974 203d       max_limit =
+00004a30: 206d 6178 286d 6178 5f6c 696d 6974 2c20   max(max_limit, 
+00004a40: 6c69 6d69 742c 206d 656d 696e 666f 2e70  limit, meminfo.p
+00004a50: 726f 6365 7373 202b 206d 656d 696e 666f  rocess + meminfo
+00004a60: 2e73 7069 6c6c 6564 290a 2020 2020 2020  .spilled).      
+00004a70: 2020 2020 2020 636f 6c6f 725f 6920 3d20        color_i = 
+00004a80: 7365 6c66 2e5f 6d65 6d6f 7279 5f63 6f6c  self._memory_col
+00004a90: 6f72 286d 656d 696e 666f 2e70 726f 6365  or(meminfo.proce
+00004aa0: 7373 2c20 6c69 6d69 742c 2077 732e 7374  ss, limit, ws.st
+00004ab0: 6174 7573 290a 0a20 2020 2020 2020 2020  atus)..         
+00004ac0: 2020 2077 6964 7468 202b 3d20 5b0a 2020     width += [.  
+00004ad0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00004ae0: 6d69 6e66 6f2e 6d61 6e61 6765 642c 0a20  minfo.managed,. 
+00004af0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00004b00: 656d 696e 666f 2e75 6e6d 616e 6167 6564  eminfo.unmanaged
+00004b10: 5f6f 6c64 2c0a 2020 2020 2020 2020 2020  _old,.          
+00004b20: 2020 2020 2020 6d65 6d69 6e66 6f2e 756e        meminfo.un
+00004b30: 6d61 6e61 6765 645f 7265 6365 6e74 2c0a  managed_recent,.
+00004b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b50: 6d65 6d69 6e66 6f2e 7370 696c 6c65 642c  meminfo.spilled,
+00004b60: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+00004b70: 2020 2020 2020 2020 2020 2078 202b 3d20             x += 
+00004b80: 5b73 756d 2877 6964 7468 5b2d 343a 695d  [sum(width[-4:i]
+00004b90: 2920 2b20 7769 6474 685b 695d 202f 2032  ) + width[i] / 2
+00004ba0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00004bb0: 2d34 2c20 3029 5d0a 2020 2020 2020 2020  -4, 0)].        
+00004bc0: 2020 2020 636f 6c6f 7220 2b3d 205b 636f      color += [co
+00004bd0: 6c6f 725f 692c 2063 6f6c 6f72 5f69 2c20  lor_i, color_i, 
+00004be0: 636f 6c6f 725f 692c 2022 6772 6579 225d  color_i, "grey"]
+00004bf0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00004c00: 6d65 6d6f 7279 2069 6e66 6f0a 2020 2020  memory info.    
+00004c10: 2020 2020 2020 2020 7072 6f63 6d65 6d6f          procmemo
+00004c20: 7279 2e61 7070 656e 6428 6d65 6d69 6e66  ry.append(meminf
+00004c30: 6f2e 7072 6f63 6573 7329 0a20 2020 2020  o.process).     
+00004c40: 2020 2020 2020 206d 616e 6167 6564 2e61         managed.a
+00004c50: 7070 656e 6428 6d65 6d69 6e66 6f2e 6d61  ppend(meminfo.ma
+00004c60: 6e61 6765 6429 0a20 2020 2020 2020 2020  naged).         
+00004c70: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
+00004c80: 2e61 7070 656e 6428 6d65 6d69 6e66 6f2e  .append(meminfo.
+00004c90: 756e 6d61 6e61 6765 645f 6f6c 6429 0a20  unmanaged_old). 
+00004ca0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
+00004cb0: 6167 6564 5f72 6563 656e 742e 6170 7065  aged_recent.appe
+00004cc0: 6e64 286d 656d 696e 666f 2e75 6e6d 616e  nd(meminfo.unman
+00004cd0: 6167 6564 5f72 6563 656e 7429 0a20 2020  aged_recent).   
+00004ce0: 2020 2020 2020 2020 2073 7069 6c6c 6564           spilled
+00004cf0: 2e61 7070 656e 6428 6d65 6d69 6e66 6f2e  .append(meminfo.
+00004d00: 7370 696c 6c65 6429 0a0a 2020 2020 2020  spilled)..      
+00004d10: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
+00004d20: 2020 2020 2020 2020 2022 7769 6474 6822           "width"
+00004d30: 3a20 7769 6474 682c 0a20 2020 2020 2020  : width,.       
+00004d40: 2020 2020 2022 7822 3a20 782c 0a20 2020       "x": x,.   
+00004d50: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
+00004d60: 3a20 636f 6c6f 722c 0a20 2020 2020 2020  : color,.       
+00004d70: 2020 2020 2022 616c 7068 6122 3a20 5b31       "alpha": [1
+00004d80: 2c20 302e 372c 2030 2e34 2c20 315d 202a  , 0.7, 0.4, 1] *
+00004d90: 206c 656e 2877 6f72 6b65 7273 292c 0a20   len(workers),. 
+00004da0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+00004db0: 6572 223a 2071 7561 646c 6973 7428 7773  er": quadlist(ws
+00004dc0: 2e61 6464 7265 7373 2066 6f72 2077 7320  .address for ws 
+00004dd0: 696e 2077 6f72 6b65 7273 292c 0a20 2020  in workers),.   
+00004de0: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
+00004df0: 645f 776f 726b 6572 223a 2071 7561 646c  d_worker": quadl
+00004e00: 6973 7428 6573 6361 7065 2e75 726c 5f65  ist(escape.url_e
+00004e10: 7363 6170 6528 7773 2e61 6464 7265 7373  scape(ws.address
+00004e20: 2920 666f 7220 7773 2069 6e20 776f 726b  ) for ws in work
+00004e30: 6572 7329 2c0a 2020 2020 2020 2020 2020  ers),.          
+00004e40: 2020 2279 223a 2071 7561 646c 6973 7428    "y": quadlist(
+00004e50: 7261 6e67 6528 6c65 6e28 776f 726b 6572  range(len(worker
+00004e60: 7329 2929 2c0a 2020 2020 2020 2020 2020  s))),.          
+00004e70: 2020 2270 726f 635f 6d65 6d6f 7279 223a    "proc_memory":
+00004e80: 2071 7561 646c 6973 7428 7072 6f63 6d65   quadlist(procme
+00004e90: 6d6f 7279 292c 0a20 2020 2020 2020 2020  mory),.         
+00004ea0: 2020 2022 6d61 6e61 6765 6422 3a20 7175     "managed": qu
+00004eb0: 6164 6c69 7374 286d 616e 6167 6564 292c  adlist(managed),
+00004ec0: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
+00004ed0: 6d61 6e61 6765 645f 6f6c 6422 3a20 7175  managed_old": qu
+00004ee0: 6164 6c69 7374 2875 6e6d 616e 6167 6564  adlist(unmanaged
+00004ef0: 5f6f 6c64 292c 0a20 2020 2020 2020 2020  _old),.         
+00004f00: 2020 2022 756e 6d61 6e61 6765 645f 7265     "unmanaged_re
+00004f10: 6365 6e74 223a 2071 7561 646c 6973 7428  cent": quadlist(
+00004f20: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+00004f30: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+00004f40: 7370 696c 6c65 6422 3a20 7175 6164 6c69  spilled": quadli
+00004f50: 7374 2873 7069 6c6c 6564 292c 0a20 2020  st(spilled),.   
+00004f60: 2020 2020 207d 0a20 2020 2020 2020 2023       }.        #
+00004f70: 2052 656d 6f76 6520 7265 6374 616e 676c   Remove rectangl
+00004f80: 6573 2077 6974 6820 7769 6474 683d 300a  es with width=0.
+00004f90: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00004fa0: 207b 6b3a 205b 7669 2066 6f72 2076 692c   {k: [vi for vi,
+00004fb0: 2077 2069 6e20 7a69 7028 762c 2077 6964   w in zip(v, wid
+00004fc0: 7468 2920 6966 2077 5d20 666f 7220 6b2c  th) if w] for k,
+00004fd0: 2076 2069 6e20 7265 7375 6c74 2e69 7465   v in result.ite
+00004fe0: 6d73 2829 7d0a 0a20 2020 2020 2020 2073  ms()}..        s
+00004ff0: 656c 662e 726f 6f74 2e78 5f72 616e 6765  elf.root.x_range
+00005000: 2e65 6e64 203d 206d 6178 5f6c 696d 6974  .end = max_limit
+00005010: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+00005020: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
+00005030: 756c 7429 0a0a 0a63 6c61 7373 2057 6f72  ult)...class Wor
+00005040: 6b65 7273 4d65 6d6f 7279 4869 7374 6f67  kersMemoryHistog
+00005050: 7261 6d28 4461 7368 626f 6172 6443 6f6d  ram(DashboardCom
+00005060: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
+00005070: 4869 7374 6f67 7261 6d20 6f66 206d 656d  Histogram of mem
+00005080: 6f72 7920 7573 6167 652c 2073 686f 7769  ory usage, showi
+00005090: 6e67 2068 6f77 206d 616e 7920 776f 726b  ng how many work
+000050a0: 6572 7320 7468 6572 6520 6172 6520 696e  ers there are in
+000050b0: 2065 6163 6820 6275 636b 6574 206f 660a   each bucket of.
+000050c0: 2020 2020 7573 6167 652e 2052 6570 6c61      usage. Repla
+000050d0: 6365 7320 7468 6520 7065 722d 776f 726b  ces the per-work
+000050e0: 6572 2067 7261 7068 2077 6865 6e20 7468  er graph when th
+000050f0: 6572 6520 6172 6520 3e3d 2035 3020 776f  ere are >= 50 wo
+00005100: 726b 6572 732e 0a20 2020 2022 2222 0a0a  rkers..    """..
+00005110: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00005120: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00005130: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+00005140: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00005150: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
+00005160: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00005170: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+00005180: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
+00005190: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
+000051a0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
+000051b0: 2020 2020 2020 2020 2020 7b22 6c65 6674            {"left
+000051c0: 223a 205b 312c 2032 5d2c 2022 7269 6768  ": [1, 2], "righ
+000051d0: 7422 3a20 5b31 302c 2031 305d 2c20 2274  t": [10, 10], "t
+000051e0: 6f70 223a 205b 302c 2030 5d7d 0a20 2020  op": [0, 0]}.   
+000051f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00005200: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
+00005210: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00005220: 7469 746c 653d 2242 7974 6573 2073 746f  title="Bytes sto
+00005230: 7265 6420 7065 7220 776f 726b 6572 222c  red per worker",
+00005240: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00005250: 653d 2277 6f72 6b65 7273 5f6d 656d 6f72  e="workers_memor
+00005260: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00005270: 795f 6178 6973 5f6c 6162 656c 3d22 6672  y_axis_label="fr
+00005280: 6571 7565 6e63 7922 2c0a 2020 2020 2020  equency",.      
+00005290: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+000052a0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+000052b0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+000052c0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000052d0: 6f74 2e78 6178 6973 5b30 5d2e 666f 726d  ot.xaxis[0].form
+000052e0: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
+000052f0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
+00005300: 6d61 743d 2230 2e30 2062 2229 0a20 2020  mat="0.0 b").   
+00005310: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
+00005320: 6178 6973 2e74 6963 6b65 7220 3d20 4164  axis.ticker = Ad
+00005330: 6170 7469 7665 5469 636b 6572 282a 2a54  aptiveTicker(**T
+00005340: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
+00005350: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00005360: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
+00005370: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
+00005380: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
+00005390: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000053a0: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
+000053b0: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
+000053c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000053d0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
+000053e0: 6c65 203d 2046 616c 7365 0a0a 2020 2020  le = False..    
+000053f0: 2020 2020 7365 6c66 2e72 6f6f 742e 746f      self.root.to
+00005400: 6f6c 6261 725f 6c6f 6361 7469 6f6e 203d  olbar_location =
+00005410: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
+00005420: 656c 662e 726f 6f74 2e71 7561 6428 0a20  elf.root.quad(. 
+00005430: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+00005440: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+00005450: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+00005460: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
+00005470: 2020 2020 7269 6768 743d 2272 6967 6874      right="right
+00005480: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
+00005490: 6f74 746f 6d3d 302c 0a20 2020 2020 2020  ottom=0,.       
+000054a0: 2020 2020 2074 6f70 3d22 746f 7022 2c0a       top="top",.
+000054b0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+000054c0: 723d 2264 6565 7073 6b79 626c 7565 222c  r="deepskyblue",
+000054d0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+000054e0: 6c5f 616c 7068 613d 302e 352c 0a20 2020  l_alpha=0.5,.   
+000054f0: 2020 2020 2029 0a0a 2020 2020 4077 6974       )..    @wit
+00005500: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00005510: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
+00005520: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+00005530: 2020 2020 2020 206e 6279 7465 7320 3d20         nbytes = 
+00005540: 6e70 2e61 7361 7272 6179 280a 2020 2020  np.asarray(.    
+00005550: 2020 2020 2020 2020 5b77 732e 6d65 7472          [ws.metr
+00005560: 6963 735b 226d 656d 6f72 7922 5d20 666f  ics["memory"] fo
+00005570: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
+00005580: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
+00005590: 616c 7565 7328 295d 0a20 2020 2020 2020  alues()].       
+000055a0: 2029 0a20 2020 2020 2020 2063 6f75 6e74   ).        count
+000055b0: 732c 2078 203d 206e 702e 6869 7374 6f67  s, x = np.histog
+000055c0: 7261 6d28 6e62 7974 6573 2c20 6269 6e73  ram(nbytes, bins
+000055d0: 3d34 3029 0a20 2020 2020 2020 2064 203d  =40).        d =
+000055e0: 207b 226c 6566 7422 3a20 785b 3a2d 315d   {"left": x[:-1]
+000055f0: 2c20 2272 6967 6874 223a 2078 5b31 3a5d  , "right": x[1:]
+00005600: 2c20 2274 6f70 223a 2063 6f75 6e74 737d  , "top": counts}
+00005610: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+00005620: 7365 6c66 2e73 6f75 7263 652c 2064 290a  self.source, d).
+00005630: 0a0a 636c 6173 7320 576f 726b 6572 7354  ..class WorkersT
+00005640: 7261 6e73 6665 7242 7974 6573 2844 6173  ransferBytes(Das
+00005650: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+00005660: 3a0a 2020 2020 2222 2253 697a 6520 6f66  :.    """Size of
+00005670: 206f 7065 6e20 6461 7461 2074 7261 6e73   open data trans
+00005680: 6665 7273 2066 726f 6d2f 746f 206f 7468  fers from/to oth
+00005690: 6572 2077 6f72 6b65 7273 2070 6572 2077  er workers per w
+000056a0: 6f72 6b65 7222 2222 0a0a 2020 2020 406c  orker"""..    @l
+000056b0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+000056c0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000056d0: 2073 6368 6564 756c 6572 2c20 7769 6474   scheduler, widt
+000056e0: 683d 3630 302c 202a 2a6b 7761 7267 7329  h=600, **kwargs)
+000056f0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+00005700: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+00005710: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
+00005720: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
+00005730: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+00005740: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00005750: 2020 2020 2020 2020 2020 2022 6573 6361             "esca
+00005760: 7065 645f 776f 726b 6572 223a 205b 5d2c  ped_worker": [],
+00005770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005780: 2022 7472 616e 7366 6572 5f69 6e63 6f6d   "transfer_incom
+00005790: 696e 675f 6279 7465 7322 3a20 5b5d 2c0a  ing_bytes": [],.
+000057a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057b0: 2274 7261 6e73 6665 725f 6f75 7467 6f69  "transfer_outgoi
+000057c0: 6e67 5f62 7974 6573 223a 205b 5d2c 0a20  ng_bytes": [],. 
+000057d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000057e0: 776f 726b 6572 223a 205b 5d2c 0a20 2020  worker": [],.   
+000057f0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
+00005800: 696e 636f 6d69 6e67 223a 205b 5d2c 0a20  incoming": [],. 
+00005810: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00005820: 795f 6f75 7467 6f69 6e67 223a 205b 5d2c  y_outgoing": [],
+00005830: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00005840: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00005850: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00005860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+00005870: 2020 7469 746c 653d 6622 4279 7465 7320    title=f"Bytes 
+00005880: 7472 616e 7366 6572 7269 6e67 3a20 7b66  transferring: {f
+00005890: 6f72 6d61 745f 6279 7465 7328 3029 7d22  ormat_bytes(0)}"
+000058a0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+000058b0: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
+000058c0: 2020 2020 7769 6474 683d 696e 7428 7769      width=int(wi
+000058d0: 6474 6820 2f20 3229 2c0a 2020 2020 2020  dth / 2),.      
+000058e0: 2020 2020 2020 6e61 6d65 3d22 776f 726b        name="work
+000058f0: 6572 735f 7472 616e 7366 6572 5f62 7974  ers_transfer_byt
+00005900: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+00005910: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
+00005920: 6f6d 3d35 302c 0a20 2020 2020 2020 2020  om=50,.         
+00005930: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00005940: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00005950: 2320 7472 616e 7366 6572 5f69 6e63 6f6d  # transfer_incom
+00005960: 696e 675f 6279 7465 730a 2020 2020 2020  ing_bytes.      
+00005970: 2020 7365 6c66 2e72 6f6f 742e 6862 6172    self.root.hbar
+00005980: 280a 2020 2020 2020 2020 2020 2020 6e61  (.            na
+00005990: 6d65 3d22 7472 616e 7366 6572 5f69 6e63  me="transfer_inc
+000059a0: 6f6d 696e 675f 6279 7465 7322 2c0a 2020  oming_bytes",.  
+000059b0: 2020 2020 2020 2020 2020 793d 2279 5f69            y="y_i
+000059c0: 6e63 6f6d 696e 6722 2c0a 2020 2020 2020  ncoming",.      
+000059d0: 2020 2020 2020 7269 6768 743d 2274 7261        right="tra
+000059e0: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
+000059f0: 7974 6573 222c 0a20 2020 2020 2020 2020  ytes",.         
+00005a00: 2020 206c 696e 655f 636f 6c6f 723d 4e6f     line_color=No
+00005a10: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00005a20: 6c65 6674 3d30 2c0a 2020 2020 2020 2020  left=0,.        
+00005a30: 2020 2020 6865 6967 6874 3d30 2e35 2c0a      height=0.5,.
+00005a40: 2020 2020 2020 2020 2020 2020 6669 6c6c              fill
+00005a50: 5f63 6f6c 6f72 3d22 7265 6422 2c0a 2020  _color="red",.  
+00005a60: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00005a70: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+00005a80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00005a90: 2023 2074 7261 6e73 6665 725f 6f75 7467   # transfer_outg
+00005aa0: 6f69 6e67 5f62 7974 6573 0a20 2020 2020  oing_bytes.     
+00005ab0: 2020 2073 656c 662e 726f 6f74 2e68 6261     self.root.hba
+00005ac0: 7228 0a20 2020 2020 2020 2020 2020 206e  r(.            n
+00005ad0: 616d 653d 2274 7261 6e73 6665 725f 6f75  ame="transfer_ou
+00005ae0: 7467 6f69 6e67 5f62 7974 6573 222c 0a20  tgoing_bytes",. 
+00005af0: 2020 2020 2020 2020 2020 2079 3d22 795f             y="y_
+00005b00: 6f75 7467 6f69 6e67 222c 0a20 2020 2020  outgoing",.     
+00005b10: 2020 2020 2020 2072 6967 6874 3d22 7472         right="tr
+00005b20: 616e 7366 6572 5f6f 7574 676f 696e 675f  ansfer_outgoing_
+00005b30: 6279 7465 7322 2c0a 2020 2020 2020 2020  bytes",.        
+00005b40: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d4e      line_color=N
+00005b50: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00005b60: 206c 6566 743d 302c 0a20 2020 2020 2020   left=0,.       
+00005b70: 2020 2020 2068 6569 6768 743d 302e 352c       height=0.5,
+00005b80: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00005b90: 6c5f 636f 6c6f 723d 2262 6c75 6522 2c0a  l_color="blue",.
+00005ba0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00005bb0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+00005bc0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00005bd0: 2020 2073 656c 662e 726f 6f74 2e61 7869     self.root.axi
+00005be0: 735b 305d 2e74 6963 6b65 7220 3d20 4261  s[0].ticker = Ba
+00005bf0: 7369 6354 6963 6b65 7228 2a2a 5449 434b  sicTicker(**TICK
+00005c00: 535f 3130 3234 290a 2020 2020 2020 2020  S_1024).        
+00005c10: 7365 6c66 2e72 6f6f 742e 7861 7869 735b  self.root.xaxis[
+00005c20: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
+00005c30: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
+00005c40: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
+00005c50: 6222 290a 2020 2020 2020 2020 7365 6c66  b").        self
+00005c60: 2e72 6f6f 742e 7861 7869 732e 6d61 6a6f  .root.xaxis.majo
+00005c70: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
+00005c80: 696f 6e20 3d20 584c 4142 454c 5f4f 5249  ion = XLABEL_ORI
+00005c90: 454e 5441 5449 4f4e 0a20 2020 2020 2020  ENTATION.       
+00005ca0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+00005cb0: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
+00005cc0: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
+00005cd0: 2020 2073 656c 662e 726f 6f74 2e78 5f72     self.root.x_r
+00005ce0: 616e 6765 203d 2052 616e 6765 3164 2873  ange = Range1d(s
+00005cf0: 7461 7274 3d30 290a 2020 2020 2020 2020  tart=0).        
+00005d00: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
+00005d10: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00005d20: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00005d30: 742e 7967 7269 642e 7669 7369 626c 6520  t.ygrid.visible 
+00005d40: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00005d50: 7365 6c66 2e72 6f6f 742e 746f 6f6c 6261  self.root.toolba
+00005d60: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
+00005d70: 650a 0a20 2020 2020 2020 2074 6170 203d  e..        tap =
+00005d80: 2054 6170 546f 6f6c 2863 616c 6c62 6163   TapTool(callbac
+00005d90: 6b3d 4f70 656e 5552 4c28 7572 6c3d 222e  k=OpenURL(url=".
+00005da0: 2f69 6e66 6f2f 776f 726b 6572 2f40 6573  /info/worker/@es
+00005db0: 6361 7065 645f 776f 726b 6572 2e68 746d  caped_worker.htm
+00005dc0: 6c22 2929 0a20 2020 2020 2020 2068 6f76  l")).        hov
+00005dd0: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
+00005de0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+00005df0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
+00005e00: 2020 2020 2020 2028 2257 6f72 6b65 7222         ("Worker"
+00005e10: 2c20 2240 776f 726b 6572 2229 2c0a 2020  , "@worker"),.  
+00005e20: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+00005e30: 496e 636f 6d69 6e67 222c 2022 4074 7261  Incoming", "@tra
+00005e40: 6e73 6665 725f 696e 636f 6d69 6e67 5f62  nsfer_incoming_b
+00005e50: 7974 6573 7b30 2e30 3020 627d 2229 2c0a  ytes{0.00 b}"),.
+00005e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e70: 2822 4f75 7467 6f69 6e67 222c 2022 4074  ("Outgoing", "@t
+00005e80: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
+00005e90: 5f62 7974 6573 7b30 2e30 3020 627d 2229  _bytes{0.00 b}")
+00005ea0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
+00005eb0: 0a20 2020 2020 2020 2020 2020 2070 6f69  .            poi
+00005ec0: 6e74 5f70 6f6c 6963 793d 2266 6f6c 6c6f  nt_policy="follo
+00005ed0: 775f 6d6f 7573 6522 2c0a 2020 2020 2020  w_mouse",.      
+00005ee0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00005ef0: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
+00005f00: 686f 7665 722c 2074 6170 290a 0a20 2020  hover, tap)..   
+00005f10: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
+00005f20: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
+00005f30: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00005f40: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
+00005f50: 6629 3a0a 2020 2020 2020 2020 7773 7320  f):.        wss 
+00005f60: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00005f70: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00005f80: 290a 0a20 2020 2020 2020 2068 203d 2030  )..        h = 0
+00005f90: 2e31 0a20 2020 2020 2020 2079 5f69 6e63  .1.        y_inc
+00005fa0: 6f6d 696e 6720 3d20 5b69 202b 2030 2e37  oming = [i + 0.7
+00005fb0: 3520 2b20 6920 2a20 6820 666f 7220 6920  5 + i * h for i 
+00005fc0: 696e 2072 616e 6765 286c 656e 2877 7373  in range(len(wss
+00005fd0: 2929 5d0a 2020 2020 2020 2020 795f 6f75  ))].        y_ou
+00005fe0: 7467 6f69 6e67 203d 205b 6920 2b20 302e  tgoing = [i + 0.
+00005ff0: 3235 202b 2069 202a 2068 2066 6f72 2069  25 + i * h for i
+00006000: 2069 6e20 7261 6e67 6528 6c65 6e28 7773   in range(len(ws
+00006010: 7329 295d 0a0a 2020 2020 2020 2020 7472  s))]..        tr
+00006020: 616e 7366 6572 5f69 6e63 6f6d 696e 675f  ansfer_incoming_
+00006030: 6279 7465 7320 3d20 5b0a 2020 2020 2020  bytes = [.      
+00006040: 2020 2020 2020 7773 2e6d 6574 7269 6373        ws.metrics
+00006050: 5b22 7472 616e 7366 6572 225d 5b22 696e  ["transfer"]["in
+00006060: 636f 6d69 6e67 5f62 7974 6573 225d 2066  coming_bytes"] f
+00006070: 6f72 2077 7320 696e 2077 7373 0a20 2020  or ws in wss.   
+00006080: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
+00006090: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
+000060a0: 5f62 7974 6573 203d 205b 0a20 2020 2020  _bytes = [.     
+000060b0: 2020 2020 2020 2077 732e 6d65 7472 6963         ws.metric
+000060c0: 735b 2274 7261 6e73 6665 7222 5d5b 226f  s["transfer"]["o
+000060d0: 7574 676f 696e 675f 6279 7465 7322 5d20  utgoing_bytes"] 
+000060e0: 666f 7220 7773 2069 6e20 7773 730a 2020  for ws in wss.  
+000060f0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00006100: 776f 726b 6572 7320 3d20 5b77 732e 6164  workers = [ws.ad
+00006110: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+00006120: 7773 735d 0a20 2020 2020 2020 2065 7363  wss].        esc
+00006130: 6170 6564 5f77 6f72 6b65 7273 203d 205b  aped_workers = [
+00006140: 6573 6361 7065 2e75 726c 5f65 7363 6170  escape.url_escap
+00006150: 6528 776f 726b 6572 2920 666f 7220 776f  e(worker) for wo
+00006160: 726b 6572 2069 6e20 776f 726b 6572 735d  rker in workers]
+00006170: 0a0a 2020 2020 2020 2020 6966 2077 7373  ..        if wss
+00006180: 3a0a 2020 2020 2020 2020 2020 2020 785f  :.            x_
+00006190: 6c69 6d69 7420 3d20 6d61 7828 0a20 2020  limit = max(.   
+000061a0: 2020 2020 2020 2020 2020 2020 206d 6178               max
+000061b0: 2874 7261 6e73 6665 725f 696e 636f 6d69  (transfer_incomi
+000061c0: 6e67 5f62 7974 6573 292c 0a20 2020 2020  ng_bytes),.     
+000061d0: 2020 2020 2020 2020 2020 206d 6178 2874             max(t
+000061e0: 7261 6e73 6665 725f 6f75 7467 6f69 6e67  ransfer_outgoing
+000061f0: 5f62 7974 6573 292c 0a20 2020 2020 2020  _bytes),.       
+00006200: 2020 2020 2020 2020 206d 6178 2877 732e           max(ws.
+00006210: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
+00006220: 2077 7320 696e 2077 7373 292c 0a20 2020   ws in wss),.   
+00006230: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00006240: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006250: 2020 2020 2078 5f6c 696d 6974 203d 2030       x_limit = 0
+00006260: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00006270: 6f74 2e78 5f72 616e 6765 2e65 6e64 203d  ot.x_range.end =
+00006280: 2078 5f6c 696d 6974 0a0a 2020 2020 2020   x_limit..      
+00006290: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
+000062a0: 2020 2020 2020 2020 2022 6573 6361 7065           "escape
+000062b0: 645f 776f 726b 6572 223a 2065 7363 6170  d_worker": escap
+000062c0: 6564 5f77 6f72 6b65 7273 2c0a 2020 2020  ed_workers,.    
+000062d0: 2020 2020 2020 2020 2274 7261 6e73 6665          "transfe
+000062e0: 725f 696e 636f 6d69 6e67 5f62 7974 6573  r_incoming_bytes
+000062f0: 223a 2074 7261 6e73 6665 725f 696e 636f  ": transfer_inco
+00006300: 6d69 6e67 5f62 7974 6573 2c0a 2020 2020  ming_bytes,.    
+00006310: 2020 2020 2020 2020 2274 7261 6e73 6665          "transfe
+00006320: 725f 6f75 7467 6f69 6e67 5f62 7974 6573  r_outgoing_bytes
+00006330: 223a 2074 7261 6e73 6665 725f 6f75 7467  ": transfer_outg
+00006340: 6f69 6e67 5f62 7974 6573 2c0a 2020 2020  oing_bytes,.    
+00006350: 2020 2020 2020 2020 2277 6f72 6b65 7222          "worker"
+00006360: 3a20 776f 726b 6572 732c 0a20 2020 2020  : workers,.     
+00006370: 2020 2020 2020 2022 795f 696e 636f 6d69         "y_incomi
+00006380: 6e67 223a 2079 5f69 6e63 6f6d 696e 672c  ng": y_incoming,
+00006390: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
+000063a0: 6f75 7467 6f69 6e67 223a 2079 5f6f 7574  outgoing": y_out
+000063b0: 676f 696e 672c 0a20 2020 2020 2020 207d  going,.        }
+000063c0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000063d0: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
+000063e0: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
+000063f0: 4279 7465 7320 7472 616e 7366 6572 7269  Bytes transferri
+00006400: 6e67 3a20 7b66 6f72 6d61 745f 6279 7465  ng: {format_byte
+00006410: 7328 7375 6d28 7472 616e 7366 6572 5f69  s(sum(transfer_i
+00006420: 6e63 6f6d 696e 675f 6279 7465 7329 297d  ncoming_bytes))}
+00006430: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+00006440: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
+00006450: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
+00006460: 0a0a 636c 6173 7320 4861 7264 7761 7265  ..class Hardware
+00006470: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
+00006480: 656e 7429 3a0a 2020 2020 2222 224f 6363  ent):.    """Occ
+00006490: 7570 616e 6379 2028 696e 2074 696d 6529  upancy (in time)
+000064a0: 2070 6572 2077 6f72 6b65 7222 2222 0a0a   per worker"""..
+000064b0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+000064c0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000064d0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+000064e0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+000064f0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00006500: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+00006510: 2020 2020 2020 2020 2320 4469 736b 0a20          # Disk. 
+00006520: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00006530: 5f73 6f75 7263 6520 3d20 436f 6c75 6d6e  _source = Column
+00006540: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
+00006550: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00006560: 2020 2020 2020 2020 2020 2273 697a 6522            "size"
+00006570: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00006580: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+00006590: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+000065a0: 2020 207d 0a20 2020 2020 2020 2029 0a0a     }.        )..
+000065b0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+000065c0: 6b5f 6669 6775 7265 203d 2066 6967 7572  k_figure = figur
+000065d0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
+000065e0: 6974 6c65 3d22 4469 736b 2042 616e 6477  itle="Disk Bandw
+000065f0: 6964 7468 202d 2d20 436f 6d70 7574 696e  idth -- Computin
+00006600: 6720 2e2e 2e22 2c0a 2020 2020 2020 2020  g ...",.        
+00006610: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
+00006620: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
+00006630: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
+00006640: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00006650: 785f 7261 6e67 653d 4661 6374 6f72 5261  x_range=FactorRa
+00006660: 6e67 6528 6661 6374 6f72 733d 5b5d 292c  nge(factors=[]),
+00006670: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+00006680: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+00006690: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+000066a0: 736b 5f66 6967 7572 652e 7662 6172 280a  sk_figure.vbar(.
+000066b0: 2020 2020 2020 2020 2020 2020 783d 2273              x="s
+000066c0: 697a 6522 2c20 746f 703d 2262 616e 6477  ize", top="bandw
+000066d0: 6964 7468 222c 2077 6964 7468 3d30 2e39  idth", width=0.9
+000066e0: 2c20 736f 7572 6365 3d73 656c 662e 6469  , source=self.di
+000066f0: 736b 5f73 6f75 7263 650a 2020 2020 2020  sk_source.      
+00006700: 2020 290a 2020 2020 2020 2020 686f 7665    ).        hove
+00006710: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
+00006720: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+00006730: 2276 6c69 6e65 222c 2074 6f6f 6c74 6970  "vline", tooltip
+00006740: 733d 5b28 2242 616e 6477 6964 7468 222c  s=[("Bandwidth",
+00006750: 2022 4062 616e 6477 6964 7468 7b30 2e30   "@bandwidth{0.0
+00006760: 3020 627d 2f73 2229 5d0a 2020 2020 2020  0 b}/s")].      
+00006770: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00006780: 2e64 6973 6b5f 6669 6775 7265 2e61 6464  .disk_figure.add
+00006790: 5f74 6f6f 6c73 2868 6f76 6572 290a 2020  _tools(hover).  
+000067a0: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
+000067b0: 6669 6775 7265 2e79 6178 6973 5b30 5d2e  figure.yaxis[0].
+000067c0: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
+000067d0: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
+000067e0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
+000067f0: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+00006800: 736b 5f66 6967 7572 652e 7867 7269 642e  sk_figure.xgrid.
+00006810: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00006820: 0a20 2020 2020 2020 2023 204d 656d 6f72  .        # Memor
+00006830: 790a 2020 2020 2020 2020 7365 6c66 2e6d  y.        self.m
+00006840: 656d 6f72 795f 736f 7572 6365 203d 2043  emory_source = C
+00006850: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
+00006860: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00006870: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00006880: 7369 7a65 223a 205b 5d2c 0a20 2020 2020  size": [],.     
+00006890: 2020 2020 2020 2020 2020 2022 6261 6e64             "band
+000068a0: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
+000068b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000068c0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+000068d0: 662e 6d65 6d6f 7279 5f66 6967 7572 6520  f.memory_figure 
+000068e0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+000068f0: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
+00006900: 6f72 7920 4261 6e64 7769 6474 6820 2d2d  ory Bandwidth --
+00006910: 2043 6f6d 7075 7469 6e67 202e 2e2e 222c   Computing ...",
+00006920: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00006930: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
+00006940: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
+00006950: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
+00006960: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+00006970: 3d46 6163 746f 7252 616e 6765 2866 6163  =FactorRange(fac
+00006980: 746f 7273 3d5b 5d29 2c0a 2020 2020 2020  tors=[]),.      
+00006990: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+000069a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000069b0: 2020 2073 656c 662e 6d65 6d6f 7279 5f66     self.memory_f
+000069c0: 6967 7572 652e 7662 6172 280a 2020 2020  igure.vbar(.    
+000069d0: 2020 2020 2020 2020 783d 2273 697a 6522          x="size"
+000069e0: 2c20 746f 703d 2262 616e 6477 6964 7468  , top="bandwidth
+000069f0: 222c 2077 6964 7468 3d30 2e39 2c20 736f  ", width=0.9, so
+00006a00: 7572 6365 3d73 656c 662e 6d65 6d6f 7279  urce=self.memory
+00006a10: 5f73 6f75 7263 650a 2020 2020 2020 2020  _source.        
+00006a20: 290a 2020 2020 2020 2020 686f 7665 7220  ).        hover 
+00006a30: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
+00006a40: 2020 2020 2020 2020 206d 6f64 653d 2276           mode="v
+00006a50: 6c69 6e65 222c 2074 6f6f 6c74 6970 733d  line", tooltips=
+00006a60: 5b28 2242 616e 6477 6964 7468 222c 2022  [("Bandwidth", "
+00006a70: 4062 616e 6477 6964 7468 7b30 2e30 3020  @bandwidth{0.00 
+00006a80: 627d 2f73 2229 5d0a 2020 2020 2020 2020  b}/s")].        
+00006a90: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
+00006aa0: 656d 6f72 795f 6669 6775 7265 2e61 6464  emory_figure.add
+00006ab0: 5f74 6f6f 6c73 2868 6f76 6572 290a 2020  _tools(hover).  
+00006ac0: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
+00006ad0: 795f 6669 6775 7265 2e79 6178 6973 5b30  y_figure.yaxis[0
+00006ae0: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
+00006af0: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
+00006b00: 6572 2866 6f72 6d61 743d 2230 2e30 2062  er(format="0.0 b
+00006b10: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00006b20: 6d65 6d6f 7279 5f66 6967 7572 652e 7867  memory_figure.xg
+00006b30: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+00006b40: 6c73 650a 0a20 2020 2020 2020 2023 204e  lse..        # N
+00006b50: 6574 776f 726b 0a20 2020 2020 2020 2073  etwork.        s
+00006b60: 656c 662e 6e65 7477 6f72 6b5f 736f 7572  elf.network_sour
+00006b70: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+00006b80: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
+00006b90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00006ba0: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
+00006bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006bc0: 2022 6261 6e64 7769 6474 6822 3a20 5b5d   "bandwidth": []
+00006bd0: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00006be0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00006bf0: 2020 2073 656c 662e 6e65 7477 6f72 6b5f     self.network_
+00006c00: 6669 6775 7265 203d 2066 6967 7572 6528  figure = figure(
+00006c10: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00006c20: 6c65 3d22 4e65 7477 6f72 6b20 4261 6e64  le="Network Band
+00006c30: 7769 6474 6820 2d2d 2043 6f6d 7075 7469  width -- Computi
+00006c40: 6e67 202e 2e2e 222c 0a20 2020 2020 2020  ng ...",.       
+00006c50: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+00006c60: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
+00006c70: 6172 5f6c 6f63 6174 696f 6e3d 2261 626f  ar_location="abo
+00006c80: 7665 222c 0a20 2020 2020 2020 2020 2020  ve",.           
+00006c90: 2078 5f72 616e 6765 3d46 6163 746f 7252   x_range=FactorR
+00006ca0: 616e 6765 2866 6163 746f 7273 3d5b 5d29  ange(factors=[])
+00006cb0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00006cc0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00006cd0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00006ce0: 6e65 7477 6f72 6b5f 6669 6775 7265 2e76  network_figure.v
+00006cf0: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
+00006d00: 2078 3d22 7369 7a65 222c 2074 6f70 3d22   x="size", top="
+00006d10: 6261 6e64 7769 6474 6822 2c20 7769 6474  bandwidth", widt
+00006d20: 683d 302e 392c 2073 6f75 7263 653d 7365  h=0.9, source=se
+00006d30: 6c66 2e6e 6574 776f 726b 5f73 6f75 7263  lf.network_sourc
+00006d40: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
+00006d50: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+00006d60: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
+00006d70: 2020 206d 6f64 653d 2276 6c69 6e65 222c     mode="vline",
+00006d80: 2074 6f6f 6c74 6970 733d 5b28 2242 616e   tooltips=[("Ban
+00006d90: 6477 6964 7468 222c 2022 4062 616e 6477  dwidth", "@bandw
+00006da0: 6964 7468 7b30 2e30 3020 627d 2f73 2229  idth{0.00 b}/s")
+00006db0: 5d0a 2020 2020 2020 2020 290a 2020 2020  ].        ).    
+00006dc0: 2020 2020 7365 6c66 2e6e 6574 776f 726b      self.network
+00006dd0: 5f66 6967 7572 652e 6164 645f 746f 6f6c  _figure.add_tool
+00006de0: 7328 686f 7665 7229 0a20 2020 2020 2020  s(hover).       
+00006df0: 2073 656c 662e 6e65 7477 6f72 6b5f 6669   self.network_fi
+00006e00: 6775 7265 2e79 6178 6973 5b30 5d2e 666f  gure.yaxis[0].fo
+00006e10: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+00006e20: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+00006e30: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
+00006e40: 2020 2020 2020 2073 656c 662e 6e65 7477         self.netw
+00006e50: 6f72 6b5f 6669 6775 7265 2e78 6772 6964  ork_figure.xgrid
+00006e60: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+00006e70: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00006e80: 6f6f 7420 3d20 726f 7728 0a20 2020 2020  oot = row(.     
+00006e90: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
+00006ea0: 7279 5f66 6967 7572 652c 0a20 2020 2020  ry_figure,.     
+00006eb0: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00006ec0: 5f66 6967 7572 652c 0a20 2020 2020 2020  _figure,.       
+00006ed0: 2020 2020 2073 656c 662e 6e65 7477 6f72       self.networ
+00006ee0: 6b5f 6669 6775 7265 2c0a 2020 2020 2020  k_figure,.      
+00006ef0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00006f00: 662e 6d65 6d6f 7279 5f64 6174 6120 3d20  f.memory_data = 
+00006f10: 7b0a 2020 2020 2020 2020 2020 2020 2273  {.            "s
+00006f20: 697a 6522 3a20 5b5d 2c0a 2020 2020 2020  ize": [],.      
+00006f30: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+00006f40: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
+00006f50: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+00006f60: 736b 5f64 6174 6120 3d20 7b0a 2020 2020  sk_data = {.    
+00006f70: 2020 2020 2020 2020 2273 697a 6522 3a20          "size": 
+00006f80: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00006f90: 2262 616e 6477 6964 7468 223a 205b 5d2c  "bandwidth": [],
+00006fa0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00006fb0: 2020 2073 656c 662e 6e65 7477 6f72 6b5f     self.network_
+00006fc0: 6461 7461 203d 207b 0a20 2020 2020 2020  data = {.       
+00006fd0: 2020 2020 2022 7369 7a65 223a 205b 5d2c       "size": [],
+00006fe0: 0a20 2020 2020 2020 2020 2020 2022 6261  .            "ba
+00006ff0: 6e64 7769 6474 6822 3a20 5b5d 2c0a 2020  ndwidth": [],.  
+00007000: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00007010: 2061 7379 6e63 2064 6566 2066 2829 3a0a   async def f():.
+00007020: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00007030: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
+00007040: 7363 6865 6475 6c65 722e 6265 6e63 686d  scheduler.benchm
+00007050: 6172 6b5f 6861 7264 7761 7265 2829 0a0a  ark_hardware()..
+00007060: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00007070: 7369 7a65 2069 6e20 736f 7274 6564 2872  size in sorted(r
+00007080: 6573 756c 745b 2264 6973 6b22 5d2c 206b  esult["disk"], k
+00007090: 6579 3d70 6172 7365 5f62 7974 6573 293a  ey=parse_bytes):
+000070a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000070b0: 2062 616e 6477 6964 7468 203d 2072 6573   bandwidth = res
+000070c0: 756c 745b 2264 6973 6b22 5d5b 7369 7a65  ult["disk"][size
+000070d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000070e0: 2020 7365 6c66 2e64 6973 6b5f 6461 7461    self.disk_data
+000070f0: 5b22 7369 7a65 225d 2e61 7070 656e 6428  ["size"].append(
+00007100: 7369 7a65 290a 2020 2020 2020 2020 2020  size).          
+00007110: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
+00007120: 6461 7461 5b22 6261 6e64 7769 6474 6822  data["bandwidth"
+00007130: 5d2e 6170 7065 6e64 2862 616e 6477 6964  ].append(bandwid
+00007140: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
+00007150: 2066 6f72 2073 697a 6520 696e 2073 6f72   for size in sor
+00007160: 7465 6428 7265 7375 6c74 5b22 6d65 6d6f  ted(result["memo
+00007170: 7279 225d 2c20 6b65 793d 7061 7273 655f  ry"], key=parse_
+00007180: 6279 7465 7329 3a0a 2020 2020 2020 2020  bytes):.        
+00007190: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
+000071a0: 6820 3d20 7265 7375 6c74 5b22 6d65 6d6f  h = result["memo
+000071b0: 7279 225d 5b73 697a 655d 0a20 2020 2020  ry"][size].     
+000071c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000071d0: 6d65 6d6f 7279 5f64 6174 615b 2273 697a  memory_data["siz
+000071e0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
+000071f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007200: 2073 656c 662e 6d65 6d6f 7279 5f64 6174   self.memory_dat
+00007210: 615b 2262 616e 6477 6964 7468 225d 2e61  a["bandwidth"].a
+00007220: 7070 656e 6428 6261 6e64 7769 6474 6829  ppend(bandwidth)
+00007230: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00007240: 7220 7369 7a65 2069 6e20 736f 7274 6564  r size in sorted
+00007250: 2872 6573 756c 745b 226e 6574 776f 726b  (result["network
+00007260: 225d 2c20 6b65 793d 7061 7273 655f 6279  "], key=parse_by
+00007270: 7465 7329 3a0a 2020 2020 2020 2020 2020  tes):.          
+00007280: 2020 2020 2020 6261 6e64 7769 6474 6820        bandwidth 
+00007290: 3d20 7265 7375 6c74 5b22 6e65 7477 6f72  = result["networ
+000072a0: 6b22 5d5b 7369 7a65 5d0a 2020 2020 2020  k"][size].      
+000072b0: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+000072c0: 6574 776f 726b 5f64 6174 615b 2273 697a  etwork_data["siz
+000072d0: 6522 5d2e 6170 7065 6e64 2873 697a 6529  e"].append(size)
+000072e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000072f0: 2073 656c 662e 6e65 7477 6f72 6b5f 6461   self.network_da
+00007300: 7461 5b22 6261 6e64 7769 6474 6822 5d2e  ta["bandwidth"].
+00007310: 6170 7065 6e64 2862 616e 6477 6964 7468  append(bandwidth
+00007320: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00007330: 7363 6865 6475 6c65 722e 6c6f 6f70 2e61  scheduler.loop.a
+00007340: 6464 5f63 616c 6c62 6163 6b28 6629 0a0a  dd_callback(f)..
+00007350: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
+00007360: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+00007370: 2028 0a20 2020 2020 2020 2020 2020 206e   (.            n
+00007380: 6f74 2073 656c 662e 6469 736b 5f64 6174  ot self.disk_dat
+00007390: 615b 2273 697a 6522 5d0a 2020 2020 2020  a["size"].      
+000073a0: 2020 2020 2020 6f72 2073 656c 662e 6469        or self.di
+000073b0: 736b 5f66 6967 7572 652e 7469 746c 652e  sk_figure.title.
+000073c0: 7465 7874 203d 3d20 2244 6973 6b20 4261  text == "Disk Ba
+000073d0: 6e64 7769 6474 6822 0a20 2020 2020 2020  ndwidth".       
+000073e0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000073f0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00007400: 7365 6c66 2e6e 6574 776f 726b 5f66 6967  self.network_fig
+00007410: 7572 652e 785f 7261 6e67 652e 6661 6374  ure.x_range.fact
+00007420: 6f72 7320 3d20 7365 6c66 2e6e 6574 776f  ors = self.netwo
+00007430: 726b 5f64 6174 615b 2273 697a 6522 5d0a  rk_data["size"].
+00007440: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+00007450: 6b5f 6669 6775 7265 2e78 5f72 616e 6765  k_figure.x_range
+00007460: 2e66 6163 746f 7273 203d 2073 656c 662e  .factors = self.
+00007470: 6469 736b 5f64 6174 615b 2273 697a 6522  disk_data["size"
+00007480: 5d0a 2020 2020 2020 2020 7365 6c66 2e6d  ].        self.m
+00007490: 656d 6f72 795f 6669 6775 7265 2e78 5f72  emory_figure.x_r
+000074a0: 616e 6765 2e66 6163 746f 7273 203d 2073  ange.factors = s
+000074b0: 656c 662e 6d65 6d6f 7279 5f64 6174 615b  elf.memory_data[
+000074c0: 2273 697a 6522 5d0a 2020 2020 2020 2020  "size"].        
+000074d0: 7570 6461 7465 2873 656c 662e 6469 736b  update(self.disk
+000074e0: 5f73 6f75 7263 652c 2073 656c 662e 6469  _source, self.di
+000074f0: 736b 5f64 6174 6129 0a20 2020 2020 2020  sk_data).       
+00007500: 2075 7064 6174 6528 7365 6c66 2e6d 656d   update(self.mem
+00007510: 6f72 795f 736f 7572 6365 2c20 7365 6c66  ory_source, self
+00007520: 2e6d 656d 6f72 795f 6461 7461 290a 2020  .memory_data).  
+00007530: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
+00007540: 662e 6e65 7477 6f72 6b5f 736f 7572 6365  f.network_source
+00007550: 2c20 7365 6c66 2e6e 6574 776f 726b 5f64  , self.network_d
+00007560: 6174 6129 0a20 2020 2020 2020 2073 656c  ata).        sel
+00007570: 662e 6d65 6d6f 7279 5f66 6967 7572 652e  f.memory_figure.
+00007580: 7469 746c 652e 7465 7874 203d 2022 4d65  title.text = "Me
+00007590: 6d6f 7279 2042 616e 6477 6964 7468 220a  mory Bandwidth".
+000075a0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+000075b0: 6b5f 6669 6775 7265 2e74 6974 6c65 2e74  k_figure.title.t
+000075c0: 6578 7420 3d20 2244 6973 6b20 4261 6e64  ext = "Disk Band
+000075d0: 7769 6474 6822 0a20 2020 2020 2020 2073  width".        s
+000075e0: 656c 662e 6e65 7477 6f72 6b5f 6669 6775  elf.network_figu
+000075f0: 7265 2e74 6974 6c65 2e74 6578 7420 3d20  re.title.text = 
+00007600: 224e 6574 776f 726b 2042 616e 6477 6964  "Network Bandwid
+00007610: 7468 220a 0a0a 636c 6173 7320 4261 6e64  th"...class Band
+00007620: 7769 6474 6854 7970 6573 2844 6173 6862  widthTypes(Dashb
+00007630: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+00007640: 2020 2020 2222 2242 6172 2063 6861 7274      """Bar chart
+00007650: 2073 686f 7769 6e67 2062 616e 6477 6964   showing bandwid
+00007660: 7468 2070 6572 2074 7970 6522 2222 0a0a  th per type"""..
+00007670: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00007680: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00007690: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+000076a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+000076b0: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
+000076c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000076d0: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+000076e0: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
+000076f0: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
+00007700: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
+00007710: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
 00007720: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-00007730: 6477 6964 7468 2d68 616c 6622 3a20 5b30  dwidth-half": [0
-00007740: 2e35 2c20 315d 2c0a 2020 2020 2020 2020  .5, 1],.        
-00007750: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-00007760: 5b22 6122 2c20 2262 225d 2c0a 2020 2020  ["a", "b"],.    
-00007770: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
-00007780: 6477 6964 7468 5f74 6578 7422 3a20 5b22  dwidth_text": ["
-00007790: 3122 2c20 2232 225d 2c0a 2020 2020 2020  1", "2"],.      
-000077a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000077b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000077c0: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
-000077d0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-000077e0: 3d22 4261 6e64 7769 6474 6820 6279 2054  ="Bandwidth by T
-000077f0: 7970 6522 2c0a 2020 2020 2020 2020 2020  ype",.          
-00007800: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-00007810: 2020 2020 2020 2020 6e61 6d65 3d22 6261          name="ba
-00007820: 6e64 7769 6474 685f 7479 7065 5f68 6973  ndwidth_type_his
-00007830: 746f 6772 616d 222c 0a20 2020 2020 2020  togram",.       
-00007840: 2020 2020 2079 5f72 616e 6765 3d5b 2261       y_range=["a
-00007850: 222c 2022 6222 5d2c 0a20 2020 2020 2020  ", "b"],.       
-00007860: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-00007870: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007880: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-00007890: 2e6d 616a 6f72 5f6c 6162 656c 5f6f 7269  .major_label_ori
-000078a0: 656e 7461 7469 6f6e 203d 202d 302e 350a  entation = -0.5.
-000078b0: 2020 2020 2020 2020 7265 6374 203d 2073          rect = s
-000078c0: 656c 662e 726f 6f74 2e72 6563 7428 0a20  elf.root.rect(. 
-000078d0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-000078e0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-000078f0: 2020 2020 2020 2020 2020 2078 3d22 6261             x="ba
-00007900: 6e64 7769 6474 682d 6861 6c66 222c 0a20  ndwidth-half",. 
-00007910: 2020 2020 2020 2020 2020 2079 3d22 7479             y="ty
-00007920: 7065 222c 0a20 2020 2020 2020 2020 2020  pe",.           
-00007930: 2077 6964 7468 3d22 6261 6e64 7769 6474   width="bandwidt
-00007940: 6822 2c0a 2020 2020 2020 2020 2020 2020  h",.            
-00007950: 6865 6967 6874 3d30 2e39 2c0a 2020 2020  height=0.9,.    
-00007960: 2020 2020 2020 2020 636f 6c6f 723d 2262          color="b
-00007970: 6c75 6522 2c0a 2020 2020 2020 2020 290a  lue",.        ).
-00007980: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00007990: 742e 785f 7261 6e67 652e 7374 6172 7420  t.x_range.start 
-000079a0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-000079b0: 2e72 6f6f 742e 7861 7869 735b 305d 2e66  .root.xaxis[0].f
-000079c0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-000079d0: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-000079e0: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-000079f0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00007a00: 742e 7861 7869 732e 7469 636b 6572 203d  t.xaxis.ticker =
-00007a10: 2041 6461 7074 6976 6554 6963 6b65 7228   AdaptiveTicker(
-00007a20: 2a2a 5449 434b 535f 3130 3234 290a 2020  **TICKS_1024).  
-00007a30: 2020 2020 2020 7265 6374 2e6e 6f6e 7365        rect.nonse
-00007a40: 6c65 6374 696f 6e5f 676c 7970 6820 3d20  lection_glyph = 
-00007a50: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
-00007a60: 6c66 2e72 6f6f 742e 7861 7869 732e 6d69  lf.root.xaxis.mi
-00007a70: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-00007a80: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-00007a90: 7365 6c66 2e72 6f6f 742e 7967 7269 642e  self.root.ygrid.
-00007aa0: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
-00007ab0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00007ac0: 6f74 2e74 6f6f 6c62 6172 5f6c 6f63 6174  ot.toolbar_locat
-00007ad0: 696f 6e20 3d20 4e6f 6e65 0a0a 2020 2020  ion = None..    
-00007ae0: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-00007af0: 7254 6f6f 6c28 290a 2020 2020 2020 2020  rTool().        
-00007b00: 686f 7665 722e 746f 6f6c 7469 7073 203d  hover.tooltips =
-00007b10: 2022 4074 7970 653a 2040 6261 6e64 7769   "@type: @bandwi
-00007b20: 6474 685f 7465 7874 202f 2073 220a 2020  dth_text / s".  
-00007b30: 2020 2020 2020 686f 7665 722e 706f 696e        hover.poin
-00007b40: 745f 706f 6c69 6379 203d 2022 666f 6c6c  t_policy = "foll
-00007b50: 6f77 5f6d 6f75 7365 220a 2020 2020 2020  ow_mouse".      
-00007b60: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-00007b70: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-00007b80: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-00007b90: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-00007ba0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-00007bb0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-00007bc0: 6c66 293a 0a20 2020 2020 2020 2062 7720  lf):.        bw 
-00007bd0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00007be0: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
-00007bf0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00007c00: 6f74 2e79 5f72 616e 6765 2e66 6163 746f  ot.y_range.facto
-00007c10: 7273 203d 206c 6973 7428 736f 7274 6564  rs = list(sorted
-00007c20: 2862 7729 290a 2020 2020 2020 2020 7265  (bw)).        re
-00007c30: 7375 6c74 203d 207b 0a20 2020 2020 2020  sult = {.       
-00007c40: 2020 2020 2022 6261 6e64 7769 6474 6822       "bandwidth"
-00007c50: 3a20 6c69 7374 2862 772e 7661 6c75 6573  : list(bw.values
-00007c60: 2829 292c 0a20 2020 2020 2020 2020 2020  ()),.           
-00007c70: 2022 6261 6e64 7769 6474 682d 6861 6c66   "bandwidth-half
-00007c80: 223a 205b 6220 2f20 3220 666f 7220 6220  ": [b / 2 for b 
-00007c90: 696e 2062 772e 7661 6c75 6573 2829 5d2c  in bw.values()],
-00007ca0: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
-00007cb0: 7065 223a 206c 6973 7428 6277 2e6b 6579  pe": list(bw.key
-00007cc0: 7328 2929 2c0a 2020 2020 2020 2020 2020  s()),.          
-00007cd0: 2020 2262 616e 6477 6964 7468 5f74 6578    "bandwidth_tex
-00007ce0: 7422 3a20 5b66 6f72 6d61 745f 6279 7465  t": [format_byte
-00007cf0: 7328 7829 2066 6f72 2078 2069 6e20 6277  s(x) for x in bw
-00007d00: 2e76 616c 7565 7328 295d 2c0a 2020 2020  .values()],.    
-00007d10: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-00007d20: 6c66 2e72 6f6f 742e 7469 746c 652e 7465  lf.root.title.te
-00007d30: 7874 203d 2022 4261 6e64 7769 6474 683a  xt = "Bandwidth:
-00007d40: 2022 202b 2066 6f72 6d61 745f 6279 7465   " + format_byte
-00007d50: 7328 7365 6c66 2e73 6368 6564 756c 6572  s(self.scheduler
-00007d60: 2e62 616e 6477 6964 7468 290a 2020 2020  .bandwidth).    
-00007d70: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-00007d80: 736f 7572 6365 2c20 7265 7375 6c74 290a  source, result).
-00007d90: 0a0a 636c 6173 7320 4261 6e64 7769 6474  ..class Bandwidt
-00007da0: 6857 6f72 6b65 7273 2844 6173 6862 6f61  hWorkers(Dashboa
-00007db0: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-00007dc0: 2020 2222 2248 6f77 206d 616e 7920 7461    """How many ta
-00007dd0: 736b 7320 6172 6520 6f6e 2065 6163 6820  sks are on each 
-00007de0: 776f 726b 6572 2222 220a 0a20 2020 2040  worker"""..    @
-00007df0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-00007e00: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00007e10: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-00007e20: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00007e30: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
-00007e40: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
-00007e50: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
-00007e60: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
-00007e70: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-00007e80: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
-00007e90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00007ea0: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
-00007eb0: 6822 3a20 5b31 2c20 325d 2c0a 2020 2020  h": [1, 2],.    
-00007ec0: 2020 2020 2020 2020 2020 2020 2273 6f75              "sou
-00007ed0: 7263 6522 3a20 5b22 6122 2c20 2262 225d  rce": ["a", "b"]
-00007ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007ef0: 2020 2264 6573 7469 6e61 7469 6f6e 223a    "destination":
-00007f00: 205b 2261 222c 2022 6222 5d2c 0a20 2020   ["a", "b"],.   
-00007f10: 2020 2020 2020 2020 2020 2020 2022 6261               "ba
-00007f20: 6e64 7769 6474 685f 7465 7874 223a 205b  ndwidth_text": [
-00007f30: 2231 222c 2022 3222 5d2c 0a20 2020 2020  "1", "2"],.     
-00007f40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00007f50: 2029 0a0a 2020 2020 2020 2020 7661 6c75   )..        valu
-00007f60: 6573 203d 205b 6865 7828 7829 5b32 3a5d  es = [hex(x)[2:]
-00007f70: 2066 6f72 2078 2069 6e20 7261 6e67 6528   for x in range(
-00007f80: 3634 2c20 3235 3629 5d5b 3a3a 2d31 5d0a  64, 256)][::-1].
-00007f90: 2020 2020 2020 2020 6d61 7070 6572 203d          mapper =
-00007fa0: 206c 696e 6561 725f 636d 6170 280a 2020   linear_cmap(.  
-00007fb0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
-00007fc0: 6e61 6d65 3d22 6261 6e64 7769 6474 6822  name="bandwidth"
-00007fd0: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
-00007fe0: 6c65 7474 653d 5b22 2322 202b 2078 202b  lette=["#" + x +
-00007ff0: 2078 202b 2022 4646 2220 666f 7220 7820   x + "FF" for x 
-00008000: 696e 2076 616c 7565 735d 2c0a 2020 2020  in values],.    
-00008010: 2020 2020 2020 2020 6c6f 773d 302c 0a20          low=0,. 
-00008020: 2020 2020 2020 2020 2020 2068 6967 683d             high=
-00008030: 312c 0a20 2020 2020 2020 2029 0a0a 2020  1,.        )..  
-00008040: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-00008050: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-00008060: 2020 2020 2020 7469 746c 653d 2242 616e        title="Ban
-00008070: 6477 6964 7468 2062 7920 576f 726b 6572  dwidth by Worker
-00008080: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-00008090: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-000080a0: 2020 2020 206e 616d 653d 2262 616e 6477       name="bandw
-000080b0: 6964 7468 5f77 6f72 6b65 725f 6865 6174  idth_worker_heat
-000080c0: 6d61 7022 2c0a 2020 2020 2020 2020 2020  map",.          
-000080d0: 2020 785f 7261 6e67 653d 5b22 6122 2c20    x_range=["a", 
-000080e0: 2262 225d 2c0a 2020 2020 2020 2020 2020  "b"],.          
-000080f0: 2020 795f 7261 6e67 653d 5b22 6122 2c20    y_range=["a", 
-00008100: 2262 225d 2c0a 2020 2020 2020 2020 2020  "b"],.          
-00008110: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-00008120: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00008130: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
-00008140: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
-00008150: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
-00008160: 5249 454e 5441 5449 4f4e 0a20 2020 2020  RIENTATION.     
-00008170: 2020 2073 656c 662e 726f 6f74 2e72 6563     self.root.rec
-00008180: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
-00008190: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-000081a0: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
-000081b0: 3d22 736f 7572 6365 222c 0a20 2020 2020  ="source",.     
-000081c0: 2020 2020 2020 2079 3d22 6465 7374 696e         y="destin
-000081d0: 6174 696f 6e22 2c0a 2020 2020 2020 2020  ation",.        
-000081e0: 2020 2020 636f 6c6f 723d 6d61 7070 6572      color=mapper
-000081f0: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
-00008200: 6967 6874 3d31 2c0a 2020 2020 2020 2020  ight=1,.        
-00008210: 2020 2020 7769 6474 683d 312c 0a20 2020      width=1,.   
-00008220: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00008230: 7365 6c66 2e63 6f6c 6f72 5f6d 6170 203d  self.color_map =
-00008240: 206d 6170 7065 725b 2274 7261 6e73 666f   mapper["transfo
-00008250: 726d 225d 0a20 2020 2020 2020 2063 6f6c  rm"].        col
-00008260: 6f72 5f62 6172 203d 2043 6f6c 6f72 4261  or_bar = ColorBa
-00008270: 7228 0a20 2020 2020 2020 2020 2020 2063  r(.            c
-00008280: 6f6c 6f72 5f6d 6170 7065 723d 7365 6c66  olor_mapper=self
-00008290: 2e63 6f6c 6f72 5f6d 6170 2c0a 2020 2020  .color_map,.    
-000082a0: 2020 2020 2020 2020 6c61 6265 6c5f 7374          label_st
-000082b0: 616e 646f 6666 3d31 322c 0a20 2020 2020  andoff=12,.     
-000082c0: 2020 2020 2020 2062 6f72 6465 725f 6c69         border_li
-000082d0: 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20  ne_color=None,. 
-000082e0: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
-000082f0: 696f 6e3d 2830 2c20 3029 2c0a 2020 2020  ion=(0, 0),.    
-00008300: 2020 2020 290a 2020 2020 2020 2020 636f      ).        co
-00008310: 6c6f 725f 6261 722e 666f 726d 6174 7465  lor_bar.formatte
-00008320: 7220 3d20 4e75 6d65 7261 6c54 6963 6b46  r = NumeralTickF
-00008330: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-00008340: 2230 2e30 2062 2229 0a20 2020 2020 2020  "0.0 b").       
-00008350: 2063 6f6c 6f72 5f62 6172 2e74 6963 6b65   color_bar.ticke
-00008360: 7220 3d20 4164 6170 7469 7665 5469 636b  r = AdaptiveTick
-00008370: 6572 282a 2a54 4943 4b53 5f31 3032 3429  er(**TICKS_1024)
-00008380: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00008390: 6f74 2e61 6464 5f6c 6179 6f75 7428 636f  ot.add_layout(co
-000083a0: 6c6f 725f 6261 722c 2022 7269 6768 7422  lor_bar, "right"
-000083b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000083c0: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
-000083d0: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-000083e0: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-000083f0: 7665 7254 6f6f 6c28 290a 2020 2020 2020  verTool().      
-00008400: 2020 686f 7665 722e 746f 6f6c 7469 7073    hover.tooltips
-00008410: 203d 2022 2222 0a20 2020 2020 2020 2020   = """.         
-00008420: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-00008430: 2020 2020 2020 2020 203c 703e 3c62 3e53           <p><b>S
-00008440: 6f75 7263 653a 3c2f 623e 2040 736f 7572  ource:</b> @sour
-00008450: 6365 203c 2f70 3e0a 2020 2020 2020 2020  ce </p>.        
-00008460: 2020 2020 2020 2020 3c70 3e3c 623e 4465          <p><b>De
-00008470: 7374 696e 6174 696f 6e3a 3c2f 623e 2040  stination:</b> @
-00008480: 6465 7374 696e 6174 696f 6e20 3c2f 703e  destination </p>
-00008490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000084a0: 203c 703e 3c62 3e42 616e 6477 6964 7468   <p><b>Bandwidth
-000084b0: 3a3c 2f62 3e20 4062 616e 6477 6964 7468  :</b> @bandwidth
-000084c0: 5f74 6578 7420 2f20 733c 2f70 3e0a 2020  _text / s</p>.  
-000084d0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-000084e0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-000084f0: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
-00008500: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
-00008510: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
-00008520: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-00008530: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
-00008540: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-00008550: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-00008560: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-00008570: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-00008580: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00008590: 6277 203d 2073 656c 662e 7363 6865 6475  bw = self.schedu
-000085a0: 6c65 722e 6261 6e64 7769 6474 685f 776f  ler.bandwidth_wo
-000085b0: 726b 6572 730a 2020 2020 2020 2020 6966  rkers.        if
-000085c0: 206e 6f74 2062 773a 0a20 2020 2020 2020   not bw:.       
-000085d0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-000085e0: 2020 2020 2064 6566 206e 616d 6528 6164       def name(ad
-000085f0: 6472 6573 7329 3a0a 2020 2020 2020 2020  dress):.        
-00008600: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00008610: 2020 2020 2020 2020 2077 7320 3d20 7365           ws = se
-00008620: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
-00008630: 6b65 7273 5b61 6464 7265 7373 5d0a 2020  kers[address].  
-00008640: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00008650: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
-00008660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00008670: 6e20 6164 6472 6573 730a 2020 2020 2020  n address.      
-00008680: 2020 2020 2020 6966 2077 732e 6e61 6d65        if ws.name
-00008690: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000086a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000086b0: 7475 726e 2073 7472 2877 732e 6e61 6d65  turn str(ws.name
-000086c0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000086d0: 7475 726e 2061 6464 7265 7373 0a0a 2020  turn address..  
-000086e0: 2020 2020 2020 782c 2079 2c20 7661 6c75        x, y, valu
-000086f0: 6520 3d20 7a69 7028 2a28 286e 616d 6528  e = zip(*((name(
-00008700: 6129 2c20 6e61 6d65 2862 292c 2063 2920  a), name(b), c) 
-00008710: 666f 7220 2861 2c20 6229 2c20 6320 696e  for (a, b), c in
-00008720: 2062 772e 6974 656d 7328 2929 290a 0a20   bw.items())).. 
-00008730: 2020 2020 2020 2073 656c 662e 636f 6c6f         self.colo
-00008740: 725f 6d61 702e 6869 6768 203d 206d 6178  r_map.high = max
-00008750: 2876 616c 7565 290a 0a20 2020 2020 2020  (value)..       
-00008760: 2066 6163 746f 7273 203d 206c 6973 7428   factors = list(
-00008770: 736f 7274 6564 2873 6574 2878 202b 2079  sorted(set(x + y
-00008780: 2929 290a 2020 2020 2020 2020 7365 6c66  ))).        self
-00008790: 2e72 6f6f 742e 785f 7261 6e67 652e 6661  .root.x_range.fa
-000087a0: 6374 6f72 7320 3d20 6661 6374 6f72 730a  ctors = factors.
-000087b0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-000087c0: 742e 795f 7261 6e67 652e 6661 6374 6f72  t.y_range.factor
-000087d0: 7320 3d20 6661 6374 6f72 735b 3a3a 2d31  s = factors[::-1
-000087e0: 5d0a 0a20 2020 2020 2020 2072 6573 756c  ]..        resul
-000087f0: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
-00008800: 2020 2273 6f75 7263 6522 3a20 782c 0a20    "source": x,. 
-00008810: 2020 2020 2020 2020 2020 2022 6465 7374             "dest
-00008820: 696e 6174 696f 6e22 3a20 792c 0a20 2020  ination": y,.   
-00008830: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
-00008840: 6474 6822 3a20 7661 6c75 652c 0a20 2020  dth": value,.   
-00008850: 2020 2020 2020 2020 2022 6261 6e64 7769           "bandwi
-00008860: 6474 685f 7465 7874 223a 206c 6973 7428  dth_text": list(
-00008870: 6d61 7028 666f 726d 6174 5f62 7974 6573  map(format_bytes
-00008880: 2c20 7661 6c75 6529 292c 0a20 2020 2020  , value)),.     
-00008890: 2020 207d 0a20 2020 2020 2020 2073 656c     }.        sel
-000088a0: 662e 726f 6f74 2e74 6974 6c65 2e74 6578  f.root.title.tex
-000088b0: 7420 3d20 2242 616e 6477 6964 7468 3a20  t = "Bandwidth: 
-000088c0: 2220 2b20 666f 726d 6174 5f62 7974 6573  " + format_bytes
-000088d0: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
-000088e0: 6261 6e64 7769 6474 6829 0a20 2020 2020  bandwidth).     
-000088f0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
-00008900: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
-00008910: 0a63 6c61 7373 2057 6f72 6b65 724e 6574  .class WorkerNet
-00008920: 776f 726b 4261 6e64 7769 6474 6828 4461  workBandwidth(Da
-00008930: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00008940: 293a 0a20 2020 2022 2222 576f 726b 6572  ):.    """Worker
-00008950: 206e 6574 776f 726b 2062 616e 6477 6964   network bandwid
-00008960: 7468 2063 6861 7274 0a0a 2020 2020 506c  th chart..    Pl
-00008970: 6f74 7320 686f 7269 7a6f 6e74 616c 2062  ots horizontal b
-00008980: 6172 7320 7769 7468 2074 6865 2068 6f73  ars with the hos
-00008990: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
-000089a0: 7320 616e 6420 686f 7374 5f6e 6574 5f69  s and host_net_i
-000089b0: 6f2e 7772 6974 655f 6270 7320 776f 726b  o.write_bps work
-000089c0: 6572 0a20 2020 2073 7461 7465 0a20 2020  er.    state.   
-000089d0: 2022 2222 0a0a 2020 2020 406c 6f67 5f65   """..    @log_e
-000089e0: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
-000089f0: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-00008a00: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
-00008a10: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00008a20: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
-00008a30: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
-00008a40: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
-00008a50: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
-00008a60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00008a70: 2020 2020 2020 2020 2020 2020 2279 5f72              "y_r
-00008a80: 6561 6422 3a20 5b5d 2c0a 2020 2020 2020  ead": [],.      
-00008a90: 2020 2020 2020 2020 2020 2279 5f77 7269            "y_wri
-00008aa0: 7465 223a 205b 5d2c 0a20 2020 2020 2020  te": [],.       
-00008ab0: 2020 2020 2020 2020 2022 785f 7265 6164           "x_read
-00008ac0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00008ad0: 2020 2020 2020 2022 785f 7772 6974 6522         "x_write"
-00008ae0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00008af0: 2020 2020 2020 2278 5f72 6561 645f 6469        "x_read_di
-00008b00: 736b 223a 205b 5d2c 0a20 2020 2020 2020  sk": [],.       
-00008b10: 2020 2020 2020 2020 2022 785f 7772 6974           "x_writ
-00008b20: 655f 6469 736b 223a 205b 5d2c 0a20 2020  e_disk": [],.   
-00008b30: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00008b40: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00008b50: 6c66 2e62 616e 6477 6964 7468 203d 2066  lf.bandwidth = f
-00008b60: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-00008b70: 2020 2074 6974 6c65 3d22 576f 726b 6572     title="Worker
-00008b80: 204e 6574 776f 726b 2042 616e 6477 6964   Network Bandwid
-00008b90: 7468 222c 0a20 2020 2020 2020 2020 2020  th",.           
-00008ba0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00008bb0: 2020 2020 2020 206e 616d 653d 2277 6f72         name="wor
-00008bc0: 6b65 725f 6e65 7477 6f72 6b5f 6261 6e64  ker_network_band
-00008bd0: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
-00008be0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-00008bf0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00008c00: 2023 2068 6f73 745f 6e65 745f 696f 2e72   # host_net_io.r
-00008c10: 6561 645f 6270 730a 2020 2020 2020 2020  ead_bps.        
-00008c20: 7365 6c66 2e62 616e 6477 6964 7468 2e68  self.bandwidth.h
-00008c30: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
-00008c40: 2079 3d22 795f 7265 6164 222c 0a20 2020   y="y_read",.   
-00008c50: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-00008c60: 785f 7265 6164 222c 0a20 2020 2020 2020  x_read",.       
-00008c70: 2020 2020 206c 696e 655f 636f 6c6f 723d       line_color=
-00008c80: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00008c90: 2020 6c65 6674 3d30 2c0a 2020 2020 2020    left=0,.      
-00008ca0: 2020 2020 2020 6865 6967 6874 3d30 2e35        height=0.5
-00008cb0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-00008cc0: 6c6c 5f63 6f6c 6f72 3d22 7265 6422 2c0a  ll_color="red",.
-00008cd0: 2020 2020 2020 2020 2020 2020 6c65 6765              lege
-00008ce0: 6e64 5f6c 6162 656c 3d22 7265 6164 222c  nd_label="read",
-00008cf0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00008d00: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00008d10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00008d20: 2020 2020 2320 686f 7374 5f6e 6574 5f69      # host_net_i
-00008d30: 6f2e 7772 6974 655f 6270 730a 2020 2020  o.write_bps.    
-00008d40: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-00008d50: 7468 2e68 6261 7228 0a20 2020 2020 2020  th.hbar(.       
-00008d60: 2020 2020 2079 3d22 795f 7772 6974 6522       y="y_write"
-00008d70: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
-00008d80: 6768 743d 2278 5f77 7269 7465 222c 0a20  ght="x_write",. 
-00008d90: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-00008da0: 636f 6c6f 723d 4e6f 6e65 2c0a 2020 2020  color=None,.    
-00008db0: 2020 2020 2020 2020 6c65 6674 3d30 2c0a          left=0,.
-00008dc0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
-00008dd0: 6874 3d30 2e35 2c0a 2020 2020 2020 2020  ht=0.5,.        
-00008de0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-00008df0: 626c 7565 222c 0a20 2020 2020 2020 2020  blue",.         
-00008e00: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
-00008e10: 2277 7269 7465 222c 0a20 2020 2020 2020  "write",.       
-00008e20: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00008e30: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00008e40: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00008e50: 2e62 616e 6477 6964 7468 2e61 7869 735b  .bandwidth.axis[
-00008e60: 305d 2e74 6963 6b65 7220 3d20 4261 7369  0].ticker = Basi
-00008e70: 6354 6963 6b65 7228 2a2a 5449 434b 535f  cTicker(**TICKS_
-00008e80: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
-00008e90: 6c66 2e62 616e 6477 6964 7468 2e78 6178  lf.bandwidth.xax
-00008ea0: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
-00008eb0: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
-00008ec0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00008ed0: 2e30 2062 2229 0a20 2020 2020 2020 2073  .0 b").        s
-00008ee0: 656c 662e 6261 6e64 7769 6474 682e 7861  elf.bandwidth.xa
-00008ef0: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
-00008f00: 6f72 6965 6e74 6174 696f 6e20 3d20 584c  orientation = XL
-00008f10: 4142 454c 5f4f 5249 454e 5441 5449 4f4e  ABEL_ORIENTATION
-00008f20: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
-00008f30: 6e64 7769 6474 682e 7861 7869 732e 6d69  ndwidth.xaxis.mi
-00008f40: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-00008f50: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-00008f60: 7365 6c66 2e62 616e 6477 6964 7468 2e78  self.bandwidth.x
-00008f70: 5f72 616e 6765 203d 2052 616e 6765 3164  _range = Range1d
-00008f80: 2873 7461 7274 3d30 290a 2020 2020 2020  (start=0).      
-00008f90: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-00008fa0: 2e79 6178 6973 2e76 6973 6962 6c65 203d  .yaxis.visible =
-00008fb0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
-00008fc0: 656c 662e 6261 6e64 7769 6474 682e 7967  elf.bandwidth.yg
-00008fd0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-00008fe0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00008ff0: 2e62 616e 6477 6964 7468 2e74 6f6f 6c62  .bandwidth.toolb
-00009000: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
-00009010: 6e65 0a0a 2020 2020 2020 2020 7365 6c66  ne..        self
-00009020: 2e64 6973 6b20 3d20 6669 6775 7265 280a  .disk = figure(.
-00009030: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-00009040: 653d 2257 6f72 6b65 7273 2044 6973 6b22  e="Workers Disk"
-00009050: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00009060: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-00009070: 2020 2020 6e61 6d65 3d22 776f 726b 6572      name="worker
-00009080: 5f64 6973 6b22 2c0a 2020 2020 2020 2020  _disk",.        
-00009090: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-000090a0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000090b0: 2023 2068 6f73 745f 6469 736b 5f69 6f2e   # host_disk_io.
-000090c0: 7265 6164 5f62 7073 0a20 2020 2020 2020  read_bps.       
-000090d0: 2073 656c 662e 6469 736b 2e68 6261 7228   self.disk.hbar(
-000090e0: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
-000090f0: 795f 7265 6164 222c 0a20 2020 2020 2020  y_read",.       
-00009100: 2020 2020 2072 6967 6874 3d22 785f 7265       right="x_re
-00009110: 6164 5f64 6973 6b22 2c0a 2020 2020 2020  ad_disk",.      
-00009120: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
-00009130: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00009140: 2020 206c 6566 743d 302c 0a20 2020 2020     left=0,.     
-00009150: 2020 2020 2020 2068 6569 6768 743d 302e         height=0.
-00009160: 352c 0a20 2020 2020 2020 2020 2020 2066  5,.            f
-00009170: 696c 6c5f 636f 6c6f 723d 2272 6564 222c  ill_color="red",
-00009180: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-00009190: 656e 645f 6c61 6265 6c3d 2272 6561 6422  end_label="read"
-000091a0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
-000091b0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-000091c0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-000091d0: 2020 2020 2023 2068 6f73 745f 6469 736b       # host_disk
-000091e0: 5f69 6f2e 7772 6974 655f 6270 730a 2020  _io.write_bps.  
-000091f0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
-00009200: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
-00009210: 2020 793d 2279 5f77 7269 7465 222c 0a20    y="y_write",. 
-00009220: 2020 2020 2020 2020 2020 2072 6967 6874             right
-00009230: 3d22 785f 7772 6974 655f 6469 736b 222c  ="x_write_disk",
-00009240: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00009250: 655f 636f 6c6f 723d 4e6f 6e65 2c0a 2020  e_color=None,.  
-00009260: 2020 2020 2020 2020 2020 6c65 6674 3d30            left=0
-00009270: 2c0a 2020 2020 2020 2020 2020 2020 6865  ,.            he
-00009280: 6967 6874 3d30 2e35 2c0a 2020 2020 2020  ight=0.5,.      
-00009290: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
-000092a0: 3d22 626c 7565 222c 0a20 2020 2020 2020  ="blue",.       
-000092b0: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
-000092c0: 6c3d 2277 7269 7465 222c 0a20 2020 2020  l="write",.     
-000092d0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-000092e0: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-000092f0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00009300: 6c66 2e64 6973 6b2e 6178 6973 5b30 5d2e  lf.disk.axis[0].
-00009310: 7469 636b 6572 203d 2042 6173 6963 5469  ticker = BasicTi
-00009320: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
-00009330: 3429 0a20 2020 2020 2020 2073 656c 662e  4).        self.
-00009340: 6469 736b 2e78 6178 6973 5b30 5d2e 666f  disk.xaxis[0].fo
-00009350: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
-00009360: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
-00009370: 6f72 6d61 743d 2230 2e30 2062 2229 0a20  ormat="0.0 b"). 
-00009380: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-00009390: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
-000093a0: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
-000093b0: 2058 4c41 4245 4c5f 4f52 4945 4e54 4154   XLABEL_ORIENTAT
-000093c0: 494f 4e0a 2020 2020 2020 2020 7365 6c66  ION.        self
-000093d0: 2e64 6973 6b2e 7861 7869 732e 6d69 6e6f  .disk.xaxis.mino
-000093e0: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
-000093f0: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
-00009400: 6c66 2e64 6973 6b2e 785f 7261 6e67 6520  lf.disk.x_range 
-00009410: 3d20 5261 6e67 6531 6428 7374 6172 743d  = Range1d(start=
-00009420: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-00009430: 6469 736b 2e79 6178 6973 2e76 6973 6962  disk.yaxis.visib
-00009440: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-00009450: 2020 2073 656c 662e 6469 736b 2e79 6772     self.disk.ygr
-00009460: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
-00009470: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-00009480: 6469 736b 2e74 6f6f 6c62 6172 5f6c 6f63  disk.toolbar_loc
-00009490: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
-000094a0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-000094b0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-000094c0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-000094d0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-000094e0: 6c66 293a 0a20 2020 2020 2020 2077 6f72  lf):.        wor
-000094f0: 6b65 7273 203d 2073 656c 662e 7363 6865  kers = self.sche
-00009500: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
-00009510: 6c75 6573 2829 0a0a 2020 2020 2020 2020  lues()..        
-00009520: 6820 3d20 302e 310a 2020 2020 2020 2020  h = 0.1.        
-00009530: 795f 7265 6164 203d 205b 6920 2b20 302e  y_read = [i + 0.
-00009540: 3735 202b 2069 202a 2068 2066 6f72 2069  75 + i * h for i
-00009550: 2069 6e20 7261 6e67 6528 6c65 6e28 776f   in range(len(wo
-00009560: 726b 6572 7329 295d 0a20 2020 2020 2020  rkers))].       
-00009570: 2079 5f77 7269 7465 203d 205b 6920 2b20   y_write = [i + 
-00009580: 302e 3235 202b 2069 202a 2068 2066 6f72  0.25 + i * h for
-00009590: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-000095a0: 776f 726b 6572 7329 295d 0a0a 2020 2020  workers))]..    
-000095b0: 2020 2020 785f 7265 6164 203d 205b 5d0a      x_read = [].
-000095c0: 2020 2020 2020 2020 785f 7772 6974 6520          x_write 
-000095d0: 3d20 5b5d 0a20 2020 2020 2020 2078 5f72  = [].        x_r
-000095e0: 6561 645f 6469 736b 203d 205b 5d0a 2020  ead_disk = [].  
-000095f0: 2020 2020 2020 785f 7772 6974 655f 6469        x_write_di
-00009600: 736b 203d 205b 5d0a 0a20 2020 2020 2020  sk = []..       
-00009610: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
-00009620: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00009630: 785f 7265 6164 2e61 7070 656e 6428 7773  x_read.append(ws
-00009640: 2e6d 6574 7269 6373 5b22 686f 7374 5f6e  .metrics["host_n
-00009650: 6574 5f69 6f22 5d5b 2272 6561 645f 6270  et_io"]["read_bp
-00009660: 7322 5d29 0a20 2020 2020 2020 2020 2020  s"]).           
-00009670: 2078 5f77 7269 7465 2e61 7070 656e 6428   x_write.append(
-00009680: 7773 2e6d 6574 7269 6373 5b22 686f 7374  ws.metrics["host
-00009690: 5f6e 6574 5f69 6f22 5d5b 2277 7269 7465  _net_io"]["write
-000096a0: 5f62 7073 225d 290a 2020 2020 2020 2020  _bps"]).        
-000096b0: 2020 2020 785f 7265 6164 5f64 6973 6b2e      x_read_disk.
-000096c0: 6170 7065 6e64 2877 732e 6d65 7472 6963  append(ws.metric
-000096d0: 732e 6765 7428 2268 6f73 745f 6469 736b  s.get("host_disk
-000096e0: 5f69 6f22 2c20 7b7d 292e 6765 7428 2272  _io", {}).get("r
-000096f0: 6561 645f 6270 7322 2c20 3029 290a 2020  ead_bps", 0)).  
-00009700: 2020 2020 2020 2020 2020 785f 7772 6974            x_writ
-00009710: 655f 6469 736b 2e61 7070 656e 6428 7773  e_disk.append(ws
-00009720: 2e6d 6574 7269 6373 2e67 6574 2822 686f  .metrics.get("ho
-00009730: 7374 5f64 6973 6b5f 696f 222c 207b 7d29  st_disk_io", {})
-00009740: 2e67 6574 2822 7772 6974 655f 6270 7322  .get("write_bps"
-00009750: 2c20 3029 290a 0a20 2020 2020 2020 2069  , 0))..        i
-00009760: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-00009770: 2e77 6f72 6b65 7273 3a0a 2020 2020 2020  .workers:.      
-00009780: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-00009790: 6964 7468 2e78 5f72 616e 6765 2e65 6e64  idth.x_range.end
-000097a0: 203d 206d 6178 280a 2020 2020 2020 2020   = max(.        
-000097b0: 2020 2020 2020 2020 6d61 7828 785f 7265          max(x_re
-000097c0: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
-000097d0: 2020 2020 206d 6178 2878 5f77 7269 7465       max(x_write
-000097e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-000097f0: 2020 2031 3030 5f30 3030 5f30 3030 2c0a     100_000_000,.
-00009800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009810: 302e 3935 202a 2073 656c 662e 6261 6e64  0.95 * self.band
-00009820: 7769 6474 682e 785f 7261 6e67 652e 656e  width.x_range.en
-00009830: 642c 0a20 2020 2020 2020 2020 2020 2029  d,.            )
-00009840: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00009850: 6c66 2e64 6973 6b2e 785f 7261 6e67 652e  lf.disk.x_range.
-00009860: 656e 6420 3d20 6d61 7828 0a20 2020 2020  end = max(.     
-00009870: 2020 2020 2020 2020 2020 206d 6178 2878             max(x
-00009880: 5f72 6561 645f 6469 736b 292c 0a20 2020  _read_disk),.   
-00009890: 2020 2020 2020 2020 2020 2020 206d 6178               max
-000098a0: 2878 5f77 7269 7465 5f64 6973 6b29 2c0a  (x_write_disk),.
-000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098c0: 3130 305f 3030 305f 3030 302c 0a20 2020  100_000_000,.   
-000098d0: 2020 2020 2020 2020 2020 2020 2030 2e39               0.9
-000098e0: 3520 2a20 7365 6c66 2e64 6973 6b2e 785f  5 * self.disk.x_
-000098f0: 7261 6e67 652e 656e 642c 0a20 2020 2020  range.end,.     
-00009900: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00009910: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00009920: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-00009930: 682e 785f 7261 6e67 652e 656e 6420 3d20  h.x_range.end = 
-00009940: 3130 305f 3030 305f 3030 300a 2020 2020  100_000_000.    
-00009950: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
-00009960: 6b2e 785f 7261 6e67 652e 656e 6420 3d20  k.x_range.end = 
-00009970: 3130 305f 3030 305f 3030 300a 0a20 2020  100_000_000..   
-00009980: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
-00009990: 2020 2020 2020 2020 2020 2020 2279 5f72              "y_r
-000099a0: 6561 6422 3a20 795f 7265 6164 2c0a 2020  ead": y_read,.  
-000099b0: 2020 2020 2020 2020 2020 2279 5f77 7269            "y_wri
-000099c0: 7465 223a 2079 5f77 7269 7465 2c0a 2020  te": y_write,.  
-000099d0: 2020 2020 2020 2020 2020 2278 5f72 6561            "x_rea
-000099e0: 6422 3a20 785f 7265 6164 2c0a 2020 2020  d": x_read,.    
-000099f0: 2020 2020 2020 2020 2278 5f77 7269 7465          "x_write
-00009a00: 223a 2078 5f77 7269 7465 2c0a 2020 2020  ": x_write,.    
-00009a10: 2020 2020 2020 2020 2278 5f72 6561 645f          "x_read_
-00009a20: 6469 736b 223a 2078 5f72 6561 645f 6469  disk": x_read_di
-00009a30: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00009a40: 2278 5f77 7269 7465 5f64 6973 6b22 3a20  "x_write_disk": 
-00009a50: 785f 7772 6974 655f 6469 736b 2c0a 2020  x_write_disk,.  
-00009a60: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00009a70: 2075 7064 6174 6528 7365 6c66 2e73 6f75   update(self.sou
-00009a80: 7263 652c 2072 6573 756c 7429 0a0a 0a63  rce, result)...c
-00009a90: 6c61 7373 2053 7973 7465 6d54 696d 6573  lass SystemTimes
-00009aa0: 6572 6965 7328 4461 7368 626f 6172 6443  eries(DashboardC
-00009ab0: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00009ac0: 2222 5469 6d65 7365 7269 6573 2066 6f72  ""Timeseries for
-00009ad0: 2077 6f72 6b65 7220 6e65 7477 6f72 6b20   worker network 
-00009ae0: 6261 6e64 7769 6474 682c 2063 7075 2c20  bandwidth, cpu, 
-00009af0: 6d65 6d6f 7279 2061 6e64 2064 6973 6b2e  memory and disk.
-00009b00: 0a0a 2020 2020 6261 6e64 7769 6474 680a  ..    bandwidth.
-00009b10: 2020 2020 2020 2020 506c 6f74 7320 7468          Plots th
-00009b20: 6520 6176 6572 6167 6520 6f66 2068 6f73  e average of hos
-00009b30: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
-00009b40: 7320 616e 6420 686f 7374 5f6e 6574 5f69  s and host_net_i
-00009b50: 6f2e 7772 6974 655f 6270 7320 666f 7220  o.write_bps for 
-00009b60: 7468 650a 2020 2020 2020 2020 776f 726b  the.        work
-00009b70: 6572 7320 6173 2061 2066 756e 6374 696f  ers as a functio
-00009b80: 6e20 6f66 2074 696d 650a 2020 2020 6370  n of time.    cp
-00009b90: 750a 2020 2020 2020 2020 506c 6f74 7320  u.        Plots 
-00009ba0: 7468 6520 6176 6572 6167 6520 6f66 2063  the average of c
-00009bb0: 7075 2066 6f72 2074 6865 2077 6f72 6b65  pu for the worke
-00009bc0: 7273 2061 7320 6120 6675 6e63 7469 6f6e  rs as a function
-00009bd0: 206f 6620 7469 6d65 0a20 2020 206d 656d   of time.    mem
-00009be0: 6f72 790a 2020 2020 2020 2020 506c 6f74  ory.        Plot
-00009bf0: 7320 7468 6520 6176 6572 6167 6520 6f66  s the average of
-00009c00: 206d 656d 6f72 7920 666f 7220 7468 6520   memory for the 
-00009c10: 776f 726b 6572 7320 6173 2061 2066 756e  workers as a fun
-00009c20: 6374 696f 6e20 6f66 2074 696d 650a 2020  ction of time.  
-00009c30: 2020 6469 736b 0a20 2020 2020 2020 2050    disk.        P
-00009c40: 6c6f 7473 2074 6865 2061 7665 7261 6765  lots the average
-00009c50: 206f 6620 686f 7374 5f64 6973 6b5f 696f   of host_disk_io
-00009c60: 2e72 6561 645f 6270 7320 616e 6420 686f  .read_bps and ho
-00009c70: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
-00009c80: 5f62 7073 2066 6f72 2074 6865 0a20 2020  _bps for the.   
-00009c90: 2020 2020 2077 6f72 6b65 7273 2061 7320       workers as 
-00009ca0: 6120 6675 6e63 7469 6f6e 206f 6620 7469  a function of ti
-00009cb0: 6d65 0a0a 2020 2020 5468 6520 6d65 7472  me..    The metr
-00009cc0: 6963 7320 706c 6f74 7465 6420 636f 6d65  ics plotted come
-00009cd0: 2066 726f 6d20 7468 6520 6167 6772 6567   from the aggreg
-00009ce0: 6174 696f 6e20 6f66 2066 726f 6d20 7773  ation of from ws
-00009cf0: 2e6d 6574 7269 6373 5b6b 6579 5d20 666f  .metrics[key] fo
-00009d00: 7220 7773 2069 6e0a 2020 2020 7363 6865  r ws in.    sche
-00009d10: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
-00009d20: 6c75 6573 2829 2064 6976 6964 6564 2062  lues() divided b
-00009d30: 7920 6e75 6d62 6572 206f 6620 776f 726b  y number of work
-00009d40: 6572 732e 0a20 2020 2022 2222 0a0a 2020  ers..    """..  
-00009d50: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
-00009d60: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00009d70: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-00009d80: 666f 6c6c 6f77 5f69 6e74 6572 7661 6c3d  follow_interval=
-00009d90: 3230 3030 302c 202a 2a6b 7761 7267 7329  20000, **kwargs)
-00009da0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00009db0: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00009dc0: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
-00009dd0: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
-00009de0: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
-00009df0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00009e00: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-00009e10: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00009e20: 2020 2020 2020 2022 686f 7374 5f6e 6574         "host_net
-00009e30: 5f69 6f2e 7265 6164 5f62 7073 223a 205b  _io.read_bps": [
-00009e40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00009e50: 2020 2022 686f 7374 5f6e 6574 5f69 6f2e     "host_net_io.
-00009e60: 7772 6974 655f 6270 7322 3a20 5b5d 2c0a  write_bps": [],.
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e80: 2263 7075 223a 205b 5d2c 0a20 2020 2020  "cpu": [],.     
-00009e90: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00009ea0: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
-00009eb0: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
-00009ec0: 6973 6b5f 696f 2e72 6561 645f 6270 7322  isk_io.read_bps"
-00009ed0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00009ee0: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
-00009ef0: 5f69 6f2e 7772 6974 655f 6270 7322 3a20  _io.write_bps": 
-00009f00: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00009f10: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
-00009f20: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
-00009f30: 2e73 6f75 7263 652c 2073 656c 662e 6765  .source, self.ge
-00009f40: 745f 6461 7461 2829 290a 0a20 2020 2020  t_data())..     
-00009f50: 2020 2078 5f72 616e 6765 203d 2044 6174     x_range = Dat
-00009f60: 6152 616e 6765 3164 280a 2020 2020 2020  aRange1d(.      
-00009f70: 2020 2020 2020 666f 6c6c 6f77 3d22 656e        follow="en
-00009f80: 6422 2c20 666f 6c6c 6f77 5f69 6e74 6572  d", follow_inter
-00009f90: 7661 6c3d 666f 6c6c 6f77 5f69 6e74 6572  val=follow_inter
-00009fa0: 7661 6c2c 2072 616e 6765 5f70 6164 6469  val, range_paddi
-00009fb0: 6e67 3d30 0a20 2020 2020 2020 2029 0a20  ng=0.        ). 
-00009fc0: 2020 2020 2020 2074 6f6f 6c73 203d 2022         tools = "
-00009fd0: 7265 7365 742c 2078 7061 6e2c 2078 7768  reset, xpan, xwh
-00009fe0: 6565 6c5f 7a6f 6f6d 220a 0a20 2020 2020  eel_zoom"..     
-00009ff0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-0000a000: 6820 3d20 6669 6775 7265 280a 2020 2020  h = figure(.    
-0000a010: 2020 2020 2020 2020 7469 746c 653d 2257          title="W
-0000a020: 6f72 6b65 7220 4e65 7477 6f72 6b20 4261  orker Network Ba
-0000a030: 6e64 7769 6474 6820 2861 7665 7261 6765  ndwidth (average
-0000a040: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
-0000a050: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
-0000a060: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
-0000a070: 2020 2020 746f 6f6c 733d 746f 6f6c 732c      tools=tools,
-0000a080: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-0000a090: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
-0000a0a0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
-0000a0b0: 776f 726b 6572 5f6e 6574 776f 726b 5f62  worker_network_b
-0000a0c0: 616e 6477 6964 7468 2d74 696d 6573 6572  andwidth-timeser
-0000a0d0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
-0000a0e0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0000a0f0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0000a100: 656c 662e 6261 6e64 7769 6474 682e 6c69  elf.bandwidth.li
-0000a110: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
-0000a120: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-0000a130: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0000a140: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
-0000a150: 2020 2020 2020 793d 2268 6f73 745f 6e65        y="host_ne
-0000a160: 745f 696f 2e72 6561 645f 6270 7322 2c0a  t_io.read_bps",.
-0000a170: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-0000a180: 723d 2272 6564 222c 0a20 2020 2020 2020  r="red",.       
-0000a190: 2020 2020 206c 6567 656e 645f 6c61 6265       legend_labe
-0000a1a0: 6c3d 2272 6561 6420 286d 6561 6e29 222c  l="read (mean)",
-0000a1b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000a1c0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-0000a1d0: 682e 6c69 6e65 280a 2020 2020 2020 2020  h.line(.        
-0000a1e0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0000a1f0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000a200: 2020 2020 783d 2274 696d 6522 2c0a 2020      x="time",.  
-0000a210: 2020 2020 2020 2020 2020 793d 2268 6f73            y="hos
-0000a220: 745f 6e65 745f 696f 2e77 7269 7465 5f62  t_net_io.write_b
-0000a230: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
-0000a240: 2063 6f6c 6f72 3d22 626c 7565 222c 0a20   color="blue",. 
-0000a250: 2020 2020 2020 2020 2020 206c 6567 656e             legen
-0000a260: 645f 6c61 6265 6c3d 2277 7269 7465 2028  d_label="write (
-0000a270: 6d65 616e 2922 2c0a 2020 2020 2020 2020  mean)",.        
-0000a280: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000a290: 6261 6e64 7769 6474 682e 6c65 6765 6e64  bandwidth.legend
-0000a2a0: 2e6c 6f63 6174 696f 6e20 3d20 2274 6f70  .location = "top
-0000a2b0: 5f6c 6566 7422 0a20 2020 2020 2020 2073  _left".        s
-0000a2c0: 656c 662e 6261 6e64 7769 6474 682e 7961  elf.bandwidth.ya
-0000a2d0: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
-0000a2e0: 2022 6279 7465 7320 2f20 7365 636f 6e64   "bytes / second
-0000a2f0: 220a 2020 2020 2020 2020 7365 6c66 2e62  ".        self.b
-0000a300: 616e 6477 6964 7468 2e79 6178 6973 5b30  andwidth.yaxis[0
-0000a310: 5d2e 666f 726d 6174 7465 7220 3d20 4e75  ].formatter = Nu
-0000a320: 6d65 7261 6c54 6963 6b46 6f72 6d61 7474  meralTickFormatt
-0000a330: 6572 2866 6f72 6d61 743d 2230 2e30 6222  er(format="0.0b"
-0000a340: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
-0000a350: 616e 6477 6964 7468 2e79 5f72 616e 6765  andwidth.y_range
-0000a360: 2e73 7461 7274 203d 2030 0a20 2020 2020  .start = 0.     
-0000a370: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-0000a380: 682e 7961 7869 732e 6d69 6e6f 725f 7469  h.yaxis.minor_ti
-0000a390: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
-0000a3a0: 300a 2020 2020 2020 2020 7365 6c66 2e62  0.        self.b
-0000a3b0: 616e 6477 6964 7468 2e78 6772 6964 2e76  andwidth.xgrid.v
-0000a3c0: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-0000a3d0: 2020 2020 2020 2020 7365 6c66 2e63 7075          self.cpu
-0000a3e0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-0000a3f0: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
-0000a400: 726b 6572 2043 5055 2055 7469 6c69 7a61  rker CPU Utiliza
-0000a410: 7469 6f6e 2028 6176 6572 6167 6529 222c  tion (average)",
-0000a420: 0a20 2020 2020 2020 2020 2020 2078 5f61  .            x_a
-0000a430: 7869 735f 7479 7065 3d22 6461 7465 7469  xis_type="dateti
-0000a440: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-0000a450: 2074 6f6f 6c73 3d74 6f6f 6c73 2c0a 2020   tools=tools,.  
-0000a460: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
-0000a470: 653d 785f 7261 6e67 652c 0a20 2020 2020  e=x_range,.     
-0000a480: 2020 2020 2020 206e 616d 653d 2277 6f72         name="wor
-0000a490: 6b65 725f 6370 752d 7469 6d65 7365 7269  ker_cpu-timeseri
-0000a4a0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-0000a4b0: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-0000a4c0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-0000a4d0: 6c66 2e63 7075 2e6c 696e 6528 0a20 2020  lf.cpu.line(.   
-0000a4e0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000a4f0: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0000a500: 2020 2020 2020 2020 2078 3d22 7469 6d65           x="time
-0000a510: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-0000a520: 3d22 6370 7522 2c0a 2020 2020 2020 2020  ="cpu",.        
-0000a530: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000a540: 7075 2e79 6178 6973 2e61 7869 735f 6c61  pu.yaxis.axis_la
-0000a550: 6265 6c20 3d20 2255 7469 6c69 7a61 7469  bel = "Utilizati
-0000a560: 6f6e 220a 2020 2020 2020 2020 7365 6c66  on".        self
-0000a570: 2e63 7075 2e79 5f72 616e 6765 2e73 7461  .cpu.y_range.sta
-0000a580: 7274 203d 2030 0a20 2020 2020 2020 2073  rt = 0.        s
-0000a590: 656c 662e 6370 752e 7961 7869 732e 6d69  elf.cpu.yaxis.mi
-0000a5a0: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-0000a5b0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-0000a5c0: 7365 6c66 2e63 7075 2e78 6772 6964 2e76  self.cpu.xgrid.v
-0000a5d0: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-0000a5e0: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
-0000a5f0: 6f72 7920 3d20 6669 6775 7265 280a 2020  ory = figure(.  
-0000a600: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000a610: 2257 6f72 6b65 7220 4d65 6d6f 7279 2055  "Worker Memory U
-0000a620: 7365 2028 6176 6572 6167 6529 222c 0a20  se (average)",. 
-0000a630: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
-0000a640: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
-0000a650: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0000a660: 6f6f 6c73 3d74 6f6f 6c73 2c0a 2020 2020  ools=tools,.    
-0000a670: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-0000a680: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
-0000a690: 2020 2020 206e 616d 653d 2277 6f72 6b65       name="worke
-0000a6a0: 725f 6d65 6d6f 7279 2d74 696d 6573 6572  r_memory-timeser
-0000a6b0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
-0000a6c0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0000a6d0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0000a6e0: 656c 662e 6d65 6d6f 7279 2e6c 696e 6528  elf.memory.line(
-0000a6f0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000a700: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000a710: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-0000a720: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-0000a730: 2020 2079 3d22 6d65 6d6f 7279 222c 0a20     y="memory",. 
-0000a740: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000a750: 2073 656c 662e 6d65 6d6f 7279 2e79 6178   self.memory.yax
-0000a760: 6973 2e61 7869 735f 6c61 6265 6c20 3d20  is.axis_label = 
-0000a770: 2242 7974 6573 220a 2020 2020 2020 2020  "Bytes".        
-0000a780: 7365 6c66 2e6d 656d 6f72 792e 7961 7869  self.memory.yaxi
-0000a790: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
-0000a7a0: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
-0000a7b0: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
-0000a7c0: 3062 2229 0a20 2020 2020 2020 2073 656c  0b").        sel
-0000a7d0: 662e 6d65 6d6f 7279 2e79 5f72 616e 6765  f.memory.y_range
-0000a7e0: 2e73 7461 7274 203d 2030 0a20 2020 2020  .start = 0.     
-0000a7f0: 2020 2073 656c 662e 6d65 6d6f 7279 2e79     self.memory.y
-0000a800: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-0000a810: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-0000a820: 2020 2020 2020 2073 656c 662e 6d65 6d6f         self.memo
-0000a830: 7279 2e78 6772 6964 2e76 6973 6962 6c65  ry.xgrid.visible
-0000a840: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0000a850: 2020 7365 6c66 2e64 6973 6b20 3d20 6669    self.disk = fi
-0000a860: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-0000a870: 2020 7469 746c 653d 2257 6f72 6b65 7220    title="Worker 
-0000a880: 4469 736b 2042 616e 6477 6964 7468 2028  Disk Bandwidth (
-0000a890: 6176 6572 6167 6529 222c 0a20 2020 2020  average)",.     
-0000a8a0: 2020 2020 2020 2078 5f61 7869 735f 7479         x_axis_ty
-0000a8b0: 7065 3d22 6461 7465 7469 6d65 222c 0a20  pe="datetime",. 
-0000a8c0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0000a8d0: 3d74 6f6f 6c73 2c0a 2020 2020 2020 2020  =tools,.        
-0000a8e0: 2020 2020 785f 7261 6e67 653d 785f 7261      x_range=x_ra
-0000a8f0: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
-0000a900: 206e 616d 653d 2277 6f72 6b65 725f 6469   name="worker_di
-0000a910: 736b 2d74 696d 6573 6572 6965 7322 2c0a  sk-timeseries",.
-0000a920: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-0000a930: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-0000a940: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-0000a950: 736b 2e6c 696e 6528 0a20 2020 2020 2020  sk.line(.       
-0000a960: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000a970: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0000a980: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-0000a990: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
-0000a9a0: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
-0000a9b0: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
-0000a9c0: 2020 636f 6c6f 723d 2272 6564 222c 0a20    color="red",. 
-0000a9d0: 2020 2020 2020 2020 2020 206c 6567 656e             legen
-0000a9e0: 645f 6c61 6265 6c3d 2272 6561 6420 286d  d_label="read (m
-0000a9f0: 6561 6e29 222c 0a20 2020 2020 2020 2029  ean)",.        )
-0000aa00: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-0000aa10: 736b 2e6c 696e 6528 0a20 2020 2020 2020  sk.line(.       
-0000aa20: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000aa30: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0000aa40: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-0000aa50: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
-0000aa60: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
-0000aa70: 5f62 7073 222c 0a20 2020 2020 2020 2020  _bps",.         
-0000aa80: 2020 2063 6f6c 6f72 3d22 626c 7565 222c     color="blue",
-0000aa90: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
-0000aaa0: 656e 645f 6c61 6265 6c3d 2277 7269 7465  end_label="write
-0000aab0: 2028 6d65 616e 2922 2c0a 2020 2020 2020   (mean)",.      
-0000aac0: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0000aad0: 662e 6469 736b 2e6c 6567 656e 642e 6c6f  f.disk.legend.lo
-0000aae0: 6361 7469 6f6e 203d 2022 746f 705f 6c65  cation = "top_le
-0000aaf0: 6674 220a 2020 2020 2020 2020 7365 6c66  ft".        self
-0000ab00: 2e64 6973 6b2e 7961 7869 732e 6178 6973  .disk.yaxis.axis
-0000ab10: 5f6c 6162 656c 203d 2022 6279 7465 7320  _label = "bytes 
-0000ab20: 2f20 7365 636f 6e64 220a 2020 2020 2020  / second".      
-0000ab30: 2020 7365 6c66 2e64 6973 6b2e 7961 7869    self.disk.yaxi
-0000ab40: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
-0000ab50: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
-0000ab60: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
-0000ab70: 3062 2229 0a20 2020 2020 2020 2073 656c  0b").        sel
-0000ab80: 662e 6469 736b 2e79 5f72 616e 6765 2e73  f.disk.y_range.s
-0000ab90: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
-0000aba0: 2073 656c 662e 6469 736b 2e79 6178 6973   self.disk.yaxis
-0000abb0: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
-0000abc0: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
-0000abd0: 2020 2073 656c 662e 6469 736b 2e78 6772     self.disk.xgr
-0000abe0: 6964 2e76 6973 6962 6c65 203d 2046 616c  id.visible = Fal
-0000abf0: 7365 0a0a 2020 2020 6465 6620 6765 745f  se..    def get_
-0000ac00: 6461 7461 2873 656c 6629 3a0a 2020 2020  data(self):.    
-0000ac10: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-0000ac20: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
-0000ac30: 6b65 7273 2e76 616c 7565 7328 290a 0a20  kers.values().. 
-0000ac40: 2020 2020 2020 206e 6574 5f72 6561 645f         net_read_
-0000ac50: 6270 7320 3d20 300a 2020 2020 2020 2020  bps = 0.        
-0000ac60: 6e65 745f 7772 6974 655f 6270 7320 3d20  net_write_bps = 
-0000ac70: 300a 2020 2020 2020 2020 6370 7520 3d20  0.        cpu = 
-0000ac80: 300a 2020 2020 2020 2020 6d65 6d6f 7279  0.        memory
-0000ac90: 203d 2030 0a20 2020 2020 2020 2064 6973   = 0.        dis
-0000aca0: 6b5f 7265 6164 5f62 7073 203d 2030 0a20  k_read_bps = 0. 
-0000acb0: 2020 2020 2020 2064 6973 6b5f 7772 6974         disk_writ
-0000acc0: 655f 6270 7320 3d20 300a 2020 2020 2020  e_bps = 0.      
-0000acd0: 2020 7469 6d65 203d 2030 0a20 2020 2020    time = 0.     
-0000ace0: 2020 2066 6f72 2077 7320 696e 2077 6f72     for ws in wor
-0000acf0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-0000ad00: 2020 6e65 745f 7265 6164 5f62 7073 202b    net_read_bps +
-0000ad10: 3d20 7773 2e6d 6574 7269 6373 5b22 686f  = ws.metrics["ho
-0000ad20: 7374 5f6e 6574 5f69 6f22 5d5b 2272 6561  st_net_io"]["rea
-0000ad30: 645f 6270 7322 5d0a 2020 2020 2020 2020  d_bps"].        
-0000ad40: 2020 2020 6e65 745f 7772 6974 655f 6270      net_write_bp
-0000ad50: 7320 2b3d 2077 732e 6d65 7472 6963 735b  s += ws.metrics[
-0000ad60: 2268 6f73 745f 6e65 745f 696f 225d 5b22  "host_net_io"]["
-0000ad70: 7772 6974 655f 6270 7322 5d0a 2020 2020  write_bps"].    
-0000ad80: 2020 2020 2020 2020 6370 7520 2b3d 2077          cpu += w
-0000ad90: 732e 6d65 7472 6963 735b 2263 7075 225d  s.metrics["cpu"]
-0000ada0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-0000adb0: 6f72 7920 2b3d 2077 732e 6d65 7472 6963  ory += ws.metric
-0000adc0: 735b 226d 656d 6f72 7922 5d0a 2020 2020  s["memory"].    
-0000add0: 2020 2020 2020 2020 6469 736b 5f72 6561          disk_rea
-0000ade0: 645f 6270 7320 2b3d 2077 732e 6d65 7472  d_bps += ws.metr
-0000adf0: 6963 732e 6765 7428 2268 6f73 745f 6469  ics.get("host_di
-0000ae00: 736b 5f69 6f22 2c20 7b7d 292e 6765 7428  sk_io", {}).get(
-0000ae10: 2272 6561 645f 6270 7322 2c20 3029 0a20  "read_bps", 0). 
-0000ae20: 2020 2020 2020 2020 2020 2064 6973 6b5f             disk_
-0000ae30: 7772 6974 655f 6270 7320 2b3d 2077 732e  write_bps += ws.
-0000ae40: 6d65 7472 6963 732e 6765 7428 2268 6f73  metrics.get("hos
-0000ae50: 745f 6469 736b 5f69 6f22 2c20 7b7d 292e  t_disk_io", {}).
-0000ae60: 6765 7428 2277 7269 7465 5f62 7073 222c  get("write_bps",
-0000ae70: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-0000ae80: 7469 6d65 202b 3d20 7773 2e6d 6574 7269  time += ws.metri
-0000ae90: 6373 5b22 7469 6d65 225d 0a0a 2020 2020  cs["time"]..    
-0000aea0: 2020 2020 7265 7375 6c74 203d 207b 0a20      result = {. 
-0000aeb0: 2020 2020 2020 2020 2020 2023 2075 7365             # use
-0000aec0: 2060 6f72 6020 746f 2061 766f 6964 205a   `or` to avoid Z
-0000aed0: 6572 6f44 6976 6973 696f 6e20 7768 656e  eroDivision when
-0000aee0: 206e 6f20 776f 726b 6572 730a 2020 2020   no workers.    
-0000aef0: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
-0000af00: 5b74 696d 6520 2f20 286c 656e 2877 6f72  [time / (len(wor
-0000af10: 6b65 7273 2920 6f72 2031 2920 2a20 3130  kers) or 1) * 10
-0000af20: 3030 5d2c 0a20 2020 2020 2020 2020 2020  00],.           
-0000af30: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
-0000af40: 6164 5f62 7073 223a 205b 6e65 745f 7265  ad_bps": [net_re
-0000af50: 6164 5f62 7073 202f 2028 6c65 6e28 776f  ad_bps / (len(wo
-0000af60: 726b 6572 7329 206f 7220 3129 5d2c 0a20  rkers) or 1)],. 
-0000af70: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-0000af80: 5f6e 6574 5f69 6f2e 7772 6974 655f 6270  _net_io.write_bp
-0000af90: 7322 3a20 5b6e 6574 5f77 7269 7465 5f62  s": [net_write_b
-0000afa0: 7073 202f 2028 6c65 6e28 776f 726b 6572  ps / (len(worker
-0000afb0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
-0000afc0: 2020 2020 2020 2022 6370 7522 3a20 5b63         "cpu": [c
-0000afd0: 7075 202f 2028 6c65 6e28 776f 726b 6572  pu / (len(worker
-0000afe0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
-0000aff0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-0000b000: 205b 6d65 6d6f 7279 202f 2028 6c65 6e28   [memory / (len(
-0000b010: 776f 726b 6572 7329 206f 7220 3129 5d2c  workers) or 1)],
-0000b020: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-0000b030: 7374 5f64 6973 6b5f 696f 2e72 6561 645f  st_disk_io.read_
-0000b040: 6270 7322 3a20 5b64 6973 6b5f 7265 6164  bps": [disk_read
-0000b050: 5f62 7073 202f 2028 6c65 6e28 776f 726b  _bps / (len(work
-0000b060: 6572 7329 206f 7220 3129 5d2c 0a20 2020  ers) or 1)],.   
-0000b070: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
-0000b080: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
-0000b090: 223a 205b 6469 736b 5f77 7269 7465 5f62  ": [disk_write_b
-0000b0a0: 7073 202f 2028 6c65 6e28 776f 726b 6572  ps / (len(worker
-0000b0b0: 7329 206f 7220 3129 5d2c 0a20 2020 2020  s) or 1)],.     
-0000b0c0: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-0000b0d0: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-0000b0e0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-0000b0f0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-0000b100: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-0000b110: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
-0000b120: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000b130: 736f 7572 6365 2e73 7472 6561 6d28 7365  source.stream(se
-0000b140: 6c66 2e67 6574 5f64 6174 6128 292c 2031  lf.get_data(), 1
-0000b150: 3030 3029 0a0a 2020 2020 2020 2020 6966  000)..        if
-0000b160: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-0000b170: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-0000b180: 2020 2020 2079 5f65 6e64 5f63 7075 203d       y_end_cpu =
-0000b190: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
-0000b1a0: 2020 2020 2020 7773 2e6e 7468 7265 6164        ws.nthread
-0000b1b0: 7320 6f72 2031 2066 6f72 2077 7320 696e  s or 1 for ws in
-0000b1c0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-0000b1d0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-0000b1e0: 0a20 2020 2020 2020 2020 2020 2029 202f  .            ) /
-0000b1f0: 206c 656e 2873 656c 662e 7363 6865 6475   len(self.schedu
-0000b200: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-0000b210: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-0000b220: 2020 795f 656e 645f 6d65 6d20 3d20 7375    y_end_mem = su
-0000b230: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
-0000b240: 2020 2077 732e 6d65 6d6f 7279 5f6c 696d     ws.memory_lim
-0000b250: 6974 2066 6f72 2077 7320 696e 2073 656c  it for ws in sel
-0000b260: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
-0000b270: 6572 732e 7661 6c75 6573 2829 0a20 2020  ers.values().   
-0000b280: 2020 2020 2020 2020 2029 202f 206c 656e           ) / len
-0000b290: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
-0000b2a0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-0000b2b0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0000b2c0: 2020 2020 2020 2020 2020 2020 795f 656e              y_en
-0000b2d0: 645f 6370 7520 3d20 310a 2020 2020 2020  d_cpu = 1.      
-0000b2e0: 2020 2020 2020 795f 656e 645f 6d65 6d20        y_end_mem 
-0000b2f0: 3d20 3130 305f 3030 305f 3030 300a 0a20  = 100_000_000.. 
-0000b300: 2020 2020 2020 2073 656c 662e 6370 752e         self.cpu.
-0000b310: 795f 7261 6e67 652e 656e 6420 3d20 795f  y_range.end = y_
-0000b320: 656e 645f 6370 7520 2a20 3130 300a 2020  end_cpu * 100.  
-0000b330: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
-0000b340: 792e 795f 7261 6e67 652e 656e 6420 3d20  y.y_range.end = 
-0000b350: 795f 656e 645f 6d65 6d0a 0a0a 636c 6173  y_end_mem...clas
-0000b360: 7320 436f 6d70 7574 6550 6572 4b65 7928  s ComputePerKey(
-0000b370: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-0000b380: 6e74 293a 0a20 2020 2022 2222 4261 7220  nt):.    """Bar 
-0000b390: 6368 6172 7420 7368 6f77 696e 6720 7469  chart showing ti
-0000b3a0: 6d65 2073 7065 6e64 2069 6e20 6163 7469  me spend in acti
-0000b3b0: 6f6e 2062 7920 6b65 7920 7072 6566 6978  on by key prefix
-0000b3c0: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
-0000b3d0: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
-0000b3e0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-0000b3f0: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
-0000b400: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
-0000b410: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
-0000b420: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-0000b430: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-0000b440: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-0000b450: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-0000b460: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-0000b470: 6572 2e70 6c75 6769 6e73 3a0a 2020 2020  er.plugins:.    
-0000b480: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0000b490: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
-0000b4a0: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
-0000b4b0: 696e 2873 656c 662e 7363 6865 6475 6c65  in(self.schedule
-0000b4c0: 7229 290a 0a20 2020 2020 2020 2063 6f6d  r))..        com
-0000b4d0: 7075 7465 5f64 6174 6120 3d20 7b0a 2020  pute_data = {.  
-0000b4e0: 2020 2020 2020 2020 2020 2274 696d 6573            "times
-0000b4f0: 223a 205b 302e 322c 2030 2e31 5d2c 0a20  ": [0.2, 0.1],. 
-0000b500: 2020 2020 2020 2020 2020 2022 666f 726d             "form
-0000b510: 6174 7465 645f 7469 6d65 223a 205b 2230  atted_time": ["0
-0000b520: 2e32 206d 7322 2c20 2232 2e38 2075 7322  .2 ms", "2.8 us"
-0000b530: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000b540: 616e 676c 6573 223a 205b 332e 3134 2c20  angles": [3.14, 
-0000b550: 302e 3738 355d 2c0a 2020 2020 2020 2020  0.785],.        
-0000b560: 2020 2020 2263 6f6c 6f72 223a 205b 7473      "color": [ts
-0000b570: 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b 2274  _color_lookup["t
-0000b580: 7261 6e73 6665 7222 5d2c 2074 735f 636f  ransfer"], ts_co
-0000b590: 6c6f 725f 6c6f 6f6b 7570 5b22 636f 6d70  lor_lookup["comp
-0000b5a0: 7574 6522 5d5d 2c0a 2020 2020 2020 2020  ute"]],.        
-0000b5b0: 2020 2020 226e 616d 6573 223a 205b 2273      "names": ["s
-0000b5c0: 756d 222c 2022 7375 6d5f 7061 7274 6961  um", "sum_partia
-0000b5d0: 6c22 5d2c 0a20 2020 2020 2020 207d 0a0a  l"],.        }..
-0000b5e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
-0000b5f0: 7075 7465 5f73 6f75 7263 6520 3d20 436f  pute_source = Co
-0000b600: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
-0000b610: 6174 613d 636f 6d70 7574 655f 6461 7461  ata=compute_data
-0000b620: 290a 0a20 2020 2020 2020 2066 6967 203d  )..        fig =
-0000b630: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-0000b640: 2020 2020 2074 6974 6c65 3d22 436f 6d70       title="Comp
-0000b650: 7574 6520 5469 6d65 2050 6572 2054 6173  ute Time Per Tas
-0000b660: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-0000b670: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0000b680: 2020 2020 2020 6e61 6d65 3d22 636f 6d70        name="comp
-0000b690: 7574 655f 7469 6d65 5f70 6572 5f6b 6579  ute_time_per_key
-0000b6a0: 222c 0a20 2020 2020 2020 2020 2020 2078  ",.            x
-0000b6b0: 5f72 616e 6765 3d5b 2261 222c 2022 6222  _range=["a", "b"
-0000b6c0: 5d2c 0a20 2020 2020 2020 2020 2020 202a  ],.            *
-0000b6d0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-0000b6e0: 2029 0a0a 2020 2020 2020 2020 7265 6374   )..        rect
-0000b6f0: 203d 2066 6967 2e76 6261 7228 0a20 2020   = fig.vbar(.   
-0000b700: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000b710: 7365 6c66 2e63 6f6d 7075 7465 5f73 6f75  self.compute_sou
-0000b720: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
-0000b730: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
-0000b740: 2020 2020 2020 2020 746f 703d 2274 696d          top="tim
-0000b750: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-0000b760: 2077 6964 7468 3d30 2e37 2c0a 2020 2020   width=0.7,.    
-0000b770: 2020 2020 2020 2020 636f 6c6f 723d 2263          color="c
-0000b780: 6f6c 6f72 222c 0a20 2020 2020 2020 2029  olor",.        )
-0000b790: 0a0a 2020 2020 2020 2020 6669 672e 795f  ..        fig.y_
-0000b7a0: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
-0000b7b0: 2020 2020 2020 2020 6669 672e 7961 7869          fig.yaxi
-0000b7c0: 732e 6178 6973 5f6c 6162 656c 203d 2022  s.axis_label = "
-0000b7d0: 5469 6d65 2028 7329 220a 2020 2020 2020  Time (s)".      
-0000b7e0: 2020 6669 672e 7961 7869 735b 305d 2e66    fig.yaxis[0].f
-0000b7f0: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-0000b800: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-0000b810: 666f 726d 6174 3d22 3022 290a 2020 2020  format="0").    
-0000b820: 2020 2020 6669 672e 7961 7869 732e 7469      fig.yaxis.ti
-0000b830: 636b 6572 203d 2041 6461 7074 6976 6554  cker = AdaptiveT
-0000b840: 6963 6b65 7228 2a2a 5449 434b 535f 3130  icker(**TICKS_10
-0000b850: 3234 290a 2020 2020 2020 2020 6669 672e  24).        fig.
-0000b860: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
-0000b870: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
-0000b880: 584c 4142 454c 5f4f 5249 454e 5441 5449  XLABEL_ORIENTATI
-0000b890: 4f4e 0a20 2020 2020 2020 2072 6563 742e  ON.        rect.
-0000b8a0: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
-0000b8b0: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
-0000b8c0: 2020 2066 6967 2e78 6178 6973 2e6d 696e     fig.xaxis.min
-0000b8d0: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-0000b8e0: 6861 203d 2030 0a20 2020 2020 2020 2066  ha = 0.        f
-0000b8f0: 6967 2e78 6772 6964 2e76 6973 6962 6c65  ig.xgrid.visible
-0000b900: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0000b910: 2020 6669 672e 746f 6f6c 6261 725f 6c6f    fig.toolbar_lo
-0000b920: 6361 7469 6f6e 203d 204e 6f6e 650a 0a20  cation = None.. 
-0000b930: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-0000b940: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
-0000b950: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
-0000b960: 7320 3d20 2222 220a 2020 2020 2020 2020  s = """.        
-0000b970: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
-0000b980: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
-0000b990: 4e61 6d65 3a3c 2f62 3e20 406e 616d 6573  Name:</b> @names
-0000b9a0: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000b9b0: 2020 2020 203c 703e 3c62 3e54 696d 653a       <p><b>Time:
-0000b9c0: 3c2f 623e 2040 666f 726d 6174 7465 645f  </b> @formatted_
-0000b9d0: 7469 6d65 3c2f 703e 0a20 2020 2020 2020  time</p>.       
-0000b9e0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-0000b9f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000ba00: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
-0000ba10: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
-0000ba20: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
-0000ba30: 6669 672e 6164 645f 746f 6f6c 7328 686f  fig.add_tools(ho
-0000ba40: 7665 7229 0a0a 2020 2020 2020 2020 6669  ver)..        fi
-0000ba50: 672e 6164 645f 6c61 796f 7574 280a 2020  g.add_layout(.  
-0000ba60: 2020 2020 2020 2020 2020 5469 746c 6528            Title(
-0000ba70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ba80: 2074 6578 743d 224e 6f74 653a 2074 6173   text="Note: tas
-0000ba90: 6b73 206c 6573 7320 7468 616e 2032 2520  ks less than 2% 
-0000baa0: 6f66 206d 6178 2061 7265 206e 6f74 2064  of max are not d
-0000bab0: 6973 706c 6179 6564 222c 0a20 2020 2020  isplayed",.     
-0000bac0: 2020 2020 2020 2020 2020 2074 6578 745f             text_
-0000bad0: 666f 6e74 5f73 7479 6c65 3d22 6974 616c  font_style="ital
-0000bae0: 6963 222c 0a20 2020 2020 2020 2020 2020  ic",.           
-0000baf0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0000bb00: 2262 656c 6f77 222c 0a20 2020 2020 2020  "below",.       
-0000bb10: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-0000bb20: 2e66 6967 203d 2066 6967 0a20 2020 2020  .fig = fig.     
-0000bb30: 2020 2074 6162 3120 3d20 5461 6250 616e     tab1 = TabPan
-0000bb40: 656c 2863 6869 6c64 3d66 6967 2c20 7469  el(child=fig, ti
-0000bb50: 746c 653d 2242 6172 2043 6861 7274 2229  tle="Bar Chart")
-0000bb60: 0a0a 2020 2020 2020 2020 6669 6732 203d  ..        fig2 =
-0000bb70: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-0000bb80: 2020 2020 2074 6974 6c65 3d22 436f 6d70       title="Comp
-0000bb90: 7574 6520 5469 6d65 2050 6572 2054 6173  ute Time Per Tas
-0000bba0: 6b22 2c0a 2020 2020 2020 2020 2020 2020  k",.            
-0000bbb0: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0000bbc0: 2020 2020 2020 6e61 6d65 3d22 636f 6d70        name="comp
-0000bbd0: 7574 655f 7469 6d65 5f70 6572 5f6b 6579  ute_time_per_key
-0000bbe0: 2d70 6965 222c 0a20 2020 2020 2020 2020  -pie",.         
-0000bbf0: 2020 2078 5f72 616e 6765 3d28 2d30 2e35     x_range=(-0.5
-0000bc00: 2c20 312e 3029 2c0a 2020 2020 2020 2020  , 1.0),.        
-0000bc10: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0000bc20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000bc30: 2066 6967 322e 7765 6467 6528 0a20 2020   fig2.wedge(.   
-0000bc40: 2020 2020 2020 2020 2078 3d30 2c0a 2020           x=0,.  
-0000bc50: 2020 2020 2020 2020 2020 793d 312c 0a20            y=1,. 
-0000bc60: 2020 2020 2020 2020 2020 2072 6164 6975             radiu
-0000bc70: 733d 302e 342c 0a20 2020 2020 2020 2020  s=0.4,.         
-0000bc80: 2020 2073 7461 7274 5f61 6e67 6c65 3d63     start_angle=c
-0000bc90: 756d 7375 6d28 2261 6e67 6c65 7322 2c20  umsum("angles", 
-0000bca0: 696e 636c 7564 655f 7a65 726f 3d54 7275  include_zero=Tru
-0000bcb0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000bcc0: 656e 645f 616e 676c 653d 6375 6d73 756d  end_angle=cumsum
-0000bcd0: 2822 616e 676c 6573 2229 2c0a 2020 2020  ("angles"),.    
-0000bce0: 2020 2020 2020 2020 6c69 6e65 5f63 6f6c          line_col
-0000bcf0: 6f72 3d22 7768 6974 6522 2c0a 2020 2020  or="white",.    
-0000bd00: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
-0000bd10: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
-0000bd20: 2020 2020 2020 2020 6c65 6765 6e64 5f66          legend_f
-0000bd30: 6965 6c64 3d22 6e61 6d65 7322 2c0a 2020  ield="names",.  
-0000bd40: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0000bd50: 3d73 656c 662e 636f 6d70 7574 655f 736f  =self.compute_so
-0000bd60: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
-0000bd70: 0a20 2020 2020 2020 2066 6967 322e 6178  .        fig2.ax
-0000bd80: 6973 2e61 7869 735f 6c61 6265 6c20 3d20  is.axis_label = 
-0000bd90: 4e6f 6e65 0a20 2020 2020 2020 2066 6967  None.        fig
-0000bda0: 322e 6178 6973 2e76 6973 6962 6c65 203d  2.axis.visible =
-0000bdb0: 2046 616c 7365 0a20 2020 2020 2020 2066   False.        f
-0000bdc0: 6967 322e 6772 6964 2e67 7269 645f 6c69  ig2.grid.grid_li
-0000bdd0: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
-0000bde0: 2020 2020 2020 2020 6669 6732 2e61 6464          fig2.add
-0000bdf0: 5f6c 6179 6f75 7428 0a20 2020 2020 2020  _layout(.       
-0000be00: 2020 2020 2054 6974 6c65 280a 2020 2020       Title(.    
-0000be10: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0000be20: 3d22 4e6f 7465 3a20 7461 736b 7320 6c65  ="Note: tasks le
-0000be30: 7373 2074 6861 6e20 3225 206f 6620 6d61  ss than 2% of ma
-0000be40: 7820 6172 6520 6e6f 7420 6469 7370 6c61  x are not displa
-0000be50: 7965 6422 2c0a 2020 2020 2020 2020 2020  yed",.          
-0000be60: 2020 2020 2020 7465 7874 5f66 6f6e 745f        text_font_
-0000be70: 7374 796c 653d 2269 7461 6c69 6322 2c0a  style="italic",.
-0000be80: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0000be90: 2020 2020 2020 2020 2020 2022 6265 6c6f             "belo
-0000bea0: 7722 2c0a 2020 2020 2020 2020 290a 0a20  w",.        ).. 
-0000beb0: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-0000bec0: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
-0000bed0: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
-0000bee0: 7320 3d20 2222 220a 2020 2020 2020 2020  s = """.        
-0000bef0: 2020 2020 3c64 6976 3e0a 2020 2020 2020      <div>.      
-0000bf00: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
-0000bf10: 4e61 6d65 3a3c 2f62 3e20 406e 616d 6573  Name:</b> @names
-0000bf20: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000bf30: 2020 2020 203c 703e 3c62 3e54 696d 653a       <p><b>Time:
-0000bf40: 3c2f 623e 2040 666f 726d 6174 7465 645f  </b> @formatted_
-0000bf50: 7469 6d65 3c2f 703e 0a20 2020 2020 2020  time</p>.       
-0000bf60: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-0000bf70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000bf80: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
-0000bf90: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
-0000bfa0: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
-0000bfb0: 6669 6732 2e61 6464 5f74 6f6f 6c73 2868  fig2.add_tools(h
-0000bfc0: 6f76 6572 290a 2020 2020 2020 2020 7365  over).        se
-0000bfd0: 6c66 2e77 6564 6765 5f66 6967 203d 2066  lf.wedge_fig = f
-0000bfe0: 6967 320a 2020 2020 2020 2020 7461 6232  ig2.        tab2
-0000bff0: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
-0000c000: 643d 6669 6732 2c20 7469 746c 653d 2250  d=fig2, title="P
-0000c010: 6965 2043 6861 7274 2229 0a0a 2020 2020  ie Chart")..    
-0000c020: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
-0000c030: 5461 6273 2874 6162 733d 5b74 6162 312c  Tabs(tabs=[tab1,
-0000c040: 2074 6162 325d 2c20 7369 7a69 6e67 5f6d   tab2], sizing_m
-0000c050: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-0000c060: 6822 290a 0a20 2020 2040 7769 7468 6f75  h")..    @withou
-0000c070: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
-0000c080: 6174 696f 6e0a 2020 2020 406c 6f67 5f65  ation.    @log_e
-0000c090: 7272 6f72 730a 2020 2020 6465 6620 7570  rrors.    def up
-0000c0a0: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
-0000c0b0: 2020 2020 636f 6d70 7574 655f 7469 6d65      compute_time
-0000c0c0: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-0000c0d0: 666c 6f61 7429 0a0a 2020 2020 2020 2020  float)..        
-0000c0e0: 666f 7220 6b65 792c 2074 7320 696e 2073  for key, ts in s
-0000c0f0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-0000c100: 736b 5f70 7265 6669 7865 732e 6974 656d  sk_prefixes.item
-0000c110: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000c120: 206e 616d 6520 3d20 6b65 795f 7370 6c69   name = key_spli
-0000c130: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
-0000c140: 2020 2066 6f72 2061 6374 696f 6e2c 2074     for action, t
-0000c150: 2069 6e20 7473 2e61 6c6c 5f64 7572 6174   in ts.all_durat
-0000c160: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-0000c170: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000c180: 2061 6374 696f 6e20 3d3d 2022 636f 6d70   action == "comp
-0000c190: 7574 6522 3a0a 2020 2020 2020 2020 2020  ute":.          
-0000c1a0: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-0000c1b0: 655f 7469 6d65 735b 6e61 6d65 5d20 2b3d  e_times[name] +=
-0000c1c0: 2074 0a0a 2020 2020 2020 2020 2320 6f72   t..        # or
-0000c1d0: 6465 7220 6279 206c 6172 6765 7374 2074  der by largest t
-0000c1e0: 696d 6520 6669 7273 740a 2020 2020 2020  ime first.      
-0000c1f0: 2020 636f 6d70 7574 655f 7469 6d65 7320    compute_times 
-0000c200: 3d20 736f 7274 6564 2863 6f6d 7075 7465  = sorted(compute
-0000c210: 5f74 696d 6573 2e69 7465 6d73 2829 2c20  _times.items(), 
-0000c220: 6b65 793d 6c61 6d62 6461 2078 3a20 785b  key=lambda x: x[
-0000c230: 315d 2c20 7265 7665 7273 653d 5472 7565  1], reverse=True
-0000c240: 290a 0a20 2020 2020 2020 2023 206b 6565  )..        # kee
-0000c250: 7020 6f6e 6c79 2074 696d 6520 7768 6963  p only time whic
-0000c260: 6820 6172 6520 3225 206f 6620 6d61 7820  h are 2% of max 
-0000c270: 6f72 2067 7265 6174 6572 0a20 2020 2020  or greater.     
-0000c280: 2020 2069 6620 636f 6d70 7574 655f 7469     if compute_ti
-0000c290: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
-0000c2a0: 206d 6178 5f74 696d 6520 3d20 636f 6d70   max_time = comp
-0000c2b0: 7574 655f 7469 6d65 735b 305d 5b31 5d20  ute_times[0][1] 
-0000c2c0: 2a20 302e 3032 0a20 2020 2020 2020 2020  * 0.02.         
-0000c2d0: 2020 2063 6f6d 7075 7465 5f74 696d 6573     compute_times
-0000c2e0: 203d 205b 286e 2c20 7429 2066 6f72 206e   = [(n, t) for n
-0000c2f0: 2c20 7420 696e 2063 6f6d 7075 7465 5f74  , t in compute_t
-0000c300: 696d 6573 2069 6620 7420 3e20 6d61 785f  imes if t > max_
-0000c310: 7469 6d65 5d0a 2020 2020 2020 2020 2020  time].          
-0000c320: 2020 636f 6d70 7574 655f 636f 6c6f 7273    compute_colors
-0000c330: 203d 206c 6973 7428 290a 2020 2020 2020   = list().      
-0000c340: 2020 2020 2020 636f 6d70 7574 655f 6e61        compute_na
-0000c350: 6d65 7320 3d20 6c69 7374 2829 0a20 2020  mes = list().   
-0000c360: 2020 2020 2020 2020 2063 6f6d 7075 7465           compute
-0000c370: 5f74 696d 6520 3d20 6c69 7374 2829 0a20  _time = list(). 
-0000c380: 2020 2020 2020 2020 2020 2074 6f74 616c             total
-0000c390: 5f74 696d 6520 3d20 300a 2020 2020 2020  _time = 0.      
-0000c3a0: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
-0000c3b0: 7420 696e 2063 6f6d 7075 7465 5f74 696d  t in compute_tim
-0000c3c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000c3d0: 2020 2020 636f 6d70 7574 655f 6e61 6d65      compute_name
-0000c3e0: 732e 6170 7065 6e64 286e 616d 6529 0a20  s.append(name). 
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c400: 6f6d 7075 7465 5f63 6f6c 6f72 732e 6170  ompute_colors.ap
-0000c410: 7065 6e64 2874 735f 636f 6c6f 725f 6f66  pend(ts_color_of
-0000c420: 286e 616d 6529 290a 2020 2020 2020 2020  (name)).        
-0000c430: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
-0000c440: 7469 6d65 2e61 7070 656e 6428 7429 0a20  time.append(t). 
-0000c450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000c460: 6f74 616c 5f74 696d 6520 2b3d 2074 0a0a  otal_time += t..
-0000c470: 2020 2020 2020 2020 2020 2020 616e 676c              angl
-0000c480: 6573 203d 205b 7420 2f20 746f 7461 6c5f  es = [t / total_
-0000c490: 7469 6d65 202a 2032 202a 206d 6174 682e  time * 2 * math.
-0000c4a0: 7069 2066 6f72 2074 2069 6e20 636f 6d70  pi for t in comp
-0000c4b0: 7574 655f 7469 6d65 5d0a 0a20 2020 2020  ute_time]..     
-0000c4c0: 2020 2020 2020 2073 656c 662e 6669 672e         self.fig.
-0000c4d0: 785f 7261 6e67 652e 6661 6374 6f72 7320  x_range.factors 
-0000c4e0: 3d20 636f 6d70 7574 655f 6e61 6d65 730a  = compute_names.
-0000c4f0: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
-0000c500: 7075 7465 5f72 6573 756c 7420 3d20 6469  pute_result = di
-0000c510: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0000c520: 2020 2020 616e 676c 6573 3d61 6e67 6c65      angles=angle
-0000c530: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0000c540: 2020 2074 696d 6573 3d63 6f6d 7075 7465     times=compute
-0000c550: 5f74 696d 652c 0a20 2020 2020 2020 2020  _time,.         
-0000c560: 2020 2020 2020 2063 6f6c 6f72 3d63 6f6d         color=com
-0000c570: 7075 7465 5f63 6f6c 6f72 732c 0a20 2020  pute_colors,.   
-0000c580: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-0000c590: 6573 3d63 6f6d 7075 7465 5f6e 616d 6573  es=compute_names
+00007730: 6477 6964 7468 223a 205b 312c 2032 5d2c  dwidth": [1, 2],
+00007740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007750: 2022 6261 6e64 7769 6474 682d 6861 6c66   "bandwidth-half
+00007760: 223a 205b 302e 352c 2031 5d2c 0a20 2020  ": [0.5, 1],.   
+00007770: 2020 2020 2020 2020 2020 2020 2022 7479               "ty
+00007780: 7065 223a 205b 2261 222c 2022 6222 5d2c  pe": ["a", "b"],
+00007790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000077a0: 2022 6261 6e64 7769 6474 685f 7465 7874   "bandwidth_text
+000077b0: 223a 205b 2231 222c 2022 3222 5d2c 0a20  ": ["1", "2"],. 
+000077c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000077d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000077e0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
+000077f0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00007800: 7469 746c 653d 2242 616e 6477 6964 7468  title="Bandwidth
+00007810: 2062 7920 5479 7065 222c 0a20 2020 2020   by Type",.     
+00007820: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
+00007830: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+00007840: 653d 2262 616e 6477 6964 7468 5f74 7970  e="bandwidth_typ
+00007850: 655f 6869 7374 6f67 7261 6d22 2c0a 2020  e_histogram",.  
+00007860: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
+00007870: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
+00007880: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00007890: 6773 2c0a 2020 2020 2020 2020 290a 2020  gs,.        ).  
+000078a0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+000078b0: 7861 7869 732e 6d61 6a6f 725f 6c61 6265  xaxis.major_labe
+000078c0: 6c5f 6f72 6965 6e74 6174 696f 6e20 3d20  l_orientation = 
+000078d0: 2d30 2e35 0a20 2020 2020 2020 2072 6563  -0.5.        rec
+000078e0: 7420 3d20 7365 6c66 2e72 6f6f 742e 7265  t = self.root.re
+000078f0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+00007900: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+00007910: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00007920: 783d 2262 616e 6477 6964 7468 2d68 616c  x="bandwidth-hal
+00007930: 6622 2c0a 2020 2020 2020 2020 2020 2020  f",.            
+00007940: 793d 2274 7970 6522 2c0a 2020 2020 2020  y="type",.      
+00007950: 2020 2020 2020 7769 6474 683d 2262 616e        width="ban
+00007960: 6477 6964 7468 222c 0a20 2020 2020 2020  dwidth",.       
+00007970: 2020 2020 2068 6569 6768 743d 302e 392c       height=0.9,
+00007980: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+00007990: 6f72 3d22 626c 7565 222c 0a20 2020 2020  or="blue",.     
+000079a0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+000079b0: 662e 726f 6f74 2e78 5f72 616e 6765 2e73  f.root.x_range.s
+000079c0: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
+000079d0: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+000079e0: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
+000079f0: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
+00007a00: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00007a10: 2062 2229 0a20 2020 2020 2020 2073 656c   b").        sel
+00007a20: 662e 726f 6f74 2e78 6178 6973 2e74 6963  f.root.xaxis.tic
+00007a30: 6b65 7220 3d20 4164 6170 7469 7665 5469  ker = AdaptiveTi
+00007a40: 636b 6572 282a 2a54 4943 4b53 5f31 3032  cker(**TICKS_102
+00007a50: 3429 0a20 2020 2020 2020 2072 6563 742e  4).        rect.
+00007a60: 6e6f 6e73 656c 6563 7469 6f6e 5f67 6c79  nonselection_gly
+00007a70: 7068 203d 204e 6f6e 650a 0a20 2020 2020  ph = None..     
+00007a80: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00007a90: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+00007aa0: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+00007ab0: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00007ac0: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
+00007ad0: 616c 7365 0a0a 2020 2020 2020 2020 7365  alse..        se
+00007ae0: 6c66 2e72 6f6f 742e 746f 6f6c 6261 725f  lf.root.toolbar_
+00007af0: 6c6f 6361 7469 6f6e 203d 204e 6f6e 650a  location = None.
+00007b00: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
+00007b10: 2048 6f76 6572 546f 6f6c 2829 0a20 2020   HoverTool().   
+00007b20: 2020 2020 2068 6f76 6572 2e74 6f6f 6c74       hover.toolt
+00007b30: 6970 7320 3d20 2240 7479 7065 3a20 4062  ips = "@type: @b
+00007b40: 616e 6477 6964 7468 5f74 6578 7420 2f20  andwidth_text / 
+00007b50: 7322 0a20 2020 2020 2020 2068 6f76 6572  s".        hover
+00007b60: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
+00007b70: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
+00007b80: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00007b90: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
+00007ba0: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+00007bb0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+00007bc0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+00007bd0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+00007be0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00007bf0: 2020 6277 203d 2073 656c 662e 7363 6865    bw = self.sche
+00007c00: 6475 6c65 722e 6261 6e64 7769 6474 685f  duler.bandwidth_
+00007c10: 7479 7065 730a 2020 2020 2020 2020 7365  types.        se
+00007c20: 6c66 2e72 6f6f 742e 795f 7261 6e67 652e  lf.root.y_range.
+00007c30: 6661 6374 6f72 7320 3d20 6c69 7374 2873  factors = list(s
+00007c40: 6f72 7465 6428 6277 2929 0a20 2020 2020  orted(bw)).     
+00007c50: 2020 2072 6573 756c 7420 3d20 7b0a 2020     result = {.  
+00007c60: 2020 2020 2020 2020 2020 2262 616e 6477            "bandw
+00007c70: 6964 7468 223a 206c 6973 7428 6277 2e76  idth": list(bw.v
+00007c80: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
+00007c90: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+00007ca0: 2d68 616c 6622 3a20 5b62 202f 2032 2066  -half": [b / 2 f
+00007cb0: 6f72 2062 2069 6e20 6277 2e76 616c 7565  or b in bw.value
+00007cc0: 7328 295d 2c0a 2020 2020 2020 2020 2020  s()],.          
+00007cd0: 2020 2274 7970 6522 3a20 6c69 7374 2862    "type": list(b
+00007ce0: 772e 6b65 7973 2829 292c 0a20 2020 2020  w.keys()),.     
+00007cf0: 2020 2020 2020 2022 6261 6e64 7769 6474         "bandwidt
+00007d00: 685f 7465 7874 223a 205b 666f 726d 6174  h_text": [format
+00007d10: 5f62 7974 6573 2878 2920 666f 7220 7820  _bytes(x) for x 
+00007d20: 696e 2062 772e 7661 6c75 6573 2829 5d2c  in bw.values()],
+00007d30: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00007d40: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
+00007d50: 6c65 2e74 6578 7420 3d20 2242 616e 6477  le.text = "Bandw
+00007d60: 6964 7468 3a20 2220 2b20 666f 726d 6174  idth: " + format
+00007d70: 5f62 7974 6573 2873 656c 662e 7363 6865  _bytes(self.sche
+00007d80: 6475 6c65 722e 6261 6e64 7769 6474 6829  duler.bandwidth)
+00007d90: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
+00007da0: 7365 6c66 2e73 6f75 7263 652c 2072 6573  self.source, res
+00007db0: 756c 7429 0a0a 0a63 6c61 7373 2042 616e  ult)...class Ban
+00007dc0: 6477 6964 7468 576f 726b 6572 7328 4461  dwidthWorkers(Da
+00007dd0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+00007de0: 293a 0a20 2020 2022 2222 486f 7720 6d61  ):.    """How ma
+00007df0: 6e79 2074 6173 6b73 2061 7265 206f 6e20  ny tasks are on 
+00007e00: 6561 6368 2077 6f72 6b65 7222 2222 0a0a  each worker"""..
+00007e10: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00007e20: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00007e30: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
+00007e40: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00007e50: 2020 2020 2073 656c 662e 6c61 7374 203d       self.last =
+00007e60: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00007e70: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
+00007e80: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
+00007e90: 6c66 2e73 6f75 7263 6520 3d20 436f 6c75  lf.source = Colu
+00007ea0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
+00007eb0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00007ec0: 2020 2020 2020 2020 2020 2020 2262 616e              "ban
+00007ed0: 6477 6964 7468 223a 205b 312c 2032 5d2c  dwidth": [1, 2],
+00007ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007ef0: 2022 736f 7572 6365 223a 205b 2261 222c   "source": ["a",
+00007f00: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
+00007f10: 2020 2020 2020 2022 6465 7374 696e 6174         "destinat
+00007f20: 696f 6e22 3a20 5b22 6122 2c20 2262 225d  ion": ["a", "b"]
+00007f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007f40: 2020 2262 616e 6477 6964 7468 5f74 6578    "bandwidth_tex
+00007f50: 7422 3a20 5b22 3122 2c20 2232 225d 2c0a  t": ["1", "2"],.
+00007f60: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00007f70: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00007f80: 2076 616c 7565 7320 3d20 5b68 6578 2878   values = [hex(x
+00007f90: 295b 323a 5d20 666f 7220 7820 696e 2072  )[2:] for x in r
+00007fa0: 616e 6765 2836 342c 2032 3536 295d 5b3a  ange(64, 256)][:
+00007fb0: 3a2d 315d 0a20 2020 2020 2020 206d 6170  :-1].        map
+00007fc0: 7065 7220 3d20 6c69 6e65 6172 5f63 6d61  per = linear_cma
+00007fd0: 7028 0a20 2020 2020 2020 2020 2020 2066  p(.            f
+00007fe0: 6965 6c64 5f6e 616d 653d 2262 616e 6477  ield_name="bandw
+00007ff0: 6964 7468 222c 0a20 2020 2020 2020 2020  idth",.         
+00008000: 2020 2070 616c 6574 7465 3d5b 2223 2220     palette=["#" 
+00008010: 2b20 7820 2b20 7820 2b20 2246 4622 2066  + x + x + "FF" f
+00008020: 6f72 2078 2069 6e20 7661 6c75 6573 5d2c  or x in values],
+00008030: 0a20 2020 2020 2020 2020 2020 206c 6f77  .            low
+00008040: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+00008050: 6869 6768 3d31 2c0a 2020 2020 2020 2020  high=1,.        
+00008060: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00008070: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
+00008080: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+00008090: 3d22 4261 6e64 7769 6474 6820 6279 2057  ="Bandwidth by W
+000080a0: 6f72 6b65 7222 2c0a 2020 2020 2020 2020  orker",.        
+000080b0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
+000080c0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+000080d0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+000080e0: 5f68 6561 746d 6170 222c 0a20 2020 2020  _heatmap",.     
+000080f0: 2020 2020 2020 2078 5f72 616e 6765 3d5b         x_range=[
+00008100: 2261 222c 2022 6222 5d2c 0a20 2020 2020  "a", "b"],.     
+00008110: 2020 2020 2020 2079 5f72 616e 6765 3d5b         y_range=[
+00008120: 2261 222c 2022 6222 5d2c 0a20 2020 2020  "a", "b"],.     
+00008130: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+00008140: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00008150: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+00008160: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
+00008170: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
+00008180: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
+00008190: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+000081a0: 742e 7265 6374 280a 2020 2020 2020 2020  t.rect(.        
+000081b0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+000081c0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+000081d0: 2020 2020 783d 2273 6f75 7263 6522 2c0a      x="source",.
+000081e0: 2020 2020 2020 2020 2020 2020 793d 2264              y="d
+000081f0: 6573 7469 6e61 7469 6f6e 222c 0a20 2020  estination",.   
+00008200: 2020 2020 2020 2020 2063 6f6c 6f72 3d6d           color=m
+00008210: 6170 7065 722c 0a20 2020 2020 2020 2020  apper,.         
+00008220: 2020 2068 6569 6768 743d 312c 0a20 2020     height=1,.   
+00008230: 2020 2020 2020 2020 2077 6964 7468 3d31           width=1
+00008240: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00008250: 2020 2020 2073 656c 662e 636f 6c6f 725f       self.color_
+00008260: 6d61 7020 3d20 6d61 7070 6572 5b22 7472  map = mapper["tr
+00008270: 616e 7366 6f72 6d22 5d0a 2020 2020 2020  ansform"].      
+00008280: 2020 636f 6c6f 725f 6261 7220 3d20 436f    color_bar = Co
+00008290: 6c6f 7242 6172 280a 2020 2020 2020 2020  lorBar(.        
+000082a0: 2020 2020 636f 6c6f 725f 6d61 7070 6572      color_mapper
+000082b0: 3d73 656c 662e 636f 6c6f 725f 6d61 702c  =self.color_map,
+000082c0: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
+000082d0: 656c 5f73 7461 6e64 6f66 663d 3132 2c0a  el_standoff=12,.
+000082e0: 2020 2020 2020 2020 2020 2020 626f 7264              bord
+000082f0: 6572 5f6c 696e 655f 636f 6c6f 723d 4e6f  er_line_color=No
+00008300: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00008310: 6c6f 6361 7469 6f6e 3d28 302c 2030 292c  location=(0, 0),
+00008320: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00008330: 2020 2063 6f6c 6f72 5f62 6172 2e66 6f72     color_bar.for
+00008340: 6d61 7474 6572 203d 204e 756d 6572 616c  matter = Numeral
+00008350: 5469 636b 466f 726d 6174 7465 7228 666f  TickFormatter(fo
+00008360: 726d 6174 3d22 302e 3020 6222 290a 2020  rmat="0.0 b").  
+00008370: 2020 2020 2020 636f 6c6f 725f 6261 722e        color_bar.
+00008380: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
+00008390: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
+000083a0: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
+000083b0: 6c66 2e72 6f6f 742e 6164 645f 6c61 796f  lf.root.add_layo
+000083c0: 7574 2863 6f6c 6f72 5f62 6172 2c20 2272  ut(color_bar, "r
+000083d0: 6967 6874 2229 0a0a 2020 2020 2020 2020  ight")..        
+000083e0: 7365 6c66 2e72 6f6f 742e 746f 6f6c 6261  self.root.toolba
+000083f0: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
+00008400: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
+00008410: 203d 2048 6f76 6572 546f 6f6c 2829 0a20   = HoverTool(). 
+00008420: 2020 2020 2020 2068 6f76 6572 2e74 6f6f         hover.too
+00008430: 6c74 6970 7320 3d20 2222 220a 2020 2020  ltips = """.    
+00008440: 2020 2020 2020 2020 3c64 6976 3e0a 2020          <div>.  
+00008450: 2020 2020 2020 2020 2020 2020 2020 3c70                <p
+00008460: 3e3c 623e 536f 7572 6365 3a3c 2f62 3e20  ><b>Source:</b> 
+00008470: 4073 6f75 7263 6520 3c2f 703e 0a20 2020  @source </p>.   
+00008480: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
+00008490: 3c62 3e44 6573 7469 6e61 7469 6f6e 3a3c  <b>Destination:<
+000084a0: 2f62 3e20 4064 6573 7469 6e61 7469 6f6e  /b> @destination
+000084b0: 203c 2f70 3e0a 2020 2020 2020 2020 2020   </p>.          
+000084c0: 2020 2020 2020 3c70 3e3c 623e 4261 6e64        <p><b>Band
+000084d0: 7769 6474 683a 3c2f 623e 2040 6261 6e64  width:</b> @band
+000084e0: 7769 6474 685f 7465 7874 202f 2073 3c2f  width_text / s</
+000084f0: 703e 0a20 2020 2020 2020 2020 2020 203c  p>.            <
+00008500: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00008510: 2020 2222 220a 2020 2020 2020 2020 686f    """.        ho
+00008520: 7665 722e 706f 696e 745f 706f 6c69 6379  ver.point_policy
+00008530: 203d 2022 666f 6c6c 6f77 5f6d 6f75 7365   = "follow_mouse
+00008540: 220a 2020 2020 2020 2020 7365 6c66 2e72  ".        self.r
+00008550: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
+00008560: 7665 7229 0a0a 2020 2020 4077 6974 686f  ver)..    @witho
+00008570: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00008580: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+00008590: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+000085a0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+000085b0: 2020 2020 2062 7720 3d20 7365 6c66 2e73       bw = self.s
+000085c0: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
+000085d0: 7468 5f77 6f72 6b65 7273 0a20 2020 2020  th_workers.     
+000085e0: 2020 2069 6620 6e6f 7420 6277 3a0a 2020     if not bw:.  
+000085f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00008600: 0a0a 2020 2020 2020 2020 6465 6620 6e61  ..        def na
+00008610: 6d65 2861 6464 7265 7373 293a 0a20 2020  me(address):.   
+00008620: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00008630: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00008640: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+00008650: 722e 776f 726b 6572 735b 6164 6472 6573  r.workers[addres
+00008660: 735d 0a20 2020 2020 2020 2020 2020 2065  s].            e
+00008670: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
+00008680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008690: 7265 7475 726e 2061 6464 7265 7373 0a20  return address. 
+000086a0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
+000086b0: 2e6e 616d 6520 6973 206e 6f74 204e 6f6e  .name is not Non
+000086c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000086d0: 2020 2072 6574 7572 6e20 7374 7228 7773     return str(ws
+000086e0: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
+000086f0: 2020 2072 6574 7572 6e20 6164 6472 6573     return addres
+00008700: 730a 0a20 2020 2020 2020 2078 2c20 792c  s..        x, y,
+00008710: 2076 616c 7565 203d 207a 6970 282a 2828   value = zip(*((
+00008720: 6e61 6d65 2861 292c 206e 616d 6528 6229  name(a), name(b)
+00008730: 2c20 6329 2066 6f72 2028 612c 2062 292c  , c) for (a, b),
+00008740: 2063 2069 6e20 6277 2e69 7465 6d73 2829   c in bw.items()
+00008750: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+00008760: 2e63 6f6c 6f72 5f6d 6170 2e68 6967 6820  .color_map.high 
+00008770: 3d20 6d61 7828 7661 6c75 6529 0a0a 2020  = max(value)..  
+00008780: 2020 2020 2020 6661 6374 6f72 7320 3d20        factors = 
+00008790: 6c69 7374 2873 6f72 7465 6428 7365 7428  list(sorted(set(
+000087a0: 7820 2b20 7929 2929 0a20 2020 2020 2020  x + y))).       
+000087b0: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
+000087c0: 6765 2e66 6163 746f 7273 203d 2066 6163  ge.factors = fac
+000087d0: 746f 7273 0a20 2020 2020 2020 2073 656c  tors.        sel
+000087e0: 662e 726f 6f74 2e79 5f72 616e 6765 2e66  f.root.y_range.f
+000087f0: 6163 746f 7273 203d 2066 6163 746f 7273  actors = factors
+00008800: 5b3a 3a2d 315d 0a0a 2020 2020 2020 2020  [::-1]..        
+00008810: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
+00008820: 2020 2020 2020 2022 736f 7572 6365 223a         "source":
+00008830: 2078 2c0a 2020 2020 2020 2020 2020 2020   x,.            
+00008840: 2264 6573 7469 6e61 7469 6f6e 223a 2079  "destination": y
+00008850: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
+00008860: 616e 6477 6964 7468 223a 2076 616c 7565  andwidth": value
+00008870: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
+00008880: 616e 6477 6964 7468 5f74 6578 7422 3a20  andwidth_text": 
+00008890: 6c69 7374 286d 6170 2866 6f72 6d61 745f  list(map(format_
+000088a0: 6279 7465 732c 2076 616c 7565 2929 2c0a  bytes, value)),.
+000088b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000088c0: 2020 7365 6c66 2e72 6f6f 742e 7469 746c    self.root.titl
+000088d0: 652e 7465 7874 203d 2022 4261 6e64 7769  e.text = "Bandwi
+000088e0: 6474 683a 2022 202b 2066 6f72 6d61 745f  dth: " + format_
+000088f0: 6279 7465 7328 7365 6c66 2e73 6368 6564  bytes(self.sched
+00008900: 756c 6572 2e62 616e 6477 6964 7468 290a  uler.bandwidth).
+00008910: 2020 2020 2020 2020 7570 6461 7465 2873          update(s
+00008920: 656c 662e 736f 7572 6365 2c20 7265 7375  elf.source, resu
+00008930: 6c74 290a 0a0a 636c 6173 7320 576f 726b  lt)...class Work
+00008940: 6572 4e65 7477 6f72 6b42 616e 6477 6964  erNetworkBandwid
+00008950: 7468 2844 6173 6862 6f61 7264 436f 6d70  th(DashboardComp
+00008960: 6f6e 656e 7429 3a0a 2020 2020 2222 2257  onent):.    """W
+00008970: 6f72 6b65 7220 6e65 7477 6f72 6b20 6261  orker network ba
+00008980: 6e64 7769 6474 6820 6368 6172 740a 0a20  ndwidth chart.. 
+00008990: 2020 2050 6c6f 7473 2068 6f72 697a 6f6e     Plots horizon
+000089a0: 7461 6c20 6261 7273 2077 6974 6820 7468  tal bars with th
+000089b0: 6520 686f 7374 5f6e 6574 5f69 6f2e 7265  e host_net_io.re
+000089c0: 6164 5f62 7073 2061 6e64 2068 6f73 745f  ad_bps and host_
+000089d0: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
+000089e0: 2077 6f72 6b65 720a 2020 2020 7374 6174   worker.    stat
+000089f0: 650a 2020 2020 2222 220a 0a20 2020 2040  e.    """..    @
+00008a00: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+00008a10: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00008a20: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00008a30: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00008a40: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+00008a50: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+00008a60: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
+00008a70: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+00008a80: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
+00008a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008aa0: 2022 795f 7265 6164 223a 205b 5d2c 0a20   "y_read": [],. 
+00008ab0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00008ac0: 795f 7772 6974 6522 3a20 5b5d 2c0a 2020  y_write": [],.  
+00008ad0: 2020 2020 2020 2020 2020 2020 2020 2278                "x
+00008ae0: 5f72 6561 6422 3a20 5b5d 2c0a 2020 2020  _read": [],.    
+00008af0: 2020 2020 2020 2020 2020 2020 2278 5f77              "x_w
+00008b00: 7269 7465 223a 205b 5d2c 0a20 2020 2020  rite": [],.     
+00008b10: 2020 2020 2020 2020 2020 2022 785f 7265             "x_re
+00008b20: 6164 5f64 6973 6b22 3a20 5b5d 2c0a 2020  ad_disk": [],.  
+00008b30: 2020 2020 2020 2020 2020 2020 2020 2278                "x
+00008b40: 5f77 7269 7465 5f64 6973 6b22 3a20 5b5d  _write_disk": []
+00008b50: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00008b60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00008b70: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+00008b80: 6820 3d20 6669 6775 7265 280a 2020 2020  h = figure(.    
+00008b90: 2020 2020 2020 2020 7469 746c 653d 2257          title="W
+00008ba0: 6f72 6b65 7220 4e65 7477 6f72 6b20 4261  orker Network Ba
+00008bb0: 6e64 7769 6474 6822 2c0a 2020 2020 2020  ndwidth",.      
+00008bc0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+00008bd0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00008be0: 3d22 776f 726b 6572 5f6e 6574 776f 726b  ="worker_network
+00008bf0: 5f62 616e 6477 6964 7468 222c 0a20 2020  _bandwidth",.   
+00008c00: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00008c10: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00008c20: 2020 2020 2020 2320 686f 7374 5f6e 6574        # host_net
+00008c30: 5f69 6f2e 7265 6164 5f62 7073 0a20 2020  _io.read_bps.   
+00008c40: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+00008c50: 6474 682e 6862 6172 280a 2020 2020 2020  dth.hbar(.      
+00008c60: 2020 2020 2020 793d 2279 5f72 6561 6422        y="y_read"
+00008c70: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
+00008c80: 6768 743d 2278 5f72 6561 6422 2c0a 2020  ght="x_read",.  
+00008c90: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
+00008ca0: 6f6c 6f72 3d4e 6f6e 652c 0a20 2020 2020  olor=None,.     
+00008cb0: 2020 2020 2020 206c 6566 743d 302c 0a20         left=0,. 
+00008cc0: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00008cd0: 743d 302e 352c 0a20 2020 2020 2020 2020  t=0.5,.         
+00008ce0: 2020 2066 696c 6c5f 636f 6c6f 723d 2272     fill_color="r
+00008cf0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00008d00: 206c 6567 656e 645f 6c61 6265 6c3d 2272   legend_label="r
+00008d10: 6561 6422 2c0a 2020 2020 2020 2020 2020  ead",.          
+00008d20: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+00008d30: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
+00008d40: 0a20 2020 2020 2020 2023 2068 6f73 745f  .        # host_
+00008d50: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
+00008d60: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+00008d70: 6e64 7769 6474 682e 6862 6172 280a 2020  ndwidth.hbar(.  
+00008d80: 2020 2020 2020 2020 2020 793d 2279 5f77            y="y_w
+00008d90: 7269 7465 222c 0a20 2020 2020 2020 2020  rite",.         
+00008da0: 2020 2072 6967 6874 3d22 785f 7772 6974     right="x_writ
+00008db0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00008dc0: 6c69 6e65 5f63 6f6c 6f72 3d4e 6f6e 652c  line_color=None,
+00008dd0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
+00008de0: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
+00008df0: 2068 6569 6768 743d 302e 352c 0a20 2020   height=0.5,.   
+00008e00: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+00008e10: 6c6f 723d 2262 6c75 6522 2c0a 2020 2020  lor="blue",.    
+00008e20: 2020 2020 2020 2020 6c65 6765 6e64 5f6c          legend_l
+00008e30: 6162 656c 3d22 7772 6974 6522 2c0a 2020  abel="write",.  
+00008e40: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00008e50: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+00008e60: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00008e70: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
+00008e80: 6178 6973 5b30 5d2e 7469 636b 6572 203d  axis[0].ticker =
+00008e90: 2042 6173 6963 5469 636b 6572 282a 2a54   BasicTicker(**T
+00008ea0: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
+00008eb0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+00008ec0: 682e 7861 7869 735b 305d 2e66 6f72 6d61  h.xaxis[0].forma
+00008ed0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
+00008ee0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
+00008ef0: 6174 3d22 302e 3020 6222 290a 2020 2020  at="0.0 b").    
+00008f00: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+00008f10: 7468 2e78 6178 6973 2e6d 616a 6f72 5f6c  th.xaxis.major_l
+00008f20: 6162 656c 5f6f 7269 656e 7461 7469 6f6e  abel_orientation
+00008f30: 203d 2058 4c41 4245 4c5f 4f52 4945 4e54   = XLABEL_ORIENT
+00008f40: 4154 494f 4e0a 2020 2020 2020 2020 7365  ATION.        se
+00008f50: 6c66 2e62 616e 6477 6964 7468 2e78 6178  lf.bandwidth.xax
+00008f60: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+00008f70: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+00008f80: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+00008f90: 6474 682e 785f 7261 6e67 6520 3d20 5261  dth.x_range = Ra
+00008fa0: 6e67 6531 6428 7374 6172 743d 3029 0a20  nge1d(start=0). 
+00008fb0: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00008fc0: 7769 6474 682e 7961 7869 732e 7669 7369  width.yaxis.visi
+00008fd0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+00008fe0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+00008ff0: 7468 2e79 6772 6964 2e76 6973 6962 6c65  th.ygrid.visible
+00009000: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00009010: 2073 656c 662e 6261 6e64 7769 6474 682e   self.bandwidth.
+00009020: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+00009030: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00009040: 2073 656c 662e 6469 736b 203d 2066 6967   self.disk = fig
+00009050: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+00009060: 2074 6974 6c65 3d22 576f 726b 6572 7320   title="Workers 
+00009070: 4469 736b 222c 0a20 2020 2020 2020 2020  Disk",.         
+00009080: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
+00009090: 2020 2020 2020 2020 206e 616d 653d 2277           name="w
+000090a0: 6f72 6b65 725f 6469 736b 222c 0a20 2020  orker_disk",.   
+000090b0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+000090c0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+000090d0: 2020 2020 2020 2320 686f 7374 5f64 6973        # host_dis
+000090e0: 6b5f 696f 2e72 6561 645f 6270 730a 2020  k_io.read_bps.  
+000090f0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+00009100: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
+00009110: 2020 793d 2279 5f72 6561 6422 2c0a 2020    y="y_read",.  
+00009120: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+00009130: 2278 5f72 6561 645f 6469 736b 222c 0a20  "x_read_disk",. 
+00009140: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+00009150: 636f 6c6f 723d 4e6f 6e65 2c0a 2020 2020  color=None,.    
+00009160: 2020 2020 2020 2020 6c65 6674 3d30 2c0a          left=0,.
+00009170: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00009180: 6874 3d30 2e35 2c0a 2020 2020 2020 2020  ht=0.5,.        
+00009190: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+000091a0: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+000091b0: 2020 6c65 6765 6e64 5f6c 6162 656c 3d22    legend_label="
+000091c0: 7265 6164 222c 0a20 2020 2020 2020 2020  read",.         
+000091d0: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
+000091e0: 6f75 7263 652c 0a20 2020 2020 2020 2029  ource,.        )
+000091f0: 0a0a 2020 2020 2020 2020 2320 686f 7374  ..        # host
+00009200: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
+00009210: 7073 0a20 2020 2020 2020 2073 656c 662e  ps.        self.
+00009220: 6469 736b 2e68 6261 7228 0a20 2020 2020  disk.hbar(.     
+00009230: 2020 2020 2020 2079 3d22 795f 7772 6974         y="y_writ
+00009240: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00009250: 7269 6768 743d 2278 5f77 7269 7465 5f64  right="x_write_d
+00009260: 6973 6b22 2c0a 2020 2020 2020 2020 2020  isk",.          
+00009270: 2020 6c69 6e65 5f63 6f6c 6f72 3d4e 6f6e    line_color=Non
+00009280: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
+00009290: 6566 743d 302c 0a20 2020 2020 2020 2020  eft=0,.         
+000092a0: 2020 2068 6569 6768 743d 302e 352c 0a20     height=0.5,. 
+000092b0: 2020 2020 2020 2020 2020 2066 696c 6c5f             fill_
+000092c0: 636f 6c6f 723d 2262 6c75 6522 2c0a 2020  color="blue",.  
+000092d0: 2020 2020 2020 2020 2020 6c65 6765 6e64            legend
+000092e0: 5f6c 6162 656c 3d22 7772 6974 6522 2c0a  _label="write",.
+000092f0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00009300: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+00009310: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00009320: 2020 2073 656c 662e 6469 736b 2e61 7869     self.disk.axi
+00009330: 735b 305d 2e74 6963 6b65 7220 3d20 4261  s[0].ticker = Ba
+00009340: 7369 6354 6963 6b65 7228 2a2a 5449 434b  sicTicker(**TICK
+00009350: 535f 3130 3234 290a 2020 2020 2020 2020  S_1024).        
+00009360: 7365 6c66 2e64 6973 6b2e 7861 7869 735b  self.disk.xaxis[
+00009370: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
+00009380: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
+00009390: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
+000093a0: 6222 290a 2020 2020 2020 2020 7365 6c66  b").        self
+000093b0: 2e64 6973 6b2e 7861 7869 732e 6d61 6a6f  .disk.xaxis.majo
+000093c0: 725f 6c61 6265 6c5f 6f72 6965 6e74 6174  r_label_orientat
+000093d0: 696f 6e20 3d20 584c 4142 454c 5f4f 5249  ion = XLABEL_ORI
+000093e0: 454e 5441 5449 4f4e 0a20 2020 2020 2020  ENTATION.       
+000093f0: 2073 656c 662e 6469 736b 2e78 6178 6973   self.disk.xaxis
+00009400: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
+00009410: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
+00009420: 2020 2073 656c 662e 6469 736b 2e78 5f72     self.disk.x_r
+00009430: 616e 6765 203d 2052 616e 6765 3164 2873  ange = Range1d(s
+00009440: 7461 7274 3d30 290a 2020 2020 2020 2020  tart=0).        
+00009450: 7365 6c66 2e64 6973 6b2e 7961 7869 732e  self.disk.yaxis.
+00009460: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00009470: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+00009480: 6b2e 7967 7269 642e 7669 7369 626c 6520  k.ygrid.visible 
+00009490: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000094a0: 7365 6c66 2e64 6973 6b2e 746f 6f6c 6261  self.disk.toolba
+000094b0: 725f 6c6f 6361 7469 6f6e 203d 204e 6f6e  r_location = Non
+000094c0: 650a 0a20 2020 2040 7769 7468 6f75 745f  e..    @without_
+000094d0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+000094e0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+000094f0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+00009500: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00009510: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
+00009520: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+00009530: 7273 2e76 616c 7565 7328 290a 0a20 2020  rs.values()..   
+00009540: 2020 2020 2068 203d 2030 2e31 0a20 2020       h = 0.1.   
+00009550: 2020 2020 2079 5f72 6561 6420 3d20 5b69       y_read = [i
+00009560: 202b 2030 2e37 3520 2b20 6920 2a20 6820   + 0.75 + i * h 
+00009570: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+00009580: 656e 2877 6f72 6b65 7273 2929 5d0a 2020  en(workers))].  
+00009590: 2020 2020 2020 795f 7772 6974 6520 3d20        y_write = 
+000095a0: 5b69 202b 2030 2e32 3520 2b20 6920 2a20  [i + 0.25 + i * 
+000095b0: 6820 666f 7220 6920 696e 2072 616e 6765  h for i in range
+000095c0: 286c 656e 2877 6f72 6b65 7273 2929 5d0a  (len(workers))].
+000095d0: 0a20 2020 2020 2020 2078 5f72 6561 6420  .        x_read 
+000095e0: 3d20 5b5d 0a20 2020 2020 2020 2078 5f77  = [].        x_w
+000095f0: 7269 7465 203d 205b 5d0a 2020 2020 2020  rite = [].      
+00009600: 2020 785f 7265 6164 5f64 6973 6b20 3d20    x_read_disk = 
+00009610: 5b5d 0a20 2020 2020 2020 2078 5f77 7269  [].        x_wri
+00009620: 7465 5f64 6973 6b20 3d20 5b5d 0a0a 2020  te_disk = []..  
+00009630: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+00009640: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+00009650: 2020 2020 2078 5f72 6561 642e 6170 7065       x_read.appe
+00009660: 6e64 2877 732e 6d65 7472 6963 735b 2268  nd(ws.metrics["h
+00009670: 6f73 745f 6e65 745f 696f 225d 5b22 7265  ost_net_io"]["re
+00009680: 6164 5f62 7073 225d 290a 2020 2020 2020  ad_bps"]).      
+00009690: 2020 2020 2020 785f 7772 6974 652e 6170        x_write.ap
+000096a0: 7065 6e64 2877 732e 6d65 7472 6963 735b  pend(ws.metrics[
+000096b0: 2268 6f73 745f 6e65 745f 696f 225d 5b22  "host_net_io"]["
+000096c0: 7772 6974 655f 6270 7322 5d29 0a20 2020  write_bps"]).   
+000096d0: 2020 2020 2020 2020 2078 5f72 6561 645f           x_read_
+000096e0: 6469 736b 2e61 7070 656e 6428 7773 2e6d  disk.append(ws.m
+000096f0: 6574 7269 6373 2e67 6574 2822 686f 7374  etrics.get("host
+00009700: 5f64 6973 6b5f 696f 222c 207b 7d29 2e67  _disk_io", {}).g
+00009710: 6574 2822 7265 6164 5f62 7073 222c 2030  et("read_bps", 0
+00009720: 2929 0a20 2020 2020 2020 2020 2020 2078  )).            x
+00009730: 5f77 7269 7465 5f64 6973 6b2e 6170 7065  _write_disk.appe
+00009740: 6e64 2877 732e 6d65 7472 6963 732e 6765  nd(ws.metrics.ge
+00009750: 7428 2268 6f73 745f 6469 736b 5f69 6f22  t("host_disk_io"
+00009760: 2c20 7b7d 292e 6765 7428 2277 7269 7465  , {}).get("write
+00009770: 5f62 7073 222c 2030 2929 0a0a 2020 2020  _bps", 0))..    
+00009780: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
+00009790: 6475 6c65 722e 776f 726b 6572 733a 0a20  duler.workers:. 
+000097a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000097b0: 6261 6e64 7769 6474 682e 785f 7261 6e67  bandwidth.x_rang
+000097c0: 652e 656e 6420 3d20 6d61 7828 0a20 2020  e.end = max(.   
+000097d0: 2020 2020 2020 2020 2020 2020 206d 6178               max
+000097e0: 2878 5f72 6561 6429 2c0a 2020 2020 2020  (x_read),.      
+000097f0: 2020 2020 2020 2020 2020 6d61 7828 785f            max(x_
+00009800: 7772 6974 6529 2c0a 2020 2020 2020 2020  write),.        
+00009810: 2020 2020 2020 2020 3130 305f 3030 305f          100_000_
+00009820: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
+00009830: 2020 2020 2030 2e39 3520 2a20 7365 6c66       0.95 * self
+00009840: 2e62 616e 6477 6964 7468 2e78 5f72 616e  .bandwidth.x_ran
+00009850: 6765 2e65 6e64 2c0a 2020 2020 2020 2020  ge.end,.        
+00009860: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00009870: 2020 2073 656c 662e 6469 736b 2e78 5f72     self.disk.x_r
+00009880: 616e 6765 2e65 6e64 203d 206d 6178 280a  ange.end = max(.
+00009890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098a0: 6d61 7828 785f 7265 6164 5f64 6973 6b29  max(x_read_disk)
+000098b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000098c0: 2020 6d61 7828 785f 7772 6974 655f 6469    max(x_write_di
+000098d0: 736b 292c 0a20 2020 2020 2020 2020 2020  sk),.           
+000098e0: 2020 2020 2031 3030 5f30 3030 5f30 3030       100_000_000
+000098f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009900: 2020 302e 3935 202a 2073 656c 662e 6469    0.95 * self.di
+00009910: 736b 2e78 5f72 616e 6765 2e65 6e64 2c0a  sk.x_range.end,.
+00009920: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00009930: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009940: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+00009950: 6477 6964 7468 2e78 5f72 616e 6765 2e65  dwidth.x_range.e
+00009960: 6e64 203d 2031 3030 5f30 3030 5f30 3030  nd = 100_000_000
+00009970: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00009980: 662e 6469 736b 2e78 5f72 616e 6765 2e65  f.disk.x_range.e
+00009990: 6e64 203d 2031 3030 5f30 3030 5f30 3030  nd = 100_000_000
+000099a0: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+000099b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+000099c0: 2022 795f 7265 6164 223a 2079 5f72 6561   "y_read": y_rea
+000099d0: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
+000099e0: 795f 7772 6974 6522 3a20 795f 7772 6974  y_write": y_writ
+000099f0: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+00009a00: 785f 7265 6164 223a 2078 5f72 6561 642c  x_read": x_read,
+00009a10: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
+00009a20: 7772 6974 6522 3a20 785f 7772 6974 652c  write": x_write,
+00009a30: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
+00009a40: 7265 6164 5f64 6973 6b22 3a20 785f 7265  read_disk": x_re
+00009a50: 6164 5f64 6973 6b2c 0a20 2020 2020 2020  ad_disk,.       
+00009a60: 2020 2020 2022 785f 7772 6974 655f 6469       "x_write_di
+00009a70: 736b 223a 2078 5f77 7269 7465 5f64 6973  sk": x_write_dis
+00009a80: 6b2c 0a20 2020 2020 2020 207d 0a0a 2020  k,.        }..  
+00009a90: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
+00009aa0: 662e 736f 7572 6365 2c20 7265 7375 6c74  f.source, result
+00009ab0: 290a 0a0a 636c 6173 7320 5379 7374 656d  )...class System
+00009ac0: 5469 6d65 7365 7269 6573 2844 6173 6862  Timeseries(Dashb
+00009ad0: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
+00009ae0: 2020 2020 2222 2254 696d 6573 6572 6965      """Timeserie
+00009af0: 7320 666f 7220 776f 726b 6572 206e 6574  s for worker net
+00009b00: 776f 726b 2062 616e 6477 6964 7468 2c20  work bandwidth, 
+00009b10: 6370 752c 206d 656d 6f72 7920 616e 6420  cpu, memory and 
+00009b20: 6469 736b 2e0a 0a20 2020 2062 616e 6477  disk...    bandw
+00009b30: 6964 7468 0a20 2020 2020 2020 2050 6c6f  idth.        Plo
+00009b40: 7473 2074 6865 2061 7665 7261 6765 206f  ts the average o
+00009b50: 6620 686f 7374 5f6e 6574 5f69 6f2e 7265  f host_net_io.re
+00009b60: 6164 5f62 7073 2061 6e64 2068 6f73 745f  ad_bps and host_
+00009b70: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
+00009b80: 2066 6f72 2074 6865 0a20 2020 2020 2020   for the.       
+00009b90: 2077 6f72 6b65 7273 2061 7320 6120 6675   workers as a fu
+00009ba0: 6e63 7469 6f6e 206f 6620 7469 6d65 0a20  nction of time. 
+00009bb0: 2020 2063 7075 0a20 2020 2020 2020 2050     cpu.        P
+00009bc0: 6c6f 7473 2074 6865 2061 7665 7261 6765  lots the average
+00009bd0: 206f 6620 6370 7520 666f 7220 7468 6520   of cpu for the 
+00009be0: 776f 726b 6572 7320 6173 2061 2066 756e  workers as a fun
+00009bf0: 6374 696f 6e20 6f66 2074 696d 650a 2020  ction of time.  
+00009c00: 2020 6d65 6d6f 7279 0a20 2020 2020 2020    memory.       
+00009c10: 2050 6c6f 7473 2074 6865 2061 7665 7261   Plots the avera
+00009c20: 6765 206f 6620 6d65 6d6f 7279 2066 6f72  ge of memory for
+00009c30: 2074 6865 2077 6f72 6b65 7273 2061 7320   the workers as 
+00009c40: 6120 6675 6e63 7469 6f6e 206f 6620 7469  a function of ti
+00009c50: 6d65 0a20 2020 2064 6973 6b0a 2020 2020  me.    disk.    
+00009c60: 2020 2020 506c 6f74 7320 7468 6520 6176      Plots the av
+00009c70: 6572 6167 6520 6f66 2068 6f73 745f 6469  erage of host_di
+00009c80: 736b 5f69 6f2e 7265 6164 5f62 7073 2061  sk_io.read_bps a
+00009c90: 6e64 2068 6f73 745f 6469 736b 5f69 6f2e  nd host_disk_io.
+00009ca0: 7772 6974 655f 6270 7320 666f 7220 7468  write_bps for th
+00009cb0: 650a 2020 2020 2020 2020 776f 726b 6572  e.        worker
+00009cc0: 7320 6173 2061 2066 756e 6374 696f 6e20  s as a function 
+00009cd0: 6f66 2074 696d 650a 0a20 2020 2054 6865  of time..    The
+00009ce0: 206d 6574 7269 6373 2070 6c6f 7474 6564   metrics plotted
+00009cf0: 2063 6f6d 6520 6672 6f6d 2074 6865 2061   come from the a
+00009d00: 6767 7265 6761 7469 6f6e 206f 6620 6672  ggregation of fr
+00009d10: 6f6d 2077 732e 6d65 7472 6963 735b 6b65  om ws.metrics[ke
+00009d20: 795d 2066 6f72 2077 7320 696e 0a20 2020  y] for ws in.   
+00009d30: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
+00009d40: 7273 2e76 616c 7565 7328 2920 6469 7669  rs.values() divi
+00009d50: 6465 6420 6279 206e 756d 6265 7220 6f66  ded by number of
+00009d60: 2077 6f72 6b65 7273 2e0a 2020 2020 2222   workers..    ""
+00009d70: 220a 0a20 2020 2040 6c6f 675f 6572 726f  "..    @log_erro
+00009d80: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
+00009d90: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+00009da0: 6c65 722c 2066 6f6c 6c6f 775f 696e 7465  ler, follow_inte
+00009db0: 7276 616c 3d32 3030 3030 2c20 2a2a 6b77  rval=20000, **kw
+00009dc0: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+00009dd0: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
+00009de0: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+00009df0: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
+00009e00: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+00009e10: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+00009e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e30: 2274 696d 6522 3a20 5b5d 2c0a 2020 2020  "time": [],.    
+00009e40: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+00009e50: 745f 6e65 745f 696f 2e72 6561 645f 6270  t_net_io.read_bp
+00009e60: 7322 3a20 5b5d 2c0a 2020 2020 2020 2020  s": [],.        
+00009e70: 2020 2020 2020 2020 2268 6f73 745f 6e65          "host_ne
+00009e80: 745f 696f 2e77 7269 7465 5f62 7073 223a  t_io.write_bps":
+00009e90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00009ea0: 2020 2020 2022 6370 7522 3a20 5b5d 2c0a       "cpu": [],.
+00009eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ec0: 226d 656d 6f72 7922 3a20 5b5d 2c0a 2020  "memory": [],.  
+00009ed0: 2020 2020 2020 2020 2020 2020 2020 2268                "h
+00009ee0: 6f73 745f 6469 736b 5f69 6f2e 7265 6164  ost_disk_io.read
+00009ef0: 5f62 7073 223a 205b 5d2c 0a20 2020 2020  _bps": [],.     
+00009f00: 2020 2020 2020 2020 2020 2022 686f 7374             "host
+00009f10: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
+00009f20: 7073 223a 205b 5d2c 0a20 2020 2020 2020  ps": [],.       
+00009f30: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
+00009f40: 0a0a 2020 2020 2020 2020 7570 6461 7465  ..        update
+00009f50: 2873 656c 662e 736f 7572 6365 2c20 7365  (self.source, se
+00009f60: 6c66 2e67 6574 5f64 6174 6128 2929 0a0a  lf.get_data())..
+00009f70: 2020 2020 2020 2020 785f 7261 6e67 6520          x_range 
+00009f80: 3d20 4461 7461 5261 6e67 6531 6428 0a20  = DataRange1d(. 
+00009f90: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+00009fa0: 773d 2265 6e64 222c 2066 6f6c 6c6f 775f  w="end", follow_
+00009fb0: 696e 7465 7276 616c 3d66 6f6c 6c6f 775f  interval=follow_
+00009fc0: 696e 7465 7276 616c 2c20 7261 6e67 655f  interval, range_
+00009fd0: 7061 6464 696e 673d 300a 2020 2020 2020  padding=0.      
+00009fe0: 2020 290a 2020 2020 2020 2020 746f 6f6c    ).        tool
+00009ff0: 7320 3d20 2272 6573 6574 2c20 7870 616e  s = "reset, xpan
+0000a000: 2c20 7877 6865 656c 5f7a 6f6f 6d22 0a0a  , xwheel_zoom"..
+0000a010: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+0000a020: 6477 6964 7468 203d 2066 6967 7572 6528  dwidth = figure(
+0000a030: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+0000a040: 6c65 3d22 576f 726b 6572 204e 6574 776f  le="Worker Netwo
+0000a050: 726b 2042 616e 6477 6964 7468 2028 6176  rk Bandwidth (av
+0000a060: 6572 6167 6529 222c 0a20 2020 2020 2020  erage)",.       
+0000a070: 2020 2020 2078 5f61 7869 735f 7479 7065       x_axis_type
+0000a080: 3d22 6461 7465 7469 6d65 222c 0a20 2020  ="datetime",.   
+0000a090: 2020 2020 2020 2020 2074 6f6f 6c73 3d74           tools=t
+0000a0a0: 6f6f 6c73 2c0a 2020 2020 2020 2020 2020  ools,.          
+0000a0b0: 2020 785f 7261 6e67 653d 785f 7261 6e67    x_range=x_rang
+0000a0c0: 652c 0a20 2020 2020 2020 2020 2020 206e  e,.            n
+0000a0d0: 616d 653d 2277 6f72 6b65 725f 6e65 7477  ame="worker_netw
+0000a0e0: 6f72 6b5f 6261 6e64 7769 6474 682d 7469  ork_bandwidth-ti
+0000a0f0: 6d65 7365 7269 6573 222c 0a20 2020 2020  meseries",.     
+0000a100: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0000a110: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000a120: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0000a130: 7468 2e6c 696e 6528 0a20 2020 2020 2020  th.line(.       
+0000a140: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+0000a150: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+0000a160: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
+0000a170: 2020 2020 2020 2020 2020 2079 3d22 686f             y="ho
+0000a180: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
+0000a190: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
+0000a1a0: 2063 6f6c 6f72 3d22 7265 6422 2c0a 2020   color="red",.  
+0000a1b0: 2020 2020 2020 2020 2020 6c65 6765 6e64            legend
+0000a1c0: 5f6c 6162 656c 3d22 7265 6164 2028 6d65  _label="read (me
+0000a1d0: 616e 2922 2c0a 2020 2020 2020 2020 290a  an)",.        ).
+0000a1e0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+0000a1f0: 6477 6964 7468 2e6c 696e 6528 0a20 2020  dwidth.line(.   
+0000a200: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0000a210: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0000a220: 2020 2020 2020 2020 2078 3d22 7469 6d65           x="time
+0000a230: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+0000a240: 3d22 686f 7374 5f6e 6574 5f69 6f2e 7772  ="host_net_io.wr
+0000a250: 6974 655f 6270 7322 2c0a 2020 2020 2020  ite_bps",.      
+0000a260: 2020 2020 2020 636f 6c6f 723d 2262 6c75        color="blu
+0000a270: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000a280: 6c65 6765 6e64 5f6c 6162 656c 3d22 7772  legend_label="wr
+0000a290: 6974 6520 286d 6561 6e29 222c 0a20 2020  ite (mean)",.   
+0000a2a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000a2b0: 7365 6c66 2e62 616e 6477 6964 7468 2e6c  self.bandwidth.l
+0000a2c0: 6567 656e 642e 6c6f 6361 7469 6f6e 203d  egend.location =
+0000a2d0: 2022 746f 705f 6c65 6674 220a 2020 2020   "top_left".    
+0000a2e0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0000a2f0: 7468 2e79 6178 6973 2e61 7869 735f 6c61  th.yaxis.axis_la
+0000a300: 6265 6c20 3d20 2262 7974 6573 202f 2073  bel = "bytes / s
+0000a310: 6563 6f6e 6422 0a20 2020 2020 2020 2073  econd".        s
+0000a320: 656c 662e 6261 6e64 7769 6474 682e 7961  elf.bandwidth.ya
+0000a330: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
+0000a340: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
+0000a350: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+0000a360: 302e 3062 2229 0a20 2020 2020 2020 2073  0.0b").        s
+0000a370: 656c 662e 6261 6e64 7769 6474 682e 795f  elf.bandwidth.y_
+0000a380: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
+0000a390: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+0000a3a0: 6477 6964 7468 2e79 6178 6973 2e6d 696e  dwidth.yaxis.min
+0000a3b0: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+0000a3c0: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+0000a3d0: 656c 662e 6261 6e64 7769 6474 682e 7867  elf.bandwidth.xg
+0000a3e0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0000a3f0: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
+0000a400: 662e 6370 7520 3d20 6669 6775 7265 280a  f.cpu = figure(.
+0000a410: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0000a420: 653d 2257 6f72 6b65 7220 4350 5520 5574  e="Worker CPU Ut
+0000a430: 696c 697a 6174 696f 6e20 2861 7665 7261  ilization (avera
+0000a440: 6765 2922 2c0a 2020 2020 2020 2020 2020  ge)",.          
+0000a450: 2020 785f 6178 6973 5f74 7970 653d 2264    x_axis_type="d
+0000a460: 6174 6574 696d 6522 2c0a 2020 2020 2020  atetime",.      
+0000a470: 2020 2020 2020 746f 6f6c 733d 746f 6f6c        tools=tool
+0000a480: 732c 0a20 2020 2020 2020 2020 2020 2078  s,.            x
+0000a490: 5f72 616e 6765 3d78 5f72 616e 6765 2c0a  _range=x_range,.
+0000a4a0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0000a4b0: 3d22 776f 726b 6572 5f63 7075 2d74 696d  ="worker_cpu-tim
+0000a4c0: 6573 6572 6965 7322 2c0a 2020 2020 2020  eseries",.      
+0000a4d0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+0000a4e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000a4f0: 2020 2073 656c 662e 6370 752e 6c69 6e65     self.cpu.line
+0000a500: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
+0000a510: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+0000a520: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
+0000a530: 2274 696d 6522 2c0a 2020 2020 2020 2020  "time",.        
+0000a540: 2020 2020 793d 2263 7075 222c 0a20 2020      y="cpu",.   
+0000a550: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0000a560: 656c 662e 6370 752e 7961 7869 732e 6178  elf.cpu.yaxis.ax
+0000a570: 6973 5f6c 6162 656c 203d 2022 5574 696c  is_label = "Util
+0000a580: 697a 6174 696f 6e22 0a20 2020 2020 2020  ization".       
+0000a590: 2073 656c 662e 6370 752e 795f 7261 6e67   self.cpu.y_rang
+0000a5a0: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
+0000a5b0: 2020 2020 7365 6c66 2e63 7075 2e79 6178      self.cpu.yax
+0000a5c0: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
+0000a5d0: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
+0000a5e0: 2020 2020 2073 656c 662e 6370 752e 7867       self.cpu.xg
+0000a5f0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+0000a600: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
+0000a610: 662e 6d65 6d6f 7279 203d 2066 6967 7572  f.memory = figur
+0000a620: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
+0000a630: 6974 6c65 3d22 576f 726b 6572 204d 656d  itle="Worker Mem
+0000a640: 6f72 7920 5573 6520 2861 7665 7261 6765  ory Use (average
+0000a650: 2922 2c0a 2020 2020 2020 2020 2020 2020  )",.            
+0000a660: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
+0000a670: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
+0000a680: 2020 2020 746f 6f6c 733d 746f 6f6c 732c      tools=tools,
+0000a690: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+0000a6a0: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
+0000a6b0: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
+0000a6c0: 776f 726b 6572 5f6d 656d 6f72 792d 7469  worker_memory-ti
+0000a6d0: 6d65 7365 7269 6573 222c 0a20 2020 2020  meseries",.     
+0000a6e0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0000a6f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000a700: 2020 2020 7365 6c66 2e6d 656d 6f72 792e      self.memory.
+0000a710: 6c69 6e65 280a 2020 2020 2020 2020 2020  line(.          
+0000a720: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+0000a730: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+0000a740: 2020 783d 2274 696d 6522 2c0a 2020 2020    x="time",.    
+0000a750: 2020 2020 2020 2020 793d 226d 656d 6f72          y="memor
+0000a760: 7922 2c0a 2020 2020 2020 2020 290a 2020  y",.        ).  
+0000a770: 2020 2020 2020 7365 6c66 2e6d 656d 6f72        self.memor
+0000a780: 792e 7961 7869 732e 6178 6973 5f6c 6162  y.yaxis.axis_lab
+0000a790: 656c 203d 2022 4279 7465 7322 0a20 2020  el = "Bytes".   
+0000a7a0: 2020 2020 2073 656c 662e 6d65 6d6f 7279       self.memory
+0000a7b0: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
+0000a7c0: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+0000a7d0: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+0000a7e0: 743d 2230 2e30 6222 290a 2020 2020 2020  t="0.0b").      
+0000a7f0: 2020 7365 6c66 2e6d 656d 6f72 792e 795f    self.memory.y_
+0000a800: 7261 6e67 652e 7374 6172 7420 3d20 300a  range.start = 0.
+0000a810: 2020 2020 2020 2020 7365 6c66 2e6d 656d          self.mem
+0000a820: 6f72 792e 7961 7869 732e 6d69 6e6f 725f  ory.yaxis.minor_
+0000a830: 7469 636b 5f6c 696e 655f 616c 7068 6120  tick_line_alpha 
+0000a840: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000a850: 2e6d 656d 6f72 792e 7867 7269 642e 7669  .memory.xgrid.vi
+0000a860: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0000a870: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+0000a880: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+0000a890: 2020 2020 2020 2074 6974 6c65 3d22 576f         title="Wo
+0000a8a0: 726b 6572 2044 6973 6b20 4261 6e64 7769  rker Disk Bandwi
+0000a8b0: 6474 6820 2861 7665 7261 6765 2922 2c0a  dth (average)",.
+0000a8c0: 2020 2020 2020 2020 2020 2020 785f 6178              x_ax
+0000a8d0: 6973 5f74 7970 653d 2264 6174 6574 696d  is_type="datetim
+0000a8e0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000a8f0: 746f 6f6c 733d 746f 6f6c 732c 0a20 2020  tools=tools,.   
+0000a900: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+0000a910: 3d78 5f72 616e 6765 2c0a 2020 2020 2020  =x_range,.      
+0000a920: 2020 2020 2020 6e61 6d65 3d22 776f 726b        name="work
+0000a930: 6572 5f64 6973 6b2d 7469 6d65 7365 7269  er_disk-timeseri
+0000a940: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0000a950: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+0000a960: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+0000a970: 6c66 2e64 6973 6b2e 6c69 6e65 280a 2020  lf.disk.line(.  
+0000a980: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000a990: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0000a9a0: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
+0000a9b0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000a9c0: 793d 2268 6f73 745f 6469 736b 5f69 6f2e  y="host_disk_io.
+0000a9d0: 7265 6164 5f62 7073 222c 0a20 2020 2020  read_bps",.     
+0000a9e0: 2020 2020 2020 2063 6f6c 6f72 3d22 7265         color="re
+0000a9f0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0000aa00: 6c65 6765 6e64 5f6c 6162 656c 3d22 7265  legend_label="re
+0000aa10: 6164 2028 6d65 616e 2922 2c0a 2020 2020  ad (mean)",.    
+0000aa20: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000aa30: 6c66 2e64 6973 6b2e 6c69 6e65 280a 2020  lf.disk.line(.  
+0000aa40: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000aa50: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0000aa60: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
+0000aa70: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000aa80: 793d 2268 6f73 745f 6469 736b 5f69 6f2e  y="host_disk_io.
+0000aa90: 7772 6974 655f 6270 7322 2c0a 2020 2020  write_bps",.    
+0000aaa0: 2020 2020 2020 2020 636f 6c6f 723d 2262          color="b
+0000aab0: 6c75 6522 2c0a 2020 2020 2020 2020 2020  lue",.          
+0000aac0: 2020 6c65 6765 6e64 5f6c 6162 656c 3d22    legend_label="
+0000aad0: 7772 6974 6520 286d 6561 6e29 222c 0a20  write (mean)",. 
+0000aae0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000aaf0: 2020 7365 6c66 2e64 6973 6b2e 6c65 6765    self.disk.lege
+0000ab00: 6e64 2e6c 6f63 6174 696f 6e20 3d20 2274  nd.location = "t
+0000ab10: 6f70 5f6c 6566 7422 0a20 2020 2020 2020  op_left".       
+0000ab20: 2073 656c 662e 6469 736b 2e79 6178 6973   self.disk.yaxis
+0000ab30: 2e61 7869 735f 6c61 6265 6c20 3d20 2262  .axis_label = "b
+0000ab40: 7974 6573 202f 2073 6563 6f6e 6422 0a20  ytes / second". 
+0000ab50: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+0000ab60: 2e79 6178 6973 5b30 5d2e 666f 726d 6174  .yaxis[0].format
+0000ab70: 7465 7220 3d20 4e75 6d65 7261 6c54 6963  ter = NumeralTic
+0000ab80: 6b46 6f72 6d61 7474 6572 2866 6f72 6d61  kFormatter(forma
+0000ab90: 743d 2230 2e30 6222 290a 2020 2020 2020  t="0.0b").      
+0000aba0: 2020 7365 6c66 2e64 6973 6b2e 795f 7261    self.disk.y_ra
+0000abb0: 6e67 652e 7374 6172 7420 3d20 300a 2020  nge.start = 0.  
+0000abc0: 2020 2020 2020 7365 6c66 2e64 6973 6b2e        self.disk.
+0000abd0: 7961 7869 732e 6d69 6e6f 725f 7469 636b  yaxis.minor_tick
+0000abe0: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
+0000abf0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+0000ac00: 6b2e 7867 7269 642e 7669 7369 626c 6520  k.xgrid.visible 
+0000ac10: 3d20 4661 6c73 650a 0a20 2020 2064 6566  = False..    def
+0000ac20: 2067 6574 5f64 6174 6128 7365 6c66 293a   get_data(self):
+0000ac30: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+0000ac40: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+0000ac50: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+0000ac60: 2829 0a0a 2020 2020 2020 2020 6e65 745f  ()..        net_
+0000ac70: 7265 6164 5f62 7073 203d 2030 0a20 2020  read_bps = 0.   
+0000ac80: 2020 2020 206e 6574 5f77 7269 7465 5f62       net_write_b
+0000ac90: 7073 203d 2030 0a20 2020 2020 2020 2063  ps = 0.        c
+0000aca0: 7075 203d 2030 0a20 2020 2020 2020 206d  pu = 0.        m
+0000acb0: 656d 6f72 7920 3d20 300a 2020 2020 2020  emory = 0.      
+0000acc0: 2020 6469 736b 5f72 6561 645f 6270 7320    disk_read_bps 
+0000acd0: 3d20 300a 2020 2020 2020 2020 6469 736b  = 0.        disk
+0000ace0: 5f77 7269 7465 5f62 7073 203d 2030 0a20  _write_bps = 0. 
+0000acf0: 2020 2020 2020 2074 696d 6520 3d20 300a         time = 0.
+0000ad00: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+0000ad10: 6e20 776f 726b 6572 733a 0a20 2020 2020  n workers:.     
+0000ad20: 2020 2020 2020 206e 6574 5f72 6561 645f         net_read_
+0000ad30: 6270 7320 2b3d 2077 732e 6d65 7472 6963  bps += ws.metric
+0000ad40: 735b 2268 6f73 745f 6e65 745f 696f 225d  s["host_net_io"]
+0000ad50: 5b22 7265 6164 5f62 7073 225d 0a20 2020  ["read_bps"].   
+0000ad60: 2020 2020 2020 2020 206e 6574 5f77 7269           net_wri
+0000ad70: 7465 5f62 7073 202b 3d20 7773 2e6d 6574  te_bps += ws.met
+0000ad80: 7269 6373 5b22 686f 7374 5f6e 6574 5f69  rics["host_net_i
+0000ad90: 6f22 5d5b 2277 7269 7465 5f62 7073 225d  o"]["write_bps"]
+0000ada0: 0a20 2020 2020 2020 2020 2020 2063 7075  .            cpu
+0000adb0: 202b 3d20 7773 2e6d 6574 7269 6373 5b22   += ws.metrics["
+0000adc0: 6370 7522 5d0a 2020 2020 2020 2020 2020  cpu"].          
+0000add0: 2020 6d65 6d6f 7279 202b 3d20 7773 2e6d    memory += ws.m
+0000ade0: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
+0000adf0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
+0000ae00: 6b5f 7265 6164 5f62 7073 202b 3d20 7773  k_read_bps += ws
+0000ae10: 2e6d 6574 7269 6373 2e67 6574 2822 686f  .metrics.get("ho
+0000ae20: 7374 5f64 6973 6b5f 696f 222c 207b 7d29  st_disk_io", {})
+0000ae30: 2e67 6574 2822 7265 6164 5f62 7073 222c  .get("read_bps",
+0000ae40: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
+0000ae50: 6469 736b 5f77 7269 7465 5f62 7073 202b  disk_write_bps +
+0000ae60: 3d20 7773 2e6d 6574 7269 6373 2e67 6574  = ws.metrics.get
+0000ae70: 2822 686f 7374 5f64 6973 6b5f 696f 222c  ("host_disk_io",
+0000ae80: 207b 7d29 2e67 6574 2822 7772 6974 655f   {}).get("write_
+0000ae90: 6270 7322 2c20 3029 0a20 2020 2020 2020  bps", 0).       
+0000aea0: 2020 2020 2074 696d 6520 2b3d 2077 732e       time += ws.
+0000aeb0: 6d65 7472 6963 735b 2274 696d 6522 5d0a  metrics["time"].
+0000aec0: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+0000aed0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000aee0: 2320 7573 6520 606f 7260 2074 6f20 6176  # use `or` to av
+0000aef0: 6f69 6420 5a65 726f 4469 7669 7369 6f6e  oid ZeroDivision
+0000af00: 2077 6865 6e20 6e6f 2077 6f72 6b65 7273   when no workers
+0000af10: 0a20 2020 2020 2020 2020 2020 2022 7469  .            "ti
+0000af20: 6d65 223a 205b 7469 6d65 202f 2028 6c65  me": [time / (le
+0000af30: 6e28 776f 726b 6572 7329 206f 7220 3129  n(workers) or 1)
+0000af40: 202a 2031 3030 305d 2c0a 2020 2020 2020   * 1000],.      
+0000af50: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
+0000af60: 696f 2e72 6561 645f 6270 7322 3a20 5b6e  io.read_bps": [n
+0000af70: 6574 5f72 6561 645f 6270 7320 2f20 286c  et_read_bps / (l
+0000af80: 656e 2877 6f72 6b65 7273 2920 6f72 2031  en(workers) or 1
+0000af90: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
+0000afa0: 2268 6f73 745f 6e65 745f 696f 2e77 7269  "host_net_io.wri
+0000afb0: 7465 5f62 7073 223a 205b 6e65 745f 7772  te_bps": [net_wr
+0000afc0: 6974 655f 6270 7320 2f20 286c 656e 2877  ite_bps / (len(w
+0000afd0: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
+0000afe0: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
+0000aff0: 223a 205b 6370 7520 2f20 286c 656e 2877  ": [cpu / (len(w
+0000b000: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
+0000b010: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+0000b020: 6f72 7922 3a20 5b6d 656d 6f72 7920 2f20  ory": [memory / 
+0000b030: 286c 656e 2877 6f72 6b65 7273 2920 6f72  (len(workers) or
+0000b040: 2031 295d 2c0a 2020 2020 2020 2020 2020   1)],.          
+0000b050: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
+0000b060: 7265 6164 5f62 7073 223a 205b 6469 736b  read_bps": [disk
+0000b070: 5f72 6561 645f 6270 7320 2f20 286c 656e  _read_bps / (len
+0000b080: 2877 6f72 6b65 7273 2920 6f72 2031 295d  (workers) or 1)]
+0000b090: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+0000b0a0: 6f73 745f 6469 736b 5f69 6f2e 7772 6974  ost_disk_io.writ
+0000b0b0: 655f 6270 7322 3a20 5b64 6973 6b5f 7772  e_bps": [disk_wr
+0000b0c0: 6974 655f 6270 7320 2f20 286c 656e 2877  ite_bps / (len(w
+0000b0d0: 6f72 6b65 7273 2920 6f72 2031 295d 2c0a  orkers) or 1)],.
+0000b0e0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0000b0f0: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+0000b100: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+0000b110: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+0000b120: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+0000b130: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+0000b140: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000b150: 7365 6c66 2e73 6f75 7263 652e 7374 7265  self.source.stre
+0000b160: 616d 2873 656c 662e 6765 745f 6461 7461  am(self.get_data
+0000b170: 2829 2c20 3130 3030 290a 0a20 2020 2020  (), 1000)..     
+0000b180: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
+0000b190: 756c 6572 2e77 6f72 6b65 7273 3a0a 2020  uler.workers:.  
+0000b1a0: 2020 2020 2020 2020 2020 795f 656e 645f            y_end_
+0000b1b0: 6370 7520 3d20 7375 6d28 0a20 2020 2020  cpu = sum(.     
+0000b1c0: 2020 2020 2020 2020 2020 2077 732e 6e74             ws.nt
+0000b1d0: 6872 6561 6473 206f 7220 3120 666f 7220  hreads or 1 for 
+0000b1e0: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
+0000b1f0: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+0000b200: 7565 7328 290a 2020 2020 2020 2020 2020  ues().          
+0000b210: 2020 2920 2f20 6c65 6e28 7365 6c66 2e73    ) / len(self.s
+0000b220: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0000b230: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+0000b240: 2020 2020 2020 2079 5f65 6e64 5f6d 656d         y_end_mem
+0000b250: 203d 2073 756d 280a 2020 2020 2020 2020   = sum(.        
+0000b260: 2020 2020 2020 2020 7773 2e6d 656d 6f72          ws.memor
+0000b270: 795f 6c69 6d69 7420 666f 7220 7773 2069  y_limit for ws i
+0000b280: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
+0000b290: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+0000b2a0: 290a 2020 2020 2020 2020 2020 2020 2920  ).            ) 
+0000b2b0: 2f20 6c65 6e28 7365 6c66 2e73 6368 6564  / len(self.sched
+0000b2c0: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+0000b2d0: 7565 7328 2929 0a20 2020 2020 2020 2065  ues()).        e
+0000b2e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000b2f0: 2079 5f65 6e64 5f63 7075 203d 2031 0a20   y_end_cpu = 1. 
+0000b300: 2020 2020 2020 2020 2020 2079 5f65 6e64             y_end
+0000b310: 5f6d 656d 203d 2031 3030 5f30 3030 5f30  _mem = 100_000_0
+0000b320: 3030 0a0a 2020 2020 2020 2020 7365 6c66  00..        self
+0000b330: 2e63 7075 2e79 5f72 616e 6765 2e65 6e64  .cpu.y_range.end
+0000b340: 203d 2079 5f65 6e64 5f63 7075 202a 2031   = y_end_cpu * 1
+0000b350: 3030 0a20 2020 2020 2020 2073 656c 662e  00.        self.
+0000b360: 6d65 6d6f 7279 2e79 5f72 616e 6765 2e65  memory.y_range.e
+0000b370: 6e64 203d 2079 5f65 6e64 5f6d 656d 0a0a  nd = y_end_mem..
+0000b380: 0a63 6c61 7373 2043 6f6d 7075 7465 5065  .class ComputePe
+0000b390: 724b 6579 2844 6173 6862 6f61 7264 436f  rKey(DashboardCo
+0000b3a0: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
+0000b3b0: 2242 6172 2063 6861 7274 2073 686f 7769  "Bar chart showi
+0000b3c0: 6e67 2074 696d 6520 7370 656e 6420 696e  ng time spend in
+0000b3d0: 2061 6374 696f 6e20 6279 206b 6579 2070   action by key p
+0000b3e0: 7265 6669 7822 2222 0a0a 2020 2020 406c  refix"""..    @l
+0000b3f0: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+0000b400: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+0000b410: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
+0000b420: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+0000b430: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
+0000b440: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+0000b450: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+0000b460: 0a20 2020 2020 2020 2069 6620 5461 736b  .        if Task
+0000b470: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+0000b480: 6520 6e6f 7420 696e 2073 656c 662e 7363  e not in self.sc
+0000b490: 6865 6475 6c65 722e 706c 7567 696e 733a  heduler.plugins:
+0000b4a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000b4b0: 662e 7363 6865 6475 6c65 722e 6164 645f  f.scheduler.add_
+0000b4c0: 706c 7567 696e 2854 6173 6b53 7472 6561  plugin(TaskStrea
+0000b4d0: 6d50 6c75 6769 6e28 7365 6c66 2e73 6368  mPlugin(self.sch
+0000b4e0: 6564 756c 6572 2929 0a0a 2020 2020 2020  eduler))..      
+0000b4f0: 2020 636f 6d70 7574 655f 6461 7461 203d    compute_data =
+0000b500: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0000b510: 7469 6d65 7322 3a20 5b30 2e32 2c20 302e  times": [0.2, 0.
+0000b520: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0000b530: 2266 6f72 6d61 7474 6564 5f74 696d 6522  "formatted_time"
+0000b540: 3a20 5b22 302e 3220 6d73 222c 2022 322e  : ["0.2 ms", "2.
+0000b550: 3820 7573 225d 2c0a 2020 2020 2020 2020  8 us"],.        
+0000b560: 2020 2020 2261 6e67 6c65 7322 3a20 5b33      "angles": [3
+0000b570: 2e31 342c 2030 2e37 3835 5d2c 0a20 2020  .14, 0.785],.   
+0000b580: 2020 2020 2020 2020 2022 636f 6c6f 7222           "color"
+0000b590: 3a20 5b74 735f 636f 6c6f 725f 6c6f 6f6b  : [ts_color_look
+0000b5a0: 7570 5b22 7472 616e 7366 6572 225d 2c20  up["transfer"], 
+0000b5b0: 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b  ts_color_lookup[
+0000b5c0: 2263 6f6d 7075 7465 225d 5d2c 0a20 2020  "compute"]],.   
+0000b5d0: 2020 2020 2020 2020 2022 6e61 6d65 7322           "names"
+0000b5e0: 3a20 5b22 7375 6d22 2c20 2273 756d 5f70  : ["sum", "sum_p
+0000b5f0: 6172 7469 616c 225d 2c0a 2020 2020 2020  artial"],.      
+0000b600: 2020 7d0a 0a20 2020 2020 2020 2073 656c    }..        sel
+0000b610: 662e 636f 6d70 7574 655f 736f 7572 6365  f.compute_source
+0000b620: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+0000b630: 7263 6528 6461 7461 3d63 6f6d 7075 7465  rce(data=compute
+0000b640: 5f64 6174 6129 0a0a 2020 2020 2020 2020  _data)..        
+0000b650: 6669 6720 3d20 6669 6775 7265 280a 2020  fig = figure(.  
+0000b660: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000b670: 2243 6f6d 7075 7465 2054 696d 6520 5065  "Compute Time Pe
+0000b680: 7220 5461 736b 222c 0a20 2020 2020 2020  r Task",.       
+0000b690: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+0000b6a0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+0000b6b0: 2263 6f6d 7075 7465 5f74 696d 655f 7065  "compute_time_pe
+0000b6c0: 725f 6b65 7922 2c0a 2020 2020 2020 2020  r_key",.        
+0000b6d0: 2020 2020 785f 7261 6e67 653d 5b22 6122      x_range=["a"
+0000b6e0: 2c20 2262 225d 2c0a 2020 2020 2020 2020  , "b"],.        
+0000b6f0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000b700: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000b710: 2072 6563 7420 3d20 6669 672e 7662 6172   rect = fig.vbar
+0000b720: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
+0000b730: 7572 6365 3d73 656c 662e 636f 6d70 7574  urce=self.comput
+0000b740: 655f 736f 7572 6365 2c0a 2020 2020 2020  e_source,.      
+0000b750: 2020 2020 2020 783d 226e 616d 6573 222c        x="names",
+0000b760: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+0000b770: 3d22 7469 6d65 7322 2c0a 2020 2020 2020  ="times",.      
+0000b780: 2020 2020 2020 7769 6474 683d 302e 372c        width=0.7,
+0000b790: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000b7a0: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
+0000b7b0: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
+0000b7c0: 6967 2e79 5f72 616e 6765 2e73 7461 7274  ig.y_range.start
+0000b7d0: 203d 2030 0a20 2020 2020 2020 2066 6967   = 0.        fig
+0000b7e0: 2e79 6178 6973 2e61 7869 735f 6c61 6265  .yaxis.axis_labe
+0000b7f0: 6c20 3d20 2254 696d 6520 2873 2922 0a20  l = "Time (s)". 
+0000b800: 2020 2020 2020 2066 6967 2e79 6178 6973         fig.yaxis
+0000b810: 5b30 5d2e 666f 726d 6174 7465 7220 3d20  [0].formatter = 
+0000b820: 4e75 6d65 7261 6c54 6963 6b46 6f72 6d61  NumeralTickForma
+0000b830: 7474 6572 2866 6f72 6d61 743d 2230 2229  tter(format="0")
+0000b840: 0a20 2020 2020 2020 2066 6967 2e79 6178  .        fig.yax
+0000b850: 6973 2e74 6963 6b65 7220 3d20 4164 6170  is.ticker = Adap
+0000b860: 7469 7665 5469 636b 6572 282a 2a54 4943  tiveTicker(**TIC
+0000b870: 4b53 5f31 3032 3429 0a20 2020 2020 2020  KS_1024).       
+0000b880: 2066 6967 2e78 6178 6973 2e6d 616a 6f72   fig.xaxis.major
+0000b890: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
+0000b8a0: 6f6e 203d 2058 4c41 4245 4c5f 4f52 4945  on = XLABEL_ORIE
+0000b8b0: 4e54 4154 494f 4e0a 2020 2020 2020 2020  NTATION.        
+0000b8c0: 7265 6374 2e6e 6f6e 7365 6c65 6374 696f  rect.nonselectio
+0000b8d0: 6e5f 676c 7970 6820 3d20 4e6f 6e65 0a0a  n_glyph = None..
+0000b8e0: 2020 2020 2020 2020 6669 672e 7861 7869          fig.xaxi
+0000b8f0: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
+0000b900: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+0000b910: 2020 2020 6669 672e 7867 7269 642e 7669      fig.xgrid.vi
+0000b920: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0000b930: 2020 2020 2020 2066 6967 2e74 6f6f 6c62         fig.toolb
+0000b940: 6172 5f6c 6f63 6174 696f 6e20 3d20 4e6f  ar_location = No
+0000b950: 6e65 0a0a 2020 2020 2020 2020 686f 7665  ne..        hove
+0000b960: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
+0000b970: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
+0000b980: 6f6c 7469 7073 203d 2022 2222 0a20 2020  oltips = """.   
+0000b990: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
+0000b9a0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0000b9b0: 703e 3c62 3e4e 616d 653a 3c2f 623e 2040  p><b>Name:</b> @
+0000b9c0: 6e61 6d65 733c 2f70 3e0a 2020 2020 2020  names</p>.      
+0000b9d0: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
+0000b9e0: 5469 6d65 3a3c 2f62 3e20 4066 6f72 6d61  Time:</b> @forma
+0000b9f0: 7474 6564 5f74 696d 653c 2f70 3e0a 2020  tted_time</p>.  
+0000ba00: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+0000ba10: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+0000ba20: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
+0000ba30: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
+0000ba40: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
+0000ba50: 2020 2020 2066 6967 2e61 6464 5f74 6f6f       fig.add_too
+0000ba60: 6c73 2868 6f76 6572 290a 0a20 2020 2020  ls(hover)..     
+0000ba70: 2020 2066 6967 2e61 6464 5f6c 6179 6f75     fig.add_layou
+0000ba80: 7428 0a20 2020 2020 2020 2020 2020 2054  t(.            T
+0000ba90: 6974 6c65 280a 2020 2020 2020 2020 2020  itle(.          
+0000baa0: 2020 2020 2020 7465 7874 3d22 4e6f 7465        text="Note
+0000bab0: 3a20 7461 736b 7320 6c65 7373 2074 6861  : tasks less tha
+0000bac0: 6e20 3225 206f 6620 6d61 7820 6172 6520  n 2% of max are 
+0000bad0: 6e6f 7420 6469 7370 6c61 7965 6422 2c0a  not displayed",.
+0000bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000baf0: 7465 7874 5f66 6f6e 745f 7374 796c 653d  text_font_style=
+0000bb00: 2269 7461 6c69 6322 2c0a 2020 2020 2020  "italic",.      
+0000bb10: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0000bb20: 2020 2020 2022 6265 6c6f 7722 2c0a 2020       "below",.  
+0000bb30: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000bb40: 2073 656c 662e 6669 6720 3d20 6669 670a   self.fig = fig.
+0000bb50: 2020 2020 2020 2020 7461 6231 203d 2054          tab1 = T
+0000bb60: 6162 5061 6e65 6c28 6368 696c 643d 6669  abPanel(child=fi
+0000bb70: 672c 2074 6974 6c65 3d22 4261 7220 4368  g, title="Bar Ch
+0000bb80: 6172 7422 290a 0a20 2020 2020 2020 2066  art")..        f
+0000bb90: 6967 3220 3d20 6669 6775 7265 280a 2020  ig2 = figure(.  
+0000bba0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000bbb0: 2243 6f6d 7075 7465 2054 696d 6520 5065  "Compute Time Pe
+0000bbc0: 7220 5461 736b 222c 0a20 2020 2020 2020  r Task",.       
+0000bbd0: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+0000bbe0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+0000bbf0: 2263 6f6d 7075 7465 5f74 696d 655f 7065  "compute_time_pe
+0000bc00: 725f 6b65 792d 7069 6522 2c0a 2020 2020  r_key-pie",.    
+0000bc10: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+0000bc20: 282d 302e 352c 2031 2e30 292c 0a20 2020  (-0.5, 1.0),.   
+0000bc30: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0000bc40: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+0000bc50: 2020 2020 2020 6669 6732 2e77 6564 6765        fig2.wedge
+0000bc60: 280a 2020 2020 2020 2020 2020 2020 783d  (.            x=
+0000bc70: 302c 0a20 2020 2020 2020 2020 2020 2079  0,.            y
+0000bc80: 3d31 2c0a 2020 2020 2020 2020 2020 2020  =1,.            
+0000bc90: 7261 6469 7573 3d30 2e34 2c0a 2020 2020  radius=0.4,.    
+0000bca0: 2020 2020 2020 2020 7374 6172 745f 616e          start_an
+0000bcb0: 676c 653d 6375 6d73 756d 2822 616e 676c  gle=cumsum("angl
+0000bcc0: 6573 222c 2069 6e63 6c75 6465 5f7a 6572  es", include_zer
+0000bcd0: 6f3d 5472 7565 292c 0a20 2020 2020 2020  o=True),.       
+0000bce0: 2020 2020 2065 6e64 5f61 6e67 6c65 3d63       end_angle=c
+0000bcf0: 756d 7375 6d28 2261 6e67 6c65 7322 292c  umsum("angles"),
+0000bd00: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+0000bd10: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
+0000bd20: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0000bd30: 6c5f 636f 6c6f 723d 2263 6f6c 6f72 222c  l_color="color",
+0000bd40: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
+0000bd50: 656e 645f 6669 656c 643d 226e 616d 6573  end_field="names
+0000bd60: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
+0000bd70: 6f75 7263 653d 7365 6c66 2e63 6f6d 7075  ource=self.compu
+0000bd80: 7465 5f73 6f75 7263 652c 0a20 2020 2020  te_source,.     
+0000bd90: 2020 2029 0a0a 2020 2020 2020 2020 6669     )..        fi
+0000bda0: 6732 2e61 7869 732e 6178 6973 5f6c 6162  g2.axis.axis_lab
+0000bdb0: 656c 203d 204e 6f6e 650a 2020 2020 2020  el = None.      
+0000bdc0: 2020 6669 6732 2e61 7869 732e 7669 7369    fig2.axis.visi
+0000bdd0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+0000bde0: 2020 2020 6669 6732 2e67 7269 642e 6772      fig2.grid.gr
+0000bdf0: 6964 5f6c 696e 655f 636f 6c6f 7220 3d20  id_line_color = 
+0000be00: 4e6f 6e65 0a20 2020 2020 2020 2066 6967  None.        fig
+0000be10: 322e 6164 645f 6c61 796f 7574 280a 2020  2.add_layout(.  
+0000be20: 2020 2020 2020 2020 2020 5469 746c 6528            Title(
+0000be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000be40: 2074 6578 743d 224e 6f74 653a 2074 6173   text="Note: tas
+0000be50: 6b73 206c 6573 7320 7468 616e 2032 2520  ks less than 2% 
+0000be60: 6f66 206d 6178 2061 7265 206e 6f74 2064  of max are not d
+0000be70: 6973 706c 6179 6564 222c 0a20 2020 2020  isplayed",.     
+0000be80: 2020 2020 2020 2020 2020 2074 6578 745f             text_
+0000be90: 666f 6e74 5f73 7479 6c65 3d22 6974 616c  font_style="ital
+0000bea0: 6963 222c 0a20 2020 2020 2020 2020 2020  ic",.           
+0000beb0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0000bec0: 2262 656c 6f77 222c 0a20 2020 2020 2020  "below",.       
+0000bed0: 2029 0a0a 2020 2020 2020 2020 686f 7665   )..        hove
+0000bee0: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
+0000bef0: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
+0000bf00: 6f6c 7469 7073 203d 2022 2222 0a20 2020  oltips = """.   
+0000bf10: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
+0000bf20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0000bf30: 703e 3c62 3e4e 616d 653a 3c2f 623e 2040  p><b>Name:</b> @
+0000bf40: 6e61 6d65 733c 2f70 3e0a 2020 2020 2020  names</p>.      
+0000bf50: 2020 2020 2020 2020 2020 3c70 3e3c 623e            <p><b>
+0000bf60: 5469 6d65 3a3c 2f62 3e20 4066 6f72 6d61  Time:</b> @forma
+0000bf70: 7474 6564 5f74 696d 653c 2f70 3e0a 2020  tted_time</p>.  
+0000bf80: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+0000bf90: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
+0000bfa0: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
+0000bfb0: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
+0000bfc0: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
+0000bfd0: 2020 2020 2066 6967 322e 6164 645f 746f       fig2.add_to
+0000bfe0: 6f6c 7328 686f 7665 7229 0a20 2020 2020  ols(hover).     
+0000bff0: 2020 2073 656c 662e 7765 6467 655f 6669     self.wedge_fi
+0000c000: 6720 3d20 6669 6732 0a20 2020 2020 2020  g = fig2.       
+0000c010: 2074 6162 3220 3d20 5461 6250 616e 656c   tab2 = TabPanel
+0000c020: 2863 6869 6c64 3d66 6967 322c 2074 6974  (child=fig2, tit
+0000c030: 6c65 3d22 5069 6520 4368 6172 7422 290a  le="Pie Chart").
+0000c040: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000c050: 6f74 203d 2054 6162 7328 7461 6273 3d5b  ot = Tabs(tabs=[
+0000c060: 7461 6231 2c20 7461 6232 5d2c 2073 697a  tab1, tab2], siz
+0000c070: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+0000c080: 685f 626f 7468 2229 0a0a 2020 2020 4077  h_both")..    @w
+0000c090: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
+0000c0a0: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
+0000c0b0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+0000c0c0: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
+0000c0d0: 0a20 2020 2020 2020 2063 6f6d 7075 7465  .        compute
+0000c0e0: 5f74 696d 6573 203d 2064 6566 6175 6c74  _times = default
+0000c0f0: 6469 6374 2866 6c6f 6174 290a 0a20 2020  dict(float)..   
+0000c100: 2020 2020 2066 6f72 206b 6579 2c20 7473       for key, ts
+0000c110: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+0000c120: 6572 2e74 6173 6b5f 7072 6566 6978 6573  er.task_prefixes
+0000c130: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0000c140: 2020 2020 2020 6e61 6d65 203d 206b 6579        name = key
+0000c150: 5f73 706c 6974 286b 6579 290a 2020 2020  _split(key).    
+0000c160: 2020 2020 2020 2020 666f 7220 6163 7469          for acti
+0000c170: 6f6e 2c20 7420 696e 2074 732e 616c 6c5f  on, t in ts.all_
+0000c180: 6475 7261 7469 6f6e 732e 6974 656d 7328  durations.items(
+0000c190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c1a0: 2020 2069 6620 6163 7469 6f6e 203d 3d20     if action == 
+0000c1b0: 2263 6f6d 7075 7465 223a 0a20 2020 2020  "compute":.     
+0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c1d0: 6f6d 7075 7465 5f74 696d 6573 5b6e 616d  ompute_times[nam
+0000c1e0: 655d 202b 3d20 740a 0a20 2020 2020 2020  e] += t..       
+0000c1f0: 2023 206f 7264 6572 2062 7920 6c61 7267   # order by larg
+0000c200: 6573 7420 7469 6d65 2066 6972 7374 0a20  est time first. 
+0000c210: 2020 2020 2020 2063 6f6d 7075 7465 5f74         compute_t
+0000c220: 696d 6573 203d 2073 6f72 7465 6428 636f  imes = sorted(co
+0000c230: 6d70 7574 655f 7469 6d65 732e 6974 656d  mpute_times.item
+0000c240: 7328 292c 206b 6579 3d6c 616d 6264 6120  s(), key=lambda 
+0000c250: 783a 2078 5b31 5d2c 2072 6576 6572 7365  x: x[1], reverse
+0000c260: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+0000c270: 2320 6b65 6570 206f 6e6c 7920 7469 6d65  # keep only time
+0000c280: 2077 6869 6368 2061 7265 2032 2520 6f66   which are 2% of
+0000c290: 206d 6178 206f 7220 6772 6561 7465 720a   max or greater.
+0000c2a0: 2020 2020 2020 2020 6966 2063 6f6d 7075          if compu
+0000c2b0: 7465 5f74 696d 6573 3a0a 2020 2020 2020  te_times:.      
+0000c2c0: 2020 2020 2020 6d61 785f 7469 6d65 203d        max_time =
+0000c2d0: 2063 6f6d 7075 7465 5f74 696d 6573 5b30   compute_times[0
+0000c2e0: 5d5b 315d 202a 2030 2e30 320a 2020 2020  ][1] * 0.02.    
+0000c2f0: 2020 2020 2020 2020 636f 6d70 7574 655f          compute_
+0000c300: 7469 6d65 7320 3d20 5b28 6e2c 2074 2920  times = [(n, t) 
+0000c310: 666f 7220 6e2c 2074 2069 6e20 636f 6d70  for n, t in comp
+0000c320: 7574 655f 7469 6d65 7320 6966 2074 203e  ute_times if t >
+0000c330: 206d 6178 5f74 696d 655d 0a20 2020 2020   max_time].     
+0000c340: 2020 2020 2020 2063 6f6d 7075 7465 5f63         compute_c
+0000c350: 6f6c 6f72 7320 3d20 6c69 7374 2829 0a20  olors = list(). 
+0000c360: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+0000c370: 7465 5f6e 616d 6573 203d 206c 6973 7428  te_names = list(
+0000c380: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0000c390: 6d70 7574 655f 7469 6d65 203d 206c 6973  mpute_time = lis
+0000c3a0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0000c3b0: 746f 7461 6c5f 7469 6d65 203d 2030 0a20  total_time = 0. 
+0000c3c0: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
+0000c3d0: 616d 652c 2074 2069 6e20 636f 6d70 7574  ame, t in comput
+0000c3e0: 655f 7469 6d65 733a 0a20 2020 2020 2020  e_times:.       
+0000c3f0: 2020 2020 2020 2020 2063 6f6d 7075 7465           compute
+0000c400: 5f6e 616d 6573 2e61 7070 656e 6428 6e61  _names.append(na
+0000c410: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0000c420: 2020 2020 636f 6d70 7574 655f 636f 6c6f      compute_colo
+0000c430: 7273 2e61 7070 656e 6428 7473 5f63 6f6c  rs.append(ts_col
+0000c440: 6f72 5f6f 6628 6e61 6d65 2929 0a20 2020  or_of(name)).   
+0000c450: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0000c460: 7075 7465 5f74 696d 652e 6170 7065 6e64  pute_time.append
+0000c470: 2874 290a 2020 2020 2020 2020 2020 2020  (t).            
+0000c480: 2020 2020 746f 7461 6c5f 7469 6d65 202b      total_time +
+0000c490: 3d20 740a 0a20 2020 2020 2020 2020 2020  = t..           
+0000c4a0: 2061 6e67 6c65 7320 3d20 5b74 202f 2074   angles = [t / t
+0000c4b0: 6f74 616c 5f74 696d 6520 2a20 3220 2a20  otal_time * 2 * 
+0000c4c0: 6d61 7468 2e70 6920 666f 7220 7420 696e  math.pi for t in
+0000c4d0: 2063 6f6d 7075 7465 5f74 696d 655d 0a0a   compute_time]..
+0000c4e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c4f0: 2e66 6967 2e78 5f72 616e 6765 2e66 6163  .fig.x_range.fac
+0000c500: 746f 7273 203d 2063 6f6d 7075 7465 5f6e  tors = compute_n
+0000c510: 616d 6573 0a0a 2020 2020 2020 2020 2020  ames..          
+0000c520: 2020 636f 6d70 7574 655f 7265 7375 6c74    compute_result
+0000c530: 203d 2064 6963 7428 0a20 2020 2020 2020   = dict(.       
+0000c540: 2020 2020 2020 2020 2061 6e67 6c65 733d           angles=
+0000c550: 616e 676c 6573 2c0a 2020 2020 2020 2020  angles,.        
+0000c560: 2020 2020 2020 2020 7469 6d65 733d 636f          times=co
+0000c570: 6d70 7574 655f 7469 6d65 2c0a 2020 2020  mpute_time,.    
+0000c580: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0000c590: 723d 636f 6d70 7574 655f 636f 6c6f 7273  r=compute_colors
 0000c5a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c5b0: 2020 666f 726d 6174 7465 645f 7469 6d65    formatted_time
-0000c5c0: 3d5b 666f 726d 6174 5f74 696d 6528 7429  =[format_time(t)
-0000c5d0: 2066 6f72 2074 2069 6e20 636f 6d70 7574   for t in comput
-0000c5e0: 655f 7469 6d65 5d2c 0a20 2020 2020 2020  e_time],.       
-0000c5f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000c600: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-0000c610: 636f 6d70 7574 655f 736f 7572 6365 2c20  compute_source, 
-0000c620: 636f 6d70 7574 655f 7265 7375 6c74 290a  compute_result).
-0000c630: 0a0a 636c 6173 7320 4167 6772 6567 6174  ..class Aggregat
-0000c640: 6541 6374 696f 6e28 4461 7368 626f 6172  eAction(Dashboar
-0000c650: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-0000c660: 2022 2222 4261 7220 6368 6172 7420 7368   """Bar chart sh
-0000c670: 6f77 696e 6720 7469 6d65 2073 7065 6e64  owing time spend
-0000c680: 2069 6e20 6163 7469 6f6e 2062 7920 6b65   in action by ke
-0000c690: 7920 7072 6566 6978 2222 220a 0a20 2020  y prefix"""..   
-0000c6a0: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-0000c6b0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0000c6c0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
-0000c6d0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0000c6e0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
-0000c6f0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0000c700: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-0000c710: 6572 0a0a 2020 2020 2020 2020 6966 2054  er..        if T
-0000c720: 6173 6b53 7472 6561 6d50 6c75 6769 6e2e  askStreamPlugin.
-0000c730: 6e61 6d65 206e 6f74 2069 6e20 7365 6c66  name not in self
-0000c740: 2e73 6368 6564 756c 6572 2e70 6c75 6769  .scheduler.plugi
-0000c750: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0000c760: 7365 6c66 2e73 6368 6564 756c 6572 2e61  self.scheduler.a
-0000c770: 6464 5f70 6c75 6769 6e28 5461 736b 5374  dd_plugin(TaskSt
-0000c780: 7265 616d 506c 7567 696e 2873 656c 662e  reamPlugin(self.
-0000c790: 7363 6865 6475 6c65 7229 290a 0a20 2020  scheduler))..   
-0000c7a0: 2020 2020 2061 6374 696f 6e5f 6461 7461       action_data
-0000c7b0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000c7c0: 2022 7469 6d65 7322 3a20 5b30 2e32 2c20   "times": [0.2, 
-0000c7d0: 302e 315d 2c0a 2020 2020 2020 2020 2020  0.1],.          
-0000c7e0: 2020 2266 6f72 6d61 7474 6564 5f74 696d    "formatted_tim
-0000c7f0: 6522 3a20 5b22 302e 3220 6d73 222c 2022  e": ["0.2 ms", "
-0000c800: 322e 3820 7573 225d 2c0a 2020 2020 2020  2.8 us"],.      
-0000c810: 2020 2020 2020 2263 6f6c 6f72 223a 205b        "color": [
-0000c820: 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75 705b  ts_color_lookup[
-0000c830: 2274 7261 6e73 6665 7222 5d2c 2074 735f  "transfer"], ts_
-0000c840: 636f 6c6f 725f 6c6f 6f6b 7570 5b22 636f  color_lookup["co
-0000c850: 6d70 7574 6522 5d5d 2c0a 2020 2020 2020  mpute"]],.      
-0000c860: 2020 2020 2020 226e 616d 6573 223a 205b        "names": [
-0000c870: 2274 7261 6e73 6665 7222 2c20 2263 6f6d  "transfer", "com
-0000c880: 7075 7465 225d 2c0a 2020 2020 2020 2020  pute"],.        
-0000c890: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
-0000c8a0: 6163 7469 6f6e 5f73 6f75 7263 6520 3d20  action_source = 
-0000c8b0: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-0000c8c0: 2864 6174 613d 6163 7469 6f6e 5f64 6174  (data=action_dat
-0000c8d0: 6129 0a0a 2020 2020 2020 2020 7365 6c66  a)..        self
-0000c8e0: 2e72 6f6f 7420 3d20 6669 6775 7265 280a  .root = figure(.
-0000c8f0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0000c900: 653d 2241 6767 7265 6761 7465 2050 6572  e="Aggregate Per
-0000c910: 2041 6374 696f 6e22 2c0a 2020 2020 2020   Action",.      
-0000c920: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-0000c930: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000c940: 3d22 6167 6772 6567 6174 655f 7065 725f  ="aggregate_per_
-0000c950: 6163 7469 6f6e 222c 0a20 2020 2020 2020  action",.       
-0000c960: 2020 2020 2078 5f72 616e 6765 3d5b 2261       x_range=["a
-0000c970: 222c 2022 6222 5d2c 0a20 2020 2020 2020  ", "b"],.       
-0000c980: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0000c990: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000c9a0: 2020 7265 6374 203d 2073 656c 662e 726f    rect = self.ro
-0000c9b0: 6f74 2e76 6261 7228 0a20 2020 2020 2020  ot.vbar(.       
-0000c9c0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000c9d0: 2e61 6374 696f 6e5f 736f 7572 6365 2c0a  .action_source,.
-0000c9e0: 2020 2020 2020 2020 2020 2020 783d 226e              x="n
-0000c9f0: 616d 6573 222c 0a20 2020 2020 2020 2020  ames",.         
-0000ca00: 2020 2074 6f70 3d22 7469 6d65 7322 2c0a     top="times",.
-0000ca10: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0000ca20: 683d 302e 372c 0a20 2020 2020 2020 2020  h=0.7,.         
-0000ca30: 2020 2063 6f6c 6f72 3d22 636f 6c6f 7222     color="color"
-0000ca40: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0000ca50: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-0000ca60: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
-0000ca70: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000ca80: 6f74 2e79 6178 6973 5b30 5d2e 666f 726d  ot.yaxis[0].form
-0000ca90: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
-0000caa0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
-0000cab0: 6d61 743d 2230 2229 0a20 2020 2020 2020  mat="0").       
-0000cac0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-0000cad0: 2e61 7869 735f 6c61 6265 6c20 3d20 2254  .axis_label = "T
-0000cae0: 696d 6520 2873 2922 0a20 2020 2020 2020  ime (s)".       
-0000caf0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-0000cb00: 2e74 6963 6b65 7220 3d20 4164 6170 7469  .ticker = Adapti
-0000cb10: 7665 5469 636b 6572 282a 2a54 4943 4b53  veTicker(**TICKS
-0000cb20: 5f31 3032 3429 0a20 2020 2020 2020 2073  _1024).        s
-0000cb30: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
-0000cb40: 616a 6f72 5f6c 6162 656c 5f6f 7269 656e  ajor_label_orien
-0000cb50: 7461 7469 6f6e 203d 2058 4c41 4245 4c5f  tation = XLABEL_
-0000cb60: 4f52 4945 4e54 4154 494f 4e0a 2020 2020  ORIENTATION.    
-0000cb70: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-0000cb80: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
-0000cb90: 7465 7874 5f66 6f6e 745f 7369 7a65 203d  text_font_size =
-0000cba0: 2022 3136 7078 220a 2020 2020 2020 2020   "16px".        
-0000cbb0: 7265 6374 2e6e 6f6e 7365 6c65 6374 696f  rect.nonselectio
-0000cbc0: 6e5f 676c 7970 6820 3d20 4e6f 6e65 0a0a  n_glyph = None..
-0000cbd0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0000cbe0: 742e 7861 7869 732e 6d69 6e6f 725f 7469  t.xaxis.minor_ti
-0000cbf0: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
-0000cc00: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
-0000cc10: 6f6f 742e 7867 7269 642e 7669 7369 626c  oot.xgrid.visibl
-0000cc20: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-0000cc30: 2020 2073 656c 662e 726f 6f74 2e74 6f6f     self.root.too
-0000cc40: 6c62 6172 5f6c 6f63 6174 696f 6e20 3d20  lbar_location = 
-0000cc50: 4e6f 6e65 0a0a 2020 2020 2020 2020 686f  None..        ho
-0000cc60: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-0000cc70: 290a 2020 2020 2020 2020 686f 7665 722e  ).        hover.
-0000cc80: 746f 6f6c 7469 7073 203d 2022 2222 0a20  tooltips = """. 
-0000cc90: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-0000cca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ccb0: 203c 703e 3c62 3e4e 616d 653a 3c2f 623e   <p><b>Name:</b>
-0000ccc0: 2040 6e61 6d65 733c 2f70 3e0a 2020 2020   @names</p>.    
-0000ccd0: 2020 2020 2020 2020 2020 2020 3c70 3e3c              <p><
-0000cce0: 623e 5469 6d65 3a3c 2f62 3e20 4066 6f72  b>Time:</b> @for
-0000ccf0: 6d61 7474 6564 5f74 696d 653c 2f70 3e0a  matted_time</p>.
-0000cd00: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-0000cd10: 763e 0a20 2020 2020 2020 2020 2020 2022  v>.            "
-0000cd20: 2222 0a20 2020 2020 2020 2068 6f76 6572  "".        hover
-0000cd30: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
-0000cd40: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
-0000cd50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000cd60: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
-0000cd70: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-0000cd80: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-0000cd90: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-0000cda0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-0000cdb0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-0000cdc0: 2020 6167 675f 7469 6d65 7320 3d20 6465    agg_times = de
-0000cdd0: 6661 756c 7464 6963 7428 666c 6f61 7429  faultdict(float)
-0000cde0: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
-0000cdf0: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-0000ce00: 6572 2e74 6173 6b5f 7072 6566 6978 6573  er.task_prefixes
-0000ce10: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-0000ce20: 2020 2020 2020 2066 6f72 2061 6374 696f         for actio
-0000ce30: 6e2c 2074 2069 6e20 7473 2e61 6c6c 5f64  n, t in ts.all_d
-0000ce40: 7572 6174 696f 6e73 2e69 7465 6d73 2829  urations.items()
-0000ce50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ce60: 2020 6167 675f 7469 6d65 735b 6163 7469    agg_times[acti
-0000ce70: 6f6e 5d20 2b3d 2074 0a0a 2020 2020 2020  on] += t..      
-0000ce80: 2020 2320 6f72 6465 7220 6279 206c 6172    # order by lar
-0000ce90: 6765 7374 2074 696d 6520 6669 7273 740a  gest time first.
-0000cea0: 2020 2020 2020 2020 6167 675f 7469 6d65          agg_time
-0000ceb0: 7320 3d20 736f 7274 6564 2861 6767 5f74  s = sorted(agg_t
-0000cec0: 696d 6573 2e69 7465 6d73 2829 2c20 6b65  imes.items(), ke
-0000ced0: 793d 6c61 6d62 6461 2078 3a20 785b 315d  y=lambda x: x[1]
-0000cee0: 2c20 7265 7665 7273 653d 5472 7565 290a  , reverse=True).
-0000cef0: 0a20 2020 2020 2020 2061 6767 5f63 6f6c  .        agg_col
-0000cf00: 6f72 7320 3d20 6c69 7374 2829 0a20 2020  ors = list().   
-0000cf10: 2020 2020 2061 6767 5f6e 616d 6573 203d       agg_names =
-0000cf20: 206c 6973 7428 290a 2020 2020 2020 2020   list().        
-0000cf30: 6167 675f 7469 6d65 203d 206c 6973 7428  agg_time = list(
-0000cf40: 290a 2020 2020 2020 2020 666f 7220 6163  ).        for ac
-0000cf50: 7469 6f6e 2c20 7420 696e 2061 6767 5f74  tion, t in agg_t
-0000cf60: 696d 6573 3a0a 2020 2020 2020 2020 2020  imes:.          
-0000cf70: 2020 6167 675f 6e61 6d65 732e 6170 7065    agg_names.appe
-0000cf80: 6e64 2861 6374 696f 6e29 0a20 2020 2020  nd(action).     
-0000cf90: 2020 2020 2020 2069 6620 6163 7469 6f6e         if action
-0000cfa0: 203d 3d20 2263 6f6d 7075 7465 223a 0a20   == "compute":. 
-0000cfb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000cfc0: 6767 5f63 6f6c 6f72 732e 6170 7065 6e64  gg_colors.append
-0000cfd0: 2822 7075 7270 6c65 2229 0a20 2020 2020  ("purple").     
-0000cfe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000cff0: 2020 2020 2020 2020 2020 2020 2061 6767               agg
-0000d000: 5f63 6f6c 6f72 732e 6170 7065 6e64 2874  _colors.append(t
-0000d010: 735f 636f 6c6f 725f 6c6f 6f6b 7570 5b61  s_color_lookup[a
-0000d020: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
-0000d030: 2020 2020 6167 675f 7469 6d65 2e61 7070      agg_time.app
-0000d040: 656e 6428 7429 0a0a 2020 2020 2020 2020  end(t)..        
-0000d050: 7365 6c66 2e72 6f6f 742e 785f 7261 6e67  self.root.x_rang
-0000d060: 652e 6661 6374 6f72 7320 3d20 6167 675f  e.factors = agg_
-0000d070: 6e61 6d65 730a 2020 2020 2020 2020 7365  names.        se
-0000d080: 6c66 2e72 6f6f 742e 7469 746c 652e 7465  lf.root.title.te
-0000d090: 7874 203d 2022 4167 6772 6567 6174 6520  xt = "Aggregate 
-0000d0a0: 5469 6d65 2050 6572 2041 6374 696f 6e22  Time Per Action"
-0000d0b0: 0a0a 2020 2020 2020 2020 6163 7469 6f6e  ..        action
-0000d0c0: 5f72 6573 756c 7420 3d20 6469 6374 280a  _result = dict(.
-0000d0d0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000d0e0: 733d 6167 675f 7469 6d65 2c0a 2020 2020  s=agg_time,.    
-0000d0f0: 2020 2020 2020 2020 636f 6c6f 723d 6167          color=ag
-0000d100: 675f 636f 6c6f 7273 2c0a 2020 2020 2020  g_colors,.      
-0000d110: 2020 2020 2020 6e61 6d65 733d 6167 675f        names=agg_
-0000d120: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
-0000d130: 2020 2066 6f72 6d61 7474 6564 5f74 696d     formatted_tim
-0000d140: 653d 5b66 6f72 6d61 745f 7469 6d65 2874  e=[format_time(t
-0000d150: 2920 666f 7220 7420 696e 2061 6767 5f74  ) for t in agg_t
-0000d160: 696d 655d 2c0a 2020 2020 2020 2020 290a  ime],.        ).
-0000d170: 0a20 2020 2020 2020 2075 7064 6174 6528  .        update(
-0000d180: 7365 6c66 2e61 6374 696f 6e5f 736f 7572  self.action_sour
-0000d190: 6365 2c20 6163 7469 6f6e 5f72 6573 756c  ce, action_resul
-0000d1a0: 7429 0a0a 0a63 6c61 7373 204d 656d 6f72  t)...class Memor
-0000d1b0: 7942 794b 6579 2844 6173 6862 6f61 7264  yByKey(Dashboard
-0000d1c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-0000d1d0: 2222 2242 6172 2063 6861 7274 2073 686f  """Bar chart sho
-0000d1e0: 7769 6e67 206d 656d 6f72 7920 7573 6520  wing memory use 
-0000d1f0: 6279 206b 6579 2070 7265 6669 7822 2222  by key prefix"""
-0000d200: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0000d210: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
-0000d220: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-0000d230: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-0000d240: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000d250: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000d260: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-0000d270: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-0000d280: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
-0000d290: 6c75 6d6e 4461 7461 536f 7572 6365 280a  lumnDataSource(.
-0000d2a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0000d2b0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-0000d2c0: 616d 6522 3a20 5b22 6122 2c20 2262 225d  ame": ["a", "b"]
-0000d2d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d2e0: 2020 226e 6279 7465 7322 3a20 5b31 3030    "nbytes": [100
-0000d2f0: 2c20 3130 3030 5d2c 0a20 2020 2020 2020  , 1000],.       
-0000d300: 2020 2020 2020 2020 2022 636f 756e 7422           "count"
-0000d310: 3a20 5b31 2c20 325d 2c0a 2020 2020 2020  : [1, 2],.      
-0000d320: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
-0000d330: 223a 205b 2262 6c75 6522 2c20 2262 6c75  ": ["blue", "blu
-0000d340: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
-0000d350: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
-0000d360: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-0000d370: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-0000d380: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
-0000d390: 6f72 7920 5573 6522 2c0a 2020 2020 2020  ory Use",.      
-0000d3a0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-0000d3b0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000d3c0: 3d22 6d65 6d6f 7279 5f62 795f 6b65 7922  ="memory_by_key"
-0000d3d0: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
-0000d3e0: 7261 6e67 653d 5b22 6122 2c20 2262 225d  range=["a", "b"]
-0000d3f0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-0000d400: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-0000d410: 290a 2020 2020 2020 2020 7265 6374 203d  ).        rect =
-0000d420: 2073 656c 662e 726f 6f74 2e76 6261 7228   self.root.vbar(
-0000d430: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0000d440: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0000d450: 2078 3d22 6e61 6d65 222c 2074 6f70 3d22   x="name", top="
-0000d460: 6e62 7974 6573 222c 2077 6964 7468 3d30  nbytes", width=0
-0000d470: 2e39 2c20 636f 6c6f 723d 2263 6f6c 6f72  .9, color="color
-0000d480: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000d490: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
-0000d4a0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
-0000d4b0: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
-0000d4c0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-0000d4d0: 302e 3020 6222 290a 2020 2020 2020 2020  0.0 b").        
-0000d4e0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
-0000d4f0: 7469 636b 6572 203d 2041 6461 7074 6976  ticker = Adaptiv
-0000d500: 6554 6963 6b65 7228 2a2a 5449 434b 535f  eTicker(**TICKS_
-0000d510: 3130 3234 290a 2020 2020 2020 2020 7365  1024).        se
-0000d520: 6c66 2e72 6f6f 742e 7861 7869 732e 6d61  lf.root.xaxis.ma
-0000d530: 6a6f 725f 6c61 6265 6c5f 6f72 6965 6e74  jor_label_orient
-0000d540: 6174 696f 6e20 3d20 584c 4142 454c 5f4f  ation = XLABEL_O
-0000d550: 5249 454e 5441 5449 4f4e 0a20 2020 2020  RIENTATION.     
-0000d560: 2020 2072 6563 742e 6e6f 6e73 656c 6563     rect.nonselec
-0000d570: 7469 6f6e 5f67 6c79 7068 203d 204e 6f6e  tion_glyph = Non
-0000d580: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-0000d590: 726f 6f74 2e78 6178 6973 2e6d 696e 6f72  root.xaxis.minor
-0000d5a0: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
-0000d5b0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000d5c0: 662e 726f 6f74 2e79 6772 6964 2e76 6973  f.root.ygrid.vis
-0000d5d0: 6962 6c65 203d 2046 616c 7365 0a0a 2020  ible = False..  
-0000d5e0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000d5f0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-0000d600: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0000d610: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
-0000d620: 6f6c 2829 0a20 2020 2020 2020 2068 6f76  ol().        hov
-0000d630: 6572 2e74 6f6f 6c74 6970 7320 3d20 2240  er.tooltips = "@
-0000d640: 6e61 6d65 3a20 406e 6279 7465 735f 7465  name: @nbytes_te
-0000d650: 7874 220a 2020 2020 2020 2020 686f 7665  xt".        hove
-0000d660: 722e 746f 6f6c 7469 7073 203d 2022 2222  r.tooltips = """
-0000d670: 0a20 2020 2020 2020 2020 2020 203c 6469  .            <di
-0000d680: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0000d690: 2020 203c 703e 3c62 3e4e 616d 653a 3c2f     <p><b>Name:</
-0000d6a0: 623e 2040 6e61 6d65 3c2f 703e 0a20 2020  b> @name</p>.   
-0000d6b0: 2020 2020 2020 2020 2020 2020 203c 703e               <p>
-0000d6c0: 3c62 3e42 7974 6573 3a3c 2f62 3e20 406e  <b>Bytes:</b> @n
-0000d6d0: 6279 7465 735f 7465 7874 203c 2f70 3e0a  bytes_text </p>.
-0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6f0: 3c70 3e3c 623e 436f 756e 743a 3c2f 623e  <p><b>Count:</b>
-0000d700: 2040 636f 756e 7420 6f62 6a65 6374 7320   @count objects 
-0000d710: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
-0000d720: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-0000d730: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000d740: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
-0000d750: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
-0000d760: 7365 220a 2020 2020 2020 2020 7365 6c66  se".        self
-0000d770: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-0000d780: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
-0000d790: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-0000d7a0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-0000d7b0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0000d7c0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-0000d7d0: 2020 2020 2020 2063 6f75 6e74 7320 3d20         counts = 
-0000d7e0: 6465 6661 756c 7464 6963 7428 696e 7429  defaultdict(int)
-0000d7f0: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
-0000d800: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
-0000d810: 7429 0a20 2020 2020 2020 2066 6f72 2077  t).        for w
-0000d820: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
-0000d830: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-0000d840: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-0000d850: 2020 666f 7220 7473 2069 6e20 7773 2e68    for ts in ws.h
-0000d860: 6173 5f77 6861 743a 0a20 2020 2020 2020  as_what:.       
-0000d870: 2020 2020 2020 2020 206b 7320 3d20 6b65           ks = ke
-0000d880: 795f 7370 6c69 7428 7473 2e6b 6579 290a  y_split(ts.key).
-0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8a0: 636f 756e 7473 5b6b 735d 202b 3d20 310a  counts[ks] += 1.
-0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8c0: 6e62 7974 6573 5b6b 735d 202b 3d20 7473  nbytes[ks] += ts
-0000d8d0: 2e6e 6279 7465 730a 0a20 2020 2020 2020  .nbytes..       
-0000d8e0: 206e 616d 6573 203d 206c 6973 7428 736f   names = list(so
-0000d8f0: 7274 6564 2863 6f75 6e74 7329 290a 2020  rted(counts)).  
-0000d900: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0000d910: 785f 7261 6e67 652e 6661 6374 6f72 7320  x_range.factors 
-0000d920: 3d20 6e61 6d65 730a 2020 2020 2020 2020  = names.        
-0000d930: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
-0000d940: 2020 2020 2020 2022 6e61 6d65 223a 206e         "name": n
-0000d950: 616d 6573 2c0a 2020 2020 2020 2020 2020  ames,.          
-0000d960: 2020 2263 6f75 6e74 223a 205b 636f 756e    "count": [coun
-0000d970: 7473 5b6e 616d 655d 2066 6f72 206e 616d  ts[name] for nam
-0000d980: 6520 696e 206e 616d 6573 5d2c 0a20 2020  e in names],.   
-0000d990: 2020 2020 2020 2020 2022 6e62 7974 6573           "nbytes
-0000d9a0: 223a 205b 6e62 7974 6573 5b6e 616d 655d  ": [nbytes[name]
-0000d9b0: 2066 6f72 206e 616d 6520 696e 206e 616d   for name in nam
-0000d9c0: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
-0000d9d0: 2022 6e62 7974 6573 5f74 6578 7422 3a20   "nbytes_text": 
-0000d9e0: 5b66 6f72 6d61 745f 6279 7465 7328 6e62  [format_bytes(nb
-0000d9f0: 7974 6573 5b6e 616d 655d 2920 666f 7220  ytes[name]) for 
-0000da00: 6e61 6d65 2069 6e20 6e61 6d65 735d 2c0a  name in names],.
-0000da10: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-0000da20: 6f72 223a 205b 636f 6c6f 725f 6f66 286e  or": [color_of(n
-0000da30: 616d 6529 2066 6f72 206e 616d 6520 696e  ame) for name in
-0000da40: 206e 616d 6573 5d2c 0a20 2020 2020 2020   names],.       
-0000da50: 207d 0a20 2020 2020 2020 2073 656c 662e   }.        self.
-0000da60: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
-0000da70: 3d20 2254 6f74 616c 2055 7365 3a20 2220  = "Total Use: " 
-0000da80: 2b20 666f 726d 6174 5f62 7974 6573 2873  + format_bytes(s
-0000da90: 756d 286e 6279 7465 732e 7661 6c75 6573  um(nbytes.values
-0000daa0: 2829 2929 0a0a 2020 2020 2020 2020 7570  ()))..        up
-0000dab0: 6461 7465 2873 656c 662e 736f 7572 6365  date(self.source
-0000dac0: 2c20 7265 7375 6c74 290a 0a0a 636c 6173  , result)...clas
-0000dad0: 7320 4375 7272 656e 744c 6f61 6428 4461  s CurrentLoad(Da
-0000dae0: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-0000daf0: 293a 0a20 2020 2022 2222 5461 736b 7320  ):.    """Tasks 
-0000db00: 616e 6420 4350 5520 7573 6167 6520 6f6e  and CPU usage on
-0000db10: 2065 6163 6820 776f 726b 6572 2222 220a   each worker""".
-0000db20: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0000db30: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0000db40: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-0000db50: 722c 2077 6964 7468 3d36 3030 2c20 2a2a  r, width=600, **
-0000db60: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000db70: 2073 656c 662e 6c61 7374 203d 2030 0a20   self.last = 0. 
-0000db80: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-0000db90: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-0000dba0: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
-0000dbb0: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-0000dbc0: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
-0000dbd0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0000dbe0: 2020 2020 2020 2020 226e 7072 6f63 6573          "nproces
-0000dbf0: 7369 6e67 223a 205b 5d2c 0a20 2020 2020  sing": [],.     
-0000dc00: 2020 2020 2020 2020 2020 2022 6e70 726f             "npro
-0000dc10: 6365 7373 696e 672d 6861 6c66 223a 205b  cessing-half": [
-0000dc20: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000dc30: 2020 2022 6e70 726f 6365 7373 696e 672d     "nprocessing-
-0000dc40: 636f 6c6f 7222 3a20 5b5d 2c0a 2020 2020  color": [],.    
-0000dc50: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
-0000dc60: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-0000dc70: 2020 2020 2020 2022 6370 752d 6861 6c66         "cpu-half
-0000dc80: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-0000dc90: 2020 2020 2020 2022 7922 3a20 5b5d 2c0a         "y": [],.
-0000dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcb0: 2277 6f72 6b65 7222 3a20 5b5d 2c0a 2020  "worker": [],.  
-0000dcc0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-0000dcd0: 7363 6170 6564 5f77 6f72 6b65 7222 3a20  scaped_worker": 
-0000dce0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-0000dcf0: 7d0a 2020 2020 2020 2020 290a 2020 2020  }.        ).    
-0000dd00: 2020 2020 7072 6f63 6573 7369 6e67 203d      processing =
-0000dd10: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-0000dd20: 2020 2020 2074 6974 6c65 3d22 5461 736b       title="Task
-0000dd30: 7320 5072 6f63 6573 7369 6e67 222c 0a20  s Processing",. 
-0000dd40: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0000dd50: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-0000dd60: 206e 616d 653d 2270 726f 6365 7373 696e   name="processin
-0000dd70: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-0000dd80: 7769 6474 683d 696e 7428 7769 6474 6820  width=int(width 
-0000dd90: 2f20 3229 2c0a 2020 2020 2020 2020 2020  / 2),.          
-0000dda0: 2020 6d69 6e5f 626f 7264 6572 5f62 6f74    min_border_bot
-0000ddb0: 746f 6d3d 3530 2c0a 2020 2020 2020 2020  tom=50,.        
-0000ddc0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0000ddd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000dde0: 7265 6374 203d 2070 726f 6365 7373 696e  rect = processin
-0000ddf0: 672e 7265 6374 280a 2020 2020 2020 2020  g.rect(.        
-0000de00: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0000de10: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0000de20: 2020 2020 783d 226e 7072 6f63 6573 7369      x="nprocessi
-0000de30: 6e67 2d68 616c 6622 2c0a 2020 2020 2020  ng-half",.      
-0000de40: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
-0000de50: 2020 2020 2020 2020 2077 6964 7468 3d22           width="
-0000de60: 6e70 726f 6365 7373 696e 6722 2c0a 2020  nprocessing",.  
-0000de70: 2020 2020 2020 2020 2020 6865 6967 6874            height
-0000de80: 3d30 2e39 2c0a 2020 2020 2020 2020 2020  =0.9,.          
-0000de90: 2020 636f 6c6f 723d 226e 7072 6f63 6573    color="nproces
-0000dea0: 7369 6e67 2d63 6f6c 6f72 222c 0a20 2020  sing-color",.   
-0000deb0: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
-0000dec0: 726f 6365 7373 696e 672e 785f 7261 6e67  rocessing.x_rang
-0000ded0: 652e 7374 6172 7420 3d20 300a 2020 2020  e.start = 0.    
-0000dee0: 2020 2020 7265 6374 2e6e 6f6e 7365 6c65      rect.nonsele
-0000def0: 6374 696f 6e5f 676c 7970 6820 3d20 4e6f  ction_glyph = No
-0000df00: 6e65 0a0a 2020 2020 2020 2020 6370 7520  ne..        cpu 
-0000df10: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-0000df20: 2020 2020 2020 7469 746c 653d 2243 5055        title="CPU
-0000df30: 2055 7469 6c69 7a61 7469 6f6e 222c 0a20   Utilization",. 
-0000df40: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-0000df50: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-0000df60: 2077 6964 7468 3d69 6e74 2877 6964 7468   width=int(width
-0000df70: 202f 2032 292c 0a20 2020 2020 2020 2020   / 2),.         
-0000df80: 2020 206e 616d 653d 2263 7075 5f68 6973     name="cpu_his
-0000df90: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0000dfa0: 785f 7261 6e67 653d 2830 2c20 3130 3029  x_range=(0, 100)
-0000dfb0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-0000dfc0: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
-0000dfd0: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
-0000dfe0: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-0000dff0: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
-0000e000: 203d 2063 7075 2e72 6563 7428 0a20 2020   = cpu.rect(.   
-0000e010: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0000e020: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0000e030: 2020 2020 2020 2020 2078 3d22 6370 752d           x="cpu-
-0000e040: 6861 6c66 222c 0a20 2020 2020 2020 2020  half",.         
-0000e050: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
-0000e060: 2020 2020 2020 7769 6474 683d 2263 7075        width="cpu
-0000e070: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-0000e080: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
-0000e090: 2020 2020 2020 2063 6f6c 6f72 3d22 626c         color="bl
-0000e0a0: 7565 222c 0a20 2020 2020 2020 2029 0a20  ue",.        ). 
-0000e0b0: 2020 2020 2020 2072 6563 742e 6e6f 6e73         rect.nons
-0000e0c0: 656c 6563 7469 6f6e 5f67 6c79 7068 203d  election_glyph =
-0000e0d0: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
-0000e0e0: 6f72 2066 6967 2069 6e20 2870 726f 6365  or fig in (proce
-0000e0f0: 7373 696e 672c 2063 7075 293a 0a20 2020  ssing, cpu):.   
-0000e100: 2020 2020 2020 2020 2066 6967 2e78 6178           fig.xax
-0000e110: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-0000e120: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-0000e130: 2020 2020 2020 2020 2066 6967 2e79 6178           fig.yax
-0000e140: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-0000e150: 7365 0a20 2020 2020 2020 2020 2020 2066  se.            f
-0000e160: 6967 2e79 6772 6964 2e76 6973 6962 6c65  ig.ygrid.visible
-0000e170: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0000e180: 2020 2020 2020 7461 7020 3d20 5461 7054        tap = TapT
-0000e190: 6f6f 6c28 6361 6c6c 6261 636b 3d4f 7065  ool(callback=Ope
-0000e1a0: 6e55 524c 2875 726c 3d22 2e2f 696e 666f  nURL(url="./info
-0000e1b0: 2f77 6f72 6b65 722f 4065 7363 6170 6564  /worker/@escaped
-0000e1c0: 5f77 6f72 6b65 722e 6874 6d6c 2229 290a  _worker.html")).
-0000e1d0: 2020 2020 2020 2020 2020 2020 6669 672e              fig.
-0000e1e0: 6164 645f 746f 6f6c 7328 7461 7029 0a0a  add_tools(tap)..
-0000e1f0: 2020 2020 2020 2020 2020 2020 6669 672e              fig.
-0000e200: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-0000e210: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000e220: 2020 2020 6669 672e 7961 7869 732e 7669      fig.yaxis.vi
-0000e230: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-0000e240: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-0000e250: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
-0000e260: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
-0000e270: 7320 3d20 2240 776f 726b 6572 203a 2040  s = "@worker : @
-0000e280: 6e70 726f 6365 7373 696e 6720 7461 736b  nprocessing task
-0000e290: 7322 0a20 2020 2020 2020 2068 6f76 6572  s".        hover
-0000e2a0: 2e70 6f69 6e74 5f70 6f6c 6963 7920 3d20  .point_policy = 
-0000e2b0: 2266 6f6c 6c6f 775f 6d6f 7573 6522 0a20  "follow_mouse". 
-0000e2c0: 2020 2020 2020 2070 726f 6365 7373 696e         processin
-0000e2d0: 672e 6164 645f 746f 6f6c 7328 686f 7665  g.add_tools(hove
-0000e2e0: 7229 0a0a 2020 2020 2020 2020 686f 7665  r)..        hove
-0000e2f0: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
-0000e300: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
-0000e310: 6f6c 7469 7073 203d 2022 4077 6f72 6b65  oltips = "@worke
-0000e320: 7220 3a20 4063 7075 2025 220a 2020 2020  r : @cpu %".    
-0000e330: 2020 2020 686f 7665 722e 706f 696e 745f      hover.point_
-0000e340: 706f 6c69 6379 203d 2022 666f 6c6c 6f77  policy = "follow
-0000e350: 5f6d 6f75 7365 220a 2020 2020 2020 2020  _mouse".        
-0000e360: 6370 752e 6164 645f 746f 6f6c 7328 686f  cpu.add_tools(ho
-0000e370: 7665 7229 0a0a 2020 2020 2020 2020 7365  ver)..        se
-0000e380: 6c66 2e70 726f 6365 7373 696e 675f 6669  lf.processing_fi
-0000e390: 6775 7265 203d 2070 726f 6365 7373 696e  gure = processin
-0000e3a0: 670a 2020 2020 2020 2020 7365 6c66 2e63  g.        self.c
-0000e3b0: 7075 5f66 6967 7572 6520 3d20 6370 750a  pu_figure = cpu.
-0000e3c0: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-0000e3d0: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-0000e3e0: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-0000e3f0: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-0000e400: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000e410: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
-0000e420: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0000e430: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-0000e440: 2020 6e6f 7720 3d20 7469 6d65 2829 0a20    now = time(). 
-0000e450: 2020 2020 2020 2069 6620 6e6f 7420 616e         if not an
-0000e460: 7928 7773 2e70 726f 6365 7373 696e 6720  y(ws.processing 
-0000e470: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-0000e480: 7329 2061 6e64 206e 6f77 203c 2073 656c  s) and now < sel
-0000e490: 662e 6c61 7374 202b 2031 3a0a 2020 2020  f.last + 1:.    
-0000e4a0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000e4b0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000e4c0: 203d 206e 6f77 0a0a 2020 2020 2020 2020   = now..        
-0000e4d0: 6370 7520 3d20 5b69 6e74 2877 732e 6d65  cpu = [int(ws.me
-0000e4e0: 7472 6963 735b 2263 7075 225d 2920 666f  trics["cpu"]) fo
-0000e4f0: 7220 7773 2069 6e20 776f 726b 6572 735d  r ws in workers]
-0000e500: 0a20 2020 2020 2020 206e 7072 6f63 6573  .        nproces
-0000e510: 7369 6e67 203d 205b 6c65 6e28 7773 2e70  sing = [len(ws.p
-0000e520: 726f 6365 7373 696e 6729 2066 6f72 2077  rocessing) for w
-0000e530: 7320 696e 2077 6f72 6b65 7273 5d0a 0a20  s in workers].. 
-0000e540: 2020 2020 2020 206e 7072 6f63 6573 7369         nprocessi
-0000e550: 6e67 5f63 6f6c 6f72 203d 205b 5d0a 2020  ng_color = [].  
-0000e560: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-0000e570: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-0000e580: 2020 2020 2069 6620 7773 2069 6e20 7365       if ws in se
-0000e590: 6c66 2e73 6368 6564 756c 6572 2e69 646c  lf.scheduler.idl
-0000e5a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e5b0: 2020 206e 7072 6f63 6573 7369 6e67 5f63     nprocessing_c
-0000e5c0: 6f6c 6f72 2e61 7070 656e 6428 2272 6564  olor.append("red
-0000e5d0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
-0000e5e0: 6c69 6620 7773 2069 6e20 7365 6c66 2e73  lif ws in self.s
-0000e5f0: 6368 6564 756c 6572 2e73 6174 7572 6174  cheduler.saturat
-0000e600: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0000e610: 2020 2020 6e70 726f 6365 7373 696e 675f      nprocessing_
-0000e620: 636f 6c6f 722e 6170 7065 6e64 2822 6772  color.append("gr
-0000e630: 6565 6e22 290a 2020 2020 2020 2020 2020  een").          
-0000e640: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000e650: 2020 2020 2020 2020 6e70 726f 6365 7373          nprocess
-0000e660: 696e 675f 636f 6c6f 722e 6170 7065 6e64  ing_color.append
-0000e670: 2822 626c 7565 2229 0a0a 2020 2020 2020  ("blue")..      
-0000e680: 2020 7265 7375 6c74 203d 207b 0a20 2020    result = {.   
-0000e690: 2020 2020 2020 2020 2022 6370 7522 3a20           "cpu": 
-0000e6a0: 6370 752c 0a20 2020 2020 2020 2020 2020  cpu,.           
-0000e6b0: 2022 6370 752d 6861 6c66 223a 205b 6320   "cpu-half": [c 
-0000e6c0: 2f20 3220 666f 7220 6320 696e 2063 7075  / 2 for c in cpu
-0000e6d0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0000e6e0: 6e70 726f 6365 7373 696e 6722 3a20 6e70  nprocessing": np
-0000e6f0: 726f 6365 7373 696e 672c 0a20 2020 2020  rocessing,.     
-0000e700: 2020 2020 2020 2022 6e70 726f 6365 7373         "nprocess
-0000e710: 696e 672d 6861 6c66 223a 205b 6e70 202f  ing-half": [np /
-0000e720: 2032 2066 6f72 206e 7020 696e 206e 7072   2 for np in npr
-0000e730: 6f63 6573 7369 6e67 5d2c 0a20 2020 2020  ocessing],.     
-0000e740: 2020 2020 2020 2022 6e70 726f 6365 7373         "nprocess
-0000e750: 696e 672d 636f 6c6f 7222 3a20 6e70 726f  ing-color": npro
-0000e760: 6365 7373 696e 675f 636f 6c6f 722c 0a20  cessing_color,. 
-0000e770: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-0000e780: 6572 223a 205b 7773 2e61 6464 7265 7373  er": [ws.address
-0000e790: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
-0000e7a0: 7273 5d2c 0a20 2020 2020 2020 2020 2020  rs],.           
-0000e7b0: 2022 6573 6361 7065 645f 776f 726b 6572   "escaped_worker
-0000e7c0: 223a 205b 6573 6361 7065 2e75 726c 5f65  ": [escape.url_e
-0000e7d0: 7363 6170 6528 7773 2e61 6464 7265 7373  scape(ws.address
-0000e7e0: 2920 666f 7220 7773 2069 6e20 776f 726b  ) for ws in work
-0000e7f0: 6572 735d 2c0a 2020 2020 2020 2020 2020  ers],.          
-0000e800: 2020 2279 223a 206c 6973 7428 7261 6e67    "y": list(rang
-0000e810: 6528 6c65 6e28 776f 726b 6572 7329 2929  e(len(workers)))
-0000e820: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-0000e830: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-0000e840: 6564 756c 6572 2e77 6f72 6b65 7273 3a0a  eduler.workers:.
-0000e850: 2020 2020 2020 2020 2020 2020 7872 616e              xran
-0000e860: 6765 203d 206d 6178 2877 732e 6e74 6872  ge = max(ws.nthr
-0000e870: 6561 6473 206f 7220 3120 666f 7220 7773  eads or 1 for ws
-0000e880: 2069 6e20 776f 726b 6572 7329 0a20 2020   in workers).   
-0000e890: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000e8a0: 2020 2020 2020 2078 7261 6e67 6520 3d20         xrange = 
-0000e8b0: 310a 2020 2020 2020 2020 7365 6c66 2e63  1.        self.c
-0000e8c0: 7075 5f66 6967 7572 652e 785f 7261 6e67  pu_figure.x_rang
-0000e8d0: 652e 656e 6420 3d20 7872 616e 6765 202a  e.end = xrange *
-0000e8e0: 2031 3030 0a0a 2020 2020 2020 2020 7570   100..        up
-0000e8f0: 6461 7465 2873 656c 662e 736f 7572 6365  date(self.source
-0000e900: 2c20 7265 7375 6c74 290a 0a0a 636c 6173  , result)...clas
-0000e910: 7320 5374 6561 6c69 6e67 5469 6d65 5365  s StealingTimeSe
-0000e920: 7269 6573 2844 6173 6862 6f61 7264 436f  ries(DashboardCo
-0000e930: 6d70 6f6e 656e 7429 3a0a 2020 2020 6465  mponent):.    de
-0000e940: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0000e950: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
-0000e960: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-0000e970: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
-0000e980: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-0000e990: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
-0000e9a0: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-0000e9b0: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9d0: 2274 696d 6522 3a20 5b74 696d 6528 2920  "time": [time() 
-0000e9e0: 2a20 3130 3030 2c20 7469 6d65 2829 202a  * 1000, time() *
-0000e9f0: 2031 3030 3020 2b20 315d 2c0a 2020 2020   1000 + 1],.    
-0000ea00: 2020 2020 2020 2020 2020 2020 2269 646c              "idl
-0000ea10: 6522 3a20 5b30 2c20 305d 2c0a 2020 2020  e": [0, 0],.    
-0000ea20: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
-0000ea30: 7572 6174 6564 223a 205b 302c 2030 5d2c  urated": [0, 0],
-0000ea40: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0000ea50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000ea60: 2020 785f 7261 6e67 6520 3d20 4461 7461    x_range = Data
-0000ea70: 5261 6e67 6531 6428 666f 6c6c 6f77 3d22  Range1d(follow="
-0000ea80: 656e 6422 2c20 666f 6c6c 6f77 5f69 6e74  end", follow_int
-0000ea90: 6572 7661 6c3d 3230 3030 302c 2072 616e  erval=20000, ran
-0000eaa0: 6765 5f70 6164 6469 6e67 3d30 290a 0a20  ge_padding=0).. 
-0000eab0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000eac0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-0000ead0: 2020 2020 2020 2074 6974 6c65 3d22 4964         title="Id
-0000eae0: 6c65 2061 6e64 2053 6174 7572 6174 6564  le and Saturated
-0000eaf0: 2057 6f72 6b65 7273 204f 7665 7220 5469   Workers Over Ti
-0000eb00: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-0000eb10: 2078 5f61 7869 735f 7479 7065 3d22 6461   x_axis_type="da
-0000eb20: 7465 7469 6d65 222c 0a20 2020 2020 2020  tetime",.       
-0000eb30: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-0000eb40: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-0000eb50: 6765 3d78 5f72 616e 6765 2c0a 2020 2020  ge=x_range,.    
-0000eb60: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0000eb70: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000eb80: 2020 2020 7365 6c66 2e72 6f6f 742e 6c69      self.root.li
-0000eb90: 6e65 2873 6f75 7263 653d 7365 6c66 2e73  ne(source=self.s
-0000eba0: 6f75 7263 652c 2078 3d22 7469 6d65 222c  ource, x="time",
-0000ebb0: 2079 3d22 6964 6c65 222c 2063 6f6c 6f72   y="idle", color
-0000ebc0: 3d22 7265 6422 290a 2020 2020 2020 2020  ="red").        
-0000ebd0: 7365 6c66 2e72 6f6f 742e 6c69 6e65 2873  self.root.line(s
-0000ebe0: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-0000ebf0: 652c 2078 3d22 7469 6d65 222c 2079 3d22  e, x="time", y="
-0000ec00: 7361 7475 7261 7465 6422 2c20 636f 6c6f  saturated", colo
-0000ec10: 723d 2267 7265 656e 2229 0a20 2020 2020  r="green").     
-0000ec20: 2020 2073 656c 662e 726f 6f74 2e79 6178     self.root.yax
-0000ec30: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-0000ec40: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
-0000ec50: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000ec60: 6f74 2e61 6464 5f74 6f6f 6c73 280a 2020  ot.add_tools(.  
-0000ec70: 2020 2020 2020 2020 2020 5265 7365 7454            ResetT
-0000ec80: 6f6f 6c28 292c 2050 616e 546f 6f6c 2864  ool(), PanTool(d
-0000ec90: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
-0000eca0: 2229 2c20 5768 6565 6c5a 6f6f 6d54 6f6f  "), WheelZoomToo
-0000ecb0: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
-0000ecc0: 6474 6822 290a 2020 2020 2020 2020 290a  dth").        ).
-0000ecd0: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-0000ece0: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-0000ecf0: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
-0000ed00: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
-0000ed10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000ed20: 7265 7375 6c74 203d 207b 0a20 2020 2020  result = {.     
-0000ed30: 2020 2020 2020 2022 7469 6d65 223a 205b         "time": [
-0000ed40: 7469 6d65 2829 202a 2031 3030 305d 2c0a  time() * 1000],.
-0000ed50: 2020 2020 2020 2020 2020 2020 2269 646c              "idl
-0000ed60: 6522 3a20 5b6c 656e 2873 656c 662e 7363  e": [len(self.sc
-0000ed70: 6865 6475 6c65 722e 6964 6c65 295d 2c0a  heduler.idle)],.
-0000ed80: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
-0000ed90: 7572 6174 6564 223a 205b 6c65 6e28 7365  urated": [len(se
-0000eda0: 6c66 2e73 6368 6564 756c 6572 2e73 6174  lf.scheduler.sat
-0000edb0: 7572 6174 6564 295d 2c0a 2020 2020 2020  urated)],.      
-0000edc0: 2020 7d0a 2020 2020 2020 2020 6966 2050    }.        if P
-0000edd0: 524f 4649 4c49 4e47 3a0a 2020 2020 2020  ROFILING:.      
-0000ede0: 2020 2020 2020 6375 7264 6f63 2829 2e61        curdoc().a
-0000edf0: 6464 5f6e 6578 745f 7469 636b 5f63 616c  dd_next_tick_cal
-0000ee00: 6c62 6163 6b28 6c61 6d62 6461 3a20 7365  lback(lambda: se
-0000ee10: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
-0000ee20: 2872 6573 756c 742c 2031 3030 3030 2929  (result, 10000))
-0000ee30: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000ee40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ee50: 736f 7572 6365 2e73 7472 6561 6d28 7265  source.stream(re
-0000ee60: 7375 6c74 2c20 3130 3030 3029 0a0a 0a63  sult, 10000)...c
-0000ee70: 6c61 7373 2053 7465 616c 696e 6745 7665  lass StealingEve
-0000ee80: 6e74 7328 4461 7368 626f 6172 6443 6f6d  nts(DashboardCom
-0000ee90: 706f 6e65 6e74 293a 0a20 2020 2064 6566  ponent):.    def
-0000eea0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0000eeb0: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
-0000eec0: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
-0000eed0: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-0000eee0: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-0000eef0: 2073 656c 662e 7374 6561 6c20 3d20 7363   self.steal = sc
-0000ef00: 6865 6475 6c65 722e 6578 7465 6e73 696f  heduler.extensio
-0000ef10: 6e73 5b22 7374 6561 6c69 6e67 225d 0a20  ns["stealing"]. 
-0000ef20: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-0000ef30: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000ef40: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
-0000ef50: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
-0000ef60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0000ef70: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-0000ef80: 223a 205b 7469 6d65 2829 202d 2036 302c  ": [time() - 60,
-0000ef90: 2074 696d 6528 295d 2c0a 2020 2020 2020   time()],.      
-0000efa0: 2020 2020 2020 2020 2020 226c 6576 656c            "level
-0000efb0: 223a 205b 302c 2031 355d 2c0a 2020 2020  ": [0, 15],.    
-0000efc0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
-0000efd0: 6f72 223a 205b 2277 6869 7465 222c 2022  or": ["white", "
-0000efe0: 7768 6974 6522 5d2c 0a20 2020 2020 2020  white"],.       
-0000eff0: 2020 2020 2020 2020 2022 6475 7261 7469           "durati
-0000f000: 6f6e 223a 205b 302c 2030 5d2c 0a20 2020  on": [0, 0],.   
-0000f010: 2020 2020 2020 2020 2020 2020 2022 7261               "ra
-0000f020: 6469 7573 223a 205b 312c 2031 5d2c 0a20  dius": [1, 1],. 
-0000f030: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f040: 636f 7374 5f66 6163 746f 7222 3a20 5b30  cost_factor": [0
-0000f050: 2c20 3130 5d2c 0a20 2020 2020 2020 2020  , 10],.         
-0000f060: 2020 2020 2020 2022 636f 756e 7422 3a20         "count": 
-0000f070: 5b31 2c20 315d 2c0a 2020 2020 2020 2020  [1, 1],.        
-0000f080: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
-0000f090: 0a20 2020 2020 2020 2078 5f72 616e 6765  .        x_range
-0000f0a0: 203d 2044 6174 6152 616e 6765 3164 2866   = DataRange1d(f
-0000f0b0: 6f6c 6c6f 773d 2265 6e64 222c 2066 6f6c  ollow="end", fol
-0000f0c0: 6c6f 775f 696e 7465 7276 616c 3d32 3030  low_interval=200
-0000f0d0: 3030 2c20 7261 6e67 655f 7061 6464 696e  00, range_paddin
-0000f0e0: 673d 3029 0a0a 2020 2020 2020 2020 7365  g=0)..        se
-0000f0f0: 6c66 2e72 6f6f 7420 3d20 6669 6775 7265  lf.root = figure
-0000f100: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
-0000f110: 746c 653d 2253 7465 616c 696e 6720 4576  tle="Stealing Ev
-0000f120: 656e 7473 222c 0a20 2020 2020 2020 2020  ents",.         
-0000f130: 2020 2078 5f61 7869 735f 7479 7065 3d22     x_axis_type="
-0000f140: 6461 7465 7469 6d65 222c 0a20 2020 2020  datetime",.     
-0000f150: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-0000f160: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-0000f170: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
-0000f180: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-0000f190: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-0000f1a0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000f1b0: 2e63 6972 636c 6528 0a20 2020 2020 2020  .circle(.       
-0000f1c0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-0000f1d0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-0000f1e0: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-0000f1f0: 2020 2020 2020 2020 2020 2079 3d22 6c65             y="le
-0000f200: 7665 6c22 2c0a 2020 2020 2020 2020 2020  vel",.          
-0000f210: 2020 636f 6c6f 723d 2263 6f6c 6f72 222c    color="color",
-0000f220: 0a20 2020 2020 2020 2020 2020 2073 697a  .            siz
-0000f230: 653d 2272 6164 6975 7322 2c0a 2020 2020  e="radius",.    
-0000f240: 2020 2020 2020 2020 616c 7068 613d 302e          alpha=0.
-0000f250: 352c 0a20 2020 2020 2020 2029 0a20 2020  5,.        ).   
-0000f260: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-0000f270: 6178 6973 2e61 7869 735f 6c61 6265 6c20  axis.axis_label 
-0000f280: 3d20 224c 6576 656c 220a 0a20 2020 2020  = "Level"..     
-0000f290: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
-0000f2a0: 546f 6f6c 2829 0a20 2020 2020 2020 2068  Tool().        h
-0000f2b0: 6f76 6572 2e74 6f6f 6c74 6970 7320 3d20  over.tooltips = 
-0000f2c0: 224c 6576 656c 3a20 406c 6576 656c 2c20  "Level: @level, 
-0000f2d0: 4475 7261 7469 6f6e 3a20 4064 7572 6174  Duration: @durat
-0000f2e0: 696f 6e2c 2043 6f75 6e74 3a20 4063 6f75  ion, Count: @cou
-0000f2f0: 6e74 2c20 436f 7374 2066 6163 746f 723a  nt, Cost factor:
-0000f300: 2040 636f 7374 5f66 6163 746f 7222 0a20   @cost_factor". 
-0000f310: 2020 2020 2020 2068 6f76 6572 2e70 6f69         hover.poi
-0000f320: 6e74 5f70 6f6c 6963 7920 3d20 2266 6f6c  nt_policy = "fol
-0000f330: 6c6f 775f 6d6f 7573 6522 0a0a 2020 2020  low_mouse"..    
-0000f340: 2020 2020 7365 6c66 2e72 6f6f 742e 6164      self.root.ad
-0000f350: 645f 746f 6f6c 7328 0a20 2020 2020 2020  d_tools(.       
-0000f360: 2020 2020 2068 6f76 6572 2c0a 2020 2020       hover,.    
-0000f370: 2020 2020 2020 2020 5265 7365 7454 6f6f          ResetToo
-0000f380: 6c28 292c 0a20 2020 2020 2020 2020 2020  l(),.           
-0000f390: 2050 616e 546f 6f6c 2864 696d 656e 7369   PanTool(dimensi
-0000f3a0: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
-0000f3b0: 2020 2020 2020 2020 2020 5768 6565 6c5a            WheelZ
-0000f3c0: 6f6f 6d54 6f6f 6c28 6469 6d65 6e73 696f  oomTool(dimensio
-0000f3d0: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
-0000f3e0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0000f3f0: 636f 6e76 6572 7428 7365 6c66 2c20 6d73  convert(self, ms
-0000f400: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
-0000f410: 436f 6e76 6572 7420 6120 6c6f 6720 6d65  Convert a log me
-0000f420: 7373 6167 6520 746f 2061 2067 6c79 7068  ssage to a glyph
-0000f430: 2222 220a 2020 2020 2020 2020 746f 7461  """.        tota
-0000f440: 6c5f 6475 7261 7469 6f6e 203d 2030 0a20  l_duration = 0. 
-0000f450: 2020 2020 2020 2066 6f72 206d 7367 2069         for msg i
-0000f460: 6e20 6d73 6773 3a0a 2020 2020 2020 2020  n msgs:.        
-0000f470: 2020 2020 7469 6d65 2c20 6c65 7665 6c2c      time, level,
-0000f480: 206b 6579 2c20 6475 7261 7469 6f6e 2c20   key, duration, 
-0000f490: 7361 742c 206f 6363 5f73 6174 2c20 6964  sat, occ_sat, id
-0000f4a0: 6c2c 206f 6363 5f69 646c 203d 206d 7367  l, occ_idl = msg
-0000f4b0: 5b3a 385d 0a20 2020 2020 2020 2020 2020  [:8].           
-0000f4c0: 2074 6f74 616c 5f64 7572 6174 696f 6e20   total_duration 
-0000f4d0: 2b3d 2064 7572 6174 696f 6e0a 0a20 2020  += duration..   
-0000f4e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000f4f0: 2020 2020 2020 636f 6c6f 7220 3d20 5669        color = Vi
-0000f500: 7269 6469 7331 315b 6c65 7665 6c5d 0a20  ridis11[level]. 
-0000f510: 2020 2020 2020 2065 7863 6570 7420 284b         except (K
-0000f520: 6579 4572 726f 722c 2049 6e64 6578 4572  eyError, IndexEr
-0000f530: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000f540: 2020 636f 6c6f 7220 3d20 2262 6c61 636b    color = "black
-0000f550: 220a 0a20 2020 2020 2020 2072 6164 6975  "..        radiu
-0000f560: 7320 3d20 6d61 7468 2e73 7172 7428 6d69  s = math.sqrt(mi
-0000f570: 6e28 746f 7461 6c5f 6475 7261 7469 6f6e  n(total_duration
-0000f580: 2c20 3130 2929 202a 2033 3020 2b20 320a  , 10)) * 30 + 2.
-0000f590: 0a20 2020 2020 2020 2064 203d 207b 0a20  .        d = {. 
-0000f5a0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-0000f5b0: 223a 2074 696d 6520 2a20 3130 3030 2c0a  ": time * 1000,.
-0000f5c0: 2020 2020 2020 2020 2020 2020 226c 6576              "lev
-0000f5d0: 656c 223a 206c 6576 656c 2c0a 2020 2020  el": level,.    
-0000f5e0: 2020 2020 2020 2020 2263 6f75 6e74 223a          "count":
-0000f5f0: 206c 656e 286d 7367 7329 2c0a 2020 2020   len(msgs),.    
-0000f600: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
-0000f610: 2063 6f6c 6f72 2c0a 2020 2020 2020 2020   color,.        
-0000f620: 2020 2020 2264 7572 6174 696f 6e22 3a20      "duration": 
-0000f630: 746f 7461 6c5f 6475 7261 7469 6f6e 2c0a  total_duration,.
-0000f640: 2020 2020 2020 2020 2020 2020 2272 6164              "rad
-0000f650: 6975 7322 3a20 7261 6469 7573 2c0a 2020  ius": radius,.  
-0000f660: 2020 2020 2020 2020 2020 2263 6f73 745f            "cost_
-0000f670: 6661 6374 6f72 223a 2073 656c 662e 7374  factor": self.st
-0000f680: 6561 6c2e 636f 7374 5f6d 756c 7469 706c  eal.cost_multipl
-0000f690: 6965 7273 5b6c 6576 656c 5d2c 0a20 2020  iers[level],.   
-0000f6a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0000f6b0: 7265 7475 726e 2064 0a0a 2020 2020 4077  return d..    @w
-0000f6c0: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
-0000f6d0: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
-0000f6e0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-0000f6f0: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
-0000f700: 0a20 2020 2020 2020 206c 6f67 203d 2073  .        log = s
-0000f710: 656c 662e 7363 6865 6475 6c65 722e 6765  elf.scheduler.ge
-0000f720: 745f 6576 656e 7473 2874 6f70 6963 3d22  t_events(topic="
-0000f730: 7374 6561 6c69 6e67 2229 0a20 2020 2020  stealing").     
-0000f740: 2020 2063 7572 7265 6e74 203d 206c 656e     current = len
-0000f750: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
-0000f760: 6576 656e 7473 5b22 7374 6561 6c69 6e67  events["stealing
-0000f770: 225d 290a 2020 2020 2020 2020 6e20 3d20  "]).        n = 
-0000f780: 6375 7272 656e 7420 2d20 7365 6c66 2e6c  current - self.l
-0000f790: 6173 740a 0a20 2020 2020 2020 206c 6f67  ast..        log
-0000f7a0: 203d 205b 6c6f 675b 2d69 5d5b 315d 5b31   = [log[-i][1][1
-0000f7b0: 5d20 666f 7220 6920 696e 2072 616e 6765  ] for i in range
-0000f7c0: 2831 2c20 6e20 2b20 3129 2069 6620 6c6f  (1, n + 1) if lo
-0000f7d0: 675b 2d69 5d5b 315d 5b30 5d20 3d3d 2022  g[-i][1][0] == "
-0000f7e0: 7265 7175 6573 7422 5d0a 2020 2020 2020  request"].      
-0000f7f0: 2020 7365 6c66 2e6c 6173 7420 3d20 6375    self.last = cu
-0000f800: 7272 656e 740a 0a20 2020 2020 2020 2069  rrent..        i
-0000f810: 6620 6c6f 673a 0a20 2020 2020 2020 2020  f log:.         
-0000f820: 2020 206e 6577 203d 2070 6970 6528 0a20     new = pipe(. 
-0000f830: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000f840: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
-0000f850: 2020 2020 6d61 7028 6772 6f75 7062 7928      map(groupby(
-0000f860: 3129 292c 0a20 2020 2020 2020 2020 2020  1)),.           
-0000f870: 2020 2020 206d 6170 2864 6963 742e 7661       map(dict.va
-0000f880: 6c75 6573 292c 0a20 2020 2020 2020 2020  lues),.         
-0000f890: 2020 2020 2020 2063 6f6e 6361 742c 0a20         concat,. 
-0000f8a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000f8b0: 6170 2873 656c 662e 636f 6e76 6572 7429  ap(self.convert)
-0000f8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f8d0: 2020 6c69 7374 2c0a 2020 2020 2020 2020    list,.        
-0000f8e0: 2020 2020 2020 2020 7472 616e 7370 6f73          transpos
-0000f8f0: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
-0000f900: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000f910: 5052 4f46 494c 494e 473a 0a20 2020 2020  PROFILING:.     
-0000f920: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
-0000f930: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
-0000f940: 6b5f 6361 6c6c 6261 636b 286c 616d 6264  k_callback(lambd
-0000f950: 613a 2073 656c 662e 736f 7572 6365 2e73  a: self.source.s
-0000f960: 7472 6561 6d28 6e65 772c 2031 3030 3030  tream(new, 10000
-0000f970: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-0000f980: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000f990: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
-0000f9a0: 2e73 7472 6561 6d28 6e65 772c 2031 3030  .stream(new, 100
-0000f9b0: 3030 290a 0a0a 636c 6173 7320 4576 656e  00)...class Even
-0000f9c0: 7473 2844 6173 6862 6f61 7264 436f 6d70  ts(DashboardComp
-0000f9d0: 6f6e 656e 7429 3a0a 2020 2020 6465 6620  onent):.    def 
-0000f9e0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-0000f9f0: 6368 6564 756c 6572 2c20 6e61 6d65 2c20  cheduler, name, 
-0000fa00: 6865 6967 6874 3d31 3530 2c20 2a2a 6b77  height=150, **kw
-0000fa10: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-0000fa20: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
-0000fa30: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-0000fa40: 2020 7365 6c66 2e61 6374 696f 6e5f 7973    self.action_ys
-0000fa50: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
-0000fa60: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
-0000fa70: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-0000fa80: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-0000fa90: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-0000faa0: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-0000fab0: 0a20 2020 2020 2020 2020 2020 207b 2274  .            {"t
-0000fac0: 696d 6522 3a20 5b5d 2c20 2261 6374 696f  ime": [], "actio
-0000fad0: 6e22 3a20 5b5d 2c20 2268 6f76 6572 223a  n": [], "hover":
-0000fae0: 205b 5d2c 2022 7922 3a20 5b5d 2c20 2263   [], "y": [], "c
-0000faf0: 6f6c 6f72 223a 205b 5d7d 0a20 2020 2020  olor": []}.     
-0000fb00: 2020 2029 0a0a 2020 2020 2020 2020 785f     )..        x_
-0000fb10: 7261 6e67 6520 3d20 4461 7461 5261 6e67  range = DataRang
-0000fb20: 6531 6428 666f 6c6c 6f77 3d22 656e 6422  e1d(follow="end"
-0000fb30: 2c20 666f 6c6c 6f77 5f69 6e74 6572 7661  , follow_interva
-0000fb40: 6c3d 3230 3030 3030 290a 0a20 2020 2020  l=200000)..     
-0000fb50: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
-0000fb60: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-0000fb70: 2020 2074 6974 6c65 3d6e 616d 652c 0a20     title=name,. 
-0000fb80: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
-0000fb90: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
-0000fba0: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-0000fbb0: 6569 6768 743d 6865 6967 6874 2c0a 2020  eight=height,.  
-0000fbc0: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-0000fbd0: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-0000fbe0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
-0000fbf0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-0000fc00: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-0000fc10: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0000fc20: 6f6f 742e 6369 7263 6c65 280a 2020 2020  oot.circle(.    
-0000fc30: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-0000fc40: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-0000fc50: 2020 2020 2020 2020 783d 2274 696d 6522          x="time"
-0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 793d  ,.            y=
-0000fc70: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-0000fc80: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
-0000fc90: 2020 2020 2020 2020 2020 2020 7369 7a65              size
-0000fca0: 3d35 302c 0a20 2020 2020 2020 2020 2020  =50,.           
-0000fcb0: 2061 6c70 6861 3d30 2e35 2c0a 2020 2020   alpha=0.5,.    
-0000fcc0: 2020 2020 2020 2020 6c65 6765 6e64 5f66          legend_f
-0000fcd0: 6965 6c64 3d22 6163 7469 6f6e 222c 0a20  ield="action",. 
-0000fce0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000fcf0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-0000fd00: 2e61 7869 735f 6c61 6265 6c20 3d20 2241  .axis_label = "A
-0000fd10: 6374 696f 6e22 0a20 2020 2020 2020 2073  ction".        s
-0000fd20: 656c 662e 726f 6f74 2e6c 6567 656e 642e  elf.root.legend.
-0000fd30: 6c6f 6361 7469 6f6e 203d 2022 746f 705f  location = "top_
-0000fd40: 6c65 6674 220a 0a20 2020 2020 2020 2068  left"..        h
-0000fd50: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
-0000fd60: 2829 0a20 2020 2020 2020 2068 6f76 6572  ().        hover
-0000fd70: 2e74 6f6f 6c74 6970 7320 3d20 2240 6163  .tooltips = "@ac
-0000fd80: 7469 6f6e 3c62 723e 4068 6f76 6572 220a  tion<br>@hover".
-0000fd90: 2020 2020 2020 2020 686f 7665 722e 706f          hover.po
-0000fda0: 696e 745f 706f 6c69 6379 203d 2022 666f  int_policy = "fo
-0000fdb0: 6c6c 6f77 5f6d 6f75 7365 220a 0a20 2020  llow_mouse"..   
-0000fdc0: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-0000fdd0: 6464 5f74 6f6f 6c73 280a 2020 2020 2020  dd_tools(.      
-0000fde0: 2020 2020 2020 686f 7665 722c 0a20 2020        hover,.   
-0000fdf0: 2020 2020 2020 2020 2052 6573 6574 546f           ResetTo
-0000fe00: 6f6c 2829 2c0a 2020 2020 2020 2020 2020  ol(),.          
-0000fe10: 2020 5061 6e54 6f6f 6c28 6469 6d65 6e73    PanTool(dimens
-0000fe20: 696f 6e73 3d22 7769 6474 6822 292c 0a20  ions="width"),. 
-0000fe30: 2020 2020 2020 2020 2020 2057 6865 656c             Wheel
-0000fe40: 5a6f 6f6d 546f 6f6c 2864 696d 656e 7369  ZoomTool(dimensi
-0000fe50: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
-0000fe60: 2020 2020 2020 290a 0a20 2020 2040 7769        )..    @wi
-0000fe70: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-0000fe80: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
-0000fe90: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0000fea0: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
-0000feb0: 2020 2020 2020 2020 6c6f 6720 3d20 7365          log = se
-0000fec0: 6c66 2e73 6368 6564 756c 6572 2e65 7665  lf.scheduler.eve
-0000fed0: 6e74 735b 7365 6c66 2e6e 616d 655d 0a20  nts[self.name]. 
-0000fee0: 2020 2020 2020 206e 203d 2073 656c 662e         n = self.
-0000fef0: 7363 6865 6475 6c65 722e 6576 656e 745f  scheduler.event_
-0000ff00: 636f 756e 7473 5b73 656c 662e 6e61 6d65  counts[self.name
-0000ff10: 5d20 2d20 7365 6c66 2e6c 6173 740a 2020  ] - self.last.  
-0000ff20: 2020 2020 2020 6966 206c 6f67 3a0a 2020        if log:.  
-0000ff30: 2020 2020 2020 2020 2020 6c6f 6720 3d20            log = 
-0000ff40: 5b6c 6f67 5b2d 695d 2066 6f72 2069 2069  [log[-i] for i i
-0000ff50: 6e20 7261 6e67 6528 312c 206e 202b 2031  n range(1, n + 1
-0000ff60: 295d 0a20 2020 2020 2020 2073 656c 662e  )].        self.
-0000ff70: 6c61 7374 203d 2073 656c 662e 7363 6865  last = self.sche
-0000ff80: 6475 6c65 722e 6576 656e 745f 636f 756e  duler.event_coun
-0000ff90: 7473 5b73 656c 662e 6e61 6d65 5d0a 0a20  ts[self.name].. 
-0000ffa0: 2020 2020 2020 2069 6620 6c6f 673a 0a20         if log:. 
-0000ffb0: 2020 2020 2020 2020 2020 2061 6374 696f             actio
-0000ffc0: 6e73 203d 205b 5d0a 2020 2020 2020 2020  ns = [].        
-0000ffd0: 2020 2020 7469 6d65 7320 3d20 5b5d 0a20      times = []. 
-0000ffe0: 2020 2020 2020 2020 2020 2068 6f76 6572             hover
-0000fff0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
-00010000: 2020 2079 7320 3d20 5b5d 0a20 2020 2020     ys = [].     
-00010010: 2020 2020 2020 2063 6f6c 6f72 7320 3d20         colors = 
-00010020: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-00010030: 6f72 206d 7367 5f74 696d 652c 206d 7367  or msg_time, msg
-00010040: 2069 6e20 6c6f 673a 0a20 2020 2020 2020   in log:.       
-00010050: 2020 2020 2020 2020 2074 696d 6573 2e61           times.a
-00010060: 7070 656e 6428 6d73 675f 7469 6d65 202a  ppend(msg_time *
-00010070: 2031 3030 3029 0a20 2020 2020 2020 2020   1000).         
-00010080: 2020 2020 2020 2061 6374 696f 6e20 3d20         action = 
-00010090: 6d73 675b 2261 6374 696f 6e22 5d0a 2020  msg["action"].  
-000100a0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-000100b0: 7469 6f6e 732e 6170 7065 6e64 2861 6374  tions.append(act
-000100c0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
-000100d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000100e0: 2020 2020 2020 2020 2020 2020 2020 7973                ys
-000100f0: 2e61 7070 656e 6428 7365 6c66 2e61 6374  .append(self.act
-00010100: 696f 6e5f 7973 5b61 6374 696f 6e5d 290a  ion_ys[action]).
-00010110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010120: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00010130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010140: 2020 2020 2073 656c 662e 6163 7469 6f6e       self.action
-00010150: 5f79 735b 6163 7469 6f6e 5d20 3d20 6c65  _ys[action] = le
-00010160: 6e28 7365 6c66 2e61 6374 696f 6e5f 7973  n(self.action_ys
-00010170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010180: 2020 2020 2020 7973 2e61 7070 656e 6428        ys.append(
-00010190: 7365 6c66 2e61 6374 696f 6e5f 7973 5b61  self.action_ys[a
-000101a0: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
-000101b0: 2020 2020 2020 2020 636f 6c6f 7273 2e61          colors.a
-000101c0: 7070 656e 6428 636f 6c6f 725f 6f66 2861  ppend(color_of(a
-000101d0: 6374 696f 6e29 290a 2020 2020 2020 2020  ction)).        
-000101e0: 2020 2020 2020 2020 686f 7665 7273 2e61          hovers.a
-000101f0: 7070 656e 6428 2254 4f44 4f22 290a 0a20  ppend("TODO").. 
-00010200: 2020 2020 2020 2020 2020 206e 6577 203d             new =
-00010210: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00010220: 2020 2022 7469 6d65 223a 2074 696d 6573     "time": times
-00010230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010240: 2020 2261 6374 696f 6e22 3a20 6163 7469    "action": acti
-00010250: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00010260: 2020 2020 2022 686f 7665 7222 3a20 686f       "hover": ho
-00010270: 7665 7273 2c0a 2020 2020 2020 2020 2020  vers,.          
-00010280: 2020 2020 2020 2279 223a 2079 732c 0a20        "y": ys,. 
-00010290: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000102a0: 636f 6c6f 7222 3a20 636f 6c6f 7273 2c0a  color": colors,.
-000102b0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-000102c0: 2020 2020 2020 2020 2020 2069 6620 5052             if PR
-000102d0: 4f46 494c 494e 473a 0a20 2020 2020 2020  OFILING:.       
-000102e0: 2020 2020 2020 2020 2063 7572 646f 6328           curdoc(
-000102f0: 292e 6164 645f 6e65 7874 5f74 6963 6b5f  ).add_next_tick_
-00010300: 6361 6c6c 6261 636b 286c 616d 6264 613a  callback(lambda:
-00010310: 2073 656c 662e 736f 7572 6365 2e73 7472   self.source.str
-00010320: 6561 6d28 6e65 772c 2031 3030 3030 2929  eam(new, 10000))
-00010330: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00010340: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00010350: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
-00010360: 7472 6561 6d28 6e65 772c 2031 3030 3030  tream(new, 10000
-00010370: 290a 0a0a 636c 6173 7320 5461 736b 5374  )...class TaskSt
-00010380: 7265 616d 2844 6173 6862 6f61 7264 436f  ream(DashboardCo
-00010390: 6d70 6f6e 656e 7429 3a0a 2020 2020 6465  mponent):.    de
-000103a0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-000103b0: 2073 6368 6564 756c 6572 2c20 6e5f 7265   scheduler, n_re
-000103c0: 6374 616e 676c 6573 3d31 3030 302c 2063  ctangles=1000, c
-000103d0: 6c65 6172 5f69 6e74 6572 7661 6c3d 2232  lear_interval="2
-000103e0: 3073 222c 202a 2a6b 7761 7267 7329 3a0a  0s", **kwargs):.
-000103f0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00010400: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-00010410: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
-00010420: 6f66 6673 6574 203d 2030 0a0a 2020 2020  offset = 0..    
-00010430: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-00010440: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-00010450: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-00010460: 6572 2e70 6c75 6769 6e73 3a0a 2020 2020  er.plugins:.    
-00010470: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00010480: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
-00010490: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
-000104a0: 696e 2873 656c 662e 7363 6865 6475 6c65  in(self.schedule
-000104b0: 7229 290a 2020 2020 2020 2020 7365 6c66  r)).        self
-000104c0: 2e70 6c75 6769 6e20 3d20 7365 6c66 2e73  .plugin = self.s
-000104d0: 6368 6564 756c 6572 2e70 6c75 6769 6e73  cheduler.plugins
-000104e0: 5b54 6173 6b53 7472 6561 6d50 6c75 6769  [TaskStreamPlugi
-000104f0: 6e2e 6e61 6d65 5d0a 0a20 2020 2020 2020  n.name]..       
-00010500: 2073 656c 662e 696e 6465 7820 3d20 6d61   self.index = ma
-00010510: 7828 302c 2073 656c 662e 706c 7567 696e  x(0, self.plugin
-00010520: 2e69 6e64 6578 202d 206e 5f72 6563 7461  .index - n_recta
-00010530: 6e67 6c65 7329 0a20 2020 2020 2020 2073  ngles).        s
-00010540: 656c 662e 776f 726b 6572 7320 3d20 6469  elf.workers = di
-00010550: 6374 2829 0a20 2020 2020 2020 2073 656c  ct().        sel
-00010560: 662e 6e5f 7265 6374 616e 676c 6573 203d  f.n_rectangles =
-00010570: 206e 5f72 6563 7461 6e67 6c65 730a 2020   n_rectangles.  
-00010580: 2020 2020 2020 636c 6561 725f 696e 7465        clear_inte
-00010590: 7276 616c 203d 2070 6172 7365 5f74 696d  rval = parse_tim
-000105a0: 6564 656c 7461 2863 6c65 6172 5f69 6e74  edelta(clear_int
-000105b0: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
-000105c0: 6d73 2229 0a20 2020 2020 2020 2073 656c  ms").        sel
-000105d0: 662e 636c 6561 725f 696e 7465 7276 616c  f.clear_interval
-000105e0: 203d 2063 6c65 6172 5f69 6e74 6572 7661   = clear_interva
-000105f0: 6c0a 2020 2020 2020 2020 7365 6c66 2e6c  l.        self.l
-00010600: 6173 7420 3d20 300a 2020 2020 2020 2020  ast = 0.        
-00010610: 7365 6c66 2e6c 6173 745f 7365 656e 203d  self.last_seen =
-00010620: 2030 0a0a 2020 2020 2020 2020 7365 6c66   0..        self
-00010630: 2e73 6f75 7263 652c 2073 656c 662e 726f  .source, self.ro
-00010640: 6f74 203d 2074 6173 6b5f 7374 7265 616d  ot = task_stream
-00010650: 5f66 6967 7572 6528 636c 6561 725f 696e  _figure(clear_in
-00010660: 7465 7276 616c 2c20 2a2a 6b77 6172 6773  terval, **kwargs
-00010670: 290a 0a20 2020 2020 2020 2023 2052 6571  )..        # Req
-00010680: 7569 7265 6420 666f 7220 7570 6461 7465  uired for update
-00010690: 2063 616c 6c62 6163 6b0a 2020 2020 2020   callback.      
-000106a0: 2020 7365 6c66 2e74 6173 6b5f 7374 7265    self.task_stre
-000106b0: 616d 5f69 6e64 6578 203d 205b 305d 0a0a  am_index = [0]..
-000106c0: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-000106d0: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-000106e0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-000106f0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-00010700: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
-00010710: 6620 7365 6c66 2e69 6e64 6578 203d 3d20  f self.index == 
-00010720: 7365 6c66 2e70 6c75 6769 6e2e 696e 6465  self.plugin.inde
-00010730: 783a 0a20 2020 2020 2020 2020 2020 2072  x:.            r
-00010740: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-00010750: 6620 7365 6c66 2e69 6e64 6578 2061 6e64  f self.index and
-00010760: 206c 656e 2873 656c 662e 736f 7572 6365   len(self.source
-00010770: 2e64 6174 615b 2273 7461 7274 225d 293a  .data["start"]):
-00010780: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00010790: 7274 203d 206d 696e 2873 656c 662e 736f  rt = min(self.so
-000107a0: 7572 6365 2e64 6174 615b 2273 7461 7274  urce.data["start
-000107b0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-000107c0: 6475 7261 7469 6f6e 203d 206d 6178 2873  duration = max(s
-000107d0: 656c 662e 736f 7572 6365 2e64 6174 615b  elf.source.data[
-000107e0: 2264 7572 6174 696f 6e22 5d29 0a20 2020  "duration"]).   
-000107f0: 2020 2020 2020 2020 2062 6f75 6e64 6172           boundar
-00010800: 7920 3d20 2873 656c 662e 6f66 6673 6574  y = (self.offset
-00010810: 202b 2073 7461 7274 202d 2064 7572 6174   + start - durat
-00010820: 696f 6e29 202f 2031 3030 300a 2020 2020  ion) / 1000.    
-00010830: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00010840: 2020 2020 2020 626f 756e 6461 7279 203d        boundary =
-00010850: 2073 656c 662e 6f66 6673 6574 0a20 2020   self.offset.   
-00010860: 2020 2020 2072 6563 7461 6e67 6c65 7320       rectangles 
-00010870: 3d20 7365 6c66 2e70 6c75 6769 6e2e 7265  = self.plugin.re
-00010880: 6374 616e 676c 6573 280a 2020 2020 2020  ctangles(.      
-00010890: 2020 2020 2020 6973 7461 7274 3d73 656c        istart=sel
-000108a0: 662e 696e 6465 782c 2077 6f72 6b65 7273  f.index, workers
-000108b0: 3d73 656c 662e 776f 726b 6572 732c 2073  =self.workers, s
-000108c0: 7461 7274 5f62 6f75 6e64 6172 793d 626f  tart_boundary=bo
-000108d0: 756e 6461 7279 0a20 2020 2020 2020 2029  undary.        )
-000108e0: 0a20 2020 2020 2020 206e 203d 206c 656e  .        n = len
-000108f0: 2872 6563 7461 6e67 6c65 735b 226e 616d  (rectangles["nam
-00010900: 6522 5d29 0a20 2020 2020 2020 2073 656c  e"]).        sel
-00010910: 662e 696e 6465 7820 3d20 7365 6c66 2e70  f.index = self.p
-00010920: 6c75 6769 6e2e 696e 6465 780a 0a20 2020  lugin.index..   
-00010930: 2020 2020 2069 6620 6e6f 7420 7265 6374       if not rect
-00010940: 616e 676c 6573 5b22 7374 6172 7422 5d3a  angles["start"]:
-00010950: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010960: 7572 6e0a 0a20 2020 2020 2020 2023 2049  urn..        # I
-00010970: 6620 6974 2068 6173 2062 6565 6e20 6120  f it has been a 
-00010980: 7768 696c 6520 7369 6e63 6520 7765 2776  while since we'v
-00010990: 6520 7570 6461 7465 6420 7468 6520 706c  e updated the pl
-000109a0: 6f74 0a20 2020 2020 2020 2069 6620 7469  ot.        if ti
-000109b0: 6d65 2829 203e 2073 656c 662e 6c61 7374  me() > self.last
-000109c0: 5f73 6565 6e20 2b20 7365 6c66 2e63 6c65  _seen + self.cle
-000109d0: 6172 5f69 6e74 6572 7661 6c3a 0a20 2020  ar_interval:.   
-000109e0: 2020 2020 2020 2020 206e 6577 5f73 7461           new_sta
-000109f0: 7274 203d 206d 696e 2872 6563 7461 6e67  rt = min(rectang
-00010a00: 6c65 735b 2273 7461 7274 225d 2920 2d20  les["start"]) - 
-00010a10: 7365 6c66 2e6f 6666 7365 740a 2020 2020  self.offset.    
-00010a20: 2020 2020 2020 2020 6f6c 645f 7374 6172          old_star
-00010a30: 7420 3d20 6d69 6e28 7365 6c66 2e73 6f75  t = min(self.sou
-00010a40: 7263 652e 6461 7461 5b22 7374 6172 7422  rce.data["start"
-00010a50: 5d29 0a20 2020 2020 2020 2020 2020 206f  ]).            o
-00010a60: 6c64 5f65 6e64 203d 206d 6178 280a 2020  ld_end = max(.  
-00010a70: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00010a80: 7028 0a20 2020 2020 2020 2020 2020 2020  p(.             
-00010a90: 2020 2020 2020 206f 7065 7261 746f 722e         operator.
-00010aa0: 6164 642c 0a20 2020 2020 2020 2020 2020  add,.           
-00010ab0: 2020 2020 2020 2020 2073 656c 662e 736f           self.so
-00010ac0: 7572 6365 2e64 6174 615b 2273 7461 7274  urce.data["start
-00010ad0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00010ae0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00010af0: 7263 652e 6461 7461 5b22 6475 7261 7469  rce.data["durati
-00010b00: 6f6e 225d 2c0a 2020 2020 2020 2020 2020  on"],.          
-00010b10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010b20: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00010b30: 2020 2064 656e 7369 7479 203d 2028 0a20     density = (. 
-00010b40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010b50: 756d 2873 656c 662e 736f 7572 6365 2e64  um(self.source.d
-00010b60: 6174 615b 2264 7572 6174 696f 6e22 5d29  ata["duration"])
-00010b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010b80: 202f 206c 656e 2873 656c 662e 776f 726b   / len(self.work
-00010b90: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-00010ba0: 2020 2020 202f 2028 6f6c 645f 656e 6420       / (old_end 
-00010bb0: 2d20 6f6c 645f 7374 6172 7429 0a20 2020  - old_start).   
-00010bc0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00010bd0: 2020 2020 2020 2020 2320 4966 2077 6869          # If whi
-00010be0: 7465 7370 6163 6520 6973 206d 6f72 6520  tespace is more 
-00010bf0: 7468 616e 2033 7820 7468 6520 6f6c 6420  than 3x the old 
-00010c00: 7769 6474 680a 2020 2020 2020 2020 2020  width.          
-00010c10: 2020 6966 2028 6e65 775f 7374 6172 7420    if (new_start 
-00010c20: 2d20 6f6c 645f 656e 6429 203e 2028 6f6c  - old_end) > (ol
-00010c30: 645f 656e 6420 2d20 6f6c 645f 7374 6172  d_end - old_star
-00010c40: 7429 202a 2032 206f 7220 6465 6e73 6974  t) * 2 or densit
-00010c50: 7920 3c20 302e 3035 3a0a 2020 2020 2020  y < 0.05:.      
-00010c60: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00010c70: 6f75 7263 652e 6461 7461 2e75 7064 6174  ource.data.updat
-00010c80: 6528 7b6b 3a20 5b5d 2066 6f72 206b 2069  e({k: [] for k i
-00010c90: 6e20 7265 6374 616e 676c 6573 7d29 2020  n rectangles})  
-00010ca0: 2320 636c 6561 720a 2020 2020 2020 2020  # clear.        
-00010cb0: 2020 2020 2020 2020 7365 6c66 2e6f 6666          self.off
-00010cc0: 7365 7420 3d20 6d69 6e28 7265 6374 616e  set = min(rectan
-00010cd0: 676c 6573 5b22 7374 6172 7422 5d29 2020  gles["start"])  
-00010ce0: 2320 7265 6465 6669 6e65 206f 6666 7365  # redefine offse
-00010cf0: 740a 0a20 2020 2020 2020 2072 6563 7461  t..        recta
-00010d00: 6e67 6c65 735b 2273 7461 7274 225d 203d  ngles["start"] =
-00010d10: 205b 7820 2d20 7365 6c66 2e6f 6666 7365   [x - self.offse
-00010d20: 7420 666f 7220 7820 696e 2072 6563 7461  t for x in recta
-00010d30: 6e67 6c65 735b 2273 7461 7274 225d 5d0a  ngles["start"]].
-00010d40: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-00010d50: 745f 7365 656e 203d 2074 696d 6528 290a  t_seen = time().
-00010d60: 0a20 2020 2020 2020 2023 2043 6f6e 7665  .        # Conve
-00010d70: 7274 2074 6f20 6e75 6d70 7920 666f 7220  rt to numpy for 
-00010d80: 7365 7269 616c 697a 6174 696f 6e20 7370  serialization sp
-00010d90: 6565 640a 2020 2020 2020 2020 6966 206e  eed.        if n
-00010da0: 203e 3d20 3130 2061 6e64 206e 703a 0a20   >= 10 and np:. 
-00010db0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00010dc0: 2c20 7620 696e 2072 6563 7461 6e67 6c65  , v in rectangle
-00010dd0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00010de0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00010df0: 696e 7374 616e 6365 2876 5b30 5d2c 204e  instance(v[0], N
-00010e00: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
-00010e10: 2020 2020 2020 2020 2020 2020 7265 6374              rect
-00010e20: 616e 676c 6573 5b6b 5d20 3d20 6e70 2e61  angles[k] = np.a
-00010e30: 7272 6179 2876 290a 0a20 2020 2020 2020  rray(v)..       
-00010e40: 2069 6620 5052 4f46 494c 494e 473a 0a20   if PROFILING:. 
-00010e50: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
-00010e60: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
-00010e70: 6b5f 6361 6c6c 6261 636b 280a 2020 2020  k_callback(.    
-00010e80: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00010e90: 6461 3a20 7365 6c66 2e73 6f75 7263 652e  da: self.source.
-00010ea0: 7374 7265 616d 2872 6563 7461 6e67 6c65  stream(rectangle
-00010eb0: 732c 2073 656c 662e 6e5f 7265 6374 616e  s, self.n_rectan
-00010ec0: 676c 6573 290a 2020 2020 2020 2020 2020  gles).          
-00010ed0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-00010ee0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00010ef0: 6c66 2e73 6f75 7263 652e 7374 7265 616d  lf.source.stream
-00010f00: 2872 6563 7461 6e67 6c65 732c 2073 656c  (rectangles, sel
-00010f10: 662e 6e5f 7265 6374 616e 676c 6573 290a  f.n_rectangles).
-00010f20: 0a0a 6465 6620 7461 736b 5f73 7472 6561  ..def task_strea
-00010f30: 6d5f 6669 6775 7265 2863 6c65 6172 5f69  m_figure(clear_i
-00010f40: 6e74 6572 7661 6c3d 2232 3073 222c 202a  nterval="20s", *
-00010f50: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-00010f60: 220a 2020 2020 6b77 6172 6773 2061 7265  ".    kwargs are
-00010f70: 2061 7070 6c69 6564 2074 6f20 7468 6520   applied to the 
-00010f80: 626f 6b65 682e 6d6f 6465 6c73 2e70 6c6f  bokeh.models.plo
-00010f90: 7473 2e50 6c6f 7420 636f 6e73 7472 7563  ts.Plot construc
-00010fa0: 746f 720a 2020 2020 2222 220a 2020 2020  tor.    """.    
-00010fb0: 636c 6561 725f 696e 7465 7276 616c 203d  clear_interval =
-00010fc0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-00010fd0: 2863 6c65 6172 5f69 6e74 6572 7661 6c2c  (clear_interval,
-00010fe0: 2064 6566 6175 6c74 3d22 6d73 2229 0a0a   default="ms")..
-00010ff0: 2020 2020 736f 7572 6365 203d 2043 6f6c      source = Col
-00011000: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-00011010: 2020 2020 2020 2064 6174 613d 6469 6374         data=dict
-00011020: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00011030: 6172 743d 5b74 696d 6528 2920 2d20 636c  art=[time() - cl
-00011040: 6561 725f 696e 7465 7276 616c 5d2c 0a20  ear_interval],. 
-00011050: 2020 2020 2020 2020 2020 2064 7572 6174             durat
-00011060: 696f 6e3d 5b30 2e31 5d2c 0a20 2020 2020  ion=[0.1],.     
-00011070: 2020 2020 2020 206b 6579 3d5b 2273 7461         key=["sta
-00011080: 7274 225d 2c0a 2020 2020 2020 2020 2020  rt"],.          
-00011090: 2020 6e61 6d65 3d5b 2273 7461 7274 225d    name=["start"]
-000110a0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-000110b0: 6c6f 723d 5b22 7768 6974 6522 5d2c 0a20  lor=["white"],. 
-000110c0: 2020 2020 2020 2020 2020 2064 7572 6174             durat
-000110d0: 696f 6e5f 7465 7874 3d5b 2231 3030 206d  ion_text=["100 m
-000110e0: 7322 5d2c 0a20 2020 2020 2020 2020 2020  s"],.           
-000110f0: 2077 6f72 6b65 723d 5b22 666f 6f22 5d2c   worker=["foo"],
-00011100: 0a20 2020 2020 2020 2020 2020 2079 3d5b  .            y=[
-00011110: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-00011120: 776f 726b 6572 5f74 6872 6561 643d 5b31  worker_thread=[1
-00011130: 5d2c 0a20 2020 2020 2020 2020 2020 2061  ],.            a
-00011140: 6c70 6861 3d5b 302e 305d 2c0a 2020 2020  lpha=[0.0],.    
-00011150: 2020 2020 290a 2020 2020 290a 0a20 2020      ).    )..   
-00011160: 2078 5f72 616e 6765 203d 2044 6174 6152   x_range = DataR
-00011170: 616e 6765 3164 2872 616e 6765 5f70 6164  ange1d(range_pad
-00011180: 6469 6e67 3d30 290a 2020 2020 795f 7261  ding=0).    y_ra
-00011190: 6e67 6520 3d20 4461 7461 5261 6e67 6531  nge = DataRange1
-000111a0: 6428 7261 6e67 655f 7061 6464 696e 673d  d(range_padding=
-000111b0: 3029 0a0a 2020 2020 726f 6f74 203d 2066  0)..    root = f
-000111c0: 6967 7572 6528 0a20 2020 2020 2020 206e  igure(.        n
-000111d0: 616d 653d 2274 6173 6b5f 7374 7265 616d  ame="task_stream
-000111e0: 222c 0a20 2020 2020 2020 2074 6974 6c65  ",.        title
-000111f0: 3d22 5461 736b 2053 7472 6561 6d22 2c0a  ="Task Stream",.
-00011200: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-00011210: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
-00011220: 2079 5f72 616e 6765 3d79 5f72 616e 6765   y_range=y_range
-00011230: 2c0a 2020 2020 2020 2020 746f 6f6c 6261  ,.        toolba
-00011240: 725f 6c6f 6361 7469 6f6e 3d22 6162 6f76  r_location="abov
-00011250: 6522 2c0a 2020 2020 2020 2020 785f 6178  e",.        x_ax
-00011260: 6973 5f74 7970 653d 2264 6174 6574 696d  is_type="datetim
-00011270: 6522 2c0a 2020 2020 2020 2020 795f 6178  e",.        y_ax
-00011280: 6973 5f6c 6f63 6174 696f 6e3d 4e6f 6e65  is_location=None
-00011290: 2c0a 2020 2020 2020 2020 746f 6f6c 733d  ,.        tools=
-000112a0: 2222 2c0a 2020 2020 2020 2020 6d69 6e5f  "",.        min_
-000112b0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
-000112c0: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-000112d0: 6773 2c0a 2020 2020 290a 0a20 2020 2072  gs,.    )..    r
-000112e0: 6563 7420 3d20 726f 6f74 2e72 6563 7428  ect = root.rect(
-000112f0: 0a20 2020 2020 2020 2073 6f75 7263 653d  .        source=
-00011300: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00011310: 783d 2273 7461 7274 222c 0a20 2020 2020  x="start",.     
-00011320: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
-00011330: 2020 7769 6474 683d 2264 7572 6174 696f    width="duratio
-00011340: 6e22 2c0a 2020 2020 2020 2020 6865 6967  n",.        heig
-00011350: 6874 3d30 2e34 2c0a 2020 2020 2020 2020  ht=0.4,.        
-00011360: 6669 6c6c 5f63 6f6c 6f72 3d22 636f 6c6f  fill_color="colo
-00011370: 7222 2c0a 2020 2020 2020 2020 6c69 6e65  r",.        line
-00011380: 5f63 6f6c 6f72 3d22 636f 6c6f 7222 2c0a  _color="color",.
-00011390: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
-000113a0: 6861 3d30 2e36 2c0a 2020 2020 2020 2020  ha=0.6,.        
-000113b0: 6669 6c6c 5f61 6c70 6861 3d22 616c 7068  fill_alpha="alph
-000113c0: 6122 2c0a 2020 2020 2020 2020 6c69 6e65  a",.        line
-000113d0: 5f77 6964 7468 3d33 2c0a 2020 2020 290a  _width=3,.    ).
-000113e0: 2020 2020 7265 6374 2e6e 6f6e 7365 6c65      rect.nonsele
-000113f0: 6374 696f 6e5f 676c 7970 6820 3d20 4e6f  ction_glyph = No
-00011400: 6e65 0a0a 2020 2020 726f 6f74 2e79 6178  ne..    root.yax
-00011410: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f74  is.major_label_t
-00011420: 6578 745f 616c 7068 6120 3d20 300a 2020  ext_alpha = 0.  
-00011430: 2020 726f 6f74 2e79 6178 6973 2e6d 696e    root.yaxis.min
-00011440: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-00011450: 6861 203d 2030 0a20 2020 2072 6f6f 742e  ha = 0.    root.
-00011460: 7961 7869 732e 6d61 6a6f 725f 7469 636b  yaxis.major_tick
-00011470: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-00011480: 2020 2020 726f 6f74 2e78 6772 6964 2e76      root.xgrid.v
-00011490: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
-000114a0: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
-000114b0: 7254 6f6f 6c28 0a20 2020 2020 2020 2070  rTool(.        p
-000114c0: 6f69 6e74 5f70 6f6c 6963 793d 2266 6f6c  oint_policy="fol
-000114d0: 6c6f 775f 6d6f 7573 6522 2c0a 2020 2020  low_mouse",.    
-000114e0: 2020 2020 746f 6f6c 7469 7073 3d22 2222      tooltips="""
-000114f0: 0a20 2020 2020 2020 2020 2020 203c 6469  .            <di
-00011500: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00011510: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00011520: 666f 6e74 2d73 697a 653a 2031 3270 783b  font-size: 12px;
-00011530: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00011540: 6c64 3b22 3e40 6e61 6d65 3a3c 2f73 7061  ld;">@name:</spa
-00011550: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-00011560: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00011570: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00011580: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-00011590: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-000115a0: 7370 6163 653b 223e 4064 7572 6174 696f  space;">@duratio
-000115b0: 6e5f 7465 7874 3c2f 7370 616e 3e0a 2020  n_text</span>.  
-000115c0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-000115d0: 0a20 2020 2020 2020 2020 2020 2022 2222  .            """
-000115e0: 2c0a 2020 2020 290a 0a20 2020 2074 6170  ,.    )..    tap
-000115f0: 203d 2054 6170 546f 6f6c 2863 616c 6c62   = TapTool(callb
-00011600: 6163 6b3d 4f70 656e 5552 4c28 7572 6c3d  ack=OpenURL(url=
-00011610: 222e 2f70 726f 6669 6c65 3f6b 6579 3d40  "./profile?key=@
-00011620: 6e61 6d65 2229 290a 2020 2020 6865 6c70  name")).    help
-00011630: 5f20 3d20 4865 6c70 546f 6f6c 280a 2020  _ = HelpTool(.  
-00011640: 2020 2020 2020 7265 6469 7265 6374 3d22        redirect="
-00011650: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
-00011660: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
-00011670: 6461 7368 626f 6172 642e 6874 6d6c 2374  dashboard.html#t
-00011680: 6173 6b2d 7374 7265 616d 222c 0a20 2020  ask-stream",.   
-00011690: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
-000116a0: 3d22 4120 6465 7363 7269 7074 696f 6e20  ="A description 
-000116b0: 6f66 2074 6865 2054 6173 6b53 7472 6561  of the TaskStrea
-000116c0: 6d20 616e 6420 6974 7320 636f 6c6f 7220  m and its color 
-000116d0: 7061 6c65 7474 652e 222c 0a20 2020 2029  palette.",.    )
-000116e0: 0a20 2020 2072 6f6f 742e 6164 645f 746f  .    root.add_to
-000116f0: 6f6c 7328 0a20 2020 2020 2020 2068 6f76  ols(.        hov
-00011700: 6572 2c0a 2020 2020 2020 2020 7461 702c  er,.        tap,
-00011710: 0a20 2020 2020 2020 2042 6f78 5a6f 6f6d  .        BoxZoom
-00011720: 546f 6f6c 2829 2c0a 2020 2020 2020 2020  Tool(),.        
-00011730: 5265 7365 7454 6f6f 6c28 292c 0a20 2020  ResetTool(),.   
-00011740: 2020 2020 2050 616e 546f 6f6c 2864 696d       PanTool(dim
-00011750: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
-00011760: 2c0a 2020 2020 2020 2020 5768 6565 6c5a  ,.        WheelZ
-00011770: 6f6f 6d54 6f6f 6c28 6469 6d65 6e73 696f  oomTool(dimensio
-00011780: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
-00011790: 2020 2020 2068 656c 705f 2c0a 2020 2020       help_,.    
-000117a0: 290a 2020 2020 6966 2045 7870 6f72 7454  ).    if ExportT
-000117b0: 6f6f 6c3a 2020 2320 7479 7065 3a20 6967  ool:  # type: ig
-000117c0: 6e6f 7265 0a20 2020 2020 2020 2065 7870  nore.        exp
-000117d0: 6f72 7420 3d20 4578 706f 7274 546f 6f6c  ort = ExportTool
-000117e0: 2829 0a20 2020 2020 2020 2065 7870 6f72  ().        expor
-000117f0: 742e 7265 6769 7374 6572 5f70 6c6f 7428  t.register_plot(
-00011800: 726f 6f74 290a 2020 2020 2020 2020 726f  root).        ro
-00011810: 6f74 2e61 6464 5f74 6f6f 6c73 2865 7870  ot.add_tools(exp
-00011820: 6f72 7429 0a0a 2020 2020 7265 7475 726e  ort)..    return
-00011830: 2073 6f75 7263 652c 2072 6f6f 740a 0a0a   source, root...
-00011840: 636c 6173 7320 5461 736b 4772 6170 6828  class TaskGraph(
-00011850: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-00011860: 6e74 293a 0a20 2020 2022 2222 0a20 2020  nt):.    """.   
-00011870: 2041 2064 796e 616d 6963 206e 6f64 652d   A dynamic node-
-00011880: 6c69 6e6b 2064 6961 6772 616d 2066 6f72  link diagram for
-00011890: 2074 6865 2074 6173 6b20 6772 6170 6820   the task graph 
-000118a0: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-000118b0: 0a0a 2020 2020 5365 6520 616c 736f 2074  ..    See also t
-000118c0: 6865 2047 7261 7068 4c61 796f 7574 2064  he GraphLayout d
-000118d0: 6961 676e 6f73 7469 6320 6174 0a20 2020  iagnostic at.   
-000118e0: 2064 6973 7472 6962 7574 6564 2f64 6961   distributed/dia
-000118f0: 676e 6f73 7469 6373 2f67 7261 7068 5f6c  gnostics/graph_l
-00011900: 6179 6f75 742e 7079 0a20 2020 2022 2222  ayout.py.    """
-00011910: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00011920: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00011930: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-00011940: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00011950: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-00011960: 720a 2020 2020 2020 2020 7365 6c66 2e6c  r.        self.l
-00011970: 6179 6f75 7420 3d20 4772 6170 684c 6179  ayout = GraphLay
-00011980: 6f75 7428 7363 6865 6475 6c65 7229 0a20  out(scheduler). 
-00011990: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-000119a0: 2e61 6464 5f70 6c75 6769 6e28 7365 6c66  .add_plugin(self
-000119b0: 2e6c 6179 6f75 7429 0a20 2020 2020 2020  .layout).       
-000119c0: 2073 656c 662e 696e 7669 7369 626c 655f   self.invisible_
-000119d0: 636f 756e 7420 3d20 3020 2023 206e 756d  count = 0  # num
-000119e0: 6265 7220 6f66 2069 6e76 6973 6962 6c65  ber of invisible
-000119f0: 206e 6f64 6573 0a0a 2020 2020 2020 2020   nodes..        
-00011a00: 7365 6c66 2e6e 6f64 655f 736f 7572 6365  self.node_source
-00011a10: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-00011a20: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
-00011a30: 207b 2278 223a 205b 5d2c 2022 7922 3a20   {"x": [], "y": 
-00011a40: 5b5d 2c20 226e 616d 6522 3a20 5b5d 2c20  [], "name": [], 
-00011a50: 2273 7461 7465 223a 205b 5d2c 2022 7669  "state": [], "vi
-00011a60: 7369 626c 6522 3a20 5b5d 2c20 226b 6579  sible": [], "key
-00011a70: 223a 205b 5d7d 0a20 2020 2020 2020 2029  ": []}.        )
-00011a80: 0a20 2020 2020 2020 2073 656c 662e 6564  .        self.ed
-00011a90: 6765 5f73 6f75 7263 6520 3d20 436f 6c75  ge_source = Colu
-00011aa0: 6d6e 4461 7461 536f 7572 6365 287b 2278  mnDataSource({"x
-00011ab0: 223a 205b 5d2c 2022 7922 3a20 5b5d 2c20  ": [], "y": [], 
-00011ac0: 2276 6973 6962 6c65 223a 205b 5d7d 290a  "visible": []}).
-00011ad0: 0a20 2020 2020 2020 2066 696c 7465 7220  .        filter 
-00011ae0: 3d20 4772 6f75 7046 696c 7465 7228 636f  = GroupFilter(co
-00011af0: 6c75 6d6e 5f6e 616d 653d 2276 6973 6962  lumn_name="visib
-00011b00: 6c65 222c 2067 726f 7570 3d22 5472 7565  le", group="True
-00011b10: 2229 0a20 2020 2020 2020 2069 6620 424f  ").        if BO
-00011b20: 4b45 485f 5645 5253 494f 4e2e 6d61 6a6f  KEH_VERSION.majo
-00011b30: 7220 3c20 333a 0a20 2020 2020 2020 2020  r < 3:.         
-00011b40: 2020 2066 696c 7465 725f 6b77 6172 6773     filter_kwargs
-00011b50: 203d 207b 2266 696c 7465 7273 223a 205b   = {"filters": [
-00011b60: 6669 6c74 6572 5d7d 0a20 2020 2020 2020  filter]}.       
-00011b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00011b80: 2020 2066 696c 7465 725f 6b77 6172 6773     filter_kwargs
-00011b90: 203d 207b 2266 696c 7465 7222 3a20 6669   = {"filter": fi
-00011ba0: 6c74 6572 7d0a 2020 2020 2020 2020 6e6f  lter}.        no
-00011bb0: 6465 5f76 6965 7720 3d20 4344 5356 6965  de_view = CDSVie
-00011bc0: 7728 2a2a 6669 6c74 6572 5f6b 7761 7267  w(**filter_kwarg
-00011bd0: 7329 0a20 2020 2020 2020 2065 6467 655f  s).        edge_
-00011be0: 7669 6577 203d 2043 4453 5669 6577 282a  view = CDSView(*
-00011bf0: 2a66 696c 7465 725f 6b77 6172 6773 290a  *filter_kwargs).
-00011c00: 0a20 2020 2020 2020 2023 2042 6f6b 6568  .        # Bokeh
-00011c10: 203e 3d20 332e 3020 6175 746f 6d61 7469   >= 3.0 automati
-00011c20: 6361 6c6c 7920 696e 6665 7273 2074 6865  cally infers the
-00011c30: 2073 6f75 7263 6520 746f 2075 7365 0a20   source to use. 
-00011c40: 2020 2020 2020 2069 6620 424f 4b45 485f         if BOKEH_
-00011c50: 5645 5253 494f 4e2e 6d61 6a6f 7220 3c20  VERSION.major < 
-00011c60: 333a 0a20 2020 2020 2020 2020 2020 206e  3:.            n
-00011c70: 6f64 655f 7669 6577 2e73 6f75 7263 6520  ode_view.source 
-00011c80: 3d20 7365 6c66 2e6e 6f64 655f 736f 7572  = self.node_sour
-00011c90: 6365 0a20 2020 2020 2020 2020 2020 2065  ce.            e
-00011ca0: 6467 655f 7669 6577 2e73 6f75 7263 6520  dge_view.source 
-00011cb0: 3d20 7365 6c66 2e65 6467 655f 736f 7572  = self.edge_sour
-00011cc0: 6365 0a0a 2020 2020 2020 2020 6e6f 6465  ce..        node
-00011cd0: 5f63 6f6c 6f72 7320 3d20 6661 6374 6f72  _colors = factor
-00011ce0: 5f63 6d61 7028 0a20 2020 2020 2020 2020  _cmap(.         
-00011cf0: 2020 2022 7374 6174 6522 2c0a 2020 2020     "state",.    
-00011d00: 2020 2020 2020 2020 6661 6374 6f72 733d          factors=
-00011d10: 5b22 7761 6974 696e 6722 2c20 2271 7565  ["waiting", "que
-00011d20: 7565 6422 2c20 2270 726f 6365 7373 696e  ued", "processin
-00011d30: 6722 2c20 226d 656d 6f72 7922 2c20 2272  g", "memory", "r
-00011d40: 656c 6561 7365 6422 2c20 2265 7272 6564  eleased", "erred
-00011d50: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00011d60: 7061 6c65 7474 653d 5b22 6772 6179 222c  palette=["gray",
-00011d70: 2022 7965 6c6c 6f77 222c 2022 6772 6565   "yellow", "gree
-00011d80: 6e22 2c20 2272 6564 222c 2022 626c 7565  n", "red", "blue
-00011d90: 222c 2022 626c 6163 6b22 5d2c 0a20 2020  ", "black"],.   
-00011da0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00011db0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
-00011dc0: 7265 2874 6974 6c65 3d22 5461 736b 2047  re(title="Task G
-00011dd0: 7261 7068 222c 202a 2a6b 7761 7267 7329  raph", **kwargs)
-00011de0: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
-00011df0: 6274 6974 6c65 203d 2054 6974 6c65 2874  btitle = Title(t
-00011e00: 6578 743d 2220 222c 2074 6578 745f 666f  ext=" ", text_fo
-00011e10: 6e74 5f73 7479 6c65 3d22 6974 616c 6963  nt_style="italic
-00011e20: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00011e30: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
-00011e40: 7365 6c66 2e73 7562 7469 746c 652c 2022  self.subtitle, "
-00011e50: 6162 6f76 6522 290a 0a20 2020 2020 2020  above")..       
-00011e60: 2073 656c 662e 726f 6f74 2e6d 756c 7469   self.root.multi
-00011e70: 5f6c 696e 6528 0a20 2020 2020 2020 2020  _line(.         
-00011e80: 2020 2078 733d 2278 222c 0a20 2020 2020     xs="x",.     
-00011e90: 2020 2020 2020 2079 733d 2279 222c 0a20         ys="y",. 
-00011ea0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00011eb0: 653d 7365 6c66 2e65 6467 655f 736f 7572  e=self.edge_sour
-00011ec0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-00011ed0: 6c69 6e65 5f77 6964 7468 3d31 2c0a 2020  line_width=1,.  
-00011ee0: 2020 2020 2020 2020 2020 7669 6577 3d65            view=e
-00011ef0: 6467 655f 7669 6577 2c0a 2020 2020 2020  dge_view,.      
-00011f00: 2020 2020 2020 636f 6c6f 723d 2262 6c61        color="bla
-00011f10: 636b 222c 0a20 2020 2020 2020 2020 2020  ck",.           
-00011f20: 2061 6c70 6861 3d30 2e33 2c0a 2020 2020   alpha=0.3,.    
-00011f30: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00011f40: 6374 203d 2073 656c 662e 726f 6f74 2e73  ct = self.root.s
-00011f50: 7175 6172 6528 0a20 2020 2020 2020 2020  quare(.         
-00011f60: 2020 2078 3d22 7822 2c0a 2020 2020 2020     x="x",.      
-00011f70: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
-00011f80: 2020 2020 2020 2020 2073 697a 653d 3130           size=10
-00011f90: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-00011fa0: 6c6f 723d 6e6f 6465 5f63 6f6c 6f72 732c  lor=node_colors,
-00011fb0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00011fc0: 7263 653d 7365 6c66 2e6e 6f64 655f 736f  rce=self.node_so
-00011fd0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-00011fe0: 2020 7669 6577 3d6e 6f64 655f 7669 6577    view=node_view
-00011ff0: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-00012000: 6765 6e64 5f66 6965 6c64 3d22 7374 6174  gend_field="stat
-00012010: 6522 2c0a 2020 2020 2020 2020 290a 2020  e",.        ).  
-00012020: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00012030: 7867 7269 642e 6772 6964 5f6c 696e 655f  xgrid.grid_line_
-00012040: 636f 6c6f 7220 3d20 4e6f 6e65 0a20 2020  color = None.   
-00012050: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-00012060: 6772 6964 2e67 7269 645f 6c69 6e65 5f63  grid.grid_line_c
-00012070: 6f6c 6f72 203d 204e 6f6e 650a 2020 2020  olor = None.    
-00012080: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
-00012090: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-000120a0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-000120b0: 2e72 6f6f 742e 7961 7869 732e 7669 7369  .root.yaxis.visi
-000120c0: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
-000120d0: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-000120e0: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
-000120f0: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
-00012100: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
-00012110: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-00012120: 6c74 6970 733d 223c 623e 406e 616d 653c  ltips="<b>@name<
-00012130: 2f62 3e3a 2040 7374 6174 6522 2c0a 2020  /b>: @state",.  
-00012140: 2020 2020 2020 2020 2020 7265 6e64 6572            render
-00012150: 6572 733d 5b72 6563 745d 2c0a 2020 2020  ers=[rect],.    
-00012160: 2020 2020 290a 2020 2020 2020 2020 7461      ).        ta
-00012170: 7020 3d20 5461 7054 6f6f 6c28 6361 6c6c  p = TapTool(call
-00012180: 6261 636b 3d4f 7065 6e55 524c 2875 726c  back=OpenURL(url
-00012190: 3d22 696e 666f 2f74 6173 6b2f 406b 6579  ="info/task/@key
-000121a0: 2e68 746d 6c22 292c 2072 656e 6465 7265  .html"), rendere
-000121b0: 7273 3d5b 7265 6374 5d29 0a20 2020 2020  rs=[rect]).     
-000121c0: 2020 2072 6563 742e 6e6f 6e73 656c 6563     rect.nonselec
-000121d0: 7469 6f6e 5f67 6c79 7068 203d 204e 6f6e  tion_glyph = Non
-000121e0: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
-000121f0: 6f6f 742e 6164 645f 746f 6f6c 7328 686f  oot.add_tools(ho
-00012200: 7665 722c 2074 6170 290a 2020 2020 2020  ver, tap).      
-00012210: 2020 7365 6c66 2e6d 6178 5f69 7465 6d73    self.max_items
-00012220: 203d 2063 6f6e 6669 672e 6765 7428 2264   = config.get("d
-00012230: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-00012240: 6f61 7264 2e67 7261 7068 2d6d 6178 2d69  oard.graph-max-i
-00012250: 7465 6d73 222c 2035 3030 3029 0a0a 2020  tems", 5000)..  
-00012260: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-00012270: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-00012280: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-00012290: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-000122a0: 6c66 293a 0a20 2020 2020 2020 2023 2049  lf):.        # I
-000122b0: 6620 7468 6572 6520 6172 6520 746f 6f20  f there are too 
-000122c0: 6d61 6e79 2074 6173 6b73 2069 6e20 7468  many tasks in th
-000122d0: 6520 7363 6865 6475 6c65 7220 7765 276c  e scheduler we'l
-000122e0: 6c20 6469 7361 626c 6520 7468 6973 0a20  l disable this. 
-000122f0: 2020 2020 2020 2023 2063 6f6d 706f 6f6e         # compoon
-00012300: 656e 7473 2074 6f20 6e6f 7420 6f76 6572  ents to not over
-00012310: 6c6f 6164 2073 6368 6564 756c 6572 206f  load scheduler o
-00012320: 7220 636c 6965 6e74 2e20 4f6e 6365 2077  r client. Once w
-00012330: 6520 6472 6f70 0a20 2020 2020 2020 2023  e drop.        #
-00012340: 2062 656c 6f77 2074 6865 2074 6872 6573   below the thres
-00012350: 686f 6c64 2c20 7468 6520 6461 7461 2069  hold, the data i
-00012360: 7320 6669 6c6c 6564 2075 7020 6167 6169  s filled up agai
-00012370: 6e20 6173 2075 7375 616c 0a20 2020 2020  n as usual.     
-00012380: 2020 2069 6620 6c65 6e28 7365 6c66 2e73     if len(self.s
-00012390: 6368 6564 756c 6572 2e74 6173 6b73 2920  cheduler.tasks) 
-000123a0: 3e20 7365 6c66 2e6d 6178 5f69 7465 6d73  > self.max_items
-000123b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000123c0: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
-000123d0: 203d 2022 5363 6865 6475 6c65 7220 6861   = "Scheduler ha
-000123e0: 7320 746f 6f20 6d61 6e79 2074 6173 6b73  s too many tasks
-000123f0: 2074 6f20 6469 7370 6c61 792e 220a 2020   to display.".  
-00012400: 2020 2020 2020 2020 2020 666f 7220 636f            for co
-00012410: 6e74 6169 6e65 7220 696e 205b 7365 6c66  ntainer in [self
-00012420: 2e6e 6f64 655f 736f 7572 6365 2c20 7365  .node_source, se
-00012430: 6c66 2e65 6467 655f 736f 7572 6365 5d3a  lf.edge_source]:
-00012440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012450: 2063 6f6e 7461 696e 6572 2e64 6174 6120   container.data 
-00012460: 3d20 7b63 6f6c 3a20 5b5d 2066 6f72 2063  = {col: [] for c
-00012470: 6f6c 2069 6e20 636f 6e74 6169 6e65 722e  ol in container.
-00012480: 636f 6c75 6d6e 5f6e 616d 6573 7d0a 2020  column_names}.  
-00012490: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000124a0: 2020 2020 2020 2020 2320 6f63 6361 7369          # occasi
-000124b0: 6f6e 616c 6c79 2072 6573 6574 2074 6865  onally reset the
-000124c0: 2063 6f6c 756d 6e20 6461 7461 2073 6f75   column data sou
-000124d0: 7263 6520 746f 2072 656d 6f76 6520 6f6c  rce to remove ol
-000124e0: 6420 6e6f 6465 730a 2020 2020 2020 2020  d nodes.        
-000124f0: 2020 2020 6966 2073 656c 662e 696e 7669      if self.invi
-00012500: 7369 626c 655f 636f 756e 7420 3e20 6c65  sible_count > le
-00012510: 6e28 7365 6c66 2e6e 6f64 655f 736f 7572  n(self.node_sour
-00012520: 6365 2e64 6174 615b 2278 225d 2920 2f20  ce.data["x"]) / 
-00012530: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-00012540: 2020 2073 656c 662e 6c61 796f 7574 2e72     self.layout.r
-00012550: 6573 6574 5f69 6e64 6578 2829 0a20 2020  eset_index().   
-00012560: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00012570: 662e 696e 7669 7369 626c 655f 636f 756e  f.invisible_coun
-00012580: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
-00012590: 2020 2020 2020 7570 6461 7465 203d 2054        update = T
-000125a0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-000125b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000125c0: 2020 2020 2020 7570 6461 7465 203d 2046        update = F
-000125d0: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
-000125e0: 2020 6e65 772c 2073 656c 662e 6c61 796f    new, self.layo
-000125f0: 7574 2e6e 6577 203d 2073 656c 662e 6c61  ut.new = self.la
-00012600: 796f 7574 2e6e 6577 2c20 5b5d 0a20 2020  yout.new, [].   
-00012610: 2020 2020 2020 2020 206e 6577 5f65 6467           new_edg
-00012620: 6573 203d 2073 656c 662e 6c61 796f 7574  es = self.layout
-00012630: 2e6e 6577 5f65 6467 6573 0a20 2020 2020  .new_edges.     
-00012640: 2020 2020 2020 2073 656c 662e 6c61 796f         self.layo
-00012650: 7574 2e6e 6577 5f65 6467 6573 203d 205b  ut.new_edges = [
-00012660: 5d0a 0a20 2020 2020 2020 2020 2020 2073  ]..            s
-00012670: 656c 662e 6164 645f 6e65 775f 6e6f 6465  elf.add_new_node
-00012680: 735f 6564 6765 7328 6e65 772c 206e 6577  s_edges(new, new
-00012690: 5f65 6467 6573 2c20 7570 6461 7465 3d75  _edges, update=u
-000126a0: 7064 6174 6529 0a0a 2020 2020 2020 2020  pdate)..        
-000126b0: 2020 2020 7365 6c66 2e70 6174 6368 5f75      self.patch_u
-000126c0: 7064 6174 6573 2829 0a0a 2020 2020 2020  pdates()..      
-000126d0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
-000126e0: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
-000126f0: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
-00012700: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
-00012710: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
-00012720: 6368 6564 756c 6572 2069 7320 656d 7074  cheduler is empt
-00012730: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
-00012740: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00012750: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
-00012760: 746c 652e 7465 7874 203d 2022 2022 0a0a  tle.text = " "..
-00012770: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-00012780: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-00012790: 0a20 2020 2064 6566 2061 6464 5f6e 6577  .    def add_new
-000127a0: 5f6e 6f64 6573 5f65 6467 6573 2873 656c  _nodes_edges(sel
-000127b0: 662c 206e 6577 2c20 6e65 775f 6564 6765  f, new, new_edge
-000127c0: 732c 2075 7064 6174 653d 4661 6c73 6529  s, update=False)
-000127d0: 3a0a 2020 2020 2020 2020 6966 206e 6577  :.        if new
-000127e0: 206f 7220 7570 6461 7465 3a0a 2020 2020   or update:.    
-000127f0: 2020 2020 2020 2020 6e6f 6465 5f6b 6579          node_key
-00012800: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00012810: 2020 6e6f 6465 5f78 203d 205b 5d0a 2020    node_x = [].  
-00012820: 2020 2020 2020 2020 2020 6e6f 6465 5f79            node_y
-00012830: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00012840: 2020 6e6f 6465 5f73 7461 7465 203d 205b    node_state = [
-00012850: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
-00012860: 6465 5f6e 616d 6520 3d20 5b5d 0a20 2020  de_name = [].   
-00012870: 2020 2020 2020 2020 2065 6467 655f 7820           edge_x 
-00012880: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00012890: 2065 6467 655f 7920 3d20 5b5d 0a0a 2020   edge_y = []..  
-000128a0: 2020 2020 2020 2020 2020 7820 3d20 7365            x = se
-000128b0: 6c66 2e6c 6179 6f75 742e 780a 2020 2020  lf.layout.x.    
-000128c0: 2020 2020 2020 2020 7920 3d20 7365 6c66          y = self
-000128d0: 2e6c 6179 6f75 742e 790a 0a20 2020 2020  .layout.y..     
-000128e0: 2020 2020 2020 2074 6173 6b73 203d 2073         tasks = s
-000128f0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-00012900: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
-00012910: 666f 7220 6b65 7920 696e 206e 6577 3a0a  for key in new:.
-00012920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012930: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00012940: 2020 2020 2020 2020 2074 6173 6b20 3d20           task = 
-00012950: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-00012960: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00012970: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+0000c5b0: 2020 6e61 6d65 733d 636f 6d70 7574 655f    names=compute_
+0000c5c0: 6e61 6d65 732c 0a20 2020 2020 2020 2020  names,.         
+0000c5d0: 2020 2020 2020 2066 6f72 6d61 7474 6564         formatted
+0000c5e0: 5f74 696d 653d 5b66 6f72 6d61 745f 7469  _time=[format_ti
+0000c5f0: 6d65 2874 2920 666f 7220 7420 696e 2063  me(t) for t in c
+0000c600: 6f6d 7075 7465 5f74 696d 655d 2c0a 2020  ompute_time],.  
+0000c610: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000c620: 2020 2020 2020 2020 2075 7064 6174 6528           update(
+0000c630: 7365 6c66 2e63 6f6d 7075 7465 5f73 6f75  self.compute_sou
+0000c640: 7263 652c 2063 6f6d 7075 7465 5f72 6573  rce, compute_res
+0000c650: 756c 7429 0a0a 0a63 6c61 7373 2041 6767  ult)...class Agg
+0000c660: 7265 6761 7465 4163 7469 6f6e 2844 6173  regateAction(Das
+0000c670: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+0000c680: 3a0a 2020 2020 2222 2242 6172 2063 6861  :.    """Bar cha
+0000c690: 7274 2073 686f 7769 6e67 2074 696d 6520  rt showing time 
+0000c6a0: 7370 656e 6420 696e 2061 6374 696f 6e20  spend in action 
+0000c6b0: 6279 206b 6579 2070 7265 6669 7822 2222  by key prefix"""
+0000c6c0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+0000c6d0: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
+0000c6e0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+0000c6f0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+0000c700: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000c710: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000c720: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+0000c730: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
+0000c740: 2069 6620 5461 736b 5374 7265 616d 506c   if TaskStreamPl
+0000c750: 7567 696e 2e6e 616d 6520 6e6f 7420 696e  ugin.name not in
+0000c760: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+0000c770: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
+0000c780: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+0000c790: 6c65 722e 6164 645f 706c 7567 696e 2854  ler.add_plugin(T
+0000c7a0: 6173 6b53 7472 6561 6d50 6c75 6769 6e28  askStreamPlugin(
+0000c7b0: 7365 6c66 2e73 6368 6564 756c 6572 2929  self.scheduler))
+0000c7c0: 0a0a 2020 2020 2020 2020 6163 7469 6f6e  ..        action
+0000c7d0: 5f64 6174 6120 3d20 7b0a 2020 2020 2020  _data = {.      
+0000c7e0: 2020 2020 2020 2274 696d 6573 223a 205b        "times": [
+0000c7f0: 302e 322c 2030 2e31 5d2c 0a20 2020 2020  0.2, 0.1],.     
+0000c800: 2020 2020 2020 2022 666f 726d 6174 7465         "formatte
+0000c810: 645f 7469 6d65 223a 205b 2230 2e32 206d  d_time": ["0.2 m
+0000c820: 7322 2c20 2232 2e38 2075 7322 5d2c 0a20  s", "2.8 us"],. 
+0000c830: 2020 2020 2020 2020 2020 2022 636f 6c6f             "colo
+0000c840: 7222 3a20 5b74 735f 636f 6c6f 725f 6c6f  r": [ts_color_lo
+0000c850: 6f6b 7570 5b22 7472 616e 7366 6572 225d  okup["transfer"]
+0000c860: 2c20 7473 5f63 6f6c 6f72 5f6c 6f6f 6b75  , ts_color_looku
+0000c870: 705b 2263 6f6d 7075 7465 225d 5d2c 0a20  p["compute"]],. 
+0000c880: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+0000c890: 7322 3a20 5b22 7472 616e 7366 6572 222c  s": ["transfer",
+0000c8a0: 2022 636f 6d70 7574 6522 5d2c 0a20 2020   "compute"],.   
+0000c8b0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0000c8c0: 7365 6c66 2e61 6374 696f 6e5f 736f 7572  self.action_sour
+0000c8d0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+0000c8e0: 6f75 7263 6528 6461 7461 3d61 6374 696f  ource(data=actio
+0000c8f0: 6e5f 6461 7461 290a 0a20 2020 2020 2020  n_data)..       
+0000c900: 2073 656c 662e 726f 6f74 203d 2066 6967   self.root = fig
+0000c910: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
+0000c920: 2074 6974 6c65 3d22 4167 6772 6567 6174   title="Aggregat
+0000c930: 6520 5065 7220 4163 7469 6f6e 222c 0a20  e Per Action",. 
+0000c940: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000c950: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000c960: 206e 616d 653d 2261 6767 7265 6761 7465   name="aggregate
+0000c970: 5f70 6572 5f61 6374 696f 6e22 2c0a 2020  _per_action",.  
+0000c980: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
+0000c990: 653d 5b22 6122 2c20 2262 225d 2c0a 2020  e=["a", "b"],.  
+0000c9a0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+0000c9b0: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
+0000c9c0: 2020 2020 2020 2072 6563 7420 3d20 7365         rect = se
+0000c9d0: 6c66 2e72 6f6f 742e 7662 6172 280a 2020  lf.root.vbar(.  
+0000c9e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000c9f0: 3d73 656c 662e 6163 7469 6f6e 5f73 6f75  =self.action_sou
+0000ca00: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0000ca10: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
+0000ca20: 2020 2020 2020 2020 746f 703d 2274 696d          top="tim
+0000ca30: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0000ca40: 2077 6964 7468 3d30 2e37 2c0a 2020 2020   width=0.7,.    
+0000ca50: 2020 2020 2020 2020 636f 6c6f 723d 2263          color="c
+0000ca60: 6f6c 6f72 222c 0a20 2020 2020 2020 2029  olor",.        )
+0000ca70: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+0000ca80: 6f6f 742e 795f 7261 6e67 652e 7374 6172  oot.y_range.star
+0000ca90: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
+0000caa0: 6c66 2e72 6f6f 742e 7961 7869 735b 305d  lf.root.yaxis[0]
+0000cab0: 2e66 6f72 6d61 7474 6572 203d 204e 756d  .formatter = Num
+0000cac0: 6572 616c 5469 636b 466f 726d 6174 7465  eralTickFormatte
+0000cad0: 7228 666f 726d 6174 3d22 3022 290a 2020  r(format="0").  
+0000cae0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000caf0: 7961 7869 732e 6178 6973 5f6c 6162 656c  yaxis.axis_label
+0000cb00: 203d 2022 5469 6d65 2028 7329 220a 2020   = "Time (s)".  
+0000cb10: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000cb20: 7961 7869 732e 7469 636b 6572 203d 2041  yaxis.ticker = A
+0000cb30: 6461 7074 6976 6554 6963 6b65 7228 2a2a  daptiveTicker(**
+0000cb40: 5449 434b 535f 3130 3234 290a 2020 2020  TICKS_1024).    
+0000cb50: 2020 2020 7365 6c66 2e72 6f6f 742e 7861      self.root.xa
+0000cb60: 7869 732e 6d61 6a6f 725f 6c61 6265 6c5f  xis.major_label_
+0000cb70: 6f72 6965 6e74 6174 696f 6e20 3d20 584c  orientation = XL
+0000cb80: 4142 454c 5f4f 5249 454e 5441 5449 4f4e  ABEL_ORIENTATION
+0000cb90: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000cba0: 6f74 2e78 6178 6973 2e6d 616a 6f72 5f6c  ot.xaxis.major_l
+0000cbb0: 6162 656c 5f74 6578 745f 666f 6e74 5f73  abel_text_font_s
+0000cbc0: 697a 6520 3d20 2231 3670 7822 0a20 2020  ize = "16px".   
+0000cbd0: 2020 2020 2072 6563 742e 6e6f 6e73 656c       rect.nonsel
+0000cbe0: 6563 7469 6f6e 5f67 6c79 7068 203d 204e  ection_glyph = N
+0000cbf0: 6f6e 650a 0a20 2020 2020 2020 2073 656c  one..        sel
+0000cc00: 662e 726f 6f74 2e78 6178 6973 2e6d 696e  f.root.xaxis.min
+0000cc10: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+0000cc20: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+0000cc30: 656c 662e 726f 6f74 2e78 6772 6964 2e76  elf.root.xgrid.v
+0000cc40: 6973 6962 6c65 203d 2046 616c 7365 0a0a  isible = False..
+0000cc50: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0000cc60: 742e 746f 6f6c 6261 725f 6c6f 6361 7469  t.toolbar_locati
+0000cc70: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
+0000cc80: 2020 2068 6f76 6572 203d 2048 6f76 6572     hover = Hover
+0000cc90: 546f 6f6c 2829 0a20 2020 2020 2020 2068  Tool().        h
+0000cca0: 6f76 6572 2e74 6f6f 6c74 6970 7320 3d20  over.tooltips = 
+0000ccb0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+0000ccc0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+0000ccd0: 2020 2020 2020 3c70 3e3c 623e 4e61 6d65        <p><b>Name
+0000cce0: 3a3c 2f62 3e20 406e 616d 6573 3c2f 703e  :</b> @names</p>
+0000ccf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd00: 203c 703e 3c62 3e54 696d 653a 3c2f 623e   <p><b>Time:</b>
+0000cd10: 2040 666f 726d 6174 7465 645f 7469 6d65   @formatted_time
+0000cd20: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
+0000cd30: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+0000cd40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000cd50: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
+0000cd60: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
+0000cd70: 7365 220a 2020 2020 2020 2020 7365 6c66  se".        self
+0000cd80: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
+0000cd90: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
+0000cda0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+0000cdb0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+0000cdc0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+0000cdd0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+0000cde0: 2020 2020 2020 2061 6767 5f74 696d 6573         agg_times
+0000cdf0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+0000ce00: 6c6f 6174 290a 0a20 2020 2020 2020 2066  loat)..        f
+0000ce10: 6f72 2074 7320 696e 2073 656c 662e 7363  or ts in self.sc
+0000ce20: 6865 6475 6c65 722e 7461 736b 5f70 7265  heduler.task_pre
+0000ce30: 6669 7865 732e 7661 6c75 6573 2829 3a0a  fixes.values():.
+0000ce40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000ce50: 6163 7469 6f6e 2c20 7420 696e 2074 732e  action, t in ts.
+0000ce60: 616c 6c5f 6475 7261 7469 6f6e 732e 6974  all_durations.it
+0000ce70: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+0000ce80: 2020 2020 2020 2061 6767 5f74 696d 6573         agg_times
+0000ce90: 5b61 6374 696f 6e5d 202b 3d20 740a 0a20  [action] += t.. 
+0000cea0: 2020 2020 2020 2023 206f 7264 6572 2062         # order b
+0000ceb0: 7920 6c61 7267 6573 7420 7469 6d65 2066  y largest time f
+0000cec0: 6972 7374 0a20 2020 2020 2020 2061 6767  irst.        agg
+0000ced0: 5f74 696d 6573 203d 2073 6f72 7465 6428  _times = sorted(
+0000cee0: 6167 675f 7469 6d65 732e 6974 656d 7328  agg_times.items(
+0000cef0: 292c 206b 6579 3d6c 616d 6264 6120 783a  ), key=lambda x:
+0000cf00: 2078 5b31 5d2c 2072 6576 6572 7365 3d54   x[1], reverse=T
+0000cf10: 7275 6529 0a0a 2020 2020 2020 2020 6167  rue)..        ag
+0000cf20: 675f 636f 6c6f 7273 203d 206c 6973 7428  g_colors = list(
+0000cf30: 290a 2020 2020 2020 2020 6167 675f 6e61  ).        agg_na
+0000cf40: 6d65 7320 3d20 6c69 7374 2829 0a20 2020  mes = list().   
+0000cf50: 2020 2020 2061 6767 5f74 696d 6520 3d20       agg_time = 
+0000cf60: 6c69 7374 2829 0a20 2020 2020 2020 2066  list().        f
+0000cf70: 6f72 2061 6374 696f 6e2c 2074 2069 6e20  or action, t in 
+0000cf80: 6167 675f 7469 6d65 733a 0a20 2020 2020  agg_times:.     
+0000cf90: 2020 2020 2020 2061 6767 5f6e 616d 6573         agg_names
+0000cfa0: 2e61 7070 656e 6428 6163 7469 6f6e 290a  .append(action).
+0000cfb0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0000cfc0: 6374 696f 6e20 3d3d 2022 636f 6d70 7574  ction == "comput
+0000cfd0: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+0000cfe0: 2020 2020 6167 675f 636f 6c6f 7273 2e61      agg_colors.a
+0000cff0: 7070 656e 6428 2270 7572 706c 6522 290a  ppend("purple").
+0000d000: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000d010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d020: 2020 6167 675f 636f 6c6f 7273 2e61 7070    agg_colors.app
+0000d030: 656e 6428 7473 5f63 6f6c 6f72 5f6c 6f6f  end(ts_color_loo
+0000d040: 6b75 705b 6163 7469 6f6e 5d29 0a20 2020  kup[action]).   
+0000d050: 2020 2020 2020 2020 2061 6767 5f74 696d           agg_tim
+0000d060: 652e 6170 7065 6e64 2874 290a 0a20 2020  e.append(t)..   
+0000d070: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
+0000d080: 5f72 616e 6765 2e66 6163 746f 7273 203d  _range.factors =
+0000d090: 2061 6767 5f6e 616d 6573 0a20 2020 2020   agg_names.     
+0000d0a0: 2020 2073 656c 662e 726f 6f74 2e74 6974     self.root.tit
+0000d0b0: 6c65 2e74 6578 7420 3d20 2241 6767 7265  le.text = "Aggre
+0000d0c0: 6761 7465 2054 696d 6520 5065 7220 4163  gate Time Per Ac
+0000d0d0: 7469 6f6e 220a 0a20 2020 2020 2020 2061  tion"..        a
+0000d0e0: 6374 696f 6e5f 7265 7375 6c74 203d 2064  ction_result = d
+0000d0f0: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
+0000d100: 2074 696d 6573 3d61 6767 5f74 696d 652c   times=agg_time,
+0000d110: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000d120: 6f72 3d61 6767 5f63 6f6c 6f72 732c 0a20  or=agg_colors,. 
+0000d130: 2020 2020 2020 2020 2020 206e 616d 6573             names
+0000d140: 3d61 6767 5f6e 616d 6573 2c0a 2020 2020  =agg_names,.    
+0000d150: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
+0000d160: 645f 7469 6d65 3d5b 666f 726d 6174 5f74  d_time=[format_t
+0000d170: 696d 6528 7429 2066 6f72 2074 2069 6e20  ime(t) for t in 
+0000d180: 6167 675f 7469 6d65 5d2c 0a20 2020 2020  agg_time],.     
+0000d190: 2020 2029 0a0a 2020 2020 2020 2020 7570     )..        up
+0000d1a0: 6461 7465 2873 656c 662e 6163 7469 6f6e  date(self.action
+0000d1b0: 5f73 6f75 7263 652c 2061 6374 696f 6e5f  _source, action_
+0000d1c0: 7265 7375 6c74 290a 0a0a 636c 6173 7320  result)...class 
+0000d1d0: 4d65 6d6f 7279 4279 4b65 7928 4461 7368  MemoryByKey(Dash
+0000d1e0: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
+0000d1f0: 0a20 2020 2022 2222 4261 7220 6368 6172  .    """Bar char
+0000d200: 7420 7368 6f77 696e 6720 6d65 6d6f 7279  t showing memory
+0000d210: 2075 7365 2062 7920 6b65 7920 7072 6566   use by key pref
+0000d220: 6978 2222 220a 0a20 2020 2040 6c6f 675f  ix"""..    @log_
+0000d230: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
+0000d240: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+0000d250: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+0000d260: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+0000d270: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
+0000d280: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+0000d290: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+0000d2a0: 2020 2020 2073 656c 662e 736f 7572 6365       self.source
+0000d2b0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+0000d2c0: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+0000d2d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000d2e0: 2020 2022 6e61 6d65 223a 205b 2261 222c     "name": ["a",
+0000d2f0: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
+0000d300: 2020 2020 2020 2022 6e62 7974 6573 223a         "nbytes":
+0000d310: 205b 3130 302c 2031 3030 305d 2c0a 2020   [100, 1000],.  
+0000d320: 2020 2020 2020 2020 2020 2020 2020 2263                "c
+0000d330: 6f75 6e74 223a 205b 312c 2032 5d2c 0a20  ount": [1, 2],. 
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000d350: 636f 6c6f 7222 3a20 5b22 626c 7565 222c  color": ["blue",
+0000d360: 2022 626c 7565 225d 2c0a 2020 2020 2020   "blue"],.      
+0000d370: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000d380: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000d390: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
+0000d3a0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+0000d3b0: 3d22 4d65 6d6f 7279 2055 7365 222c 0a20  ="Memory Use",. 
+0000d3c0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+0000d3d0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+0000d3e0: 206e 616d 653d 226d 656d 6f72 795f 6279   name="memory_by
+0000d3f0: 5f6b 6579 222c 0a20 2020 2020 2020 2020  _key",.         
+0000d400: 2020 2078 5f72 616e 6765 3d5b 2261 222c     x_range=["a",
+0000d410: 2022 6222 5d2c 0a20 2020 2020 2020 2020   "b"],.         
+0000d420: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+0000d430: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000d440: 6563 7420 3d20 7365 6c66 2e72 6f6f 742e  ect = self.root.
+0000d450: 7662 6172 280a 2020 2020 2020 2020 2020  vbar(.          
+0000d460: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+0000d470: 7572 6365 2c20 783d 226e 616d 6522 2c20  urce, x="name", 
+0000d480: 746f 703d 226e 6279 7465 7322 2c20 7769  top="nbytes", wi
+0000d490: 6474 683d 302e 392c 2063 6f6c 6f72 3d22  dth=0.9, color="
+0000d4a0: 636f 6c6f 7222 0a20 2020 2020 2020 2029  color".        )
+0000d4b0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000d4c0: 6f74 2e79 6178 6973 5b30 5d2e 666f 726d  ot.yaxis[0].form
+0000d4d0: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
+0000d4e0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
+0000d4f0: 6d61 743d 2230 2e30 2062 2229 0a20 2020  mat="0.0 b").   
+0000d500: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+0000d510: 6178 6973 2e74 6963 6b65 7220 3d20 4164  axis.ticker = Ad
+0000d520: 6170 7469 7665 5469 636b 6572 282a 2a54  aptiveTicker(**T
+0000d530: 4943 4b53 5f31 3032 3429 0a20 2020 2020  ICKS_1024).     
+0000d540: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
+0000d550: 6973 2e6d 616a 6f72 5f6c 6162 656c 5f6f  is.major_label_o
+0000d560: 7269 656e 7461 7469 6f6e 203d 2058 4c41  rientation = XLA
+0000d570: 4245 4c5f 4f52 4945 4e54 4154 494f 4e0a  BEL_ORIENTATION.
+0000d580: 2020 2020 2020 2020 7265 6374 2e6e 6f6e          rect.non
+0000d590: 7365 6c65 6374 696f 6e5f 676c 7970 6820  selection_glyph 
+0000d5a0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+0000d5b0: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
+0000d5c0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
+0000d5d0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
+0000d5e0: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
+0000d5f0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
+0000d600: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+0000d610: 726f 6f74 2e74 6f6f 6c62 6172 5f6c 6f63  root.toolbar_loc
+0000d620: 6174 696f 6e20 3d20 4e6f 6e65 0a0a 2020  ation = None..  
+0000d630: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+0000d640: 7665 7254 6f6f 6c28 290a 2020 2020 2020  verTool().      
+0000d650: 2020 686f 7665 722e 746f 6f6c 7469 7073    hover.tooltips
+0000d660: 203d 2022 406e 616d 653a 2040 6e62 7974   = "@name: @nbyt
+0000d670: 6573 5f74 6578 7422 0a20 2020 2020 2020  es_text".       
+0000d680: 2068 6f76 6572 2e74 6f6f 6c74 6970 7320   hover.tooltips 
+0000d690: 3d20 2222 220a 2020 2020 2020 2020 2020  = """.          
+0000d6a0: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+0000d6b0: 2020 2020 2020 2020 3c70 3e3c 623e 4e61          <p><b>Na
+0000d6c0: 6d65 3a3c 2f62 3e20 406e 616d 653c 2f70  me:</b> @name</p
+0000d6d0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0000d6e0: 2020 3c70 3e3c 623e 4279 7465 733a 3c2f    <p><b>Bytes:</
+0000d6f0: 623e 2040 6e62 7974 6573 5f74 6578 7420  b> @nbytes_text 
+0000d700: 3c2f 703e 0a20 2020 2020 2020 2020 2020  </p>.           
+0000d710: 2020 2020 203c 703e 3c62 3e43 6f75 6e74       <p><b>Count
+0000d720: 3a3c 2f62 3e20 4063 6f75 6e74 206f 626a  :</b> @count obj
+0000d730: 6563 7473 203c 2f70 3e0a 2020 2020 2020  ects </p>.      
+0000d740: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+0000d750: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+0000d760: 2020 2020 2068 6f76 6572 2e70 6f69 6e74       hover.point
+0000d770: 5f70 6f6c 6963 7920 3d20 2266 6f6c 6c6f  _policy = "follo
+0000d780: 775f 6d6f 7573 6522 0a20 2020 2020 2020  w_mouse".       
+0000d790: 2073 656c 662e 726f 6f74 2e61 6464 5f74   self.root.add_t
+0000d7a0: 6f6f 6c73 2868 6f76 6572 290a 0a20 2020  ools(hover)..   
+0000d7b0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
+0000d7c0: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
+0000d7d0: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+0000d7e0: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
+0000d7f0: 6629 3a0a 2020 2020 2020 2020 636f 756e  f):.        coun
+0000d800: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
+0000d810: 2869 6e74 290a 2020 2020 2020 2020 6e62  (int).        nb
+0000d820: 7974 6573 203d 2064 6566 6175 6c74 6469  ytes = defaultdi
+0000d830: 6374 2869 6e74 290a 2020 2020 2020 2020  ct(int).        
+0000d840: 666f 7220 7773 2069 6e20 7365 6c66 2e73  for ws in self.s
+0000d850: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0000d860: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+0000d870: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0000d880: 2077 732e 6861 735f 7768 6174 3a0a 2020   ws.has_what:.  
+0000d890: 2020 2020 2020 2020 2020 2020 2020 6b73                ks
+0000d8a0: 203d 206b 6579 5f73 706c 6974 2874 732e   = key_split(ts.
+0000d8b0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0000d8c0: 2020 2020 2063 6f75 6e74 735b 6b73 5d20       counts[ks] 
+0000d8d0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+0000d8e0: 2020 2020 206e 6279 7465 735b 6b73 5d20       nbytes[ks] 
+0000d8f0: 2b3d 2074 732e 6e62 7974 6573 0a0a 2020  += ts.nbytes..  
+0000d900: 2020 2020 2020 6e61 6d65 7320 3d20 6c69        names = li
+0000d910: 7374 2873 6f72 7465 6428 636f 756e 7473  st(sorted(counts
+0000d920: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0000d930: 726f 6f74 2e78 5f72 616e 6765 2e66 6163  root.x_range.fac
+0000d940: 746f 7273 203d 206e 616d 6573 0a20 2020  tors = names.   
+0000d950: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
+0000d960: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
+0000d970: 6522 3a20 6e61 6d65 732c 0a20 2020 2020  e": names,.     
+0000d980: 2020 2020 2020 2022 636f 756e 7422 3a20         "count": 
+0000d990: 5b63 6f75 6e74 735b 6e61 6d65 5d20 666f  [counts[name] fo
+0000d9a0: 7220 6e61 6d65 2069 6e20 6e61 6d65 735d  r name in names]
+0000d9b0: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
+0000d9c0: 6279 7465 7322 3a20 5b6e 6279 7465 735b  bytes": [nbytes[
+0000d9d0: 6e61 6d65 5d20 666f 7220 6e61 6d65 2069  name] for name i
+0000d9e0: 6e20 6e61 6d65 735d 2c0a 2020 2020 2020  n names],.      
+0000d9f0: 2020 2020 2020 226e 6279 7465 735f 7465        "nbytes_te
+0000da00: 7874 223a 205b 666f 726d 6174 5f62 7974  xt": [format_byt
+0000da10: 6573 286e 6279 7465 735b 6e61 6d65 5d29  es(nbytes[name])
+0000da20: 2066 6f72 206e 616d 6520 696e 206e 616d   for name in nam
+0000da30: 6573 5d2c 0a20 2020 2020 2020 2020 2020  es],.           
+0000da40: 2022 636f 6c6f 7222 3a20 5b63 6f6c 6f72   "color": [color
+0000da50: 5f6f 6628 6e61 6d65 2920 666f 7220 6e61  _of(name) for na
+0000da60: 6d65 2069 6e20 6e61 6d65 735d 2c0a 2020  me in names],.  
+0000da70: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0000da80: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
+0000da90: 7465 7874 203d 2022 546f 7461 6c20 5573  text = "Total Us
+0000daa0: 653a 2022 202b 2066 6f72 6d61 745f 6279  e: " + format_by
+0000dab0: 7465 7328 7375 6d28 6e62 7974 6573 2e76  tes(sum(nbytes.v
+0000dac0: 616c 7565 7328 2929 290a 0a20 2020 2020  alues()))..     
+0000dad0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+0000dae0: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
+0000daf0: 0a63 6c61 7373 2043 7572 7265 6e74 4c6f  .class CurrentLo
+0000db00: 6164 2844 6173 6862 6f61 7264 436f 6d70  ad(DashboardComp
+0000db10: 6f6e 656e 7429 3a0a 2020 2020 2222 2254  onent):.    """T
+0000db20: 6173 6b73 2061 6e64 2043 5055 2075 7361  asks and CPU usa
+0000db30: 6765 206f 6e20 6561 6368 2077 6f72 6b65  ge on each worke
+0000db40: 7222 2222 0a0a 2020 2020 406c 6f67 5f65  r"""..    @log_e
+0000db50: 7272 6f72 730a 2020 2020 6465 6620 5f5f  rrors.    def __
+0000db60: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+0000db70: 6564 756c 6572 2c20 7769 6474 683d 3630  eduler, width=60
+0000db80: 302c 202a 2a6b 7761 7267 7329 3a0a 2020  0, **kwargs):.  
+0000db90: 2020 2020 2020 7365 6c66 2e6c 6173 7420        self.last 
+0000dba0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000dbb0: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+0000dbc0: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+0000dbd0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+0000dbe0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+0000dbf0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0000dc00: 2020 2020 2020 2020 2020 2020 2022 6e70               "np
+0000dc10: 726f 6365 7373 696e 6722 3a20 5b5d 2c0a  rocessing": [],.
+0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc30: 226e 7072 6f63 6573 7369 6e67 2d68 616c  "nprocessing-hal
+0000dc40: 6622 3a20 5b5d 2c0a 2020 2020 2020 2020  f": [],.        
+0000dc50: 2020 2020 2020 2020 226e 7072 6f63 6573          "nproces
+0000dc60: 7369 6e67 2d63 6f6c 6f72 223a 205b 5d2c  sing-color": [],
+0000dc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc80: 2022 6370 7522 3a20 5b5d 2c0a 2020 2020   "cpu": [],.    
+0000dc90: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
+0000dca0: 2d68 616c 6622 3a20 5b5d 2c0a 2020 2020  -half": [],.    
+0000dcb0: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
+0000dcc0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+0000dcd0: 2020 2020 2022 776f 726b 6572 223a 205b       "worker": [
+0000dce0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0000dcf0: 2020 2022 6573 6361 7065 645f 776f 726b     "escaped_work
+0000dd00: 6572 223a 205b 5d2c 0a20 2020 2020 2020  er": [],.       
+0000dd10: 2020 2020 207d 0a20 2020 2020 2020 2029       }.        )
+0000dd20: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+0000dd30: 696e 6720 3d20 6669 6775 7265 280a 2020  ing = figure(.  
+0000dd40: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000dd50: 2254 6173 6b73 2050 726f 6365 7373 696e  "Tasks Processin
+0000dd60: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+0000dd70: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+0000dd80: 2020 2020 2020 6e61 6d65 3d22 7072 6f63        name="proc
+0000dd90: 6573 7369 6e67 222c 0a20 2020 2020 2020  essing",.       
+0000dda0: 2020 2020 2077 6964 7468 3d69 6e74 2877       width=int(w
+0000ddb0: 6964 7468 202f 2032 292c 0a20 2020 2020  idth / 2),.     
+0000ddc0: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+0000ddd0: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+0000dde0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0000ddf0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+0000de00: 2020 2020 2072 6563 7420 3d20 7072 6f63       rect = proc
+0000de10: 6573 7369 6e67 2e72 6563 7428 0a20 2020  essing.rect(.   
+0000de20: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0000de30: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0000de40: 2020 2020 2020 2020 2078 3d22 6e70 726f           x="npro
+0000de50: 6365 7373 696e 672d 6861 6c66 222c 0a20  cessing-half",. 
+0000de60: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
+0000de70: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
+0000de80: 6474 683d 226e 7072 6f63 6573 7369 6e67  dth="nprocessing
+0000de90: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+0000dea0: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
+0000deb0: 2020 2020 2020 2063 6f6c 6f72 3d22 6e70         color="np
+0000dec0: 726f 6365 7373 696e 672d 636f 6c6f 7222  rocessing-color"
+0000ded0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0000dee0: 2020 2020 7072 6f63 6573 7369 6e67 2e78      processing.x
+0000def0: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
+0000df00: 0a20 2020 2020 2020 2072 6563 742e 6e6f  .        rect.no
+0000df10: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
+0000df20: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+0000df30: 2063 7075 203d 2066 6967 7572 6528 0a20   cpu = figure(. 
+0000df40: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+0000df50: 3d22 4350 5520 5574 696c 697a 6174 696f  ="CPU Utilizatio
+0000df60: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+0000df70: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+0000df80: 2020 2020 2020 7769 6474 683d 696e 7428        width=int(
+0000df90: 7769 6474 6820 2f20 3229 2c0a 2020 2020  width / 2),.    
+0000dfa0: 2020 2020 2020 2020 6e61 6d65 3d22 6370          name="cp
+0000dfb0: 755f 6869 7374 222c 0a20 2020 2020 2020  u_hist",.       
+0000dfc0: 2020 2020 2078 5f72 616e 6765 3d28 302c       x_range=(0,
+0000dfd0: 2031 3030 292c 0a20 2020 2020 2020 2020   100),.         
+0000dfe0: 2020 206d 696e 5f62 6f72 6465 725f 626f     min_border_bo
+0000dff0: 7474 6f6d 3d35 302c 0a20 2020 2020 2020  ttom=50,.       
+0000e000: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0000e010: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e020: 2072 6563 7420 3d20 6370 752e 7265 6374   rect = cpu.rect
+0000e030: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
+0000e040: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+0000e050: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
+0000e060: 2263 7075 2d68 616c 6622 2c0a 2020 2020  "cpu-half",.    
+0000e070: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
+0000e080: 2020 2020 2020 2020 2020 2077 6964 7468             width
+0000e090: 3d22 6370 7522 2c0a 2020 2020 2020 2020  ="cpu",.        
+0000e0a0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
+0000e0b0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0000e0c0: 723d 2262 6c75 6522 2c0a 2020 2020 2020  r="blue",.      
+0000e0d0: 2020 290a 2020 2020 2020 2020 7265 6374    ).        rect
+0000e0e0: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
+0000e0f0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
+0000e100: 2020 2020 666f 7220 6669 6720 696e 2028      for fig in (
+0000e110: 7072 6f63 6573 7369 6e67 2c20 6370 7529  processing, cpu)
+0000e120: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
+0000e130: 672e 7861 7869 732e 6d69 6e6f 725f 7469  g.xaxis.minor_ti
+0000e140: 636b 5f6c 696e 655f 616c 7068 6120 3d20  ck_line_alpha = 
+0000e150: 300a 2020 2020 2020 2020 2020 2020 6669  0.            fi
+0000e160: 672e 7961 7869 732e 7669 7369 626c 6520  g.yaxis.visible 
+0000e170: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0000e180: 2020 2020 6669 672e 7967 7269 642e 7669      fig.ygrid.vi
+0000e190: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
+0000e1a0: 2020 2020 2020 2020 2020 2074 6170 203d             tap =
+0000e1b0: 2054 6170 546f 6f6c 2863 616c 6c62 6163   TapTool(callbac
+0000e1c0: 6b3d 4f70 656e 5552 4c28 7572 6c3d 222e  k=OpenURL(url=".
+0000e1d0: 2f69 6e66 6f2f 776f 726b 6572 2f40 6573  /info/worker/@es
+0000e1e0: 6361 7065 645f 776f 726b 6572 2e68 746d  caped_worker.htm
+0000e1f0: 6c22 2929 0a20 2020 2020 2020 2020 2020  l")).           
+0000e200: 2066 6967 2e61 6464 5f74 6f6f 6c73 2874   fig.add_tools(t
+0000e210: 6170 290a 0a20 2020 2020 2020 2020 2020  ap)..           
+0000e220: 2066 6967 2e74 6f6f 6c62 6172 5f6c 6f63   fig.toolbar_loc
+0000e230: 6174 696f 6e20 3d20 4e6f 6e65 0a20 2020  ation = None.   
+0000e240: 2020 2020 2020 2020 2066 6967 2e79 6178           fig.yax
+0000e250: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
+0000e260: 7365 0a0a 2020 2020 2020 2020 686f 7665  se..        hove
+0000e270: 7220 3d20 486f 7665 7254 6f6f 6c28 290a  r = HoverTool().
+0000e280: 2020 2020 2020 2020 686f 7665 722e 746f          hover.to
+0000e290: 6f6c 7469 7073 203d 2022 4077 6f72 6b65  oltips = "@worke
+0000e2a0: 7220 3a20 406e 7072 6f63 6573 7369 6e67  r : @nprocessing
+0000e2b0: 2074 6173 6b73 220a 2020 2020 2020 2020   tasks".        
+0000e2c0: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
+0000e2d0: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
+0000e2e0: 7365 220a 2020 2020 2020 2020 7072 6f63  se".        proc
+0000e2f0: 6573 7369 6e67 2e61 6464 5f74 6f6f 6c73  essing.add_tools
+0000e300: 2868 6f76 6572 290a 0a20 2020 2020 2020  (hover)..       
+0000e310: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+0000e320: 6f6c 2829 0a20 2020 2020 2020 2068 6f76  ol().        hov
+0000e330: 6572 2e74 6f6f 6c74 6970 7320 3d20 2240  er.tooltips = "@
+0000e340: 776f 726b 6572 203a 2040 6370 7520 2522  worker : @cpu %"
+0000e350: 0a20 2020 2020 2020 2068 6f76 6572 2e70  .        hover.p
+0000e360: 6f69 6e74 5f70 6f6c 6963 7920 3d20 2266  oint_policy = "f
+0000e370: 6f6c 6c6f 775f 6d6f 7573 6522 0a20 2020  ollow_mouse".   
+0000e380: 2020 2020 2063 7075 2e61 6464 5f74 6f6f       cpu.add_too
+0000e390: 6c73 2868 6f76 6572 290a 0a20 2020 2020  ls(hover)..     
+0000e3a0: 2020 2073 656c 662e 7072 6f63 6573 7369     self.processi
+0000e3b0: 6e67 5f66 6967 7572 6520 3d20 7072 6f63  ng_figure = proc
+0000e3c0: 6573 7369 6e67 0a20 2020 2020 2020 2073  essing.        s
+0000e3d0: 656c 662e 6370 755f 6669 6775 7265 203d  elf.cpu_figure =
+0000e3e0: 2063 7075 0a0a 2020 2020 4077 6974 686f   cpu..    @witho
+0000e3f0: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+0000e400: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+0000e410: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+0000e420: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+0000e430: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
+0000e440: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
+0000e450: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
+0000e460: 2020 2020 2020 206e 6f77 203d 2074 696d         now = tim
+0000e470: 6528 290a 2020 2020 2020 2020 6966 206e  e().        if n
+0000e480: 6f74 2061 6e79 2877 732e 7072 6f63 6573  ot any(ws.proces
+0000e490: 7369 6e67 2066 6f72 2077 7320 696e 2077  sing for ws in w
+0000e4a0: 6f72 6b65 7273 2920 616e 6420 6e6f 7720  orkers) and now 
+0000e4b0: 3c20 7365 6c66 2e6c 6173 7420 2b20 313a  < self.last + 1:
+0000e4c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000e4d0: 7572 6e0a 2020 2020 2020 2020 7365 6c66  urn.        self
+0000e4e0: 2e6c 6173 7420 3d20 6e6f 770a 0a20 2020  .last = now..   
+0000e4f0: 2020 2020 2063 7075 203d 205b 696e 7428       cpu = [int(
+0000e500: 7773 2e6d 6574 7269 6373 5b22 6370 7522  ws.metrics["cpu"
+0000e510: 5d29 2066 6f72 2077 7320 696e 2077 6f72  ]) for ws in wor
+0000e520: 6b65 7273 5d0a 2020 2020 2020 2020 6e70  kers].        np
+0000e530: 726f 6365 7373 696e 6720 3d20 5b6c 656e  rocessing = [len
+0000e540: 2877 732e 7072 6f63 6573 7369 6e67 2920  (ws.processing) 
+0000e550: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
+0000e560: 735d 0a0a 2020 2020 2020 2020 6e70 726f  s]..        npro
+0000e570: 6365 7373 696e 675f 636f 6c6f 7220 3d20  cessing_color = 
+0000e580: 5b5d 0a20 2020 2020 2020 2066 6f72 2077  [].        for w
+0000e590: 7320 696e 2077 6f72 6b65 7273 3a0a 2020  s in workers:.  
+0000e5a0: 2020 2020 2020 2020 2020 6966 2077 7320            if ws 
+0000e5b0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
+0000e5c0: 722e 6964 6c65 3a0a 2020 2020 2020 2020  r.idle:.        
+0000e5d0: 2020 2020 2020 2020 6e70 726f 6365 7373          nprocess
+0000e5e0: 696e 675f 636f 6c6f 722e 6170 7065 6e64  ing_color.append
+0000e5f0: 2822 7265 6422 290a 2020 2020 2020 2020  ("red").        
+0000e600: 2020 2020 656c 6966 2077 7320 696e 2073      elif ws in s
+0000e610: 656c 662e 7363 6865 6475 6c65 722e 7361  elf.scheduler.sa
+0000e620: 7475 7261 7465 643a 0a20 2020 2020 2020  turated:.       
+0000e630: 2020 2020 2020 2020 206e 7072 6f63 6573           nproces
+0000e640: 7369 6e67 5f63 6f6c 6f72 2e61 7070 656e  sing_color.appen
+0000e650: 6428 2267 7265 656e 2229 0a20 2020 2020  d("green").     
+0000e660: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000e670: 2020 2020 2020 2020 2020 2020 206e 7072               npr
+0000e680: 6f63 6573 7369 6e67 5f63 6f6c 6f72 2e61  ocessing_color.a
+0000e690: 7070 656e 6428 2262 6c75 6522 290a 0a20  ppend("blue").. 
+0000e6a0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0000e6b0: 7b0a 2020 2020 2020 2020 2020 2020 2263  {.            "c
+0000e6c0: 7075 223a 2063 7075 2c0a 2020 2020 2020  pu": cpu,.      
+0000e6d0: 2020 2020 2020 2263 7075 2d68 616c 6622        "cpu-half"
+0000e6e0: 3a20 5b63 202f 2032 2066 6f72 2063 2069  : [c / 2 for c i
+0000e6f0: 6e20 6370 755d 2c0a 2020 2020 2020 2020  n cpu],.        
+0000e700: 2020 2020 226e 7072 6f63 6573 7369 6e67      "nprocessing
+0000e710: 223a 206e 7072 6f63 6573 7369 6e67 2c0a  ": nprocessing,.
+0000e720: 2020 2020 2020 2020 2020 2020 226e 7072              "npr
+0000e730: 6f63 6573 7369 6e67 2d68 616c 6622 3a20  ocessing-half": 
+0000e740: 5b6e 7020 2f20 3220 666f 7220 6e70 2069  [np / 2 for np i
+0000e750: 6e20 6e70 726f 6365 7373 696e 675d 2c0a  n nprocessing],.
+0000e760: 2020 2020 2020 2020 2020 2020 226e 7072              "npr
+0000e770: 6f63 6573 7369 6e67 2d63 6f6c 6f72 223a  ocessing-color":
+0000e780: 206e 7072 6f63 6573 7369 6e67 5f63 6f6c   nprocessing_col
+0000e790: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0000e7a0: 2277 6f72 6b65 7222 3a20 5b77 732e 6164  "worker": [ws.ad
+0000e7b0: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+0000e7c0: 776f 726b 6572 735d 2c0a 2020 2020 2020  workers],.      
+0000e7d0: 2020 2020 2020 2265 7363 6170 6564 5f77        "escaped_w
+0000e7e0: 6f72 6b65 7222 3a20 5b65 7363 6170 652e  orker": [escape.
+0000e7f0: 7572 6c5f 6573 6361 7065 2877 732e 6164  url_escape(ws.ad
+0000e800: 6472 6573 7329 2066 6f72 2077 7320 696e  dress) for ws in
+0000e810: 2077 6f72 6b65 7273 5d2c 0a20 2020 2020   workers],.     
+0000e820: 2020 2020 2020 2022 7922 3a20 6c69 7374         "y": list
+0000e830: 2872 616e 6765 286c 656e 2877 6f72 6b65  (range(len(worke
+0000e840: 7273 2929 292c 0a20 2020 2020 2020 207d  rs))),.        }
+0000e850: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0000e860: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+0000e870: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0000e880: 2078 7261 6e67 6520 3d20 6d61 7828 7773   xrange = max(ws
+0000e890: 2e6e 7468 7265 6164 7320 6f72 2031 2066  .nthreads or 1 f
+0000e8a0: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
+0000e8b0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000e8c0: 2020 2020 2020 2020 2020 2020 7872 616e              xran
+0000e8d0: 6765 203d 2031 0a20 2020 2020 2020 2073  ge = 1.        s
+0000e8e0: 656c 662e 6370 755f 6669 6775 7265 2e78  elf.cpu_figure.x
+0000e8f0: 5f72 616e 6765 2e65 6e64 203d 2078 7261  _range.end = xra
+0000e900: 6e67 6520 2a20 3130 300a 0a20 2020 2020  nge * 100..     
+0000e910: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+0000e920: 6f75 7263 652c 2072 6573 756c 7429 0a0a  ource, result)..
+0000e930: 0a63 6c61 7373 2053 7465 616c 696e 6754  .class StealingT
+0000e940: 696d 6553 6572 6965 7328 4461 7368 626f  imeSeries(Dashbo
+0000e950: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+0000e960: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0000e970: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
+0000e980: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0000e990: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+0000e9a0: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
+0000e9b0: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
+0000e9c0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+0000e9d0: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
+0000e9e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0000e9f0: 2020 2020 2022 7469 6d65 223a 205b 7469       "time": [ti
+0000ea00: 6d65 2829 202a 2031 3030 302c 2074 696d  me() * 1000, tim
+0000ea10: 6528 2920 2a20 3130 3030 202b 2031 5d2c  e() * 1000 + 1],
+0000ea20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ea30: 2022 6964 6c65 223a 205b 302c 2030 5d2c   "idle": [0, 0],
+0000ea40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ea50: 2022 7361 7475 7261 7465 6422 3a20 5b30   "saturated": [0
+0000ea60: 2c20 305d 2c0a 2020 2020 2020 2020 2020  , 0],.          
+0000ea70: 2020 7d0a 2020 2020 2020 2020 290a 0a20    }.        ).. 
+0000ea80: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
+0000ea90: 2044 6174 6152 616e 6765 3164 2866 6f6c   DataRange1d(fol
+0000eaa0: 6c6f 773d 2265 6e64 222c 2066 6f6c 6c6f  low="end", follo
+0000eab0: 775f 696e 7465 7276 616c 3d32 3030 3030  w_interval=20000
+0000eac0: 2c20 7261 6e67 655f 7061 6464 696e 673d  , range_padding=
+0000ead0: 3029 0a0a 2020 2020 2020 2020 7365 6c66  0)..        self
+0000eae0: 2e72 6f6f 7420 3d20 6669 6775 7265 280a  .root = figure(.
+0000eaf0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0000eb00: 653d 2249 646c 6520 616e 6420 5361 7475  e="Idle and Satu
+0000eb10: 7261 7465 6420 576f 726b 6572 7320 4f76  rated Workers Ov
+0000eb20: 6572 2054 696d 6522 2c0a 2020 2020 2020  er Time",.      
+0000eb30: 2020 2020 2020 785f 6178 6973 5f74 7970        x_axis_typ
+0000eb40: 653d 2264 6174 6574 696d 6522 2c0a 2020  e="datetime",.  
+0000eb50: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+0000eb60: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+0000eb70: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
+0000eb80: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+0000eb90: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+0000eba0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000ebb0: 6f74 2e6c 696e 6528 736f 7572 6365 3d73  ot.line(source=s
+0000ebc0: 656c 662e 736f 7572 6365 2c20 783d 2274  elf.source, x="t
+0000ebd0: 696d 6522 2c20 793d 2269 646c 6522 2c20  ime", y="idle", 
+0000ebe0: 636f 6c6f 723d 2272 6564 2229 0a20 2020  color="red").   
+0000ebf0: 2020 2020 2073 656c 662e 726f 6f74 2e6c       self.root.l
+0000ec00: 696e 6528 736f 7572 6365 3d73 656c 662e  ine(source=self.
+0000ec10: 736f 7572 6365 2c20 783d 2274 696d 6522  source, x="time"
+0000ec20: 2c20 793d 2273 6174 7572 6174 6564 222c  , y="saturated",
+0000ec30: 2063 6f6c 6f72 3d22 6772 6565 6e22 290a   color="green").
+0000ec40: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0000ec50: 742e 7961 7869 732e 6d69 6e6f 725f 7469  t.yaxis.minor_ti
+0000ec60: 636b 5f6c 696e 655f 636f 6c6f 7220 3d20  ck_line_color = 
+0000ec70: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
+0000ec80: 6c66 2e72 6f6f 742e 6164 645f 746f 6f6c  lf.root.add_tool
+0000ec90: 7328 0a20 2020 2020 2020 2020 2020 2052  s(.            R
+0000eca0: 6573 6574 546f 6f6c 2829 2c20 5061 6e54  esetTool(), PanT
+0000ecb0: 6f6f 6c28 6469 6d65 6e73 696f 6e73 3d22  ool(dimensions="
+0000ecc0: 7769 6474 6822 292c 2057 6865 656c 5a6f  width"), WheelZo
+0000ecd0: 6f6d 546f 6f6c 2864 696d 656e 7369 6f6e  omTool(dimension
+0000ece0: 733d 2277 6964 7468 2229 0a20 2020 2020  s="width").     
+0000ecf0: 2020 2029 0a0a 2020 2020 4077 6974 686f     )..    @witho
+0000ed00: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+0000ed10: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+0000ed20: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+0000ed30: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+0000ed40: 2020 2020 2072 6573 756c 7420 3d20 7b0a       result = {.
+0000ed50: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
+0000ed60: 6522 3a20 5b74 696d 6528 2920 2a20 3130  e": [time() * 10
+0000ed70: 3030 5d2c 0a20 2020 2020 2020 2020 2020  00],.           
+0000ed80: 2022 6964 6c65 223a 205b 6c65 6e28 7365   "idle": [len(se
+0000ed90: 6c66 2e73 6368 6564 756c 6572 2e69 646c  lf.scheduler.idl
+0000eda0: 6529 5d2c 0a20 2020 2020 2020 2020 2020  e)],.           
+0000edb0: 2022 7361 7475 7261 7465 6422 3a20 5b6c   "saturated": [l
+0000edc0: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
+0000edd0: 722e 7361 7475 7261 7465 6429 5d2c 0a20  r.saturated)],. 
+0000ede0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0000edf0: 2069 6620 5052 4f46 494c 494e 473a 0a20   if PROFILING:. 
+0000ee00: 2020 2020 2020 2020 2020 2063 7572 646f             curdo
+0000ee10: 6328 292e 6164 645f 6e65 7874 5f74 6963  c().add_next_tic
+0000ee20: 6b5f 6361 6c6c 6261 636b 286c 616d 6264  k_callback(lambd
+0000ee30: 613a 2073 656c 662e 736f 7572 6365 2e73  a: self.source.s
+0000ee40: 7472 6561 6d28 7265 7375 6c74 2c20 3130  tream(result, 10
+0000ee50: 3030 3029 290a 2020 2020 2020 2020 656c  000)).        el
+0000ee60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000ee70: 7365 6c66 2e73 6f75 7263 652e 7374 7265  self.source.stre
+0000ee80: 616d 2872 6573 756c 742c 2031 3030 3030  am(result, 10000
+0000ee90: 290a 0a0a 636c 6173 7320 5374 6561 6c69  )...class Steali
+0000eea0: 6e67 4576 656e 7473 2844 6173 6862 6f61  ngEvents(Dashboa
+0000eeb0: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
+0000eec0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0000eed0: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
+0000eee0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+0000eef0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+0000ef00: 7220 3d20 7363 6865 6475 6c65 720a 2020  r = scheduler.  
+0000ef10: 2020 2020 2020 7365 6c66 2e73 7465 616c        self.steal
+0000ef20: 203d 2073 6368 6564 756c 6572 2e65 7874   = scheduler.ext
+0000ef30: 656e 7369 6f6e 735b 2273 7465 616c 696e  ensions["stealin
+0000ef40: 6722 5d0a 2020 2020 2020 2020 7365 6c66  g"].        self
+0000ef50: 2e6c 6173 7420 3d20 300a 2020 2020 2020  .last = 0.      
+0000ef60: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
+0000ef70: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+0000ef80: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+0000ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efa0: 2274 696d 6522 3a20 5b74 696d 6528 2920  "time": [time() 
+0000efb0: 2d20 3630 2c20 7469 6d65 2829 5d2c 0a20  - 60, time()],. 
+0000efc0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000efd0: 6c65 7665 6c22 3a20 5b30 2c20 3135 5d2c  level": [0, 15],
+0000efe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eff0: 2022 636f 6c6f 7222 3a20 5b22 7768 6974   "color": ["whit
+0000f000: 6522 2c20 2277 6869 7465 225d 2c0a 2020  e", "white"],.  
+0000f010: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+0000f020: 7572 6174 696f 6e22 3a20 5b30 2c20 305d  uration": [0, 0]
+0000f030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f040: 2020 2272 6164 6975 7322 3a20 5b31 2c20    "radius": [1, 
+0000f050: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0000f060: 2020 2020 2263 6f73 745f 6661 6374 6f72      "cost_factor
+0000f070: 223a 205b 302c 2031 305d 2c0a 2020 2020  ": [0, 10],.    
+0000f080: 2020 2020 2020 2020 2020 2020 2263 6f75              "cou
+0000f090: 6e74 223a 205b 312c 2031 5d2c 0a20 2020  nt": [1, 1],.   
+0000f0a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0000f0b0: 2020 2029 0a0a 2020 2020 2020 2020 785f     )..        x_
+0000f0c0: 7261 6e67 6520 3d20 4461 7461 5261 6e67  range = DataRang
+0000f0d0: 6531 6428 666f 6c6c 6f77 3d22 656e 6422  e1d(follow="end"
+0000f0e0: 2c20 666f 6c6c 6f77 5f69 6e74 6572 7661  , follow_interva
+0000f0f0: 6c3d 3230 3030 302c 2072 616e 6765 5f70  l=20000, range_p
+0000f100: 6164 6469 6e67 3d30 290a 0a20 2020 2020  adding=0)..     
+0000f110: 2020 2073 656c 662e 726f 6f74 203d 2066     self.root = f
+0000f120: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+0000f130: 2020 2074 6974 6c65 3d22 5374 6561 6c69     title="Steali
+0000f140: 6e67 2045 7665 6e74 7322 2c0a 2020 2020  ng Events",.    
+0000f150: 2020 2020 2020 2020 785f 6178 6973 5f74          x_axis_t
+0000f160: 7970 653d 2264 6174 6574 696d 6522 2c0a  ype="datetime",.
+0000f170: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+0000f180: 733d 2222 2c0a 2020 2020 2020 2020 2020  s="",.          
+0000f190: 2020 785f 7261 6e67 653d 785f 7261 6e67    x_range=x_rang
+0000f1a0: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
+0000f1b0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0000f1c0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0000f1d0: 2e72 6f6f 742e 6369 7263 6c65 280a 2020  .root.circle(.  
+0000f1e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0000f1f0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0000f200: 2020 2020 2020 2020 2020 783d 2274 696d            x="tim
+0000f210: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0000f220: 793d 226c 6576 656c 222c 0a20 2020 2020  y="level",.     
+0000f230: 2020 2020 2020 2063 6f6c 6f72 3d22 636f         color="co
+0000f240: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
+0000f250: 2020 7369 7a65 3d22 7261 6469 7573 222c    size="radius",
+0000f260: 0a20 2020 2020 2020 2020 2020 2061 6c70  .            alp
+0000f270: 6861 3d30 2e35 2c0a 2020 2020 2020 2020  ha=0.5,.        
+0000f280: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0000f290: 6f6f 742e 7961 7869 732e 6178 6973 5f6c  oot.yaxis.axis_l
+0000f2a0: 6162 656c 203d 2022 4c65 7665 6c22 0a0a  abel = "Level"..
+0000f2b0: 2020 2020 2020 2020 686f 7665 7220 3d20          hover = 
+0000f2c0: 486f 7665 7254 6f6f 6c28 290a 2020 2020  HoverTool().    
+0000f2d0: 2020 2020 686f 7665 722e 746f 6f6c 7469      hover.toolti
+0000f2e0: 7073 203d 2022 4c65 7665 6c3a 2040 6c65  ps = "Level: @le
+0000f2f0: 7665 6c2c 2044 7572 6174 696f 6e3a 2040  vel, Duration: @
+0000f300: 6475 7261 7469 6f6e 2c20 436f 756e 743a  duration, Count:
+0000f310: 2040 636f 756e 742c 2043 6f73 7420 6661   @count, Cost fa
+0000f320: 6374 6f72 3a20 4063 6f73 745f 6661 6374  ctor: @cost_fact
+0000f330: 6f72 220a 2020 2020 2020 2020 686f 7665  or".        hove
+0000f340: 722e 706f 696e 745f 706f 6c69 6379 203d  r.point_policy =
+0000f350: 2022 666f 6c6c 6f77 5f6d 6f75 7365 220a   "follow_mouse".
+0000f360: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000f370: 6f74 2e61 6464 5f74 6f6f 6c73 280a 2020  ot.add_tools(.  
+0000f380: 2020 2020 2020 2020 2020 686f 7665 722c            hover,
+0000f390: 0a20 2020 2020 2020 2020 2020 2052 6573  .            Res
+0000f3a0: 6574 546f 6f6c 2829 2c0a 2020 2020 2020  etTool(),.      
+0000f3b0: 2020 2020 2020 5061 6e54 6f6f 6c28 6469        PanTool(di
+0000f3c0: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
+0000f3d0: 292c 0a20 2020 2020 2020 2020 2020 2057  ),.            W
+0000f3e0: 6865 656c 5a6f 6f6d 546f 6f6c 2864 696d  heelZoomTool(dim
+0000f3f0: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
+0000f400: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000f410: 2064 6566 2063 6f6e 7665 7274 2873 656c   def convert(sel
+0000f420: 662c 206d 7367 7329 3a0a 2020 2020 2020  f, msgs):.      
+0000f430: 2020 2222 2243 6f6e 7665 7274 2061 206c    """Convert a l
+0000f440: 6f67 206d 6573 7361 6765 2074 6f20 6120  og message to a 
+0000f450: 676c 7970 6822 2222 0a20 2020 2020 2020  glyph""".       
+0000f460: 2074 6f74 616c 5f64 7572 6174 696f 6e20   total_duration 
+0000f470: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
+0000f480: 6d73 6720 696e 206d 7367 733a 0a20 2020  msg in msgs:.   
+0000f490: 2020 2020 2020 2020 2074 696d 652c 206c           time, l
+0000f4a0: 6576 656c 2c20 6b65 792c 2064 7572 6174  evel, key, durat
+0000f4b0: 696f 6e2c 2073 6174 2c20 6f63 635f 7361  ion, sat, occ_sa
+0000f4c0: 742c 2069 646c 2c20 6f63 635f 6964 6c20  t, idl, occ_idl 
+0000f4d0: 3d20 6d73 675b 3a38 5d0a 2020 2020 2020  = msg[:8].      
+0000f4e0: 2020 2020 2020 746f 7461 6c5f 6475 7261        total_dura
+0000f4f0: 7469 6f6e 202b 3d20 6475 7261 7469 6f6e  tion += duration
+0000f500: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+0000f510: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+0000f520: 203d 2056 6972 6964 6973 3131 5b6c 6576   = Viridis11[lev
+0000f530: 656c 5d0a 2020 2020 2020 2020 6578 6365  el].        exce
+0000f540: 7074 2028 4b65 7945 7272 6f72 2c20 496e  pt (KeyError, In
+0000f550: 6465 7845 7272 6f72 293a 0a20 2020 2020  dexError):.     
+0000f560: 2020 2020 2020 2063 6f6c 6f72 203d 2022         color = "
+0000f570: 626c 6163 6b22 0a0a 2020 2020 2020 2020  black"..        
+0000f580: 7261 6469 7573 203d 206d 6174 682e 7371  radius = math.sq
+0000f590: 7274 286d 696e 2874 6f74 616c 5f64 7572  rt(min(total_dur
+0000f5a0: 6174 696f 6e2c 2031 3029 2920 2a20 3330  ation, 10)) * 30
+0000f5b0: 202b 2032 0a0a 2020 2020 2020 2020 6420   + 2..        d 
+0000f5c0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000f5d0: 2274 696d 6522 3a20 7469 6d65 202a 2031  "time": time * 1
+0000f5e0: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
+0000f5f0: 2022 6c65 7665 6c22 3a20 6c65 7665 6c2c   "level": level,
+0000f600: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
+0000f610: 756e 7422 3a20 6c65 6e28 6d73 6773 292c  unt": len(msgs),
+0000f620: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
+0000f630: 6c6f 7222 3a20 636f 6c6f 722c 0a20 2020  lor": color,.   
+0000f640: 2020 2020 2020 2020 2022 6475 7261 7469           "durati
+0000f650: 6f6e 223a 2074 6f74 616c 5f64 7572 6174  on": total_durat
+0000f660: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+0000f670: 2022 7261 6469 7573 223a 2072 6164 6975   "radius": radiu
+0000f680: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0000f690: 636f 7374 5f66 6163 746f 7222 3a20 7365  cost_factor": se
+0000f6a0: 6c66 2e73 7465 616c 2e63 6f73 745f 6d75  lf.steal.cost_mu
+0000f6b0: 6c74 6970 6c69 6572 735b 6c65 7665 6c5d  ltipliers[level]
+0000f6c0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+0000f6d0: 2020 2020 2072 6574 7572 6e20 640a 0a20       return d.. 
+0000f6e0: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
+0000f6f0: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
+0000f700: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0000f710: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
+0000f720: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
+0000f730: 6720 3d20 7365 6c66 2e73 6368 6564 756c  g = self.schedul
+0000f740: 6572 2e67 6574 5f65 7665 6e74 7328 746f  er.get_events(to
+0000f750: 7069 633d 2273 7465 616c 696e 6722 290a  pic="stealing").
+0000f760: 2020 2020 2020 2020 6375 7272 656e 7420          current 
+0000f770: 3d20 6c65 6e28 7365 6c66 2e73 6368 6564  = len(self.sched
+0000f780: 756c 6572 2e65 7665 6e74 735b 2273 7465  uler.events["ste
+0000f790: 616c 696e 6722 5d29 0a20 2020 2020 2020  aling"]).       
+0000f7a0: 206e 203d 2063 7572 7265 6e74 202d 2073   n = current - s
+0000f7b0: 656c 662e 6c61 7374 0a0a 2020 2020 2020  elf.last..      
+0000f7c0: 2020 6c6f 6720 3d20 5b6c 6f67 5b2d 695d    log = [log[-i]
+0000f7d0: 5b31 5d5b 315d 2066 6f72 2069 2069 6e20  [1][1] for i in 
+0000f7e0: 7261 6e67 6528 312c 206e 202b 2031 2920  range(1, n + 1) 
+0000f7f0: 6966 206c 6f67 5b2d 695d 5b31 5d5b 305d  if log[-i][1][0]
+0000f800: 203d 3d20 2272 6571 7565 7374 225d 0a20   == "request"]. 
+0000f810: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000f820: 203d 2063 7572 7265 6e74 0a0a 2020 2020   = current..    
+0000f830: 2020 2020 6966 206c 6f67 3a0a 2020 2020      if log:.    
+0000f840: 2020 2020 2020 2020 6e65 7720 3d20 7069          new = pi
+0000f850: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
+0000f860: 2020 2020 6c6f 672c 0a20 2020 2020 2020      log,.       
+0000f870: 2020 2020 2020 2020 206d 6170 2867 726f           map(gro
+0000f880: 7570 6279 2831 2929 2c0a 2020 2020 2020  upby(1)),.      
+0000f890: 2020 2020 2020 2020 2020 6d61 7028 6469            map(di
+0000f8a0: 6374 2e76 616c 7565 7329 2c0a 2020 2020  ct.values),.    
+0000f8b0: 2020 2020 2020 2020 2020 2020 636f 6e63              conc
+0000f8c0: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
+0000f8d0: 2020 2020 6d61 7028 7365 6c66 2e63 6f6e      map(self.con
+0000f8e0: 7665 7274 292c 0a20 2020 2020 2020 2020  vert),.         
+0000f8f0: 2020 2020 2020 206c 6973 742c 0a20 2020         list,.   
+0000f900: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+0000f910: 6e73 706f 7365 2c0a 2020 2020 2020 2020  nspose,.        
+0000f920: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000f930: 2020 6966 2050 524f 4649 4c49 4e47 3a0a    if PROFILING:.
+0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f950: 6375 7264 6f63 2829 2e61 6464 5f6e 6578  curdoc().add_nex
+0000f960: 745f 7469 636b 5f63 616c 6c62 6163 6b28  t_tick_callback(
+0000f970: 6c61 6d62 6461 3a20 7365 6c66 2e73 6f75  lambda: self.sou
+0000f980: 7263 652e 7374 7265 616d 286e 6577 2c20  rce.stream(new, 
+0000f990: 3130 3030 3029 290a 2020 2020 2020 2020  10000)).        
+0000f9a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f9b0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0000f9c0: 6f75 7263 652e 7374 7265 616d 286e 6577  ource.stream(new
+0000f9d0: 2c20 3130 3030 3029 0a0a 0a63 6c61 7373  , 10000)...class
+0000f9e0: 2045 7665 6e74 7328 4461 7368 626f 6172   Events(Dashboar
+0000f9f0: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+0000fa00: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000fa10: 6c66 2c20 7363 6865 6475 6c65 722c 206e  lf, scheduler, n
+0000fa20: 616d 652c 2068 6569 6768 743d 3135 302c  ame, height=150,
+0000fa30: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0000fa40: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+0000fa50: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
+0000fa60: 2020 2020 2020 2073 656c 662e 6163 7469         self.acti
+0000fa70: 6f6e 5f79 7320 3d20 6469 6374 2829 0a20  on_ys = dict(). 
+0000fa80: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+0000fa90: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000faa0: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
+0000fab0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
+0000fac0: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
+0000fad0: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
+0000fae0: 2020 7b22 7469 6d65 223a 205b 5d2c 2022    {"time": [], "
+0000faf0: 6163 7469 6f6e 223a 205b 5d2c 2022 686f  action": [], "ho
+0000fb00: 7665 7222 3a20 5b5d 2c20 2279 223a 205b  ver": [], "y": [
+0000fb10: 5d2c 2022 636f 6c6f 7222 3a20 5b5d 7d0a  ], "color": []}.
+0000fb20: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000fb30: 2020 2078 5f72 616e 6765 203d 2044 6174     x_range = Dat
+0000fb40: 6152 616e 6765 3164 2866 6f6c 6c6f 773d  aRange1d(follow=
+0000fb50: 2265 6e64 222c 2066 6f6c 6c6f 775f 696e  "end", follow_in
+0000fb60: 7465 7276 616c 3d32 3030 3030 3029 0a0a  terval=200000)..
+0000fb70: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0000fb80: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+0000fb90: 2020 2020 2020 2020 7469 746c 653d 6e61          title=na
+0000fba0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0000fbb0: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
+0000fbc0: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
+0000fbd0: 2020 2020 6865 6967 6874 3d68 6569 6768      height=heigh
+0000fbe0: 742c 0a20 2020 2020 2020 2020 2020 2074  t,.            t
+0000fbf0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
+0000fc00: 2020 2020 2078 5f72 616e 6765 3d78 5f72       x_range=x_r
+0000fc10: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
+0000fc20: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0000fc30: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+0000fc40: 656c 662e 726f 6f74 2e63 6972 636c 6528  elf.root.circle(
+0000fc50: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0000fc60: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0000fc70: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
+0000fc80: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
+0000fc90: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
+0000fca0: 2020 2020 2020 636f 6c6f 723d 2263 6f6c        color="col
+0000fcb0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+0000fcc0: 2073 697a 653d 3530 2c0a 2020 2020 2020   size=50,.      
+0000fcd0: 2020 2020 2020 616c 7068 613d 302e 352c        alpha=0.5,
+0000fce0: 0a20 2020 2020 2020 2020 2020 206c 6567  .            leg
+0000fcf0: 656e 645f 6669 656c 643d 2261 6374 696f  end_field="actio
+0000fd00: 6e22 2c0a 2020 2020 2020 2020 290a 2020  n",.        ).  
+0000fd10: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0000fd20: 7961 7869 732e 6178 6973 5f6c 6162 656c  yaxis.axis_label
+0000fd30: 203d 2022 4163 7469 6f6e 220a 2020 2020   = "Action".    
+0000fd40: 2020 2020 7365 6c66 2e72 6f6f 742e 6c65      self.root.le
+0000fd50: 6765 6e64 2e6c 6f63 6174 696f 6e20 3d20  gend.location = 
+0000fd60: 2274 6f70 5f6c 6566 7422 0a0a 2020 2020  "top_left"..    
+0000fd70: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+0000fd80: 7254 6f6f 6c28 290a 2020 2020 2020 2020  rTool().        
+0000fd90: 686f 7665 722e 746f 6f6c 7469 7073 203d  hover.tooltips =
+0000fda0: 2022 4061 6374 696f 6e3c 6272 3e40 686f   "@action<br>@ho
+0000fdb0: 7665 7222 0a20 2020 2020 2020 2068 6f76  ver".        hov
+0000fdc0: 6572 2e70 6f69 6e74 5f70 6f6c 6963 7920  er.point_policy 
+0000fdd0: 3d20 2266 6f6c 6c6f 775f 6d6f 7573 6522  = "follow_mouse"
+0000fde0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+0000fdf0: 6f6f 742e 6164 645f 746f 6f6c 7328 0a20  oot.add_tools(. 
+0000fe00: 2020 2020 2020 2020 2020 2068 6f76 6572             hover
+0000fe10: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
+0000fe20: 7365 7454 6f6f 6c28 292c 0a20 2020 2020  setTool(),.     
+0000fe30: 2020 2020 2020 2050 616e 546f 6f6c 2864         PanTool(d
+0000fe40: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
+0000fe50: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0000fe60: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
+0000fe70: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
+0000fe80: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+0000fe90: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+0000fea0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+0000feb0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+0000fec0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+0000fed0: 6c66 293a 0a20 2020 2020 2020 206c 6f67  lf):.        log
+0000fee0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+0000fef0: 722e 6576 656e 7473 5b73 656c 662e 6e61  r.events[self.na
+0000ff00: 6d65 5d0a 2020 2020 2020 2020 6e20 3d20  me].        n = 
+0000ff10: 7365 6c66 2e73 6368 6564 756c 6572 2e65  self.scheduler.e
+0000ff20: 7665 6e74 5f63 6f75 6e74 735b 7365 6c66  vent_counts[self
+0000ff30: 2e6e 616d 655d 202d 2073 656c 662e 6c61  .name] - self.la
+0000ff40: 7374 0a20 2020 2020 2020 2069 6620 6c6f  st.        if lo
+0000ff50: 673a 0a20 2020 2020 2020 2020 2020 206c  g:.            l
+0000ff60: 6f67 203d 205b 6c6f 675b 2d69 5d20 666f  og = [log[-i] fo
+0000ff70: 7220 6920 696e 2072 616e 6765 2831 2c20  r i in range(1, 
+0000ff80: 6e20 2b20 3129 5d0a 2020 2020 2020 2020  n + 1)].        
+0000ff90: 7365 6c66 2e6c 6173 7420 3d20 7365 6c66  self.last = self
+0000ffa0: 2e73 6368 6564 756c 6572 2e65 7665 6e74  .scheduler.event
+0000ffb0: 5f63 6f75 6e74 735b 7365 6c66 2e6e 616d  _counts[self.nam
+0000ffc0: 655d 0a0a 2020 2020 2020 2020 6966 206c  e]..        if l
+0000ffd0: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
+0000ffe0: 6163 7469 6f6e 7320 3d20 5b5d 0a20 2020  actions = [].   
+0000fff0: 2020 2020 2020 2020 2074 696d 6573 203d           times =
+00010000: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00010010: 686f 7665 7273 203d 205b 5d0a 2020 2020  hovers = [].    
+00010020: 2020 2020 2020 2020 7973 203d 205b 5d0a          ys = [].
+00010030: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00010040: 7273 203d 205b 5d0a 2020 2020 2020 2020  rs = [].        
+00010050: 2020 2020 666f 7220 6d73 675f 7469 6d65      for msg_time
+00010060: 2c20 6d73 6720 696e 206c 6f67 3a0a 2020  , msg in log:.  
+00010070: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00010080: 6d65 732e 6170 7065 6e64 286d 7367 5f74  mes.append(msg_t
+00010090: 696d 6520 2a20 3130 3030 290a 2020 2020  ime * 1000).    
+000100a0: 2020 2020 2020 2020 2020 2020 6163 7469              acti
+000100b0: 6f6e 203d 206d 7367 5b22 6163 7469 6f6e  on = msg["action
+000100c0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+000100d0: 2020 2061 6374 696f 6e73 2e61 7070 656e     actions.appen
+000100e0: 6428 6163 7469 6f6e 290a 2020 2020 2020  d(action).      
+000100f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00010100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010110: 2020 2079 732e 6170 7065 6e64 2873 656c     ys.append(sel
+00010120: 662e 6163 7469 6f6e 5f79 735b 6163 7469  f.action_ys[acti
+00010130: 6f6e 5d29 0a20 2020 2020 2020 2020 2020  on]).           
+00010140: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+00010150: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00010160: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00010170: 6374 696f 6e5f 7973 5b61 6374 696f 6e5d  ction_ys[action]
+00010180: 203d 206c 656e 2873 656c 662e 6163 7469   = len(self.acti
+00010190: 6f6e 5f79 7329 0a20 2020 2020 2020 2020  on_ys).         
+000101a0: 2020 2020 2020 2020 2020 2079 732e 6170             ys.ap
+000101b0: 7065 6e64 2873 656c 662e 6163 7469 6f6e  pend(self.action
+000101c0: 5f79 735b 6163 7469 6f6e 5d29 0a20 2020  _ys[action]).   
+000101d0: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+000101e0: 6f72 732e 6170 7065 6e64 2863 6f6c 6f72  ors.append(color
+000101f0: 5f6f 6628 6163 7469 6f6e 2929 0a20 2020  _of(action)).   
+00010200: 2020 2020 2020 2020 2020 2020 2068 6f76               hov
+00010210: 6572 732e 6170 7065 6e64 2822 544f 444f  ers.append("TODO
+00010220: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+00010230: 6e65 7720 3d20 7b0a 2020 2020 2020 2020  new = {.        
+00010240: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
+00010250: 7469 6d65 732c 0a20 2020 2020 2020 2020  times,.         
+00010260: 2020 2020 2020 2022 6163 7469 6f6e 223a         "action":
+00010270: 2061 6374 696f 6e73 2c0a 2020 2020 2020   actions,.      
+00010280: 2020 2020 2020 2020 2020 2268 6f76 6572            "hover
+00010290: 223a 2068 6f76 6572 732c 0a20 2020 2020  ": hovers,.     
+000102a0: 2020 2020 2020 2020 2020 2022 7922 3a20             "y": 
+000102b0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+000102c0: 2020 2020 2263 6f6c 6f72 223a 2063 6f6c      "color": col
+000102d0: 6f72 732c 0a20 2020 2020 2020 2020 2020  ors,.           
+000102e0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+000102f0: 6966 2050 524f 4649 4c49 4e47 3a0a 2020  if PROFILING:.  
+00010300: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00010310: 7264 6f63 2829 2e61 6464 5f6e 6578 745f  rdoc().add_next_
+00010320: 7469 636b 5f63 616c 6c62 6163 6b28 6c61  tick_callback(la
+00010330: 6d62 6461 3a20 7365 6c66 2e73 6f75 7263  mbda: self.sourc
+00010340: 652e 7374 7265 616d 286e 6577 2c20 3130  e.stream(new, 10
+00010350: 3030 3029 290a 2020 2020 2020 2020 2020  000)).          
+00010360: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00010370: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00010380: 7263 652e 7374 7265 616d 286e 6577 2c20  rce.stream(new, 
+00010390: 3130 3030 3029 0a0a 0a63 6c61 7373 2054  10000)...class T
+000103a0: 6173 6b53 7472 6561 6d28 4461 7368 626f  askStream(Dashbo
+000103b0: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+000103c0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000103d0: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
+000103e0: 206e 5f72 6563 7461 6e67 6c65 733d 3130   n_rectangles=10
+000103f0: 3030 2c20 636c 6561 725f 696e 7465 7276  00, clear_interv
+00010400: 616c 3d22 3230 7322 2c20 2a2a 6b77 6172  al="20s", **kwar
+00010410: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
+00010420: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
+00010430: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+00010440: 7365 6c66 2e6f 6666 7365 7420 3d20 300a  self.offset = 0.
+00010450: 0a20 2020 2020 2020 2069 6620 5461 736b  .        if Task
+00010460: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+00010470: 6520 6e6f 7420 696e 2073 656c 662e 7363  e not in self.sc
+00010480: 6865 6475 6c65 722e 706c 7567 696e 733a  heduler.plugins:
+00010490: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000104a0: 662e 7363 6865 6475 6c65 722e 6164 645f  f.scheduler.add_
+000104b0: 706c 7567 696e 2854 6173 6b53 7472 6561  plugin(TaskStrea
+000104c0: 6d50 6c75 6769 6e28 7365 6c66 2e73 6368  mPlugin(self.sch
+000104d0: 6564 756c 6572 2929 0a20 2020 2020 2020  eduler)).       
+000104e0: 2073 656c 662e 706c 7567 696e 203d 2073   self.plugin = s
+000104f0: 656c 662e 7363 6865 6475 6c65 722e 706c  elf.scheduler.pl
+00010500: 7567 696e 735b 5461 736b 5374 7265 616d  ugins[TaskStream
+00010510: 506c 7567 696e 2e6e 616d 655d 0a0a 2020  Plugin.name]..  
+00010520: 2020 2020 2020 7365 6c66 2e69 6e64 6578        self.index
+00010530: 203d 206d 6178 2830 2c20 7365 6c66 2e70   = max(0, self.p
+00010540: 6c75 6769 6e2e 696e 6465 7820 2d20 6e5f  lugin.index - n_
+00010550: 7265 6374 616e 676c 6573 290a 2020 2020  rectangles).    
+00010560: 2020 2020 7365 6c66 2e77 6f72 6b65 7273      self.workers
+00010570: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+00010580: 2020 7365 6c66 2e6e 5f72 6563 7461 6e67    self.n_rectang
+00010590: 6c65 7320 3d20 6e5f 7265 6374 616e 676c  les = n_rectangl
+000105a0: 6573 0a20 2020 2020 2020 2063 6c65 6172  es.        clear
+000105b0: 5f69 6e74 6572 7661 6c20 3d20 7061 7273  _interval = pars
+000105c0: 655f 7469 6d65 6465 6c74 6128 636c 6561  e_timedelta(clea
+000105d0: 725f 696e 7465 7276 616c 2c20 6465 6661  r_interval, defa
+000105e0: 756c 743d 226d 7322 290a 2020 2020 2020  ult="ms").      
+000105f0: 2020 7365 6c66 2e63 6c65 6172 5f69 6e74    self.clear_int
+00010600: 6572 7661 6c20 3d20 636c 6561 725f 696e  erval = clear_in
+00010610: 7465 7276 616c 0a20 2020 2020 2020 2073  terval.        s
+00010620: 656c 662e 6c61 7374 203d 2030 0a20 2020  elf.last = 0.   
+00010630: 2020 2020 2073 656c 662e 6c61 7374 5f73       self.last_s
+00010640: 6565 6e20 3d20 300a 0a20 2020 2020 2020  een = 0..       
+00010650: 2073 656c 662e 736f 7572 6365 2c20 7365   self.source, se
+00010660: 6c66 2e72 6f6f 7420 3d20 7461 736b 5f73  lf.root = task_s
+00010670: 7472 6561 6d5f 6669 6775 7265 2863 6c65  tream_figure(cle
+00010680: 6172 5f69 6e74 6572 7661 6c2c 202a 2a6b  ar_interval, **k
+00010690: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
+000106a0: 2320 5265 7175 6972 6564 2066 6f72 2075  # Required for u
+000106b0: 7064 6174 6520 6361 6c6c 6261 636b 0a20  pdate callback. 
+000106c0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+000106d0: 5f73 7472 6561 6d5f 696e 6465 7820 3d20  _stream_index = 
+000106e0: 5b30 5d0a 0a20 2020 2040 7769 7468 6f75  [0]..    @withou
+000106f0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
+00010700: 6174 696f 6e0a 2020 2020 406c 6f67 5f65  ation.    @log_e
+00010710: 7272 6f72 730a 2020 2020 6465 6620 7570  rrors.    def up
+00010720: 6461 7465 2873 656c 6629 3a0a 2020 2020  date(self):.    
+00010730: 2020 2020 6966 2073 656c 662e 696e 6465      if self.inde
+00010740: 7820 3d3d 2073 656c 662e 706c 7567 696e  x == self.plugin
+00010750: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
+00010760: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00010770: 2020 2020 6966 2073 656c 662e 696e 6465      if self.inde
+00010780: 7820 616e 6420 6c65 6e28 7365 6c66 2e73  x and len(self.s
+00010790: 6f75 7263 652e 6461 7461 5b22 7374 6172  ource.data["star
+000107a0: 7422 5d29 3a0a 2020 2020 2020 2020 2020  t"]):.          
+000107b0: 2020 7374 6172 7420 3d20 6d69 6e28 7365    start = min(se
+000107c0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
+000107d0: 7374 6172 7422 5d29 0a20 2020 2020 2020  start"]).       
+000107e0: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+000107f0: 6d61 7828 7365 6c66 2e73 6f75 7263 652e  max(self.source.
+00010800: 6461 7461 5b22 6475 7261 7469 6f6e 225d  data["duration"]
+00010810: 290a 2020 2020 2020 2020 2020 2020 626f  ).            bo
+00010820: 756e 6461 7279 203d 2028 7365 6c66 2e6f  undary = (self.o
+00010830: 6666 7365 7420 2b20 7374 6172 7420 2d20  ffset + start - 
+00010840: 6475 7261 7469 6f6e 2920 2f20 3130 3030  duration) / 1000
+00010850: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00010860: 2020 2020 2020 2020 2020 2062 6f75 6e64             bound
+00010870: 6172 7920 3d20 7365 6c66 2e6f 6666 7365  ary = self.offse
+00010880: 740a 2020 2020 2020 2020 7265 6374 616e  t.        rectan
+00010890: 676c 6573 203d 2073 656c 662e 706c 7567  gles = self.plug
+000108a0: 696e 2e72 6563 7461 6e67 6c65 7328 0a20  in.rectangles(. 
+000108b0: 2020 2020 2020 2020 2020 2069 7374 6172             istar
+000108c0: 743d 7365 6c66 2e69 6e64 6578 2c20 776f  t=self.index, wo
+000108d0: 726b 6572 733d 7365 6c66 2e77 6f72 6b65  rkers=self.worke
+000108e0: 7273 2c20 7374 6172 745f 626f 756e 6461  rs, start_bounda
+000108f0: 7279 3d62 6f75 6e64 6172 790a 2020 2020  ry=boundary.    
+00010900: 2020 2020 290a 2020 2020 2020 2020 6e20      ).        n 
+00010910: 3d20 6c65 6e28 7265 6374 616e 676c 6573  = len(rectangles
+00010920: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
+00010930: 2020 7365 6c66 2e69 6e64 6578 203d 2073    self.index = s
+00010940: 656c 662e 706c 7567 696e 2e69 6e64 6578  elf.plugin.index
+00010950: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00010960: 2072 6563 7461 6e67 6c65 735b 2273 7461   rectangles["sta
+00010970: 7274 225d 3a0a 2020 2020 2020 2020 2020  rt"]:.          
+00010980: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00010990: 2020 2320 4966 2069 7420 6861 7320 6265    # If it has be
+000109a0: 656e 2061 2077 6869 6c65 2073 696e 6365  en a while since
+000109b0: 2077 6527 7665 2075 7064 6174 6564 2074   we've updated t
+000109c0: 6865 2070 6c6f 740a 2020 2020 2020 2020  he plot.        
+000109d0: 6966 2074 696d 6528 2920 3e20 7365 6c66  if time() > self
+000109e0: 2e6c 6173 745f 7365 656e 202b 2073 656c  .last_seen + sel
+000109f0: 662e 636c 6561 725f 696e 7465 7276 616c  f.clear_interval
+00010a00: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+00010a10: 775f 7374 6172 7420 3d20 6d69 6e28 7265  w_start = min(re
+00010a20: 6374 616e 676c 6573 5b22 7374 6172 7422  ctangles["start"
+00010a30: 5d29 202d 2073 656c 662e 6f66 6673 6574  ]) - self.offset
+00010a40: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
+00010a50: 5f73 7461 7274 203d 206d 696e 2873 656c  _start = min(sel
+00010a60: 662e 736f 7572 6365 2e64 6174 615b 2273  f.source.data["s
+00010a70: 7461 7274 225d 290a 2020 2020 2020 2020  tart"]).        
+00010a80: 2020 2020 6f6c 645f 656e 6420 3d20 6d61      old_end = ma
+00010a90: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
+00010aa0: 2020 206d 6170 280a 2020 2020 2020 2020     map(.        
+00010ab0: 2020 2020 2020 2020 2020 2020 6f70 6572              oper
+00010ac0: 6174 6f72 2e61 6464 2c0a 2020 2020 2020  ator.add,.      
+00010ad0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00010ae0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
+00010af0: 7374 6172 7422 5d2c 0a20 2020 2020 2020  start"],.       
+00010b00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010b10: 662e 736f 7572 6365 2e64 6174 615b 2264  f.source.data["d
+00010b20: 7572 6174 696f 6e22 5d2c 0a20 2020 2020  uration"],.     
+00010b30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00010b40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00010b50: 2020 2020 2020 2020 6465 6e73 6974 7920          density 
+00010b60: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00010b70: 2020 2020 7375 6d28 7365 6c66 2e73 6f75      sum(self.sou
+00010b80: 7263 652e 6461 7461 5b22 6475 7261 7469  rce.data["durati
+00010b90: 6f6e 225d 290a 2020 2020 2020 2020 2020  on"]).          
+00010ba0: 2020 2020 2020 2f20 6c65 6e28 7365 6c66        / len(self
+00010bb0: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
+00010bc0: 2020 2020 2020 2020 2020 2f20 286f 6c64            / (old
+00010bd0: 5f65 6e64 202d 206f 6c64 5f73 7461 7274  _end - old_start
+00010be0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+00010bf0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00010c00: 6620 7768 6974 6573 7061 6365 2069 7320  f whitespace is 
+00010c10: 6d6f 7265 2074 6861 6e20 3378 2074 6865  more than 3x the
+00010c20: 206f 6c64 2077 6964 7468 0a20 2020 2020   old width.     
+00010c30: 2020 2020 2020 2069 6620 286e 6577 5f73         if (new_s
+00010c40: 7461 7274 202d 206f 6c64 5f65 6e64 2920  tart - old_end) 
+00010c50: 3e20 286f 6c64 5f65 6e64 202d 206f 6c64  > (old_end - old
+00010c60: 5f73 7461 7274 2920 2a20 3220 6f72 2064  _start) * 2 or d
+00010c70: 656e 7369 7479 203c 2030 2e30 353a 0a20  ensity < 0.05:. 
+00010c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010c90: 656c 662e 736f 7572 6365 2e64 6174 612e  elf.source.data.
+00010ca0: 7570 6461 7465 287b 6b3a 205b 5d20 666f  update({k: [] fo
+00010cb0: 7220 6b20 696e 2072 6563 7461 6e67 6c65  r k in rectangle
+00010cc0: 737d 2920 2023 2063 6c65 6172 0a20 2020  s})  # clear.   
+00010cd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010ce0: 662e 6f66 6673 6574 203d 206d 696e 2872  f.offset = min(r
+00010cf0: 6563 7461 6e67 6c65 735b 2273 7461 7274  ectangles["start
+00010d00: 225d 2920 2023 2072 6564 6566 696e 6520  "])  # redefine 
+00010d10: 6f66 6673 6574 0a0a 2020 2020 2020 2020  offset..        
+00010d20: 7265 6374 616e 676c 6573 5b22 7374 6172  rectangles["star
+00010d30: 7422 5d20 3d20 5b78 202d 2073 656c 662e  t"] = [x - self.
+00010d40: 6f66 6673 6574 2066 6f72 2078 2069 6e20  offset for x in 
+00010d50: 7265 6374 616e 676c 6573 5b22 7374 6172  rectangles["star
+00010d60: 7422 5d5d 0a20 2020 2020 2020 2073 656c  t"]].        sel
+00010d70: 662e 6c61 7374 5f73 6565 6e20 3d20 7469  f.last_seen = ti
+00010d80: 6d65 2829 0a0a 2020 2020 2020 2020 2320  me()..        # 
+00010d90: 436f 6e76 6572 7420 746f 206e 756d 7079  Convert to numpy
+00010da0: 2066 6f72 2073 6572 6961 6c69 7a61 7469   for serializati
+00010db0: 6f6e 2073 7065 6564 0a20 2020 2020 2020  on speed.       
+00010dc0: 2069 6620 6e20 3e3d 2031 3020 616e 6420   if n >= 10 and 
+00010dd0: 6e70 3a0a 2020 2020 2020 2020 2020 2020  np:.            
+00010de0: 666f 7220 6b2c 2076 2069 6e20 7265 6374  for k, v in rect
+00010df0: 616e 676c 6573 2e69 7465 6d73 2829 3a0a  angles.items():.
+00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e10: 6966 2069 7369 6e73 7461 6e63 6528 765b  if isinstance(v[
+00010e20: 305d 2c20 4e75 6d62 6572 293a 0a20 2020  0], Number):.   
+00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e40: 2072 6563 7461 6e67 6c65 735b 6b5d 203d   rectangles[k] =
+00010e50: 206e 702e 6172 7261 7928 7629 0a0a 2020   np.array(v)..  
+00010e60: 2020 2020 2020 6966 2050 524f 4649 4c49        if PROFILI
+00010e70: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
+00010e80: 6375 7264 6f63 2829 2e61 6464 5f6e 6578  curdoc().add_nex
+00010e90: 745f 7469 636b 5f63 616c 6c62 6163 6b28  t_tick_callback(
+00010ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010eb0: 206c 616d 6264 613a 2073 656c 662e 736f   lambda: self.so
+00010ec0: 7572 6365 2e73 7472 6561 6d28 7265 6374  urce.stream(rect
+00010ed0: 616e 676c 6573 2c20 7365 6c66 2e6e 5f72  angles, self.n_r
+00010ee0: 6563 7461 6e67 6c65 7329 0a20 2020 2020  ectangles).     
+00010ef0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010f00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00010f10: 2020 2073 656c 662e 736f 7572 6365 2e73     self.source.s
+00010f20: 7472 6561 6d28 7265 6374 616e 676c 6573  tream(rectangles
+00010f30: 2c20 7365 6c66 2e6e 5f72 6563 7461 6e67  , self.n_rectang
+00010f40: 6c65 7329 0a0a 0a64 6566 2074 6173 6b5f  les)...def task_
+00010f50: 7374 7265 616d 5f66 6967 7572 6528 636c  stream_figure(cl
+00010f60: 6561 725f 696e 7465 7276 616c 3d22 3230  ear_interval="20
+00010f70: 7322 2c20 2a2a 6b77 6172 6773 293a 0a20  s", **kwargs):. 
+00010f80: 2020 2022 2222 0a20 2020 206b 7761 7267     """.    kwarg
+00010f90: 7320 6172 6520 6170 706c 6965 6420 746f  s are applied to
+00010fa0: 2074 6865 2062 6f6b 6568 2e6d 6f64 656c   the bokeh.model
+00010fb0: 732e 706c 6f74 732e 506c 6f74 2063 6f6e  s.plots.Plot con
+00010fc0: 7374 7275 6374 6f72 0a20 2020 2022 2222  structor.    """
+00010fd0: 0a20 2020 2063 6c65 6172 5f69 6e74 6572  .    clear_inter
+00010fe0: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
+00010ff0: 6465 6c74 6128 636c 6561 725f 696e 7465  delta(clear_inte
+00011000: 7276 616c 2c20 6465 6661 756c 743d 226d  rval, default="m
+00011010: 7322 290a 0a20 2020 2073 6f75 7263 6520  s")..    source 
+00011020: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
+00011030: 6365 280a 2020 2020 2020 2020 6461 7461  ce(.        data
+00011040: 3d64 6963 7428 0a20 2020 2020 2020 2020  =dict(.         
+00011050: 2020 2073 7461 7274 3d5b 7469 6d65 2829     start=[time()
+00011060: 202d 2063 6c65 6172 5f69 6e74 6572 7661   - clear_interva
+00011070: 6c5d 2c0a 2020 2020 2020 2020 2020 2020  l],.            
+00011080: 6475 7261 7469 6f6e 3d5b 302e 315d 2c0a  duration=[0.1],.
+00011090: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
+000110a0: 5b22 7374 6172 7422 5d2c 0a20 2020 2020  ["start"],.     
+000110b0: 2020 2020 2020 206e 616d 653d 5b22 7374         name=["st
+000110c0: 6172 7422 5d2c 0a20 2020 2020 2020 2020  art"],.         
+000110d0: 2020 2063 6f6c 6f72 3d5b 2277 6869 7465     color=["white
+000110e0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+000110f0: 6475 7261 7469 6f6e 5f74 6578 743d 5b22  duration_text=["
+00011100: 3130 3020 6d73 225d 2c0a 2020 2020 2020  100 ms"],.      
+00011110: 2020 2020 2020 776f 726b 6572 3d5b 2266        worker=["f
+00011120: 6f6f 225d 2c0a 2020 2020 2020 2020 2020  oo"],.          
+00011130: 2020 793d 5b30 5d2c 0a20 2020 2020 2020    y=[0],.       
+00011140: 2020 2020 2077 6f72 6b65 725f 7468 7265       worker_thre
+00011150: 6164 3d5b 315d 2c0a 2020 2020 2020 2020  ad=[1],.        
+00011160: 2020 2020 616c 7068 613d 5b30 2e30 5d2c      alpha=[0.0],
+00011170: 0a20 2020 2020 2020 2029 0a20 2020 2029  .        ).    )
+00011180: 0a0a 2020 2020 785f 7261 6e67 6520 3d20  ..    x_range = 
+00011190: 4461 7461 5261 6e67 6531 6428 7261 6e67  DataRange1d(rang
+000111a0: 655f 7061 6464 696e 673d 3029 0a20 2020  e_padding=0).   
+000111b0: 2079 5f72 616e 6765 203d 2044 6174 6152   y_range = DataR
+000111c0: 616e 6765 3164 2872 616e 6765 5f70 6164  ange1d(range_pad
+000111d0: 6469 6e67 3d30 290a 0a20 2020 2072 6f6f  ding=0)..    roo
+000111e0: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+000111f0: 2020 2020 6e61 6d65 3d22 7461 736b 5f73      name="task_s
+00011200: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
+00011210: 7469 746c 653d 2254 6173 6b20 5374 7265  title="Task Stre
+00011220: 616d 222c 0a20 2020 2020 2020 2078 5f72  am",.        x_r
+00011230: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
+00011240: 2020 2020 2020 795f 7261 6e67 653d 795f        y_range=y_
+00011250: 7261 6e67 652c 0a20 2020 2020 2020 2074  range,.        t
+00011260: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e3d  oolbar_location=
+00011270: 2261 626f 7665 222c 0a20 2020 2020 2020  "above",.       
+00011280: 2078 5f61 7869 735f 7479 7065 3d22 6461   x_axis_type="da
+00011290: 7465 7469 6d65 222c 0a20 2020 2020 2020  tetime",.       
+000112a0: 2079 5f61 7869 735f 6c6f 6361 7469 6f6e   y_axis_location
+000112b0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2074  =None,.        t
+000112c0: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
+000112d0: 206d 696e 5f62 6f72 6465 725f 626f 7474   min_border_bott
+000112e0: 6f6d 3d35 302c 0a20 2020 2020 2020 202a  om=50,.        *
+000112f0: 2a6b 7761 7267 732c 0a20 2020 2029 0a0a  *kwargs,.    )..
+00011300: 2020 2020 7265 6374 203d 2072 6f6f 742e      rect = root.
+00011310: 7265 6374 280a 2020 2020 2020 2020 736f  rect(.        so
+00011320: 7572 6365 3d73 6f75 7263 652c 0a20 2020  urce=source,.   
+00011330: 2020 2020 2078 3d22 7374 6172 7422 2c0a       x="start",.
+00011340: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
+00011350: 2020 2020 2020 2077 6964 7468 3d22 6475         width="du
+00011360: 7261 7469 6f6e 222c 0a20 2020 2020 2020  ration",.       
+00011370: 2068 6569 6768 743d 302e 342c 0a20 2020   height=0.4,.   
+00011380: 2020 2020 2066 696c 6c5f 636f 6c6f 723d       fill_color=
+00011390: 2263 6f6c 6f72 222c 0a20 2020 2020 2020  "color",.       
+000113a0: 206c 696e 655f 636f 6c6f 723d 2263 6f6c   line_color="col
+000113b0: 6f72 222c 0a20 2020 2020 2020 206c 696e  or",.        lin
+000113c0: 655f 616c 7068 613d 302e 362c 0a20 2020  e_alpha=0.6,.   
+000113d0: 2020 2020 2066 696c 6c5f 616c 7068 613d       fill_alpha=
+000113e0: 2261 6c70 6861 222c 0a20 2020 2020 2020  "alpha",.       
+000113f0: 206c 696e 655f 7769 6474 683d 332c 0a20   line_width=3,. 
+00011400: 2020 2029 0a20 2020 2072 6563 742e 6e6f     ).    rect.no
+00011410: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
+00011420: 203d 204e 6f6e 650a 0a20 2020 2072 6f6f   = None..    roo
+00011430: 742e 7961 7869 732e 6d61 6a6f 725f 6c61  t.yaxis.major_la
+00011440: 6265 6c5f 7465 7874 5f61 6c70 6861 203d  bel_text_alpha =
+00011450: 2030 0a20 2020 2072 6f6f 742e 7961 7869   0.    root.yaxi
+00011460: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
+00011470: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+00011480: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
+00011490: 5f74 6963 6b5f 6c69 6e65 5f61 6c70 6861  _tick_line_alpha
+000114a0: 203d 2030 0a20 2020 2072 6f6f 742e 7867   = 0.    root.xg
+000114b0: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
+000114c0: 6c73 650a 0a20 2020 2068 6f76 6572 203d  lse..    hover =
+000114d0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+000114e0: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
+000114f0: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
+00011500: 0a20 2020 2020 2020 2074 6f6f 6c74 6970  .        tooltip
+00011510: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
+00011520: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+00011530: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00011540: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+00011550: 3132 7078 3b20 666f 6e74 2d77 6569 6768  12px; font-weigh
+00011560: 743a 2062 6f6c 643b 223e 406e 616d 653a  t: bold;">@name:
+00011570: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00011580: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00011590: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+000115a0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+000115b0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+000115c0: 206d 6f6e 6f73 7061 6365 3b22 3e40 6475   monospace;">@du
+000115d0: 7261 7469 6f6e 5f74 6578 743c 2f73 7061  ration_text</spa
+000115e0: 6e3e 0a20 2020 2020 2020 2020 2020 203c  n>.            <
+000115f0: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00011600: 2020 2222 222c 0a20 2020 2029 0a0a 2020    """,.    )..  
+00011610: 2020 7461 7020 3d20 5461 7054 6f6f 6c28    tap = TapTool(
+00011620: 6361 6c6c 6261 636b 3d4f 7065 6e55 524c  callback=OpenURL
+00011630: 2875 726c 3d22 2e2f 7072 6f66 696c 653f  (url="./profile?
+00011640: 6b65 793d 406e 616d 6522 2929 0a20 2020  key=@name")).   
+00011650: 2068 656c 705f 203d 2048 656c 7054 6f6f   help_ = HelpToo
+00011660: 6c28 0a20 2020 2020 2020 2072 6564 6972  l(.        redir
+00011670: 6563 743d 2268 7474 7073 3a2f 2f64 6f63  ect="https://doc
+00011680: 732e 6461 736b 2e6f 7267 2f65 6e2f 7374  s.dask.org/en/st
+00011690: 6162 6c65 2f64 6173 6862 6f61 7264 2e68  able/dashboard.h
+000116a0: 746d 6c23 7461 736b 2d73 7472 6561 6d22  tml#task-stream"
+000116b0: 2c0a 2020 2020 2020 2020 6465 7363 7269  ,.        descri
+000116c0: 7074 696f 6e3d 2241 2064 6573 6372 6970  ption="A descrip
+000116d0: 7469 6f6e 206f 6620 7468 6520 5461 736b  tion of the Task
+000116e0: 5374 7265 616d 2061 6e64 2069 7473 2063  Stream and its c
+000116f0: 6f6c 6f72 2070 616c 6574 7465 2e22 2c0a  olor palette.",.
+00011700: 2020 2020 290a 2020 2020 726f 6f74 2e61      ).    root.a
+00011710: 6464 5f74 6f6f 6c73 280a 2020 2020 2020  dd_tools(.      
+00011720: 2020 686f 7665 722c 0a20 2020 2020 2020    hover,.       
+00011730: 2074 6170 2c0a 2020 2020 2020 2020 426f   tap,.        Bo
+00011740: 785a 6f6f 6d54 6f6f 6c28 292c 0a20 2020  xZoomTool(),.   
+00011750: 2020 2020 2052 6573 6574 546f 6f6c 2829       ResetTool()
+00011760: 2c0a 2020 2020 2020 2020 5061 6e54 6f6f  ,.        PanToo
+00011770: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
+00011780: 6474 6822 292c 0a20 2020 2020 2020 2057  dth"),.        W
+00011790: 6865 656c 5a6f 6f6d 546f 6f6c 2864 696d  heelZoomTool(dim
+000117a0: 656e 7369 6f6e 733d 2277 6964 7468 2229  ensions="width")
+000117b0: 2c0a 2020 2020 2020 2020 6865 6c70 5f2c  ,.        help_,
+000117c0: 0a20 2020 2029 0a20 2020 2069 6620 4578  .    ).    if Ex
+000117d0: 706f 7274 546f 6f6c 3a20 2023 2074 7970  portTool:  # typ
+000117e0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+000117f0: 2020 6578 706f 7274 203d 2045 7870 6f72    export = Expor
+00011800: 7454 6f6f 6c28 290a 2020 2020 2020 2020  tTool().        
+00011810: 6578 706f 7274 2e72 6567 6973 7465 725f  export.register_
+00011820: 706c 6f74 2872 6f6f 7429 0a20 2020 2020  plot(root).     
+00011830: 2020 2072 6f6f 742e 6164 645f 746f 6f6c     root.add_tool
+00011840: 7328 6578 706f 7274 290a 0a20 2020 2072  s(export)..    r
+00011850: 6574 7572 6e20 736f 7572 6365 2c20 726f  eturn source, ro
+00011860: 6f74 0a0a 0a63 6c61 7373 2054 6173 6b47  ot...class TaskG
+00011870: 7261 7068 2844 6173 6862 6f61 7264 436f  raph(DashboardCo
+00011880: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
+00011890: 220a 2020 2020 4120 6479 6e61 6d69 6320  ".    A dynamic 
+000118a0: 6e6f 6465 2d6c 696e 6b20 6469 6167 7261  node-link diagra
+000118b0: 6d20 666f 7220 7468 6520 7461 736b 2067  m for the task g
+000118c0: 7261 7068 206f 6e20 7468 6520 7363 6865  raph on the sche
+000118d0: 6475 6c65 720a 0a20 2020 2053 6565 2061  duler..    See a
+000118e0: 6c73 6f20 7468 6520 4772 6170 684c 6179  lso the GraphLay
+000118f0: 6f75 7420 6469 6167 6e6f 7374 6963 2061  out diagnostic a
+00011900: 740a 2020 2020 6469 7374 7269 6275 7465  t.    distribute
+00011910: 642f 6469 6167 6e6f 7374 6963 732f 6772  d/diagnostics/gr
+00011920: 6170 685f 6c61 796f 7574 2e70 790a 2020  aph_layout.py.  
+00011930: 2020 2222 220a 0a20 2020 2064 6566 205f    """..    def _
+00011940: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+00011950: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+00011960: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00011970: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+00011980: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+00011990: 656c 662e 6c61 796f 7574 203d 2047 7261  elf.layout = Gra
+000119a0: 7068 4c61 796f 7574 2873 6368 6564 756c  phLayout(schedul
+000119b0: 6572 290a 2020 2020 2020 2020 7363 6865  er).        sche
+000119c0: 6475 6c65 722e 6164 645f 706c 7567 696e  duler.add_plugin
+000119d0: 2873 656c 662e 6c61 796f 7574 290a 2020  (self.layout).  
+000119e0: 2020 2020 2020 7365 6c66 2e69 6e76 6973        self.invis
+000119f0: 6962 6c65 5f63 6f75 6e74 203d 2030 2020  ible_count = 0  
+00011a00: 2320 6e75 6d62 6572 206f 6620 696e 7669  # number of invi
+00011a10: 7369 626c 6520 6e6f 6465 730a 0a20 2020  sible nodes..   
+00011a20: 2020 2020 2073 656c 662e 6e6f 6465 5f73       self.node_s
+00011a30: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00011a40: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+00011a50: 2020 2020 2020 7b22 7822 3a20 5b5d 2c20        {"x": [], 
+00011a60: 2279 223a 205b 5d2c 2022 6e61 6d65 223a  "y": [], "name":
+00011a70: 205b 5d2c 2022 7374 6174 6522 3a20 5b5d   [], "state": []
+00011a80: 2c20 2276 6973 6962 6c65 223a 205b 5d2c  , "visible": [],
+00011a90: 2022 6b65 7922 3a20 5b5d 7d0a 2020 2020   "key": []}.    
+00011aa0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00011ab0: 6c66 2e65 6467 655f 736f 7572 6365 203d  lf.edge_source =
+00011ac0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+00011ad0: 6528 7b22 7822 3a20 5b5d 2c20 2279 223a  e({"x": [], "y":
+00011ae0: 205b 5d2c 2022 7669 7369 626c 6522 3a20   [], "visible": 
+00011af0: 5b5d 7d29 0a0a 2020 2020 2020 2020 6669  []})..        fi
+00011b00: 6c74 6572 203d 2047 726f 7570 4669 6c74  lter = GroupFilt
+00011b10: 6572 2863 6f6c 756d 6e5f 6e61 6d65 3d22  er(column_name="
+00011b20: 7669 7369 626c 6522 2c20 6772 6f75 703d  visible", group=
+00011b30: 2254 7275 6522 290a 2020 2020 2020 2020  "True").        
+00011b40: 6966 2042 4f4b 4548 5f56 4552 5349 4f4e  if BOKEH_VERSION
+00011b50: 2e6d 616a 6f72 203c 2033 3a0a 2020 2020  .major < 3:.    
+00011b60: 2020 2020 2020 2020 6669 6c74 6572 5f6b          filter_k
+00011b70: 7761 7267 7320 3d20 7b22 6669 6c74 6572  wargs = {"filter
+00011b80: 7322 3a20 5b66 696c 7465 725d 7d0a 2020  s": [filter]}.  
+00011b90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011ba0: 2020 2020 2020 2020 6669 6c74 6572 5f6b          filter_k
+00011bb0: 7761 7267 7320 3d20 7b22 6669 6c74 6572  wargs = {"filter
+00011bc0: 223a 2066 696c 7465 727d 0a20 2020 2020  ": filter}.     
+00011bd0: 2020 206e 6f64 655f 7669 6577 203d 2043     node_view = C
+00011be0: 4453 5669 6577 282a 2a66 696c 7465 725f  DSView(**filter_
+00011bf0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00011c00: 6564 6765 5f76 6965 7720 3d20 4344 5356  edge_view = CDSV
+00011c10: 6965 7728 2a2a 6669 6c74 6572 5f6b 7761  iew(**filter_kwa
+00011c20: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
+00011c30: 426f 6b65 6820 3e3d 2033 2e30 2061 7574  Bokeh >= 3.0 aut
+00011c40: 6f6d 6174 6963 616c 6c79 2069 6e66 6572  omatically infer
+00011c50: 7320 7468 6520 736f 7572 6365 2074 6f20  s the source to 
+00011c60: 7573 650a 2020 2020 2020 2020 6966 2042  use.        if B
+00011c70: 4f4b 4548 5f56 4552 5349 4f4e 2e6d 616a  OKEH_VERSION.maj
+00011c80: 6f72 203c 2033 3a0a 2020 2020 2020 2020  or < 3:.        
+00011c90: 2020 2020 6e6f 6465 5f76 6965 772e 736f      node_view.so
+00011ca0: 7572 6365 203d 2073 656c 662e 6e6f 6465  urce = self.node
+00011cb0: 5f73 6f75 7263 650a 2020 2020 2020 2020  _source.        
+00011cc0: 2020 2020 6564 6765 5f76 6965 772e 736f      edge_view.so
+00011cd0: 7572 6365 203d 2073 656c 662e 6564 6765  urce = self.edge
+00011ce0: 5f73 6f75 7263 650a 0a20 2020 2020 2020  _source..       
+00011cf0: 206e 6f64 655f 636f 6c6f 7273 203d 2066   node_colors = f
+00011d00: 6163 746f 725f 636d 6170 280a 2020 2020  actor_cmap(.    
+00011d10: 2020 2020 2020 2020 2273 7461 7465 222c          "state",
+00011d20: 0a20 2020 2020 2020 2020 2020 2066 6163  .            fac
+00011d30: 746f 7273 3d5b 2277 6169 7469 6e67 222c  tors=["waiting",
+00011d40: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
+00011d50: 6573 7369 6e67 222c 2022 6d65 6d6f 7279  essing", "memory
+00011d60: 222c 2022 7265 6c65 6173 6564 222c 2022  ", "released", "
+00011d70: 6572 7265 6422 5d2c 0a20 2020 2020 2020  erred"],.       
+00011d80: 2020 2020 2070 616c 6574 7465 3d5b 2267       palette=["g
+00011d90: 7261 7922 2c20 2279 656c 6c6f 7722 2c20  ray", "yellow", 
+00011da0: 2267 7265 656e 222c 2022 7265 6422 2c20  "green", "red", 
+00011db0: 2262 6c75 6522 2c20 2262 6c61 636b 225d  "blue", "black"]
+00011dc0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00011dd0: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
+00011de0: 2066 6967 7572 6528 7469 746c 653d 2254   figure(title="T
+00011df0: 6173 6b20 4772 6170 6822 2c20 2a2a 6b77  ask Graph", **kw
+00011e00: 6172 6773 290a 2020 2020 2020 2020 7365  args).        se
+00011e10: 6c66 2e73 7562 7469 746c 6520 3d20 5469  lf.subtitle = Ti
+00011e20: 746c 6528 7465 7874 3d22 2022 2c20 7465  tle(text=" ", te
+00011e30: 7874 5f66 6f6e 745f 7374 796c 653d 2269  xt_font_style="i
+00011e40: 7461 6c69 6322 290a 2020 2020 2020 2020  talic").        
+00011e50: 7365 6c66 2e72 6f6f 742e 6164 645f 6c61  self.root.add_la
+00011e60: 796f 7574 2873 656c 662e 7375 6274 6974  yout(self.subtit
+00011e70: 6c65 2c20 2261 626f 7665 2229 0a0a 2020  le, "above")..  
+00011e80: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00011e90: 6d75 6c74 695f 6c69 6e65 280a 2020 2020  multi_line(.    
+00011ea0: 2020 2020 2020 2020 7873 3d22 7822 2c0a          xs="x",.
+00011eb0: 2020 2020 2020 2020 2020 2020 7973 3d22              ys="
+00011ec0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00011ed0: 736f 7572 6365 3d73 656c 662e 6564 6765  source=self.edge
+00011ee0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+00011ef0: 2020 2020 206c 696e 655f 7769 6474 683d       line_width=
+00011f00: 312c 0a20 2020 2020 2020 2020 2020 2076  1,.            v
+00011f10: 6965 773d 6564 6765 5f76 6965 772c 0a20  iew=edge_view,. 
+00011f20: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00011f30: 3d22 626c 6163 6b22 2c0a 2020 2020 2020  ="black",.      
+00011f40: 2020 2020 2020 616c 7068 613d 302e 332c        alpha=0.3,
+00011f50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00011f60: 2020 2072 6563 7420 3d20 7365 6c66 2e72     rect = self.r
+00011f70: 6f6f 742e 7371 7561 7265 280a 2020 2020  oot.square(.    
+00011f80: 2020 2020 2020 2020 783d 2278 222c 0a20          x="x",. 
+00011f90: 2020 2020 2020 2020 2020 2079 3d22 7922             y="y"
+00011fa0: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+00011fb0: 7a65 3d31 302c 0a20 2020 2020 2020 2020  ze=10,.         
+00011fc0: 2020 2063 6f6c 6f72 3d6e 6f64 655f 636f     color=node_co
+00011fd0: 6c6f 7273 2c0a 2020 2020 2020 2020 2020  lors,.          
+00011fe0: 2020 736f 7572 6365 3d73 656c 662e 6e6f    source=self.no
+00011ff0: 6465 5f73 6f75 7263 652c 0a20 2020 2020  de_source,.     
+00012000: 2020 2020 2020 2076 6965 773d 6e6f 6465         view=node
+00012010: 5f76 6965 772c 0a20 2020 2020 2020 2020  _view,.         
+00012020: 2020 206c 6567 656e 645f 6669 656c 643d     legend_field=
+00012030: 2273 7461 7465 222c 0a20 2020 2020 2020  "state",.       
+00012040: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00012050: 726f 6f74 2e78 6772 6964 2e67 7269 645f  root.xgrid.grid_
+00012060: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
+00012070: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
+00012080: 6f6f 742e 7967 7269 642e 6772 6964 5f6c  oot.ygrid.grid_l
+00012090: 696e 655f 636f 6c6f 7220 3d20 4e6f 6e65  ine_color = None
+000120a0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000120b0: 6f74 2e78 6178 6973 2e76 6973 6962 6c65  ot.xaxis.visible
+000120c0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000120d0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
+000120e0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+000120f0: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
+00012100: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
+00012110: 2020 2020 2020 2020 2070 6f69 6e74 5f70           point_p
+00012120: 6f6c 6963 793d 2266 6f6c 6c6f 775f 6d6f  olicy="follow_mo
+00012130: 7573 6522 2c0a 2020 2020 2020 2020 2020  use",.          
+00012140: 2020 746f 6f6c 7469 7073 3d22 3c62 3e40    tooltips="<b>@
+00012150: 6e61 6d65 3c2f 623e 3a20 4073 7461 7465  name</b>: @state
+00012160: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
+00012170: 656e 6465 7265 7273 3d5b 7265 6374 5d2c  enderers=[rect],
+00012180: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00012190: 2020 2074 6170 203d 2054 6170 546f 6f6c     tap = TapTool
+000121a0: 2863 616c 6c62 6163 6b3d 4f70 656e 5552  (callback=OpenUR
+000121b0: 4c28 7572 6c3d 2269 6e66 6f2f 7461 736b  L(url="info/task
+000121c0: 2f40 6b65 792e 6874 6d6c 2229 2c20 7265  /@key.html"), re
+000121d0: 6e64 6572 6572 733d 5b72 6563 745d 290a  nderers=[rect]).
+000121e0: 2020 2020 2020 2020 7265 6374 2e6e 6f6e          rect.non
+000121f0: 7365 6c65 6374 696f 6e5f 676c 7970 6820  selection_glyph 
+00012200: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+00012210: 656c 662e 726f 6f74 2e61 6464 5f74 6f6f  elf.root.add_too
+00012220: 6c73 2868 6f76 6572 2c20 7461 7029 0a20  ls(hover, tap). 
+00012230: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
+00012240: 6974 656d 7320 3d20 636f 6e66 6967 2e67  items = config.g
+00012250: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00012260: 6461 7368 626f 6172 642e 6772 6170 682d  dashboard.graph-
+00012270: 6d61 782d 6974 656d 7322 2c20 3530 3030  max-items", 5000
+00012280: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
+00012290: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+000122a0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+000122b0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+000122c0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+000122d0: 2020 2320 4966 2074 6865 7265 2061 7265    # If there are
+000122e0: 2074 6f6f 206d 616e 7920 7461 736b 7320   too many tasks 
+000122f0: 696e 2074 6865 2073 6368 6564 756c 6572  in the scheduler
+00012300: 2077 6527 6c6c 2064 6973 6162 6c65 2074   we'll disable t
+00012310: 6869 730a 2020 2020 2020 2020 2320 636f  his.        # co
+00012320: 6d70 6f6f 6e65 6e74 7320 746f 206e 6f74  mpoonents to not
+00012330: 206f 7665 726c 6f61 6420 7363 6865 6475   overload schedu
+00012340: 6c65 7220 6f72 2063 6c69 656e 742e 204f  ler or client. O
+00012350: 6e63 6520 7765 2064 726f 700a 2020 2020  nce we drop.    
+00012360: 2020 2020 2320 6265 6c6f 7720 7468 6520      # below the 
+00012370: 7468 7265 7368 6f6c 642c 2074 6865 2064  threshold, the d
+00012380: 6174 6120 6973 2066 696c 6c65 6420 7570  ata is filled up
+00012390: 2061 6761 696e 2061 7320 7573 7561 6c0a   again as usual.
+000123a0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+000123b0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+000123c0: 736b 7329 203e 2073 656c 662e 6d61 785f  sks) > self.max_
+000123d0: 6974 656d 733a 0a20 2020 2020 2020 2020  items:.         
+000123e0: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
+000123f0: 2e74 6578 7420 3d20 2253 6368 6564 756c  .text = "Schedul
+00012400: 6572 2068 6173 2074 6f6f 206d 616e 7920  er has too many 
+00012410: 7461 736b 7320 746f 2064 6973 706c 6179  tasks to display
+00012420: 2e22 0a20 2020 2020 2020 2020 2020 2066  .".            f
+00012430: 6f72 2063 6f6e 7461 696e 6572 2069 6e20  or container in 
+00012440: 5b73 656c 662e 6e6f 6465 5f73 6f75 7263  [self.node_sourc
+00012450: 652c 2073 656c 662e 6564 6765 5f73 6f75  e, self.edge_sou
+00012460: 7263 655d 3a0a 2020 2020 2020 2020 2020  rce]:.          
+00012470: 2020 2020 2020 636f 6e74 6169 6e65 722e        container.
+00012480: 6461 7461 203d 207b 636f 6c3a 205b 5d20  data = {col: [] 
+00012490: 666f 7220 636f 6c20 696e 2063 6f6e 7461  for col in conta
+000124a0: 696e 6572 2e63 6f6c 756d 6e5f 6e61 6d65  iner.column_name
+000124b0: 737d 0a20 2020 2020 2020 2065 6c73 653a  s}.        else:
+000124c0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+000124d0: 6363 6173 696f 6e61 6c6c 7920 7265 7365  ccasionally rese
+000124e0: 7420 7468 6520 636f 6c75 6d6e 2064 6174  t the column dat
+000124f0: 6120 736f 7572 6365 2074 6f20 7265 6d6f  a source to remo
+00012500: 7665 206f 6c64 206e 6f64 6573 0a20 2020  ve old nodes.   
+00012510: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00012520: 2e69 6e76 6973 6962 6c65 5f63 6f75 6e74  .invisible_count
+00012530: 203e 206c 656e 2873 656c 662e 6e6f 6465   > len(self.node
+00012540: 5f73 6f75 7263 652e 6461 7461 5b22 7822  _source.data["x"
+00012550: 5d29 202f 2032 3a0a 2020 2020 2020 2020  ]) / 2:.        
+00012560: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
+00012570: 6f75 742e 7265 7365 745f 696e 6465 7828  out.reset_index(
+00012580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012590: 2020 7365 6c66 2e69 6e76 6973 6962 6c65    self.invisible
+000125a0: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
+000125b0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
+000125c0: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
+000125d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000125e0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
+000125f0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+00012600: 2020 2020 2020 206e 6577 2c20 7365 6c66         new, self
+00012610: 2e6c 6179 6f75 742e 6e65 7720 3d20 7365  .layout.new = se
+00012620: 6c66 2e6c 6179 6f75 742e 6e65 772c 205b  lf.layout.new, [
+00012630: 5d0a 2020 2020 2020 2020 2020 2020 6e65  ].            ne
+00012640: 775f 6564 6765 7320 3d20 7365 6c66 2e6c  w_edges = self.l
+00012650: 6179 6f75 742e 6e65 775f 6564 6765 730a  ayout.new_edges.
+00012660: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012670: 2e6c 6179 6f75 742e 6e65 775f 6564 6765  .layout.new_edge
+00012680: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+00012690: 2020 2020 7365 6c66 2e61 6464 5f6e 6577      self.add_new
+000126a0: 5f6e 6f64 6573 5f65 6467 6573 286e 6577  _nodes_edges(new
+000126b0: 2c20 6e65 775f 6564 6765 732c 2075 7064  , new_edges, upd
+000126c0: 6174 653d 7570 6461 7465 290a 0a20 2020  ate=update)..   
+000126d0: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
+000126e0: 7463 685f 7570 6461 7465 7328 290a 0a20  tch_updates().. 
+000126f0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00012700: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
+00012710: 2e74 6173 6b73 2920 3d3d 2030 3a0a 2020  .tasks) == 0:.  
+00012720: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00012730: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
+00012740: 203d 2022 5363 6865 6475 6c65 7220 6973   = "Scheduler is
+00012750: 2065 6d70 7479 2e22 0a20 2020 2020 2020   empty.".       
+00012760: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00012780: 7375 6274 6974 6c65 2e74 6578 7420 3d20  subtitle.text = 
+00012790: 2220 220a 0a20 2020 2040 7769 7468 6f75  " "..    @withou
+000127a0: 745f 7072 6f70 6572 7479 5f76 616c 6964  t_property_valid
+000127b0: 6174 696f 6e0a 2020 2020 6465 6620 6164  ation.    def ad
+000127c0: 645f 6e65 775f 6e6f 6465 735f 6564 6765  d_new_nodes_edge
+000127d0: 7328 7365 6c66 2c20 6e65 772c 206e 6577  s(self, new, new
+000127e0: 5f65 6467 6573 2c20 7570 6461 7465 3d46  _edges, update=F
+000127f0: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
+00012800: 6620 6e65 7720 6f72 2075 7064 6174 653a  f new or update:
+00012810: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00012820: 655f 6b65 7920 3d20 5b5d 0a20 2020 2020  e_key = [].     
+00012830: 2020 2020 2020 206e 6f64 655f 7820 3d20         node_x = 
+00012840: 5b5d 0a20 2020 2020 2020 2020 2020 206e  [].            n
+00012850: 6f64 655f 7920 3d20 5b5d 0a20 2020 2020  ode_y = [].     
+00012860: 2020 2020 2020 206e 6f64 655f 7374 6174         node_stat
+00012870: 6520 3d20 5b5d 0a20 2020 2020 2020 2020  e = [].         
+00012880: 2020 206e 6f64 655f 6e61 6d65 203d 205b     node_name = [
+00012890: 5d0a 2020 2020 2020 2020 2020 2020 6564  ].            ed
+000128a0: 6765 5f78 203d 205b 5d0a 2020 2020 2020  ge_x = [].      
+000128b0: 2020 2020 2020 6564 6765 5f79 203d 205b        edge_y = [
+000128c0: 5d0a 0a20 2020 2020 2020 2020 2020 2078  ]..            x
+000128d0: 203d 2073 656c 662e 6c61 796f 7574 2e78   = self.layout.x
+000128e0: 0a20 2020 2020 2020 2020 2020 2079 203d  .            y =
+000128f0: 2073 656c 662e 6c61 796f 7574 2e79 0a0a   self.layout.y..
+00012900: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00012910: 7320 3d20 7365 6c66 2e73 6368 6564 756c  s = self.schedul
+00012920: 6572 2e74 6173 6b73 0a20 2020 2020 2020  er.tasks.       
+00012930: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00012940: 6e65 773a 0a20 2020 2020 2020 2020 2020  new:.           
+00012950: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00012960: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00012970: 736b 203d 2074 6173 6b73 5b6b 6579 5d0a  sk = tasks[key].
 00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012990: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000129a0: 2020 2020 2020 2020 2078 7820 3d20 785b           xx = x[
-000129b0: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-000129c0: 2020 2020 2079 7920 3d20 795b 6b65 795d       yy = y[key]
-000129d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000129e0: 206e 6f64 655f 6b65 792e 6170 7065 6e64   node_key.append
-000129f0: 2865 7363 6170 652e 7572 6c5f 6573 6361  (escape.url_esca
-00012a00: 7065 286b 6579 2929 0a20 2020 2020 2020  pe(key)).       
-00012a10: 2020 2020 2020 2020 206e 6f64 655f 782e           node_x.
-00012a20: 6170 7065 6e64 2878 7829 0a20 2020 2020  append(xx).     
-00012a30: 2020 2020 2020 2020 2020 206e 6f64 655f             node_
-00012a40: 792e 6170 7065 6e64 2879 7929 0a20 2020  y.append(yy).   
-00012a50: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00012a60: 655f 7374 6174 652e 6170 7065 6e64 2874  e_state.append(t
-00012a70: 6173 6b2e 7374 6174 6529 0a20 2020 2020  ask.state).     
-00012a80: 2020 2020 2020 2020 2020 206e 6f64 655f             node_
-00012a90: 6e61 6d65 2e61 7070 656e 6428 7461 736b  name.append(task
-00012aa0: 2e70 7265 6669 782e 6e61 6d65 290a 0a20  .prefix.name).. 
-00012ab0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-00012ac0: 2c20 6220 696e 206e 6577 5f65 6467 6573  , b in new_edges
-00012ad0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012ae0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00012af0: 2020 2020 2020 2020 2020 2065 6467 655f             edge_
-00012b00: 782e 6170 7065 6e64 285b 785b 615d 2c20  x.append([x[a], 
-00012b10: 785b 625d 5d29 0a20 2020 2020 2020 2020  x[b]]).         
-00012b20: 2020 2020 2020 2020 2020 2065 6467 655f             edge_
-00012b30: 792e 6170 7065 6e64 285b 795b 615d 2c20  y.append([y[a], 
-00012b40: 795b 625d 5d29 0a20 2020 2020 2020 2020  y[b]]).         
-00012b50: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-00012b60: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-00012b70: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00012b80: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
-00012b90: 6465 203d 207b 0a20 2020 2020 2020 2020  de = {.         
-00012ba0: 2020 2020 2020 2022 7822 3a20 6e6f 6465         "x": node
-00012bb0: 5f78 2c0a 2020 2020 2020 2020 2020 2020  _x,.            
-00012bc0: 2020 2020 2279 223a 206e 6f64 655f 792c      "y": node_y,
-00012bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012be0: 2022 7374 6174 6522 3a20 6e6f 6465 5f73   "state": node_s
-00012bf0: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
-00012c00: 2020 2020 2020 226e 616d 6522 3a20 6e6f        "name": no
-00012c10: 6465 5f6e 616d 652c 0a20 2020 2020 2020  de_name,.       
-00012c20: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-00012c30: 6e6f 6465 5f6b 6579 2c0a 2020 2020 2020  node_key,.      
-00012c40: 2020 2020 2020 2020 2020 2276 6973 6962            "visib
-00012c50: 6c65 223a 205b 2254 7275 6522 5d20 2a20  le": ["True"] * 
-00012c60: 6c65 6e28 6e6f 6465 5f78 292c 0a20 2020  len(node_x),.   
-00012c70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00012c80: 2020 2020 2020 2065 6467 6520 3d20 7b22         edge = {"
-00012c90: 7822 3a20 6564 6765 5f78 2c20 2279 223a  x": edge_x, "y":
-00012ca0: 2065 6467 655f 792c 2022 7669 7369 626c   edge_y, "visibl
-00012cb0: 6522 3a20 5b22 5472 7565 225d 202a 206c  e": ["True"] * l
-00012cc0: 656e 2865 6467 655f 7829 7d0a 0a20 2020  en(edge_x)}..   
-00012cd0: 2020 2020 2020 2020 2069 6620 7570 6461           if upda
-00012ce0: 7465 206f 7220 6e6f 7420 6c65 6e28 7365  te or not len(se
-00012cf0: 6c66 2e6e 6f64 655f 736f 7572 6365 2e64  lf.node_source.d
-00012d00: 6174 615b 2278 225d 293a 0a20 2020 2020  ata["x"]):.     
-00012d10: 2020 2020 2020 2020 2020 2023 2073 6565             # see
-00012d20: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-00012d30: 636f 6d2f 626f 6b65 682f 626f 6b65 682f  com/bokeh/bokeh/
-00012d40: 6973 7375 6573 2f37 3532 330a 2020 2020  issues/7523.    
-00012d50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012d60: 2e6e 6f64 655f 736f 7572 6365 2e64 6174  .node_source.dat
-00012d70: 612e 7570 6461 7465 286e 6f64 6529 0a20  a.update(node). 
-00012d80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012d90: 656c 662e 6564 6765 5f73 6f75 7263 652e  elf.edge_source.
-00012da0: 6461 7461 2e75 7064 6174 6528 6564 6765  data.update(edge
-00012db0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00012dc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012dd0: 2020 2020 7365 6c66 2e6e 6f64 655f 736f      self.node_so
-00012de0: 7572 6365 2e73 7472 6561 6d28 6e6f 6465  urce.stream(node
-00012df0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012e00: 2020 7365 6c66 2e65 6467 655f 736f 7572    self.edge_sour
-00012e10: 6365 2e73 7472 6561 6d28 6564 6765 290a  ce.stream(edge).
-00012e20: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
-00012e30: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
-00012e40: 6e0a 2020 2020 6465 6620 7061 7463 685f  n.    def patch_
-00012e50: 7570 6461 7465 7328 7365 6c66 293a 0a20  updates(self):. 
-00012e60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00012e70: 2020 2053 6d61 6c6c 2075 7064 6174 6573     Small updates
-00012e80: 206c 696b 6520 636f 6c6f 7220 6368 616e   like color chan
-00012e90: 6765 7320 6f72 206c 6f73 7420 6e6f 6465  ges or lost node
-00012ea0: 7320 6672 6f6d 2074 6173 6b20 7472 616e  s from task tran
-00012eb0: 7369 7469 6f6e 730a 2020 2020 2020 2020  sitions.        
-00012ec0: 2222 220a 2020 2020 2020 2020 6e20 3d20  """.        n = 
-00012ed0: 6c65 6e28 7365 6c66 2e6e 6f64 655f 736f  len(self.node_so
-00012ee0: 7572 6365 2e64 6174 615b 2278 225d 290a  urce.data["x"]).
-00012ef0: 2020 2020 2020 2020 6d20 3d20 6c65 6e28          m = len(
-00012f00: 7365 6c66 2e65 6467 655f 736f 7572 6365  self.edge_source
-00012f10: 2e64 6174 615b 2278 225d 290a 0a20 2020  .data["x"])..   
-00012f20: 2020 2020 2069 6620 7365 6c66 2e6c 6179       if self.lay
-00012f30: 6f75 742e 7374 6174 655f 7570 6461 7465  out.state_update
-00012f40: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-00012f50: 7461 7465 5f75 7064 6174 6573 203d 2073  tate_updates = s
-00012f60: 656c 662e 6c61 796f 7574 2e73 7461 7465  elf.layout.state
-00012f70: 5f75 7064 6174 6573 0a20 2020 2020 2020  _updates.       
-00012f80: 2020 2020 2073 656c 662e 6c61 796f 7574       self.layout
-00012f90: 2e73 7461 7465 5f75 7064 6174 6573 203d  .state_updates =
-00012fa0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00012fb0: 7570 6461 7465 7320 3d20 5b28 692c 2063  updates = [(i, c
-00012fc0: 2920 666f 7220 692c 2063 2069 6e20 7374  ) for i, c in st
-00012fd0: 6174 655f 7570 6461 7465 7320 6966 2069  ate_updates if i
-00012fe0: 203c 206e 5d0a 2020 2020 2020 2020 2020   < n].          
-00012ff0: 2020 7365 6c66 2e6e 6f64 655f 736f 7572    self.node_sour
-00013000: 6365 2e70 6174 6368 287b 2273 7461 7465  ce.patch({"state
-00013010: 223a 2075 7064 6174 6573 7d29 0a0a 2020  ": updates})..  
-00013020: 2020 2020 2020 6966 2073 656c 662e 6c61        if self.la
-00013030: 796f 7574 2e76 6973 6962 6c65 5f75 7064  yout.visible_upd
-00013040: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
-00013050: 2020 7570 6461 7465 7320 3d20 7365 6c66    updates = self
-00013060: 2e6c 6179 6f75 742e 7669 7369 626c 655f  .layout.visible_
-00013070: 7570 6461 7465 730a 2020 2020 2020 2020  updates.        
-00013080: 2020 2020 7570 6461 7465 7320 3d20 5b28      updates = [(
-00013090: 692c 2063 2920 666f 7220 692c 2063 2069  i, c) for i, c i
-000130a0: 6e20 7570 6461 7465 7320 6966 2069 203c  n updates if i <
-000130b0: 206e 5d0a 2020 2020 2020 2020 2020 2020   n].            
-000130c0: 7365 6c66 2e6c 6179 6f75 742e 7669 7369  self.layout.visi
-000130d0: 626c 655f 7570 6461 7465 7320 3d20 5b5d  ble_updates = []
-000130e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000130f0: 662e 6e6f 6465 5f73 6f75 7263 652e 7061  f.node_source.pa
-00013100: 7463 6828 7b22 7669 7369 626c 6522 3a20  tch({"visible": 
-00013110: 7570 6461 7465 737d 290a 2020 2020 2020  updates}).      
-00013120: 2020 2020 2020 7365 6c66 2e69 6e76 6973        self.invis
-00013130: 6962 6c65 5f63 6f75 6e74 202b 3d20 6c65  ible_count += le
-00013140: 6e28 7570 6461 7465 7329 0a0a 2020 2020  n(updates)..    
-00013150: 2020 2020 6966 2073 656c 662e 6c61 796f      if self.layo
-00013160: 7574 2e76 6973 6962 6c65 5f65 6467 655f  ut.visible_edge_
-00013170: 7570 6461 7465 733a 0a20 2020 2020 2020  updates:.       
-00013180: 2020 2020 2075 7064 6174 6573 203d 2073       updates = s
-00013190: 656c 662e 6c61 796f 7574 2e76 6973 6962  elf.layout.visib
-000131a0: 6c65 5f65 6467 655f 7570 6461 7465 730a  le_edge_updates.
-000131b0: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-000131c0: 7465 7320 3d20 5b28 692c 2063 2920 666f  tes = [(i, c) fo
-000131d0: 7220 692c 2063 2069 6e20 7570 6461 7465  r i, c in update
-000131e0: 7320 6966 2069 203c 206d 5d0a 2020 2020  s if i < m].    
-000131f0: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
-00013200: 6f75 742e 7669 7369 626c 655f 6564 6765  out.visible_edge
-00013210: 5f75 7064 6174 6573 203d 205b 5d0a 2020  _updates = [].  
-00013220: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-00013230: 6467 655f 736f 7572 6365 2e70 6174 6368  dge_source.patch
-00013240: 287b 2276 6973 6962 6c65 223a 2075 7064  ({"visible": upd
-00013250: 6174 6573 7d29 0a0a 2020 2020 6465 6620  ates})..    def 
-00013260: 5f5f 6465 6c5f 5f28 7365 6c66 293a 0a20  __del__(self):. 
-00013270: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00013280: 6475 6c65 722e 7265 6d6f 7665 5f70 6c75  duler.remove_plu
-00013290: 6769 6e28 6e61 6d65 3d73 656c 662e 6c61  gin(name=self.la
-000132a0: 796f 7574 2e6e 616d 6529 0a0a 0a63 6c61  yout.name)...cla
-000132b0: 7373 2054 6173 6b47 726f 7570 4772 6170  ss TaskGroupGrap
-000132c0: 6828 4461 7368 626f 6172 6443 6f6d 706f  h(DashboardCompo
-000132d0: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
-000132e0: 2020 2054 6173 6b20 4772 6f75 7020 4772     Task Group Gr
-000132f0: 6170 680a 0a20 2020 2043 7265 6174 6573  aph..    Creates
-00013300: 2061 2067 7261 7068 206c 6179 6f75 7420   a graph layout 
-00013310: 666f 7220 5461 736b 4772 6f75 7073 206f  for TaskGroups o
-00013320: 6e20 7468 6520 7363 6865 6475 6c65 722e  n the scheduler.
-00013330: 2020 4974 2061 7373 6967 6e73 0a20 2020    It assigns.   
-00013340: 2028 782c 2079 2920 6c6f 6361 7469 6f6e   (x, y) location
-00013350: 7320 746f 2061 6c6c 2074 6865 2054 6173  s to all the Tas
-00013360: 6b47 726f 7570 7320 616e 6420 6c61 7973  kGroups and lays
-00013370: 2074 6865 6d20 6f75 7420 6279 2061 6363   them out by acc
-00013380: 6f72 6469 6e67 0a20 2020 2074 6f20 7468  ording.    to th
-00013390: 6569 7220 6465 7065 6e64 656e 6369 6573  eir dependencies
-000133a0: 2e20 5468 6520 6c61 796f 7574 2067 6574  . The layout get
-000133b0: 7320 7570 6461 7465 6420 6576 6572 7920  s updated every 
-000133c0: 7469 6d65 2074 6861 7420 6e65 770a 2020  time that new.  
-000133d0: 2020 5461 736b 4772 6f75 7073 2061 7265    TaskGroups are
-000133e0: 2061 6464 6564 2e0a 0a20 2020 2045 6163   added...    Eac
-000133f0: 6820 7461 736b 2067 726f 7570 206e 6f64  h task group nod
-00013400: 6520 696e 636f 6465 7320 696e 666f 726d  e incodes inform
-00013410: 6174 696f 6e20 6162 6f75 7420 7461 736b  ation about task
-00013420: 2070 726f 6772 6573 732c 206d 656d 6f72   progress, memor
-00013430: 792c 0a20 2020 2061 6e64 206f 7574 7075  y,.    and outpu
-00013440: 7420 7479 7065 2069 6e74 6f20 676c 7970  t type into glyp
-00013450: 6873 2c20 6173 2077 656c 6c20 6173 2061  hs, as well as a
-00013460: 2068 6f76 6572 2074 6f6f 6c74 6970 2077   hover tooltip w
-00013470: 6974 6820 6d6f 7265 2064 6574 6169 6c65  ith more detaile
-00013480: 640a 2020 2020 696e 666f 726d 6174 696f  d.    informatio
-00013490: 6e20 6f6e 206e 616d 652c 2063 6f6d 7075  n on name, compu
-000134a0: 7461 7469 6f6e 2074 696d 652c 206d 656d  tation time, mem
-000134b0: 6f72 792c 2061 6e64 2074 6173 6b73 2073  ory, and tasks s
-000134c0: 7461 7475 732e 0a20 2020 2022 2222 0a0a  tatus..    """..
-000134d0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-000134e0: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-000134f0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00013500: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00013510: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-00013520: 0a20 2020 2020 2020 2073 656c 662e 6e6f  .        self.no
-00013530: 6465 735f 6c61 796f 7574 203d 207b 7d0a  des_layout = {}.
-00013540: 2020 2020 2020 2020 7365 6c66 2e61 7272          self.arr
-00013550: 6f77 735f 6c61 796f 7574 203d 207b 7d0a  ows_layout = {}.
-00013560: 0a20 2020 2020 2020 2073 656c 662e 6f6c  .        self.ol
-00013570: 645f 636f 756e 7465 7220 3d20 2d31 0a0a  d_counter = -1..
-00013580: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
-00013590: 6573 5f73 6f75 7263 6520 3d20 436f 6c75  es_source = Colu
-000135a0: 6d6e 4461 7461 536f 7572 6365 280a 2020  mnDataSource(.  
-000135b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000135c0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
-000135d0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000135e0: 2020 2020 2022 7922 3a20 5b5d 2c0a 2020       "y": [],.  
-000135f0: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-00013600: 5f62 6f78 223a 205b 5d2c 0a20 2020 2020  _box": [],.     
-00013610: 2020 2020 2020 2020 2020 2022 685f 626f             "h_bo
-00013620: 7822 3a20 5b5d 2c0a 2020 2020 2020 2020  x": [],.        
-00013630: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
-00013640: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00013650: 2020 2020 2274 6f74 5f74 6173 6b73 223a      "tot_tasks":
-00013660: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00013670: 2020 2020 2022 636f 6c6f 7222 3a20 5b5d       "color": []
-00013680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013690: 2020 2278 5f73 7461 7274 223a 205b 5d2c    "x_start": [],
-000136a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000136b0: 2022 785f 656e 6422 3a20 5b5d 2c0a 2020   "x_end": [],.  
-000136c0: 2020 2020 2020 2020 2020 2020 2020 2279                "y
-000136d0: 5f73 7461 7274 223a 205b 5d2c 0a20 2020  _start": [],.   
-000136e0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
-000136f0: 656e 6422 3a20 5b5d 2c0a 2020 2020 2020  end": [],.      
-00013700: 2020 2020 2020 2020 2020 2278 5f65 6e64            "x_end
-00013710: 5f70 726f 6772 6573 7322 3a20 5b5d 2c0a  _progress": [],.
-00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013730: 226d 656d 5f61 6c70 6861 223a 205b 5d2c  "mem_alpha": [],
-00013740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013750: 2022 6e6f 6465 5f6c 696e 655f 7769 6474   "node_line_widt
-00013760: 6822 3a20 5b5d 2c0a 2020 2020 2020 2020  h": [],.        
-00013770: 2020 2020 2020 2020 2263 6f6d 705f 7461          "comp_ta
-00013780: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
-00013790: 2020 2020 2020 2020 2020 2275 726c 5f6c            "url_l
-000137a0: 6f67 6f22 3a20 5b5d 2c0a 2020 2020 2020  ogo": [],.      
-000137b0: 2020 2020 2020 2020 2020 2278 5f6c 6f67            "x_log
-000137c0: 6f22 3a20 5b5d 2c0a 2020 2020 2020 2020  o": [],.        
-000137d0: 2020 2020 2020 2020 2279 5f6c 6f67 6f22          "y_logo"
-000137e0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000137f0: 2020 2020 2020 2277 5f6c 6f67 6f22 3a20        "w_logo": 
-00013800: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00013810: 2020 2020 2268 5f6c 6f67 6f22 3a20 5b5d      "h_logo": []
-00013820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013830: 2020 2269 6e5f 7072 6f63 6573 7369 6e67    "in_processing
+00012990: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+000129a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000129b0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+000129c0: 2020 2020 2020 2020 2020 2020 2020 7878                xx
+000129d0: 203d 2078 5b6b 6579 5d0a 2020 2020 2020   = x[key].      
+000129e0: 2020 2020 2020 2020 2020 7979 203d 2079            yy = y
+000129f0: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
+00012a00: 2020 2020 2020 6e6f 6465 5f6b 6579 2e61        node_key.a
+00012a10: 7070 656e 6428 6573 6361 7065 2e75 726c  ppend(escape.url
+00012a20: 5f65 7363 6170 6528 6b65 7929 290a 2020  _escape(key)).  
+00012a30: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00012a40: 6465 5f78 2e61 7070 656e 6428 7878 290a  de_x.append(xx).
+00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a60: 6e6f 6465 5f79 2e61 7070 656e 6428 7979  node_y.append(yy
+00012a70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012a80: 2020 6e6f 6465 5f73 7461 7465 2e61 7070    node_state.app
+00012a90: 656e 6428 7461 736b 2e73 7461 7465 290a  end(task.state).
+00012aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ab0: 6e6f 6465 5f6e 616d 652e 6170 7065 6e64  node_name.append
+00012ac0: 2874 6173 6b2e 7072 6566 6978 2e6e 616d  (task.prefix.nam
+00012ad0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00012ae0: 666f 7220 612c 2062 2069 6e20 6e65 775f  for a, b in new_
+00012af0: 6564 6765 733a 0a20 2020 2020 2020 2020  edges:.         
+00012b00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00012b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b20: 6564 6765 5f78 2e61 7070 656e 6428 5b78  edge_x.append([x
+00012b30: 5b61 5d2c 2078 5b62 5d5d 290a 2020 2020  [a], x[b]]).    
+00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b50: 6564 6765 5f79 2e61 7070 656e 6428 5b79  edge_y.append([y
+00012b60: 5b61 5d2c 2079 5b62 5d5d 290a 2020 2020  [a], y[b]]).    
+00012b70: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00012b80: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ba0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
+00012bb0: 2020 206e 6f64 6520 3d20 7b0a 2020 2020     node = {.    
+00012bc0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
+00012bd0: 206e 6f64 655f 782c 0a20 2020 2020 2020   node_x,.       
+00012be0: 2020 2020 2020 2020 2022 7922 3a20 6e6f           "y": no
+00012bf0: 6465 5f79 2c0a 2020 2020 2020 2020 2020  de_y,.          
+00012c00: 2020 2020 2020 2273 7461 7465 223a 206e        "state": n
+00012c10: 6f64 655f 7374 6174 652c 0a20 2020 2020  ode_state,.     
+00012c20: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+00012c30: 223a 206e 6f64 655f 6e61 6d65 2c0a 2020  ": node_name,.  
+00012c40: 2020 2020 2020 2020 2020 2020 2020 226b                "k
+00012c50: 6579 223a 206e 6f64 655f 6b65 792c 0a20  ey": node_key,. 
+00012c60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00012c70: 7669 7369 626c 6522 3a20 5b22 5472 7565  visible": ["True
+00012c80: 225d 202a 206c 656e 286e 6f64 655f 7829  "] * len(node_x)
+00012c90: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00012ca0: 2020 2020 2020 2020 2020 2020 6564 6765              edge
+00012cb0: 203d 207b 2278 223a 2065 6467 655f 782c   = {"x": edge_x,
+00012cc0: 2022 7922 3a20 6564 6765 5f79 2c20 2276   "y": edge_y, "v
+00012cd0: 6973 6962 6c65 223a 205b 2254 7275 6522  isible": ["True"
+00012ce0: 5d20 2a20 6c65 6e28 6564 6765 5f78 297d  ] * len(edge_x)}
+00012cf0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00012d00: 2075 7064 6174 6520 6f72 206e 6f74 206c   update or not l
+00012d10: 656e 2873 656c 662e 6e6f 6465 5f73 6f75  en(self.node_sou
+00012d20: 7263 652e 6461 7461 5b22 7822 5d29 3a0a  rce.data["x"]):.
+00012d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d40: 2320 7365 6520 6874 7470 733a 2f2f 6769  # see https://gi
+00012d50: 7468 7562 2e63 6f6d 2f62 6f6b 6568 2f62  thub.com/bokeh/b
+00012d60: 6f6b 6568 2f69 7373 7565 732f 3735 3233  okeh/issues/7523
+00012d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012d80: 2073 656c 662e 6e6f 6465 5f73 6f75 7263   self.node_sourc
+00012d90: 652e 6461 7461 2e75 7064 6174 6528 6e6f  e.data.update(no
+00012da0: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
+00012db0: 2020 2020 7365 6c66 2e65 6467 655f 736f      self.edge_so
+00012dc0: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
+00012dd0: 2865 6467 6529 0a20 2020 2020 2020 2020  (edge).         
+00012de0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012df0: 2020 2020 2020 2020 2073 656c 662e 6e6f           self.no
+00012e00: 6465 5f73 6f75 7263 652e 7374 7265 616d  de_source.stream
+00012e10: 286e 6f64 6529 0a20 2020 2020 2020 2020  (node).         
+00012e20: 2020 2020 2020 2073 656c 662e 6564 6765         self.edge
+00012e30: 5f73 6f75 7263 652e 7374 7265 616d 2865  _source.stream(e
+00012e40: 6467 6529 0a0a 2020 2020 4077 6974 686f  dge)..    @witho
+00012e50: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00012e60: 6461 7469 6f6e 0a20 2020 2064 6566 2070  dation.    def p
+00012e70: 6174 6368 5f75 7064 6174 6573 2873 656c  atch_updates(sel
+00012e80: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+00012e90: 2020 2020 2020 2020 536d 616c 6c20 7570          Small up
+00012ea0: 6461 7465 7320 6c69 6b65 2063 6f6c 6f72  dates like color
+00012eb0: 2063 6861 6e67 6573 206f 7220 6c6f 7374   changes or lost
+00012ec0: 206e 6f64 6573 2066 726f 6d20 7461 736b   nodes from task
+00012ed0: 2074 7261 6e73 6974 696f 6e73 0a20 2020   transitions.   
+00012ee0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00012ef0: 206e 203d 206c 656e 2873 656c 662e 6e6f   n = len(self.no
+00012f00: 6465 5f73 6f75 7263 652e 6461 7461 5b22  de_source.data["
+00012f10: 7822 5d29 0a20 2020 2020 2020 206d 203d  x"]).        m =
+00012f20: 206c 656e 2873 656c 662e 6564 6765 5f73   len(self.edge_s
+00012f30: 6f75 7263 652e 6461 7461 5b22 7822 5d29  ource.data["x"])
+00012f40: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00012f50: 662e 6c61 796f 7574 2e73 7461 7465 5f75  f.layout.state_u
+00012f60: 7064 6174 6573 3a0a 2020 2020 2020 2020  pdates:.        
+00012f70: 2020 2020 7374 6174 655f 7570 6461 7465      state_update
+00012f80: 7320 3d20 7365 6c66 2e6c 6179 6f75 742e  s = self.layout.
+00012f90: 7374 6174 655f 7570 6461 7465 730a 2020  state_updates.  
+00012fa0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+00012fb0: 6179 6f75 742e 7374 6174 655f 7570 6461  ayout.state_upda
+00012fc0: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
+00012fd0: 2020 2020 2075 7064 6174 6573 203d 205b       updates = [
+00012fe0: 2869 2c20 6329 2066 6f72 2069 2c20 6320  (i, c) for i, c 
+00012ff0: 696e 2073 7461 7465 5f75 7064 6174 6573  in state_updates
+00013000: 2069 6620 6920 3c20 6e5d 0a20 2020 2020   if i < n].     
+00013010: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
+00013020: 5f73 6f75 7263 652e 7061 7463 6828 7b22  _source.patch({"
+00013030: 7374 6174 6522 3a20 7570 6461 7465 737d  state": updates}
+00013040: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00013050: 6c66 2e6c 6179 6f75 742e 7669 7369 626c  lf.layout.visibl
+00013060: 655f 7570 6461 7465 733a 0a20 2020 2020  e_updates:.     
+00013070: 2020 2020 2020 2075 7064 6174 6573 203d         updates =
+00013080: 2073 656c 662e 6c61 796f 7574 2e76 6973   self.layout.vis
+00013090: 6962 6c65 5f75 7064 6174 6573 0a20 2020  ible_updates.   
+000130a0: 2020 2020 2020 2020 2075 7064 6174 6573           updates
+000130b0: 203d 205b 2869 2c20 6329 2066 6f72 2069   = [(i, c) for i
+000130c0: 2c20 6320 696e 2075 7064 6174 6573 2069  , c in updates i
+000130d0: 6620 6920 3c20 6e5d 0a20 2020 2020 2020  f i < n].       
+000130e0: 2020 2020 2073 656c 662e 6c61 796f 7574       self.layout
+000130f0: 2e76 6973 6962 6c65 5f75 7064 6174 6573  .visible_updates
+00013100: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00013110: 2020 7365 6c66 2e6e 6f64 655f 736f 7572    self.node_sour
+00013120: 6365 2e70 6174 6368 287b 2276 6973 6962  ce.patch({"visib
+00013130: 6c65 223a 2075 7064 6174 6573 7d29 0a20  le": updates}). 
+00013140: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00013150: 696e 7669 7369 626c 655f 636f 756e 7420  invisible_count 
+00013160: 2b3d 206c 656e 2875 7064 6174 6573 290a  += len(updates).
+00013170: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00013180: 2e6c 6179 6f75 742e 7669 7369 626c 655f  .layout.visible_
+00013190: 6564 6765 5f75 7064 6174 6573 3a0a 2020  edge_updates:.  
+000131a0: 2020 2020 2020 2020 2020 7570 6461 7465            update
+000131b0: 7320 3d20 7365 6c66 2e6c 6179 6f75 742e  s = self.layout.
+000131c0: 7669 7369 626c 655f 6564 6765 5f75 7064  visible_edge_upd
+000131d0: 6174 6573 0a20 2020 2020 2020 2020 2020  ates.           
+000131e0: 2075 7064 6174 6573 203d 205b 2869 2c20   updates = [(i, 
+000131f0: 6329 2066 6f72 2069 2c20 6320 696e 2075  c) for i, c in u
+00013200: 7064 6174 6573 2069 6620 6920 3c20 6d5d  pdates if i < m]
+00013210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013220: 662e 6c61 796f 7574 2e76 6973 6962 6c65  f.layout.visible
+00013230: 5f65 6467 655f 7570 6461 7465 7320 3d20  _edge_updates = 
+00013240: 5b5d 0a20 2020 2020 2020 2020 2020 2073  [].            s
+00013250: 656c 662e 6564 6765 5f73 6f75 7263 652e  elf.edge_source.
+00013260: 7061 7463 6828 7b22 7669 7369 626c 6522  patch({"visible"
+00013270: 3a20 7570 6461 7465 737d 290a 0a20 2020  : updates})..   
+00013280: 2064 6566 205f 5f64 656c 5f5f 2873 656c   def __del__(sel
+00013290: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+000132a0: 2e73 6368 6564 756c 6572 2e72 656d 6f76  .scheduler.remov
+000132b0: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
+000132c0: 6c66 2e6c 6179 6f75 742e 6e61 6d65 290a  lf.layout.name).
+000132d0: 0a0a 636c 6173 7320 5461 736b 4772 6f75  ..class TaskGrou
+000132e0: 7047 7261 7068 2844 6173 6862 6f61 7264  pGraph(Dashboard
+000132f0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+00013300: 2222 220a 2020 2020 5461 736b 2047 726f  """.    Task Gro
+00013310: 7570 2047 7261 7068 0a0a 2020 2020 4372  up Graph..    Cr
+00013320: 6561 7465 7320 6120 6772 6170 6820 6c61  eates a graph la
+00013330: 796f 7574 2066 6f72 2054 6173 6b47 726f  yout for TaskGro
+00013340: 7570 7320 6f6e 2074 6865 2073 6368 6564  ups on the sched
+00013350: 756c 6572 2e20 2049 7420 6173 7369 676e  uler.  It assign
+00013360: 730a 2020 2020 2878 2c20 7929 206c 6f63  s.    (x, y) loc
+00013370: 6174 696f 6e73 2074 6f20 616c 6c20 7468  ations to all th
+00013380: 6520 5461 736b 4772 6f75 7073 2061 6e64  e TaskGroups and
+00013390: 206c 6179 7320 7468 656d 206f 7574 2062   lays them out b
+000133a0: 7920 6163 636f 7264 696e 670a 2020 2020  y according.    
+000133b0: 746f 2074 6865 6972 2064 6570 656e 6465  to their depende
+000133c0: 6e63 6965 732e 2054 6865 206c 6179 6f75  ncies. The layou
+000133d0: 7420 6765 7473 2075 7064 6174 6564 2065  t gets updated e
+000133e0: 7665 7279 2074 696d 6520 7468 6174 206e  very time that n
+000133f0: 6577 0a20 2020 2054 6173 6b47 726f 7570  ew.    TaskGroup
+00013400: 7320 6172 6520 6164 6465 642e 0a0a 2020  s are added...  
+00013410: 2020 4561 6368 2074 6173 6b20 6772 6f75    Each task grou
+00013420: 7020 6e6f 6465 2069 6e63 6f64 6573 2069  p node incodes i
+00013430: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+00013440: 2074 6173 6b20 7072 6f67 7265 7373 2c20   task progress, 
+00013450: 6d65 6d6f 7279 2c0a 2020 2020 616e 6420  memory,.    and 
+00013460: 6f75 7470 7574 2074 7970 6520 696e 746f  output type into
+00013470: 2067 6c79 7068 732c 2061 7320 7765 6c6c   glyphs, as well
+00013480: 2061 7320 6120 686f 7665 7220 746f 6f6c   as a hover tool
+00013490: 7469 7020 7769 7468 206d 6f72 6520 6465  tip with more de
+000134a0: 7461 696c 6564 0a20 2020 2069 6e66 6f72  tailed.    infor
+000134b0: 6d61 7469 6f6e 206f 6e20 6e61 6d65 2c20  mation on name, 
+000134c0: 636f 6d70 7574 6174 696f 6e20 7469 6d65  computation time
+000134d0: 2c20 6d65 6d6f 7279 2c20 616e 6420 7461  , memory, and ta
+000134e0: 736b 7320 7374 6174 7573 2e0a 2020 2020  sks status..    
+000134f0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00013500: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+00013510: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
+00013520: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+00013530: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
+00013540: 756c 6572 0a0a 2020 2020 2020 2020 7365  uler..        se
+00013550: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 7420  lf.nodes_layout 
+00013560: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+00013570: 662e 6172 726f 7773 5f6c 6179 6f75 7420  f.arrows_layout 
+00013580: 3d20 7b7d 0a0a 2020 2020 2020 2020 7365  = {}..        se
+00013590: 6c66 2e6f 6c64 5f63 6f75 6e74 6572 203d  lf.old_counter =
+000135a0: 202d 310a 0a20 2020 2020 2020 2073 656c   -1..        sel
+000135b0: 662e 6e6f 6465 735f 736f 7572 6365 203d  f.nodes_source =
+000135c0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+000135d0: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
+000135e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000135f0: 2022 7822 3a20 5b5d 2c0a 2020 2020 2020   "x": [],.      
+00013600: 2020 2020 2020 2020 2020 2279 223a 205b            "y": [
+00013610: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013620: 2020 2022 775f 626f 7822 3a20 5b5d 2c0a     "w_box": [],.
+00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013640: 2268 5f62 6f78 223a 205b 5d2c 0a20 2020  "h_box": [],.   
+00013650: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
+00013660: 6d65 223a 205b 5d2c 0a20 2020 2020 2020  me": [],.       
+00013670: 2020 2020 2020 2020 2022 746f 745f 7461           "tot_ta
+00013680: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
+00013690: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+000136a0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+000136b0: 2020 2020 2020 2022 785f 7374 6172 7422         "x_start"
+000136c0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000136d0: 2020 2020 2020 2278 5f65 6e64 223a 205b        "x_end": [
+000136e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000136f0: 2020 2022 795f 7374 6172 7422 3a20 5b5d     "y_start": []
+00013700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013710: 2020 2279 5f65 6e64 223a 205b 5d2c 0a20    "y_end": [],. 
+00013720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013730: 785f 656e 645f 7072 6f67 7265 7373 223a  x_end_progress":
+00013740: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00013750: 2020 2020 2022 6d65 6d5f 616c 7068 6122       "mem_alpha"
+00013760: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00013770: 2020 2020 2020 226e 6f64 655f 6c69 6e65        "node_line
+00013780: 5f77 6964 7468 223a 205b 5d2c 0a20 2020  _width": [],.   
+00013790: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+000137a0: 6d70 5f74 6173 6b73 223a 205b 5d2c 0a20  mp_tasks": [],. 
+000137b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000137c0: 7572 6c5f 6c6f 676f 223a 205b 5d2c 0a20  url_logo": [],. 
+000137d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000137e0: 785f 6c6f 676f 223a 205b 5d2c 0a20 2020  x_logo": [],.   
+000137f0: 2020 2020 2020 2020 2020 2020 2022 795f               "y_
+00013800: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
+00013810: 2020 2020 2020 2020 2020 2022 775f 6c6f             "w_lo
+00013820: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
+00013830: 2020 2020 2020 2020 2022 685f 6c6f 676f           "h_logo
 00013840: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00013850: 2020 2020 2020 2022 696e 5f6d 656d 6f72         "in_memor
-00013860: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
-00013870: 2020 2020 2020 2020 2269 6e5f 7265 6c65          "in_rele
-00013880: 6173 6564 223a 205b 5d2c 0a20 2020 2020  ased": [],.     
-00013890: 2020 2020 2020 2020 2020 2022 696e 5f65             "in_e
-000138a0: 7272 6564 223a 205b 5d2c 0a20 2020 2020  rred": [],.     
-000138b0: 2020 2020 2020 2020 2020 2022 636f 6d70             "comp
-000138c0: 7574 655f 7469 6d65 223a 205b 5d2c 0a20  ute_time": [],. 
-000138d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000138e0: 6d65 6d6f 7279 223a 205b 5d2c 0a20 2020  memory": [],.   
-000138f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00013900: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00013910: 6c66 2e61 7272 6f77 735f 736f 7572 6365  lf.arrows_source
-00013920: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-00013930: 7263 6528 7b22 7873 223a 205b 5d2c 2022  rce({"xs": [], "
-00013940: 7973 223a 205b 5d2c 2022 7865 223a 205b  ys": [], "xe": [
-00013950: 5d2c 2022 7965 223a 205b 5d7d 290a 0a20  ], "ye": []}).. 
-00013960: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00013970: 203d 2066 6967 7572 6528 7469 746c 653d   = figure(title=
-00013980: 2254 6173 6b20 4772 6f75 7073 2047 7261  "Task Groups Gra
-00013990: 7068 222c 206d 6174 6368 5f61 7370 6563  ph", match_aspec
-000139a0: 743d 5472 7565 2c20 2a2a 6b77 6172 6773  t=True, **kwargs
-000139b0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-000139c0: 6f6f 742e 6178 6973 2e76 6973 6962 6c65  oot.axis.visible
-000139d0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000139e0: 2073 656c 662e 7375 6274 6974 6c65 203d   self.subtitle =
-000139f0: 2054 6974 6c65 2874 6578 743d 2220 222c   Title(text=" ",
-00013a00: 2074 6578 745f 666f 6e74 5f73 7479 6c65   text_font_style
-00013a10: 3d22 6974 616c 6963 2229 0a20 2020 2020  ="italic").     
-00013a20: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
-00013a30: 5f6c 6179 6f75 7428 7365 6c66 2e73 7562  _layout(self.sub
-00013a40: 7469 746c 652c 2022 6162 6f76 6522 290a  title, "above").
-00013a50: 0a20 2020 2020 2020 2072 6563 7420 3d20  .        rect = 
-00013a60: 7365 6c66 2e72 6f6f 742e 7265 6374 280a  self.root.rect(.
-00013a70: 2020 2020 2020 2020 2020 2020 783d 2278              x="x
-00013a80: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-00013a90: 3d22 7922 2c0a 2020 2020 2020 2020 2020  ="y",.          
-00013aa0: 2020 7769 6474 683d 2277 5f62 6f78 222c    width="w_box",
-00013ab0: 0a20 2020 2020 2020 2020 2020 2068 6569  .            hei
-00013ac0: 6768 743d 2268 5f62 6f78 222c 0a20 2020  ght="h_box",.   
-00013ad0: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
-00013ae0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-00013af0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d22      fill_alpha="
-00013b00: 6d65 6d5f 616c 7068 6122 2c0a 2020 2020  mem_alpha",.    
-00013b10: 2020 2020 2020 2020 6c69 6e65 5f63 6f6c          line_col
-00013b20: 6f72 3d22 626c 6163 6b22 2c0a 2020 2020  or="black",.    
-00013b30: 2020 2020 2020 2020 6c69 6e65 5f77 6964          line_wid
-00013b40: 7468 3d22 6e6f 6465 5f6c 696e 655f 7769  th="node_line_wi
-00013b50: 6474 6822 2c0a 2020 2020 2020 2020 2020  dth",.          
-00013b60: 2020 736f 7572 6365 3d73 656c 662e 6e6f    source=self.no
-00013b70: 6465 735f 736f 7572 6365 2c0a 2020 2020  des_source,.    
-00013b80: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-00013b90: 2070 6c6f 7420 7467 206c 6f67 0a20 2020   plot tg log.   
-00013ba0: 2020 2020 2073 656c 662e 726f 6f74 2e69       self.root.i
-00013bb0: 6d61 6765 5f75 726c 280a 2020 2020 2020  mage_url(.      
-00013bc0: 2020 2020 2020 7572 6c3d 2275 726c 5f6c        url="url_l
-00013bd0: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
-00013be0: 2020 783d 2278 5f6c 6f67 6f22 2c0a 2020    x="x_logo",.  
-00013bf0: 2020 2020 2020 2020 2020 793d 2279 5f6c            y="y_l
-00013c00: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
-00013c10: 2020 773d 2277 5f6c 6f67 6f22 2c0a 2020    w="w_logo",.  
-00013c20: 2020 2020 2020 2020 2020 683d 2268 5f6c            h="h_l
-00013c30: 6f67 6f22 2c0a 2020 2020 2020 2020 2020  ogo",.          
-00013c40: 2020 616e 6368 6f72 3d22 6365 6e74 6572    anchor="center
-00013c50: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00013c60: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
-00013c70: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
-00013c80: 2029 0a0a 2020 2020 2020 2020 2320 7072   )..        # pr
-00013c90: 6f67 7265 7373 2062 6172 2070 6c61 696e  ogress bar plain
-00013ca0: 2062 6f78 0a20 2020 2020 2020 2073 656c   box.        sel
-00013cb0: 662e 726f 6f74 2e71 7561 6428 0a20 2020  f.root.quad(.   
-00013cc0: 2020 2020 2020 2020 206c 6566 743d 2278           left="x
-00013cd0: 5f73 7461 7274 222c 0a20 2020 2020 2020  _start",.       
-00013ce0: 2020 2020 2072 6967 6874 3d22 785f 656e       right="x_en
-00013cf0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00013d00: 626f 7474 6f6d 3d22 795f 7374 6172 7422  bottom="y_start"
-00013d10: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00013d20: 703d 2279 5f65 6e64 222c 0a20 2020 2020  p="y_end",.     
-00013d30: 2020 2020 2020 2063 6f6c 6f72 3d4e 6f6e         color=Non
-00013d40: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
-00013d50: 696e 655f 636f 6c6f 723d 2262 6c61 636b  ine_color="black
-00013d60: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00013d70: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
-00013d80: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
-00013d90: 2029 0a0a 2020 2020 2020 2020 2320 7072   )..        # pr
-00013da0: 6f67 7265 7373 2062 6172 0a20 2020 2020  ogress bar.     
-00013db0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
-00013dc0: 6428 0a20 2020 2020 2020 2020 2020 206c  d(.            l
-00013dd0: 6566 743d 2278 5f73 7461 7274 222c 0a20  eft="x_start",. 
-00013de0: 2020 2020 2020 2020 2020 2072 6967 6874             right
-00013df0: 3d22 785f 656e 645f 7072 6f67 7265 7373  ="x_end_progress
-00013e00: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
-00013e10: 6f74 746f 6d3d 2279 5f73 7461 7274 222c  ottom="y_start",
-00013e20: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-00013e30: 3d22 795f 656e 6422 2c0a 2020 2020 2020  ="y_end",.      
-00013e40: 2020 2020 2020 636f 6c6f 723d 2263 6f6c        color="col
-00013e50: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-00013e60: 206c 696e 655f 636f 6c6f 723d 4e6f 6e65   line_color=None
-00013e70: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-00013e80: 6c6c 5f61 6c70 6861 3d30 2e36 2c0a 2020  ll_alpha=0.6,.  
-00013e90: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00013ea0: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
-00013eb0: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
-00013ec0: 2020 2020 2020 2073 656c 662e 6172 726f         self.arro
-00013ed0: 7773 203d 2041 7272 6f77 280a 2020 2020  ws = Arrow(.    
-00013ee0: 2020 2020 2020 2020 656e 643d 5665 6548          end=VeeH
-00013ef0: 6561 6428 7369 7a65 3d38 292c 0a20 2020  ead(size=8),.   
-00013f00: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-00013f10: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
-00013f20: 2020 2020 2020 2020 206c 696e 655f 616c           line_al
-00013f30: 7068 613d 302e 352c 0a20 2020 2020 2020  pha=0.5,.       
-00013f40: 2020 2020 206c 696e 655f 7769 6474 683d       line_width=
-00013f50: 312c 0a20 2020 2020 2020 2020 2020 2078  1,.            x
-00013f60: 5f73 7461 7274 3d22 7873 222c 0a20 2020  _start="xs",.   
-00013f70: 2020 2020 2020 2020 2079 5f73 7461 7274           y_start
-00013f80: 3d22 7973 222c 0a20 2020 2020 2020 2020  ="ys",.         
-00013f90: 2020 2078 5f65 6e64 3d22 7865 222c 0a20     x_end="xe",. 
-00013fa0: 2020 2020 2020 2020 2020 2079 5f65 6e64             y_end
-00013fb0: 3d22 7965 222c 0a20 2020 2020 2020 2020  ="ye",.         
-00013fc0: 2020 2073 6f75 7263 653d 7365 6c66 2e61     source=self.a
-00013fd0: 7272 6f77 735f 736f 7572 6365 2c0a 2020  rrows_source,.  
-00013fe0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00013ff0: 7365 6c66 2e72 6f6f 742e 6164 645f 6c61  self.root.add_la
-00014000: 796f 7574 2873 656c 662e 6172 726f 7773  yout(self.arrows
-00014010: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00014020: 726f 6f74 2e78 6772 6964 2e67 7269 645f  root.xgrid.grid_
-00014030: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
-00014040: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
-00014050: 6f6f 742e 7967 7269 642e 6772 6964 5f6c  oot.ygrid.grid_l
-00014060: 696e 655f 636f 6c6f 7220 3d20 4e6f 6e65  ine_color = None
-00014070: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00014080: 6f74 2e78 5f72 616e 6765 2e72 616e 6765  ot.x_range.range
-00014090: 5f70 6164 6469 6e67 203d 2030 2e35 0a20  _padding = 0.5. 
-000140a0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-000140b0: 2e79 5f72 616e 6765 2e72 616e 6765 5f70  .y_range.range_p
-000140c0: 6164 6469 6e67 203d 2030 2e35 0a0a 2020  adding = 0.5..  
-000140d0: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-000140e0: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
-000140f0: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
-00014100: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
-00014110: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00014120: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
-00014130: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-00014140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014150: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00014160: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
-00014170: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-00014180: 626f 6c64 3b22 3e4e 616d 653a 3c2f 7370  bold;">Name:</sp
-00014190: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
-000141a0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-000141b0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-000141c0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-000141d0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-000141e0: 206d 6f6e 6f73 7061 6365 3b22 3e40 6e61   monospace;">@na
-000141f0: 6d65 3c2f 7370 616e 3e0a 2020 2020 2020  me</span>.      
-00014200: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00014210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014220: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
-00014230: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00014240: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00014250: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00014260: 6967 6874 3a20 626f 6c64 3b22 3e43 6f6d  ight: bold;">Com
-00014270: 7075 7465 2074 696d 653a 3c2f 7370 616e  pute time:</span
-00014280: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-00014290: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-000142a0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-000142b0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-000142c0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-000142d0: 6f6e 6f73 7061 6365 3b22 3e40 636f 6d70  onospace;">@comp
-000142e0: 7574 655f 7469 6d65 3c2f 7370 616e 3e0a  ute_time</span>.
-000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014300: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-00014310: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
-00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014330: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00014340: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-00014350: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-00014360: 3b22 3e4d 656d 6f72 793a 3c2f 7370 616e  ;">Memory:</span
-00014370: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-00014380: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00014390: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-000143a0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-000143b0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-000143c0: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
-000143d0: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
-000143e0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-000143f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014400: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
-00014410: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00014420: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00014430: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00014440: 6967 6874 3a20 626f 6c64 3b22 3e54 6173  ight: bold;">Tas
-00014450: 6b73 3a3c 2f73 7061 6e3e 266e 6273 703b  ks:</span>&nbsp;
-00014460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014470: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00014480: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
-00014490: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
-000144a0: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
-000144b0: 653b 223e 4074 6f74 5f74 6173 6b73 3c2f  e;">@tot_tasks</
-000144c0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
-000144d0: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
-000144e0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-000144f0: 7620 7374 796c 653d 226d 6172 6769 6e2d  v style="margin-
-00014500: 6c65 6674 3a20 3265 6d3b 223e 0a20 2020  left: 2em;">.   
-00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014520: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00014530: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
-00014540: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-00014550: 3b22 3e43 6f6d 706c 6574 6564 3a3c 2f73  ;">Completed:</s
-00014560: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
-00014570: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014580: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00014590: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-000145a0: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-000145b0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4063  , monospace;">@c
-000145c0: 6f6d 705f 7461 736b 733c 2f73 7061 6e3e  omp_tasks</span>
-000145d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000145e0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-000145f0: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
-00014600: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
-00014610: 2032 656d 3b22 3e0a 2020 2020 2020 2020   2em;">.        
-00014620: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00014630: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00014640: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
-00014650: 6569 6768 743a 2062 6f6c 643b 223e 5072  eight: bold;">Pr
-00014660: 6f63 6573 7369 6e67 3a3c 2f73 7061 6e3e  ocessing:</span>
-00014670: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
-00014680: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00014690: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-000146a0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-000146b0: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-000146c0: 6e6f 7370 6163 653b 223e 4069 6e5f 7072  nospace;">@in_pr
-000146d0: 6f63 6573 7369 6e67 3c2f 7370 616e 3e0a  ocessing</span>.
-000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146f0: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-00014700: 2020 2020 2020 203c 6469 7620 7374 796c         <div styl
-00014710: 653d 226d 6172 6769 6e2d 6c65 6674 3a20  e="margin-left: 
-00014720: 3265 6d3b 223e 0a20 2020 2020 2020 2020  2em;">.         
-00014730: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-00014740: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-00014750: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
-00014760: 6967 6874 3a20 626f 6c64 3b22 3e49 6e20  ight: bold;">In 
-00014770: 6d65 6d6f 7279 3a3c 2f73 7061 6e3e 266e  memory:</span>&n
-00014780: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
-00014790: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000147a0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-000147b0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-000147c0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-000147d0: 7370 6163 653b 223e 4069 6e5f 6d65 6d6f  space;">@in_memo
-000147e0: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
-000147f0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00014800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014810: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
-00014820: 6769 6e2d 6c65 6674 3a20 3265 6d3b 223e  gin-left: 2em;">
-00014830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014840: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00014850: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
-00014860: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-00014870: 626f 6c64 3b22 3e45 7272 6564 3a3c 2f73  bold;">Erred:</s
-00014880: 7061 6e3e 266e 6273 703b 0a20 2020 2020  pan>&nbsp;.     
-00014890: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-000148a0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-000148b0: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-000148c0: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-000148d0: 2c20 6d6f 6e6f 7370 6163 653b 223e 4069  , monospace;">@i
-000148e0: 6e5f 6572 7265 643c 2f73 7061 6e3e 0a20  n_erred</span>. 
-000148f0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00014900: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
-00014910: 2020 2020 2020 3c64 6976 2073 7479 6c65        <div style
-00014920: 3d22 6d61 7267 696e 2d6c 6566 743a 2032  ="margin-left: 2
-00014930: 656d 3b22 3e0a 2020 2020 2020 2020 2020  em;">.          
-00014940: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00014950: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00014960: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
-00014970: 6768 743a 2062 6f6c 643b 223e 5265 6c65  ght: bold;">Rele
-00014980: 6173 6564 3a3c 2f73 7061 6e3e 266e 6273  ased:</span>&nbs
-00014990: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-000149a0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-000149b0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-000149c0: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-000149d0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-000149e0: 6163 653b 223e 4069 6e5f 7265 6c65 6173  ace;">@in_releas
-000149f0: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
-00014a00: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00014a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a20: 2022 2222 2c0a 2020 2020 2020 2020 2020   """,.          
-00014a30: 2020 7265 6e64 6572 6572 733d 5b72 6563    renderers=[rec
-00014a40: 745d 2c0a 2020 2020 2020 2020 290a 0a20  t],.        ).. 
-00014a50: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00014a60: 2e61 6464 5f74 6f6f 6c73 2868 6f76 6572  .add_tools(hover
-00014a70: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-00014a80: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-00014a90: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
-00014aa0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
-00014ab0: 7465 5f6c 6179 6f75 7428 7365 6c66 293a  te_layout(self):
-00014ac0: 0a20 2020 2020 2020 2023 2047 6574 2064  .        # Get d
-00014ad0: 6570 656e 6465 6e63 6965 7320 7065 7220  ependencies per 
-00014ae0: 7461 736b 2067 726f 7570 2e0a 2020 2020  task group..    
-00014af0: 2020 2020 2320 496e 2073 6f6d 6520 6361      # In some ca
-00014b00: 7365 7320 7468 6572 6520 6172 6520 7467  ses there are tg
-00014b10: 2074 6861 7420 6861 7665 2074 6865 6d73   that have thems
-00014b20: 656c 7665 7320 6173 2064 6570 656e 6465  elves as depende
-00014b30: 6e63 6965 7320 2d20 7765 2072 656d 6f76  ncies - we remov
-00014b40: 6520 7468 6f73 652e 0a20 2020 2020 2020  e those..       
-00014b50: 2064 6570 656e 6465 6e63 6965 7320 3d20   dependencies = 
-00014b60: 7b0a 2020 2020 2020 2020 2020 2020 6b3a  {.            k:
-00014b70: 207b 6473 2e6e 616d 6520 666f 7220 6473   {ds.name for ds
-00014b80: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-00014b90: 6965 7320 6966 2064 732e 6e61 6d65 2021  ies if ds.name !
-00014ba0: 3d20 6b7d 0a20 2020 2020 2020 2020 2020  = k}.           
-00014bb0: 2066 6f72 206b 2c20 7473 2069 6e20 7365   for k, ts in se
-00014bc0: 6c66 2e73 6368 6564 756c 6572 2e74 6173  lf.scheduler.tas
-00014bd0: 6b5f 6772 6f75 7073 2e69 7465 6d73 2829  k_groups.items()
-00014be0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00014bf0: 2020 2020 696d 706f 7274 2064 6173 6b0a      import dask.
-00014c00: 0a20 2020 2020 2020 206f 7264 6572 203d  .        order =
-00014c10: 2064 6173 6b2e 6f72 6465 722e 6f72 6465   dask.order.orde
-00014c20: 7228 0a20 2020 2020 2020 2020 2020 2064  r(.            d
-00014c30: 736b 3d7b 6772 6f75 702e 6e61 6d65 3a20  sk={group.name: 
-00014c40: 3120 666f 7220 6b2c 2067 726f 7570 2069  1 for k, group i
-00014c50: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-00014c60: 2e74 6173 6b5f 6772 6f75 7073 2e69 7465  .task_groups.ite
-00014c70: 6d73 2829 7d2c 0a20 2020 2020 2020 2020  ms()},.         
-00014c80: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
-00014c90: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
-00014ca0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00014cb0: 206f 7264 6572 6564 203d 2073 6f72 7465   ordered = sorte
-00014cc0: 6428 7365 6c66 2e73 6368 6564 756c 6572  d(self.scheduler
-00014cd0: 2e74 6173 6b5f 6772 6f75 7073 2c20 6b65  .task_groups, ke
-00014ce0: 793d 6f72 6465 722e 6765 7429 0a0a 2020  y=order.get)..  
-00014cf0: 2020 2020 2020 7873 203d 207b 7d0a 2020        xs = {}.  
-00014d00: 2020 2020 2020 7973 203d 207b 7d0a 2020        ys = {}.  
-00014d10: 2020 2020 2020 6c6f 6361 7469 6f6e 7320        locations 
-00014d20: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00014d30: 6e6f 6465 735f 6c61 796f 7574 203d 207b  nodes_layout = {
-00014d40: 7d0a 2020 2020 2020 2020 6172 726f 7773  }.        arrows
-00014d50: 5f6c 6179 6f75 7420 3d20 7b7d 0a20 2020  _layout = {}.   
-00014d60: 2020 2020 2066 6f72 2074 6720 696e 206f       for tg in o
-00014d70: 7264 6572 6564 3a0a 2020 2020 2020 2020  rdered:.        
-00014d80: 2020 2020 6966 2064 6570 656e 6465 6e63      if dependenc
-00014d90: 6965 735b 7467 5d3a 0a20 2020 2020 2020  ies[tg]:.       
-00014da0: 2020 2020 2020 2020 2078 203d 206d 6178           x = max
-00014db0: 2878 735b 6465 705d 2066 6f72 2064 6570  (xs[dep] for dep
-00014dc0: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
-00014dd0: 5b74 675d 2920 2b20 310a 2020 2020 2020  [tg]) + 1.      
-00014de0: 2020 2020 2020 2020 2020 7920 3d20 6d61            y = ma
-00014df0: 7828 7973 5b64 6570 5d20 666f 7220 6465  x(ys[dep] for de
-00014e00: 7020 696e 2064 6570 656e 6465 6e63 6965  p in dependencie
-00014e10: 735b 7467 5d29 0a20 2020 2020 2020 2020  s[tg]).         
-00014e20: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e40: 6c65 6e28 6465 7065 6e64 656e 6369 6573  len(dependencies
-00014e50: 5b74 675d 2920 3e20 310a 2020 2020 2020  [tg]) > 1.      
-00014e60: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00014e70: 6420 6c65 6e28 7b79 735b 6465 705d 2066  d len({ys[dep] f
-00014e80: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
-00014e90: 656e 6369 6573 5b74 675d 7d29 203d 3d20  encies[tg]}) == 
-00014ea0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00014eb0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00014ec0: 2020 2020 2020 2020 2079 202b 3d20 310a           y += 1.
-00014ed0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00014ee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014ef0: 2020 7820 3d20 300a 2020 2020 2020 2020    x = 0.        
-00014f00: 2020 2020 2020 2020 7920 3d20 6d61 7828          y = max(
-00014f10: 7973 2e76 616c 7565 7328 2929 202b 2031  ys.values()) + 1
-00014f20: 2069 6620 7973 2065 6c73 6520 300a 0a20   if ys else 0.. 
-00014f30: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-00014f40: 2028 782c 2079 2920 696e 206c 6f63 6174   (x, y) in locat
-00014f50: 696f 6e73 3a20 2023 2061 766f 6964 2063  ions:  # avoid c
-00014f60: 6f6c 6c69 7369 6f6e 7320 6279 206d 6f76  ollisions by mov
-00014f70: 696e 6720 7570 0a20 2020 2020 2020 2020  ing up.         
-00014f80: 2020 2020 2020 2079 202b 3d20 310a 0a20         y += 1.. 
-00014f90: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
-00014fa0: 696f 6e73 2e61 6464 2828 782c 2079 2929  ions.add((x, y))
-00014fb0: 0a0a 2020 2020 2020 2020 2020 2020 7873  ..            xs
-00014fc0: 5b74 675d 2c20 7973 5b74 675d 203d 2078  [tg], ys[tg] = x
-00014fd0: 2c20 790a 0a20 2020 2020 2020 2020 2020  , y..           
-00014fe0: 2023 2069 6e66 6f20 6e65 6564 6564 2066   # info needed f
-00014ff0: 6f72 206e 6f64 6520 6c61 796f 7574 2074  or node layout t
-00015000: 6f20 636f 6c75 6d6e 2064 6174 6120 736f  o column data so
-00015010: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
-00015020: 206e 6f64 6573 5f6c 6179 6f75 745b 7467   nodes_layout[tg
-00015030: 5d20 3d20 7b22 7822 3a20 7873 5b74 675d  ] = {"x": xs[tg]
-00015040: 2c20 2279 223a 2079 735b 7467 5d7d 0a0a  , "y": ys[tg]}..
-00015050: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-00015060: 666f 206e 6565 6465 6420 666f 7220 6172  fo needed for ar
-00015070: 726f 7720 6c61 796f 7574 0a20 2020 2020  row layout.     
-00015080: 2020 2020 2020 2061 7272 6f77 735f 6c61         arrows_la
-00015090: 796f 7574 5b74 675d 203d 207b 0a20 2020  yout[tg] = {.   
-000150a0: 2020 2020 2020 2020 2020 2020 2022 6e73               "ns
-000150b0: 7461 7274 223a 2064 6570 656e 6465 6e63  tart": dependenc
-000150c0: 6965 735b 7467 5d2c 0a20 2020 2020 2020  ies[tg],.       
-000150d0: 2020 2020 2020 2020 2022 6e65 6e64 223a           "nend":
-000150e0: 205b 7467 5d20 2a20 6c65 6e28 6465 7065   [tg] * len(depe
-000150f0: 6e64 656e 6369 6573 5b74 675d 292c 0a20  ndencies[tg]),. 
-00015100: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00015110: 2020 2020 2020 7265 7475 726e 206e 6f64        return nod
-00015120: 6573 5f6c 6179 6f75 742c 2061 7272 6f77  es_layout, arrow
-00015130: 735f 6c61 796f 7574 0a0a 2020 2020 6465  s_layout..    de
-00015140: 6620 636f 6d70 7574 655f 7369 7a65 2873  f compute_size(s
-00015150: 656c 662c 2078 2c20 6d69 6e5f 626f 782c  elf, x, min_box,
-00015160: 206d 6178 5f62 6f78 293a 0a20 2020 2020   max_box):.     
-00015170: 2020 2073 7461 7274 203d 2030 2e34 0a20     start = 0.4. 
-00015180: 2020 2020 2020 2065 6e64 203d 2030 2e38         end = 0.8
-00015190: 0a0a 2020 2020 2020 2020 7920 3d20 2865  ..        y = (e
-000151a0: 6e64 202d 2073 7461 7274 2920 2f20 286d  nd - start) / (m
-000151b0: 6178 5f62 6f78 202d 206d 696e 5f62 6f78  ax_box - min_box
-000151c0: 2920 2a20 2878 202d 206d 696e 5f62 6f78  ) * (x - min_box
-000151d0: 2920 2b20 7374 6172 740a 0a20 2020 2020  ) + start..     
-000151e0: 2020 2072 6574 7572 6e20 790a 0a20 2020     return y..   
-000151f0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
-00015200: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
-00015210: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
-00015220: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
-00015230: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
-00015240: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00015250: 203d 3d20 7365 6c66 2e6f 6c64 5f63 6f75   == self.old_cou
-00015260: 6e74 6572 3a0a 2020 2020 2020 2020 2020  nter:.          
-00015270: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00015280: 2073 656c 662e 6f6c 645f 636f 756e 7465   self.old_counte
-00015290: 7220 3d20 7365 6c66 2e73 6368 6564 756c  r = self.schedul
-000152a0: 6572 2e74 7261 6e73 6974 696f 6e5f 636f  er.transition_co
-000152b0: 756e 7465 720a 0a20 2020 2020 2020 2069  unter..        i
-000152c0: 6620 6e6f 7420 7365 6c66 2e73 6368 6564  f not self.sched
-000152d0: 756c 6572 2e74 6173 6b5f 6772 6f75 7073  uler.task_groups
-000152e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000152f0: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
-00015300: 203d 2022 5363 6865 6475 6c65 7220 6973   = "Scheduler is
-00015310: 2065 6d70 7479 2e22 0a20 2020 2020 2020   empty.".       
-00015320: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015330: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
-00015340: 2e74 6578 7420 3d20 2220 220a 0a20 2020  .text = " "..   
-00015350: 2020 2020 2069 6620 7365 6c66 2e6e 6f64       if self.nod
-00015360: 6573 5f6c 6179 6f75 742e 6b65 7973 2829  es_layout.keys()
-00015370: 2021 3d20 7365 6c66 2e73 6368 6564 756c   != self.schedul
-00015380: 6572 2e74 6173 6b5f 6772 6f75 7073 2e6b  er.task_groups.k
-00015390: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-000153a0: 2020 2073 656c 662e 6e6f 6465 735f 6c61     self.nodes_la
-000153b0: 796f 7574 2c20 7365 6c66 2e61 7272 6f77  yout, self.arrow
-000153c0: 735f 6c61 796f 7574 203d 2073 656c 662e  s_layout = self.
-000153d0: 7570 6461 7465 5f6c 6179 6f75 7428 290a  update_layout().
-000153e0: 0a20 2020 2020 2020 206e 6f64 6573 5f64  .        nodes_d
-000153f0: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
-00015400: 2020 2020 2278 223a 205b 5d2c 0a20 2020      "x": [],.   
-00015410: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
-00015420: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-00015430: 5f62 6f78 223a 205b 5d2c 0a20 2020 2020  _box": [],.     
-00015440: 2020 2020 2020 2022 685f 626f 7822 3a20         "h_box": 
-00015450: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015460: 226e 616d 6522 3a20 5b5d 2c0a 2020 2020  "name": [],.    
-00015470: 2020 2020 2020 2020 2263 6f6c 6f72 223a          "color":
-00015480: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00015490: 2022 746f 745f 7461 736b 7322 3a20 5b5d   "tot_tasks": []
-000154a0: 2c0a 2020 2020 2020 2020 2020 2020 2278  ,.            "x
-000154b0: 5f73 7461 7274 223a 205b 5d2c 0a20 2020  _start": [],.   
-000154c0: 2020 2020 2020 2020 2022 785f 656e 6422           "x_end"
-000154d0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000154e0: 2020 2279 5f73 7461 7274 223a 205b 5d2c    "y_start": [],
-000154f0: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
-00015500: 656e 6422 3a20 5b5d 2c0a 2020 2020 2020  end": [],.      
-00015510: 2020 2020 2020 2278 5f65 6e64 5f70 726f        "x_end_pro
-00015520: 6772 6573 7322 3a20 5b5d 2c0a 2020 2020  gress": [],.    
-00015530: 2020 2020 2020 2020 226d 656d 5f61 6c70          "mem_alp
-00015540: 6861 223a 205b 5d2c 0a20 2020 2020 2020  ha": [],.       
-00015550: 2020 2020 2022 6e6f 6465 5f6c 696e 655f       "node_line_
-00015560: 7769 6474 6822 3a20 5b5d 2c0a 2020 2020  width": [],.    
-00015570: 2020 2020 2020 2020 2263 6f6d 705f 7461          "comp_ta
-00015580: 736b 7322 3a20 5b5d 2c0a 2020 2020 2020  sks": [],.      
-00015590: 2020 2020 2020 2275 726c 5f6c 6f67 6f22        "url_logo"
-000155a0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000155b0: 2020 2278 5f6c 6f67 6f22 3a20 5b5d 2c0a    "x_logo": [],.
-000155c0: 2020 2020 2020 2020 2020 2020 2279 5f6c              "y_l
-000155d0: 6f67 6f22 3a20 5b5d 2c0a 2020 2020 2020  ogo": [],.      
-000155e0: 2020 2020 2020 2277 5f6c 6f67 6f22 3a20        "w_logo": 
-000155f0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015600: 2268 5f6c 6f67 6f22 3a20 5b5d 2c0a 2020  "h_logo": [],.  
-00015610: 2020 2020 2020 2020 2020 2269 6e5f 7072            "in_pr
-00015620: 6f63 6573 7369 6e67 223a 205b 5d2c 0a20  ocessing": [],. 
-00015630: 2020 2020 2020 2020 2020 2022 696e 5f6d             "in_m
-00015640: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
-00015650: 2020 2020 2020 2020 2269 6e5f 7265 6c65          "in_rele
-00015660: 6173 6564 223a 205b 5d2c 0a20 2020 2020  ased": [],.     
-00015670: 2020 2020 2020 2022 696e 5f65 7272 6564         "in_erred
-00015680: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015690: 2020 2022 636f 6d70 7574 655f 7469 6d65     "compute_time
-000156a0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000156b0: 2020 2022 6d65 6d6f 7279 223a 205b 5d2c     "memory": [],
-000156c0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000156d0: 2020 2020 6172 726f 7773 5f64 6174 6120      arrows_data 
-000156e0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-000156f0: 2278 7322 3a20 5b5d 2c0a 2020 2020 2020  "xs": [],.      
-00015700: 2020 2020 2020 2279 7322 3a20 5b5d 2c0a        "ys": [],.
-00015710: 2020 2020 2020 2020 2020 2020 2278 6522              "xe"
-00015720: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00015730: 2020 2279 6522 3a20 5b5d 2c0a 2020 2020    "ye": [],.    
-00015740: 2020 2020 7d0a 0a20 2020 2020 2020 2064      }..        d
-00015750: 7572 6174 696f 6e73 203d 2073 6574 2829  urations = set()
-00015760: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
-00015770: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00015780: 666f 7220 7467 2069 6e20 7365 6c66 2e73  for tg in self.s
-00015790: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
-000157a0: 6f75 7073 2e76 616c 7565 7328 293a 0a20  oups.values():. 
-000157b0: 2020 2020 2020 2020 2020 2069 6620 7467             if tg
-000157c0: 2e64 7572 6174 696f 6e20 616e 6420 7467  .duration and tg
-000157d0: 2e6e 6279 7465 735f 746f 7461 6c3a 0a20  .nbytes_total:. 
-000157e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000157f0: 7572 6174 696f 6e73 2e61 6464 2874 672e  urations.add(tg.
-00015800: 6475 7261 7469 6f6e 290a 2020 2020 2020  duration).      
-00015810: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
-00015820: 2e61 6464 2874 672e 6e62 7974 6573 5f74  .add(tg.nbytes_t
-00015830: 6f74 616c 290a 0a20 2020 2020 2020 2064  otal)..        d
-00015840: 7572 6174 696f 6e73 5f6d 696e 203d 206d  urations_min = m
-00015850: 696e 2864 7572 6174 696f 6e73 2c20 6465  in(durations, de
-00015860: 6661 756c 743d 3029 0a20 2020 2020 2020  fault=0).       
-00015870: 2064 7572 6174 696f 6e73 5f6d 6178 203d   durations_max =
-00015880: 206d 6178 2864 7572 6174 696f 6e73 2c20   max(durations, 
-00015890: 6465 6661 756c 743d 3029 0a20 2020 2020  default=0).     
-000158a0: 2020 206e 6279 7465 735f 6d69 6e20 3d20     nbytes_min = 
-000158b0: 6d69 6e28 6e62 7974 6573 2c20 6465 6661  min(nbytes, defa
-000158c0: 756c 743d 3029 0a20 2020 2020 2020 206e  ult=0).        n
-000158d0: 6279 7465 735f 6d61 7820 3d20 6d61 7828  bytes_max = max(
-000158e0: 6e62 7974 6573 2c20 6465 6661 756c 743d  nbytes, default=
-000158f0: 3029 0a0a 2020 2020 2020 2020 626f 785f  0)..        box_
-00015900: 6469 6d20 3d20 7b7d 0a20 2020 2020 2020  dim = {}.       
-00015910: 2066 6f72 206b 6579 2c20 7467 2069 6e20   for key, tg in 
-00015920: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
-00015930: 6173 6b5f 6772 6f75 7073 2e69 7465 6d73  ask_groups.items
-00015940: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00015950: 636f 6d70 5f74 6173 6b73 203d 2028 0a20  comp_tasks = (. 
-00015960: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015970: 672e 7374 6174 6573 5b22 7265 6c65 6173  g.states["releas
-00015980: 6564 225d 202b 2074 672e 7374 6174 6573  ed"] + tg.states
-00015990: 5b22 6d65 6d6f 7279 225d 202b 2074 672e  ["memory"] + tg.
-000159a0: 7374 6174 6573 5b22 6572 7265 6422 5d0a  states["erred"].
-000159b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000159c0: 2020 2020 2020 2020 2020 746f 745f 7461            tot_ta
-000159d0: 736b 7320 3d20 7375 6d28 7467 2e73 7461  sks = sum(tg.sta
-000159e0: 7465 732e 7661 6c75 6573 2829 290a 0a20  tes.values()).. 
-000159f0: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
-00015a00: 7075 7465 2077 6964 7468 2061 6e64 2068  pute width and h
-00015a10: 6569 6768 7420 6f66 2062 6f78 6573 0a20  eight of boxes. 
-00015a20: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
-00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a40: 7467 2e64 7572 6174 696f 6e0a 2020 2020  tg.duration.    
-00015a50: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00015a60: 7467 2e6e 6279 7465 735f 746f 7461 6c0a  tg.nbytes_total.
-00015a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a80: 616e 6420 636f 6d70 5f74 6173 6b73 0a20  and comp_tasks. 
-00015a90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00015aa0: 6e64 206c 656e 2864 7572 6174 696f 6e73  nd len(durations
-00015ab0: 2920 3e20 310a 2020 2020 2020 2020 2020  ) > 1.          
-00015ac0: 2020 2020 2020 616e 6420 6c65 6e28 6e62        and len(nb
-00015ad0: 7974 6573 2920 3e20 310a 2020 2020 2020  ytes) > 1.      
-00015ae0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00015af0: 2020 2020 2020 2020 2023 2073 6361 6c65           # scale
-00015b00: 2064 7572 6174 696f 6e20 2877 6964 7468   duration (width
-00015b10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015b20: 2020 7769 6474 685f 626f 7820 3d20 7365    width_box = se
-00015b30: 6c66 2e63 6f6d 7075 7465 5f73 697a 6528  lf.compute_size(
-00015b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b50: 2020 2020 2074 672e 6475 7261 7469 6f6e       tg.duration
-00015b60: 202f 2063 6f6d 705f 7461 736b 7320 2a20   / comp_tasks * 
-00015b70: 746f 745f 7461 736b 732c 0a20 2020 2020  tot_tasks,.     
-00015b80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00015b90: 696e 5f62 6f78 3d64 7572 6174 696f 6e73  in_box=durations
-00015ba0: 5f6d 696e 202f 2063 6f6d 705f 7461 736b  _min / comp_task
-00015bb0: 7320 2a20 746f 745f 7461 736b 732c 0a20  s * tot_tasks,. 
-00015bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bd0: 2020 206d 6178 5f62 6f78 3d64 7572 6174     max_box=durat
-00015be0: 696f 6e73 5f6d 6178 202f 2063 6f6d 705f  ions_max / comp_
-00015bf0: 7461 736b 7320 2a20 746f 745f 7461 736b  tasks * tot_task
-00015c00: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00015c10: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00015c20: 2020 2020 2020 2320 6e65 6564 2074 6f20        # need to 
-00015c30: 7363 616c 6520 6d65 6d6f 7279 2028 6865  scale memory (he
-00015c40: 6967 6874 290a 2020 2020 2020 2020 2020  ight).          
-00015c50: 2020 2020 2020 6865 6967 6874 5f62 6f78        height_box
-00015c60: 203d 2073 656c 662e 636f 6d70 7574 655f   = self.compute_
-00015c70: 7369 7a65 280a 2020 2020 2020 2020 2020  size(.          
-00015c80: 2020 2020 2020 2020 2020 7467 2e6e 6279            tg.nby
-00015c90: 7465 735f 746f 7461 6c20 2f20 636f 6d70  tes_total / comp
-00015ca0: 5f74 6173 6b73 202a 2074 6f74 5f74 6173  _tasks * tot_tas
-00015cb0: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
-00015cc0: 2020 2020 2020 2020 6d69 6e5f 626f 783d          min_box=
-00015cd0: 6e62 7974 6573 5f6d 696e 202f 2063 6f6d  nbytes_min / com
-00015ce0: 705f 7461 736b 7320 2a20 746f 745f 7461  p_tasks * tot_ta
-00015cf0: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
-00015d00: 2020 2020 2020 2020 206d 6178 5f62 6f78           max_box
-00015d10: 3d6e 6279 7465 735f 6d61 7820 2f20 636f  =nbytes_max / co
-00015d20: 6d70 5f74 6173 6b73 202a 2074 6f74 5f74  mp_tasks * tot_t
-00015d30: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00015d40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00015d50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00015d60: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00015d70: 5f62 6f78 203d 2030 2e36 0a20 2020 2020  _box = 0.6.     
-00015d80: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-00015d90: 745f 626f 7820 3d20 7769 6474 685f 626f  t_box = width_bo
-00015da0: 7820 2f20 320a 0a20 2020 2020 2020 2020  x / 2..         
-00015db0: 2020 2062 6f78 5f64 696d 5b6b 6579 5d20     box_dim[key] 
-00015dc0: 3d20 7b22 7769 6474 6822 3a20 7769 6474  = {"width": widt
-00015dd0: 685f 626f 782c 2022 6865 6967 6874 223a  h_box, "height":
-00015de0: 2068 6569 6768 745f 626f 787d 0a0a 2020   height_box}..  
-00015df0: 2020 2020 2020 666f 7220 6b65 792c 2074        for key, t
-00015e00: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
-00015e10: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
-00015e20: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00015e30: 2020 2020 2078 203d 2073 656c 662e 6e6f       x = self.no
-00015e40: 6465 735f 6c61 796f 7574 5b6b 6579 5d5b  des_layout[key][
-00015e50: 2278 225d 0a20 2020 2020 2020 2020 2020  "x"].           
-00015e60: 2079 203d 2073 656c 662e 6e6f 6465 735f   y = self.nodes_
-00015e70: 6c61 796f 7574 5b6b 6579 5d5b 2279 225d  layout[key]["y"]
-00015e80: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-00015e90: 7468 203d 2062 6f78 5f64 696d 5b6b 6579  th = box_dim[key
-00015ea0: 5d5b 2277 6964 7468 225d 0a20 2020 2020  ]["width"].     
-00015eb0: 2020 2020 2020 2068 6569 6768 7420 3d20         height = 
-00015ec0: 626f 785f 6469 6d5b 6b65 795d 5b22 6865  box_dim[key]["he
-00015ed0: 6967 6874 225d 0a0a 2020 2020 2020 2020  ight"]..        
-00015ee0: 2020 2020 2320 6d61 696e 2062 6f78 6573      # main boxes
-00015ef0: 206c 6179 6f75 740a 2020 2020 2020 2020   layout.        
-00015f00: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-00015f10: 7822 5d2e 6170 7065 6e64 2878 290a 2020  x"].append(x).  
-00015f20: 2020 2020 2020 2020 2020 6e6f 6465 735f            nodes_
-00015f30: 6461 7461 5b22 7922 5d2e 6170 7065 6e64  data["y"].append
-00015f40: 2879 290a 2020 2020 2020 2020 2020 2020  (y).            
-00015f50: 6e6f 6465 735f 6461 7461 5b22 775f 626f  nodes_data["w_bo
-00015f60: 7822 5d2e 6170 7065 6e64 2877 6964 7468  x"].append(width
-00015f70: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-00015f80: 6465 735f 6461 7461 5b22 685f 626f 7822  des_data["h_box"
-00015f90: 5d2e 6170 7065 6e64 2868 6569 6768 7429  ].append(height)
-00015fa0: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-00015fb0: 6d70 5f74 6173 6b73 203d 2028 0a20 2020  mp_tasks = (.   
-00015fc0: 2020 2020 2020 2020 2020 2020 2074 672e               tg.
-00015fd0: 7374 6174 6573 5b22 7265 6c65 6173 6564  states["released
-00015fe0: 225d 202b 2074 672e 7374 6174 6573 5b22  "] + tg.states["
-00015ff0: 6d65 6d6f 7279 225d 202b 2074 672e 7374  memory"] + tg.st
-00016000: 6174 6573 5b22 6572 7265 6422 5d0a 2020  ates["erred"].  
-00016010: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00016020: 2020 2020 2020 2020 746f 745f 7461 736b          tot_task
-00016030: 7320 3d20 7375 6d28 7467 2e73 7461 7465  s = sum(tg.state
-00016040: 732e 7661 6c75 6573 2829 290a 0a20 2020  s.values())..   
-00016050: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016060: 6174 615b 226e 616d 6522 5d2e 6170 7065  ata["name"].appe
-00016070: 6e64 2874 672e 7072 6566 6978 2e6e 616d  nd(tg.prefix.nam
-00016080: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-00016090: 6e6f 6465 735f 6461 7461 5b22 636f 6c6f  nodes_data["colo
-000160a0: 7222 5d2e 6170 7065 6e64 2863 6f6c 6f72  r"].append(color
-000160b0: 5f6f 6628 7467 2e70 7265 6669 782e 6e61  _of(tg.prefix.na
-000160c0: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
-000160d0: 206e 6f64 6573 5f64 6174 615b 2274 6f74   nodes_data["tot
-000160e0: 5f74 6173 6b73 225d 2e61 7070 656e 6428  _tasks"].append(
-000160f0: 746f 745f 7461 736b 7329 0a0a 2020 2020  tot_tasks)..    
-00016100: 2020 2020 2020 2020 2320 6d65 6d6f 7279          # memory
-00016110: 2061 6c70 6861 2066 6163 746f 7220 6279   alpha factor by
-00016120: 2030 2e34 2069 6620 6e6f 7420 6765 7427   0.4 if not get'
-00016130: 7320 746f 6f20 6461 726b 0a20 2020 2020  s too dark.     
-00016140: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
-00016150: 615b 226d 656d 5f61 6c70 6861 225d 2e61  a["mem_alpha"].a
-00016160: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00016170: 2020 2020 2020 2028 7467 2e73 7461 7465         (tg.state
-00016180: 735b 226d 656d 6f72 7922 5d20 2f20 7375  s["memory"] / su
-00016190: 6d28 7467 2e73 7461 7465 732e 7661 6c75  m(tg.states.valu
-000161a0: 6573 2829 2929 202a 2030 2e34 0a20 2020  es())) * 0.4.   
-000161b0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000161c0: 2020 2020 2020 2020 2320 6d61 696e 2062          # main b
-000161d0: 6f78 206c 696e 6520 7769 6474 680a 2020  ox line width.  
-000161e0: 2020 2020 2020 2020 2020 6966 2074 672e            if tg.
-000161f0: 7374 6174 6573 5b22 7072 6f63 6573 7369  states["processi
-00016200: 6e67 225d 3a0a 2020 2020 2020 2020 2020  ng"]:.          
-00016210: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016220: 5b22 6e6f 6465 5f6c 696e 655f 7769 6474  ["node_line_widt
-00016230: 6822 5d2e 6170 7065 6e64 2835 290a 2020  h"].append(5).  
-00016240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016260: 6e6f 6465 735f 6461 7461 5b22 6e6f 6465  nodes_data["node
-00016270: 5f6c 696e 655f 7769 6474 6822 5d2e 6170  _line_width"].ap
-00016280: 7065 6e64 2831 290a 0a20 2020 2020 2020  pend(1)..       
-00016290: 2020 2020 2023 2070 726f 6772 6573 7320       # progress 
-000162a0: 6261 7220 6461 7461 2075 7064 6174 650a  bar data update.
-000162b0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000162c0: 735f 6461 7461 5b22 785f 7374 6172 7422  s_data["x_start"
-000162d0: 5d2e 6170 7065 6e64 2878 202d 2077 6964  ].append(x - wid
-000162e0: 7468 202f 2032 290a 2020 2020 2020 2020  th / 2).        
-000162f0: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-00016300: 785f 656e 6422 5d2e 6170 7065 6e64 2878  x_end"].append(x
-00016310: 202b 2077 6964 7468 202f 2032 290a 0a20   + width / 2).. 
-00016320: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016330: 5f64 6174 615b 2279 5f73 7461 7274 225d  _data["y_start"]
-00016340: 2e61 7070 656e 6428 7920 2d20 6865 6967  .append(y - heig
-00016350: 6874 202f 2032 290a 2020 2020 2020 2020  ht / 2).        
-00016360: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-00016370: 795f 656e 6422 5d2e 6170 7065 6e64 2879  y_end"].append(y
-00016380: 202d 2068 6569 6768 7420 2f20 3220 2b20   - height / 2 + 
-00016390: 6865 6967 6874 202a 2030 2e34 290a 0a20  height * 0.4).. 
-000163a0: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-000163b0: 5f64 6174 615b 2278 5f65 6e64 5f70 726f  _data["x_end_pro
-000163c0: 6772 6573 7322 5d2e 6170 7065 6e64 280a  gress"].append(.
-000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163e0: 7820 2d20 7769 6474 6820 2f20 3220 2b20  x - width / 2 + 
-000163f0: 7769 6474 6820 2a20 636f 6d70 5f74 6173  width * comp_tas
-00016400: 6b73 202f 2074 6f74 5f74 6173 6b73 0a20  ks / tot_tasks. 
-00016410: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00016420: 2020 2020 2020 2020 2020 2320 6172 726f            # arro
-00016430: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
-00016440: 7272 6f77 735f 6461 7461 5b22 7873 225d  rrows_data["xs"]
-00016450: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
-00016460: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
-00016470: 5f6c 6179 6f75 745b 6b5d 5b22 7822 5d20  _layout[k]["x"] 
-00016480: 2b20 626f 785f 6469 6d5b 6b5d 5b22 7769  + box_dim[k]["wi
-00016490: 6474 6822 5d20 2f20 320a 2020 2020 2020  dth"] / 2.      
-000164a0: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
-000164b0: 696e 2073 656c 662e 6172 726f 7773 5f6c  in self.arrows_l
-000164c0: 6179 6f75 745b 6b65 795d 5b22 6e73 7461  ayout[key]["nsta
-000164d0: 7274 225d 0a20 2020 2020 2020 2020 2020  rt"].           
-000164e0: 205d 0a20 2020 2020 2020 2020 2020 2061   ].            a
-000164f0: 7272 6f77 735f 6461 7461 5b22 7973 225d  rrows_data["ys"]
-00016500: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
-00016510: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
-00016520: 5f6c 6179 6f75 745b 6b5d 5b22 7922 5d20  _layout[k]["y"] 
-00016530: 666f 7220 6b20 696e 2073 656c 662e 6172  for k in self.ar
-00016540: 726f 7773 5f6c 6179 6f75 745b 6b65 795d  rows_layout[key]
-00016550: 5b22 6e73 7461 7274 225d 0a20 2020 2020  ["nstart"].     
-00016560: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00016570: 2020 2020 2061 7272 6f77 735f 6461 7461       arrows_data
-00016580: 5b22 7865 225d 202b 3d20 5b0a 2020 2020  ["xe"] += [.    
-00016590: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000165a0: 2e6e 6f64 6573 5f6c 6179 6f75 745b 6b5d  .nodes_layout[k]
-000165b0: 5b22 7822 5d20 2d20 626f 785f 6469 6d5b  ["x"] - box_dim[
-000165c0: 6b5d 5b22 7769 6474 6822 5d20 2f20 320a  k]["width"] / 2.
-000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165e0: 666f 7220 6b20 696e 2073 656c 662e 6172  for k in self.ar
-000165f0: 726f 7773 5f6c 6179 6f75 745b 6b65 795d  rows_layout[key]
-00016600: 5b22 6e65 6e64 225d 0a20 2020 2020 2020  ["nend"].       
-00016610: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00016620: 2020 2061 7272 6f77 735f 6461 7461 5b22     arrows_data["
-00016630: 7965 225d 202b 3d20 5b0a 2020 2020 2020  ye"] += [.      
-00016640: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-00016650: 6f64 6573 5f6c 6179 6f75 745b 6b5d 5b22  odes_layout[k]["
-00016660: 7922 5d20 666f 7220 6b20 696e 2073 656c  y"] for k in sel
-00016670: 662e 6172 726f 7773 5f6c 6179 6f75 745b  f.arrows_layout[
-00016680: 6b65 795d 5b22 6e65 6e64 225d 0a20 2020  key]["nend"].   
-00016690: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-000166a0: 2020 2020 2020 2020 2320 4c4f 474f 530a          # LOGOS.
-000166b0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000166c0: 656e 2874 672e 7479 7065 7329 203d 3d20  en(tg.types) == 
-000166d0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-000166e0: 2020 206c 6f67 6f5f 7479 7065 203d 206e     logo_type = n
-000166f0: 6578 7428 6974 6572 2874 672e 7479 7065  ext(iter(tg.type
-00016700: 7329 292e 7370 6c69 7428 222e 2229 5b30  s)).split(".")[0
-00016710: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00016720: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00016730: 2020 2020 2020 2020 2020 2075 726c 5f6c             url_l
-00016740: 6f67 6f20 3d20 6c6f 676f 735f 6469 6374  ogo = logos_dict
-00016750: 5b6c 6f67 6f5f 7479 7065 5d0a 2020 2020  [logo_type].    
-00016760: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00016770: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016790: 2075 726c 5f6c 6f67 6f20 3d20 2222 0a20   url_logo = "". 
-000167a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000167b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000167c0: 2075 726c 5f6c 6f67 6f20 3d20 2222 0a0a   url_logo = ""..
-000167d0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000167e0: 735f 6461 7461 5b22 7572 6c5f 6c6f 676f  s_data["url_logo
-000167f0: 225d 2e61 7070 656e 6428 7572 6c5f 6c6f  "].append(url_lo
-00016800: 676f 290a 0a20 2020 2020 2020 2020 2020  go)..           
-00016810: 206e 6f64 6573 5f64 6174 615b 2278 5f6c   nodes_data["x_l
-00016820: 6f67 6f22 5d2e 6170 7065 6e64 2878 202b  ogo"].append(x +
-00016830: 2077 6964 7468 202f 2033 290a 2020 2020   width / 3).    
-00016840: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00016850: 7461 5b22 795f 6c6f 676f 225d 2e61 7070  ta["y_logo"].app
-00016860: 656e 6428 7920 2b20 6865 6967 6874 202f  end(y + height /
-00016870: 2033 290a 0a20 2020 2020 2020 2020 2020   3)..           
-00016880: 2072 6174 696f 203d 2077 6964 7468 202f   ratio = width /
-00016890: 2068 6569 6768 740a 0a20 2020 2020 2020   height..       
-000168a0: 2020 2020 2069 6620 7261 7469 6f20 3e20       if ratio > 
-000168b0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-000168c0: 2020 206e 6f64 6573 5f64 6174 615b 2268     nodes_data["h
-000168d0: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2868  _logo"].append(h
-000168e0: 6569 6768 7420 2a20 302e 3329 0a20 2020  eight * 0.3).   
-000168f0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00016900: 6573 5f64 6174 615b 2277 5f6c 6f67 6f22  es_data["w_logo"
-00016910: 5d2e 6170 7065 6e64 2877 6964 7468 202a  ].append(width *
-00016920: 2030 2e33 202f 2072 6174 696f 290a 2020   0.3 / ratio).  
-00016930: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 6e6f 6465 735f 6461 7461 5b22 685f 6c6f  nodes_data["h_lo
-00016960: 676f 225d 2e61 7070 656e 6428 6865 6967  go"].append(heig
-00016970: 6874 202a 2030 2e33 202a 2072 6174 696f  ht * 0.3 * ratio
-00016980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016990: 2020 6e6f 6465 735f 6461 7461 5b22 775f    nodes_data["w_
-000169a0: 6c6f 676f 225d 2e61 7070 656e 6428 7769  logo"].append(wi
-000169b0: 6474 6820 2a20 302e 3329 0a0a 2020 2020  dth * 0.3)..    
-000169c0: 2020 2020 2020 2020 2320 636f 6d70 7574          # comput
-000169d0: 655f 7469 6d65 2061 6e64 206d 656d 6f72  e_time and memor
-000169e0: 790a 2020 2020 2020 2020 2020 2020 6e6f  y.            no
-000169f0: 6465 735f 6461 7461 5b22 636f 6d70 7574  des_data["comput
-00016a00: 655f 7469 6d65 225d 2e61 7070 656e 6428  e_time"].append(
-00016a10: 666f 726d 6174 5f74 696d 6528 7467 2e64  format_time(tg.d
-00016a20: 7572 6174 696f 6e29 290a 2020 2020 2020  uration)).      
-00016a30: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016a40: 5b22 6d65 6d6f 7279 225d 2e61 7070 656e  ["memory"].appen
-00016a50: 6428 666f 726d 6174 5f62 7974 6573 2874  d(format_bytes(t
-00016a60: 672e 6e62 7974 6573 5f74 6f74 616c 2929  g.nbytes_total))
-00016a70: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00016a80: 4164 6420 736f 6d65 2073 7461 7475 7320  Add some status 
-00016a90: 746f 2068 6f76 6572 0a20 2020 2020 2020  to hover.       
-00016aa0: 2020 2020 2074 6173 6b73 5f70 726f 6365       tasks_proce
-00016ab0: 7373 696e 6720 3d20 7467 2e73 7461 7465  ssing = tg.state
-00016ac0: 735b 2270 726f 6365 7373 696e 6722 5d0a  s["processing"].
-00016ad0: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00016ae0: 735f 6d65 6d6f 7279 203d 2074 672e 7374  s_memory = tg.st
-00016af0: 6174 6573 5b22 6d65 6d6f 7279 225d 0a20  ates["memory"]. 
-00016b00: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-00016b10: 5f72 656c 6173 6564 203d 2074 672e 7374  _relased = tg.st
-00016b20: 6174 6573 5b22 7265 6c65 6173 6564 225d  ates["released"]
-00016b30: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00016b40: 6b73 5f65 7272 6564 203d 2074 672e 7374  ks_erred = tg.st
-00016b50: 6174 6573 5b22 6572 7265 6422 5d0a 0a20  ates["erred"].. 
-00016b60: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016b70: 5f64 6174 615b 2263 6f6d 705f 7461 736b  _data["comp_task
-00016b80: 7322 5d2e 6170 7065 6e64 280a 2020 2020  s"].append(.    
-00016b90: 2020 2020 2020 2020 2020 2020 6622 7b63              f"{c
-00016ba0: 6f6d 705f 7461 736b 737d 2028 7b63 6f6d  omp_tasks} ({com
-00016bb0: 705f 7461 736b 7320 2f20 746f 745f 7461  p_tasks / tot_ta
-00016bc0: 736b 7320 2a20 3130 303a 2e30 667d 2025  sks * 100:.0f} %
-00016bd0: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
-00016be0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00016bf0: 6573 5f64 6174 615b 2269 6e5f 7072 6f63  es_data["in_proc
-00016c00: 6573 7369 6e67 225d 2e61 7070 656e 6428  essing"].append(
-00016c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016c20: 2066 227b 7461 736b 735f 7072 6f63 6573   f"{tasks_proces
-00016c30: 7369 6e67 7d20 287b 7461 736b 735f 7072  sing} ({tasks_pr
-00016c40: 6f63 6573 7369 6e67 2f20 746f 745f 7461  ocessing/ tot_ta
-00016c50: 736b 7320 2a20 3130 303a 2e30 667d 2025  sks * 100:.0f} %
-00016c60: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
-00016c70: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00016c80: 6573 5f64 6174 615b 2269 6e5f 6d65 6d6f  es_data["in_memo
-00016c90: 7279 225d 2e61 7070 656e 6428 0a20 2020  ry"].append(.   
-00016ca0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00016cb0: 7461 736b 735f 6d65 6d6f 7279 7d20 287b  tasks_memory} ({
-00016cc0: 7461 736b 735f 6d65 6d6f 7279 2f20 746f  tasks_memory/ to
-00016cd0: 745f 7461 736b 7320 2a20 3130 303a 2e30  t_tasks * 100:.0
-00016ce0: 667d 2025 2922 0a20 2020 2020 2020 2020  f} %)".         
-00016cf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00016d00: 206e 6f64 6573 5f64 6174 615b 2269 6e5f   nodes_data["in_
-00016d10: 7265 6c65 6173 6564 225d 2e61 7070 656e  released"].appen
-00016d20: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00016d30: 2020 2066 227b 7461 736b 735f 7265 6c61     f"{tasks_rela
-00016d40: 7365 647d 2028 7b74 6173 6b73 5f72 656c  sed} ({tasks_rel
-00016d50: 6173 6564 2f20 746f 745f 7461 736b 7320  ased/ tot_tasks 
-00016d60: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
-00016d70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00016d80: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016d90: 6174 615b 2269 6e5f 6572 7265 6422 5d2e  ata["in_erred"].
-00016da0: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-00016db0: 2020 2020 2020 2020 6622 7b20 7461 736b          f"{ task
-00016dc0: 735f 6572 7265 647d 2028 7b74 6173 6b73  s_erred} ({tasks
-00016dd0: 5f65 7272 6564 2f20 746f 745f 7461 736b  _erred/ tot_task
-00016de0: 7320 2a20 3130 303a 2e30 667d 2025 2922  s * 100:.0f} %)"
-00016df0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00016e00: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
-00016e10: 6573 5f73 6f75 7263 652e 6461 7461 2e75  es_source.data.u
-00016e20: 7064 6174 6528 6e6f 6465 735f 6461 7461  pdate(nodes_data
-00016e30: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00016e40: 7272 6f77 735f 736f 7572 6365 2e64 6174  rrows_source.dat
-00016e50: 612e 7570 6461 7465 2861 7272 6f77 735f  a.update(arrows_
-00016e60: 6461 7461 290a 0a0a 636c 6173 7320 5461  data)...class Ta
-00016e70: 736b 4772 6f75 7050 726f 6772 6573 7328  skGroupProgress(
-00016e80: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-00016e90: 6e74 293a 0a20 2020 2022 2222 5374 6163  nt):.    """Stac
-00016ea0: 6b65 6420 6172 6561 2063 6861 7274 2073  ked area chart s
-00016eb0: 686f 7769 6e67 2074 6173 6b20 6772 6f75  howing task grou
-00016ec0: 7073 2074 6872 6f75 6768 2074 696d 6522  ps through time"
-00016ed0: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-00016ee0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
-00016ef0: 756c 6572 2c20 2a2a 6b77 6172 6773 293a  uler, **kwargs):
-00016f00: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-00016f10: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
-00016f20: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
-00016f30: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
-00016f40: 4461 7461 536f 7572 6365 2829 0a20 2020  DataSource().   
-00016f50: 2020 2020 2023 2054 6865 206c 656e 6774       # The lengt
-00016f60: 6820 6f66 2074 696d 6573 6572 6965 7320  h of timeseries 
-00016f70: 746f 2063 6861 7274 2028 696e 2075 6e69  to chart (in uni
-00016f80: 7473 206f 6620 706c 7567 696e 2e64 7429  ts of plugin.dt)
-00016f90: 0a20 2020 2020 2020 2073 656c 662e 6e70  .        self.np
-00016fa0: 7473 203d 2031 3830 0a0a 2020 2020 2020  ts = 180..      
-00016fb0: 2020 6966 2047 726f 7570 5469 6d69 6e67    if GroupTiming
-00016fc0: 2e6e 616d 6520 6e6f 7420 696e 2073 6368  .name not in sch
-00016fd0: 6564 756c 6572 2e70 6c75 6769 6e73 3a0a  eduler.plugins:.
-00016fe0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-00016ff0: 6475 6c65 722e 6164 645f 706c 7567 696e  duler.add_plugin
-00017000: 2870 6c75 6769 6e3d 4772 6f75 7054 696d  (plugin=GroupTim
-00017010: 696e 6728 7363 6865 6475 6c65 7229 290a  ing(scheduler)).
-00017020: 0a20 2020 2020 2020 2073 656c 662e 706c  .        self.pl
-00017030: 7567 696e 203d 2073 6368 6564 756c 6572  ugin = scheduler
-00017040: 2e70 6c75 6769 6e73 5b47 726f 7570 5469  .plugins[GroupTi
-00017050: 6d69 6e67 2e6e 616d 655d 0a0a 2020 2020  ming.name]..    
-00017060: 2020 2020 7365 6c66 2e73 6f75 7263 652e      self.source.
-00017070: 6164 6428 6e70 2e61 7272 6179 2873 656c  add(np.array(sel
-00017080: 662e 706c 7567 696e 2e74 696d 6529 202a  f.plugin.time) *
-00017090: 2031 3030 302e 302c 2022 7469 6d65 2229   1000.0, "time")
-000170a0: 0a0a 2020 2020 2020 2020 785f 7261 6e67  ..        x_rang
-000170b0: 6520 3d20 4461 7461 5261 6e67 6531 6428  e = DataRange1d(
-000170c0: 7261 6e67 655f 7061 6464 696e 673d 3029  range_padding=0)
-000170d0: 0a20 2020 2020 2020 2079 5f72 616e 6765  .        y_range
-000170e0: 203d 2052 616e 6765 3164 2830 2c20 6d61   = Range1d(0, ma
-000170f0: 7828 7365 6c66 2e70 6c75 6769 6e2e 6e74  x(self.plugin.nt
-00017100: 6872 6561 6473 2929 0a0a 2020 2020 2020  hreads))..      
-00017110: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00017120: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
-00017130: 2020 7469 746c 653d 2254 6173 6b20 4772    title="Task Gr
-00017140: 6f75 7020 5072 6f67 7265 7373 222c 0a20  oup Progress",. 
-00017150: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00017160: 2274 6173 6b5f 6772 6f75 705f 7072 6f67  "task_group_prog
-00017170: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
-00017180: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
-00017190: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
-000171a0: 2020 2020 2020 2020 206d 696e 5f62 6f72           min_bor
-000171b0: 6465 725f 626f 7474 6f6d 3d35 302c 0a20  der_bottom=50,. 
-000171c0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-000171d0: 6765 3d78 5f72 616e 6765 2c0a 2020 2020  ge=x_range,.    
-000171e0: 2020 2020 2020 2020 795f 7261 6e67 653d          y_range=
-000171f0: 795f 7261 6e67 652c 0a20 2020 2020 2020  y_range,.       
-00017200: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
-00017210: 2020 2020 2020 2020 2020 2078 5f61 7869             x_axi
-00017220: 735f 7479 7065 3d22 6461 7465 7469 6d65  s_type="datetime
-00017230: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-00017240: 5f61 7869 735f 6c6f 6361 7469 6f6e 3d4e  _axis_location=N
-00017250: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00017260: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00017270: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00017280: 662e 726f 6f74 2e79 6178 6973 2e6d 616a  f.root.yaxis.maj
-00017290: 6f72 5f6c 6162 656c 5f74 6578 745f 616c  or_label_text_al
-000172a0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-000172b0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
-000172c0: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
-000172d0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-000172e0: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
-000172f0: 732e 6d61 6a6f 725f 7469 636b 5f6c 696e  s.major_tick_lin
-00017300: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00017310: 2020 2020 7365 6c66 2e72 6f6f 742e 7867      self.root.xg
-00017320: 7269 642e 7669 7369 626c 6520 3d20 4661  rid.visible = Fa
-00017330: 6c73 650a 0a20 2020 2020 2020 2073 656c  lse..        sel
-00017340: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
-00017350: 280a 2020 2020 2020 2020 2020 2020 426f  (.            Bo
-00017360: 785a 6f6f 6d54 6f6f 6c28 292c 0a20 2020  xZoomTool(),.   
-00017370: 2020 2020 2020 2020 2052 6573 6574 546f           ResetTo
-00017380: 6f6c 2829 2c0a 2020 2020 2020 2020 2020  ol(),.          
-00017390: 2020 5061 6e54 6f6f 6c28 6469 6d65 6e73    PanTool(dimens
-000173a0: 696f 6e73 3d22 7769 6474 6822 292c 0a20  ions="width"),. 
-000173b0: 2020 2020 2020 2020 2020 2057 6865 656c             Wheel
-000173c0: 5a6f 6f6d 546f 6f6c 2864 696d 656e 7369  ZoomTool(dimensi
-000173d0: 6f6e 733d 2277 6964 7468 2229 2c0a 2020  ons="width"),.  
-000173e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000173f0: 7365 6c66 2e5f 686f 7665 7220 3d20 4e6f  self._hover = No
-00017400: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00017410: 5f6c 6173 745f 6472 6177 6e20 3d20 4e6f  _last_drawn = No
-00017420: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00017430: 5f6f 6666 7365 7420 3d20 7469 6d65 2829  _offset = time()
-00017440: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-00017450: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
-00017460: 6f75 6e74 203d 2073 6368 6564 756c 6572  ount = scheduler
-00017470: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-00017480: 7465 720a 2020 2020 2020 2020 2320 4f72  ter.        # Or
-00017490: 6465 7265 6444 6963 7420 736f 2077 6520  deredDict so we 
-000174a0: 6361 6e20 6d61 6b65 2061 2072 6576 6572  can make a rever
-000174b0: 7365 2069 7465 7261 746f 7220 6c61 7465  se iterator late
-000174c0: 7220 616e 6420 6765 7420 7468 650a 2020  r and get the.  
-000174d0: 2020 2020 2020 2320 6d6f 7374 2d72 6563        # most-rec
-000174e0: 656e 746c 792d 6164 6465 6420 676c 7970  ently-added glyp
-000174f0: 6873 2e0a 2020 2020 2020 2020 7365 6c66  hs..        self
-00017500: 2e5f 7265 6e64 6572 6572 7320 3d20 4f72  ._renderers = Or
-00017510: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
-00017520: 2020 2020 7365 6c66 2e5f 6c69 6e65 5f72      self._line_r
-00017530: 656e 6465 7265 7273 203d 204f 7264 6572  enderers = Order
-00017540: 6564 4469 6374 2829 0a0a 2020 2020 6465  edDict()..    de
-00017550: 6620 5f73 686f 756c 645f 6164 645f 6e65  f _should_add_ne
-00017560: 775f 7265 6e64 6572 6572 7328 7365 6c66  w_renderers(self
-00017570: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-00017580: 2020 2022 2222 0a20 2020 2020 2020 2057     """.        W
-00017590: 6865 7468 6572 2074 6f20 6164 6420 6e65  hether to add ne
-000175a0: 7720 7265 6e64 6572 6572 7320 746f 2074  w renderers to t
-000175b0: 6865 2063 6861 7274 2e0a 0a20 2020 2020  he chart...     
-000175c0: 2020 2057 6865 6e20 6120 6e65 7720 7365     When a new se
-000175d0: 7420 6f66 2074 6173 6b20 6772 6f75 7073  t of task groups
-000175e0: 2065 6e74 6572 7320 7468 6520 7363 6865   enters the sche
-000175f0: 6475 6c65 7220 7765 2764 206c 696b 6520  duler we'd like 
-00017600: 746f 2073 7461 7274 2072 656e 6465 7269  to start renderi
-00017610: 6e67 0a20 2020 2020 2020 2074 6865 6d2e  ng.        them.
-00017620: 2042 7574 2069 7420 6361 6e20 6265 2065   But it can be e
-00017630: 7870 656e 7369 7665 2074 6f20 6164 6420  xpensive to add 
-00017640: 6e65 7720 676c 7970 732c 2073 6f20 7765  new glyps, so we
-00017650: 2064 6f20 6974 2064 656c 6962 6572 6174   do it deliberat
-00017660: 656c 792c 0a20 2020 2020 2020 2063 6865  ely,.        che
-00017670: 636b 696e 6720 7768 6574 6865 7220 7765  cking whether we
-00017680: 2068 6176 6520 746f 2064 6f20 6974 2061   have to do it a
-00017690: 6e64 2077 6865 7468 6572 2074 6865 2073  nd whether the s
-000176a0: 6368 6564 756c 6572 2073 6565 6d73 2062  cheduler seems b
-000176b0: 7573 792e 0a20 2020 2020 2020 2022 2222  usy..        """
-000176c0: 0a20 2020 2020 2020 2023 2041 6c77 6179  .        # Alway
-000176d0: 7320 6472 6177 2069 6620 7765 2068 6176  s draw if we hav
-000176e0: 6520 6e6f 7420 6265 666f 7265 0a20 2020  e not before.   
-000176f0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00017700: 2e5f 6c61 7374 5f64 7261 776e 3a0a 2020  ._last_drawn:.  
-00017710: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017720: 2054 7275 650a 2020 2020 2020 2020 2320   True.        # 
-00017730: 446f 6e27 7420 6472 6177 2069 6620 7468  Don't draw if th
-00017740: 6572 6520 6861 7665 2062 6565 6e20 6e6f  ere have been no
-00017750: 206e 6577 2074 6173 6b73 2063 6f6d 706c   new tasks compl
-00017760: 6574 6564 2073 696e 6365 2074 6865 206c  eted since the l
-00017770: 6173 7420 7570 6461 7465 2c0a 2020 2020  ast update,.    
-00017780: 2020 2020 2320 6f72 2069 6620 7468 6520      # or if the 
-00017790: 7363 6865 6475 6c65 7220 4350 5520 6973  scheduler CPU is
-000177a0: 206f 6363 7570 6965 642e 0a20 2020 2020   occupied..     
-000177b0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-000177c0: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
-000177d0: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
-000177e0: 3d3d 2073 656c 662e 7363 6865 6475 6c65  == self.schedule
-000177f0: 722e 7472 616e 7369 7469 6f6e 5f63 6f75  r.transition_cou
-00017800: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
-00017810: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
-00017820: 6572 2e70 726f 632e 6370 755f 7065 7263  er.proc.cpu_perc
-00017830: 656e 7428 2920 3e20 3530 0a20 2020 2020  ent() > 50.     
-00017840: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00017850: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00017860: 2020 2020 2020 2020 2320 4f6e 6c79 2072          # Only r
-00017870: 6574 7572 6e20 7472 7565 2069 6620 7468  eturn true if th
-00017880: 6572 6520 6172 6520 6e65 7720 7461 736b  ere are new task
-00017890: 2067 726f 7570 7320 7468 6174 2077 6520   groups that we 
-000178a0: 6861 7665 206e 6f74 2079 6574 2061 6464  have not yet add
-000178b0: 6564 0a20 2020 2020 2020 2023 2074 6f20  ed.        # to 
-000178c0: 7468 6520 436f 6c75 6d6e 4461 7461 536f  the ColumnDataSo
-000178d0: 7572 6365 2e0a 2020 2020 2020 2020 7265  urce..        re
-000178e0: 7475 726e 206e 6f74 2073 6574 2873 656c  turn not set(sel
-000178f0: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
-00017900: 2e6b 6579 7328 2929 203c 3d20 7365 7428  .keys()) <= set(
-00017910: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00017920: 2e6b 6579 7328 2929 0a0a 2020 2020 6465  .keys())..    de
-00017930: 6620 5f73 686f 756c 645f 7570 6461 7465  f _should_update
-00017940: 2873 656c 6629 202d 3e20 626f 6f6c 3a0a  (self) -> bool:.
-00017950: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00017960: 2020 2020 5768 6574 6865 7220 746f 2075      Whether to u
-00017970: 7064 6174 6520 7468 6520 436f 6c75 6d6e  pdate the Column
-00017980: 4461 7461 536f 7572 6365 2e20 5468 6973  DataSource. This
-00017990: 2069 7320 6368 6561 7065 7220 7468 616e   is cheaper than
-000179a0: 2072 6564 7261 7769 6e67 2c0a 2020 2020   redrawing,.    
-000179b0: 2020 2020 6275 7420 7374 696c 6c20 6e6f      but still no
-000179c0: 7420 6672 6565 2c20 736f 2077 6520 6368  t free, so we ch
-000179d0: 6563 6b20 7768 6574 6865 7220 7765 206e  eck whether we n
-000179e0: 6565 6420 6974 2061 6e64 2077 6865 7468  eed it and wheth
-000179f0: 6572 2074 6865 2073 6368 6575 646c 6572  er the scheudler
-00017a00: 0a20 2020 2020 2020 2069 7320 6275 7379  .        is busy
-00017a10: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00017a20: 2020 2020 2020 7265 7475 726e 2028 0a20        return (. 
-00017a30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017a40: 5f6c 6173 745f 7472 616e 7369 7469 6f6e  _last_transition
-00017a50: 5f63 6f75 6e74 2021 3d20 7365 6c66 2e73  _count != self.s
-00017a60: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00017a70: 696f 6e5f 636f 756e 7465 720a 2020 2020  ion_counter.    
-00017a80: 2020 2020 2020 2020 616e 6420 7365 6c66          and self
-00017a90: 2e73 6368 6564 756c 6572 2e70 726f 632e  .scheduler.proc.
-00017aa0: 6370 755f 7065 7263 656e 7428 2920 3c20  cpu_percent() < 
-00017ab0: 3530 0a20 2020 2020 2020 2029 0a0a 2020  50.        )..  
-00017ac0: 2020 6465 6620 5f67 6574 5f74 696d 6573    def _get_times
-00017ad0: 6572 6965 7328 7365 6c66 2c20 7265 7374  eries(self, rest
-00017ae0: 7269 6374 5f74 6f5f 6578 6973 7469 6e67  rict_to_existing
-00017af0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00017b00: 2022 2222 0a20 2020 2020 2020 2055 7064   """.        Upd
-00017b10: 6174 6520 7468 6520 436f 6c75 6d6e 4461  ate the ColumnDa
-00017b20: 7461 536f 7572 6365 2077 6974 6820 6f75  taSource with ou
-00017b30: 7220 7469 6d65 2073 6572 6965 7320 6461  r time series da
-00017b40: 7461 2e0a 0a20 2020 2020 2020 2072 6573  ta...        res
-00017b50: 7472 6963 745f 746f 5f65 7869 7374 696e  trict_to_existin
-00017b60: 6720 6465 7465 726d 696e 6573 2077 6865  g determines whe
-00017b70: 7468 6572 2074 6f20 6164 6420 6e65 7720  ther to add new 
-00017b80: 7461 736b 2067 726f 7570 730a 2020 2020  task groups.    
-00017b90: 2020 2020 7768 6963 6820 6d69 6768 7420      which might 
-00017ba0: 6861 7665 2062 6565 6e20 6164 6465 6420  have been added 
-00017bb0: 7369 6e63 6520 7468 6520 6c61 7374 2074  since the last t
-00017bc0: 696d 6520 7765 2072 656e 6465 7265 642e  ime we rendered.
-00017bd0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
-00017be0: 2069 6d70 6f72 7461 6e74 2061 7320 7765   important as we
-00017bf0: 2077 616e 7420 746f 2061 6464 206e 6577   want to add new
-00017c00: 2073 7461 636b 6572 7320 7665 7279 2064   stackers very d
-00017c10: 656c 6962 6572 6174 656c 792e 0a20 2020  eliberately..   
-00017c20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00017c30: 2023 2047 6574 2074 6865 2066 726f 6e74   # Get the front
-00017c40: 2f62 6163 6b20 696e 6469 6365 7320 666f  /back indices fo
-00017c50: 7220 6d6f 7374 2072 6563 656e 7420 6e70  r most recent np
-00017c60: 7473 2062 696e 7320 6f75 7420 6f66 2074  ts bins out of t
-00017c70: 6865 2074 696d 6573 6572 6965 730a 2020  he timeseries.  
-00017c80: 2020 2020 2020 6672 6f6e 7420 3d20 6d61        front = ma
-00017c90: 7828 6c65 6e28 7365 6c66 2e70 6c75 6769  x(len(self.plugi
-00017ca0: 6e2e 7469 6d65 2920 2d20 7365 6c66 2e6e  n.time) - self.n
-00017cb0: 7074 732c 2030 290a 2020 2020 2020 2020  pts, 0).        
-00017cc0: 6261 636b 203d 204e 6f6e 650a 2020 2020  back = None.    
-00017cd0: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
-00017ce0: 2070 6572 696f 6473 206f 6620 7a65 726f   periods of zero
-00017cf0: 2063 6f6d 7075 7465 2061 7420 7468 6520   compute at the 
-00017d00: 6672 6f6e 7420 6f72 2062 6163 6b20 6f66  front or back of
-00017d10: 2074 6865 2074 696d 6573 6572 6965 730a   the timeseries.
-00017d20: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00017d30: 656c 662e 706c 7567 696e 2e63 6f6d 7075  elf.plugin.compu
-00017d40: 7465 293a 0a20 2020 2020 2020 2020 2020  te):.           
-00017d50: 2061 6767 203d 2073 756d 286e 702e 6172   agg = sum(np.ar
-00017d60: 7261 7928 765b 6672 6f6e 743a 5d29 2066  ray(v[front:]) f
-00017d70: 6f72 2076 2069 6e20 7365 6c66 2e70 6c75  or v in self.plu
-00017d80: 6769 6e2e 636f 6d70 7574 652e 7661 6c75  gin.compute.valu
-00017d90: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-00017da0: 2020 6672 6f6e 7432 203d 206c 656e 2861    front2 = len(a
-00017db0: 6767 2920 2d20 6c65 6e28 6e70 2e74 7269  gg) - len(np.tri
-00017dc0: 6d5f 7a65 726f 7328 6167 672c 2074 7269  m_zeros(agg, tri
-00017dd0: 6d3d 2266 2229 290a 2020 2020 2020 2020  m="f")).        
-00017de0: 2020 2020 6672 6f6e 7420 2b3d 2066 726f      front += fro
-00017df0: 6e74 320a 2020 2020 2020 2020 2020 2020  nt2.            
-00017e00: 6261 636b 203d 206c 656e 286e 702e 7472  back = len(np.tr
-00017e10: 696d 5f7a 6572 6f73 2861 6767 2c20 7472  im_zeros(agg, tr
-00017e20: 696d 3d22 6222 2929 202d 206c 656e 2861  im="b")) - len(a
-00017e30: 6767 2920 6f72 204e 6f6e 650a 0a20 2020  gg) or None..   
-00017e40: 2020 2020 2070 7265 7065 6e64 203d 2028       prepend = (
-00017e50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00017e60: 662e 706c 7567 696e 2e74 696d 655b 6672  f.plugin.time[fr
-00017e70: 6f6e 7420 2d20 315d 0a20 2020 2020 2020  ont - 1].       
-00017e80: 2020 2020 2069 6620 6672 6f6e 7420 3e3d       if front >=
-00017e90: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-00017ea0: 6c73 6520 7365 6c66 2e70 6c75 6769 6e2e  lse self.plugin.
-00017eb0: 7469 6d65 5b66 726f 6e74 5d20 2d20 7365  time[front] - se
-00017ec0: 6c66 2e70 6c75 6769 6e2e 6474 0a20 2020  lf.plugin.dt.   
-00017ed0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00017ee0: 696d 6573 7461 6d70 7320 3d20 6e70 2e61  imestamps = np.a
-00017ef0: 7272 6179 2873 656c 662e 706c 7567 696e  rray(self.plugin
-00017f00: 2e74 696d 655b 6672 6f6e 743a 6261 636b  .time[front:back
-00017f10: 5d29 0a20 2020 2020 2020 2064 7420 3d20  ]).        dt = 
-00017f20: 6e70 2e64 6966 6628 7469 6d65 7374 616d  np.diff(timestam
-00017f30: 7073 2c20 7072 6570 656e 643d 7072 6570  ps, prepend=prep
-00017f40: 656e 6429 0a0a 2020 2020 2020 2020 6966  end)..        if
-00017f50: 2072 6573 7472 6963 745f 746f 5f65 7869   restrict_to_exi
-00017f60: 7374 696e 673a 0a20 2020 2020 2020 2020  sting:.         
-00017f70: 2020 206e 6577 5f64 6174 6120 3d20 7b0a     new_data = {.
-00017f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f90: 6b3a 206e 702e 6172 7261 7928 765b 6672  k: np.array(v[fr
-00017fa0: 6f6e 743a 6261 636b 5d29 202f 2064 740a  ont:back]) / dt.
-00017fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fc0: 666f 7220 6b2c 2076 2069 6e20 7365 6c66  for k, v in self
-00017fd0: 2e70 6c75 6769 6e2e 636f 6d70 7574 652e  .plugin.compute.
-00017fe0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-00017ff0: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-00018000: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00018010: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00018020: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018030: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
-00018040: 6120 3d20 7661 6c6d 6170 280a 2020 2020  a = valmap(.    
-00018050: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-00018060: 6461 2078 3a20 6e70 2e61 7272 6179 2878  da x: np.array(x
-00018070: 5b66 726f 6e74 3a62 6163 6b5d 2920 2f20  [front:back]) / 
-00018080: 6474 2c0a 2020 2020 2020 2020 2020 2020  dt,.            
-00018090: 2020 2020 7365 6c66 2e70 6c75 6769 6e2e      self.plugin.
-000180a0: 636f 6d70 7574 652c 0a20 2020 2020 2020  compute,.       
-000180b0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000180c0: 6e65 775f 6461 7461 5b22 7469 6d65 225d  new_data["time"]
-000180d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-000180e0: 2074 696d 6573 7461 6d70 7320 2d20 7365   timestamps - se
-000180f0: 6c66 2e5f 6f66 6673 6574 0a20 2020 2020  lf._offset.     
-00018100: 2020 2029 202a 2031 3030 302e 3020 2023     ) * 1000.0  #
-00018110: 2062 6f6b 6568 206c 696b 6573 206d 696c   bokeh likes mil
-00018120: 6c69 7365 636f 6e64 730a 2020 2020 2020  liseconds.      
-00018130: 2020 6e65 775f 6461 7461 5b22 6e74 6872    new_data["nthr
-00018140: 6561 6473 225d 203d 206e 702e 6172 7261  eads"] = np.arra
-00018150: 7928 7365 6c66 2e70 6c75 6769 6e2e 6e74  y(self.plugin.nt
-00018160: 6872 6561 6473 5b66 726f 6e74 3a62 6163  hreads[front:bac
-00018170: 6b5d 290a 0a20 2020 2020 2020 2072 6574  k])..        ret
-00018180: 7572 6e20 6e65 775f 6461 7461 0a0a 2020  urn new_data..  
-00018190: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-000181a0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-000181b0: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-000181c0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
-000181d0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-000181e0: 0a20 2020 2020 2020 204d 6179 6265 2075  .        Maybe u
-000181f0: 7064 6174 6520 7468 6520 6368 6172 742e  pdate the chart.
-00018200: 2054 6869 7320 6973 2073 6f6d 6577 6861   This is somewha
-00018210: 7420 6578 7065 6e73 6976 6520 746f 2064  t expensive to d
-00018220: 7261 772c 2073 6f20 7765 2075 7064 6174  raw, so we updat
-00018230: 650a 2020 2020 2020 2020 6974 2070 7265  e.        it pre
-00018240: 7474 7920 6465 6665 6e73 6976 656c 792e  tty defensively.
-00018250: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00018260: 2020 2020 2069 6620 7365 6c66 2e5f 7368       if self._sh
-00018270: 6f75 6c64 5f61 6464 5f6e 6577 5f72 656e  ould_add_new_ren
-00018280: 6465 7265 7273 2829 3a0a 2020 2020 2020  derers():.      
-00018290: 2020 2020 2020 2320 5570 6461 7465 2074        # Update t
-000182a0: 6865 2063 6861 7274 2c20 616c 6c6f 7769  he chart, allowi
-000182b0: 6e67 2066 6f72 206e 6577 2074 6173 6b20  ng for new task 
-000182c0: 6772 6f75 7073 2074 6f20 6265 2061 6464  groups to be add
-000182d0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-000182e0: 6e65 775f 6461 7461 203d 2073 656c 662e  new_data = self.
-000182f0: 5f67 6574 5f74 696d 6573 6572 6965 7328  _get_timeseries(
-00018300: 7265 7374 7269 6374 5f74 6f5f 6578 6973  restrict_to_exis
-00018310: 7469 6e67 3d46 616c 7365 290a 2020 2020  ting=False).    
-00018320: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
-00018330: 7263 652e 6461 7461 203d 206e 6577 5f64  rce.data = new_d
-00018340: 6174 610a 0a20 2020 2020 2020 2020 2020  ata..           
-00018350: 2023 2050 6f73 7369 626c 7920 7570 6461   # Possibly upda
-00018360: 7465 2074 6865 2079 2072 616e 6765 2069  te the y range i
-00018370: 6620 7468 6520 6e75 6d62 6572 206f 6620  f the number of 
-00018380: 7468 7265 6164 7320 6861 7320 696e 6372  threads has incr
-00018390: 6561 7365 642e 0a20 2020 2020 2020 2020  eased..         
-000183a0: 2020 206d 6178 5f6e 7468 7265 6164 7320     max_nthreads 
-000183b0: 3d20 6d61 7828 7365 6c66 2e70 6c75 6769  = max(self.plugi
-000183c0: 6e2e 6e74 6872 6561 6473 290a 2020 2020  n.nthreads).    
-000183d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000183e0: 726f 6f74 2e79 5f72 616e 6765 2e65 6e64  root.y_range.end
-000183f0: 2021 3d20 6d61 785f 6e74 6872 6561 6473   != max_nthreads
-00018400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018410: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
-00018420: 6e67 652e 656e 6420 3d20 6d61 785f 6e74  nge.end = max_nt
-00018430: 6872 6561 6473 0a0a 2020 2020 2020 2020  hreads..        
-00018440: 2020 2020 7374 6163 6b65 7273 203d 206c      stackers = l
-00018450: 6973 7428 7365 6c66 2e70 6c75 6769 6e2e  ist(self.plugin.
-00018460: 636f 6d70 7574 652e 6b65 7973 2829 290a  compute.keys()).
-00018470: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00018480: 7273 203d 205b 636f 6c6f 725f 6f66 286b  rs = [color_of(k
-00018490: 6579 5f73 706c 6974 286b 2929 2066 6f72  ey_split(k)) for
-000184a0: 206b 2069 6e20 7374 6163 6b65 7273 5d0a   k in stackers].
-000184b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000184c0: 2069 2c20 2867 726f 7570 2c20 636f 6c6f   i, (group, colo
-000184d0: 7229 2069 6e20 656e 756d 6572 6174 6528  r) in enumerate(
-000184e0: 7a69 7028 7374 6163 6b65 7273 2c20 636f  zip(stackers, co
-000184f0: 6c6f 7273 2929 3a0a 2020 2020 2020 2020  lors)):.        
-00018500: 2020 2020 2020 2020 2320 4966 2077 6520          # If we 
-00018510: 6861 7665 2061 6c72 6561 6479 2064 7261  have already dra
-00018520: 776e 2074 6865 2067 726f 7570 2c20 6275  wn the group, bu
-00018530: 7420 6974 2069 7320 616c 6c20 7a65 726f  t it is all zero
-00018540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018550: 2020 2320 7365 7420 6974 2074 6f20 6265    # set it to be
-00018560: 2069 6e76 6973 6962 6c65 2e0a 2020 2020   invisible..    
-00018570: 2020 2020 2020 2020 2020 2020 6966 2067              if g
-00018580: 726f 7570 2069 6e20 7365 6c66 2e5f 7265  roup in self._re
-00018590: 6e64 6572 6572 733a 0a20 2020 2020 2020  nderers:.       
-000185a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000185b0: 6e6f 7420 6e70 2e63 6f75 6e74 5f6e 6f6e  not np.count_non
-000185c0: 7a65 726f 286e 6577 5f64 6174 615b 6772  zero(new_data[gr
-000185d0: 6f75 705d 2920 3e20 303a 0a20 2020 2020  oup]) > 0:.     
-000185e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185f0: 2020 2073 656c 662e 5f72 656e 6465 7265     self._rendere
-00018600: 7273 5b67 726f 7570 5d2e 7669 7369 626c  rs[group].visibl
-00018610: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
-00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018630: 2020 7365 6c66 2e5f 6c69 6e65 5f72 656e    self._line_ren
-00018640: 6465 7265 7273 5b67 726f 7570 5d2e 7669  derers[group].vi
-00018650: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
-00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018670: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018690: 7365 6c66 2e5f 7265 6e64 6572 6572 735b  self._renderers[
-000186a0: 6772 6f75 705d 2e76 6973 6962 6c65 203d  group].visible =
-000186b0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-000186c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000186d0: 6c66 2e5f 6c69 6e65 5f72 656e 6465 7265  lf._line_rendere
-000186e0: 7273 5b67 726f 7570 5d2e 7669 7369 626c  rs[group].visibl
-000186f0: 6520 3d20 5472 7565 0a0a 2020 2020 2020  e = True..      
-00018700: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00018710: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00018720: 2020 2020 2020 2020 2320 4472 6177 2074          # Draw t
-00018730: 6865 206e 6577 2061 7265 6120 616e 6420  he new area and 
-00018740: 6c69 6e65 2067 6c79 7068 732e 0a20 2020  line glyphs..   
-00018750: 2020 2020 2020 2020 2020 2020 2072 656e               ren
-00018760: 6465 7265 7220 3d20 7365 6c66 2e72 6f6f  derer = self.roo
-00018770: 742e 7661 7265 6128 0a20 2020 2020 2020  t.varea(.       
-00018780: 2020 2020 2020 2020 2020 2020 2078 3d22               x="
-00018790: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-000187a0: 2020 2020 2020 2020 2020 2079 313d 7374             y1=st
-000187b0: 6163 6b28 2a73 7461 636b 6572 735b 3a69  ack(*stackers[:i
-000187c0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000187d0: 2020 2020 2020 2020 7932 3d73 7461 636b          y2=stack
-000187e0: 282a 7374 6163 6b65 7273 5b3a 2069 202b  (*stackers[: i +
-000187f0: 2031 5d29 2c0a 2020 2020 2020 2020 2020   1]),.          
-00018800: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-00018810: 636f 6c6f 722c 0a20 2020 2020 2020 2020  color,.         
-00018820: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
-00018830: 3d30 2e35 2c0a 2020 2020 2020 2020 2020  =0.5,.          
-00018840: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00018850: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00018860: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018880: 7365 6c66 2e5f 7265 6e64 6572 6572 735b  self._renderers[
-00018890: 6772 6f75 705d 203d 2072 656e 6465 7265  group] = rendere
-000188a0: 720a 0a20 2020 2020 2020 2020 2020 2020  r..             
-000188b0: 2020 206c 696e 655f 7265 6e64 6572 6572     line_renderer
-000188c0: 203d 2073 656c 662e 726f 6f74 2e6c 696e   = self.root.lin
-000188d0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-000188e0: 2020 2020 2020 2078 3d22 7469 6d65 222c         x="time",
-000188f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018900: 2020 2020 2079 3d73 7461 636b 282a 7374       y=stack(*st
-00018910: 6163 6b65 7273 5b3a 2069 202b 2031 5d29  ackers[: i + 1])
-00018920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018930: 2020 2020 2020 636f 6c6f 723d 636f 6c6f        color=colo
-00018940: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00018950: 2020 2020 2020 2061 6c70 6861 3d31 2e30         alpha=1.0
-00018960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018970: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-00018980: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-00018990: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000189a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000189b0: 2e5f 6c69 6e65 5f72 656e 6465 7265 7273  ._line_renderers
-000189c0: 5b67 726f 7570 5d20 3d20 6c69 6e65 5f72  [group] = line_r
-000189d0: 656e 6465 7265 720a 0a20 2020 2020 2020  enderer..       
-000189e0: 2020 2020 2023 2044 6f6e 2774 2061 6464       # Don't add
-000189f0: 2068 6f76 6572 2075 6e74 696c 2074 6865   hover until the
-00018a00: 7265 2069 7320 736f 6d65 7468 696e 6720  re is something 
-00018a10: 746f 2073 686f 772c 2061 7320 626f 6b65  to show, as boke
-00018a20: 686a 7320 7365 656d 7320 746f 0a20 2020  hjs seems to.   
-00018a30: 2020 2020 2020 2020 2023 2068 6176 6520           # have 
-00018a40: 7472 6f75 626c 6520 7769 7468 2063 7573  trouble with cus
-00018a50: 746f 6d20 686f 7665 7273 2077 6865 6e20  tom hovers when 
-00018a60: 7468 6572 6520 6172 6520 6e6f 2072 656e  there are no ren
-00018a70: 6465 7265 7273 2e0a 2020 2020 2020 2020  derers..        
-00018a80: 2020 2020 6966 2073 656c 662e 706c 7567      if self.plug
-00018a90: 696e 2e63 6f6d 7075 7465 2061 6e64 2073  in.compute and s
-00018aa0: 656c 662e 5f68 6f76 6572 2069 7320 4e6f  elf._hover is No
-00018ab0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00018ac0: 2020 2020 2320 4164 6420 6120 686f 7665      # Add a hove
-00018ad0: 7220 7468 6174 2077 696c 6c20 7368 6f77  r that will show
-00018ae0: 206f 6363 7570 616e 6379 2066 6f72 2061   occupancy for a
-00018af0: 6c6c 2063 7572 7265 6e74 6c79 2061 6374  ll currently act
-00018b00: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
-00018b10: 2020 2020 2320 7461 736b 2067 726f 7570      # task group
-00018b20: 732e 2054 6869 7320 6973 2061 206c 6974  s. This is a lit
-00018b30: 746c 6520 7472 6963 6b79 2c20 626f 6b65  tle tricky, boke
-00018b40: 6820 646f 6573 6e27 7420 2879 6574 2920  h doesn't (yet) 
-00018b50: 7375 7070 6f72 740a 2020 2020 2020 2020  support.        
-00018b60: 2020 2020 2020 2020 2320 6869 7420 7465          # hit te
-00018b70: 7374 7320 666f 7220 7374 6163 6b65 6420  sts for stacked 
-00018b80: 6172 6561 2063 6861 7274 733a 2068 7474  area charts: htt
-00018b90: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00018ba0: 626f 6b65 682f 626f 6b65 682f 6973 7375  bokeh/bokeh/issu
-00018bb0: 6573 2f39 3138 320a 2020 2020 2020 2020  es/9182.        
-00018bc0: 2020 2020 2020 2020 2320 496e 7374 6561          # Instea
-00018bd0: 642c 2073 686f 7720 6120 7369 6e67 6c65  d, show a single
-00018be0: 2076 6c69 6e65 2068 6f76 6572 2077 6869   vline hover whi
-00018bf0: 6368 206c 6973 7473 2074 6865 2063 7572  ch lists the cur
-00018c00: 7265 6e74 6c79 2061 6374 6976 6520 7461  rently active ta
-00018c10: 736b 0a20 2020 2020 2020 2020 2020 2020  sk.             
-00018c20: 2020 2023 2067 726f 7570 732e 2041 2063     # groups. A c
-00018c30: 7573 746f 6d20 666f 726d 6174 7465 7220  ustom formatter 
-00018c40: 696e 204a 532d 6c61 6e64 2070 756c 6c73  in JS-land pulls
-00018c50: 2074 6865 2072 656c 6576 616e 7420 6461   the relevant da
-00018c60: 7461 2069 6e64 6578 2061 6e64 0a20 2020  ta index and.   
-00018c70: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-00018c80: 7373 656d 626c 6573 2074 6865 2074 6f6f  ssembles the too
-00018c90: 6c74 6970 2e0a 2020 2020 2020 2020 2020  ltip..          
-00018ca0: 2020 2020 2020 666f 726d 6174 7465 7220        formatter 
-00018cb0: 3d20 4375 7374 6f6d 4a53 486f 7665 7228  = CustomJSHover(
-00018cc0: 636f 6465 3d22 7265 7475 726e 2027 273b  code="return '';
-00018cd0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00018ce0: 2020 2073 656c 662e 5f68 6f76 6572 203d     self._hover =
-00018cf0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d10: 746f 6f6c 7469 7073 3d22 2222 0a20 2020  tooltips=""".   
-00018d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d30: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-00018d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d50: 2020 2020 203c 6469 7620 7374 796c 653d       <div style=
-00018d60: 2266 6f6e 742d 7369 7a65 3a20 312e 3265  "font-size: 1.2e
-00018d70: 6d3b 2066 6f6e 742d 7765 6967 6874 3a20  m; font-weight: 
-00018d80: 626f 6c64 223e 0a20 2020 2020 2020 2020  bold">.         
-00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018da0: 2020 203c 623e 576f 726b 6572 2074 6872     <b>Worker thr
-00018db0: 6561 6420 6f63 6375 7061 6e63 793c 2f62  ead occupancy</b
-00018dc0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-00018dd0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-00018de0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00018df0: 2020 2020 2020 2020 2020 2020 203c 6469               <di
-00018e00: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-00018e10: 2020 2020 2020 2020 2020 2020 2020 2024                 $
-00018e20: 696e 6465 787b 6375 7374 6f6d 7d0a 2020  index{custom}.  
+00013850: 2020 2020 2020 2022 696e 5f70 726f 6365         "in_proce
+00013860: 7373 696e 6722 3a20 5b5d 2c0a 2020 2020  ssing": [],.    
+00013870: 2020 2020 2020 2020 2020 2020 2269 6e5f              "in_
+00013880: 6d65 6d6f 7279 223a 205b 5d2c 0a20 2020  memory": [],.   
+00013890: 2020 2020 2020 2020 2020 2020 2022 696e               "in
+000138a0: 5f72 656c 6561 7365 6422 3a20 5b5d 2c0a  _released": [],.
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138c0: 2269 6e5f 6572 7265 6422 3a20 5b5d 2c0a  "in_erred": [],.
+000138d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138e0: 2263 6f6d 7075 7465 5f74 696d 6522 3a20  "compute_time": 
+000138f0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00013900: 2020 2020 226d 656d 6f72 7922 3a20 5b5d      "memory": []
+00013910: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00013920: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00013930: 2020 2073 656c 662e 6172 726f 7773 5f73     self.arrows_s
+00013940: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00013950: 7461 536f 7572 6365 287b 2278 7322 3a20  taSource({"xs": 
+00013960: 5b5d 2c20 2279 7322 3a20 5b5d 2c20 2278  [], "ys": [], "x
+00013970: 6522 3a20 5b5d 2c20 2279 6522 3a20 5b5d  e": [], "ye": []
+00013980: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
+00013990: 2e72 6f6f 7420 3d20 6669 6775 7265 2874  .root = figure(t
+000139a0: 6974 6c65 3d22 5461 736b 2047 726f 7570  itle="Task Group
+000139b0: 7320 4772 6170 6822 2c20 6d61 7463 685f  s Graph", match_
+000139c0: 6173 7065 6374 3d54 7275 652c 202a 2a6b  aspect=True, **k
+000139d0: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
+000139e0: 656c 662e 726f 6f74 2e61 7869 732e 7669  elf.root.axis.vi
+000139f0: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+00013a00: 2020 2020 2020 7365 6c66 2e73 7562 7469        self.subti
+00013a10: 746c 6520 3d20 5469 746c 6528 7465 7874  tle = Title(text
+00013a20: 3d22 2022 2c20 7465 7874 5f66 6f6e 745f  =" ", text_font_
+00013a30: 7374 796c 653d 2269 7461 6c69 6322 290a  style="italic").
+00013a40: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00013a50: 742e 6164 645f 6c61 796f 7574 2873 656c  t.add_layout(sel
+00013a60: 662e 7375 6274 6974 6c65 2c20 2261 626f  f.subtitle, "abo
+00013a70: 7665 2229 0a0a 2020 2020 2020 2020 7265  ve")..        re
+00013a80: 6374 203d 2073 656c 662e 726f 6f74 2e72  ct = self.root.r
+00013a90: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
+00013aa0: 2078 3d22 7822 2c0a 2020 2020 2020 2020   x="x",.        
+00013ab0: 2020 2020 793d 2279 222c 0a20 2020 2020      y="y",.     
+00013ac0: 2020 2020 2020 2077 6964 7468 3d22 775f         width="w_
+00013ad0: 626f 7822 2c0a 2020 2020 2020 2020 2020  box",.          
+00013ae0: 2020 6865 6967 6874 3d22 685f 626f 7822    height="h_box"
+00013af0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00013b00: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
+00013b10: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
+00013b20: 7068 613d 226d 656d 5f61 6c70 6861 222c  pha="mem_alpha",
+00013b30: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+00013b40: 655f 636f 6c6f 723d 2262 6c61 636b 222c  e_color="black",
+00013b50: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+00013b60: 655f 7769 6474 683d 226e 6f64 655f 6c69  e_width="node_li
+00013b70: 6e65 5f77 6964 7468 222c 0a20 2020 2020  ne_width",.     
+00013b80: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+00013b90: 6c66 2e6e 6f64 6573 5f73 6f75 7263 652c  lf.nodes_source,
+00013ba0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00013bb0: 2020 2020 2320 706c 6f74 2074 6720 6c6f      # plot tg lo
+00013bc0: 670a 2020 2020 2020 2020 7365 6c66 2e72  g.        self.r
+00013bd0: 6f6f 742e 696d 6167 655f 7572 6c28 0a20  oot.image_url(. 
+00013be0: 2020 2020 2020 2020 2020 2075 726c 3d22             url="
+00013bf0: 7572 6c5f 6c6f 676f 222c 0a20 2020 2020  url_logo",.     
+00013c00: 2020 2020 2020 2078 3d22 785f 6c6f 676f         x="x_logo
+00013c10: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+00013c20: 3d22 795f 6c6f 676f 222c 0a20 2020 2020  ="y_logo",.     
+00013c30: 2020 2020 2020 2077 3d22 775f 6c6f 676f         w="w_logo
+00013c40: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
+00013c50: 3d22 685f 6c6f 676f 222c 0a20 2020 2020  ="h_logo",.     
+00013c60: 2020 2020 2020 2061 6e63 686f 723d 2263         anchor="c
+00013c70: 656e 7465 7222 2c0a 2020 2020 2020 2020  enter",.        
+00013c80: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+00013c90: 6e6f 6465 735f 736f 7572 6365 2c0a 2020  nodes_source,.  
+00013ca0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00013cb0: 2023 2070 726f 6772 6573 7320 6261 7220   # progress bar 
+00013cc0: 706c 6169 6e20 626f 780a 2020 2020 2020  plain box.      
+00013cd0: 2020 7365 6c66 2e72 6f6f 742e 7175 6164    self.root.quad
+00013ce0: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
+00013cf0: 6674 3d22 785f 7374 6172 7422 2c0a 2020  ft="x_start",.  
+00013d00: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+00013d10: 2278 5f65 6e64 222c 0a20 2020 2020 2020  "x_end",.       
+00013d20: 2020 2020 2062 6f74 746f 6d3d 2279 5f73       bottom="y_s
+00013d30: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
+00013d40: 2020 2074 6f70 3d22 795f 656e 6422 2c0a     top="y_end",.
+00013d50: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+00013d60: 723d 4e6f 6e65 2c0a 2020 2020 2020 2020  r=None,.        
+00013d70: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+00013d80: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
+00013d90: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+00013da0: 6e6f 6465 735f 736f 7572 6365 2c0a 2020  nodes_source,.  
+00013db0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00013dc0: 2023 2070 726f 6772 6573 7320 6261 720a   # progress bar.
+00013dd0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00013de0: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
+00013df0: 2020 2020 6c65 6674 3d22 785f 7374 6172      left="x_star
+00013e00: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00013e10: 7269 6768 743d 2278 5f65 6e64 5f70 726f  right="x_end_pro
+00013e20: 6772 6573 7322 2c0a 2020 2020 2020 2020  gress",.        
+00013e30: 2020 2020 626f 7474 6f6d 3d22 795f 7374      bottom="y_st
+00013e40: 6172 7422 2c0a 2020 2020 2020 2020 2020  art",.          
+00013e50: 2020 746f 703d 2279 5f65 6e64 222c 0a20    top="y_end",. 
+00013e60: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00013e70: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
+00013e80: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
+00013e90: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00013ea0: 2020 2066 696c 6c5f 616c 7068 613d 302e     fill_alpha=0.
+00013eb0: 362c 0a20 2020 2020 2020 2020 2020 2073  6,.            s
+00013ec0: 6f75 7263 653d 7365 6c66 2e6e 6f64 6573  ource=self.nodes
+00013ed0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+00013ee0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00013ef0: 2e61 7272 6f77 7320 3d20 4172 726f 7728  .arrows = Arrow(
+00013f00: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+00013f10: 3d56 6565 4865 6164 2873 697a 653d 3829  =VeeHead(size=8)
+00013f20: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+00013f30: 6e65 5f63 6f6c 6f72 3d22 626c 6163 6b22  ne_color="black"
+00013f40: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+00013f50: 6e65 5f61 6c70 6861 3d30 2e35 2c0a 2020  ne_alpha=0.5,.  
+00013f60: 2020 2020 2020 2020 2020 6c69 6e65 5f77            line_w
+00013f70: 6964 7468 3d31 2c0a 2020 2020 2020 2020  idth=1,.        
+00013f80: 2020 2020 785f 7374 6172 743d 2278 7322      x_start="xs"
+00013f90: 2c0a 2020 2020 2020 2020 2020 2020 795f  ,.            y_
+00013fa0: 7374 6172 743d 2279 7322 2c0a 2020 2020  start="ys",.    
+00013fb0: 2020 2020 2020 2020 785f 656e 643d 2278          x_end="x
+00013fc0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00013fd0: 795f 656e 643d 2279 6522 2c0a 2020 2020  y_end="ye",.    
+00013fe0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00013ff0: 656c 662e 6172 726f 7773 5f73 6f75 7263  elf.arrows_sourc
+00014000: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
+00014010: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+00014020: 6464 5f6c 6179 6f75 7428 7365 6c66 2e61  dd_layout(self.a
+00014030: 7272 6f77 7329 0a0a 2020 2020 2020 2020  rrows)..        
+00014040: 7365 6c66 2e72 6f6f 742e 7867 7269 642e  self.root.xgrid.
+00014050: 6772 6964 5f6c 696e 655f 636f 6c6f 7220  grid_line_color 
+00014060: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+00014070: 656c 662e 726f 6f74 2e79 6772 6964 2e67  elf.root.ygrid.g
+00014080: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
+00014090: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+000140a0: 6c66 2e72 6f6f 742e 785f 7261 6e67 652e  lf.root.x_range.
+000140b0: 7261 6e67 655f 7061 6464 696e 6720 3d20  range_padding = 
+000140c0: 302e 350a 2020 2020 2020 2020 7365 6c66  0.5.        self
+000140d0: 2e72 6f6f 742e 795f 7261 6e67 652e 7261  .root.y_range.ra
+000140e0: 6e67 655f 7061 6464 696e 6720 3d20 302e  nge_padding = 0.
+000140f0: 350a 0a20 2020 2020 2020 2068 6f76 6572  5..        hover
+00014100: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00014110: 2020 2020 2020 2020 2020 706f 696e 745f            point_
+00014120: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+00014130: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
+00014140: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
+00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014160: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+00014170: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00014180: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00014190: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
+000141a0: 6768 743a 2062 6f6c 643b 223e 4e61 6d65  ght: bold;">Name
+000141b0: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
+000141c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141d0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+000141e0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+000141f0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+00014200: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+00014210: 223e 406e 616d 653c 2f73 7061 6e3e 0a20  ">@name</span>. 
+00014220: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014230: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00014240: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00014250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014260: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014270: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014280: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014290: 223e 436f 6d70 7574 6520 7469 6d65 3a3c  ">Compute time:<
+000142a0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+000142b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142c0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+000142d0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+000142e0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+000142f0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00014300: 4063 6f6d 7075 7465 5f74 696d 653c 2f73  @compute_time</s
+00014310: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014320: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014330: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014340: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014350: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014360: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014370: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014380: 2062 6f6c 643b 223e 4d65 6d6f 7279 3a3c   bold;">Memory:<
+00014390: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143b0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+000143c0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+000143d0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+000143e0: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+000143f0: 406d 656d 6f72 793c 2f73 7061 6e3e 0a20  @memory</span>. 
+00014400: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014410: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00014420: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00014430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014440: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014450: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014460: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014470: 223e 5461 736b 733a 3c2f 7370 616e 3e26  ">Tasks:</span>&
+00014480: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00014490: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+000144a0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+000144b0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+000144c0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+000144d0: 6f73 7061 6365 3b22 3e40 746f 745f 7461  ospace;">@tot_ta
+000144e0: 736b 733c 2f73 7061 6e3e 0a20 2020 2020  sks</span>.     
+000144f0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+00014500: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014510: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
+00014520: 7267 696e 2d6c 6566 743a 2032 656d 3b22  rgin-left: 2em;"
+00014530: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014540: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014550: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014560: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014570: 2062 6f6c 643b 223e 436f 6d70 6c65 7465   bold;">Complete
+00014580: 643a 3c2f 7370 616e 3e26 6e62 7370 3b0a  d:</span>&nbsp;.
+00014590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145a0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+000145b0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+000145c0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000145d0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+000145e0: 3b22 3e40 636f 6d70 5f74 6173 6b73 3c2f  ;">@comp_tasks</
+000145f0: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
+00014600: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00014610: 2020 2020 2020 2020 2020 2020 203c 6469               <di
+00014620: 7620 7374 796c 653d 226d 6172 6769 6e2d  v style="margin-
+00014630: 6c65 6674 3a20 3265 6d3b 223e 0a20 2020  left: 2em;">.   
+00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014650: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00014660: 6e74 2d73 697a 653a 2031 3270 783b 2066  nt-size: 12px; f
+00014670: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+00014680: 3b22 3e50 726f 6365 7373 696e 673a 3c2f  ;">Processing:</
+00014690: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+000146a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146b0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+000146c0: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+000146d0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+000146e0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+000146f0: 696e 5f70 726f 6365 7373 696e 673c 2f73  in_processing</s
+00014700: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014710: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014720: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014730: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
+00014740: 6566 743a 2032 656d 3b22 3e0a 2020 2020  eft: 2em;">.    
+00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014760: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014770: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014780: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014790: 223e 496e 206d 656d 6f72 793a 3c2f 7370  ">In memory:</sp
+000147a0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+000147b0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+000147c0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+000147d0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+000147e0: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+000147f0: 206d 6f6e 6f73 7061 6365 3b22 3e40 696e   monospace;">@in
+00014800: 5f6d 656d 6f72 793c 2f73 7061 6e3e 0a20  _memory</span>. 
+00014810: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014820: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00014830: 2020 2020 2020 3c64 6976 2073 7479 6c65        <div style
+00014840: 3d22 6d61 7267 696e 2d6c 6566 743a 2032  ="margin-left: 2
+00014850: 656d 3b22 3e0a 2020 2020 2020 2020 2020  em;">.          
+00014860: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00014870: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00014880: 3a20 3132 7078 3b20 666f 6e74 2d77 6569  : 12px; font-wei
+00014890: 6768 743a 2062 6f6c 643b 223e 4572 7265  ght: bold;">Erre
+000148a0: 643a 3c2f 7370 616e 3e26 6e62 7370 3b0a  d:</span>&nbsp;.
+000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148c0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+000148d0: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+000148e0: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000148f0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+00014900: 3b22 3e40 696e 5f65 7272 6564 3c2f 7370  ;">@in_erred</sp
+00014910: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
+00014920: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+00014930: 2020 2020 2020 2020 2020 203c 6469 7620             <div 
+00014940: 7374 796c 653d 226d 6172 6769 6e2d 6c65  style="margin-le
+00014950: 6674 3a20 3265 6d3b 223e 0a20 2020 2020  ft: 2em;">.     
+00014960: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014970: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+00014980: 2d73 697a 653a 2031 3270 783b 2066 6f6e  -size: 12px; fon
+00014990: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+000149a0: 3e52 656c 6561 7365 643a 3c2f 7370 616e  >Released:</span
+000149b0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+000149c0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+000149d0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+000149e0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+000149f0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00014a00: 6f6e 6f73 7061 6365 3b22 3e40 696e 5f72  onospace;">@in_r
+00014a10: 656c 6561 7365 643c 2f73 7061 6e3e 0a20  eleased</span>. 
+00014a20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+00014a30: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+00014a40: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
+00014a50: 2020 2020 2020 2072 656e 6465 7265 7273         renderers
+00014a60: 3d5b 7265 6374 5d2c 0a20 2020 2020 2020  =[rect],.       
+00014a70: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00014a80: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
+00014a90: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
+00014aa0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00014ab0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+00014ac0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+00014ad0: 2075 7064 6174 655f 6c61 796f 7574 2873   update_layout(s
+00014ae0: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
+00014af0: 4765 7420 6465 7065 6e64 656e 6369 6573  Get dependencies
+00014b00: 2070 6572 2074 6173 6b20 6772 6f75 702e   per task group.
+00014b10: 0a20 2020 2020 2020 2023 2049 6e20 736f  .        # In so
+00014b20: 6d65 2063 6173 6573 2074 6865 7265 2061  me cases there a
+00014b30: 7265 2074 6720 7468 6174 2068 6176 6520  re tg that have 
+00014b40: 7468 656d 7365 6c76 6573 2061 7320 6465  themselves as de
+00014b50: 7065 6e64 656e 6369 6573 202d 2077 6520  pendencies - we 
+00014b60: 7265 6d6f 7665 2074 686f 7365 2e0a 2020  remove those..  
+00014b70: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+00014b80: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
+00014b90: 2020 206b 3a20 7b64 732e 6e61 6d65 2066     k: {ds.name f
+00014ba0: 6f72 2064 7320 696e 2074 732e 6465 7065  or ds in ts.depe
+00014bb0: 6e64 656e 6369 6573 2069 6620 6473 2e6e  ndencies if ds.n
+00014bc0: 616d 6520 213d 206b 7d0a 2020 2020 2020  ame != k}.      
+00014bd0: 2020 2020 2020 666f 7220 6b2c 2074 7320        for k, ts 
+00014be0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
+00014bf0: 722e 7461 736b 5f67 726f 7570 732e 6974  r.task_groups.it
+00014c00: 656d 7328 290a 2020 2020 2020 2020 7d0a  ems().        }.
+00014c10: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
+00014c20: 6461 736b 0a0a 2020 2020 2020 2020 6f72  dask..        or
+00014c30: 6465 7220 3d20 6461 736b 2e6f 7264 6572  der = dask.order
+00014c40: 2e6f 7264 6572 280a 2020 2020 2020 2020  .order(.        
+00014c50: 2020 2020 6473 6b3d 7b67 726f 7570 2e6e      dsk={group.n
+00014c60: 616d 653a 2031 2066 6f72 206b 2c20 6772  ame: 1 for k, gr
+00014c70: 6f75 7020 696e 2073 656c 662e 7363 6865  oup in self.sche
+00014c80: 6475 6c65 722e 7461 736b 5f67 726f 7570  duler.task_group
+00014c90: 732e 6974 656d 7328 297d 2c0a 2020 2020  s.items()},.    
+00014ca0: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+00014cb0: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
+00014cc0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00014cd0: 2020 2020 2020 6f72 6465 7265 6420 3d20        ordered = 
+00014ce0: 736f 7274 6564 2873 656c 662e 7363 6865  sorted(self.sche
+00014cf0: 6475 6c65 722e 7461 736b 5f67 726f 7570  duler.task_group
+00014d00: 732c 206b 6579 3d6f 7264 6572 2e67 6574  s, key=order.get
+00014d10: 290a 0a20 2020 2020 2020 2078 7320 3d20  )..        xs = 
+00014d20: 7b7d 0a20 2020 2020 2020 2079 7320 3d20  {}.        ys = 
+00014d30: 7b7d 0a20 2020 2020 2020 206c 6f63 6174  {}.        locat
+00014d40: 696f 6e73 203d 2073 6574 2829 0a20 2020  ions = set().   
+00014d50: 2020 2020 206e 6f64 6573 5f6c 6179 6f75       nodes_layou
+00014d60: 7420 3d20 7b7d 0a20 2020 2020 2020 2061  t = {}.        a
+00014d70: 7272 6f77 735f 6c61 796f 7574 203d 207b  rrows_layout = {
+00014d80: 7d0a 2020 2020 2020 2020 666f 7220 7467  }.        for tg
+00014d90: 2069 6e20 6f72 6465 7265 643a 0a20 2020   in ordered:.   
+00014da0: 2020 2020 2020 2020 2069 6620 6465 7065           if depe
+00014db0: 6e64 656e 6369 6573 5b74 675d 3a0a 2020  ndencies[tg]:.  
+00014dc0: 2020 2020 2020 2020 2020 2020 2020 7820                x 
+00014dd0: 3d20 6d61 7828 7873 5b64 6570 5d20 666f  = max(xs[dep] fo
+00014de0: 7220 6465 7020 696e 2064 6570 656e 6465  r dep in depende
+00014df0: 6e63 6965 735b 7467 5d29 202b 2031 0a20  ncies[tg]) + 1. 
+00014e00: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00014e10: 203d 206d 6178 2879 735b 6465 705d 2066   = max(ys[dep] f
+00014e20: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
+00014e30: 656e 6369 6573 5b74 675d 290a 2020 2020  encies[tg]).    
+00014e40: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00014e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e60: 2020 2020 206c 656e 2864 6570 656e 6465       len(depende
+00014e70: 6e63 6965 735b 7467 5d29 203e 2031 0a20  ncies[tg]) > 1. 
+00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e90: 2020 2061 6e64 206c 656e 287b 7973 5b64     and len({ys[d
+00014ea0: 6570 5d20 666f 7220 6465 7020 696e 2064  ep] for dep in d
+00014eb0: 6570 656e 6465 6e63 6965 735b 7467 5d7d  ependencies[tg]}
+00014ec0: 2920 3d3d 2031 0a20 2020 2020 2020 2020  ) == 1.         
+00014ed0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00014ee0: 2020 2020 2020 2020 2020 2020 2020 7920                y 
+00014ef0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00014f00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014f10: 2020 2020 2020 2078 203d 2030 0a20 2020         x = 0.   
+00014f20: 2020 2020 2020 2020 2020 2020 2079 203d               y =
+00014f30: 206d 6178 2879 732e 7661 6c75 6573 2829   max(ys.values()
+00014f40: 2920 2b20 3120 6966 2079 7320 656c 7365  ) + 1 if ys else
+00014f50: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
+00014f60: 7768 696c 6520 2878 2c20 7929 2069 6e20  while (x, y) in 
+00014f70: 6c6f 6361 7469 6f6e 733a 2020 2320 6176  locations:  # av
+00014f80: 6f69 6420 636f 6c6c 6973 696f 6e73 2062  oid collisions b
+00014f90: 7920 6d6f 7669 6e67 2075 700a 2020 2020  y moving up.    
+00014fa0: 2020 2020 2020 2020 2020 2020 7920 2b3d              y +=
+00014fb0: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
+00014fc0: 6c6f 6361 7469 6f6e 732e 6164 6428 2878  locations.add((x
+00014fd0: 2c20 7929 290a 0a20 2020 2020 2020 2020  , y))..         
+00014fe0: 2020 2078 735b 7467 5d2c 2079 735b 7467     xs[tg], ys[tg
+00014ff0: 5d20 3d20 782c 2079 0a0a 2020 2020 2020  ] = x, y..      
+00015000: 2020 2020 2020 2320 696e 666f 206e 6565        # info nee
+00015010: 6465 6420 666f 7220 6e6f 6465 206c 6179  ded for node lay
+00015020: 6f75 7420 746f 2063 6f6c 756d 6e20 6461  out to column da
+00015030: 7461 2073 6f75 7263 650a 2020 2020 2020  ta source.      
+00015040: 2020 2020 2020 6e6f 6465 735f 6c61 796f        nodes_layo
+00015050: 7574 5b74 675d 203d 207b 2278 223a 2078  ut[tg] = {"x": x
+00015060: 735b 7467 5d2c 2022 7922 3a20 7973 5b74  s[tg], "y": ys[t
+00015070: 675d 7d0a 0a20 2020 2020 2020 2020 2020  g]}..           
+00015080: 2023 2069 6e66 6f20 6e65 6564 6564 2066   # info needed f
+00015090: 6f72 2061 7272 6f77 206c 6179 6f75 740a  or arrow layout.
+000150a0: 2020 2020 2020 2020 2020 2020 6172 726f              arro
+000150b0: 7773 5f6c 6179 6f75 745b 7467 5d20 3d20  ws_layout[tg] = 
+000150c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000150d0: 2020 226e 7374 6172 7422 3a20 6465 7065    "nstart": depe
+000150e0: 6e64 656e 6369 6573 5b74 675d 2c0a 2020  ndencies[tg],.  
+000150f0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+00015100: 656e 6422 3a20 5b74 675d 202a 206c 656e  end": [tg] * len
+00015110: 2864 6570 656e 6465 6e63 6965 735b 7467  (dependencies[tg
+00015120: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+00015130: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
+00015140: 6e20 6e6f 6465 735f 6c61 796f 7574 2c20  n nodes_layout, 
+00015150: 6172 726f 7773 5f6c 6179 6f75 740a 0a20  arrows_layout.. 
+00015160: 2020 2064 6566 2063 6f6d 7075 7465 5f73     def compute_s
+00015170: 697a 6528 7365 6c66 2c20 782c 206d 696e  ize(self, x, min
+00015180: 5f62 6f78 2c20 6d61 785f 626f 7829 3a0a  _box, max_box):.
+00015190: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+000151a0: 302e 340a 2020 2020 2020 2020 656e 6420  0.4.        end 
+000151b0: 3d20 302e 380a 0a20 2020 2020 2020 2079  = 0.8..        y
+000151c0: 203d 2028 656e 6420 2d20 7374 6172 7429   = (end - start)
+000151d0: 202f 2028 6d61 785f 626f 7820 2d20 6d69   / (max_box - mi
+000151e0: 6e5f 626f 7829 202a 2028 7820 2d20 6d69  n_box) * (x - mi
+000151f0: 6e5f 626f 7829 202b 2073 7461 7274 0a0a  n_box) + start..
+00015200: 2020 2020 2020 2020 7265 7475 726e 2079          return y
+00015210: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
+00015220: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
+00015230: 6f6e 0a20 2020 2064 6566 2075 7064 6174  on.    def updat
+00015240: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00015250: 2069 6620 7365 6c66 2e73 6368 6564 756c   if self.schedul
+00015260: 6572 2e74 7261 6e73 6974 696f 6e5f 636f  er.transition_co
+00015270: 756e 7465 7220 3d3d 2073 656c 662e 6f6c  unter == self.ol
+00015280: 645f 636f 756e 7465 723a 0a20 2020 2020  d_counter:.     
+00015290: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+000152a0: 2020 2020 2020 7365 6c66 2e6f 6c64 5f63        self.old_c
+000152b0: 6f75 6e74 6572 203d 2073 656c 662e 7363  ounter = self.sc
+000152c0: 6865 6475 6c65 722e 7472 616e 7369 7469  heduler.transiti
+000152d0: 6f6e 5f63 6f75 6e74 6572 0a0a 2020 2020  on_counter..    
+000152e0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+000152f0: 7363 6865 6475 6c65 722e 7461 736b 5f67  scheduler.task_g
+00015300: 726f 7570 733a 0a20 2020 2020 2020 2020  roups:.         
+00015310: 2020 2073 656c 662e 7375 6274 6974 6c65     self.subtitle
+00015320: 2e74 6578 7420 3d20 2253 6368 6564 756c  .text = "Schedul
+00015330: 6572 2069 7320 656d 7074 792e 220a 2020  er is empty.".  
+00015340: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00015350: 2020 2020 2020 2020 7365 6c66 2e73 7562          self.sub
+00015360: 7469 746c 652e 7465 7874 203d 2022 2022  title.text = " "
+00015370: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00015380: 662e 6e6f 6465 735f 6c61 796f 7574 2e6b  f.nodes_layout.k
+00015390: 6579 7328 2920 213d 2073 656c 662e 7363  eys() != self.sc
+000153a0: 6865 6475 6c65 722e 7461 736b 5f67 726f  heduler.task_gro
+000153b0: 7570 732e 6b65 7973 2829 3a0a 2020 2020  ups.keys():.    
+000153c0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+000153d0: 6573 5f6c 6179 6f75 742c 2073 656c 662e  es_layout, self.
+000153e0: 6172 726f 7773 5f6c 6179 6f75 7420 3d20  arrows_layout = 
+000153f0: 7365 6c66 2e75 7064 6174 655f 6c61 796f  self.update_layo
+00015400: 7574 2829 0a0a 2020 2020 2020 2020 6e6f  ut()..        no
+00015410: 6465 735f 6461 7461 203d 207b 0a20 2020  des_data = {.   
+00015420: 2020 2020 2020 2020 2022 7822 3a20 5b5d           "x": []
+00015430: 2c0a 2020 2020 2020 2020 2020 2020 2279  ,.            "y
+00015440: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015450: 2020 2022 775f 626f 7822 3a20 5b5d 2c0a     "w_box": [],.
+00015460: 2020 2020 2020 2020 2020 2020 2268 5f62              "h_b
+00015470: 6f78 223a 205b 5d2c 0a20 2020 2020 2020  ox": [],.       
+00015480: 2020 2020 2022 6e61 6d65 223a 205b 5d2c       "name": [],
+00015490: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
+000154a0: 6c6f 7222 3a20 5b5d 2c0a 2020 2020 2020  lor": [],.      
+000154b0: 2020 2020 2020 2274 6f74 5f74 6173 6b73        "tot_tasks
+000154c0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+000154d0: 2020 2022 785f 7374 6172 7422 3a20 5b5d     "x_start": []
+000154e0: 2c0a 2020 2020 2020 2020 2020 2020 2278  ,.            "x
+000154f0: 5f65 6e64 223a 205b 5d2c 0a20 2020 2020  _end": [],.     
+00015500: 2020 2020 2020 2022 795f 7374 6172 7422         "y_start"
+00015510: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015520: 2020 2279 5f65 6e64 223a 205b 5d2c 0a20    "y_end": [],. 
+00015530: 2020 2020 2020 2020 2020 2022 785f 656e             "x_en
+00015540: 645f 7072 6f67 7265 7373 223a 205b 5d2c  d_progress": [],
+00015550: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00015560: 6d5f 616c 7068 6122 3a20 5b5d 2c0a 2020  m_alpha": [],.  
+00015570: 2020 2020 2020 2020 2020 226e 6f64 655f            "node_
+00015580: 6c69 6e65 5f77 6964 7468 223a 205b 5d2c  line_width": [],
+00015590: 0a20 2020 2020 2020 2020 2020 2022 636f  .            "co
+000155a0: 6d70 5f74 6173 6b73 223a 205b 5d2c 0a20  mp_tasks": [],. 
+000155b0: 2020 2020 2020 2020 2020 2022 7572 6c5f             "url_
+000155c0: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
+000155d0: 2020 2020 2020 2022 785f 6c6f 676f 223a         "x_logo":
+000155e0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000155f0: 2022 795f 6c6f 676f 223a 205b 5d2c 0a20   "y_logo": [],. 
+00015600: 2020 2020 2020 2020 2020 2022 775f 6c6f             "w_lo
+00015610: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
+00015620: 2020 2020 2022 685f 6c6f 676f 223a 205b       "h_logo": [
+00015630: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
+00015640: 696e 5f70 726f 6365 7373 696e 6722 3a20  in_processing": 
+00015650: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00015660: 2269 6e5f 6d65 6d6f 7279 223a 205b 5d2c  "in_memory": [],
+00015670: 0a20 2020 2020 2020 2020 2020 2022 696e  .            "in
+00015680: 5f72 656c 6561 7365 6422 3a20 5b5d 2c0a  _released": [],.
+00015690: 2020 2020 2020 2020 2020 2020 2269 6e5f              "in_
+000156a0: 6572 7265 6422 3a20 5b5d 2c0a 2020 2020  erred": [],.    
+000156b0: 2020 2020 2020 2020 2263 6f6d 7075 7465          "compute
+000156c0: 5f74 696d 6522 3a20 5b5d 2c0a 2020 2020  _time": [],.    
+000156d0: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
+000156e0: 3a20 5b5d 2c0a 2020 2020 2020 2020 7d0a  : [],.        }.
+000156f0: 0a20 2020 2020 2020 2061 7272 6f77 735f  .        arrows_
+00015700: 6461 7461 203d 207b 0a20 2020 2020 2020  data = {.       
+00015710: 2020 2020 2022 7873 223a 205b 5d2c 0a20       "xs": [],. 
+00015720: 2020 2020 2020 2020 2020 2022 7973 223a             "ys":
+00015730: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00015740: 2022 7865 223a 205b 5d2c 0a20 2020 2020   "xe": [],.     
+00015750: 2020 2020 2020 2022 7965 223a 205b 5d2c         "ye": [],
+00015760: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00015770: 2020 2020 6475 7261 7469 6f6e 7320 3d20      durations = 
+00015780: 7365 7428 290a 2020 2020 2020 2020 6e62  set().        nb
+00015790: 7974 6573 203d 2073 6574 2829 0a20 2020  ytes = set().   
+000157a0: 2020 2020 2066 6f72 2074 6720 696e 2073       for tg in s
+000157b0: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+000157c0: 736b 5f67 726f 7570 732e 7661 6c75 6573  sk_groups.values
+000157d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000157e0: 6966 2074 672e 6475 7261 7469 6f6e 2061  if tg.duration a
+000157f0: 6e64 2074 672e 6e62 7974 6573 5f74 6f74  nd tg.nbytes_tot
+00015800: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
+00015810: 2020 2020 6475 7261 7469 6f6e 732e 6164      durations.ad
+00015820: 6428 7467 2e64 7572 6174 696f 6e29 0a20  d(tg.duration). 
+00015830: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00015840: 6279 7465 732e 6164 6428 7467 2e6e 6279  bytes.add(tg.nby
+00015850: 7465 735f 746f 7461 6c29 0a0a 2020 2020  tes_total)..    
+00015860: 2020 2020 6475 7261 7469 6f6e 735f 6d69      durations_mi
+00015870: 6e20 3d20 6d69 6e28 6475 7261 7469 6f6e  n = min(duration
+00015880: 732c 2064 6566 6175 6c74 3d30 290a 2020  s, default=0).  
+00015890: 2020 2020 2020 6475 7261 7469 6f6e 735f        durations_
+000158a0: 6d61 7820 3d20 6d61 7828 6475 7261 7469  max = max(durati
+000158b0: 6f6e 732c 2064 6566 6175 6c74 3d30 290a  ons, default=0).
+000158c0: 2020 2020 2020 2020 6e62 7974 6573 5f6d          nbytes_m
+000158d0: 696e 203d 206d 696e 286e 6279 7465 732c  in = min(nbytes,
+000158e0: 2064 6566 6175 6c74 3d30 290a 2020 2020   default=0).    
+000158f0: 2020 2020 6e62 7974 6573 5f6d 6178 203d      nbytes_max =
+00015900: 206d 6178 286e 6279 7465 732c 2064 6566   max(nbytes, def
+00015910: 6175 6c74 3d30 290a 0a20 2020 2020 2020  ault=0)..       
+00015920: 2062 6f78 5f64 696d 203d 207b 7d0a 2020   box_dim = {}.  
+00015930: 2020 2020 2020 666f 7220 6b65 792c 2074        for key, t
+00015940: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
+00015950: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
+00015960: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00015970: 2020 2020 2063 6f6d 705f 7461 736b 7320       comp_tasks 
+00015980: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00015990: 2020 2020 7467 2e73 7461 7465 735b 2272      tg.states["r
+000159a0: 656c 6561 7365 6422 5d20 2b20 7467 2e73  eleased"] + tg.s
+000159b0: 7461 7465 735b 226d 656d 6f72 7922 5d20  tates["memory"] 
+000159c0: 2b20 7467 2e73 7461 7465 735b 2265 7272  + tg.states["err
+000159d0: 6564 225d 0a20 2020 2020 2020 2020 2020  ed"].           
+000159e0: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
+000159f0: 6f74 5f74 6173 6b73 203d 2073 756d 2874  ot_tasks = sum(t
+00015a00: 672e 7374 6174 6573 2e76 616c 7565 7328  g.states.values(
+00015a10: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+00015a20: 2320 636f 6d70 7574 6520 7769 6474 6820  # compute width 
+00015a30: 616e 6420 6865 6967 6874 206f 6620 626f  and height of bo
+00015a40: 7865 730a 2020 2020 2020 2020 2020 2020  xes.            
+00015a50: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+00015a60: 2020 2020 2074 672e 6475 7261 7469 6f6e       tg.duration
+00015a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015a80: 2061 6e64 2074 672e 6e62 7974 6573 5f74   and tg.nbytes_t
+00015a90: 6f74 616c 0a20 2020 2020 2020 2020 2020  otal.           
+00015aa0: 2020 2020 2061 6e64 2063 6f6d 705f 7461       and comp_ta
+00015ab0: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
+00015ac0: 2020 2020 616e 6420 6c65 6e28 6475 7261      and len(dura
+00015ad0: 7469 6f6e 7329 203e 2031 0a20 2020 2020  tions) > 1.     
+00015ae0: 2020 2020 2020 2020 2020 2061 6e64 206c             and l
+00015af0: 656e 286e 6279 7465 7329 203e 2031 0a20  en(nbytes) > 1. 
+00015b00: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
+00015b10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015b20: 7363 616c 6520 6475 7261 7469 6f6e 2028  scale duration (
+00015b30: 7769 6474 6829 0a20 2020 2020 2020 2020  width).         
+00015b40: 2020 2020 2020 2077 6964 7468 5f62 6f78         width_box
+00015b50: 203d 2073 656c 662e 636f 6d70 7574 655f   = self.compute_
+00015b60: 7369 7a65 280a 2020 2020 2020 2020 2020  size(.          
+00015b70: 2020 2020 2020 2020 2020 7467 2e64 7572            tg.dur
+00015b80: 6174 696f 6e20 2f20 636f 6d70 5f74 6173  ation / comp_tas
+00015b90: 6b73 202a 2074 6f74 5f74 6173 6b73 2c0a  ks * tot_tasks,.
+00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015bb0: 2020 2020 6d69 6e5f 626f 783d 6475 7261      min_box=dura
+00015bc0: 7469 6f6e 735f 6d69 6e20 2f20 636f 6d70  tions_min / comp
+00015bd0: 5f74 6173 6b73 202a 2074 6f74 5f74 6173  _tasks * tot_tas
+00015be0: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
+00015bf0: 2020 2020 2020 2020 6d61 785f 626f 783d          max_box=
+00015c00: 6475 7261 7469 6f6e 735f 6d61 7820 2f20  durations_max / 
+00015c10: 636f 6d70 5f74 6173 6b73 202a 2074 6f74  comp_tasks * tot
+00015c20: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
+00015c30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00015c40: 2020 2020 2020 2020 2020 2023 206e 6565             # nee
+00015c50: 6420 746f 2073 6361 6c65 206d 656d 6f72  d to scale memor
+00015c60: 7920 2868 6569 6768 7429 0a20 2020 2020  y (height).     
+00015c70: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
+00015c80: 745f 626f 7820 3d20 7365 6c66 2e63 6f6d  t_box = self.com
+00015c90: 7075 7465 5f73 697a 6528 0a20 2020 2020  pute_size(.     
+00015ca0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00015cb0: 672e 6e62 7974 6573 5f74 6f74 616c 202f  g.nbytes_total /
+00015cc0: 2063 6f6d 705f 7461 736b 7320 2a20 746f   comp_tasks * to
+00015cd0: 745f 7461 736b 732c 0a20 2020 2020 2020  t_tasks,.       
+00015ce0: 2020 2020 2020 2020 2020 2020 206d 696e               min
+00015cf0: 5f62 6f78 3d6e 6279 7465 735f 6d69 6e20  _box=nbytes_min 
+00015d00: 2f20 636f 6d70 5f74 6173 6b73 202a 2074  / comp_tasks * t
+00015d10: 6f74 5f74 6173 6b73 2c0a 2020 2020 2020  ot_tasks,.      
+00015d20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00015d30: 785f 626f 783d 6e62 7974 6573 5f6d 6178  x_box=nbytes_max
+00015d40: 202f 2063 6f6d 705f 7461 736b 7320 2a20   / comp_tasks * 
+00015d50: 746f 745f 7461 736b 732c 0a20 2020 2020  tot_tasks,.     
+00015d60: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00015d70: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d90: 7769 6474 685f 626f 7820 3d20 302e 360a  width_box = 0.6.
+00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015db0: 6865 6967 6874 5f62 6f78 203d 2077 6964  height_box = wid
+00015dc0: 7468 5f62 6f78 202f 2032 0a0a 2020 2020  th_box / 2..    
+00015dd0: 2020 2020 2020 2020 626f 785f 6469 6d5b          box_dim[
+00015de0: 6b65 795d 203d 207b 2277 6964 7468 223a  key] = {"width":
+00015df0: 2077 6964 7468 5f62 6f78 2c20 2268 6569   width_box, "hei
+00015e00: 6768 7422 3a20 6865 6967 6874 5f62 6f78  ght": height_box
+00015e10: 7d0a 0a20 2020 2020 2020 2066 6f72 206b  }..        for k
+00015e20: 6579 2c20 7467 2069 6e20 7365 6c66 2e73  ey, tg in self.s
+00015e30: 6368 6564 756c 6572 2e74 6173 6b5f 6772  cheduler.task_gr
+00015e40: 6f75 7073 2e69 7465 6d73 2829 3a0a 2020  oups.items():.  
+00015e50: 2020 2020 2020 2020 2020 7820 3d20 7365            x = se
+00015e60: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 745b  lf.nodes_layout[
+00015e70: 6b65 795d 5b22 7822 5d0a 2020 2020 2020  key]["x"].      
+00015e80: 2020 2020 2020 7920 3d20 7365 6c66 2e6e        y = self.n
+00015e90: 6f64 6573 5f6c 6179 6f75 745b 6b65 795d  odes_layout[key]
+00015ea0: 5b22 7922 5d0a 2020 2020 2020 2020 2020  ["y"].          
+00015eb0: 2020 7769 6474 6820 3d20 626f 785f 6469    width = box_di
+00015ec0: 6d5b 6b65 795d 5b22 7769 6474 6822 5d0a  m[key]["width"].
+00015ed0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00015ee0: 6874 203d 2062 6f78 5f64 696d 5b6b 6579  ht = box_dim[key
+00015ef0: 5d5b 2268 6569 6768 7422 5d0a 0a20 2020  ]["height"]..   
+00015f00: 2020 2020 2020 2020 2023 206d 6169 6e20           # main 
+00015f10: 626f 7865 7320 6c61 796f 7574 0a20 2020  boxes layout.   
+00015f20: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00015f30: 6174 615b 2278 225d 2e61 7070 656e 6428  ata["x"].append(
+00015f40: 7829 0a20 2020 2020 2020 2020 2020 206e  x).            n
+00015f50: 6f64 6573 5f64 6174 615b 2279 225d 2e61  odes_data["y"].a
+00015f60: 7070 656e 6428 7929 0a20 2020 2020 2020  ppend(y).       
+00015f70: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+00015f80: 2277 5f62 6f78 225d 2e61 7070 656e 6428  "w_box"].append(
+00015f90: 7769 6474 6829 0a20 2020 2020 2020 2020  width).         
+00015fa0: 2020 206e 6f64 6573 5f64 6174 615b 2268     nodes_data["h
+00015fb0: 5f62 6f78 225d 2e61 7070 656e 6428 6865  _box"].append(he
+00015fc0: 6967 6874 290a 0a20 2020 2020 2020 2020  ight)..         
+00015fd0: 2020 2063 6f6d 705f 7461 736b 7320 3d20     comp_tasks = 
+00015fe0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00015ff0: 2020 7467 2e73 7461 7465 735b 2272 656c    tg.states["rel
+00016000: 6561 7365 6422 5d20 2b20 7467 2e73 7461  eased"] + tg.sta
+00016010: 7465 735b 226d 656d 6f72 7922 5d20 2b20  tes["memory"] + 
+00016020: 7467 2e73 7461 7465 735b 2265 7272 6564  tg.states["erred
+00016030: 225d 0a20 2020 2020 2020 2020 2020 2029  "].            )
+00016040: 0a20 2020 2020 2020 2020 2020 2074 6f74  .            tot
+00016050: 5f74 6173 6b73 203d 2073 756d 2874 672e  _tasks = sum(tg.
+00016060: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
+00016070: 0a0a 2020 2020 2020 2020 2020 2020 6e6f  ..            no
+00016080: 6465 735f 6461 7461 5b22 6e61 6d65 225d  des_data["name"]
+00016090: 2e61 7070 656e 6428 7467 2e70 7265 6669  .append(tg.prefi
+000160a0: 782e 6e61 6d65 290a 0a20 2020 2020 2020  x.name)..       
+000160b0: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+000160c0: 2263 6f6c 6f72 225d 2e61 7070 656e 6428  "color"].append(
+000160d0: 636f 6c6f 725f 6f66 2874 672e 7072 6566  color_of(tg.pref
+000160e0: 6978 2e6e 616d 6529 290a 2020 2020 2020  ix.name)).      
+000160f0: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016100: 5b22 746f 745f 7461 736b 7322 5d2e 6170  ["tot_tasks"].ap
+00016110: 7065 6e64 2874 6f74 5f74 6173 6b73 290a  pend(tot_tasks).
+00016120: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+00016130: 656d 6f72 7920 616c 7068 6120 6661 6374  emory alpha fact
+00016140: 6f72 2062 7920 302e 3420 6966 206e 6f74  or by 0.4 if not
+00016150: 2067 6574 2773 2074 6f6f 2064 6172 6b0a   get's too dark.
+00016160: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00016170: 735f 6461 7461 5b22 6d65 6d5f 616c 7068  s_data["mem_alph
+00016180: 6122 5d2e 6170 7065 6e64 280a 2020 2020  a"].append(.    
+00016190: 2020 2020 2020 2020 2020 2020 2874 672e              (tg.
+000161a0: 7374 6174 6573 5b22 6d65 6d6f 7279 225d  states["memory"]
+000161b0: 202f 2073 756d 2874 672e 7374 6174 6573   / sum(tg.states
+000161c0: 2e76 616c 7565 7328 2929 2920 2a20 302e  .values())) * 0.
+000161d0: 340a 2020 2020 2020 2020 2020 2020 290a  4.            ).
+000161e0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+000161f0: 6169 6e20 626f 7820 6c69 6e65 2077 6964  ain box line wid
+00016200: 7468 0a20 2020 2020 2020 2020 2020 2069  th.            i
+00016210: 6620 7467 2e73 7461 7465 735b 2270 726f  f tg.states["pro
+00016220: 6365 7373 696e 6722 5d3a 0a20 2020 2020  cessing"]:.     
+00016230: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016240: 5f64 6174 615b 226e 6f64 655f 6c69 6e65  _data["node_line
+00016250: 5f77 6964 7468 225d 2e61 7070 656e 6428  _width"].append(
+00016260: 3529 0a20 2020 2020 2020 2020 2020 2065  5).            e
+00016270: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00016280: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+00016290: 226e 6f64 655f 6c69 6e65 5f77 6964 7468  "node_line_width
+000162a0: 225d 2e61 7070 656e 6428 3129 0a0a 2020  "].append(1)..  
+000162b0: 2020 2020 2020 2020 2020 2320 7072 6f67            # prog
+000162c0: 7265 7373 2062 6172 2064 6174 6120 7570  ress bar data up
+000162d0: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
+000162e0: 206e 6f64 6573 5f64 6174 615b 2278 5f73   nodes_data["x_s
+000162f0: 7461 7274 225d 2e61 7070 656e 6428 7820  tart"].append(x 
+00016300: 2d20 7769 6474 6820 2f20 3229 0a20 2020  - width / 2).   
+00016310: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016320: 6174 615b 2278 5f65 6e64 225d 2e61 7070  ata["x_end"].app
+00016330: 656e 6428 7820 2b20 7769 6474 6820 2f20  end(x + width / 
+00016340: 3229 0a0a 2020 2020 2020 2020 2020 2020  2)..            
+00016350: 6e6f 6465 735f 6461 7461 5b22 795f 7374  nodes_data["y_st
+00016360: 6172 7422 5d2e 6170 7065 6e64 2879 202d  art"].append(y -
+00016370: 2068 6569 6768 7420 2f20 3229 0a20 2020   height / 2).   
+00016380: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016390: 6174 615b 2279 5f65 6e64 225d 2e61 7070  ata["y_end"].app
+000163a0: 656e 6428 7920 2d20 6865 6967 6874 202f  end(y - height /
+000163b0: 2032 202b 2068 6569 6768 7420 2a20 302e   2 + height * 0.
+000163c0: 3429 0a0a 2020 2020 2020 2020 2020 2020  4)..            
+000163d0: 6e6f 6465 735f 6461 7461 5b22 785f 656e  nodes_data["x_en
+000163e0: 645f 7072 6f67 7265 7373 225d 2e61 7070  d_progress"].app
+000163f0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+00016400: 2020 2020 2078 202d 2077 6964 7468 202f       x - width /
+00016410: 2032 202b 2077 6964 7468 202a 2063 6f6d   2 + width * com
+00016420: 705f 7461 736b 7320 2f20 746f 745f 7461  p_tasks / tot_ta
+00016430: 736b 730a 2020 2020 2020 2020 2020 2020  sks.            
+00016440: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00016450: 2061 7272 6f77 730a 2020 2020 2020 2020   arrows.        
+00016460: 2020 2020 6172 726f 7773 5f64 6174 615b      arrows_data[
+00016470: 2278 7322 5d20 2b3d 205b 0a20 2020 2020  "xs"] += [.     
+00016480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016490: 6e6f 6465 735f 6c61 796f 7574 5b6b 5d5b  nodes_layout[k][
+000164a0: 2278 225d 202b 2062 6f78 5f64 696d 5b6b  "x"] + box_dim[k
+000164b0: 5d5b 2277 6964 7468 225d 202f 2032 0a20  ]["width"] / 2. 
+000164c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000164d0: 6f72 206b 2069 6e20 7365 6c66 2e61 7272  or k in self.arr
+000164e0: 6f77 735f 6c61 796f 7574 5b6b 6579 5d5b  ows_layout[key][
+000164f0: 226e 7374 6172 7422 5d0a 2020 2020 2020  "nstart"].      
+00016500: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00016510: 2020 2020 6172 726f 7773 5f64 6174 615b      arrows_data[
+00016520: 2279 7322 5d20 2b3d 205b 0a20 2020 2020  "ys"] += [.     
+00016530: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016540: 6e6f 6465 735f 6c61 796f 7574 5b6b 5d5b  nodes_layout[k][
+00016550: 2279 225d 2066 6f72 206b 2069 6e20 7365  "y"] for k in se
+00016560: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
+00016570: 5b6b 6579 5d5b 226e 7374 6172 7422 5d0a  [key]["nstart"].
+00016580: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00016590: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
+000165a0: 5f64 6174 615b 2278 6522 5d20 2b3d 205b  _data["xe"] += [
+000165b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000165c0: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
+000165d0: 7574 5b6b 5d5b 2278 225d 202d 2062 6f78  ut[k]["x"] - box
+000165e0: 5f64 696d 5b6b 5d5b 2277 6964 7468 225d  _dim[k]["width"]
+000165f0: 202f 2032 0a20 2020 2020 2020 2020 2020   / 2.           
+00016600: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
+00016610: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
+00016620: 5b6b 6579 5d5b 226e 656e 6422 5d0a 2020  [key]["nend"].  
+00016630: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+00016640: 2020 2020 2020 2020 6172 726f 7773 5f64          arrows_d
+00016650: 6174 615b 2279 6522 5d20 2b3d 205b 0a20  ata["ye"] += [. 
+00016660: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016670: 656c 662e 6e6f 6465 735f 6c61 796f 7574  elf.nodes_layout
+00016680: 5b6b 5d5b 2279 225d 2066 6f72 206b 2069  [k]["y"] for k i
+00016690: 6e20 7365 6c66 2e61 7272 6f77 735f 6c61  n self.arrows_la
+000166a0: 796f 7574 5b6b 6579 5d5b 226e 656e 6422  yout[key]["nend"
+000166b0: 5d0a 2020 2020 2020 2020 2020 2020 5d0a  ].            ].
+000166c0: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
+000166d0: 4f47 4f53 0a20 2020 2020 2020 2020 2020  OGOS.           
+000166e0: 2069 6620 6c65 6e28 7467 2e74 7970 6573   if len(tg.types
+000166f0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00016700: 2020 2020 2020 2020 6c6f 676f 5f74 7970          logo_typ
+00016710: 6520 3d20 6e65 7874 2869 7465 7228 7467  e = next(iter(tg
+00016720: 2e74 7970 6573 2929 2e73 706c 6974 2822  .types)).split("
+00016730: 2e22 295b 305d 0a20 2020 2020 2020 2020  .")[0].         
+00016740: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016760: 7572 6c5f 6c6f 676f 203d 206c 6f67 6f73  url_logo = logos
+00016770: 5f64 6963 745b 6c6f 676f 5f74 7970 655d  _dict[logo_type]
+00016780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016790: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+000167a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000167b0: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
+000167c0: 2022 220a 2020 2020 2020 2020 2020 2020   "".            
+000167d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000167e0: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
+000167f0: 2022 220a 0a20 2020 2020 2020 2020 2020   ""..           
+00016800: 206e 6f64 6573 5f64 6174 615b 2275 726c   nodes_data["url
+00016810: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2875  _logo"].append(u
+00016820: 726c 5f6c 6f67 6f29 0a0a 2020 2020 2020  rl_logo)..      
+00016830: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016840: 5b22 785f 6c6f 676f 225d 2e61 7070 656e  ["x_logo"].appen
+00016850: 6428 7820 2b20 7769 6474 6820 2f20 3329  d(x + width / 3)
+00016860: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00016870: 6573 5f64 6174 615b 2279 5f6c 6f67 6f22  es_data["y_logo"
+00016880: 5d2e 6170 7065 6e64 2879 202b 2068 6569  ].append(y + hei
+00016890: 6768 7420 2f20 3329 0a0a 2020 2020 2020  ght / 3)..      
+000168a0: 2020 2020 2020 7261 7469 6f20 3d20 7769        ratio = wi
+000168b0: 6474 6820 2f20 6865 6967 6874 0a0a 2020  dth / height..  
+000168c0: 2020 2020 2020 2020 2020 6966 2072 6174            if rat
+000168d0: 696f 203e 2031 3a0a 2020 2020 2020 2020  io > 1:.        
+000168e0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+000168f0: 7461 5b22 685f 6c6f 676f 225d 2e61 7070  ta["h_logo"].app
+00016900: 656e 6428 6865 6967 6874 202a 2030 2e33  end(height * 0.3
+00016910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016920: 2020 6e6f 6465 735f 6461 7461 5b22 775f    nodes_data["w_
+00016930: 6c6f 676f 225d 2e61 7070 656e 6428 7769  logo"].append(wi
+00016940: 6474 6820 2a20 302e 3320 2f20 7261 7469  dth * 0.3 / rati
+00016950: 6f29 0a20 2020 2020 2020 2020 2020 2065  o).            e
+00016960: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00016970: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+00016980: 2268 5f6c 6f67 6f22 5d2e 6170 7065 6e64  "h_logo"].append
+00016990: 2868 6569 6768 7420 2a20 302e 3320 2a20  (height * 0.3 * 
+000169a0: 7261 7469 6f29 0a20 2020 2020 2020 2020  ratio).         
+000169b0: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+000169c0: 615b 2277 5f6c 6f67 6f22 5d2e 6170 7065  a["w_logo"].appe
+000169d0: 6e64 2877 6964 7468 202a 2030 2e33 290a  nd(width * 0.3).
+000169e0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
+000169f0: 6f6d 7075 7465 5f74 696d 6520 616e 6420  ompute_time and 
+00016a00: 6d65 6d6f 7279 0a20 2020 2020 2020 2020  memory.         
+00016a10: 2020 206e 6f64 6573 5f64 6174 615b 2263     nodes_data["c
+00016a20: 6f6d 7075 7465 5f74 696d 6522 5d2e 6170  ompute_time"].ap
+00016a30: 7065 6e64 2866 6f72 6d61 745f 7469 6d65  pend(format_time
+00016a40: 2874 672e 6475 7261 7469 6f6e 2929 0a20  (tg.duration)). 
+00016a50: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016a60: 5f64 6174 615b 226d 656d 6f72 7922 5d2e  _data["memory"].
+00016a70: 6170 7065 6e64 2866 6f72 6d61 745f 6279  append(format_by
+00016a80: 7465 7328 7467 2e6e 6279 7465 735f 746f  tes(tg.nbytes_to
+00016a90: 7461 6c29 290a 0a20 2020 2020 2020 2020  tal))..         
+00016aa0: 2020 2023 2041 6464 2073 6f6d 6520 7374     # Add some st
+00016ab0: 6174 7573 2074 6f20 686f 7665 720a 2020  atus to hover.  
+00016ac0: 2020 2020 2020 2020 2020 7461 736b 735f            tasks_
+00016ad0: 7072 6f63 6573 7369 6e67 203d 2074 672e  processing = tg.
+00016ae0: 7374 6174 6573 5b22 7072 6f63 6573 7369  states["processi
+00016af0: 6e67 225d 0a20 2020 2020 2020 2020 2020  ng"].           
+00016b00: 2074 6173 6b73 5f6d 656d 6f72 7920 3d20   tasks_memory = 
+00016b10: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
+00016b20: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
+00016b30: 7461 736b 735f 7265 6c61 7365 6420 3d20  tasks_relased = 
+00016b40: 7467 2e73 7461 7465 735b 2272 656c 6561  tg.states["relea
+00016b50: 7365 6422 5d0a 2020 2020 2020 2020 2020  sed"].          
+00016b60: 2020 7461 736b 735f 6572 7265 6420 3d20    tasks_erred = 
+00016b70: 7467 2e73 7461 7465 735b 2265 7272 6564  tg.states["erred
+00016b80: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
+00016b90: 6e6f 6465 735f 6461 7461 5b22 636f 6d70  nodes_data["comp
+00016ba0: 5f74 6173 6b73 225d 2e61 7070 656e 6428  _tasks"].append(
+00016bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016bc0: 2066 227b 636f 6d70 5f74 6173 6b73 7d20   f"{comp_tasks} 
+00016bd0: 287b 636f 6d70 5f74 6173 6b73 202f 2074  ({comp_tasks / t
+00016be0: 6f74 5f74 6173 6b73 202a 2031 3030 3a2e  ot_tasks * 100:.
+00016bf0: 3066 7d20 2529 220a 2020 2020 2020 2020  0f} %)".        
+00016c00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00016c10: 2020 6e6f 6465 735f 6461 7461 5b22 696e    nodes_data["in
+00016c20: 5f70 726f 6365 7373 696e 6722 5d2e 6170  _processing"].ap
+00016c30: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+00016c40: 2020 2020 2020 6622 7b74 6173 6b73 5f70        f"{tasks_p
+00016c50: 726f 6365 7373 696e 677d 2028 7b74 6173  rocessing} ({tas
+00016c60: 6b73 5f70 726f 6365 7373 696e 672f 2074  ks_processing/ t
+00016c70: 6f74 5f74 6173 6b73 202a 2031 3030 3a2e  ot_tasks * 100:.
+00016c80: 3066 7d20 2529 220a 2020 2020 2020 2020  0f} %)".        
+00016c90: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00016ca0: 2020 6e6f 6465 735f 6461 7461 5b22 696e    nodes_data["in
+00016cb0: 5f6d 656d 6f72 7922 5d2e 6170 7065 6e64  _memory"].append
+00016cc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016cd0: 2020 6622 7b74 6173 6b73 5f6d 656d 6f72    f"{tasks_memor
+00016ce0: 797d 2028 7b74 6173 6b73 5f6d 656d 6f72  y} ({tasks_memor
+00016cf0: 792f 2074 6f74 5f74 6173 6b73 202a 2031  y/ tot_tasks * 1
+00016d00: 3030 3a2e 3066 7d20 2529 220a 2020 2020  00:.0f} %)".    
+00016d10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00016d20: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016d30: 5b22 696e 5f72 656c 6561 7365 6422 5d2e  ["in_released"].
+00016d40: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00016d50: 2020 2020 2020 2020 6622 7b74 6173 6b73          f"{tasks
+00016d60: 5f72 656c 6173 6564 7d20 287b 7461 736b  _relased} ({task
+00016d70: 735f 7265 6c61 7365 642f 2074 6f74 5f74  s_relased/ tot_t
+00016d80: 6173 6b73 202a 2031 3030 3a2e 3066 7d20  asks * 100:.0f} 
+00016d90: 2529 220a 2020 2020 2020 2020 2020 2020  %)".            
+00016da0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
+00016db0: 6465 735f 6461 7461 5b22 696e 5f65 7272  des_data["in_err
+00016dc0: 6564 225d 2e61 7070 656e 6428 0a20 2020  ed"].append(.   
+00016dd0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+00016de0: 2074 6173 6b73 5f65 7272 6564 7d20 287b   tasks_erred} ({
+00016df0: 7461 736b 735f 6572 7265 642f 2074 6f74  tasks_erred/ tot
+00016e00: 5f74 6173 6b73 202a 2031 3030 3a2e 3066  _tasks * 100:.0f
+00016e10: 7d20 2529 220a 2020 2020 2020 2020 2020  } %)".          
+00016e20: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00016e30: 662e 6e6f 6465 735f 736f 7572 6365 2e64  f.nodes_source.d
+00016e40: 6174 612e 7570 6461 7465 286e 6f64 6573  ata.update(nodes
+00016e50: 5f64 6174 6129 0a20 2020 2020 2020 2073  _data).        s
+00016e60: 656c 662e 6172 726f 7773 5f73 6f75 7263  elf.arrows_sourc
+00016e70: 652e 6461 7461 2e75 7064 6174 6528 6172  e.data.update(ar
+00016e80: 726f 7773 5f64 6174 6129 0a0a 0a63 6c61  rows_data)...cla
+00016e90: 7373 2054 6173 6b47 726f 7570 5072 6f67  ss TaskGroupProg
+00016ea0: 7265 7373 2844 6173 6862 6f61 7264 436f  ress(DashboardCo
+00016eb0: 6d70 6f6e 656e 7429 3a0a 2020 2020 2222  mponent):.    ""
+00016ec0: 2253 7461 636b 6564 2061 7265 6120 6368  "Stacked area ch
+00016ed0: 6172 7420 7368 6f77 696e 6720 7461 736b  art showing task
+00016ee0: 2067 726f 7570 7320 7468 726f 7567 6820   groups through 
+00016ef0: 7469 6d65 2222 220a 0a20 2020 2064 6566  time"""..    def
+00016f00: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00016f10: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
+00016f20: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
+00016f30: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
+00016f40: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
+00016f50: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
+00016f60: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
+00016f70: 290a 2020 2020 2020 2020 2320 5468 6520  ).        # The 
+00016f80: 6c65 6e67 7468 206f 6620 7469 6d65 7365  length of timese
+00016f90: 7269 6573 2074 6f20 6368 6172 7420 2869  ries to chart (i
+00016fa0: 6e20 756e 6974 7320 6f66 2070 6c75 6769  n units of plugi
+00016fb0: 6e2e 6474 290a 2020 2020 2020 2020 7365  n.dt).        se
+00016fc0: 6c66 2e6e 7074 7320 3d20 3138 300a 0a20  lf.npts = 180.. 
+00016fd0: 2020 2020 2020 2069 6620 4772 6f75 7054         if GroupT
+00016fe0: 696d 696e 672e 6e61 6d65 206e 6f74 2069  iming.name not i
+00016ff0: 6e20 7363 6865 6475 6c65 722e 706c 7567  n scheduler.plug
+00017000: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
+00017010: 2073 6368 6564 756c 6572 2e61 6464 5f70   scheduler.add_p
+00017020: 6c75 6769 6e28 706c 7567 696e 3d47 726f  lugin(plugin=Gro
+00017030: 7570 5469 6d69 6e67 2873 6368 6564 756c  upTiming(schedul
+00017040: 6572 2929 0a0a 2020 2020 2020 2020 7365  er))..        se
+00017050: 6c66 2e70 6c75 6769 6e20 3d20 7363 6865  lf.plugin = sche
+00017060: 6475 6c65 722e 706c 7567 696e 735b 4772  duler.plugins[Gr
+00017070: 6f75 7054 696d 696e 672e 6e61 6d65 5d0a  oupTiming.name].
+00017080: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00017090: 7572 6365 2e61 6464 286e 702e 6172 7261  urce.add(np.arra
+000170a0: 7928 7365 6c66 2e70 6c75 6769 6e2e 7469  y(self.plugin.ti
+000170b0: 6d65 2920 2a20 3130 3030 2e30 2c20 2274  me) * 1000.0, "t
+000170c0: 696d 6522 290a 0a20 2020 2020 2020 2078  ime")..        x
+000170d0: 5f72 616e 6765 203d 2044 6174 6152 616e  _range = DataRan
+000170e0: 6765 3164 2872 616e 6765 5f70 6164 6469  ge1d(range_paddi
+000170f0: 6e67 3d30 290a 2020 2020 2020 2020 795f  ng=0).        y_
+00017100: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
+00017110: 302c 206d 6178 2873 656c 662e 706c 7567  0, max(self.plug
+00017120: 696e 2e6e 7468 7265 6164 7329 290a 0a20  in.nthreads)).. 
+00017130: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00017140: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
+00017150: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
+00017160: 736b 2047 726f 7570 2050 726f 6772 6573  sk Group Progres
+00017170: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00017180: 6e61 6d65 3d22 7461 736b 5f67 726f 7570  name="task_group
+00017190: 5f70 726f 6772 6573 7322 2c0a 2020 2020  _progress",.    
+000171a0: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
+000171b0: 6c6f 6361 7469 6f6e 3d22 6162 6f76 6522  location="above"
+000171c0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
+000171d0: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
+000171e0: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
+000171f0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
+00017200: 0a20 2020 2020 2020 2020 2020 2079 5f72  .            y_r
+00017210: 616e 6765 3d79 5f72 616e 6765 2c0a 2020  ange=y_range,.  
+00017220: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00017230: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00017240: 785f 6178 6973 5f74 7970 653d 2264 6174  x_axis_type="dat
+00017250: 6574 696d 6522 2c0a 2020 2020 2020 2020  etime",.        
+00017260: 2020 2020 795f 6178 6973 5f6c 6f63 6174      y_axis_locat
+00017270: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
+00017280: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00017290: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000172a0: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
+000172b0: 732e 6d61 6a6f 725f 6c61 6265 6c5f 7465  s.major_label_te
+000172c0: 7874 5f61 6c70 6861 203d 2030 0a20 2020  xt_alpha = 0.   
+000172d0: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+000172e0: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
+000172f0: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
+00017300: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00017310: 2e79 6178 6973 2e6d 616a 6f72 5f74 6963  .yaxis.major_tic
+00017320: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
+00017330: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00017340: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
+00017350: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+00017360: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00017370: 746f 6f6c 7328 0a20 2020 2020 2020 2020  tools(.         
+00017380: 2020 2042 6f78 5a6f 6f6d 546f 6f6c 2829     BoxZoomTool()
+00017390: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
+000173a0: 7365 7454 6f6f 6c28 292c 0a20 2020 2020  setTool(),.     
+000173b0: 2020 2020 2020 2050 616e 546f 6f6c 2864         PanTool(d
+000173c0: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
+000173d0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000173e0: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
+000173f0: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
+00017400: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+00017410: 2020 2020 2073 656c 662e 5f68 6f76 6572       self._hover
+00017420: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00017430: 7365 6c66 2e5f 6c61 7374 5f64 7261 776e  self._last_drawn
+00017440: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00017450: 7365 6c66 2e5f 6f66 6673 6574 203d 2074  self._offset = t
+00017460: 696d 6528 290a 2020 2020 2020 2020 7365  ime().        se
+00017470: 6c66 2e5f 6c61 7374 5f74 7261 6e73 6974  lf._last_transit
+00017480: 696f 6e5f 636f 756e 7420 3d20 7363 6865  ion_count = sche
+00017490: 6475 6c65 722e 7472 616e 7369 7469 6f6e  duler.transition
+000174a0: 5f63 6f75 6e74 6572 0a20 2020 2020 2020  _counter.       
+000174b0: 2023 204f 7264 6572 6564 4469 6374 2073   # OrderedDict s
+000174c0: 6f20 7765 2063 616e 206d 616b 6520 6120  o we can make a 
+000174d0: 7265 7665 7273 6520 6974 6572 6174 6f72  reverse iterator
+000174e0: 206c 6174 6572 2061 6e64 2067 6574 2074   later and get t
+000174f0: 6865 0a20 2020 2020 2020 2023 206d 6f73  he.        # mos
+00017500: 742d 7265 6365 6e74 6c79 2d61 6464 6564  t-recently-added
+00017510: 2067 6c79 7068 732e 0a20 2020 2020 2020   glyphs..       
+00017520: 2073 656c 662e 5f72 656e 6465 7265 7273   self._renderers
+00017530: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
+00017540: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00017550: 696e 655f 7265 6e64 6572 6572 7320 3d20  ine_renderers = 
+00017560: 4f72 6465 7265 6444 6963 7428 290a 0a20  OrderedDict().. 
+00017570: 2020 2064 6566 205f 7368 6f75 6c64 5f61     def _should_a
+00017580: 6464 5f6e 6577 5f72 656e 6465 7265 7273  dd_new_renderers
+00017590: 2873 656c 6629 202d 3e20 626f 6f6c 3a0a  (self) -> bool:.
+000175a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000175b0: 2020 2020 5768 6574 6865 7220 746f 2061      Whether to a
+000175c0: 6464 206e 6577 2072 656e 6465 7265 7273  dd new renderers
+000175d0: 2074 6f20 7468 6520 6368 6172 742e 0a0a   to the chart...
+000175e0: 2020 2020 2020 2020 5768 656e 2061 206e          When a n
+000175f0: 6577 2073 6574 206f 6620 7461 736b 2067  ew set of task g
+00017600: 726f 7570 7320 656e 7465 7273 2074 6865  roups enters the
+00017610: 2073 6368 6564 756c 6572 2077 6527 6420   scheduler we'd 
+00017620: 6c69 6b65 2074 6f20 7374 6172 7420 7265  like to start re
+00017630: 6e64 6572 696e 670a 2020 2020 2020 2020  ndering.        
+00017640: 7468 656d 2e20 4275 7420 6974 2063 616e  them. But it can
+00017650: 2062 6520 6578 7065 6e73 6976 6520 746f   be expensive to
+00017660: 2061 6464 206e 6577 2067 6c79 7073 2c20   add new glyps, 
+00017670: 736f 2077 6520 646f 2069 7420 6465 6c69  so we do it deli
+00017680: 6265 7261 7465 6c79 2c0a 2020 2020 2020  berately,.      
+00017690: 2020 6368 6563 6b69 6e67 2077 6865 7468    checking wheth
+000176a0: 6572 2077 6520 6861 7665 2074 6f20 646f  er we have to do
+000176b0: 2069 7420 616e 6420 7768 6574 6865 7220   it and whether 
+000176c0: 7468 6520 7363 6865 6475 6c65 7220 7365  the scheduler se
+000176d0: 656d 7320 6275 7379 2e0a 2020 2020 2020  ems busy..      
+000176e0: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
+000176f0: 416c 7761 7973 2064 7261 7720 6966 2077  Always draw if w
+00017700: 6520 6861 7665 206e 6f74 2062 6566 6f72  e have not befor
+00017710: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+00017720: 2073 656c 662e 5f6c 6173 745f 6472 6177   self._last_draw
+00017730: 6e3a 0a20 2020 2020 2020 2020 2020 2072  n:.            r
+00017740: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
+00017750: 2020 2023 2044 6f6e 2774 2064 7261 7720     # Don't draw 
+00017760: 6966 2074 6865 7265 2068 6176 6520 6265  if there have be
+00017770: 656e 206e 6f20 6e65 7720 7461 736b 7320  en no new tasks 
+00017780: 636f 6d70 6c65 7465 6420 7369 6e63 6520  completed since 
+00017790: 7468 6520 6c61 7374 2075 7064 6174 652c  the last update,
+000177a0: 0a20 2020 2020 2020 2023 206f 7220 6966  .        # or if
+000177b0: 2074 6865 2073 6368 6564 756c 6572 2043   the scheduler C
+000177c0: 5055 2069 7320 6f63 6375 7069 6564 2e0a  PU is occupied..
+000177d0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+000177e0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+000177f0: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
+00017800: 6f75 6e74 203d 3d20 7365 6c66 2e73 6368  ount == self.sch
+00017810: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00017820: 6e5f 636f 756e 7465 720a 2020 2020 2020  n_counter.      
+00017830: 2020 2020 2020 6f72 2073 656c 662e 7363        or self.sc
+00017840: 6865 6475 6c65 722e 7072 6f63 2e63 7075  heduler.proc.cpu
+00017850: 5f70 6572 6365 6e74 2829 203e 2035 300a  _percent() > 50.
+00017860: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00017870: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00017880: 6c73 650a 0a20 2020 2020 2020 2023 204f  lse..        # O
+00017890: 6e6c 7920 7265 7475 726e 2074 7275 6520  nly return true 
+000178a0: 6966 2074 6865 7265 2061 7265 206e 6577  if there are new
+000178b0: 2074 6173 6b20 6772 6f75 7073 2074 6861   task groups tha
+000178c0: 7420 7765 2068 6176 6520 6e6f 7420 7965  t we have not ye
+000178d0: 7420 6164 6465 640a 2020 2020 2020 2020  t added.        
+000178e0: 2320 746f 2074 6865 2043 6f6c 756d 6e44  # to the ColumnD
+000178f0: 6174 6153 6f75 7263 652e 0a20 2020 2020  ataSource..     
+00017900: 2020 2072 6574 7572 6e20 6e6f 7420 7365     return not se
+00017910: 7428 7365 6c66 2e70 6c75 6769 6e2e 636f  t(self.plugin.co
+00017920: 6d70 7574 652e 6b65 7973 2829 2920 3c3d  mpute.keys()) <=
+00017930: 2073 6574 2873 656c 662e 736f 7572 6365   set(self.source
+00017940: 2e64 6174 612e 6b65 7973 2829 290a 0a20  .data.keys()).. 
+00017950: 2020 2064 6566 205f 7368 6f75 6c64 5f75     def _should_u
+00017960: 7064 6174 6528 7365 6c66 2920 2d3e 2062  pdate(self) -> b
+00017970: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+00017980: 0a20 2020 2020 2020 2057 6865 7468 6572  .        Whether
+00017990: 2074 6f20 7570 6461 7465 2074 6865 2043   to update the C
+000179a0: 6f6c 756d 6e44 6174 6153 6f75 7263 652e  olumnDataSource.
+000179b0: 2054 6869 7320 6973 2063 6865 6170 6572   This is cheaper
+000179c0: 2074 6861 6e20 7265 6472 6177 696e 672c   than redrawing,
+000179d0: 0a20 2020 2020 2020 2062 7574 2073 7469  .        but sti
+000179e0: 6c6c 206e 6f74 2066 7265 652c 2073 6f20  ll not free, so 
+000179f0: 7765 2063 6865 636b 2077 6865 7468 6572  we check whether
+00017a00: 2077 6520 6e65 6564 2069 7420 616e 6420   we need it and 
+00017a10: 7768 6574 6865 7220 7468 6520 7363 6865  whether the sche
+00017a20: 7564 6c65 720a 2020 2020 2020 2020 6973  udler.        is
+00017a30: 2062 7573 792e 0a20 2020 2020 2020 2022   busy..        "
+00017a40: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00017a50: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00017a60: 7365 6c66 2e5f 6c61 7374 5f74 7261 6e73  self._last_trans
+00017a70: 6974 696f 6e5f 636f 756e 7420 213d 2073  ition_count != s
+00017a80: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
+00017a90: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00017aa0: 0a20 2020 2020 2020 2020 2020 2061 6e64  .            and
+00017ab0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00017ac0: 7072 6f63 2e63 7075 5f70 6572 6365 6e74  proc.cpu_percent
+00017ad0: 2829 203c 2035 300a 2020 2020 2020 2020  () < 50.        
+00017ae0: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
+00017af0: 7469 6d65 7365 7269 6573 2873 656c 662c  timeseries(self,
+00017b00: 2072 6573 7472 6963 745f 746f 5f65 7869   restrict_to_exi
+00017b10: 7374 696e 673d 4661 6c73 6529 3a0a 2020  sting=False):.  
+00017b20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00017b30: 2020 5570 6461 7465 2074 6865 2043 6f6c    Update the Col
+00017b40: 756d 6e44 6174 6153 6f75 7263 6520 7769  umnDataSource wi
+00017b50: 7468 206f 7572 2074 696d 6520 7365 7269  th our time seri
+00017b60: 6573 2064 6174 612e 0a0a 2020 2020 2020  es data...      
+00017b70: 2020 7265 7374 7269 6374 5f74 6f5f 6578    restrict_to_ex
+00017b80: 6973 7469 6e67 2064 6574 6572 6d69 6e65  isting determine
+00017b90: 7320 7768 6574 6865 7220 746f 2061 6464  s whether to add
+00017ba0: 206e 6577 2074 6173 6b20 6772 6f75 7073   new task groups
+00017bb0: 0a20 2020 2020 2020 2077 6869 6368 206d  .        which m
+00017bc0: 6967 6874 2068 6176 6520 6265 656e 2061  ight have been a
+00017bd0: 6464 6564 2073 696e 6365 2074 6865 206c  dded since the l
+00017be0: 6173 7420 7469 6d65 2077 6520 7265 6e64  ast time we rend
+00017bf0: 6572 6564 2e0a 2020 2020 2020 2020 5468  ered..        Th
+00017c00: 6973 2069 7320 696d 706f 7274 616e 7420  is is important 
+00017c10: 6173 2077 6520 7761 6e74 2074 6f20 6164  as we want to ad
+00017c20: 6420 6e65 7720 7374 6163 6b65 7273 2076  d new stackers v
+00017c30: 6572 7920 6465 6c69 6265 7261 7465 6c79  ery deliberately
+00017c40: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00017c50: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
+00017c60: 6672 6f6e 742f 6261 636b 2069 6e64 6963  front/back indic
+00017c70: 6573 2066 6f72 206d 6f73 7420 7265 6365  es for most rece
+00017c80: 6e74 206e 7074 7320 6269 6e73 206f 7574  nt npts bins out
+00017c90: 206f 6620 7468 6520 7469 6d65 7365 7269   of the timeseri
+00017ca0: 6573 0a20 2020 2020 2020 2066 726f 6e74  es.        front
+00017cb0: 203d 206d 6178 286c 656e 2873 656c 662e   = max(len(self.
+00017cc0: 706c 7567 696e 2e74 696d 6529 202d 2073  plugin.time) - s
+00017cd0: 656c 662e 6e70 7473 2c20 3029 0a20 2020  elf.npts, 0).   
+00017ce0: 2020 2020 2062 6163 6b20 3d20 4e6f 6e65       back = None
+00017cf0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
+00017d00: 6520 616e 7920 7065 7269 6f64 7320 6f66  e any periods of
+00017d10: 207a 6572 6f20 636f 6d70 7574 6520 6174   zero compute at
+00017d20: 2074 6865 2066 726f 6e74 206f 7220 6261   the front or ba
+00017d30: 636b 206f 6620 7468 6520 7469 6d65 7365  ck of the timese
+00017d40: 7269 6573 0a20 2020 2020 2020 2069 6620  ries.        if 
+00017d50: 6c65 6e28 7365 6c66 2e70 6c75 6769 6e2e  len(self.plugin.
+00017d60: 636f 6d70 7574 6529 3a0a 2020 2020 2020  compute):.      
+00017d70: 2020 2020 2020 6167 6720 3d20 7375 6d28        agg = sum(
+00017d80: 6e70 2e61 7272 6179 2876 5b66 726f 6e74  np.array(v[front
+00017d90: 3a5d 2920 666f 7220 7620 696e 2073 656c  :]) for v in sel
+00017da0: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
+00017db0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+00017dc0: 2020 2020 2020 2066 726f 6e74 3220 3d20         front2 = 
+00017dd0: 6c65 6e28 6167 6729 202d 206c 656e 286e  len(agg) - len(n
+00017de0: 702e 7472 696d 5f7a 6572 6f73 2861 6767  p.trim_zeros(agg
+00017df0: 2c20 7472 696d 3d22 6622 2929 0a20 2020  , trim="f")).   
+00017e00: 2020 2020 2020 2020 2066 726f 6e74 202b           front +
+00017e10: 3d20 6672 6f6e 7432 0a20 2020 2020 2020  = front2.       
+00017e20: 2020 2020 2062 6163 6b20 3d20 6c65 6e28       back = len(
+00017e30: 6e70 2e74 7269 6d5f 7a65 726f 7328 6167  np.trim_zeros(ag
+00017e40: 672c 2074 7269 6d3d 2262 2229 2920 2d20  g, trim="b")) - 
+00017e50: 6c65 6e28 6167 6729 206f 7220 4e6f 6e65  len(agg) or None
+00017e60: 0a0a 2020 2020 2020 2020 7072 6570 656e  ..        prepen
+00017e70: 6420 3d20 280a 2020 2020 2020 2020 2020  d = (.          
+00017e80: 2020 7365 6c66 2e70 6c75 6769 6e2e 7469    self.plugin.ti
+00017e90: 6d65 5b66 726f 6e74 202d 2031 5d0a 2020  me[front - 1].  
+00017ea0: 2020 2020 2020 2020 2020 6966 2066 726f            if fro
+00017eb0: 6e74 203e 3d20 310a 2020 2020 2020 2020  nt >= 1.        
+00017ec0: 2020 2020 656c 7365 2073 656c 662e 706c      else self.pl
+00017ed0: 7567 696e 2e74 696d 655b 6672 6f6e 745d  ugin.time[front]
+00017ee0: 202d 2073 656c 662e 706c 7567 696e 2e64   - self.plugin.d
+00017ef0: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
+00017f00: 2020 2020 7469 6d65 7374 616d 7073 203d      timestamps =
+00017f10: 206e 702e 6172 7261 7928 7365 6c66 2e70   np.array(self.p
+00017f20: 6c75 6769 6e2e 7469 6d65 5b66 726f 6e74  lugin.time[front
+00017f30: 3a62 6163 6b5d 290a 2020 2020 2020 2020  :back]).        
+00017f40: 6474 203d 206e 702e 6469 6666 2874 696d  dt = np.diff(tim
+00017f50: 6573 7461 6d70 732c 2070 7265 7065 6e64  estamps, prepend
+00017f60: 3d70 7265 7065 6e64 290a 0a20 2020 2020  =prepend)..     
+00017f70: 2020 2069 6620 7265 7374 7269 6374 5f74     if restrict_t
+00017f80: 6f5f 6578 6973 7469 6e67 3a0a 2020 2020  o_existing:.    
+00017f90: 2020 2020 2020 2020 6e65 775f 6461 7461          new_data
+00017fa0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00017fb0: 2020 2020 206b 3a20 6e70 2e61 7272 6179       k: np.array
+00017fc0: 2876 5b66 726f 6e74 3a62 6163 6b5d 2920  (v[front:back]) 
+00017fd0: 2f20 6474 0a20 2020 2020 2020 2020 2020  / dt.           
+00017fe0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+00017ff0: 2073 656c 662e 706c 7567 696e 2e63 6f6d   self.plugin.com
+00018000: 7075 7465 2e69 7465 6d73 2829 0a20 2020  pute.items().   
+00018010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00018020: 6b20 696e 2073 656c 662e 736f 7572 6365  k in self.source
+00018030: 2e64 6174 610a 2020 2020 2020 2020 2020  .data.          
+00018040: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
+00018050: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+00018060: 775f 6461 7461 203d 2076 616c 6d61 7028  w_data = valmap(
+00018070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018080: 206c 616d 6264 6120 783a 206e 702e 6172   lambda x: np.ar
+00018090: 7261 7928 785b 6672 6f6e 743a 6261 636b  ray(x[front:back
+000180a0: 5d29 202f 2064 742c 0a20 2020 2020 2020  ]) / dt,.       
+000180b0: 2020 2020 2020 2020 2073 656c 662e 706c           self.pl
+000180c0: 7567 696e 2e63 6f6d 7075 7465 2c0a 2020  ugin.compute,.  
+000180d0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000180e0: 2020 2020 206e 6577 5f64 6174 615b 2274       new_data["t
+000180f0: 696d 6522 5d20 3d20 280a 2020 2020 2020  ime"] = (.      
+00018100: 2020 2020 2020 7469 6d65 7374 616d 7073        timestamps
+00018110: 202d 2073 656c 662e 5f6f 6666 7365 740a   - self._offset.
+00018120: 2020 2020 2020 2020 2920 2a20 3130 3030          ) * 1000
+00018130: 2e30 2020 2320 626f 6b65 6820 6c69 6b65  .0  # bokeh like
+00018140: 7320 6d69 6c6c 6973 6563 6f6e 6473 0a20  s milliseconds. 
+00018150: 2020 2020 2020 206e 6577 5f64 6174 615b         new_data[
+00018160: 226e 7468 7265 6164 7322 5d20 3d20 6e70  "nthreads"] = np
+00018170: 2e61 7272 6179 2873 656c 662e 706c 7567  .array(self.plug
+00018180: 696e 2e6e 7468 7265 6164 735b 6672 6f6e  in.nthreads[fron
+00018190: 743a 6261 636b 5d29 0a0a 2020 2020 2020  t:back])..      
+000181a0: 2020 7265 7475 726e 206e 6577 5f64 6174    return new_dat
+000181b0: 610a 0a20 2020 2040 7769 7468 6f75 745f  a..    @without_
+000181c0: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
+000181d0: 696f 6e0a 2020 2020 406c 6f67 5f65 7272  ion.    @log_err
+000181e0: 6f72 730a 2020 2020 6465 6620 7570 6461  ors.    def upda
+000181f0: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
+00018200: 2020 2222 220a 2020 2020 2020 2020 4d61    """.        Ma
+00018210: 7962 6520 7570 6461 7465 2074 6865 2063  ybe update the c
+00018220: 6861 7274 2e20 5468 6973 2069 7320 736f  hart. This is so
+00018230: 6d65 7768 6174 2065 7870 656e 7369 7665  mewhat expensive
+00018240: 2074 6f20 6472 6177 2c20 736f 2077 6520   to draw, so we 
+00018250: 7570 6461 7465 0a20 2020 2020 2020 2069  update.        i
+00018260: 7420 7072 6574 7479 2064 6566 656e 7369  t pretty defensi
+00018270: 7665 6c79 2e0a 2020 2020 2020 2020 2222  vely..        ""
+00018280: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+00018290: 662e 5f73 686f 756c 645f 6164 645f 6e65  f._should_add_ne
+000182a0: 775f 7265 6e64 6572 6572 7328 293a 0a20  w_renderers():. 
+000182b0: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
+000182c0: 6174 6520 7468 6520 6368 6172 742c 2061  ate the chart, a
+000182d0: 6c6c 6f77 696e 6720 666f 7220 6e65 7720  llowing for new 
+000182e0: 7461 736b 2067 726f 7570 7320 746f 2062  task groups to b
+000182f0: 6520 6164 6465 642e 0a20 2020 2020 2020  e added..       
+00018300: 2020 2020 206e 6577 5f64 6174 6120 3d20       new_data = 
+00018310: 7365 6c66 2e5f 6765 745f 7469 6d65 7365  self._get_timese
+00018320: 7269 6573 2872 6573 7472 6963 745f 746f  ries(restrict_to
+00018330: 5f65 7869 7374 696e 673d 4661 6c73 6529  _existing=False)
+00018340: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00018350: 662e 736f 7572 6365 2e64 6174 6120 3d20  f.source.data = 
+00018360: 6e65 775f 6461 7461 0a0a 2020 2020 2020  new_data..      
+00018370: 2020 2020 2020 2320 506f 7373 6962 6c79        # Possibly
+00018380: 2075 7064 6174 6520 7468 6520 7920 7261   update the y ra
+00018390: 6e67 6520 6966 2074 6865 206e 756d 6265  nge if the numbe
+000183a0: 7220 6f66 2074 6872 6561 6473 2068 6173  r of threads has
+000183b0: 2069 6e63 7265 6173 6564 2e0a 2020 2020   increased..    
+000183c0: 2020 2020 2020 2020 6d61 785f 6e74 6872          max_nthr
+000183d0: 6561 6473 203d 206d 6178 2873 656c 662e  eads = max(self.
+000183e0: 706c 7567 696e 2e6e 7468 7265 6164 7329  plugin.nthreads)
+000183f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018400: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
+00018410: 652e 656e 6420 213d 206d 6178 5f6e 7468  e.end != max_nth
+00018420: 7265 6164 733a 0a20 2020 2020 2020 2020  reads:.         
+00018430: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00018440: 2e79 5f72 616e 6765 2e65 6e64 203d 206d  .y_range.end = m
+00018450: 6178 5f6e 7468 7265 6164 730a 0a20 2020  ax_nthreads..   
+00018460: 2020 2020 2020 2020 2073 7461 636b 6572           stacker
+00018470: 7320 3d20 6c69 7374 2873 656c 662e 706c  s = list(self.pl
+00018480: 7567 696e 2e63 6f6d 7075 7465 2e6b 6579  ugin.compute.key
+00018490: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+000184a0: 2063 6f6c 6f72 7320 3d20 5b63 6f6c 6f72   colors = [color
+000184b0: 5f6f 6628 6b65 795f 7370 6c69 7428 6b29  _of(key_split(k)
+000184c0: 2920 666f 7220 6b20 696e 2073 7461 636b  ) for k in stack
+000184d0: 6572 735d 0a0a 2020 2020 2020 2020 2020  ers]..          
+000184e0: 2020 666f 7220 692c 2028 6772 6f75 702c    for i, (group,
+000184f0: 2063 6f6c 6f72 2920 696e 2065 6e75 6d65   color) in enume
+00018500: 7261 7465 287a 6970 2873 7461 636b 6572  rate(zip(stacker
+00018510: 732c 2063 6f6c 6f72 7329 293a 0a20 2020  s, colors)):.   
+00018520: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00018530: 6620 7765 2068 6176 6520 616c 7265 6164  f we have alread
+00018540: 7920 6472 6177 6e20 7468 6520 6772 6f75  y drawn the grou
+00018550: 702c 2062 7574 2069 7420 6973 2061 6c6c  p, but it is all
+00018560: 207a 6572 6f2c 0a20 2020 2020 2020 2020   zero,.         
+00018570: 2020 2020 2020 2023 2073 6574 2069 7420         # set it 
+00018580: 746f 2062 6520 696e 7669 7369 626c 652e  to be invisible.
+00018590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000185a0: 2069 6620 6772 6f75 7020 696e 2073 656c   if group in sel
+000185b0: 662e 5f72 656e 6465 7265 7273 3a0a 2020  f._renderers:.  
+000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185d0: 2020 6966 206e 6f74 206e 702e 636f 756e    if not np.coun
+000185e0: 745f 6e6f 6e7a 6572 6f28 6e65 775f 6461  t_nonzero(new_da
+000185f0: 7461 5b67 726f 7570 5d29 203e 2030 3a0a  ta[group]) > 0:.
+00018600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018610: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+00018620: 6e64 6572 6572 735b 6772 6f75 705d 2e76  nderers[group].v
+00018630: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+00018640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018650: 2020 2020 2020 2073 656c 662e 5f6c 696e         self._lin
+00018660: 655f 7265 6e64 6572 6572 735b 6772 6f75  e_renderers[grou
+00018670: 705d 2e76 6973 6962 6c65 203d 2046 616c  p].visible = Fal
+00018680: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00018690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186b0: 2020 2020 2073 656c 662e 5f72 656e 6465       self._rende
+000186c0: 7265 7273 5b67 726f 7570 5d2e 7669 7369  rers[group].visi
+000186d0: 626c 6520 3d20 5472 7565 0a20 2020 2020  ble = True.     
+000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186f0: 2020 2073 656c 662e 5f6c 696e 655f 7265     self._line_re
+00018700: 6e64 6572 6572 735b 6772 6f75 705d 2e76  nderers[group].v
+00018710: 6973 6962 6c65 203d 2054 7275 650a 0a20  isible = True.. 
+00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018730: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+00018740: 2020 2020 2020 2020 2020 2020 2023 2044               # D
+00018750: 7261 7720 7468 6520 6e65 7720 6172 6561  raw the new area
+00018760: 2061 6e64 206c 696e 6520 676c 7970 6873   and line glyphs
+00018770: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018780: 2020 7265 6e64 6572 6572 203d 2073 656c    renderer = sel
+00018790: 662e 726f 6f74 2e76 6172 6561 280a 2020  f.root.varea(.  
+000187a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187b0: 2020 783d 2274 696d 6522 2c0a 2020 2020    x="time",.    
+000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187d0: 7931 3d73 7461 636b 282a 7374 6163 6b65  y1=stack(*stacke
+000187e0: 7273 5b3a 695d 292c 0a20 2020 2020 2020  rs[:i]),.       
+000187f0: 2020 2020 2020 2020 2020 2020 2079 323d               y2=
+00018800: 7374 6163 6b28 2a73 7461 636b 6572 735b  stack(*stackers[
+00018810: 3a20 6920 2b20 315d 292c 0a20 2020 2020  : i + 1]),.     
+00018820: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018830: 6f6c 6f72 3d63 6f6c 6f72 2c0a 2020 2020  olor=color,.    
+00018840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018850: 616c 7068 613d 302e 352c 0a20 2020 2020  alpha=0.5,.     
+00018860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00018870: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+00018880: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00018890: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000188a0: 2020 2020 2073 656c 662e 5f72 656e 6465       self._rende
+000188b0: 7265 7273 5b67 726f 7570 5d20 3d20 7265  rers[group] = re
+000188c0: 6e64 6572 6572 0a0a 2020 2020 2020 2020  nderer..        
+000188d0: 2020 2020 2020 2020 6c69 6e65 5f72 656e          line_ren
+000188e0: 6465 7265 7220 3d20 7365 6c66 2e72 6f6f  derer = self.roo
+000188f0: 742e 6c69 6e65 280a 2020 2020 2020 2020  t.line(.        
+00018900: 2020 2020 2020 2020 2020 2020 783d 2274              x="t
+00018910: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
+00018920: 2020 2020 2020 2020 2020 793d 7374 6163            y=stac
+00018930: 6b28 2a73 7461 636b 6572 735b 3a20 6920  k(*stackers[: i 
+00018940: 2b20 315d 292c 0a20 2020 2020 2020 2020  + 1]),.         
+00018950: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00018960: 3d63 6f6c 6f72 2c0a 2020 2020 2020 2020  =color,.        
+00018970: 2020 2020 2020 2020 2020 2020 616c 7068              alph
+00018980: 613d 312e 302c 0a20 2020 2020 2020 2020  a=1.0,.         
+00018990: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+000189a0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+000189b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000189c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000189d0: 2073 656c 662e 5f6c 696e 655f 7265 6e64   self._line_rend
+000189e0: 6572 6572 735b 6772 6f75 705d 203d 206c  erers[group] = l
+000189f0: 696e 655f 7265 6e64 6572 6572 0a0a 2020  ine_renderer..  
+00018a00: 2020 2020 2020 2020 2020 2320 446f 6e27            # Don'
+00018a10: 7420 6164 6420 686f 7665 7220 756e 7469  t add hover unti
+00018a20: 6c20 7468 6572 6520 6973 2073 6f6d 6574  l there is somet
+00018a30: 6869 6e67 2074 6f20 7368 6f77 2c20 6173  hing to show, as
+00018a40: 2062 6f6b 6568 6a73 2073 6565 6d73 2074   bokehjs seems t
+00018a50: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+00018a60: 6861 7665 2074 726f 7562 6c65 2077 6974  have trouble wit
+00018a70: 6820 6375 7374 6f6d 2068 6f76 6572 7320  h custom hovers 
+00018a80: 7768 656e 2074 6865 7265 2061 7265 206e  when there are n
+00018a90: 6f20 7265 6e64 6572 6572 732e 0a20 2020  o renderers..   
+00018aa0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00018ab0: 2e70 6c75 6769 6e2e 636f 6d70 7574 6520  .plugin.compute 
+00018ac0: 616e 6420 7365 6c66 2e5f 686f 7665 7220  and self._hover 
+00018ad0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00018ae0: 2020 2020 2020 2020 2023 2041 6464 2061           # Add a
+00018af0: 2068 6f76 6572 2074 6861 7420 7769 6c6c   hover that will
+00018b00: 2073 686f 7720 6f63 6375 7061 6e63 7920   show occupancy 
+00018b10: 666f 7220 616c 6c20 6375 7272 656e 746c  for all currentl
+00018b20: 7920 6163 7469 7665 0a20 2020 2020 2020  y active.       
+00018b30: 2020 2020 2020 2020 2023 2074 6173 6b20           # task 
+00018b40: 6772 6f75 7073 2e20 5468 6973 2069 7320  groups. This is 
+00018b50: 6120 6c69 7474 6c65 2074 7269 636b 792c  a little tricky,
+00018b60: 2062 6f6b 6568 2064 6f65 736e 2774 2028   bokeh doesn't (
+00018b70: 7965 7429 2073 7570 706f 7274 0a20 2020  yet) support.   
+00018b80: 2020 2020 2020 2020 2020 2020 2023 2068               # h
+00018b90: 6974 2074 6573 7473 2066 6f72 2073 7461  it tests for sta
+00018ba0: 636b 6564 2061 7265 6120 6368 6172 7473  cked area charts
+00018bb0: 3a20 6874 7470 733a 2f2f 6769 7468 7562  : https://github
+00018bc0: 2e63 6f6d 2f62 6f6b 6568 2f62 6f6b 6568  .com/bokeh/bokeh
+00018bd0: 2f69 7373 7565 732f 3931 3832 0a20 2020  /issues/9182.   
+00018be0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00018bf0: 6e73 7465 6164 2c20 7368 6f77 2061 2073  nstead, show a s
+00018c00: 696e 676c 6520 766c 696e 6520 686f 7665  ingle vline hove
+00018c10: 7220 7768 6963 6820 6c69 7374 7320 7468  r which lists th
+00018c20: 6520 6375 7272 656e 746c 7920 6163 7469  e currently acti
+00018c30: 7665 2074 6173 6b0a 2020 2020 2020 2020  ve task.        
+00018c40: 2020 2020 2020 2020 2320 6772 6f75 7073          # groups
+00018c50: 2e20 4120 6375 7374 6f6d 2066 6f72 6d61  . A custom forma
+00018c60: 7474 6572 2069 6e20 4a53 2d6c 616e 6420  tter in JS-land 
+00018c70: 7075 6c6c 7320 7468 6520 7265 6c65 7661  pulls the releva
+00018c80: 6e74 2064 6174 6120 696e 6465 7820 616e  nt data index an
+00018c90: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00018ca0: 2020 2320 6173 7365 6d62 6c65 7320 7468    # assembles th
+00018cb0: 6520 746f 6f6c 7469 702e 0a20 2020 2020  e tooltip..     
+00018cc0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00018cd0: 7474 6572 203d 2043 7573 746f 6d4a 5348  tter = CustomJSH
+00018ce0: 6f76 6572 2863 6f64 653d 2272 6574 7572  over(code="retur
+00018cf0: 6e20 2727 3b22 290a 2020 2020 2020 2020  n '';").        
+00018d00: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
+00018d10: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
+00018d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018d30: 2020 2020 2074 6f6f 6c74 6970 733d 2222       tooltips=""
+00018d40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00018d50: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d70: 2020 2020 2020 2020 2020 3c64 6976 2073            <div s
+00018d80: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+00018d90: 2031 2e32 656d 3b20 666f 6e74 2d77 6569   1.2em; font-wei
+00018da0: 6768 743a 2062 6f6c 6422 3e0a 2020 2020  ght: bold">.    
+00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018dc0: 2020 2020 2020 2020 3c62 3e57 6f72 6b65          <b>Worke
+00018dd0: 7220 7468 7265 6164 206f 6363 7570 616e  r thread occupan
+00018de0: 6379 3c2f 623e 0a20 2020 2020 2020 2020  cy</b>.         
+00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e00: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+00018e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e20: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
 00018e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e40: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e60: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
-00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e80: 2020 2020 2020 2222 222c 0a20 2020 2020        """,.     
-00018e90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00018ea0: 6f64 653d 2276 6c69 6e65 222c 0a20 2020  ode="vline",.   
+00018e40: 2020 2020 2469 6e64 6578 7b63 7573 746f      $index{custo
+00018e50: 6d7d 0a20 2020 2020 2020 2020 2020 2020  m}.             
+00018e60: 2020 2020 2020 2020 2020 2020 203c 2f64               </d
+00018e70: 6976 3e0a 2020 2020 2020 2020 2020 2020  iv>.            
+00018e80: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+00018e90: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+00018ea0: 2020 2020 2020 2020 2020 2022 2222 2c0a             """,.
 00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ec0: 206c 696e 655f 706f 6c69 6379 3d22 6e65   line_policy="ne
-00018ed0: 6172 6573 7422 2c0a 2020 2020 2020 2020  arest",.        
-00018ee0: 2020 2020 2020 2020 2020 2020 6174 7461              atta
-00018ef0: 6368 6d65 6e74 3d22 686f 7269 7a6f 6e74  chment="horizont
-00018f00: 616c 222c 0a20 2020 2020 2020 2020 2020  al",.           
-00018f10: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
-00018f20: 6572 733d 7b22 2469 6e64 6578 223a 2066  ers={"$index": f
-00018f30: 6f72 6d61 7474 6572 7d2c 0a20 2020 2020  ormatter},.     
-00018f40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00018f50: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00018f60: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
-00018f70: 2873 656c 662e 5f68 6f76 6572 290a 0a20  (self._hover).. 
-00018f80: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00018f90: 6c66 2e5f 686f 7665 723a 0a20 2020 2020  lf._hover:.     
-00018fa0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-00018fb0: 6174 6520 6120 6375 7374 6f6d 2074 6f6f  ate a custom too
-00018fc0: 6c74 6970 2074 6861 743a 0a20 2020 2020  ltip that:.     
-00018fd0: 2020 2020 2020 2020 2020 2023 2020 2031             #   1
-00018fe0: 2e20 496e 636c 7564 6573 206e 7468 7265  . Includes nthre
-00018ff0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00019000: 2020 2020 2320 2020 322e 2046 696c 7465      #   2. Filte
-00019010: 7273 206f 7574 2069 6e61 6374 6976 6520  rs out inactive 
-00019020: 7461 736b 2067 726f 7570 730a 2020 2020  task groups.    
-00019030: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00019040: 2020 2028 6f6e 6573 2077 6974 686f 7574     (ones without
-00019050: 2061 6e79 2063 6f6d 7075 7465 2064 7572   any compute dur
-00019060: 696e 6720 7468 6520 7265 6c65 7661 6e74  ing the relevant
-00019070: 2064 7429 0a20 2020 2020 2020 2020 2020   dt).           
-00019080: 2020 2020 2023 2020 2033 2e20 436f 6c6f       #   3. Colo
-00019090: 7273 2074 6865 206c 6162 656c 7320 6170  rs the labels ap
-000190a0: 7072 6f70 7269 6174 656c 792e 0a20 2020  propriately..   
-000190b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000190c0: 6d61 7474 6572 203d 2043 7573 746f 6d4a  matter = CustomJ
-000190d0: 5348 6f76 6572 280a 2020 2020 2020 2020  SHover(.        
-000190e0: 2020 2020 2020 2020 2020 2020 636f 6465              code
-000190f0: 3d22 2222 0a20 2020 2020 2020 2020 2020  =""".           
-00019100: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00019110: 7374 2063 6f6c 6f72 6d61 7020 3d20 2573  st colormap = %s
-00019120: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00019130: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00019140: 6469 7673 203d 205b 5d3b 0a20 2020 2020  divs = [];.     
-00019150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019160: 2020 2066 6f72 2028 6c65 7420 6b20 6f66     for (let k of
-00019170: 204f 626a 6563 742e 6b65 7973 2873 6f75   Object.keys(sou
-00019180: 7263 652e 6461 7461 2929 207b 0a20 2020  rce.data)) {.   
-00019190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191a0: 2020 2020 2020 2063 6f6e 7374 2076 616c         const val
-000191b0: 203d 2073 6f75 7263 652e 6461 7461 5b6b   = source.data[k
-000191c0: 5d5b 7661 6c75 655d 3b0a 2020 2020 2020  ][value];.      
-000191d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191e0: 2020 2020 636f 6e73 7420 636f 6c6f 7220      const color 
-000191f0: 3d20 636f 6c6f 726d 6170 5b6b 5d3b 0a20  = colormap[k];. 
-00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019210: 2020 2020 2020 2020 2069 6620 286b 203d           if (k =
-00019220: 3d3d 2022 7469 6d65 2220 7c7c 206b 203d  == "time" || k =
-00019230: 3d3d 2022 6e74 6872 6561 6473 2220 7c7c  == "nthreads" ||
-00019240: 2076 616c 203c 2031 2e65 2d33 2920 7b0a   val < 1.e-3) {.
-00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019260: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00019270: 696e 7565 3b0a 2020 2020 2020 2020 2020  inue;.          
+00018ec0: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
+00018ed0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018ee0: 2020 2020 2020 6c69 6e65 5f70 6f6c 6963        line_polic
+00018ef0: 793d 226e 6561 7265 7374 222c 0a20 2020  y="nearest",.   
+00018f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f10: 2061 7474 6163 686d 656e 743d 2268 6f72   attachment="hor
+00018f20: 697a 6f6e 7461 6c22 2c0a 2020 2020 2020  izontal",.      
+00018f30: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00018f40: 726d 6174 7465 7273 3d7b 2224 696e 6465  rmatters={"$inde
+00018f50: 7822 3a20 666f 726d 6174 7465 727d 2c0a  x": formatter},.
+00018f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018f80: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00018f90: 746f 6f6c 7328 7365 6c66 2e5f 686f 7665  tools(self._hove
+00018fa0: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+00018fb0: 6966 2073 656c 662e 5f68 6f76 6572 3a0a  if self._hover:.
+00018fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018fd0: 2320 4372 6561 7465 2061 2063 7573 746f  # Create a custo
+00018fe0: 6d20 746f 6f6c 7469 7020 7468 6174 3a0a  m tooltip that:.
+00018ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019000: 2320 2020 312e 2049 6e63 6c75 6465 7320  #   1. Includes 
+00019010: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+00019020: 2020 2020 2020 2020 2023 2020 2032 2e20           #   2. 
+00019030: 4669 6c74 6572 7320 6f75 7420 696e 6163  Filters out inac
+00019040: 7469 7665 2074 6173 6b20 6772 6f75 7073  tive task groups
+00019050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019060: 2023 2020 2020 2020 286f 6e65 7320 7769   #      (ones wi
+00019070: 7468 6f75 7420 616e 7920 636f 6d70 7574  thout any comput
+00019080: 6520 6475 7269 6e67 2074 6865 2072 656c  e during the rel
+00019090: 6576 616e 7420 6474 290a 2020 2020 2020  evant dt).      
+000190a0: 2020 2020 2020 2020 2020 2320 2020 332e            #   3.
+000190b0: 2043 6f6c 6f72 7320 7468 6520 6c61 6265   Colors the labe
+000190c0: 6c73 2061 7070 726f 7072 6961 7465 6c79  ls appropriately
+000190d0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000190e0: 2020 666f 726d 6174 7465 7220 3d20 4375    formatter = Cu
+000190f0: 7374 6f6d 4a53 486f 7665 7228 0a20 2020  stomJSHover(.   
+00019100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019110: 2063 6f64 653d 2222 220a 2020 2020 2020   code=""".      
+00019120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019130: 2020 636f 6e73 7420 636f 6c6f 726d 6170    const colormap
+00019140: 203d 2025 733b 0a20 2020 2020 2020 2020   = %s;.         
+00019150: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019160: 6f6e 7374 2064 6976 7320 3d20 5b5d 3b0a  onst divs = [];.
+00019170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019180: 2020 2020 2020 2020 666f 7220 286c 6574          for (let
+00019190: 206b 206f 6620 4f62 6a65 6374 2e6b 6579   k of Object.key
+000191a0: 7328 736f 7572 6365 2e64 6174 6129 2920  s(source.data)) 
+000191b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000191c0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000191d0: 7420 7661 6c20 3d20 736f 7572 6365 2e64  t val = source.d
+000191e0: 6174 615b 6b5d 5b76 616c 7565 5d3b 0a20  ata[k][value];. 
+000191f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019200: 2020 2020 2020 2020 2063 6f6e 7374 2063           const c
+00019210: 6f6c 6f72 203d 2063 6f6c 6f72 6d61 705b  olor = colormap[
+00019220: 6b5d 3b0a 2020 2020 2020 2020 2020 2020  k];.            
+00019230: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019240: 2028 6b20 3d3d 3d20 2274 696d 6522 207c   (k === "time" |
+00019250: 7c20 6b20 3d3d 3d20 226e 7468 7265 6164  | k === "nthread
+00019260: 7322 207c 7c20 7661 6c20 3c20 312e 652d  s" || val < 1.e-
+00019270: 3329 207b 0a20 2020 2020 2020 2020 2020  3) {.           
 00019280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019290: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-000192a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000192b0: 7420 6c61 6265 6c20 3d20 6b2e 6c65 6e67  t label = k.leng
-000192c0: 7468 203e 3d20 3230 203f 206b 2e73 6c69  th >= 20 ? k.sli
-000192d0: 6365 2830 2c20 3230 2920 2b20 27e2 80a6  ce(0, 20) + '...
-000192e0: 2720 3a20 6b3b 0a0a 2020 2020 2020 2020  ' : k;..        
-000192f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019300: 2020 2f2f 2055 6e73 6869 6674 2073 6f20    // Unshift so 
-00019310: 7468 6174 2074 6865 206f 7264 6572 696e  that the orderin
-00019320: 6720 6f66 2074 6865 206c 6162 656c 7320  g of the labels 
-00019330: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
-00019340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019350: 2020 2020 2020 2020 202f 2f20 7468 6520           // the 
-00019360: 6f72 6465 7269 6e67 206f 6620 7468 6520  ordering of the 
-00019370: 7374 6163 6b65 7273 2e0a 2020 2020 2020  stackers..      
-00019380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019390: 2020 2020 6469 7673 2e75 6e73 6869 6674      divs.unshift
-000193a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000193b0: 2020 2020 2020 2020 2020 2020 2020 273c                '<
-000193c0: 6469 763e 270a 2020 2020 2020 2020 2020  div>'.          
+00019290: 2063 6f6e 7469 6e75 653b 0a20 2020 2020   continue;.     
+000192a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192b0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192d0: 2063 6f6e 7374 206c 6162 656c 203d 206b   const label = k
+000192e0: 2e6c 656e 6774 6820 3e3d 2032 3020 3f20  .length >= 20 ? 
+000192f0: 6b2e 736c 6963 6528 302c 2032 3029 202b  k.slice(0, 20) +
+00019300: 2027 e280 a627 203a 206b 3b0a 0a20 2020   '...' : k;..   
+00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019320: 2020 2020 2020 202f 2f20 556e 7368 6966         // Unshif
+00019330: 7420 736f 2074 6861 7420 7468 6520 6f72  t so that the or
+00019340: 6465 7269 6e67 206f 6620 7468 6520 6c61  dering of the la
+00019350: 6265 6c73 2069 7320 7468 6520 7361 6d65  bels is the same
+00019360: 2061 730a 2020 2020 2020 2020 2020 2020   as.            
+00019370: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00019380: 2074 6865 206f 7264 6572 696e 6720 6f66   the ordering of
+00019390: 2074 6865 2073 7461 636b 6572 732e 0a20   the stackers.. 
+000193a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193b0: 2020 2020 2020 2020 2064 6976 732e 756e           divs.un
+000193c0: 7368 6966 7428 0a20 2020 2020 2020 2020  shift(.         
 000193d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193e0: 2020 2020 2b20 273c 7370 616e 2073 7479      + '<span sty
-000193f0: 6c65 3d22 666f 6e74 2d77 6569 6768 743a  le="font-weight:
-00019400: 2062 6f6c 643b 2063 6f6c 6f72 3a27 202b   bold; color:' +
-00019410: 2063 6f6c 6f72 202b 2027 3b22 3e27 0a20   color + ';">'. 
-00019420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019430: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00019440: 206c 6162 656c 0a20 2020 2020 2020 2020   label.         
+000193e0: 2020 2027 3c64 6976 3e27 0a20 2020 2020     '<div>'.     
+000193f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019400: 2020 2020 2020 2020 202b 2027 3c73 7061           + '<spa
+00019410: 6e20 7374 796c 653d 2266 6f6e 742d 7765  n style="font-we
+00019420: 6967 6874 3a20 626f 6c64 3b20 636f 6c6f  ight: bold; colo
+00019430: 723a 2720 2b20 636f 6c6f 7220 2b20 273b  r:' + color + ';
+00019440: 223e 270a 2020 2020 2020 2020 2020 2020  ">'.            
 00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019460: 2020 2020 202b 2027 3c2f 7370 616e 3e27       + '</span>'
-00019470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019480: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00019490: 2027 3a20 270a 2020 2020 2020 2020 2020   ': '.          
+00019460: 2020 2020 2b20 6c61 6265 6c0a 2020 2020      + label.    
+00019470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019480: 2020 2020 2020 2020 2020 2b20 273c 2f73            + '</s
+00019490: 7061 6e3e 270a 2020 2020 2020 2020 2020  pan>'.          
 000194a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194b0: 2020 2020 2b20 2076 616c 2e74 6f46 6978      +  val.toFix
-000194c0: 6564 2831 290a 2020 2020 2020 2020 2020  ed(1).          
-000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194e0: 2020 2020 2b20 273c 2f64 6976 3e27 0a20      + '</div>'. 
+000194b0: 2020 2020 2b20 273a 2027 0a20 2020 2020      + ': '.     
+000194c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194d0: 2020 2020 2020 2020 202b 2020 7661 6c2e           +  val.
+000194e0: 746f 4669 7865 6428 3129 0a20 2020 2020  toFixed(1).     
 000194f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019500: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019520: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00019530: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00019540: 7673 2e75 6e73 6869 6674 280a 2020 2020  vs.unshift(.    
+00019500: 2020 2020 2020 2020 202b 2027 3c2f 6469           + '</di
+00019510: 763e 270a 2020 2020 2020 2020 2020 2020  v>'.            
+00019520: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00019530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019540: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
 00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019560: 2020 2020 2020 273c 6469 763e 270a 2020        '<div>'.  
-00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019580: 2020 2020 2020 2020 2020 2b20 273c 7370            + '<sp
-00019590: 616e 2073 7479 6c65 3d22 666f 6e74 2d77  an style="font-w
-000195a0: 6569 6768 743a 2062 6f6c 643b 2063 6f6c  eight: bold; col
-000195b0: 6f72 3a20 6461 726b 6772 6579 3b22 3e6e  or: darkgrey;">n
-000195c0: 7468 7265 6164 733a 203c 2f73 7061 6e3e  threads: </span>
-000195d0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000195e0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-000195f0: 736f 7572 6365 2e64 6174 612e 6e74 6872  source.data.nthr
-00019600: 6561 6473 5b76 616c 7565 5d0a 2020 2020  eads[value].    
-00019610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019620: 2020 2020 2020 2020 2b20 273c 2f64 6976          + '</div
-00019630: 3e27 0a20 2020 2020 2020 2020 2020 2020  >'.             
-00019640: 2020 2020 2020 2020 2020 2029 3b0a 2020             );.  
-00019650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019660: 2020 2020 2020 7265 7475 726e 2064 6976        return div
-00019670: 732e 6a6f 696e 2827 5c5c 6e27 290a 2020  s.join('\\n').  
-00019680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019690: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000196a0: 2020 2020 2020 2020 2020 2020 2020 2520                % 
-000196b0: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-000196c0: 2020 2020 2020 2020 2020 2020 2020 7a69                zi
-000196d0: 7028 7374 6163 6b65 7273 2c20 636f 6c6f  p(stackers, colo
-000196e0: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
-000196f0: 2020 2020 2020 2020 292c 2020 2320 736e          ),  # sn
-00019700: 6561 6b20 7468 6520 636f 6c6f 7220 6d61  eak the color ma
-00019710: 7070 696e 6720 696e 746f 2074 6865 2063  pping into the c
-00019720: 616c 6c62 6163 6b0a 2020 2020 2020 2020  allback.        
-00019730: 2020 2020 2020 2020 2020 2020 6172 6773              args
-00019740: 3d7b 2273 6f75 7263 6522 3a20 7365 6c66  ={"source": self
-00019750: 2e73 6f75 7263 657d 2c0a 2020 2020 2020  .source},.      
-00019760: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00019770: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-00019780: 6420 7468 6520 486f 7665 7254 6f6f 6c20  d the HoverTool 
-00019790: 746f 2074 6865 2074 6f70 206c 696e 6520  to the top line 
-000197a0: 7265 6e64 6572 6572 2e0a 2020 2020 2020  renderer..      
-000197b0: 2020 2020 2020 2020 2020 746f 705f 6c69            top_li
-000197c0: 6e65 203d 204e 6f6e 650a 2020 2020 2020  ne = None.      
-000197d0: 2020 2020 2020 2020 2020 666f 7220 6c69            for li
-000197e0: 6e65 2069 6e20 7265 7665 7273 6564 2873  ne in reversed(s
-000197f0: 656c 662e 5f6c 696e 655f 7265 6e64 6572  elf._line_render
-00019800: 6572 732e 7661 6c75 6573 2829 293a 0a20  ers.values()):. 
-00019810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019820: 2020 2069 6620 6c69 6e65 2e76 6973 6962     if line.visib
-00019830: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00019840: 2020 2020 2020 2020 2020 2020 746f 705f              top_
-00019850: 6c69 6e65 203d 206c 696e 650a 2020 2020  line = line.    
+00019560: 2020 2064 6976 732e 756e 7368 6966 7428     divs.unshift(
+00019570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019580: 2020 2020 2020 2020 2020 2027 3c64 6976             '<div
+00019590: 3e27 0a20 2020 2020 2020 2020 2020 2020  >'.             
+000195a0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+000195b0: 2027 3c73 7061 6e20 7374 796c 653d 2266   '<span style="f
+000195c0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
+000195d0: 3b20 636f 6c6f 723a 2064 6172 6b67 7265  ; color: darkgre
+000195e0: 793b 223e 6e74 6872 6561 6473 3a20 3c2f  y;">nthreads: </
+000195f0: 7370 616e 3e27 0a20 2020 2020 2020 2020  span>'.         
+00019600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019610: 2020 202b 2073 6f75 7263 652e 6461 7461     + source.data
+00019620: 2e6e 7468 7265 6164 735b 7661 6c75 655d  .nthreads[value]
+00019630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019640: 2020 2020 2020 2020 2020 2020 202b 2027               + '
+00019650: 3c2f 6469 763e 270a 2020 2020 2020 2020  </div>'.        
+00019660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019670: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00019680: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00019690: 6e20 6469 7673 2e6a 6f69 6e28 275c 5c6e  n divs.join('\\n
+000196a0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000196b0: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
+000196c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196d0: 2020 2025 2064 6963 7428 0a20 2020 2020     % dict(.     
+000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196f0: 2020 207a 6970 2873 7461 636b 6572 732c     zip(stackers,
+00019700: 2063 6f6c 6f72 7329 0a20 2020 2020 2020   colors).       
+00019710: 2020 2020 2020 2020 2020 2020 2029 2c20               ), 
+00019720: 2023 2073 6e65 616b 2074 6865 2063 6f6c   # sneak the col
+00019730: 6f72 206d 6170 7069 6e67 2069 6e74 6f20  or mapping into 
+00019740: 7468 6520 6361 6c6c 6261 636b 0a20 2020  the callback.   
+00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019760: 2061 7267 733d 7b22 736f 7572 6365 223a   args={"source":
+00019770: 2073 656c 662e 736f 7572 6365 7d2c 0a20   self.source},. 
+00019780: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00019790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000197a0: 2023 2041 6464 2074 6865 2048 6f76 6572   # Add the Hover
+000197b0: 546f 6f6c 2074 6f20 7468 6520 746f 7020  Tool to the top 
+000197c0: 6c69 6e65 2072 656e 6465 7265 722e 0a20  line renderer.. 
+000197d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000197e0: 6f70 5f6c 696e 6520 3d20 4e6f 6e65 0a20  op_line = None. 
+000197f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019800: 6f72 206c 696e 6520 696e 2072 6576 6572  or line in rever
+00019810: 7365 6428 7365 6c66 2e5f 6c69 6e65 5f72  sed(self._line_r
+00019820: 656e 6465 7265 7273 2e76 616c 7565 7328  enderers.values(
+00019830: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00019840: 2020 2020 2020 2020 6966 206c 696e 652e          if line.
+00019850: 7669 7369 626c 653a 0a20 2020 2020 2020  visible:.       
 00019860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019870: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00019880: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00019890: 686f 7665 722e 7265 6e64 6572 6572 7320  hover.renderers 
-000198a0: 3d20 5b74 6f70 5f6c 696e 655d 0a20 2020  = [top_line].   
-000198b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000198c0: 662e 5f68 6f76 6572 2e66 6f72 6d61 7474  f._hover.formatt
-000198d0: 6572 7320 3d20 7b22 2469 6e64 6578 223a  ers = {"$index":
-000198e0: 2066 6f72 6d61 7474 6572 7d0a 0a20 2020   formatter}..   
-000198f0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-00019900: 6173 745f 6472 6177 6e20 3d20 7469 6d65  ast_drawn = time
-00019910: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-00019920: 656c 662e 5f6c 6173 745f 7472 616e 7369  elf._last_transi
-00019930: 7469 6f6e 5f63 6f75 6e74 203d 2073 656c  tion_count = sel
-00019940: 662e 7363 6865 6475 6c65 722e 7472 616e  f.scheduler.tran
-00019950: 7369 7469 6f6e 5f63 6f75 6e74 6572 0a20  sition_counter. 
-00019960: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00019970: 2e5f 7368 6f75 6c64 5f75 7064 6174 6528  ._should_update(
-00019980: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-00019990: 2050 6f73 7369 626c 7920 7570 6461 7465   Possibly update
-000199a0: 2074 6865 2079 2072 616e 6765 2069 6620   the y range if 
-000199b0: 6e65 7720 7468 7265 6164 7320 6861 7665  new threads have
-000199c0: 2062 6565 6e20 6164 6465 640a 2020 2020   been added.    
-000199d0: 2020 2020 2020 2020 6d61 785f 6e74 6872          max_nthr
-000199e0: 6561 6473 203d 206d 6178 2873 656c 662e  eads = max(self.
-000199f0: 706c 7567 696e 2e6e 7468 7265 6164 7329  plugin.nthreads)
-00019a00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00019a10: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
-00019a20: 652e 656e 6420 213d 206d 6178 5f6e 7468  e.end != max_nth
-00019a30: 7265 6164 733a 0a20 2020 2020 2020 2020  reads:.         
-00019a40: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00019a50: 2e79 5f72 616e 6765 2e65 6e64 203d 206d  .y_range.end = m
-00019a60: 6178 5f6e 7468 7265 6164 730a 2020 2020  ax_nthreads.    
-00019a70: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
-00019a80: 2074 6865 2064 6174 612c 206f 6e6c 7920   the data, only 
-00019a90: 696e 636c 7564 696e 6720 6578 6973 7469  including existi
-00019aa0: 6e67 2063 6f6c 756d 6e73 2c20 7261 7468  ng columns, rath
-00019ab0: 6572 2074 6861 6e20 7265 6472 6177 696e  er than redrawin
-00019ac0: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
-00019ad0: 7468 6520 7768 6f6c 6520 6368 6172 742e  the whole chart.
-00019ae0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00019af0: 662e 736f 7572 6365 2e64 6174 6120 3d20  f.source.data = 
-00019b00: 7365 6c66 2e5f 6765 745f 7469 6d65 7365  self._get_timese
-00019b10: 7269 6573 2872 6573 7472 6963 745f 746f  ries(restrict_to
-00019b20: 5f65 7869 7374 696e 673d 5472 7565 290a  _existing=True).
-00019b30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019b40: 2e5f 6c61 7374 5f74 7261 6e73 6974 696f  ._last_transitio
-00019b50: 6e5f 636f 756e 7420 3d20 7365 6c66 2e73  n_count = self.s
-00019b60: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00019b70: 696f 6e5f 636f 756e 7465 720a 0a0a 636c  ion_counter...cl
-00019b80: 6173 7320 5461 736b 5072 6f67 7265 7373  ass TaskProgress
-00019b90: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
-00019ba0: 656e 7429 3a0a 2020 2020 2222 2250 726f  ent):.    """Pro
-00019bb0: 6772 6573 7320 6261 7273 2070 6572 2074  gress bars per t
-00019bc0: 6173 6b20 7479 7065 2222 220a 0a20 2020  ask type"""..   
-00019bd0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00019be0: 6c66 2c20 7363 6865 6475 6c65 722c 202a  lf, scheduler, *
-00019bf0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00019c00: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-00019c10: 203d 2073 6368 6564 756c 6572 0a0a 2020   = scheduler..  
-00019c20: 2020 2020 2020 6461 7461 203d 2070 726f        data = pro
-00019c30: 6772 6573 735f 7175 6164 7328 0a20 2020  gress_quads(.   
-00019c40: 2020 2020 2020 2020 2064 6963 7428 616c           dict(al
-00019c50: 6c3d 7b7d 2c20 6d65 6d6f 7279 3d7b 7d2c  l={}, memory={},
-00019c60: 2065 7272 6564 3d7b 7d2c 2072 656c 6561   erred={}, relea
-00019c70: 7365 643d 7b7d 2c20 7072 6f63 6573 7369  sed={}, processi
-00019c80: 6e67 3d7b 7d2c 2071 7565 7565 643d 7b7d  ng={}, queued={}
-00019c90: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00019ca0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-00019cb0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00019cc0: 6365 2864 6174 613d 6461 7461 290a 0a20  ce(data=data).. 
-00019cd0: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
-00019ce0: 2044 6174 6152 616e 6765 3164 2872 616e   DataRange1d(ran
-00019cf0: 6765 5f70 6164 6469 6e67 3d30 290a 2020  ge_padding=0).  
-00019d00: 2020 2020 2020 795f 7261 6e67 6520 3d20        y_range = 
-00019d10: 5261 6e67 6531 6428 2d38 2c20 3029 0a0a  Range1d(-8, 0)..
-00019d20: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00019d30: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
-00019d40: 2020 2020 2020 2020 7469 746c 653d 2250          title="P
-00019d50: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
-00019d60: 2020 2020 2020 6e61 6d65 3d22 7461 736b        name="task
-00019d70: 5f70 726f 6772 6573 7322 2c0a 2020 2020  _progress",.    
-00019d80: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-00019d90: 785f 7261 6e67 652c 0a20 2020 2020 2020  x_range,.       
-00019da0: 2020 2020 2079 5f72 616e 6765 3d79 5f72       y_range=y_r
-00019db0: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
-00019dc0: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
-00019dd0: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
-00019de0: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-00019df0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-00019e00: 6e5f 626f 7264 6572 5f62 6f74 746f 6d3d  n_border_bottom=
-00019e10: 3530 2c0a 2020 2020 2020 2020 2020 2020  50,.            
-00019e20: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-00019e30: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00019e40: 2e72 6f6f 742e 6c69 6e65 2820 2023 206a  .root.line(  # j
-00019e50: 7573 7420 746f 2064 6566 696e 6520 6561  ust to define ea
-00019e60: 726c 7920 7261 6e67 6573 0a20 2020 2020  rly ranges.     
-00019e70: 2020 2020 2020 2078 3d5b 302c 2030 2e39         x=[0, 0.9
-00019e80: 5d2c 2079 3d5b 2d31 2c20 305d 2c20 6c69  ], y=[-1, 0], li
-00019e90: 6e65 5f63 6f6c 6f72 3d22 2346 4646 4646  ne_color="#FFFFF
-00019ea0: 4622 2c20 616c 7068 613d 302e 300a 2020  F", alpha=0.0.  
-00019eb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00019ec0: 7365 6c66 2e72 6f6f 742e 7175 6164 280a  self.root.quad(.
-00019ed0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00019ee0: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-00019ef0: 2020 2020 2020 2020 2020 2020 746f 703d              top=
-00019f00: 2274 6f70 222c 0a20 2020 2020 2020 2020  "top",.         
-00019f10: 2020 2062 6f74 746f 6d3d 2262 6f74 746f     bottom="botto
-00019f20: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-00019f30: 6c65 6674 3d22 6c65 6674 222c 0a20 2020  left="left",.   
-00019f40: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
-00019f50: 7269 6768 7422 2c0a 2020 2020 2020 2020  right",.        
-00019f60: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-00019f70: 2361 6161 6161 6122 2c0a 2020 2020 2020  #aaaaaa",.      
-00019f80: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
-00019f90: 3d22 2361 6161 6161 6122 2c0a 2020 2020  ="#aaaaaa",.    
-00019fa0: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
-00019fb0: 6861 3d30 2e31 2c0a 2020 2020 2020 2020  ha=0.1,.        
-00019fc0: 2020 2020 6c69 6e65 5f61 6c70 6861 3d30      line_alpha=0
-00019fd0: 2e33 2c0a 2020 2020 2020 2020 290a 2020  .3,.        ).  
-00019fe0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-00019ff0: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
-0001a000: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-0001a010: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0001a020: 2020 746f 703d 2274 6f70 222c 0a20 2020    top="top",.   
-0001a030: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
-0001a040: 2262 6f74 746f 6d22 2c0a 2020 2020 2020  "bottom",.      
-0001a050: 2020 2020 2020 6c65 6674 3d22 6c65 6674        left="left
-0001a060: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
-0001a070: 6967 6874 3d22 7265 6c65 6173 6564 2d6c  ight="released-l
-0001a080: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
-0001a090: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
-0001a0a0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-0001a0b0: 206c 696e 655f 636f 6c6f 723d 2263 6f6c   line_color="col
-0001a0c0: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-0001a0d0: 2066 696c 6c5f 616c 7068 613d 302e 362c   fill_alpha=0.6,
-0001a0e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001a0f0: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
-0001a100: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
-0001a110: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
-0001a120: 652c 0a20 2020 2020 2020 2020 2020 2074  e,.            t
-0001a130: 6f70 3d22 746f 7022 2c0a 2020 2020 2020  op="top",.      
-0001a140: 2020 2020 2020 626f 7474 6f6d 3d22 626f        bottom="bo
-0001a150: 7474 6f6d 222c 0a20 2020 2020 2020 2020  ttom",.         
-0001a160: 2020 206c 6566 743d 2272 656c 6561 7365     left="release
-0001a170: 642d 6c6f 6322 2c0a 2020 2020 2020 2020  d-loc",.        
-0001a180: 2020 2020 7269 6768 743d 226d 656d 6f72      right="memor
-0001a190: 792d 6c6f 6322 2c0a 2020 2020 2020 2020  y-loc",.        
-0001a1a0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-0001a1b0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-0001a1c0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-0001a1d0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-0001a1e0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d31      fill_alpha=1
-0001a1f0: 2e30 2c0a 2020 2020 2020 2020 290a 2020  .0,.        ).  
-0001a200: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001a210: 7175 6164 280a 2020 2020 2020 2020 2020  quad(.          
-0001a220: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
-0001a230: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0001a240: 2020 746f 703d 2274 6f70 222c 0a20 2020    top="top",.   
-0001a250: 2020 2020 2020 2020 2062 6f74 746f 6d3d           bottom=
-0001a260: 2262 6f74 746f 6d22 2c0a 2020 2020 2020  "bottom",.      
-0001a270: 2020 2020 2020 6c65 6674 3d22 6d65 6d6f        left="memo
-0001a280: 7279 2d6c 6f63 222c 0a20 2020 2020 2020  ry-loc",.       
-0001a290: 2020 2020 2072 6967 6874 3d22 6572 7265       right="erre
-0001a2a0: 642d 6c6f 6322 2c0a 2020 2020 2020 2020  d-loc",.        
-0001a2b0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-0001a2c0: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
-0001a2d0: 2020 2020 6669 6c6c 5f61 6c70 6861 3d30      fill_alpha=0
-0001a2e0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-0001a2f0: 6c69 6e65 5f61 6c70 6861 3d30 2c0a 2020  line_alpha=0,.  
-0001a300: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001a310: 7365 6c66 2e72 6f6f 742e 7175 6164 280a  self.root.quad(.
-0001a320: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0001a330: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-0001a340: 2020 2020 2020 2020 2020 2020 746f 703d              top=
-0001a350: 2274 6f70 222c 0a20 2020 2020 2020 2020  "top",.         
-0001a360: 2020 2062 6f74 746f 6d3d 2262 6f74 746f     bottom="botto
-0001a370: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-0001a380: 6c65 6674 3d22 6572 7265 642d 6c6f 6322  left="erred-loc"
-0001a390: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
-0001a3a0: 6768 743d 2270 726f 6365 7373 696e 672d  ght="processing-
-0001a3b0: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
-0001a3c0: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 6772    fill_color="gr
-0001a3d0: 6179 222c 0a20 2020 2020 2020 2020 2020  ay",.           
-0001a3e0: 2066 696c 6c5f 616c 7068 613d 302e 3335   fill_alpha=0.35
-0001a3f0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-0001a400: 6e65 5f61 6c70 6861 3d30 2c0a 2020 2020  ne_alpha=0,.    
-0001a410: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001a420: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-0001a430: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0001a440: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0001a450: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
-0001a460: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
-0001a470: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
-0001a480: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-0001a490: 6674 3d22 7072 6f63 6573 7369 6e67 2d6c  ft="processing-l
-0001a4a0: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
-0001a4b0: 2072 6967 6874 3d22 7175 6575 6564 2d6c   right="queued-l
-0001a4c0: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
-0001a4d0: 2066 696c 6c5f 636f 6c6f 723d 2267 7261   fill_color="gra
-0001a4e0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-0001a4f0: 6861 7463 685f 7061 7474 6572 6e3d 222f  hatch_pattern="/
-0001a500: 222c 0a20 2020 2020 2020 2020 2020 2068  ",.            h
-0001a510: 6174 6368 5f63 6f6c 6f72 3d22 7768 6974  atch_color="whit
-0001a520: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0001a530: 6669 6c6c 5f61 6c70 6861 3d30 2e33 352c  fill_alpha=0.35,
-0001a540: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-0001a550: 655f 616c 7068 613d 302c 0a20 2020 2020  e_alpha=0,.     
-0001a560: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0001a570: 662e 726f 6f74 2e71 7561 6428 0a20 2020  f.root.quad(.   
-0001a580: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0001a590: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
-0001a5a0: 2020 2020 2020 2020 2074 6f70 3d22 746f           top="to
-0001a5b0: 7022 2c0a 2020 2020 2020 2020 2020 2020  p",.            
-0001a5c0: 626f 7474 6f6d 3d22 626f 7474 6f6d 222c  bottom="bottom",
-0001a5d0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
-0001a5e0: 743d 2271 7565 7565 642d 6c6f 6322 2c0a  t="queued-loc",.
-0001a5f0: 2020 2020 2020 2020 2020 2020 7269 6768              righ
-0001a600: 743d 226e 6f2d 776f 726b 6572 2d6c 6f63  t="no-worker-loc
-0001a610: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-0001a620: 696c 6c5f 636f 6c6f 723d 2272 6564 222c  ill_color="red",
-0001a630: 0a20 2020 2020 2020 2020 2020 2068 6174  .            hat
-0001a640: 6368 5f70 6174 7465 726e 3d22 2f22 2c0a  ch_pattern="/",.
-0001a650: 2020 2020 2020 2020 2020 2020 6861 7463              hatc
-0001a660: 685f 636f 6c6f 723d 2262 6c61 636b 222c  h_color="black",
-0001a670: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0001a680: 6c5f 616c 7068 613d 302e 3335 2c0a 2020  l_alpha=0.35,.  
-0001a690: 2020 2020 2020 2020 2020 6c69 6e65 5f61            line_a
-0001a6a0: 6c70 6861 3d30 2c0a 2020 2020 2020 2020  lpha=0,.        
-0001a6b0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0001a6c0: 6f6f 742e 7465 7874 280a 2020 2020 2020  oot.text(.      
-0001a6d0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-0001a6e0: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-0001a6f0: 2020 2020 2020 7465 7874 3d22 7368 6f77        text="show
-0001a700: 2d6e 616d 6522 2c0a 2020 2020 2020 2020  -name",.        
-0001a710: 2020 2020 793d 2262 6f74 746f 6d22 2c0a      y="bottom",.
-0001a720: 2020 2020 2020 2020 2020 2020 783d 226c              x="l
-0001a730: 6566 7422 2c0a 2020 2020 2020 2020 2020  eft",.          
-0001a740: 2020 785f 6f66 6673 6574 3d35 2c0a 2020    x_offset=5,.  
-0001a750: 2020 2020 2020 2020 2020 7465 7874 5f66            text_f
-0001a760: 6f6e 745f 7369 7a65 3d76 616c 7565 2822  ont_size=value("
-0001a770: 3130 7074 2229 2c0a 2020 2020 2020 2020  10pt"),.        
-0001a780: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0001a790: 6f6f 742e 7465 7874 280a 2020 2020 2020  oot.text(.      
-0001a7a0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-0001a7b0: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-0001a7c0: 2020 2020 2020 7465 7874 3d22 646f 6e65        text="done
-0001a7d0: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
-0001a7e0: 3d22 626f 7474 6f6d 222c 0a20 2020 2020  ="bottom",.     
-0001a7f0: 2020 2020 2020 2078 3d22 7269 6768 7422         x="right"
-0001a800: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
-0001a810: 6f66 6673 6574 3d2d 352c 0a20 2020 2020  offset=-5,.     
-0001a820: 2020 2020 2020 2074 6578 745f 616c 6967         text_alig
-0001a830: 6e3d 2272 6967 6874 222c 0a20 2020 2020  n="right",.     
-0001a840: 2020 2020 2020 2074 6578 745f 666f 6e74         text_font
-0001a850: 5f73 697a 653d 7661 6c75 6528 2231 3070  _size=value("10p
-0001a860: 7422 292c 0a20 2020 2020 2020 2029 0a20  t"),.        ). 
-0001a870: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001a880: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
-0001a890: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
-0001a8a0: 656c 662e 726f 6f74 2e79 6178 6973 2e6d  elf.root.yaxis.m
-0001a8b0: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
-0001a8c0: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
-0001a8d0: 2073 656c 662e 726f 6f74 2e79 6178 6973   self.root.yaxis
-0001a8e0: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0001a8f0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001a900: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
-0001a910: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0001a920: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-0001a930: 2e6d 696e 6f72 5f74 6963 6b5f 6c69 6e65  .minor_tick_line
-0001a940: 5f61 6c70 6861 203d 2030 0a20 2020 2020  _alpha = 0.     
-0001a950: 2020 2073 656c 662e 726f 6f74 2e78 6178     self.root.xax
-0001a960: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-0001a970: 7365 0a0a 2020 2020 2020 2020 686f 7665  se..        hove
-0001a980: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
-0001a990: 2020 2020 2020 2020 2020 2070 6f69 6e74             point
-0001a9a0: 5f70 6f6c 6963 793d 2266 6f6c 6c6f 775f  _policy="follow_
-0001a9b0: 6d6f 7573 6522 2c0a 2020 2020 2020 2020  mouse",.        
-0001a9c0: 2020 2020 746f 6f6c 7469 7073 3d22 2222      tooltips="""
-0001a9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a9e0: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
-0001a9f0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-0001aa00: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-0001aa10: 653a 2031 3470 783b 2066 6f6e 742d 7765  e: 14px; font-we
-0001aa20: 6967 6874 3a20 626f 6c64 3b22 3e4e 616d  ight: bold;">Nam
-0001aa30: 653a 3c2f 7370 616e 3e26 6e62 7370 3b0a  e:</span>&nbsp;.
-0001aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa50: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-0001aa60: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-0001aa70: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-0001aa80: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-0001aa90: 3b22 3e40 6e61 6d65 3c2f 7370 616e 3e0a  ;">@name</span>.
-0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aab0: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-0001aac0: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
-0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aae0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-0001aaf0: 6e74 2d73 697a 653a 2031 3470 783b 2066  nt-size: 14px; f
-0001ab00: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-0001ab10: 3b22 3e41 6c6c 3a3c 2f73 7061 6e3e 266e  ;">All:</span>&n
-0001ab20: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
-0001ab30: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001ab40: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001ab50: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-0001ab60: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-0001ab70: 7370 6163 653b 223e 4061 6c6c 3c2f 7370  space;">@all</sp
-0001ab80: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-0001ab90: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
-0001aba0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-0001abb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001abc0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-0001abd0: 3d22 666f 6e74 2d73 697a 653a 2031 3470  ="font-size: 14p
-0001abe0: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-0001abf0: 626f 6c64 3b22 3e51 7565 7565 643a 3c2f  bold;">Queued:</
-0001ac00: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
-0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac20: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-0001ac30: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-0001ac40: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-0001ac50: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-0001ac60: 7175 6575 6564 3c2f 7370 616e 3e0a 2020  queued</span>.  
-0001ac70: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-0001ac80: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001ac90: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-0001aca0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001acb0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-0001acc0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
-0001acd0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-0001ace0: 3e4e 6f2d 776f 726b 6572 3a3c 2f73 7061  >No-worker:</spa
-0001acf0: 6e3e 266e 6273 703b 0a20 2020 2020 2020  n>&nbsp;.       
-0001ad00: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-0001ad10: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-0001ad20: 697a 653a 2031 3070 783b 2066 6f6e 742d  ize: 10px; font-
-0001ad30: 6661 6d69 6c79 3a20 4d6f 6e61 636f 2c20  family: Monaco, 
-0001ad40: 6d6f 6e6f 7370 6163 653b 223e 406e 6f5f  monospace;">@no_
-0001ad50: 776f 726b 6572 3c2f 7370 616e 3e0a 2020  worker</span>.  
-0001ad60: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-0001ad70: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001ad80: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-0001ad90: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001ada0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-0001adb0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
-0001adc0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-0001add0: 3e50 726f 6365 7373 696e 673a 3c2f 7370  >Processing:</sp
-0001ade0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
-0001adf0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-0001ae00: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-0001ae10: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-0001ae20: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-0001ae30: 206d 6f6e 6f73 7061 6365 3b22 3e40 7072   monospace;">@pr
-0001ae40: 6f63 6573 7369 6e67 3c2f 7370 616e 3e0a  ocessing</span>.
-0001ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae60: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-0001ae70: 2020 2020 2020 203c 6469 763e 0a20 2020         <div>.   
-0001ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae90: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-0001aea0: 6e74 2d73 697a 653a 2031 3470 783b 2066  nt-size: 14px; f
-0001aeb0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-0001aec0: 3b22 3e4d 656d 6f72 793a 3c2f 7370 616e  ;">Memory:</span
-0001aed0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-0001aee0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-0001aef0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-0001af00: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-0001af10: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-0001af20: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
-0001af30: 7279 3c2f 7370 616e 3e0a 2020 2020 2020  ry</span>.      
-0001af40: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-0001af50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001af60: 203c 6469 763e 0a20 2020 2020 2020 2020   <div>.         
-0001af70: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-0001af80: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-0001af90: 653a 2031 3470 783b 2066 6f6e 742d 7765  e: 14px; font-we
-0001afa0: 6967 6874 3a20 626f 6c64 3b22 3e45 7272  ight: bold;">Err
-0001afb0: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
-0001afc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001afd0: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-0001afe0: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
-0001aff0: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
-0001b000: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
-0001b010: 653b 223e 4065 7272 6564 3c2f 7370 616e  e;">@erred</span
-0001b020: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0001b030: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-0001b040: 2020 2020 2020 2020 2022 2222 2c0a 2020           """,.  
-0001b050: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001b060: 6865 6c70 5f20 3d20 4865 6c70 546f 6f6c  help_ = HelpTool
-0001b070: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
-0001b080: 6469 7265 6374 3d22 6874 7470 733a 2f2f  direct="https://
-0001b090: 646f 6373 2e64 6173 6b2e 6f72 672f 656e  docs.dask.org/en
-0001b0a0: 2f73 7461 626c 652f 6461 7368 626f 6172  /stable/dashboar
-0001b0b0: 642e 6874 6d6c 2370 726f 6772 6573 7322  d.html#progress"
-0001b0c0: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-0001b0d0: 7363 7269 7074 696f 6e3d 2241 2064 6573  scription="A des
-0001b0e0: 6372 6970 7469 6f6e 206f 6620 7468 6520  cription of the 
-0001b0f0: 7072 6f67 7265 7373 2062 6172 7320 706c  progress bars pl
-0001b100: 6f74 2e22 2c0a 2020 2020 2020 2020 290a  ot.",.        ).
-0001b110: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001b120: 742e 6164 645f 746f 6f6c 7328 686f 7665  t.add_tools(hove
-0001b130: 722c 2068 656c 705f 290a 0a20 2020 2040  r, help_)..    @
-0001b140: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-0001b150: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-0001b160: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0001b170: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-0001b180: 3a0a 2020 2020 2020 2020 7374 6174 6520  :.        state 
-0001b190: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0001b1a0: 226d 656d 6f72 7922 3a20 7b7d 2c0a 2020  "memory": {},.  
-0001b1b0: 2020 2020 2020 2020 2020 2265 7272 6564            "erred
-0001b1c0: 223a 207b 7d2c 0a20 2020 2020 2020 2020  ": {},.         
-0001b1d0: 2020 2022 7265 6c65 6173 6564 223a 207b     "released": {
-0001b1e0: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
-0001b1f0: 7072 6f63 6573 7369 6e67 223a 207b 7d2c  processing": {},
-0001b200: 0a20 2020 2020 2020 2020 2020 2022 7761  .            "wa
-0001b210: 6974 696e 6722 3a20 7b7d 2c0a 2020 2020  iting": {},.    
-0001b220: 2020 2020 2020 2020 2271 7565 7565 6422          "queued"
-0001b230: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
-0001b240: 2020 226e 6f5f 776f 726b 6572 223a 207b    "no_worker": {
-0001b250: 7d2c 0a20 2020 2020 2020 207d 0a0a 2020  },.        }..  
-0001b260: 2020 2020 2020 666f 7220 7470 2069 6e20        for tp in 
-0001b270: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
-0001b280: 6173 6b5f 7072 6566 6978 6573 2e76 616c  ask_prefixes.val
-0001b290: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-0001b2a0: 2020 2061 6374 6976 655f 7374 6174 6573     active_states
-0001b2b0: 203d 2074 702e 6163 7469 7665 5f73 7461   = tp.active_sta
-0001b2c0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-0001b2d0: 6966 2061 6e79 2861 6374 6976 655f 7374  if any(active_st
-0001b2e0: 6174 6573 2e67 6574 2873 2920 666f 7220  ates.get(s) for 
-0001b2f0: 7320 696e 2073 7461 7465 2e6b 6579 7328  s in state.keys(
-0001b300: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0001b310: 2020 2020 7374 6174 655b 226d 656d 6f72      state["memor
-0001b320: 7922 5d5b 7470 2e6e 616d 655d 203d 2061  y"][tp.name] = a
-0001b330: 6374 6976 655f 7374 6174 6573 5b22 6d65  ctive_states["me
-0001b340: 6d6f 7279 225d 0a20 2020 2020 2020 2020  mory"].         
-0001b350: 2020 2020 2020 2073 7461 7465 5b22 6572         state["er
-0001b360: 7265 6422 5d5b 7470 2e6e 616d 655d 203d  red"][tp.name] =
-0001b370: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-0001b380: 6572 7265 6422 5d0a 2020 2020 2020 2020  erred"].        
-0001b390: 2020 2020 2020 2020 7374 6174 655b 2272          state["r
-0001b3a0: 656c 6561 7365 6422 5d5b 7470 2e6e 616d  eleased"][tp.nam
-0001b3b0: 655d 203d 2061 6374 6976 655f 7374 6174  e] = active_stat
-0001b3c0: 6573 5b22 7265 6c65 6173 6564 225d 0a20  es["released"]. 
-0001b3d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001b3e0: 7461 7465 5b22 7072 6f63 6573 7369 6e67  tate["processing
-0001b3f0: 225d 5b74 702e 6e61 6d65 5d20 3d20 6163  "][tp.name] = ac
-0001b400: 7469 7665 5f73 7461 7465 735b 2270 726f  tive_states["pro
-0001b410: 6365 7373 696e 6722 5d0a 2020 2020 2020  cessing"].      
-0001b420: 2020 2020 2020 2020 2020 7374 6174 655b            state[
-0001b430: 2277 6169 7469 6e67 225d 5b74 702e 6e61  "waiting"][tp.na
-0001b440: 6d65 5d20 3d20 6163 7469 7665 5f73 7461  me] = active_sta
-0001b450: 7465 735b 2277 6169 7469 6e67 225d 0a20  tes["waiting"]. 
-0001b460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001b470: 7461 7465 5b22 7175 6575 6564 225d 5b74  tate["queued"][t
-0001b480: 702e 6e61 6d65 5d20 3d20 6163 7469 7665  p.name] = active
-0001b490: 5f73 7461 7465 735b 2271 7565 7565 6422  _states["queued"
-0001b4a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001b4b0: 2020 7374 6174 655b 226e 6f5f 776f 726b    state["no_work
-0001b4c0: 6572 225d 5b74 702e 6e61 6d65 5d20 3d20  er"][tp.name] = 
-0001b4d0: 6163 7469 7665 5f73 7461 7465 735b 226e  active_states["n
-0001b4e0: 6f2d 776f 726b 6572 225d 0a0a 2020 2020  o-worker"]..    
-0001b4f0: 2020 2020 7374 6174 655b 2261 6c6c 225d      state["all"]
-0001b500: 203d 207b 6b3a 2073 756d 2876 5b6b 5d20   = {k: sum(v[k] 
-0001b510: 666f 7220 7620 696e 2073 7461 7465 2e76  for v in state.v
-0001b520: 616c 7565 7328 2929 2066 6f72 206b 2069  alues()) for k i
-0001b530: 6e20 7374 6174 655b 226d 656d 6f72 7922  n state["memory"
-0001b540: 5d7d 0a0a 2020 2020 2020 2020 6966 206e  ]}..        if n
-0001b550: 6f74 2073 7461 7465 5b22 616c 6c22 5d20  ot state["all"] 
-0001b560: 616e 6420 6e6f 7420 6c65 6e28 7365 6c66  and not len(self
-0001b570: 2e73 6f75 7263 652e 6461 7461 5b22 616c  .source.data["al
-0001b580: 6c22 5d29 3a0a 2020 2020 2020 2020 2020  l"]):.          
-0001b590: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-0001b5a0: 2020 6420 3d20 7072 6f67 7265 7373 5f71    d = progress_q
-0001b5b0: 7561 6473 2873 7461 7465 290a 0a20 2020  uads(state)..   
-0001b5c0: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
-0001b5d0: 2e73 6f75 7263 652c 2064 290a 0a20 2020  .source, d)..   
-0001b5e0: 2020 2020 2074 6f74 616c 7320 3d20 7b0a       totals = {.
-0001b5f0: 2020 2020 2020 2020 2020 2020 6b3a 2073              k: s
-0001b600: 756d 2873 7461 7465 5b6b 5d2e 7661 6c75  um(state[k].valu
-0001b610: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-0001b620: 2020 666f 7220 6b20 696e 205b 0a20 2020    for k in [.   
-0001b630: 2020 2020 2020 2020 2020 2020 2022 616c               "al
-0001b640: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
-0001b650: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
-0001b660: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-0001b670: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
-0001b680: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
-0001b690: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001b6a0: 2020 2022 7761 6974 696e 6722 2c0a 2020     "waiting",.  
-0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2271                "q
-0001b6c0: 7565 7565 6422 2c0a 2020 2020 2020 2020  ueued",.        
-0001b6d0: 2020 2020 2020 2020 226e 6f5f 776f 726b          "no_work
-0001b6e0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0001b6f0: 205d 0a20 2020 2020 2020 207d 0a20 2020   ].        }.   
-0001b700: 2020 2020 2074 6f74 616c 735b 2270 726f       totals["pro
-0001b710: 6365 7373 696e 6722 5d20 3d20 746f 7461  cessing"] = tota
-0001b720: 6c73 5b22 616c 6c22 5d20 2d20 7375 6d28  ls["all"] - sum(
-0001b730: 0a20 2020 2020 2020 2020 2020 2076 2066  .            v f
-0001b740: 6f72 206b 2c20 7620 696e 2074 6f74 616c  or k, v in total
-0001b750: 732e 6974 656d 7328 2920 6966 206b 2021  s.items() if k !
-0001b760: 3d20 2261 6c6c 220a 2020 2020 2020 2020  = "all".        
-0001b770: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001b780: 726f 6f74 2e74 6974 6c65 2e74 6578 7420  root.title.text 
-0001b790: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0001b7a0: 2250 726f 6772 6573 7320 2d2d 2074 6f74  "Progress -- tot
-0001b7b0: 616c 3a20 2528 616c 6c29 732c 2022 0a20  al: %(all)s, ". 
-0001b7c0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
-0001b7d0: 696e 673a 2025 2877 6169 7469 6e67 2973  ing: %(waiting)s
+00019870: 2074 6f70 5f6c 696e 6520 3d20 6c69 6e65   top_line = line
+00019880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019890: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+000198a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000198b0: 656c 662e 5f68 6f76 6572 2e72 656e 6465  elf._hover.rende
+000198c0: 7265 7273 203d 205b 746f 705f 6c69 6e65  rers = [top_line
+000198d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000198e0: 2020 7365 6c66 2e5f 686f 7665 722e 666f    self._hover.fo
+000198f0: 726d 6174 7465 7273 203d 207b 2224 696e  rmatters = {"$in
+00019900: 6465 7822 3a20 666f 726d 6174 7465 727d  dex": formatter}
+00019910: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00019920: 6c66 2e5f 6c61 7374 5f64 7261 776e 203d  lf._last_drawn =
+00019930: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+00019940: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
+00019950: 7261 6e73 6974 696f 6e5f 636f 756e 7420  ransition_count 
+00019960: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00019970: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+00019980: 7465 720a 2020 2020 2020 2020 656c 6966  ter.        elif
+00019990: 2073 656c 662e 5f73 686f 756c 645f 7570   self._should_up
+000199a0: 6461 7465 2829 3a0a 2020 2020 2020 2020  date():.        
+000199b0: 2020 2020 2320 506f 7373 6962 6c79 2075      # Possibly u
+000199c0: 7064 6174 6520 7468 6520 7920 7261 6e67  pdate the y rang
+000199d0: 6520 6966 206e 6577 2074 6872 6561 6473  e if new threads
+000199e0: 2068 6176 6520 6265 656e 2061 6464 6564   have been added
+000199f0: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
+00019a00: 5f6e 7468 7265 6164 7320 3d20 6d61 7828  _nthreads = max(
+00019a10: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
+00019a20: 6561 6473 290a 2020 2020 2020 2020 2020  eads).          
+00019a30: 2020 6966 2073 656c 662e 726f 6f74 2e79    if self.root.y
+00019a40: 5f72 616e 6765 2e65 6e64 2021 3d20 6d61  _range.end != ma
+00019a50: 785f 6e74 6872 6561 6473 3a0a 2020 2020  x_nthreads:.    
+00019a60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019a70: 2e72 6f6f 742e 795f 7261 6e67 652e 656e  .root.y_range.en
+00019a80: 6420 3d20 6d61 785f 6e74 6872 6561 6473  d = max_nthreads
+00019a90: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00019aa0: 7064 6174 6520 7468 6520 6461 7461 2c20  pdate the data, 
+00019ab0: 6f6e 6c79 2069 6e63 6c75 6469 6e67 2065  only including e
+00019ac0: 7869 7374 696e 6720 636f 6c75 6d6e 732c  xisting columns,
+00019ad0: 2072 6174 6865 7220 7468 616e 2072 6564   rather than red
+00019ae0: 7261 7769 6e67 0a20 2020 2020 2020 2020  rawing.         
+00019af0: 2020 2023 2074 6865 2077 686f 6c65 2063     # the whole c
+00019b00: 6861 7274 2e0a 2020 2020 2020 2020 2020  hart..          
+00019b10: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
+00019b20: 7461 203d 2073 656c 662e 5f67 6574 5f74  ta = self._get_t
+00019b30: 696d 6573 6572 6965 7328 7265 7374 7269  imeseries(restri
+00019b40: 6374 5f74 6f5f 6578 6973 7469 6e67 3d54  ct_to_existing=T
+00019b50: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+00019b60: 2073 656c 662e 5f6c 6173 745f 7472 616e   self._last_tran
+00019b70: 7369 7469 6f6e 5f63 6f75 6e74 203d 2073  sition_count = s
+00019b80: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
+00019b90: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00019ba0: 0a0a 0a63 6c61 7373 2054 6173 6b50 726f  ...class TaskPro
+00019bb0: 6772 6573 7328 4461 7368 626f 6172 6443  gress(DashboardC
+00019bc0: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
+00019bd0: 2222 5072 6f67 7265 7373 2062 6172 7320  ""Progress bars 
+00019be0: 7065 7220 7461 736b 2074 7970 6522 2222  per task type"""
+00019bf0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00019c00: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00019c10: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+00019c20: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00019c30: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+00019c40: 720a 0a20 2020 2020 2020 2064 6174 6120  r..        data 
+00019c50: 3d20 7072 6f67 7265 7373 5f71 7561 6473  = progress_quads
+00019c60: 280a 2020 2020 2020 2020 2020 2020 6469  (.            di
+00019c70: 6374 2861 6c6c 3d7b 7d2c 206d 656d 6f72  ct(all={}, memor
+00019c80: 793d 7b7d 2c20 6572 7265 643d 7b7d 2c20  y={}, erred={}, 
+00019c90: 7265 6c65 6173 6564 3d7b 7d2c 2070 726f  released={}, pro
+00019ca0: 6365 7373 696e 673d 7b7d 2c20 7175 6575  cessing={}, queu
+00019cb0: 6564 3d7b 7d29 0a20 2020 2020 2020 2029  ed={}).        )
+00019cc0: 0a20 2020 2020 2020 2073 656c 662e 736f  .        self.so
+00019cd0: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00019ce0: 6153 6f75 7263 6528 6461 7461 3d64 6174  aSource(data=dat
+00019cf0: 6129 0a0a 2020 2020 2020 2020 785f 7261  a)..        x_ra
+00019d00: 6e67 6520 3d20 4461 7461 5261 6e67 6531  nge = DataRange1
+00019d10: 6428 7261 6e67 655f 7061 6464 696e 673d  d(range_padding=
+00019d20: 3029 0a20 2020 2020 2020 2079 5f72 616e  0).        y_ran
+00019d30: 6765 203d 2052 616e 6765 3164 282d 382c  ge = Range1d(-8,
+00019d40: 2030 290a 0a20 2020 2020 2020 2073 656c   0)..        sel
+00019d50: 662e 726f 6f74 203d 2066 6967 7572 6528  f.root = figure(
+00019d60: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00019d70: 6c65 3d22 5072 6f67 7265 7373 222c 0a20  le="Progress",. 
+00019d80: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00019d90: 2274 6173 6b5f 7072 6f67 7265 7373 222c  "task_progress",
+00019da0: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+00019db0: 616e 6765 3d78 5f72 616e 6765 2c0a 2020  ange=x_range,.  
+00019dc0: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
+00019dd0: 653d 795f 7261 6e67 652c 0a20 2020 2020  e=y_range,.     
+00019de0: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
+00019df0: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
+00019e00: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00019e10: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
+00019e20: 2020 206d 696e 5f62 6f72 6465 725f 626f     min_border_bo
+00019e30: 7474 6f6d 3d35 302c 0a20 2020 2020 2020  ttom=50,.       
+00019e40: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00019e50: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00019e60: 2073 656c 662e 726f 6f74 2e6c 696e 6528   self.root.line(
+00019e70: 2020 2320 6a75 7374 2074 6f20 6465 6669    # just to defi
+00019e80: 6e65 2065 6172 6c79 2072 616e 6765 730a  ne early ranges.
+00019e90: 2020 2020 2020 2020 2020 2020 783d 5b30              x=[0
+00019ea0: 2c20 302e 395d 2c20 793d 5b2d 312c 2030  , 0.9], y=[-1, 0
+00019eb0: 5d2c 206c 696e 655f 636f 6c6f 723d 2223  ], line_color="#
+00019ec0: 4646 4646 4646 222c 2061 6c70 6861 3d30  FFFFFF", alpha=0
+00019ed0: 2e30 0a20 2020 2020 2020 2029 0a20 2020  .0.        ).   
+00019ee0: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
+00019ef0: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
+00019f00: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+00019f10: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+00019f20: 2074 6f70 3d22 746f 7022 2c0a 2020 2020   top="top",.    
+00019f30: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
+00019f40: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
+00019f50: 2020 2020 206c 6566 743d 226c 6566 7422       left="left"
+00019f60: 2c0a 2020 2020 2020 2020 2020 2020 7269  ,.            ri
+00019f70: 6768 743d 2272 6967 6874 222c 0a20 2020  ght="right",.   
+00019f80: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+00019f90: 6c6f 723d 2223 6161 6161 6161 222c 0a20  lor="#aaaaaa",. 
+00019fa0: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+00019fb0: 636f 6c6f 723d 2223 6161 6161 6161 222c  color="#aaaaaa",
+00019fc0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00019fd0: 6c5f 616c 7068 613d 302e 312c 0a20 2020  l_alpha=0.1,.   
+00019fe0: 2020 2020 2020 2020 206c 696e 655f 616c           line_al
+00019ff0: 7068 613d 302e 332c 0a20 2020 2020 2020  pha=0.3,.       
+0001a000: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001a010: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
+0001a020: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+0001a030: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+0001a040: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
+0001a050: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+0001a060: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
+0001a070: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+0001a080: 226c 6566 7422 2c0a 2020 2020 2020 2020  "left",.        
+0001a090: 2020 2020 7269 6768 743d 2272 656c 6561      right="relea
+0001a0a0: 7365 642d 6c6f 6322 2c0a 2020 2020 2020  sed-loc",.      
+0001a0b0: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
+0001a0c0: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
+0001a0d0: 2020 2020 2020 6c69 6e65 5f63 6f6c 6f72        line_color
+0001a0e0: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
+0001a0f0: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
+0001a100: 3d30 2e36 2c0a 2020 2020 2020 2020 290a  =0.6,.        ).
+0001a110: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001a120: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
+0001a130: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0001a140: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0001a150: 2020 2020 746f 703d 2274 6f70 222c 0a20      top="top",. 
+0001a160: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
+0001a170: 6d3d 2262 6f74 746f 6d22 2c0a 2020 2020  m="bottom",.    
+0001a180: 2020 2020 2020 2020 6c65 6674 3d22 7265          left="re
+0001a190: 6c65 6173 6564 2d6c 6f63 222c 0a20 2020  leased-loc",.   
+0001a1a0: 2020 2020 2020 2020 2072 6967 6874 3d22           right="
+0001a1b0: 6d65 6d6f 7279 2d6c 6f63 222c 0a20 2020  memory-loc",.   
+0001a1c0: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+0001a1d0: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
+0001a1e0: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+0001a1f0: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
+0001a200: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
+0001a210: 7068 613d 312e 302c 0a20 2020 2020 2020  pha=1.0,.       
+0001a220: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001a230: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
+0001a240: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+0001a250: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+0001a260: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
+0001a270: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+0001a280: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
+0001a290: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+0001a2a0: 226d 656d 6f72 792d 6c6f 6322 2c0a 2020  "memory-loc",.  
+0001a2b0: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+0001a2c0: 2265 7272 6564 2d6c 6f63 222c 0a20 2020  "erred-loc",.   
+0001a2d0: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+0001a2e0: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
+0001a2f0: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
+0001a300: 7068 613d 302e 352c 0a20 2020 2020 2020  pha=0.5,.       
+0001a310: 2020 2020 206c 696e 655f 616c 7068 613d       line_alpha=
+0001a320: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
+0001a330: 2020 2020 2073 656c 662e 726f 6f74 2e71       self.root.q
+0001a340: 7561 6428 0a20 2020 2020 2020 2020 2020  uad(.           
+0001a350: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+0001a360: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+0001a370: 2074 6f70 3d22 746f 7022 2c0a 2020 2020   top="top",.    
+0001a380: 2020 2020 2020 2020 626f 7474 6f6d 3d22          bottom="
+0001a390: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
+0001a3a0: 2020 2020 206c 6566 743d 2265 7272 6564       left="erred
+0001a3b0: 2d6c 6f63 222c 0a20 2020 2020 2020 2020  -loc",.         
+0001a3c0: 2020 2072 6967 6874 3d22 7072 6f63 6573     right="proces
+0001a3d0: 7369 6e67 2d6c 6f63 222c 0a20 2020 2020  sing-loc",.     
+0001a3e0: 2020 2020 2020 2066 696c 6c5f 636f 6c6f         fill_colo
+0001a3f0: 723d 2267 7261 7922 2c0a 2020 2020 2020  r="gray",.      
+0001a400: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
+0001a410: 3d30 2e33 352c 0a20 2020 2020 2020 2020  =0.35,.         
+0001a420: 2020 206c 696e 655f 616c 7068 613d 302c     line_alpha=0,
+0001a430: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001a440: 2020 2073 656c 662e 726f 6f74 2e71 7561     self.root.qua
+0001a450: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+0001a460: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+0001a470: 652c 0a20 2020 2020 2020 2020 2020 2074  e,.            t
+0001a480: 6f70 3d22 746f 7022 2c0a 2020 2020 2020  op="top",.      
+0001a490: 2020 2020 2020 626f 7474 6f6d 3d22 626f        bottom="bo
+0001a4a0: 7474 6f6d 222c 0a20 2020 2020 2020 2020  ttom",.         
+0001a4b0: 2020 206c 6566 743d 2270 726f 6365 7373     left="process
+0001a4c0: 696e 672d 6c6f 6322 2c0a 2020 2020 2020  ing-loc",.      
+0001a4d0: 2020 2020 2020 7269 6768 743d 2271 7565        right="que
+0001a4e0: 7565 642d 6c6f 6322 2c0a 2020 2020 2020  ued-loc",.      
+0001a4f0: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
+0001a500: 3d22 6772 6179 222c 0a20 2020 2020 2020  ="gray",.       
+0001a510: 2020 2020 2068 6174 6368 5f70 6174 7465       hatch_patte
+0001a520: 726e 3d22 2f22 2c0a 2020 2020 2020 2020  rn="/",.        
+0001a530: 2020 2020 6861 7463 685f 636f 6c6f 723d      hatch_color=
+0001a540: 2277 6869 7465 222c 0a20 2020 2020 2020  "white",.       
+0001a550: 2020 2020 2066 696c 6c5f 616c 7068 613d       fill_alpha=
+0001a560: 302e 3335 2c0a 2020 2020 2020 2020 2020  0.35,.          
+0001a570: 2020 6c69 6e65 5f61 6c70 6861 3d30 2c0a    line_alpha=0,.
+0001a580: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001a590: 2020 7365 6c66 2e72 6f6f 742e 7175 6164    self.root.quad
+0001a5a0: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
+0001a5b0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
+0001a5c0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+0001a5d0: 703d 2274 6f70 222c 0a20 2020 2020 2020  p="top",.       
+0001a5e0: 2020 2020 2062 6f74 746f 6d3d 2262 6f74       bottom="bot
+0001a5f0: 746f 6d22 2c0a 2020 2020 2020 2020 2020  tom",.          
+0001a600: 2020 6c65 6674 3d22 7175 6575 6564 2d6c    left="queued-l
+0001a610: 6f63 222c 0a20 2020 2020 2020 2020 2020  oc",.           
+0001a620: 2072 6967 6874 3d22 6e6f 2d77 6f72 6b65   right="no-worke
+0001a630: 722d 6c6f 6322 2c0a 2020 2020 2020 2020  r-loc",.        
+0001a640: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+0001a650: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+0001a660: 2020 6861 7463 685f 7061 7474 6572 6e3d    hatch_pattern=
+0001a670: 222f 222c 0a20 2020 2020 2020 2020 2020  "/",.           
+0001a680: 2068 6174 6368 5f63 6f6c 6f72 3d22 626c   hatch_color="bl
+0001a690: 6163 6b22 2c0a 2020 2020 2020 2020 2020  ack",.          
+0001a6a0: 2020 6669 6c6c 5f61 6c70 6861 3d30 2e33    fill_alpha=0.3
+0001a6b0: 352c 0a20 2020 2020 2020 2020 2020 206c  5,.            l
+0001a6c0: 696e 655f 616c 7068 613d 302c 0a20 2020  ine_alpha=0,.   
+0001a6d0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0001a6e0: 656c 662e 726f 6f74 2e74 6578 7428 0a20  elf.root.text(. 
+0001a6f0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001a700: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+0001a710: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+0001a720: 2273 686f 772d 6e61 6d65 222c 0a20 2020  "show-name",.   
+0001a730: 2020 2020 2020 2020 2079 3d22 626f 7474           y="bott
+0001a740: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
+0001a750: 2078 3d22 6c65 6674 222c 0a20 2020 2020   x="left",.     
+0001a760: 2020 2020 2020 2078 5f6f 6666 7365 743d         x_offset=
+0001a770: 352c 0a20 2020 2020 2020 2020 2020 2074  5,.            t
+0001a780: 6578 745f 666f 6e74 5f73 697a 653d 7661  ext_font_size=va
+0001a790: 6c75 6528 2231 3070 7422 292c 0a20 2020  lue("10pt"),.   
+0001a7a0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0001a7b0: 656c 662e 726f 6f74 2e74 6578 7428 0a20  elf.root.text(. 
+0001a7c0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001a7d0: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
+0001a7e0: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+0001a7f0: 2264 6f6e 6522 2c0a 2020 2020 2020 2020  "done",.        
+0001a800: 2020 2020 793d 2262 6f74 746f 6d22 2c0a      y="bottom",.
+0001a810: 2020 2020 2020 2020 2020 2020 783d 2272              x="r
+0001a820: 6967 6874 222c 0a20 2020 2020 2020 2020  ight",.         
+0001a830: 2020 2078 5f6f 6666 7365 743d 2d35 2c0a     x_offset=-5,.
+0001a840: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0001a850: 5f61 6c69 676e 3d22 7269 6768 7422 2c0a  _align="right",.
+0001a860: 2020 2020 2020 2020 2020 2020 7465 7874              text
+0001a870: 5f66 6f6e 745f 7369 7a65 3d76 616c 7565  _font_size=value
+0001a880: 2822 3130 7074 2229 2c0a 2020 2020 2020  ("10pt"),.      
+0001a890: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001a8a0: 2e72 6f6f 742e 7967 7269 642e 7669 7369  .root.ygrid.visi
+0001a8b0: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+0001a8c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7961      self.root.ya
+0001a8d0: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
+0001a8e0: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
+0001a8f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001a900: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
+0001a910: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+0001a920: 6c66 2e72 6f6f 742e 7867 7269 642e 7669  lf.root.xgrid.vi
+0001a930: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
+0001a940: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001a950: 7861 7869 732e 6d69 6e6f 725f 7469 636b  xaxis.minor_tick
+0001a960: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
+0001a970: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001a980: 742e 7861 7869 732e 7669 7369 626c 6520  t.xaxis.visible 
+0001a990: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+0001a9a0: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+0001a9b0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
+0001a9c0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
+0001a9d0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
+0001a9e0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
+0001a9f0: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
+0001aa00: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa20: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+0001aa30: 742d 7369 7a65 3a20 3134 7078 3b20 666f  t-size: 14px; fo
+0001aa40: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+0001aa50: 223e 4e61 6d65 3a3c 2f73 7061 6e3e 266e  ">Name:</span>&n
+0001aa60: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+0001aa70: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+0001aa80: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+0001aa90: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+0001aaa0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+0001aab0: 7370 6163 653b 223e 406e 616d 653c 2f73  space;">@name</s
+0001aac0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+0001aad0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+0001aae0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+0001aaf0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001ab00: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+0001ab10: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
+0001ab20: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+0001ab30: 2062 6f6c 643b 223e 416c 6c3a 3c2f 7370   bold;">All:</sp
+0001ab40: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+0001ab60: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+0001ab70: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+0001ab80: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+0001ab90: 206d 6f6e 6f73 7061 6365 3b22 3e40 616c   monospace;">@al
+0001aba0: 6c3c 2f73 7061 6e3e 0a20 2020 2020 2020  l</span>.       
+0001abb0: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
+0001abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abd0: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+0001abe0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+0001abf0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+0001ac00: 3a20 3134 7078 3b20 666f 6e74 2d77 6569  : 14px; font-wei
+0001ac10: 6768 743a 2062 6f6c 643b 223e 5175 6575  ght: bold;">Queu
+0001ac20: 6564 3a3c 2f73 7061 6e3e 266e 6273 703b  ed:</span>&nbsp;
+0001ac30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ac40: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+0001ac50: 3d22 666f 6e74 2d73 697a 653a 2031 3070  ="font-size: 10p
+0001ac60: 783b 2066 6f6e 742d 6661 6d69 6c79 3a20  x; font-family: 
+0001ac70: 4d6f 6e61 636f 2c20 6d6f 6e6f 7370 6163  Monaco, monospac
+0001ac80: 653b 223e 4071 7565 7565 643c 2f73 7061  e;">@queued</spa
+0001ac90: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
+0001aca0: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+0001acb0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+0001acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acd0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+0001ace0: 2266 6f6e 742d 7369 7a65 3a20 3134 7078  "font-size: 14px
+0001acf0: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
+0001ad00: 6f6c 643b 223e 4e6f 2d77 6f72 6b65 723a  old;">No-worker:
+0001ad10: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+0001ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad30: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+0001ad40: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+0001ad50: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+0001ad60: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+0001ad70: 3e40 6e6f 5f77 6f72 6b65 723c 2f73 7061  >@no_worker</spa
+0001ad80: 6e3e 0a20 2020 2020 2020 2020 2020 2020  n>.             
+0001ad90: 2020 203c 2f64 6976 3e0a 2020 2020 2020     </div>.      
+0001ada0: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adc0: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+0001add0: 2266 6f6e 742d 7369 7a65 3a20 3134 7078  "font-size: 14px
+0001ade0: 3b20 666f 6e74 2d77 6569 6768 743a 2062  ; font-weight: b
+0001adf0: 6f6c 643b 223e 5072 6f63 6573 7369 6e67  old;">Processing
+0001ae00: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
+0001ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae20: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+0001ae30: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+0001ae40: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+0001ae50: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+0001ae60: 223e 4070 726f 6365 7373 696e 673c 2f73  ">@processing</s
+0001ae70: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+0001ae80: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+0001ae90: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+0001aea0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001aeb0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+0001aec0: 653d 2266 6f6e 742d 7369 7a65 3a20 3134  e="font-size: 14
+0001aed0: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+0001aee0: 2062 6f6c 643b 223e 4d65 6d6f 7279 3a3c   bold;">Memory:<
+0001aef0: 2f73 7061 6e3e 266e 6273 703b 0a20 2020  /span>&nbsp;.   
+0001af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af10: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+0001af20: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+0001af30: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+0001af40: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+0001af50: 406d 656d 6f72 793c 2f73 7061 6e3e 0a20  @memory</span>. 
+0001af60: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001af70: 2f64 6976 3e0a 2020 2020 2020 2020 2020  /div>.          
+0001af80: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+0001af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001afa0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+0001afb0: 742d 7369 7a65 3a20 3134 7078 3b20 666f  t-size: 14px; fo
+0001afc0: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+0001afd0: 223e 4572 7265 643a 3c2f 7370 616e 3e26  ">Erred:</span>&
+0001afe0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+0001aff0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+0001b000: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+0001b010: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+0001b020: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+0001b030: 6f73 7061 6365 3b22 3e40 6572 7265 643c  ospace;">@erred<
+0001b040: 2f73 7061 6e3e 0a20 2020 2020 2020 2020  /span>.         
+0001b050: 2020 2020 2020 203c 2f64 6976 3e0a 2020         </div>.  
+0001b060: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+0001b070: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0001b080: 2020 2020 2068 656c 705f 203d 2048 656c       help_ = Hel
+0001b090: 7054 6f6f 6c28 0a20 2020 2020 2020 2020  pTool(.         
+0001b0a0: 2020 2072 6564 6972 6563 743d 2268 7474     redirect="htt
+0001b0b0: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
+0001b0c0: 7267 2f65 6e2f 7374 6162 6c65 2f64 6173  rg/en/stable/das
+0001b0d0: 6862 6f61 7264 2e68 746d 6c23 7072 6f67  hboard.html#prog
+0001b0e0: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
+0001b0f0: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
+0001b100: 4120 6465 7363 7269 7074 696f 6e20 6f66  A description of
+0001b110: 2074 6865 2070 726f 6772 6573 7320 6261   the progress ba
+0001b120: 7273 2070 6c6f 742e 222c 0a20 2020 2020  rs plot.",.     
+0001b130: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001b140: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+0001b150: 2868 6f76 6572 2c20 6865 6c70 5f29 0a0a  (hover, help_)..
+0001b160: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
+0001b170: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
+0001b180: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0001b190: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
+0001b1a0: 7365 6c66 293a 0a20 2020 2020 2020 2073  self):.        s
+0001b1b0: 7461 7465 203d 207b 0a20 2020 2020 2020  tate = {.       
+0001b1c0: 2020 2020 2022 6d65 6d6f 7279 223a 207b       "memory": {
+0001b1d0: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
+0001b1e0: 6572 7265 6422 3a20 7b7d 2c0a 2020 2020  erred": {},.    
+0001b1f0: 2020 2020 2020 2020 2272 656c 6561 7365          "release
+0001b200: 6422 3a20 7b7d 2c0a 2020 2020 2020 2020  d": {},.        
+0001b210: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
+0001b220: 3a20 7b7d 2c0a 2020 2020 2020 2020 2020  : {},.          
+0001b230: 2020 2277 6169 7469 6e67 223a 207b 7d2c    "waiting": {},
+0001b240: 0a20 2020 2020 2020 2020 2020 2022 7175  .            "qu
+0001b250: 6575 6564 223a 207b 7d2c 0a20 2020 2020  eued": {},.     
+0001b260: 2020 2020 2020 2022 6e6f 5f77 6f72 6b65         "no_worke
+0001b270: 7222 3a20 7b7d 2c0a 2020 2020 2020 2020  r": {},.        
+0001b280: 7d0a 0a20 2020 2020 2020 2066 6f72 2074  }..        for t
+0001b290: 7020 696e 2073 656c 662e 7363 6865 6475  p in self.schedu
+0001b2a0: 6c65 722e 7461 736b 5f70 7265 6669 7865  ler.task_prefixe
+0001b2b0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
+0001b2c0: 2020 2020 2020 2020 6163 7469 7665 5f73          active_s
+0001b2d0: 7461 7465 7320 3d20 7470 2e61 6374 6976  tates = tp.activ
+0001b2e0: 655f 7374 6174 6573 0a20 2020 2020 2020  e_states.       
+0001b2f0: 2020 2020 2069 6620 616e 7928 6163 7469       if any(acti
+0001b300: 7665 5f73 7461 7465 732e 6765 7428 7329  ve_states.get(s)
+0001b310: 2066 6f72 2073 2069 6e20 7374 6174 652e   for s in state.
+0001b320: 6b65 7973 2829 293a 0a20 2020 2020 2020  keys()):.       
+0001b330: 2020 2020 2020 2020 2073 7461 7465 5b22           state["
+0001b340: 6d65 6d6f 7279 225d 5b74 702e 6e61 6d65  memory"][tp.name
+0001b350: 5d20 3d20 6163 7469 7665 5f73 7461 7465  ] = active_state
+0001b360: 735b 226d 656d 6f72 7922 5d0a 2020 2020  s["memory"].    
+0001b370: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+0001b380: 655b 2265 7272 6564 225d 5b74 702e 6e61  e["erred"][tp.na
+0001b390: 6d65 5d20 3d20 6163 7469 7665 5f73 7461  me] = active_sta
+0001b3a0: 7465 735b 2265 7272 6564 225d 0a20 2020  tes["erred"].   
+0001b3b0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0001b3c0: 7465 5b22 7265 6c65 6173 6564 225d 5b74  te["released"][t
+0001b3d0: 702e 6e61 6d65 5d20 3d20 6163 7469 7665  p.name] = active
+0001b3e0: 5f73 7461 7465 735b 2272 656c 6561 7365  _states["release
+0001b3f0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+0001b400: 2020 2020 7374 6174 655b 2270 726f 6365      state["proce
+0001b410: 7373 696e 6722 5d5b 7470 2e6e 616d 655d  ssing"][tp.name]
+0001b420: 203d 2061 6374 6976 655f 7374 6174 6573   = active_states
+0001b430: 5b22 7072 6f63 6573 7369 6e67 225d 0a20  ["processing"]. 
+0001b440: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001b450: 7461 7465 5b22 7761 6974 696e 6722 5d5b  tate["waiting"][
+0001b460: 7470 2e6e 616d 655d 203d 2061 6374 6976  tp.name] = activ
+0001b470: 655f 7374 6174 6573 5b22 7761 6974 696e  e_states["waitin
+0001b480: 6722 5d0a 2020 2020 2020 2020 2020 2020  g"].            
+0001b490: 2020 2020 7374 6174 655b 2271 7565 7565      state["queue
+0001b4a0: 6422 5d5b 7470 2e6e 616d 655d 203d 2061  d"][tp.name] = a
+0001b4b0: 6374 6976 655f 7374 6174 6573 5b22 7175  ctive_states["qu
+0001b4c0: 6575 6564 225d 0a20 2020 2020 2020 2020  eued"].         
+0001b4d0: 2020 2020 2020 2073 7461 7465 5b22 6e6f         state["no
+0001b4e0: 5f77 6f72 6b65 7222 5d5b 7470 2e6e 616d  _worker"][tp.nam
+0001b4f0: 655d 203d 2061 6374 6976 655f 7374 6174  e] = active_stat
+0001b500: 6573 5b22 6e6f 2d77 6f72 6b65 7222 5d0a  es["no-worker"].
+0001b510: 0a20 2020 2020 2020 2073 7461 7465 5b22  .        state["
+0001b520: 616c 6c22 5d20 3d20 7b6b 3a20 7375 6d28  all"] = {k: sum(
+0001b530: 765b 6b5d 2066 6f72 2076 2069 6e20 7374  v[k] for v in st
+0001b540: 6174 652e 7661 6c75 6573 2829 2920 666f  ate.values()) fo
+0001b550: 7220 6b20 696e 2073 7461 7465 5b22 6d65  r k in state["me
+0001b560: 6d6f 7279 225d 7d0a 0a20 2020 2020 2020  mory"]}..       
+0001b570: 2069 6620 6e6f 7420 7374 6174 655b 2261   if not state["a
+0001b580: 6c6c 225d 2061 6e64 206e 6f74 206c 656e  ll"] and not len
+0001b590: 2873 656c 662e 736f 7572 6365 2e64 6174  (self.source.dat
+0001b5a0: 615b 2261 6c6c 225d 293a 0a20 2020 2020  a["all"]):.     
+0001b5b0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+0001b5c0: 2020 2020 2020 2064 203d 2070 726f 6772         d = progr
+0001b5d0: 6573 735f 7175 6164 7328 7374 6174 6529  ess_quads(state)
+0001b5e0: 0a0a 2020 2020 2020 2020 7570 6461 7465  ..        update
+0001b5f0: 2873 656c 662e 736f 7572 6365 2c20 6429  (self.source, d)
+0001b600: 0a0a 2020 2020 2020 2020 746f 7461 6c73  ..        totals
+0001b610: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001b620: 206b 3a20 7375 6d28 7374 6174 655b 6b5d   k: sum(state[k]
+0001b630: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+0001b640: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
+0001b650: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0001b660: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
+0001b670: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+0001b680: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001b690: 2020 2022 6572 7265 6422 2c0a 2020 2020     "erred",.    
+0001b6a0: 2020 2020 2020 2020 2020 2020 2272 656c              "rel
+0001b6b0: 6561 7365 6422 2c0a 2020 2020 2020 2020  eased",.        
+0001b6c0: 2020 2020 2020 2020 2277 6169 7469 6e67          "waiting
+0001b6d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001b6e0: 2020 2022 7175 6575 6564 222c 0a20 2020     "queued",.   
+0001b6f0: 2020 2020 2020 2020 2020 2020 2022 6e6f               "no
+0001b700: 5f77 6f72 6b65 7222 2c0a 2020 2020 2020  _worker",.      
+0001b710: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0001b720: 7d0a 2020 2020 2020 2020 746f 7461 6c73  }.        totals
+0001b730: 5b22 7072 6f63 6573 7369 6e67 225d 203d  ["processing"] =
+0001b740: 2074 6f74 616c 735b 2261 6c6c 225d 202d   totals["all"] -
+0001b750: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
+0001b760: 2020 7620 666f 7220 6b2c 2076 2069 6e20    v for k, v in 
+0001b770: 746f 7461 6c73 2e69 7465 6d73 2829 2069  totals.items() i
+0001b780: 6620 6b20 213d 2022 616c 6c22 0a20 2020  f k != "all".   
+0001b790: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001b7a0: 7365 6c66 2e72 6f6f 742e 7469 746c 652e  self.root.title.
+0001b7b0: 7465 7874 203d 2028 0a20 2020 2020 2020  text = (.       
+0001b7c0: 2020 2020 2022 5072 6f67 7265 7373 202d       "Progress -
+0001b7d0: 2d20 746f 7461 6c3a 2025 2861 6c6c 2973  - total: %(all)s
 0001b7e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-0001b7f0: 2271 7565 7565 643a 2025 2871 7565 7565  "queued: %(queue
-0001b800: 6429 732c 2022 0a20 2020 2020 2020 2020  d)s, ".         
-0001b810: 2020 2022 7072 6f63 6573 7369 6e67 3a20     "processing: 
-0001b820: 2528 7072 6f63 6573 7369 6e67 2973 2c20  %(processing)s, 
-0001b830: 220a 2020 2020 2020 2020 2020 2020 2269  ".            "i
-0001b840: 6e2d 6d65 6d6f 7279 3a20 2528 6d65 6d6f  n-memory: %(memo
-0001b850: 7279 2973 2c20 220a 2020 2020 2020 2020  ry)s, ".        
-0001b860: 2020 2020 226e 6f2d 776f 726b 6572 3a20      "no-worker: 
-0001b870: 2528 6e6f 5f77 6f72 6b65 7229 732c 2022  %(no_worker)s, "
-0001b880: 0a20 2020 2020 2020 2020 2020 2022 6572  .            "er
-0001b890: 7265 643a 2025 2865 7272 6564 2973 2220  red: %(erred)s" 
-0001b8a0: 2520 746f 7461 6c73 0a20 2020 2020 2020  % totals.       
-0001b8b0: 2029 0a0a 0a63 6c61 7373 2046 696e 6550   )...class FineP
-0001b8c0: 6572 666f 726d 616e 6365 4d65 7472 6963  erformanceMetric
-0001b8d0: 7328 4461 7368 626f 6172 6443 6f6d 706f  s(DashboardCompo
-0001b8e0: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
-0001b8f0: 2020 2054 6865 206d 6169 6e20 6f76 6572     The main over
-0001b900: 7669 6577 206f 6620 7468 6520 4669 6e65  view of the Fine
-0001b910: 2050 6572 666f 726d 616e 6365 204d 6574   Performance Met
-0001b920: 7269 6373 2070 6167 652e 0a20 2020 2022  rics page..    "
-0001b930: 2222 0a0a 2020 2020 406c 6f67 5f65 7272  ""..    @log_err
-0001b940: 6f72 730a 2020 2020 6465 6620 5f5f 696e  ors.    def __in
-0001b950: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
-0001b960: 756c 6572 2c20 2a2a 6b77 6172 6773 293a  uler, **kwargs):
-0001b970: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-0001b980: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
-0001b990: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
-0001b9a0: 2e73 656e 6464 6174 6120 3d20 6465 6661  .senddata = defa
-0001b9b0: 756c 7464 6963 7428 6c69 7374 290a 2020  ultdict(list).  
-0001b9c0: 2020 2020 2020 7365 6c66 2e73 656e 6473        self.sends
-0001b9d0: 7263 203d 2043 6f6c 756d 6e44 6174 6153  rc = ColumnDataS
-0001b9e0: 6f75 7263 6528 6461 7461 3d64 6963 7428  ource(data=dict(
-0001b9f0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0001ba00: 7461 736b 5f65 7865 635f 6461 7461 203d  task_exec_data =
-0001ba10: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
-0001ba20: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0001ba30: 7461 736b 5f65 7865 635f 6461 7461 5f6c  task_exec_data_l
-0001ba40: 696d 6974 6564 203d 2064 6566 6175 6c74  imited = default
-0001ba50: 6469 6374 286c 6973 7429 0a20 2020 2020  dict(list).     
-0001ba60: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
-0001ba70: 635f 6279 5f70 7265 6669 785f 7372 6320  c_by_prefix_src 
-0001ba80: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-0001ba90: 6365 2864 6174 613d 6469 6374 2829 290a  ce(data=dict()).
-0001baa0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001bab0: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
-0001bac0: 7479 5f73 7263 203d 2043 6f6c 756d 6e44  ty_src = ColumnD
-0001bad0: 6174 6153 6f75 7263 6528 6461 7461 3d64  ataSource(data=d
-0001bae0: 6963 7428 2929 0a20 2020 2020 2020 2073  ict()).        s
-0001baf0: 656c 662e 7375 6273 7461 6e74 6961 6c5f  elf.substantial_
-0001bb00: 6368 616e 6765 203d 2046 616c 7365 0a20  change = False. 
-0001bb10: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0001bb20: 5f61 6374 6976 6974 6965 7320 3d20 5b5d  _activities = []
-0001bb30: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-0001bb40: 6974 5f72 6f6f 7428 290a 0a20 2020 2064  it_root()..    d
-0001bb50: 6566 2069 6e69 745f 726f 6f74 2873 656c  ef init_root(sel
-0001bb60: 6629 3a0a 2020 2020 2020 2020 6465 6620  f):.        def 
-0001bb70: 6861 6e64 6c65 5f73 656c 6563 746f 725f  handle_selector_
-0001bb80: 6368 6e67 2861 7474 722c 206f 6c64 2c20  chng(attr, old, 
-0001bb90: 6e65 7729 3a0a 2020 2020 2020 2020 2020  new):.          
-0001bba0: 2020 7365 6c66 2e75 6e69 745f 7365 6c65    self.unit_sele
-0001bbb0: 6374 6564 203d 206e 6577 0a20 2020 2020  cted = new.     
-0001bbc0: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
-0001bbd0: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
-0001bbe0: 2054 7275 650a 0a20 2020 2020 2020 2073   True..        s
-0001bbf0: 656c 662e 6675 6e63 7469 6f6e 5f73 656c  elf.function_sel
-0001bc00: 6563 746f 7220 3d20 4d75 6c74 6943 686f  ector = MultiCho
-0001bc10: 6963 6528 7661 6c75 653d 5b5d 2c20 6f70  ice(value=[], op
-0001bc20: 7469 6f6e 733d 5b5d 290a 2020 2020 2020  tions=[]).      
-0001bc30: 2020 7365 6c66 2e66 756e 6374 696f 6e5f    self.function_
-0001bc40: 7365 6c65 6374 6f72 2e70 6c61 6365 686f  selector.placeho
-0001bc50: 6c64 6572 203d 2022 5365 6c65 6374 2073  lder = "Select s
-0001bc60: 7065 6369 6669 6320 6675 6e63 7469 6f6e  pecific function
-0001bc70: 7322 0a20 2020 2020 2020 2073 656c 662e  s".        self.
-0001bc80: 756e 6974 5f73 656c 6563 746f 7220 3d20  unit_selector = 
-0001bc90: 5365 6c65 6374 2874 6974 6c65 3d22 556e  Select(title="Un
-0001bca0: 6974 2073 656c 6563 7469 6f6e 222c 206f  it selection", o
-0001bcb0: 7074 696f 6e73 3d5b 5d29 0a20 2020 2020  ptions=[]).     
-0001bcc0: 2020 2073 656c 662e 756e 6974 5f73 656c     self.unit_sel
-0001bcd0: 6563 746f 722e 6f6e 5f63 6861 6e67 6528  ector.on_change(
-0001bce0: 2276 616c 7565 222c 2068 616e 646c 655f  "value", handle_
-0001bcf0: 7365 6c65 6374 6f72 5f63 686e 6729 0a20  selector_chng). 
-0001bd00: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001bd10: 5f73 656c 6563 7465 6420 3d20 2273 6563  _selected = "sec
-0001bd20: 6f6e 6473 220a 2020 2020 2020 2020 7365  onds".        se
-0001bd30: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
-0001bd40: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
-0001bd50: 2066 6967 7572 6528 290a 2020 2020 2020   figure().      
-0001bd60: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001bd70: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
-0001bd80: 203d 2066 6967 7572 6528 290a 2020 2020   = figure().    
-0001bd90: 2020 2020 7365 6c66 2e73 656e 6464 6174      self.senddat
-0001bda0: 615f 6279 5f61 6374 6976 6974 795f 6368  a_by_activity_ch
-0001bdb0: 6172 7420 3d20 6669 6775 7265 2829 0a20  art = figure(). 
-0001bdc0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001bdd0: 203d 2063 6f6c 756d 6e28 0a20 2020 2020   = column(.     
-0001bde0: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
-0001bdf0: 7469 6f6e 5f73 656c 6563 746f 722c 0a20  tion_selector,. 
-0001be00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001be10: 756e 6974 5f73 656c 6563 746f 722c 0a20  unit_selector,. 
-0001be20: 2020 2020 2020 2020 2020 2072 6f77 280a             row(.
-0001be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be40: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0001be50: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-0001be60: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
-0001be70: 6861 7274 2c0a 2020 2020 2020 2020 2020  hart,.          
-0001be80: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-0001be90: 6173 6b5f 6578 6563 5f62 795f 6163 7469  ask_exec_by_acti
-0001bea0: 7669 7479 5f63 6861 7274 2c0a 2020 2020  vity_chart,.    
-0001beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bec0: 7365 6c66 2e73 656e 6464 6174 615f 6279  self.senddata_by
-0001bed0: 5f61 6374 6976 6974 795f 6368 6172 742c  _activity_chart,
-0001bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bef0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0001bf00: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
-0001bf10: 2273 7472 6574 6368 5f77 6964 7468 222c  "stretch_width",
-0001bf20: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-0001bf30: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
-0001bf40: 6e67 5f6d 6f64 653d 2273 6361 6c65 5f77  ng_mode="scale_w
-0001bf50: 6964 7468 222c 0a20 2020 2020 2020 2029  idth",.        )
-0001bf60: 0a0a 2020 2020 6465 6620 666f 726d 6174  ..    def format
-0001bf70: 2873 656c 662c 2075 6e69 743a 2073 7472  (self, unit: str
-0001bf80: 2c20 7661 6c3a 2041 6e79 2920 2d3e 2073  , val: Any) -> s
-0001bf90: 7472 3a0a 2020 2020 2020 2020 666f 726d  tr:.        form
-0001bfa0: 6174 7465 7273 203d 207b 2262 7974 6573  atters = {"bytes
-0001bfb0: 223a 2066 6f72 6d61 745f 6279 7465 732c  ": format_bytes,
-0001bfc0: 2022 7365 636f 6e64 7322 3a20 666f 726d   "seconds": form
-0001bfd0: 6174 5f74 696d 657d 0a20 2020 2020 2020  at_time}.       
-0001bfe0: 2072 6574 7572 6e20 666f 726d 6174 7465   return formatte
-0001bff0: 7273 2e67 6574 2875 6e69 742c 2073 7472  rs.get(unit, str
-0001c000: 2928 7661 6c29 0a0a 2020 2020 4077 6974  )(val)..    @wit
-0001c010: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-0001c020: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-0001c030: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0001c040: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-0001c050: 2020 2020 2020 2069 7465 6d73 203d 2073         items = s
-0001c060: 6f72 7465 6428 0a20 2020 2020 2020 2020  orted(.         
-0001c070: 2020 2028 6b2c 2076 290a 2020 2020 2020     (k, v).      
-0001c080: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-0001c090: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-0001c0a0: 2e63 756d 756c 6174 6976 655f 776f 726b  .cumulative_work
-0001c0b0: 6572 5f6d 6574 7269 6373 2e69 7465 6d73  er_metrics.items
-0001c0c0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0001c0d0: 6620 6973 696e 7374 616e 6365 286b 2c20  f isinstance(k, 
-0001c0e0: 7475 706c 6529 0a20 2020 2020 2020 2029  tuple).        )
-0001c0f0: 0a20 2020 2020 2020 2066 6f72 2028 636f  .        for (co
-0001c100: 6e74 6578 742c 202a 7061 7274 7329 2c20  ntext, *parts), 
-0001c110: 7661 6c20 696e 2069 7465 6d73 3a0a 2020  val in items:.  
-0001c120: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
-0001c130: 7465 7874 203d 3d20 2267 6574 2d64 6174  text == "get-dat
-0001c140: 6122 3a0a 2020 2020 2020 2020 2020 2020  a":.            
-0001c150: 2020 2020 6163 7469 7669 7479 2c20 756e      activity, un
-0001c160: 6974 203d 2070 6172 7473 0a0a 2020 2020  it = parts..    
-0001c170: 2020 2020 2020 2020 2020 2020 6966 2075              if u
-0001c180: 6e69 7420 6e6f 7420 696e 2073 656c 662e  nit not in self.
-0001c190: 756e 6974 5f73 656c 6563 746f 722e 6f70  unit_selector.op
-0001c1a0: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-0001c1b0: 2020 2020 2020 2020 2020 2023 206e 6f74             # not
-0001c1c0: 6520 6170 7065 6e64 2064 6f65 736e 2774  e append doesn't
-0001c1d0: 2077 6f72 6b20 6865 7265 0a20 2020 2020   work here.     
-0001c1e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c1f0: 656c 662e 756e 6974 5f73 656c 6563 746f  elf.unit_selecto
-0001c200: 722e 6f70 7469 6f6e 7320 2b3d 205b 756e  r.options += [un
-0001c210: 6974 5d0a 0a20 2020 2020 2020 2020 2020  it]..           
-0001c220: 2020 2020 2069 6620 6163 7469 7669 7479       if activity
-0001c230: 206e 6f74 2069 6e20 7365 6c66 2e73 656e   not in self.sen
-0001c240: 6464 6174 615b 2261 6374 6976 6974 7922  ddata["activity"
-0001c250: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0001c260: 2020 2020 2020 2073 656c 662e 7375 6273         self.subs
-0001c270: 7461 6e74 6961 6c5f 6368 616e 6765 203d  tantial_change =
-0001c280: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0001c290: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0001c2a0: 656e 6464 6174 615b 2261 6374 6976 6974  enddata["activit
-0001c2b0: 7922 5d2e 6170 7065 6e64 2861 6374 6976  y"].append(activ
-0001c2c0: 6974 7929 0a0a 2020 2020 2020 2020 2020  ity)..          
-0001c2d0: 2020 2020 2020 6964 7820 3d20 7365 6c66        idx = self
-0001c2e0: 2e73 656e 6464 6174 615b 2261 6374 6976  .senddata["activ
-0001c2f0: 6974 7922 5d2e 696e 6465 7828 6163 7469  ity"].index(acti
-0001c300: 7669 7479 290a 2020 2020 2020 2020 2020  vity).          
-0001c310: 2020 2020 2020 7768 696c 6520 6964 7820        while idx 
-0001c320: 3e3d 206c 656e 2873 656c 662e 7365 6e64  >= len(self.send
-0001c330: 6461 7461 5b66 227b 6163 7469 7669 7479  data[f"{activity
-0001c340: 7d5f 7b75 6e69 747d 225d 293a 0a20 2020  }_{unit}"]):.   
-0001c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c360: 2073 656c 662e 7365 6e64 6461 7461 5b66   self.senddata[f
-0001c370: 227b 6163 7469 7669 7479 7d5f 7b75 6e69  "{activity}_{uni
-0001c380: 747d 225d 2e61 7070 656e 6428 3029 0a20  t}"].append(0). 
-0001c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3a0: 2020 2073 656c 662e 7365 6e64 6461 7461     self.senddata
-0001c3b0: 5b66 227b 6163 7469 7669 7479 7d5f 7b75  [f"{activity}_{u
-0001c3c0: 6e69 747d 5f74 6578 7422 5d2e 6170 7065  nit}_text"].appe
-0001c3d0: 6e64 2822 2229 0a20 2020 2020 2020 2020  nd("").         
-0001c3e0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-0001c3f0: 6461 7461 5b66 227b 6163 7469 7669 7479  data[f"{activity
-0001c400: 7d5f 7b75 6e69 747d 5f74 6578 7422 5d5b  }_{unit}_text"][
-0001c410: 6964 785d 203d 2073 656c 662e 666f 726d  idx] = self.form
-0001c420: 6174 2875 6e69 742c 2076 616c 290a 2020  at(unit, val).  
-0001c430: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001c440: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
-0001c450: 6374 6976 6974 797d 5f7b 756e 6974 7d22  ctivity}_{unit}"
-0001c460: 5d5b 6964 785d 203d 2076 616c 0a0a 2020  ][idx] = val..  
-0001c470: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
-0001c480: 6f6e 7465 7874 203d 3d20 2265 7865 6375  ontext == "execu
-0001c490: 7465 223a 0a20 2020 2020 2020 2020 2020  te":.           
-0001c4a0: 2020 2020 2070 7265 6669 782c 2061 6374       prefix, act
-0001c4b0: 6976 6974 792c 2075 6e69 7420 3d20 7061  ivity, unit = pa
-0001c4c0: 7274 730a 0a20 2020 2020 2020 2020 2020  rts..           
-0001c4d0: 2020 2020 2069 6620 756e 6974 206e 6f74       if unit not
-0001c4e0: 2069 6e20 7365 6c66 2e75 6e69 745f 7365   in self.unit_se
-0001c4f0: 6c65 6374 6f72 2e6f 7074 696f 6e73 3a0a  lector.options:.
-0001c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c510: 2020 2020 2320 6e6f 7465 2061 7070 656e      # note appen
-0001c520: 6420 646f 6573 6e27 7420 776f 726b 2068  d doesn't work h
-0001c530: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
-0001c540: 2020 2020 2020 2020 7365 6c66 2e75 6e69          self.uni
-0001c550: 745f 7365 6c65 6374 6f72 2e6f 7074 696f  t_selector.optio
-0001c560: 6e73 202b 3d20 5b75 6e69 745d 0a0a 2020  ns += [unit]..  
-0001c570: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001c580: 2061 6374 6976 6974 7920 6e6f 7420 696e   activity not in
-0001c590: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
-0001c5a0: 6974 6965 733a 0a20 2020 2020 2020 2020  ities:.         
-0001c5b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001c5c0: 7375 6273 7461 6e74 6961 6c5f 6368 616e  substantial_chan
-0001c5d0: 6765 203d 2054 7275 650a 2020 2020 2020  ge = True.      
-0001c5e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001c5f0: 6c66 2e74 6173 6b5f 6163 7469 7669 7469  lf.task_activiti
-0001c600: 6573 2e61 7070 656e 6428 6163 7469 7669  es.append(activi
-0001c610: 7479 290a 0a20 2020 2020 2020 2020 2020  ty)..           
-0001c620: 2020 2020 2069 6620 7072 6566 6978 206e       if prefix n
-0001c630: 6f74 2069 6e20 7365 6c66 2e74 6173 6b5f  ot in self.task_
-0001c640: 6578 6563 5f64 6174 615b 2266 756e 6374  exec_data["funct
-0001c650: 696f 6e73 225d 3a0a 2020 2020 2020 2020  ions"]:.        
-0001c660: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c670: 2e73 7562 7374 616e 7469 616c 5f63 6861  .substantial_cha
-0001c680: 6e67 6520 3d20 5472 7565 0a20 2020 2020  nge = True.     
-0001c690: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c6a0: 656c 662e 6675 6e63 7469 6f6e 5f73 656c  elf.function_sel
-0001c6b0: 6563 746f 722e 6f70 7469 6f6e 732e 6170  ector.options.ap
-0001c6c0: 7065 6e64 2870 7265 6669 7829 0a20 2020  pend(prefix).   
-0001c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6e0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
-0001c6f0: 6461 7461 5b22 6675 6e63 7469 6f6e 7322  data["functions"
-0001c700: 5d2e 6170 7065 6e64 2870 7265 6669 7829  ].append(prefix)
-0001c710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c720: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
-0001c730: 7865 635f 6461 7461 5b22 7469 6d65 7374  xec_data["timest
-0001c740: 616d 7022 5d2e 6170 7065 6e64 2864 6174  amp"].append(dat
-0001c750: 6574 696d 652e 7574 636e 6f77 2829 290a  etime.utcnow()).
-0001c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c770: 6964 7820 3d20 7365 6c66 2e74 6173 6b5f  idx = self.task_
-0001c780: 6578 6563 5f64 6174 615b 2266 756e 6374  exec_data["funct
-0001c790: 696f 6e73 225d 2e69 6e64 6578 2870 7265  ions"].index(pre
-0001c7a0: 6669 7829 0a0a 2020 2020 2020 2020 2020  fix)..          
-0001c7b0: 2020 2020 2020 2320 536f 6d65 2066 756e        # Some fun
-0001c7c0: 6374 696f 6e2f 6163 7469 7669 7479 2063  ction/activity c
-0001c7d0: 6f6d 626f 7320 6d69 7373 696e 672c 2073  ombos missing, s
-0001c7e0: 6f20 6e65 6564 2074 6f20 6b65 6570 2063  o need to keep c
-0001c7f0: 6f6c 756d 6e73 2061 6c69 676e 6564 0a20  olumns aligned. 
-0001c800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001c810: 6f72 206f 7020 696e 2073 656c 662e 7461  or op in self.ta
-0001c820: 736b 5f61 6374 6976 6974 6965 733a 0a20  sk_activities:. 
-0001c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c840: 2020 2077 6869 6c65 206c 656e 2873 656c     while len(sel
-0001c850: 662e 7461 736b 5f65 7865 635f 6461 7461  f.task_exec_data
-0001c860: 5b66 227b 6f70 7d5f 7b75 6e69 747d 225d  [f"{op}_{unit}"]
-0001c870: 2920 213d 206c 656e 280a 2020 2020 2020  ) != len(.      
-0001c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c890: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001c8a0: 5f64 6174 615b 2266 756e 6374 696f 6e73  _data["functions
-0001c8b0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-0001c8c0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8e0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001c8f0: 5f64 6174 615b 6622 7b6f 707d 5f7b 756e  _data[f"{op}_{un
-0001c900: 6974 7d22 5d2e 6170 7065 6e64 2830 290a  it}"].append(0).
-0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c920: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001c930: 6b5f 6578 6563 5f64 6174 615b 6622 7b6f  k_exec_data[f"{o
-0001c940: 707d 5f7b 756e 6974 7d5f 7465 7874 225d  p}_{unit}_text"]
-0001c950: 2e61 7070 656e 6428 2222 290a 0a20 2020  .append("")..   
-0001c960: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001c970: 662e 7461 736b 5f65 7865 635f 6461 7461  f.task_exec_data
-0001c980: 5b66 227b 6163 7469 7669 7479 7d5f 7b75  [f"{activity}_{u
-0001c990: 6e69 747d 225d 5b69 6478 5d20 3d20 7661  nit}"][idx] = va
-0001c9a0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-0001c9b0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
-0001c9c0: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
-0001c9d0: 797d 5f7b 756e 6974 7d5f 7465 7874 225d  y}_{unit}_text"]
-0001c9e0: 5b69 6478 5d20 3d20 7365 6c66 2e66 6f72  [idx] = self.for
-0001c9f0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-0001ca00: 2020 2020 2020 2020 2075 6e69 742c 2076           unit, v
-0001ca10: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
-0001ca20: 2020 2029 0a0a 2020 2020 2020 2020 6461     )..        da
-0001ca30: 7461 203d 2073 656c 662e 7461 736b 5f65  ta = self.task_e
-0001ca40: 7865 635f 6461 7461 2e63 6f70 7928 290a  xec_data.copy().
-0001ca50: 2020 2020 2020 2020 2320 4966 2075 7365          # If use
-0001ca60: 7220 6861 7320 6d61 6e75 616c 6c79 2073  r has manually s
-0001ca70: 656c 6563 7465 6420 6675 6e63 7469 6f6e  elected function
-0001ca80: 2873 2920 7468 656e 2077 6520 6172 6520  (s) then we are 
-0001ca90: 6f6e 6c79 2073 686f 7769 6e67 2074 6865  only showing the
-0001caa0: 6d2e 0a20 2020 2020 2020 2069 6620 7365  m..        if se
-0001cab0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
-0001cac0: 6374 6f72 2e76 616c 7565 3a0a 2020 2020  ctor.value:.    
-0001cad0: 2020 2020 2020 2020 696e 6465 7865 7320          indexes 
-0001cae0: 3d20 5b64 6174 615b 2266 756e 6374 696f  = [data["functio
-0001caf0: 6e73 225d 2e69 6e64 6578 2866 2920 666f  ns"].index(f) fo
-0001cb00: 7220 6620 696e 2073 656c 662e 6675 6e63  r f in self.func
-0001cb10: 7469 6f6e 5f73 656c 6563 746f 722e 7661  tion_selector.va
-0001cb20: 6c75 655d 0a20 2020 2020 2020 2020 2020  lue].           
-0001cb30: 2066 6f72 206b 6579 2c20 7661 6c75 6573   for key, values
-0001cb40: 2069 6e20 6461 7461 2e69 7465 6d73 2829   in data.items()
-0001cb50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cb60: 2020 6461 7461 5b6b 6579 5d20 3d20 5b76    data[key] = [v
-0001cb70: 616c 7565 735b 6964 785d 2066 6f72 2069  alues[idx] for i
-0001cb80: 6478 2069 6e20 696e 6465 7865 735d 0a0a  dx in indexes]..
-0001cb90: 2020 2020 2020 2020 2320 4f74 6865 7277          # Otherw
-0001cba0: 6973 6520 6c69 6d69 7420 7468 6f73 6520  ise limit those 
-0001cbb0: 6265 696e 6720 7368 6f77 6e20 7768 6963  being shown whic
-0001cbc0: 6820 6861 7665 2027 6578 7069 7265 6427  h have 'expired'
-0001cbd0: 2074 6f20 6265 2064 6973 706c 6179 6564   to be displayed
-0001cbe0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001cbf0: 2020 2020 2020 2020 2020 2063 7574 6f66             cutof
-0001cc00: 6620 3d20 6461 7465 7469 6d65 2e75 7463  f = datetime.utc
-0001cc10: 6e6f 7728 2920 2d20 7469 6d65 6465 6c74  now() - timedelt
-0001cc20: 6128 7365 636f 6e64 733d 3130 290a 2020  a(seconds=10).  
-0001cc30: 2020 2020 2020 2020 2020 6e5f 7368 6f77            n_show
-0001cc40: 203d 206c 656e 285b 6420 666f 7220 6420   = len([d for d 
-0001cc50: 696e 2064 6174 615b 2274 696d 6573 7461  in data["timesta
-0001cc60: 6d70 225d 2069 6620 6420 3e20 6375 746f  mp"] if d > cuto
-0001cc70: 6666 5d29 206f 7220 350a 2020 2020 2020  ff]) or 5.      
-0001cc80: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-0001cc90: 2064 6174 613a 0a20 2020 2020 2020 2020   data:.         
-0001cca0: 2020 2020 2020 2064 6174 615b 6b65 795d         data[key]
-0001ccb0: 203d 2064 6174 615b 6b65 795d 5b2d 6e5f   = data[key][-n_
-0001ccc0: 7368 6f77 3a5d 0a20 2020 2020 2020 2073  show:].        s
-0001ccd0: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
-0001cce0: 7461 5f6c 696d 6974 6564 203d 2064 6174  ta_limited = dat
-0001ccf0: 612e 636f 7079 2829 0a0a 2020 2020 2020  a.copy()..      
-0001cd00: 2020 2320 5368 6f77 2074 6f74 616c 206e    # Show total n
-0001cd10: 756d 6265 7220 6f66 2066 756e 6374 696f  umber of functio
-0001cd20: 6e73 2074 6f20 6368 6f6f 7365 2066 726f  ns to choose fro
-0001cd30: 6d0a 2020 2020 2020 2020 7365 6c66 2e66  m.        self.f
-0001cd40: 756e 6374 696f 6e5f 7365 6c65 6374 6f72  unction_selector
-0001cd50: 2e74 6974 6c65 203d 2028 0a20 2020 2020  .title = (.     
-0001cd60: 2020 2020 2020 2066 2246 696c 7465 7220         f"Filter 
-0001cd70: 6279 2066 756e 6374 696f 6e20 287b 6c65  by function ({le
-0001cd80: 6e28 7365 6c66 2e66 756e 6374 696f 6e5f  n(self.function_
-0001cd90: 7365 6c65 6374 6f72 2e6f 7074 696f 6e73  selector.options
-0001cda0: 297d 293a 220a 2020 2020 2020 2020 290a  )}):".        ).
-0001cdb0: 0a20 2020 2020 2020 2074 6173 6b5f 6578  .        task_ex
-0001cdc0: 6563 5f70 6965 6368 6172 7420 3d20 7365  ec_piechart = se
-0001cdd0: 6c66 2e5f 6275 696c 645f 7461 736b 5f65  lf._build_task_e
-0001cde0: 7865 6375 7469 6f6e 5f62 795f 6163 7469  xecution_by_acti
-0001cdf0: 7669 7479 5f63 6861 7274 280a 2020 2020  vity_chart(.    
-0001ce00: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001ce10: 6b5f 6578 6563 5f64 6174 615f 6c69 6d69  k_exec_data_limi
-0001ce20: 7465 642e 636f 7079 2829 0a20 2020 2020  ted.copy().     
-0001ce30: 2020 2029 0a20 2020 2020 2020 2074 6173     ).        tas
-0001ce40: 6b5f 6578 6563 5f62 6172 6368 6172 7420  k_exec_barchart 
-0001ce50: 3d20 7365 6c66 2e5f 6275 696c 645f 7461  = self._build_ta
-0001ce60: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
-0001ce70: 7072 6566 6978 5f63 6861 7274 280a 2020  prefix_chart(.  
-0001ce80: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-0001ce90: 6173 6b5f 6578 6563 5f64 6174 615f 6c69  ask_exec_data_li
-0001cea0: 6d69 7465 642e 636f 7079 2829 0a20 2020  mited.copy().   
-0001ceb0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0001cec0: 656e 6464 6174 615f 7069 6563 6861 7274  enddata_piechart
-0001ced0: 203d 2073 656c 662e 5f62 7569 6c64 5f73   = self._build_s
-0001cee0: 656e 6464 6174 615f 6368 6172 7428 7365  enddata_chart(se
-0001cef0: 6c66 2e73 656e 6464 6174 612e 636f 7079  lf.senddata.copy
-0001cf00: 2829 290a 0a20 2020 2020 2020 2023 2052  ())..        # R
-0001cf10: 6570 6c61 6369 6e67 2074 6865 2063 6869  eplacing the chi
-0001cf20: 6c64 2063 6175 7365 7320 736d 616c 6c20  ld causes small 
-0001cf30: 626c 6970 7320 6966 2064 6f6e 6520 6576  blips if done ev
-0001cf40: 6572 7920 6974 6572 6174 696f 6e20 7673  ery iteration vs
-0001cf50: 2075 7064 6174 696e 670a 2020 2020 2020   updating.      
-0001cf60: 2020 2320 7265 6e64 6572 6572 732c 2062    # renderers, b
-0001cf70: 7574 2069 7427 7320 6e65 6564 6564 2077  ut it's needed w
-0001cf80: 6865 6e20 6e65 7720 6675 6e63 7469 6f6e  hen new function
-0001cf90: 7320 616e 642f 6f72 2061 6374 6976 6974  s and/or activit
-0001cfa0: 6965 7320 7368 6f77 2075 7020 746f 0a20  ies show up to. 
-0001cfb0: 2020 2020 2020 2023 2072 6572 656e 6465         # rerende
-0001cfc0: 7220 706c 6f74 0a20 2020 2020 2020 2069  r plot.        i
-0001cfd0: 6620 7365 6c66 2e73 7562 7374 616e 7469  f self.substanti
-0001cfe0: 616c 5f63 6861 6e67 653a 0a20 2020 2020  al_change:.     
-0001cff0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001d000: 2e63 6869 6c64 7265 6e5b 2d31 5d2e 6368  .children[-1].ch
-0001d010: 696c 6472 656e 5b30 5d20 3d20 7461 736b  ildren[0] = task
-0001d020: 5f65 7865 635f 6261 7263 6861 7274 0a20  _exec_barchart. 
-0001d030: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001d040: 726f 6f74 2e63 6869 6c64 7265 6e5b 2d31  root.children[-1
-0001d050: 5d2e 6368 696c 6472 656e 5b31 5d20 3d20  ].children[1] = 
-0001d060: 7461 736b 5f65 7865 635f 7069 6563 6861  task_exec_piecha
-0001d070: 7274 0a20 2020 2020 2020 2020 2020 2073  rt.            s
-0001d080: 656c 662e 726f 6f74 2e63 6869 6c64 7265  elf.root.childre
-0001d090: 6e5b 2d31 5d2e 6368 696c 6472 656e 5b32  n[-1].children[2
-0001d0a0: 5d20 3d20 7365 6e64 6461 7461 5f70 6965  ] = senddata_pie
-0001d0b0: 6368 6172 740a 2020 2020 2020 2020 2020  chart.          
-0001d0c0: 2020 7365 6c66 2e73 7562 7374 616e 7469    self.substanti
-0001d0d0: 616c 5f63 6861 6e67 6520 3d20 4661 6c73  al_change = Fals
-0001d0e0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-0001d0f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001d100: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
-0001d110: 6566 6978 5f63 6861 7274 2e72 656e 6465  efix_chart.rende
-0001d120: 7265 7273 203d 2074 6173 6b5f 6578 6563  rers = task_exec
-0001d130: 5f70 6965 6368 6172 742e 7265 6e64 6572  _piechart.render
-0001d140: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-0001d150: 7365 6c66 2e74 6173 6b5f 6578 6563 5f62  self.task_exec_b
-0001d160: 795f 6163 7469 7669 7479 5f63 6861 7274  y_activity_chart
-0001d170: 2e72 656e 6465 7265 7273 203d 2074 6173  .renderers = tas
-0001d180: 6b5f 6578 6563 5f62 6172 6368 6172 742e  k_exec_barchart.
-0001d190: 7265 6e64 6572 6572 730a 2020 2020 2020  renderers.      
-0001d1a0: 2020 2020 2020 7365 6c66 2e73 656e 6464        self.sendd
-0001d1b0: 6174 615f 6279 5f61 6374 6976 6974 795f  ata_by_activity_
-0001d1c0: 6368 6172 742e 7265 6e64 6572 6572 7320  chart.renderers 
-0001d1d0: 3d20 7365 6e64 6461 7461 5f70 6965 6368  = senddata_piech
-0001d1e0: 6172 742e 7265 6e64 6572 6572 730a 0a20  art.renderers.. 
-0001d1f0: 2020 2064 6566 205f 6275 696c 645f 7461     def _build_ta
-0001d200: 736b 5f65 7865 6375 7469 6f6e 5f62 795f  sk_execution_by_
-0001d210: 6163 7469 7669 7479 5f63 6861 7274 280a  activity_chart(.
-0001d220: 2020 2020 2020 2020 7365 6c66 2c20 7461          self, ta
-0001d230: 736b 5f65 7865 635f 6461 7461 3a20 6465  sk_exec_data: de
-0001d240: 6661 756c 7464 6963 745b 7374 722c 206c  faultdict[str, l
-0001d250: 6973 745d 0a20 2020 2029 202d 3e20 6669  ist].    ) -> fi
-0001d260: 6775 7265 3a0a 2020 2020 2020 2020 7069  gure:.        pi
-0001d270: 6563 6861 7274 5f64 6174 6120 3d20 7b7d  echart_data = {}
-0001d280: 0a20 2020 2020 2020 2070 6965 6368 6172  .        piechar
-0001d290: 745f 6461 7461 5b22 7661 6c75 6522 5d20  t_data["value"] 
-0001d2a0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0001d2b0: 7375 6d28 7461 736b 5f65 7865 635f 6461  sum(task_exec_da
-0001d2c0: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
-0001d2d0: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
-0001d2e0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0001d2f0: 7220 6f70 2069 6e20 7365 6c66 2e74 6173  r op in self.tas
-0001d300: 6b5f 6163 7469 7669 7469 6573 0a20 2020  k_activities.   
-0001d310: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
-0001d320: 6965 6368 6172 745f 6461 7461 5b22 7465  iechart_data["te
-0001d330: 7874 225d 203d 205b 0a20 2020 2020 2020  xt"] = [.       
-0001d340: 2020 2020 2073 656c 662e 666f 726d 6174       self.format
-0001d350: 2873 656c 662e 756e 6974 5f73 656c 6563  (self.unit_selec
-0001d360: 7465 642c 2076 2920 666f 7220 7620 696e  ted, v) for v in
-0001d370: 2070 6965 6368 6172 745f 6461 7461 5b22   piechart_data["
-0001d380: 7661 6c75 6522 5d0a 2020 2020 2020 2020  value"].        
-0001d390: 5d0a 2020 2020 2020 2020 7069 6563 6861  ].        piecha
-0001d3a0: 7274 5f64 6174 615b 2261 6e67 6c65 225d  rt_data["angle"]
-0001d3b0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001d3c0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0001d3d0: 2020 2073 756d 2874 6173 6b5f 6578 6563     sum(task_exec
-0001d3e0: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
-0001d3f0: 797d 5f7b 7365 6c66 2e75 6e69 745f 7365  y}_{self.unit_se
-0001d400: 6c65 6374 6564 7d22 5d29 0a20 2020 2020  lected}"]).     
-0001d410: 2020 2020 2020 2020 2020 202f 2073 756d             / sum
-0001d420: 2870 6965 6368 6172 745f 6461 7461 5b22  (piechart_data["
-0001d430: 7661 6c75 6522 5d29 0a20 2020 2020 2020  value"]).       
-0001d440: 2020 2020 2020 2020 2069 6620 7375 6d28           if sum(
-0001d450: 7069 6563 6861 7274 5f64 6174 615b 2276  piechart_data["v
-0001d460: 616c 7565 225d 290a 2020 2020 2020 2020  alue"]).        
-0001d470: 2020 2020 2020 2020 656c 7365 2030 2020          else 0  
-0001d480: 2320 6d61 7920 6e6f 7420 6861 7665 2061  # may not have a
-0001d490: 6e79 2062 7974 6573 206d 6f76 656d 656e  ny bytes movemen
-0001d4a0: 7420 7265 706f 7274 6564 2c20 6176 6f69  t reported, avoi
-0001d4b0: 6420 6469 7669 6465 2062 7920 7a65 726f  d divide by zero
-0001d4c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001d4d0: 2020 2020 2020 2020 2020 202a 2032 0a20             * 2. 
-0001d4e0: 2020 2020 2020 2020 2020 202a 206d 6174             * mat
-0001d4f0: 682e 7069 0a20 2020 2020 2020 2020 2020  h.pi.           
-0001d500: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
-0001d510: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
-0001d520: 6974 6965 730a 2020 2020 2020 2020 5d0a  ities.        ].
-0001d530: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
-0001d540: 5f64 6174 615b 2263 6f6c 6f72 225d 203d  _data["color"] =
-0001d550: 2073 6d61 6c6c 5f70 616c 6574 7465 735b   small_palettes[
-0001d560: 2259 6c47 6e42 7522 5d2e 6765 7428 0a20  "YlGnBu"].get(. 
-0001d570: 2020 2020 2020 2020 2020 206c 656e 2873             len(s
-0001d580: 656c 662e 7461 736b 5f61 6374 6976 6974  elf.task_activit
-0001d590: 6965 7329 2c20 5b5d 0a20 2020 2020 2020  ies), [].       
-0001d5a0: 2029 0a20 2020 2020 2020 2070 6965 6368   ).        piech
-0001d5b0: 6172 745f 6461 7461 5b22 6163 7469 7669  art_data["activi
-0001d5c0: 7479 225d 203d 2073 656c 662e 7461 736b  ty"] = self.task
-0001d5d0: 5f61 6374 6976 6974 6965 730a 2020 2020  _activities.    
-0001d5e0: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
-0001d5f0: 6563 5f62 795f 6163 7469 7669 7479 5f73  ec_by_activity_s
-0001d600: 7263 2e64 6174 6120 3d20 7069 6563 6861  rc.data = piecha
-0001d610: 7274 5f64 6174 610a 0a20 2020 2020 2020  rt_data..       
-0001d620: 2070 6965 6368 6172 7420 3d20 6669 6775   piechart = figu
-0001d630: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-0001d640: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
-0001d650: 2020 2020 2020 2020 7369 7a69 6e67 5f6d          sizing_m
-0001d660: 6f64 653d 2273 6361 6c65 5f62 6f74 6822  ode="scale_both"
-0001d670: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-0001d680: 746c 653d 2254 6173 6b20 6578 6563 7574  tle="Task execut
-0001d690: 696f 6e2c 2062 7920 6163 7469 7669 7479  ion, by activity
-0001d6a0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0001d6b0: 6f6f 6c73 3d22 686f 7665 7222 2c0a 2020  ools="hover",.  
-0001d6c0: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
-0001d6d0: 7073 3d22 407b 6163 7469 7669 7479 7d3a  ps="@{activity}:
-0001d6e0: 2040 7465 7874 222c 0a20 2020 2020 2020   @text",.       
-0001d6f0: 2020 2020 2078 5f72 616e 6765 3d28 2d30       x_range=(-0
-0001d700: 2e35 2c20 312e 3029 2c0a 2020 2020 2020  .5, 1.0),.      
-0001d710: 2020 290a 2020 2020 2020 2020 7069 6563    ).        piec
-0001d720: 6861 7274 2e61 7869 732e 6178 6973 5f6c  hart.axis.axis_l
-0001d730: 6162 656c 203d 204e 6f6e 650a 2020 2020  abel = None.    
-0001d740: 2020 2020 7069 6563 6861 7274 2e61 7869      piechart.axi
-0001d750: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
-0001d760: 650a 2020 2020 2020 2020 7069 6563 6861  e.        piecha
-0001d770: 7274 2e67 7269 642e 6772 6964 5f6c 696e  rt.grid.grid_lin
-0001d780: 655f 636f 6c6f 7220 3d20 4e6f 6e65 0a0a  e_color = None..
-0001d790: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
-0001d7a0: 2e77 6564 6765 280a 2020 2020 2020 2020  .wedge(.        
-0001d7b0: 2020 2020 783d 302c 0a20 2020 2020 2020      x=0,.       
-0001d7c0: 2020 2020 2079 3d31 2c0a 2020 2020 2020       y=1,.      
-0001d7d0: 2020 2020 2020 7261 6469 7573 3d30 2e34        radius=0.4
-0001d7e0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-0001d7f0: 6172 745f 616e 676c 653d 6375 6d73 756d  art_angle=cumsum
-0001d800: 2822 616e 676c 6522 2c20 696e 636c 7564  ("angle", includ
-0001d810: 655f 7a65 726f 3d54 7275 6529 2c0a 2020  e_zero=True),.  
-0001d820: 2020 2020 2020 2020 2020 656e 645f 616e            end_an
-0001d830: 676c 653d 6375 6d73 756d 2822 616e 676c  gle=cumsum("angl
-0001d840: 6522 292c 0a20 2020 2020 2020 2020 2020  e"),.           
-0001d850: 206c 696e 655f 636f 6c6f 723d 2277 6869   line_color="whi
-0001d860: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
-0001d870: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
-0001d880: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-0001d890: 206c 6567 656e 645f 6669 656c 643d 2261   legend_field="a
-0001d8a0: 6374 6976 6974 7922 2c0a 2020 2020 2020  ctivity",.      
-0001d8b0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-0001d8c0: 662e 7461 736b 5f65 7865 635f 6279 5f61  f.task_exec_by_a
-0001d8d0: 6374 6976 6974 795f 7372 632c 0a20 2020  ctivity_src,.   
-0001d8e0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001d8f0: 6574 7572 6e20 7069 6563 6861 7274 0a0a  eturn piechart..
-0001d900: 2020 2020 6465 6620 5f62 7569 6c64 5f74      def _build_t
-0001d910: 6173 6b5f 6578 6563 7574 696f 6e5f 6279  ask_execution_by
-0001d920: 5f70 7265 6669 785f 6368 6172 7428 0a20  _prefix_chart(. 
-0001d930: 2020 2020 2020 2073 656c 662c 2074 6173         self, tas
-0001d940: 6b5f 6578 6563 5f64 6174 613a 2064 6566  k_exec_data: def
-0001d950: 6175 6c74 6469 6374 5b73 7472 2c20 6c69  aultdict[str, li
-0001d960: 7374 5d0a 2020 2020 2920 2d3e 2066 6967  st].    ) -> fig
-0001d970: 7572 653a 0a20 2020 2020 2020 2062 6172  ure:.        bar
-0001d980: 6368 6172 7420 3d20 6669 6775 7265 280a  chart = figure(.
-0001d990: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
-0001d9a0: 6e67 653d 7461 736b 5f65 7865 635f 6461  nge=task_exec_da
-0001d9b0: 7461 5b22 6675 6e63 7469 6f6e 7322 5d2c  ta["functions"],
-0001d9c0: 0a20 2020 2020 2020 2020 2020 2068 6569  .            hei
-0001d9d0: 6768 743d 3530 302c 0a20 2020 2020 2020  ght=500,.       
-0001d9e0: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
-0001d9f0: 3d22 7363 616c 655f 626f 7468 222c 0a20  ="scale_both",. 
-0001da00: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0001da10: 3d22 5461 736b 2065 7865 6375 7469 6f6e  ="Task execution
-0001da20: 2c20 6279 2066 756e 6374 696f 6e22 2c0a  , by function",.
-0001da30: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-0001da40: 733d 2270 616e 2c77 6865 656c 5f7a 6f6f  s="pan,wheel_zoo
-0001da50: 6d2c 626f 785f 7a6f 6f6d 2c72 6573 6574  m,box_zoom,reset
-0001da60: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
-0001da70: 2020 2020 2062 6172 6368 6172 742e 7961       barchart.ya
-0001da80: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-0001da90: 6c73 650a 2020 2020 2020 2020 6261 7263  lse.        barc
-0001daa0: 6861 7274 2e78 6178 6973 2e6d 616a 6f72  hart.xaxis.major
-0001dab0: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
-0001dac0: 6f6e 203d 2030 2e32 0a20 2020 2020 2020  on = 0.2.       
-0001dad0: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
-0001dae0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
-0001daf0: 204e 6f6e 650a 2020 2020 2020 2020 7374   None.        st
-0001db00: 6163 6b65 7273 203d 205b 0a20 2020 2020  ackers = [.     
-0001db10: 2020 2020 2020 206e 616d 6520 666f 7220         name for 
-0001db20: 6e61 6d65 2069 6e20 7461 736b 5f65 7865  name in task_exe
-0001db30: 635f 6461 7461 2069 6620 6e61 6d65 2e65  c_data if name.e
-0001db40: 6e64 7377 6974 6828 7365 6c66 2e75 6e69  ndswith(self.uni
-0001db50: 745f 7365 6c65 6374 6564 290a 2020 2020  t_selected).    
-0001db60: 2020 2020 5d0a 2020 2020 2020 2020 6966      ].        if
-0001db70: 2073 7461 636b 6572 733a 0a20 2020 2020   stackers:.     
-0001db80: 2020 2020 2020 2072 656e 6465 7265 7273         renderers
-0001db90: 203d 2062 6172 6368 6172 742e 7662 6172   = barchart.vbar
-0001dba0: 5f73 7461 636b 280a 2020 2020 2020 2020  _stack(.        
-0001dbb0: 2020 2020 2020 2020 7374 6163 6b65 7273          stackers
+0001b7f0: 2277 6169 7469 6e67 3a20 2528 7761 6974  "waiting: %(wait
+0001b800: 696e 6729 732c 2022 0a20 2020 2020 2020  ing)s, ".       
+0001b810: 2020 2020 2022 7175 6575 6564 3a20 2528       "queued: %(
+0001b820: 7175 6575 6564 2973 2c20 220a 2020 2020  queued)s, ".    
+0001b830: 2020 2020 2020 2020 2270 726f 6365 7373          "process
+0001b840: 696e 673a 2025 2870 726f 6365 7373 696e  ing: %(processin
+0001b850: 6729 732c 2022 0a20 2020 2020 2020 2020  g)s, ".         
+0001b860: 2020 2022 696e 2d6d 656d 6f72 793a 2025     "in-memory: %
+0001b870: 286d 656d 6f72 7929 732c 2022 0a20 2020  (memory)s, ".   
+0001b880: 2020 2020 2020 2020 2022 6e6f 2d77 6f72           "no-wor
+0001b890: 6b65 723a 2025 286e 6f5f 776f 726b 6572  ker: %(no_worker
+0001b8a0: 2973 2c20 220a 2020 2020 2020 2020 2020  )s, ".          
+0001b8b0: 2020 2265 7272 6564 3a20 2528 6572 7265    "erred: %(erre
+0001b8c0: 6429 7322 2025 2074 6f74 616c 730a 2020  d)s" % totals.  
+0001b8d0: 2020 2020 2020 290a 0a0a 636c 6173 7320        )...class 
+0001b8e0: 4669 6e65 5065 7266 6f72 6d61 6e63 654d  FinePerformanceM
+0001b8f0: 6574 7269 6373 2844 6173 6862 6f61 7264  etrics(Dashboard
+0001b900: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
+0001b910: 2222 220a 2020 2020 5468 6520 6d61 696e  """.    The main
+0001b920: 206f 7665 7276 6965 7720 6f66 2074 6865   overview of the
+0001b930: 2046 696e 6520 5065 7266 6f72 6d61 6e63   Fine Performanc
+0001b940: 6520 4d65 7472 6963 7320 7061 6765 2e0a  e Metrics page..
+0001b950: 2020 2020 2222 220a 0a20 2020 2040 6c6f      """..    @lo
+0001b960: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+0001b970: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0001b980: 7363 6865 6475 6c65 722c 202a 2a6b 7761  scheduler, **kwa
+0001b990: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
+0001b9a0: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
+0001b9b0: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
+0001b9c0: 2073 656c 662e 7365 6e64 6461 7461 203d   self.senddata =
+0001b9d0: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
+0001b9e0: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0001b9f0: 7365 6e64 7372 6320 3d20 436f 6c75 6d6e  sendsrc = Column
+0001ba00: 4461 7461 536f 7572 6365 2864 6174 613d  DataSource(data=
+0001ba10: 6469 6374 2829 290a 2020 2020 2020 2020  dict()).        
+0001ba20: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
+0001ba30: 6174 6120 3d20 6465 6661 756c 7464 6963  ata = defaultdic
+0001ba40: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
+0001ba50: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
+0001ba60: 6174 615f 6c69 6d69 7465 6420 3d20 6465  ata_limited = de
+0001ba70: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
+0001ba80: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001ba90: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001baa0: 5f73 7263 203d 2043 6f6c 756d 6e44 6174  _src = ColumnDat
+0001bab0: 6153 6f75 7263 6528 6461 7461 3d64 6963  aSource(data=dic
+0001bac0: 7428 2929 0a20 2020 2020 2020 2073 656c  t()).        sel
+0001bad0: 662e 7461 736b 5f65 7865 635f 6279 5f61  f.task_exec_by_a
+0001bae0: 6374 6976 6974 795f 7372 6320 3d20 436f  ctivity_src = Co
+0001baf0: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
+0001bb00: 6174 613d 6469 6374 2829 290a 2020 2020  ata=dict()).    
+0001bb10: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
+0001bb20: 7469 616c 5f63 6861 6e67 6520 3d20 4661  tial_change = Fa
+0001bb30: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+0001bb40: 2e74 6173 6b5f 6163 7469 7669 7469 6573  .task_activities
+0001bb50: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
+0001bb60: 6c66 2e69 6e69 745f 726f 6f74 2829 0a0a  lf.init_root()..
+0001bb70: 2020 2020 6465 6620 696e 6974 5f72 6f6f      def init_roo
+0001bb80: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+0001bb90: 2064 6566 2068 616e 646c 655f 7365 6c65   def handle_sele
+0001bba0: 6374 6f72 5f63 686e 6728 6174 7472 2c20  ctor_chng(attr, 
+0001bbb0: 6f6c 642c 206e 6577 293a 0a20 2020 2020  old, new):.     
+0001bbc0: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
+0001bbd0: 5f73 656c 6563 7465 6420 3d20 6e65 770a  _selected = new.
+0001bbe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001bbf0: 2e73 7562 7374 616e 7469 616c 5f63 6861  .substantial_cha
+0001bc00: 6e67 6520 3d20 5472 7565 0a0a 2020 2020  nge = True..    
+0001bc10: 2020 2020 7365 6c66 2e66 756e 6374 696f      self.functio
+0001bc20: 6e5f 7365 6c65 6374 6f72 203d 204d 756c  n_selector = Mul
+0001bc30: 7469 4368 6f69 6365 2876 616c 7565 3d5b  tiChoice(value=[
+0001bc40: 5d2c 206f 7074 696f 6e73 3d5b 5d29 0a20  ], options=[]). 
+0001bc50: 2020 2020 2020 2073 656c 662e 6675 6e63         self.func
+0001bc60: 7469 6f6e 5f73 656c 6563 746f 722e 706c  tion_selector.pl
+0001bc70: 6163 6568 6f6c 6465 7220 3d20 2253 656c  aceholder = "Sel
+0001bc80: 6563 7420 7370 6563 6966 6963 2066 756e  ect specific fun
+0001bc90: 6374 696f 6e73 220a 2020 2020 2020 2020  ctions".        
+0001bca0: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
+0001bcb0: 6f72 203d 2053 656c 6563 7428 7469 746c  or = Select(titl
+0001bcc0: 653d 2255 6e69 7420 7365 6c65 6374 696f  e="Unit selectio
+0001bcd0: 6e22 2c20 6f70 7469 6f6e 733d 5b22 7365  n", options=["se
+0001bce0: 636f 6e64 7322 5d29 0a20 2020 2020 2020  conds"]).       
+0001bcf0: 2073 656c 662e 756e 6974 5f73 656c 6563   self.unit_selec
+0001bd00: 746f 722e 6f6e 5f63 6861 6e67 6528 2276  tor.on_change("v
+0001bd10: 616c 7565 222c 2068 616e 646c 655f 7365  alue", handle_se
+0001bd20: 6c65 6374 6f72 5f63 686e 6729 0a20 2020  lector_chng).   
+0001bd30: 2020 2020 2073 656c 662e 756e 6974 5f73       self.unit_s
+0001bd40: 656c 6563 7465 6420 3d20 2273 6563 6f6e  elected = "secon
+0001bd50: 6473 220a 2020 2020 2020 2020 7365 6c66  ds".        self
+0001bd60: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
+0001bd70: 7469 7669 7479 5f63 6861 7274 203d 204e  tivity_chart = N
+0001bd80: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0001bd90: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001bda0: 6566 6978 5f63 6861 7274 203d 204e 6f6e  efix_chart = Non
+0001bdb0: 650a 2020 2020 2020 2020 7365 6c66 2e73  e.        self.s
+0001bdc0: 656e 6464 6174 615f 6279 5f61 6374 6976  enddata_by_activ
+0001bdd0: 6974 795f 6368 6172 7420 3d20 4e6f 6e65  ity_chart = None
+0001bde0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001bdf0: 6f74 203d 2063 6f6c 756d 6e28 0a20 2020  ot = column(.   
+0001be00: 2020 2020 2020 2020 2073 656c 662e 6675           self.fu
+0001be10: 6e63 7469 6f6e 5f73 656c 6563 746f 722c  nction_selector,
+0001be20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001be30: 662e 756e 6974 5f73 656c 6563 746f 722c  f.unit_selector,
+0001be40: 0a20 2020 2020 2020 2020 2020 2073 697a  .            siz
+0001be50: 696e 675f 6d6f 6465 3d22 7363 616c 655f  ing_mode="scale_
+0001be60: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
+0001be70: 290a 0a20 2020 2064 6566 2066 6f72 6d61  )..    def forma
+0001be80: 7428 7365 6c66 2c20 756e 6974 3a20 7374  t(self, unit: st
+0001be90: 722c 2076 616c 3a20 416e 7929 202d 3e20  r, val: Any) -> 
+0001bea0: 7374 723a 0a20 2020 2020 2020 2066 6f72  str:.        for
+0001beb0: 6d61 7474 6572 7320 3d20 7b22 6279 7465  matters = {"byte
+0001bec0: 7322 3a20 666f 726d 6174 5f62 7974 6573  s": format_bytes
+0001bed0: 2c20 2273 6563 6f6e 6473 223a 2066 6f72  , "seconds": for
+0001bee0: 6d61 745f 7469 6d65 7d0a 2020 2020 2020  mat_time}.      
+0001bef0: 2020 7265 7475 726e 2066 6f72 6d61 7474    return formatt
+0001bf00: 6572 732e 6765 7428 756e 6974 2c20 7374  ers.get(unit, st
+0001bf10: 7229 2876 616c 290a 0a20 2020 2064 6566  r)(val)..    def
+0001bf20: 2067 6574 5f6d 6574 7269 6373 280a 2020   get_metrics(.  
+0001bf30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001bf40: 2920 2d3e 2074 7570 6c65 5b6c 6973 745b  ) -> tuple[list[
+0001bf50: 7475 706c 655b 7374 722c 2073 7472 2c20  tuple[str, str, 
+0001bf60: 7374 722c 2066 6c6f 6174 5d5d 2c20 6c69  str, float]], li
+0001bf70: 7374 5b74 7570 6c65 5b73 7472 2c20 7374  st[tuple[str, st
+0001bf80: 722c 2066 6c6f 6174 5d5d 5d3a 0a20 2020  r, float]]]:.   
+0001bf90: 2020 2020 2022 2222 5072 652d 7072 6f63       """Pre-proc
+0001bfa0: 6573 7320 6669 6e65 2070 6572 666f 726d  ess fine perform
+0001bfb0: 616e 6365 206d 6574 7269 6373 0a0a 2020  ance metrics..  
+0001bfc0: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
+0001bfd0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+0001bfe0: 2020 2020 2020 2d20 2765 7865 6375 7465        - 'execute
+0001bff0: 2720 6d65 7472 6963 733a 205b 2866 756e  ' metrics: [(fun
+0001c000: 6374 696f 6e2c 2061 6374 6976 6974 792c  ction, activity,
+0001c010: 2075 6e69 742c 2076 616c 7565 292c 202e   unit, value), .
+0001c020: 2e2e 5d0a 2020 2020 2020 2020 2d20 2767  ..].        - 'g
+0001c030: 6574 5f64 6174 6127 206d 6574 7269 6373  et_data' metrics
+0001c040: 3a20 5b28 6163 7469 7669 7479 2c20 756e  : [(activity, un
+0001c050: 6974 2c20 7661 6c75 6529 2c20 2e2e 2e5d  it, value), ...]
+0001c060: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001c070: 2020 2020 2065 7865 6375 7465 3a20 6465       execute: de
+0001c080: 6661 756c 7464 6963 745b 7475 706c 655b  faultdict[tuple[
+0001c090: 7374 722c 2073 7472 2c20 7374 725d 2c20  str, str, str], 
+0001c0a0: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
+0001c0b0: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+0001c0c0: 2020 2020 6765 745f 6461 7461 203d 205b      get_data = [
+0001c0d0: 5d0a 0a20 2020 2020 2020 2066 6f72 206b  ]..        for k
+0001c0e0: 2c20 7620 696e 2073 656c 662e 7363 6865  , v in self.sche
+0001c0f0: 6475 6c65 722e 6375 6d75 6c61 7469 7665  duler.cumulative
+0001c100: 5f77 6f72 6b65 725f 6d65 7472 6963 732e  _worker_metrics.
+0001c110: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0001c120: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+0001c130: 7374 616e 6365 286b 2c20 7475 706c 6529  stance(k, tuple)
+0001c140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c150: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0001c160: 2020 2020 2020 2063 6f6e 7465 7874 2c20         context, 
+0001c170: 2a6f 7468 6572 2c20 6163 7469 7669 7479  *other, activity
+0001c180: 2c20 756e 6974 203d 206b 0a20 2020 2020  , unit = k.     
+0001c190: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0001c1a0: 696e 7374 616e 6365 2875 6e69 742c 2073  instance(unit, s
+0001c1b0: 7472 290a 0a20 2020 2020 2020 2020 2020  tr)..           
+0001c1c0: 2069 6620 636f 6e74 6578 7420 3d3d 2022   if context == "
+0001c1d0: 6578 6563 7574 6522 3a0a 2020 2020 2020  execute":.      
+0001c1e0: 2020 2020 2020 2020 2020 7370 616e 5f69            span_i
+0001c1f0: 642c 2066 756e 6374 696f 6e20 3d20 6f74  d, function = ot
+0001c200: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
+0001c210: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0001c220: 7461 6e63 6528 6675 6e63 7469 6f6e 2c20  tance(function, 
+0001c230: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
+0001c240: 2020 2020 2023 2043 7573 746f 6d20 6d65       # Custom me
+0001c250: 7472 6963 7320 6361 6e20 7072 6f76 6964  trics can provid
+0001c260: 6520 616e 7920 6861 7368 6162 6c65 2061  e any hashable a
+0001c270: 7320 7468 6520 6c61 6265 6c0a 2020 2020  s the label.    
+0001c280: 2020 2020 2020 2020 2020 2020 2320 5371              # Sq
+0001c290: 7561 7368 2061 6c6c 2073 7061 6e5f 6964  uash all span_id
+0001c2a0: 7320 746f 6765 7468 6572 0a20 2020 2020  s together.     
+0001c2b0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0001c2c0: 4f20 6f66 6665 7220 6120 6669 6c74 6572  O offer a filter
+0001c2d0: 2062 7920 7370 616e 5f69 642c 206c 696b   by span_id, lik
+0001c2e0: 6520 7765 2061 6c72 6561 6479 2064 6f20  e we already do 
+0001c2f0: 6279 2066 756e 6374 696f 6e0a 2020 2020  by function.    
+0001c300: 2020 2020 2020 2020 2020 2020 6578 6563              exec
+0001c310: 7574 655b 6675 6e63 7469 6f6e 2c20 7374  ute[function, st
+0001c320: 7228 6163 7469 7669 7479 292c 2075 6e69  r(activity), uni
+0001c330: 745d 202b 3d20 760a 2020 2020 2020 2020  t] += v.        
+0001c340: 2020 2020 656c 6966 2063 6f6e 7465 7874      elif context
+0001c350: 203d 3d20 2267 6574 2d64 6174 6122 3a0a   == "get-data":.
+0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c370: 6173 7365 7274 206e 6f74 206f 7468 6572  assert not other
+0001c380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c390: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0001c3a0: 6365 2861 6374 6976 6974 792c 2073 7472  ce(activity, str
+0001c3b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c3c0: 2020 6765 745f 6461 7461 2e61 7070 656e    get_data.appen
+0001c3d0: 6428 2861 6374 6976 6974 792c 2075 6e69  d((activity, uni
+0001c3e0: 742c 2076 2929 0a0a 2020 2020 2020 2020  t, v))..        
+0001c3f0: 2020 2020 2320 4967 6e6f 7265 206d 656d      # Ignore mem
+0001c400: 6f72 792d 6d6f 6e69 746f 7220 616e 6420  ory-monitor and 
+0001c410: 6761 7468 6572 2d64 6570 206d 6574 7269  gather-dep metri
+0001c420: 6373 0a0a 2020 2020 2020 2020 7265 7475  cs..        retu
+0001c430: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+0001c440: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0001c450: 2020 2028 6675 6e63 7469 6f6e 2c20 6163     (function, ac
+0001c460: 7469 7669 7479 2c20 756e 6974 2c20 7629  tivity, unit, v)
+0001c470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c480: 2066 6f72 2028 6675 6e63 7469 6f6e 2c20   for (function, 
+0001c490: 6163 7469 7669 7479 2c20 756e 6974 292c  activity, unit),
+0001c4a0: 2076 2069 6e20 736f 7274 6564 2865 7865   v in sorted(exe
+0001c4b0: 6375 7465 2e69 7465 6d73 2829 290a 2020  cute.items()).  
+0001c4c0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0001c4d0: 2020 2020 2020 2020 2073 6f72 7465 6428           sorted(
+0001c4e0: 6765 745f 6461 7461 292c 0a20 2020 2020  get_data),.     
+0001c4f0: 2020 2029 0a0a 2020 2020 4077 6974 686f     )..    @witho
+0001c500: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+0001c510: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
+0001c520: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
+0001c530: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+0001c540: 2020 2020 2065 7865 6375 7465 5f6d 6574       execute_met
+0001c550: 7269 6373 2c20 6765 745f 6461 7461 5f6d  rics, get_data_m
+0001c560: 6574 7269 6373 203d 2073 656c 662e 6765  etrics = self.ge
+0001c570: 745f 6d65 7472 6963 7328 290a 0a20 2020  t_metrics()..   
+0001c580: 2020 2020 2061 6374 6976 6974 6965 7320       activities 
+0001c590: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001c5a0: 6163 7469 7669 7479 2066 6f72 202a 5f2c  activity for *_,
+0001c5b0: 2061 6374 6976 6974 792c 205f 2c20 5f20   activity, _, _ 
+0001c5c0: 696e 2063 6861 696e 2865 7865 6375 7465  in chain(execute
+0001c5d0: 5f6d 6574 7269 6373 2c20 6765 745f 6461  _metrics, get_da
+0001c5e0: 7461 5f6d 6574 7269 6373 290a 2020 2020  ta_metrics).    
+0001c5f0: 2020 2020 7d0a 2020 2020 2020 2020 6163      }.        ac
+0001c600: 7469 7669 7469 6573 2e64 6966 6665 7265  tivities.differe
+0001c610: 6e63 655f 7570 6461 7465 2873 656c 662e  nce_update(self.
+0001c620: 7461 736b 5f61 6374 6976 6974 6965 7329  task_activities)
+0001c630: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
+0001c640: 7669 7469 6573 3a0a 2020 2020 2020 2020  vities:.        
+0001c650: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
+0001c660: 7469 616c 5f63 6861 6e67 6520 3d20 5472  tial_change = Tr
+0001c670: 7565 0a20 2020 2020 2020 2020 2020 2073  ue.            s
+0001c680: 656c 662e 7461 736b 5f61 6374 6976 6974  elf.task_activit
+0001c690: 6965 732e 6578 7465 6e64 2861 6374 6976  ies.extend(activ
+0001c6a0: 6974 6965 7329 0a0a 2020 2020 2020 2020  ities)..        
+0001c6b0: 756e 6974 7320 3d20 7b75 6e69 7420 666f  units = {unit fo
+0001c6c0: 7220 2a5f 2c20 756e 6974 2c20 5f20 696e  r *_, unit, _ in
+0001c6d0: 2063 6861 696e 2865 7865 6375 7465 5f6d   chain(execute_m
+0001c6e0: 6574 7269 6373 2c20 6765 745f 6461 7461  etrics, get_data
+0001c6f0: 5f6d 6574 7269 6373 297d 0a20 2020 2020  _metrics)}.     
+0001c700: 2020 2075 6e69 7473 2e64 6966 6665 7265     units.differe
+0001c710: 6e63 655f 7570 6461 7465 2873 656c 662e  nce_update(self.
+0001c720: 756e 6974 5f73 656c 6563 746f 722e 6f70  unit_selector.op
+0001c730: 7469 6f6e 7329 0a20 2020 2020 2020 2073  tions).        s
+0001c740: 656c 662e 756e 6974 5f73 656c 6563 746f  elf.unit_selecto
+0001c750: 722e 6f70 7469 6f6e 732e 6578 7465 6e64  r.options.extend
+0001c760: 2875 6e69 7473 290a 0a20 2020 2020 2020  (units)..       
+0001c770: 2066 756e 6374 696f 6e73 203d 207b 6675   functions = {fu
+0001c780: 6e63 7469 6f6e 2066 6f72 2066 756e 6374  nction for funct
+0001c790: 696f 6e2c 202a 5f20 696e 2065 7865 6375  ion, *_ in execu
+0001c7a0: 7465 5f6d 6574 7269 6373 7d0a 2020 2020  te_metrics}.    
+0001c7b0: 2020 2020 6675 6e63 7469 6f6e 732e 6469      functions.di
+0001c7c0: 6666 6572 656e 6365 5f75 7064 6174 6528  fference_update(
+0001c7d0: 7365 6c66 2e74 6173 6b5f 6578 6563 5f64  self.task_exec_d
+0001c7e0: 6174 615b 2266 756e 6374 696f 6e73 225d  ata["functions"]
+0001c7f0: 290a 2020 2020 2020 2020 6966 2066 756e  ).        if fun
+0001c800: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+0001c810: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
+0001c820: 7469 616c 5f63 6861 6e67 6520 3d20 5472  tial_change = Tr
+0001c830: 7565 0a20 2020 2020 2020 2020 2020 2073  ue.            s
+0001c840: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
+0001c850: 7461 5b22 7469 6d65 7374 616d 7022 5d2e  ta["timestamp"].
+0001c860: 6578 7465 6e64 2864 6174 6574 696d 652e  extend(datetime.
+0001c870: 6e6f 7728 2920 666f 7220 5f20 696e 2066  now() for _ in f
+0001c880: 756e 6374 696f 6e73 290a 2020 2020 2020  unctions).      
+0001c890: 2020 2020 2020 7365 6c66 2e66 756e 6374        self.funct
+0001c8a0: 696f 6e5f 7365 6c65 6374 6f72 2e6f 7074  ion_selector.opt
+0001c8b0: 696f 6e73 2e65 7874 656e 6428 6675 6e63  ions.extend(func
+0001c8c0: 7469 6f6e 7329 0a20 2020 2020 2020 2020  tions).         
+0001c8d0: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
+0001c8e0: 635f 6461 7461 5b22 6675 6e63 7469 6f6e  c_data["function
+0001c8f0: 7322 5d2e 6578 7465 6e64 2866 756e 6374  s"].extend(funct
+0001c900: 696f 6e73 290a 0a20 2020 2020 2020 2066  ions)..        f
+0001c910: 6f72 2061 6374 6976 6974 792c 2075 6e69  or activity, uni
+0001c920: 742c 2076 616c 2069 6e20 6765 745f 6461  t, val in get_da
+0001c930: 7461 5f6d 6574 7269 6373 3a0a 2020 2020  ta_metrics:.    
+0001c940: 2020 2020 2020 2020 6966 2061 6374 6976          if activ
+0001c950: 6974 7920 6e6f 7420 696e 2073 656c 662e  ity not in self.
+0001c960: 7365 6e64 6461 7461 5b22 6163 7469 7669  senddata["activi
+0001c970: 7479 225d 3a0a 2020 2020 2020 2020 2020  ty"]:.          
+0001c980: 2020 2020 2020 7365 6c66 2e73 7562 7374        self.subst
+0001c990: 616e 7469 616c 5f63 6861 6e67 6520 3d20  antial_change = 
+0001c9a0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001c9b0: 2020 2020 2073 656c 662e 7365 6e64 6461       self.sendda
+0001c9c0: 7461 5b22 6163 7469 7669 7479 225d 2e61  ta["activity"].a
+0001c9d0: 7070 656e 6428 6163 7469 7669 7479 290a  ppend(activity).
+0001c9e0: 0a20 2020 2020 2020 2020 2020 2069 6478  .            idx
+0001c9f0: 203d 2073 656c 662e 7365 6e64 6461 7461   = self.senddata
+0001ca00: 5b22 6163 7469 7669 7479 225d 2e69 6e64  ["activity"].ind
+0001ca10: 6578 2861 6374 6976 6974 7929 0a20 2020  ex(activity).   
+0001ca20: 2020 2020 2020 2020 2077 6869 6c65 2069           while i
+0001ca30: 6478 203e 3d20 6c65 6e28 7365 6c66 2e73  dx >= len(self.s
+0001ca40: 656e 6464 6174 615b 6622 7b61 6374 6976  enddata[f"{activ
+0001ca50: 6974 797d 5f7b 756e 6974 7d22 5d29 3a0a  ity}_{unit}"]):.
+0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca70: 7365 6c66 2e73 656e 6464 6174 615b 6622  self.senddata[f"
+0001ca80: 7b61 6374 6976 6974 797d 5f7b 756e 6974  {activity}_{unit
+0001ca90: 7d22 5d2e 6170 7065 6e64 2830 290a 2020  }"].append(0).  
+0001caa0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001cab0: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
+0001cac0: 6374 6976 6974 797d 5f7b 756e 6974 7d5f  ctivity}_{unit}_
+0001cad0: 7465 7874 225d 2e61 7070 656e 6428 2222  text"].append(""
+0001cae0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001caf0: 6c66 2e73 656e 6464 6174 615b 6622 7b61  lf.senddata[f"{a
+0001cb00: 6374 6976 6974 797d 5f7b 756e 6974 7d5f  ctivity}_{unit}_
+0001cb10: 7465 7874 225d 5b69 6478 5d20 3d20 7365  text"][idx] = se
+0001cb20: 6c66 2e66 6f72 6d61 7428 756e 6974 2c20  lf.format(unit, 
+0001cb30: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
+0001cb40: 2073 656c 662e 7365 6e64 6461 7461 5b66   self.senddata[f
+0001cb50: 227b 6163 7469 7669 7479 7d5f 7b75 6e69  "{activity}_{uni
+0001cb60: 747d 225d 5b69 6478 5d20 3d20 7661 6c0a  t}"][idx] = val.
+0001cb70: 0a20 2020 2020 2020 2066 6f72 2070 7265  .        for pre
+0001cb80: 6669 782c 2061 6374 6976 6974 792c 2075  fix, activity, u
+0001cb90: 6e69 742c 2076 616c 2069 6e20 6578 6563  nit, val in exec
+0001cba0: 7574 655f 6d65 7472 6963 733a 0a20 2020  ute_metrics:.   
+0001cbb0: 2020 2020 2020 2020 2069 6478 203d 2073           idx = s
+0001cbc0: 656c 662e 7461 736b 5f65 7865 635f 6461  elf.task_exec_da
+0001cbd0: 7461 5b22 6675 6e63 7469 6f6e 7322 5d2e  ta["functions"].
+0001cbe0: 696e 6465 7828 7072 6566 6978 290a 0a20  index(prefix).. 
+0001cbf0: 2020 2020 2020 2020 2020 2023 2053 6f6d             # Som
+0001cc00: 6520 6675 6e63 7469 6f6e 2f61 6374 6976  e function/activ
+0001cc10: 6974 7920 636f 6d62 6f73 206d 6973 7369  ity combos missi
+0001cc20: 6e67 2c20 736f 206e 6565 6420 746f 206b  ng, so need to k
+0001cc30: 6565 7020 636f 6c75 6d6e 7320 616c 6967  eep columns alig
+0001cc40: 6e65 640a 2020 2020 2020 2020 2020 2020  ned.            
+0001cc50: 666f 7220 6f70 2069 6e20 7365 6c66 2e74  for op in self.t
+0001cc60: 6173 6b5f 6163 7469 7669 7469 6573 3a0a  ask_activities:.
+0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc80: 7768 696c 6520 6c65 6e28 7365 6c66 2e74  while len(self.t
+0001cc90: 6173 6b5f 6578 6563 5f64 6174 615b 6622  ask_exec_data[f"
+0001cca0: 7b6f 707d 5f7b 756e 6974 7d22 5d29 2021  {op}_{unit}"]) !
+0001ccb0: 3d20 6c65 6e28 0a20 2020 2020 2020 2020  = len(.         
+0001ccc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001ccd0: 7461 736b 5f65 7865 635f 6461 7461 5b22  task_exec_data["
+0001cce0: 6675 6e63 7469 6f6e 7322 5d0a 2020 2020  functions"].    
+0001ccf0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+0001cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd10: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
+0001cd20: 635f 6461 7461 5b66 227b 6f70 7d5f 7b75  c_data[f"{op}_{u
+0001cd30: 6e69 747d 225d 2e61 7070 656e 6428 3029  nit}"].append(0)
+0001cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cd50: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
+0001cd60: 7865 635f 6461 7461 5b66 227b 6f70 7d5f  xec_data[f"{op}_
+0001cd70: 7b75 6e69 747d 5f74 6578 7422 5d2e 6170  {unit}_text"].ap
+0001cd80: 7065 6e64 2822 2229 0a0a 2020 2020 2020  pend("")..      
+0001cd90: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+0001cda0: 6578 6563 5f64 6174 615b 6622 7b61 6374  exec_data[f"{act
+0001cdb0: 6976 6974 797d 5f7b 756e 6974 7d22 5d5b  ivity}_{unit}"][
+0001cdc0: 6964 785d 203d 2076 616c 0a20 2020 2020  idx] = val.     
+0001cdd0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0001cde0: 5f65 7865 635f 6461 7461 5b66 227b 6163  _exec_data[f"{ac
+0001cdf0: 7469 7669 7479 7d5f 7b75 6e69 747d 5f74  tivity}_{unit}_t
+0001ce00: 6578 7422 5d5b 6964 785d 203d 2073 656c  ext"][idx] = sel
+0001ce10: 662e 666f 726d 6174 2875 6e69 742c 2076  f.format(unit, v
+0001ce20: 616c 290a 0a20 2020 2020 2020 2064 6174  al)..        dat
+0001ce30: 6120 3d20 7365 6c66 2e74 6173 6b5f 6578  a = self.task_ex
+0001ce40: 6563 5f64 6174 612e 636f 7079 2829 0a20  ec_data.copy(). 
+0001ce50: 2020 2020 2020 2023 2049 6620 7573 6572         # If user
+0001ce60: 2068 6173 206d 616e 7561 6c6c 7920 7365   has manually se
+0001ce70: 6c65 6374 6564 2066 756e 6374 696f 6e28  lected function(
+0001ce80: 7329 2074 6865 6e20 7765 2061 7265 206f  s) then we are o
+0001ce90: 6e6c 7920 7368 6f77 696e 6720 7468 656d  nly showing them
+0001cea0: 2e0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0001ceb0: 662e 6675 6e63 7469 6f6e 5f73 656c 6563  f.function_selec
+0001cec0: 746f 722e 7661 6c75 653a 0a20 2020 2020  tor.value:.     
+0001ced0: 2020 2020 2020 2069 6e64 6578 6573 203d         indexes =
+0001cee0: 205b 6461 7461 5b22 6675 6e63 7469 6f6e   [data["function
+0001cef0: 7322 5d2e 696e 6465 7828 6629 2066 6f72  s"].index(f) for
+0001cf00: 2066 2069 6e20 7365 6c66 2e66 756e 6374   f in self.funct
+0001cf10: 696f 6e5f 7365 6c65 6374 6f72 2e76 616c  ion_selector.val
+0001cf20: 7565 5d0a 2020 2020 2020 2020 2020 2020  ue].            
+0001cf30: 666f 7220 6b65 792c 2076 616c 7565 7320  for key, values 
+0001cf40: 696e 2064 6174 612e 6974 656d 7328 293a  in data.items():
+0001cf50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf60: 2064 6174 615b 6b65 795d 203d 205b 7661   data[key] = [va
+0001cf70: 6c75 6573 5b69 6478 5d20 666f 7220 6964  lues[idx] for id
+0001cf80: 7820 696e 2069 6e64 6578 6573 5d0a 0a20  x in indexes].. 
+0001cf90: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
+0001cfa0: 7365 206c 696d 6974 2074 686f 7365 2062  se limit those b
+0001cfb0: 6569 6e67 2073 686f 776e 2077 6869 6368  eing shown which
+0001cfc0: 2068 6176 6520 2765 7870 6972 6564 2720   have 'expired' 
+0001cfd0: 746f 2062 6520 6469 7370 6c61 7965 640a  to be displayed.
+0001cfe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001cff0: 2020 2020 2020 2020 2020 6375 746f 6666            cutoff
+0001d000: 203d 2064 6174 6574 696d 652e 7574 636e   = datetime.utcn
+0001d010: 6f77 2829 202d 2074 696d 6564 656c 7461  ow() - timedelta
+0001d020: 2873 6563 6f6e 6473 3d31 3029 0a20 2020  (seconds=10).   
+0001d030: 2020 2020 2020 2020 206e 5f73 686f 7720           n_show 
+0001d040: 3d20 6c65 6e28 5b64 2066 6f72 2064 2069  = len([d for d i
+0001d050: 6e20 6461 7461 5b22 7469 6d65 7374 616d  n data["timestam
+0001d060: 7022 5d20 6966 2064 203e 2063 7574 6f66  p"] if d > cutof
+0001d070: 665d 2920 6f72 2035 0a20 2020 2020 2020  f]) or 5.       
+0001d080: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+0001d090: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+0001d0a0: 2020 2020 2020 6461 7461 5b6b 6579 5d20        data[key] 
+0001d0b0: 3d20 6461 7461 5b6b 6579 5d5b 2d6e 5f73  = data[key][-n_s
+0001d0c0: 686f 773a 5d0a 2020 2020 2020 2020 7365  how:].        se
+0001d0d0: 6c66 2e74 6173 6b5f 6578 6563 5f64 6174  lf.task_exec_dat
+0001d0e0: 615f 6c69 6d69 7465 6420 3d20 6461 7461  a_limited = data
+0001d0f0: 2e63 6f70 7928 290a 0a20 2020 2020 2020  .copy()..       
+0001d100: 2023 2053 686f 7720 746f 7461 6c20 6e75   # Show total nu
+0001d110: 6d62 6572 206f 6620 6675 6e63 7469 6f6e  mber of function
+0001d120: 7320 746f 2063 686f 6f73 6520 6672 6f6d  s to choose from
+0001d130: 0a20 2020 2020 2020 2073 656c 662e 6675  .        self.fu
+0001d140: 6e63 7469 6f6e 5f73 656c 6563 746f 722e  nction_selector.
+0001d150: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
+0001d160: 2020 2020 2020 6622 4669 6c74 6572 2062        f"Filter b
+0001d170: 7920 6675 6e63 7469 6f6e 2028 7b6c 656e  y function ({len
+0001d180: 2873 656c 662e 6675 6e63 7469 6f6e 5f73  (self.function_s
+0001d190: 656c 6563 746f 722e 6f70 7469 6f6e 7329  elector.options)
+0001d1a0: 7d29 3a22 0a20 2020 2020 2020 2029 0a0a  }):".        )..
+0001d1b0: 2020 2020 2020 2020 6e65 6564 735f 6669          needs_fi
+0001d1c0: 6775 7265 735f 726f 7720 3d20 7365 6c66  gures_row = self
+0001d1d0: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
+0001d1e0: 7469 7669 7479 5f63 6861 7274 2069 7320  tivity_chart is 
+0001d1f0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+0001d200: 662e 5f62 7569 6c64 5f74 6173 6b5f 6578  f._build_task_ex
+0001d210: 6563 7574 696f 6e5f 6279 5f61 6374 6976  ecution_by_activ
+0001d220: 6974 795f 6368 6172 7428 7365 6c66 2e74  ity_chart(self.t
+0001d230: 6173 6b5f 6578 6563 5f64 6174 615f 6c69  ask_exec_data_li
+0001d240: 6d69 7465 642e 636f 7079 2829 290a 2020  mited.copy()).  
+0001d250: 2020 2020 2020 7365 6c66 2e5f 6275 696c        self._buil
+0001d260: 645f 7461 736b 5f65 7865 6375 7469 6f6e  d_task_execution
+0001d270: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
+0001d280: 2873 656c 662e 7461 736b 5f65 7865 635f  (self.task_exec_
+0001d290: 6461 7461 5f6c 696d 6974 6564 2e63 6f70  data_limited.cop
+0001d2a0: 7928 2929 0a20 2020 2020 2020 2073 656c  y()).        sel
+0001d2b0: 662e 5f62 7569 6c64 5f73 656e 6464 6174  f._build_senddat
+0001d2c0: 615f 6368 6172 7428 7365 6c66 2e73 656e  a_chart(self.sen
+0001d2d0: 6464 6174 612e 636f 7079 2829 290a 0a20  ddata.copy()).. 
+0001d2e0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0001d2f0: 7562 7374 616e 7469 616c 5f63 6861 6e67  ubstantial_chang
+0001d300: 6520 6f72 206e 6565 6473 5f66 6967 7572  e or needs_figur
+0001d310: 6573 5f72 6f77 3a0a 2020 2020 2020 2020  es_row:.        
+0001d320: 2020 2020 7365 6c66 2e73 7562 7374 616e      self.substan
+0001d330: 7469 616c 5f63 6861 6e67 6520 3d20 4661  tial_change = Fa
+0001d340: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
+0001d350: 2066 6967 7572 6573 5f72 6f77 203d 2072   figures_row = r
+0001d360: 6f77 280a 2020 2020 2020 2020 2020 2020  ow(.            
+0001d370: 2020 2020 6368 696c 6472 656e 3d5b 0a20      children=[. 
+0001d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d390: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
+0001d3a0: 635f 6279 5f70 7265 6669 785f 6368 6172  c_by_prefix_char
+0001d3b0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001d3c0: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0001d3d0: 5f65 7865 635f 6279 5f61 6374 6976 6974  _exec_by_activit
+0001d3e0: 795f 6368 6172 742c 0a20 2020 2020 2020  y_chart,.       
+0001d3f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001d400: 662e 7365 6e64 6461 7461 5f62 795f 6163  f.senddata_by_ac
+0001d410: 7469 7669 7479 5f63 6861 7274 2c0a 2020  tivity_chart,.  
+0001d420: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+0001d430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d440: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+0001d450: 7265 7463 685f 7769 6474 6822 2c0a 2020  retch_width",.  
+0001d460: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0001d470: 2020 2020 2020 2020 2069 6620 6e65 6564           if need
+0001d480: 735f 6669 6775 7265 735f 726f 773a 0a20  s_figures_row:. 
+0001d490: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001d4a0: 2046 6972 7374 2069 7465 7261 7469 6f6e   First iteration
+0001d4b0: 2c20 696e 6974 6961 6c20 6173 7369 676e  , initial assign
+0001d4c0: 6d65 6e74 206f 6620 6669 6775 7265 7320  ment of figures 
+0001d4d0: 726f 770a 2020 2020 2020 2020 2020 2020  row.            
+0001d4e0: 2020 2020 7365 6c66 2e72 6f6f 742e 6368      self.root.ch
+0001d4f0: 696c 6472 656e 2e61 7070 656e 6428 6669  ildren.append(fi
+0001d500: 6775 7265 735f 726f 7729 0a20 2020 2020  gures_row).     
+0001d510: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001d520: 2020 2020 2020 2020 2020 2020 2023 204f               # O
+0001d530: 7468 6572 7769 7365 206e 6565 6473 2066  therwise needs f
+0001d540: 6f72 6365 6420 7265 6672 6573 6820 6279  orced refresh by
+0001d550: 2072 6570 6c61 6369 6e67 2074 6865 2066   replacing the f
+0001d560: 6967 7572 6573 2072 6f77 0a20 2020 2020  igures row.     
+0001d570: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001d580: 726f 6f74 2e63 6869 6c64 7265 6e5b 2d31  root.children[-1
+0001d590: 5d20 3d20 6669 6775 7265 735f 726f 770a  ] = figures_row.
+0001d5a0: 0a20 2020 2064 6566 205f 6275 696c 645f  .    def _build_
+0001d5b0: 7461 736b 5f65 7865 6375 7469 6f6e 5f62  task_execution_b
+0001d5c0: 795f 6163 7469 7669 7479 5f63 6861 7274  y_activity_chart
+0001d5d0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001d5e0: 7461 736b 5f65 7865 635f 6461 7461 3a20  task_exec_data: 
+0001d5f0: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+0001d600: 206c 6973 745d 0a20 2020 2029 202d 3e20   list].    ) -> 
+0001d610: 4e6f 6e65 3a0a 2020 2020 2020 2020 7069  None:.        pi
+0001d620: 6563 6861 7274 5f64 6174 6120 3d20 7b7d  echart_data = {}
+0001d630: 0a20 2020 2020 2020 2070 6965 6368 6172  .        piechar
+0001d640: 745f 6461 7461 5b22 7661 6c75 6522 5d20  t_data["value"] 
+0001d650: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001d660: 7375 6d28 7461 736b 5f65 7865 635f 6461  sum(task_exec_da
+0001d670: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
+0001d680: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
+0001d690: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0001d6a0: 7220 6f70 2069 6e20 7365 6c66 2e74 6173  r op in self.tas
+0001d6b0: 6b5f 6163 7469 7669 7469 6573 0a20 2020  k_activities.   
+0001d6c0: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
+0001d6d0: 6965 6368 6172 745f 6461 7461 5b22 7465  iechart_data["te
+0001d6e0: 7874 225d 203d 205b 0a20 2020 2020 2020  xt"] = [.       
+0001d6f0: 2020 2020 2073 656c 662e 666f 726d 6174       self.format
+0001d700: 2873 656c 662e 756e 6974 5f73 656c 6563  (self.unit_selec
+0001d710: 7465 642c 2076 2920 666f 7220 7620 696e  ted, v) for v in
+0001d720: 2070 6965 6368 6172 745f 6461 7461 5b22   piechart_data["
+0001d730: 7661 6c75 6522 5d0a 2020 2020 2020 2020  value"].        
+0001d740: 5d0a 2020 2020 2020 2020 7069 6563 6861  ].        piecha
+0001d750: 7274 5f64 6174 615b 2261 6e67 6c65 225d  rt_data["angle"]
+0001d760: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001d770: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0001d780: 2020 2073 756d 2874 6173 6b5f 6578 6563     sum(task_exec
+0001d790: 5f64 6174 615b 6622 7b61 6374 6976 6974  _data[f"{activit
+0001d7a0: 797d 5f7b 7365 6c66 2e75 6e69 745f 7365  y}_{self.unit_se
+0001d7b0: 6c65 6374 6564 7d22 5d29 0a20 2020 2020  lected}"]).     
+0001d7c0: 2020 2020 2020 2020 2020 202f 2073 756d             / sum
+0001d7d0: 2870 6965 6368 6172 745f 6461 7461 5b22  (piechart_data["
+0001d7e0: 7661 6c75 6522 5d29 0a20 2020 2020 2020  value"]).       
+0001d7f0: 2020 2020 2020 2020 2069 6620 7375 6d28           if sum(
+0001d800: 7069 6563 6861 7274 5f64 6174 615b 2276  piechart_data["v
+0001d810: 616c 7565 225d 290a 2020 2020 2020 2020  alue"]).        
+0001d820: 2020 2020 2020 2020 656c 7365 2030 2020          else 0  
+0001d830: 2320 6d61 7920 6e6f 7420 6861 7665 2061  # may not have a
+0001d840: 6e79 2062 7974 6573 206d 6f76 656d 656e  ny bytes movemen
+0001d850: 7420 7265 706f 7274 6564 2c20 6176 6f69  t reported, avoi
+0001d860: 6420 6469 7669 6465 2062 7920 7a65 726f  d divide by zero
+0001d870: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001d880: 2020 2020 2020 2020 2020 202a 2032 0a20             * 2. 
+0001d890: 2020 2020 2020 2020 2020 202a 206d 6174             * mat
+0001d8a0: 682e 7069 0a20 2020 2020 2020 2020 2020  h.pi.           
+0001d8b0: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
+0001d8c0: 2073 656c 662e 7461 736b 5f61 6374 6976   self.task_activ
+0001d8d0: 6974 6965 730a 2020 2020 2020 2020 5d0a  ities.        ].
+0001d8e0: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
+0001d8f0: 5f64 6174 615b 2263 6f6c 6f72 225d 203d  _data["color"] =
+0001d900: 2073 656c 662e 5f67 6574 5f70 616c 6574   self._get_palet
+0001d910: 7465 286c 656e 2873 656c 662e 7461 736b  te(len(self.task
+0001d920: 5f61 6374 6976 6974 6965 7329 290a 2020  _activities)).  
+0001d930: 2020 2020 2020 7069 6563 6861 7274 5f64        piechart_d
+0001d940: 6174 615b 2261 6374 6976 6974 7922 5d20  ata["activity"] 
+0001d950: 3d20 7365 6c66 2e74 6173 6b5f 6163 7469  = self.task_acti
+0001d960: 7669 7469 6573 0a20 2020 2020 2020 2073  vities.        s
+0001d970: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
+0001d980: 5f61 6374 6976 6974 795f 7372 632e 6461  _activity_src.da
+0001d990: 7461 203d 2070 6965 6368 6172 745f 6461  ta = piechart_da
+0001d9a0: 7461 0a0a 2020 2020 2020 2020 6966 2073  ta..        if s
+0001d9b0: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
+0001d9c0: 5f61 6374 6976 6974 795f 6368 6172 7420  _activity_chart 
+0001d9d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001d9e0: 2020 2020 2070 6965 6368 6172 7420 3d20       piechart = 
+0001d9f0: 6669 6775 7265 280a 2020 2020 2020 2020  figure(.        
+0001da00: 2020 2020 2020 2020 6865 6967 6874 3d35          height=5
+0001da10: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+0001da20: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
+0001da30: 2273 6361 6c65 5f62 6f74 6822 2c0a 2020  "scale_both",.  
+0001da40: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0001da50: 746c 653d 2254 6173 6b20 6578 6563 7574  tle="Task execut
+0001da60: 696f 6e2c 2062 7920 6163 7469 7669 7479  ion, by activity
+0001da70: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001da80: 2020 2074 6f6f 6c73 3d22 686f 7665 7222     tools="hover"
+0001da90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001daa0: 2020 746f 6f6c 7469 7073 3d22 407b 6163    tooltips="@{ac
+0001dab0: 7469 7669 7479 7d3a 2040 7465 7874 222c  tivity}: @text",
+0001dac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dad0: 2078 5f72 616e 6765 3d28 2d30 2e35 2c20   x_range=(-0.5, 
+0001dae0: 312e 3029 2c0a 2020 2020 2020 2020 2020  1.0),.          
+0001daf0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001db00: 7069 6563 6861 7274 2e61 7869 732e 6178  piechart.axis.ax
+0001db10: 6973 5f6c 6162 656c 203d 204e 6f6e 650a  is_label = None.
+0001db20: 2020 2020 2020 2020 2020 2020 7069 6563              piec
+0001db30: 6861 7274 2e61 7869 732e 7669 7369 626c  hart.axis.visibl
+0001db40: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+0001db50: 2020 2020 2020 7069 6563 6861 7274 2e67        piechart.g
+0001db60: 7269 642e 6772 6964 5f6c 696e 655f 636f  rid.grid_line_co
+0001db70: 6c6f 7220 3d20 4e6f 6e65 0a0a 2020 2020  lor = None..    
+0001db80: 2020 2020 2020 2020 7069 6563 6861 7274          piechart
+0001db90: 2e77 6564 6765 280a 2020 2020 2020 2020  .wedge(.        
+0001dba0: 2020 2020 2020 2020 783d 302c 0a20 2020          x=0,.   
+0001dbb0: 2020 2020 2020 2020 2020 2020 2079 3d31               y=1
 0001dbc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001dbd0: 2020 783d 2266 756e 6374 696f 6e73 222c    x="functions",
-0001dbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dbf0: 2077 6964 7468 3d30 2e39 2c0a 2020 2020   width=0.9,.    
-0001dc00: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0001dc10: 6365 3d73 656c 662e 7461 736b 5f65 7865  ce=self.task_exe
-0001dc20: 635f 6279 5f70 7265 6669 785f 7372 632c  c_by_prefix_src,
-0001dc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dc40: 2063 6f6c 6f72 3d73 6d61 6c6c 5f70 616c   color=small_pal
-0001dc50: 6574 7465 735b 2259 6c47 6e42 7522 5d2e  ettes["YlGnBu"].
-0001dc60: 6765 7428 6c65 6e28 7365 6c66 2e74 6173  get(len(self.tas
-0001dc70: 6b5f 6163 7469 7669 7469 6573 292c 205b  k_activities), [
-0001dc80: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001dc90: 2020 2020 6c65 6765 6e64 5f6c 6162 656c      legend_label
-0001dca0: 3d73 656c 662e 7461 736b 5f61 6374 6976  =self.task_activ
-0001dcb0: 6974 6965 732c 0a20 2020 2020 2020 2020  ities,.         
-0001dcc0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001dcd0: 2066 6f72 2076 6261 7220 696e 2072 656e   for vbar in ren
-0001dce0: 6465 7265 7273 3a0a 2020 2020 2020 2020  derers:.        
-0001dcf0: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
-0001dd00: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001dd10: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-0001dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd30: 2020 2076 6261 722e 6e61 6d65 2c0a 2020     vbar.name,.  
-0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd50: 2020 2020 2020 6622 407b 7b7b 7662 6172        f"@{{{vbar
-0001dd60: 2e6e 616d 657d 5f74 6578 747d 7d22 2c0a  .name}_text}}",.
-0001dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd80: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001dd90: 2020 2020 2020 2020 2020 2028 2266 756e             ("fun
-0001dda0: 6374 696f 6e22 2c20 2240 6675 6e63 7469  ction", "@functi
-0001ddb0: 6f6e 7322 292c 0a20 2020 2020 2020 2020  ons"),.         
-0001ddc0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0001ddd0: 2020 2020 2020 2020 2062 6172 6368 6172           barchar
-0001dde0: 742e 6164 645f 746f 6f6c 7328 486f 7665  t.add_tools(Hove
-0001ddf0: 7254 6f6f 6c28 746f 6f6c 7469 7073 3d74  rTool(tooltips=t
-0001de00: 6f6f 6c74 6970 732c 2072 656e 6465 7265  ooltips, rendere
-0001de10: 7273 3d5b 7662 6172 5d29 290a 0a20 2020  rs=[vbar]))..   
-0001de20: 2020 2020 2020 2020 2069 6620 616e 7928           if any(
-0001de30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001de40: 206c 656e 2873 656c 662e 7461 736b 5f65   len(self.task_e
-0001de50: 7865 635f 6279 5f70 7265 6669 785f 7372  xec_by_prefix_sr
-0001de60: 632e 6461 7461 5b6b 5d29 2021 3d20 6c65  c.data[k]) != le
-0001de70: 6e28 7461 736b 5f65 7865 635f 6461 7461  n(task_exec_data
-0001de80: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
-0001de90: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
-0001dea0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
-0001deb0: 7072 6566 6978 5f73 7263 2e64 6174 610a  prefix_src.data.
-0001dec0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0001ded0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001dee0: 656c 662e 7375 6273 7461 6e74 6961 6c5f  elf.substantial_
-0001def0: 6368 616e 6765 203d 2054 7275 650a 0a20  change = True.. 
-0001df00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001df10: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
-0001df20: 6669 785f 7372 632e 6461 7461 203d 2064  fix_src.data = d
-0001df30: 6963 7428 7461 736b 5f65 7865 635f 6461  ict(task_exec_da
-0001df40: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
-0001df50: 6261 7263 6861 7274 2e72 656e 6465 7265  barchart.rendere
-0001df60: 7273 203d 2072 656e 6465 7265 7273 0a20  rs = renderers. 
-0001df70: 2020 2020 2020 2072 6574 7572 6e20 6261         return ba
-0001df80: 7263 6861 7274 0a0a 2020 2020 6465 6620  rchart..    def 
-0001df90: 5f62 7569 6c64 5f73 656e 6464 6174 615f  _build_senddata_
-0001dfa0: 6368 6172 7428 7365 6c66 2c20 7365 6e64  chart(self, send
-0001dfb0: 6461 7461 3a20 6465 6661 756c 7464 6963  data: defaultdic
-0001dfc0: 745b 7374 722c 206c 6973 745d 2920 2d3e  t[str, list]) ->
-0001dfd0: 2066 6967 7572 653a 0a20 2020 2020 2020   figure:.       
-0001dfe0: 2070 6965 6461 7461 203d 207b 7d0a 2020   piedata = {}.  
-0001dff0: 2020 2020 2020 7069 6564 6174 615b 2261        piedata["a
-0001e000: 6374 6976 6974 7922 5d20 3d20 7365 6e64  ctivity"] = send
-0001e010: 6461 7461 5b22 6163 7469 7669 7479 225d  data["activity"]
-0001e020: 0a20 2020 2020 2020 2070 6965 6461 7461  .        piedata
-0001e030: 5b22 7661 6c75 6522 5d20 3d20 5b0a 2020  ["value"] = [.  
-0001e040: 2020 2020 2020 2020 2020 2873 756d 2873            (sum(s
-0001e050: 656e 6464 6174 615b 6622 7b6f 707d 5f7b  enddata[f"{op}_{
-0001e060: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
-0001e070: 6564 7d22 5d29 2920 666f 7220 6f70 2069  ed}"])) for op i
-0001e080: 6e20 7365 6e64 6461 7461 5b22 6163 7469  n senddata["acti
-0001e090: 7669 7479 225d 0a20 2020 2020 2020 205d  vity"].        ]
-0001e0a0: 0a20 2020 2020 2020 2070 6965 6461 7461  .        piedata
-0001e0b0: 5b22 7465 7874 225d 203d 205b 7365 6c66  ["text"] = [self
-0001e0c0: 2e66 6f72 6d61 7428 7365 6c66 2e75 6e69  .format(self.uni
-0001e0d0: 745f 7365 6c65 6374 6564 2c20 7629 2066  t_selected, v) f
-0001e0e0: 6f72 2076 2069 6e20 7069 6564 6174 615b  or v in piedata[
-0001e0f0: 2276 616c 7565 225d 5d0a 2020 2020 2020  "value"]].      
-0001e100: 2020 7069 6564 6174 615b 2261 6e67 6c65    piedata["angle
-0001e110: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
-0001e120: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-0001e130: 2020 2020 2028 7375 6d28 7365 6e64 6461       (sum(sendda
-0001e140: 7461 5b66 227b 6f70 7d5f 7b73 656c 662e  ta[f"{op}_{self.
-0001e150: 756e 6974 5f73 656c 6563 7465 647d 225d  unit_selected}"]
-0001e160: 2920 2f20 7375 6d28 7069 6564 6174 615b  ) / sum(piedata[
-0001e170: 2276 616c 7565 225d 2929 0a20 2020 2020  "value"])).     
-0001e180: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-0001e190: 6d28 7069 6564 6174 615b 2276 616c 7565  m(piedata["value
-0001e1a0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-0001e1b0: 2020 2020 656c 7365 2030 2e30 0a20 2020      else 0.0.   
-0001e1c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001e1d0: 2020 2020 2020 202a 2032 0a20 2020 2020         * 2.     
-0001e1e0: 2020 2020 2020 202a 206d 6174 682e 7069         * math.pi
-0001e1f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001e200: 206f 7020 696e 2070 6965 6461 7461 5b22   op in piedata["
-0001e210: 6163 7469 7669 7479 225d 0a20 2020 2020  activity"].     
-0001e220: 2020 205d 0a20 2020 2020 2020 2070 6965     ].        pie
-0001e230: 6461 7461 5b22 636f 6c6f 7222 5d20 3d20  data["color"] = 
-0001e240: 736d 616c 6c5f 7061 6c65 7474 6573 5b22  small_palettes["
-0001e250: 596c 476e 4275 225d 2e67 6574 286c 656e  YlGnBu"].get(len
-0001e260: 2870 6965 6461 7461 5b22 6163 7469 7669  (piedata["activi
-0001e270: 7479 225d 292c 205b 5d29 0a0a 2020 2020  ty"]), [])..    
-0001e280: 2020 2020 7365 6c66 2e73 656e 6473 7263      self.sendsrc
-0001e290: 2e64 6174 6120 3d20 7069 6564 6174 610a  .data = piedata.
-0001e2a0: 2020 2020 2020 2020 7365 6e64 6461 7461          senddata
-0001e2b0: 5f70 6965 6368 6172 7420 3d20 6669 6775  _piechart = figu
-0001e2c0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-0001e2d0: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
-0001e2e0: 2020 2020 2020 2020 7369 7a69 6e67 5f6d          sizing_m
-0001e2f0: 6f64 653d 2273 6361 6c65 5f62 6f74 6822  ode="scale_both"
-0001e300: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-0001e310: 746c 653d 2253 656e 6420 6461 7461 2c20  tle="Send data, 
-0001e320: 6279 2061 6374 6976 6974 7922 2c0a 2020  by activity",.  
-0001e330: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-0001e340: 2268 6f76 6572 222c 0a20 2020 2020 2020  "hover",.       
-0001e350: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
-0001e360: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
-0001e370: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0001e380: 785f 7261 6e67 653d 282d 302e 352c 2031  x_range=(-0.5, 1
-0001e390: 2e30 292c 0a20 2020 2020 2020 2029 0a20  .0),.        ). 
-0001e3a0: 2020 2020 2020 2073 656e 6464 6174 615f         senddata_
-0001e3b0: 7069 6563 6861 7274 2e77 6564 6765 280a  piechart.wedge(.
-0001e3c0: 2020 2020 2020 2020 2020 2020 783d 302c              x=0,
-0001e3d0: 0a20 2020 2020 2020 2020 2020 2079 3d31  .            y=1
-0001e3e0: 2c0a 2020 2020 2020 2020 2020 2020 7261  ,.            ra
-0001e3f0: 6469 7573 3d30 2e34 2c0a 2020 2020 2020  dius=0.4,.      
-0001e400: 2020 2020 2020 7374 6172 745f 616e 676c        start_angl
-0001e410: 653d 6375 6d73 756d 2822 616e 676c 6522  e=cumsum("angle"
-0001e420: 2c20 696e 636c 7564 655f 7a65 726f 3d54  , include_zero=T
-0001e430: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
-0001e440: 2020 656e 645f 616e 676c 653d 6375 6d73    end_angle=cums
-0001e450: 756d 2822 616e 676c 6522 292c 0a20 2020  um("angle"),.   
-0001e460: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
-0001e470: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
-0001e480: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
-0001e490: 6c6f 723d 2263 6f6c 6f72 222c 0a20 2020  lor="color",.   
-0001e4a0: 2020 2020 2020 2020 206c 6567 656e 645f           legend_
-0001e4b0: 6669 656c 643d 2261 6374 6976 6974 7922  field="activity"
-0001e4c0: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
-0001e4d0: 7572 6365 3d73 656c 662e 7365 6e64 7372  urce=self.sendsr
-0001e4e0: 632c 0a20 2020 2020 2020 2029 0a20 2020  c,.        ).   
-0001e4f0: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
-0001e500: 6563 6861 7274 2e61 7869 732e 6178 6973  echart.axis.axis
-0001e510: 5f6c 6162 656c 203d 204e 6f6e 650a 2020  _label = None.  
-0001e520: 2020 2020 2020 7365 6e64 6461 7461 5f70        senddata_p
-0001e530: 6965 6368 6172 742e 6178 6973 2e76 6973  iechart.axis.vis
-0001e540: 6962 6c65 203d 2046 616c 7365 0a20 2020  ible = False.   
-0001e550: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
-0001e560: 6563 6861 7274 2e67 7269 642e 6772 6964  echart.grid.grid
-0001e570: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
-0001e580: 6e65 0a20 2020 2020 2020 2072 6574 7572  ne.        retur
-0001e590: 6e20 7365 6e64 6461 7461 5f70 6965 6368  n senddata_piech
-0001e5a0: 6172 740a 0a0a 636c 6173 7320 436f 6e74  art...class Cont
-0001e5b0: 656e 7469 6f6e 2844 6173 6862 6f61 7264  ention(Dashboard
-0001e5c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-0001e5d0: 2222 220a 2020 2020 4576 656e 7420 4c6f  """.    Event Lo
-0001e5e0: 6f70 2048 6561 6c74 6820 2861 6e64 2047  op Health (and G
-0001e5f0: 494c 2043 6f6e 7465 6e74 696f 6e2c 2069  IL Contention, i
-0001e600: 6620 636f 6e66 6967 7572 6564 290a 2020  f configured).  
-0001e610: 2020 2222 220a 0a20 2020 2040 6c6f 675f    """..    @log_
-0001e620: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
-0001e630: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
-0001e640: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
-0001e650: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-0001e660: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
-0001e670: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
-0001e680: 656c 662e 6461 7461 203d 2064 6963 7428  elf.data = dict(
-0001e690: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-0001e6a0: 6573 3d5b 0a20 2020 2020 2020 2020 2020  es=[.           
-0001e6b0: 2020 2020 2028 2253 6368 6564 756c 6572       ("Scheduler
-0001e6c0: 222c 2022 4576 656e 7420 4c6f 6f70 2229  ", "Event Loop")
-0001e6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e6e0: 2020 2822 5363 6865 6475 6c65 7222 2c20    ("Scheduler", 
-0001e6f0: 2247 494c 2043 6f6e 7465 6e74 696f 6e22  "GIL Contention"
-0001e700: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001e710: 2020 2028 2257 6f72 6b65 7273 222c 2022     ("Workers", "
-0001e720: 4576 656e 7420 4c6f 6f70 2229 2c0a 2020  Event Loop"),.  
-0001e730: 2020 2020 2020 2020 2020 2020 2020 2822                ("
-0001e740: 576f 726b 6572 7322 2c20 2247 494c 2043  Workers", "GIL C
-0001e750: 6f6e 7465 6e74 696f 6e22 292c 0a20 2020  ontention"),.   
-0001e760: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0001e770: 2020 2020 2020 2020 7661 6c75 6573 3d5b          values=[
-0001e780: 302c 2030 2c20 302c 2030 5d2c 0a20 2020  0, 0, 0, 0],.   
-0001e790: 2020 2020 2020 2020 2074 6578 743d 5b22           text=["
-0001e7a0: 3073 222c 2022 3025 222c 2022 3073 222c  0s", "0%", "0s",
-0001e7b0: 2022 3025 225d 2c0a 2020 2020 2020 2020   "0%"],.        
-0001e7c0: 290a 2020 2020 2020 2020 7469 746c 6520  ).        title 
-0001e7d0: 3d20 2245 7665 6e74 204c 6f6f 7020 2620  = "Event Loop & 
-0001e7e0: 4749 4c20 436f 6e74 656e 7469 6f6e 220a  GIL Contention".
-0001e7f0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-0001e800: 6520 4749 4c20 7265 6c61 7465 6420 6e61  e GIL related na
-0001e810: 6d65 732f 7661 6c75 6573 2069 6620 6e6f  mes/values if no
-0001e820: 7420 6d6f 6e69 746f 7269 6e67 2047 494c  t monitoring GIL
-0001e830: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001e840: 7365 6c66 2e73 6368 6564 756c 6572 2e6d  self.scheduler.m
-0001e850: 6f6e 6974 6f72 2e6d 6f6e 6974 6f72 5f67  onitor.monitor_g
-0001e860: 696c 5f63 6f6e 7465 6e74 696f 6e3a 0a20  il_contention:. 
-0001e870: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-0001e880: 203d 2022 4576 656e 7420 4c6f 6f70 220a   = "Event Loop".
-0001e890: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001e8a0: 6b65 7920 696e 2073 656c 662e 6461 7461  key in self.data
-0001e8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e8c0: 2020 7365 6c66 2e64 6174 615b 6b65 795d    self.data[key]
-0001e8d0: 203d 2073 656c 662e 6461 7461 5b6b 6579   = self.data[key
-0001e8e0: 5d5b 3a3a 325d 0a0a 2020 2020 2020 2020  ][::2]..        
-0001e8f0: 7365 6c66 2e73 6f75 7263 6520 3d20 436f  self.source = Co
-0001e900: 6c75 6d6e 4461 7461 536f 7572 6365 2864  lumnDataSource(d
-0001e910: 6174 613d 7365 6c66 2e64 6174 6129 0a20  ata=self.data). 
-0001e920: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001e930: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-0001e940: 2020 2020 2020 2074 6974 6c65 3d74 6974         title=tit
-0001e950: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-0001e960: 785f 7261 6e67 653d 4661 6374 6f72 5261  x_range=FactorRa
-0001e970: 6e67 6528 2a73 656c 662e 6461 7461 5b22  nge(*self.data["
-0001e980: 6e61 6d65 7322 5d29 2c0a 2020 2020 2020  names"]),.      
-0001e990: 2020 2020 2020 795f 7261 6e67 653d 2830        y_range=(0
-0001e9a0: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
-0001e9b0: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
-0001e9c0: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
-0001e9d0: 6c6f 6361 7469 6f6e 3d22 6162 6f76 6522  location="above"
-0001e9e0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-0001e9f0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-0001ea00: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0001ea10: 6f6f 742e 7662 6172 280a 2020 2020 2020  oot.vbar(.      
-0001ea20: 2020 2020 2020 783d 226e 616d 6573 222c        x="names",
-0001ea30: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-0001ea40: 3d22 7661 6c75 6573 222c 0a20 2020 2020  ="values",.     
-0001ea50: 2020 2020 2020 2077 6964 7468 3d30 2e39         width=0.9
-0001ea60: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-0001ea70: 6e65 5f63 6f6c 6f72 3d22 7768 6974 6522  ne_color="white"
-0001ea80: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
-0001ea90: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0001eaa0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-0001eab0: 6c6c 5f63 6f6c 6f72 3d66 6163 746f 725f  ll_color=factor_
-0001eac0: 636d 6170 280a 2020 2020 2020 2020 2020  cmap(.          
-0001ead0: 2020 2020 2020 6669 656c 645f 6e61 6d65        field_name
-0001eae0: 3d22 6e61 6d65 7322 2c0a 2020 2020 2020  ="names",.      
-0001eaf0: 2020 2020 2020 2020 2020 7061 6c65 7474            palett
-0001eb00: 653d 5b22 2362 3865 3063 6522 2c20 2223  e=["#b8e0ce", "#
-0001eb10: 3831 6161 6534 225d 2c0a 2020 2020 2020  81aae4"],.      
-0001eb20: 2020 2020 2020 2020 2020 6661 6374 6f72            factor
-0001eb30: 733d 5b22 4576 656e 7420 4c6f 6f70 222c  s=["Event Loop",
-0001eb40: 2022 4749 4c20 436f 6e74 656e 7469 6f6e   "GIL Contention
-0001eb50: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0001eb60: 2020 2020 7374 6172 743d 312c 0a20 2020      start=1,.   
-0001eb70: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-0001eb80: 3d32 2c0a 2020 2020 2020 2020 2020 2020  =2,.            
-0001eb90: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0001eba0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001ebb0: 785f 7261 6e67 652e 6772 6f75 705f 7061  x_range.group_pa
-0001ebc0: 6464 696e 6720 3d20 302e 3235 0a20 2020  dding = 0.25.   
-0001ebd0: 2020 2020 2073 656c 662e 726f 6f74 2e78       self.root.x
-0001ebe0: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
-0001ebf0: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
-0001ec00: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001ec10: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
-0001ec20: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
-0001ec30: 6c66 2e72 6f6f 742e 7867 7269 642e 7669  lf.root.xgrid.vi
-0001ec40: 7369 626c 6520 3d20 4661 6c73 650a 0a20  sible = False.. 
-0001ec50: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
-0001ec60: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
-0001ec70: 2020 2020 2020 746f 6f6c 7469 7073 3d5b        tooltips=[
-0001ec80: 2822 4e61 6d65 222c 2022 406e 616d 6573  ("Name", "@names
-0001ec90: 2229 2c20 2822 5661 6c75 6522 2c20 2240  "), ("Value", "@
-0001eca0: 7465 7874 2229 5d2c 206d 6f64 653d 2276  text")], mode="v
-0001ecb0: 6c69 6e65 220a 2020 2020 2020 2020 290a  line".        ).
-0001ecc0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001ecd0: 742e 6164 645f 746f 6f6c 7328 686f 7665  t.add_tools(hove
-0001ece0: 7229 0a0a 2020 2020 4077 6974 686f 7574  r)..    @without
-0001ecf0: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
-0001ed00: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
-0001ed10: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
-0001ed20: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
-0001ed30: 2020 2073 203d 2073 656c 662e 7363 6865     s = self.sche
-0001ed40: 6475 6c65 720a 2020 2020 2020 2020 6d6f  duler.        mo
-0001ed50: 6e69 746f 725f 6769 6c20 3d20 732e 6d6f  nitor_gil = s.mo
-0001ed60: 6e69 746f 722e 6d6f 6e69 746f 725f 6769  nitor.monitor_gi
-0001ed70: 6c5f 636f 6e74 656e 7469 6f6e 0a0a 2020  l_contention..  
-0001ed80: 2020 2020 2020 7365 6c66 2e64 6174 615b        self.data[
-0001ed90: 2276 616c 7565 7322 5d20 3d20 5b0a 2020  "values"] = [.  
-0001eda0: 2020 2020 2020 2020 2020 732e 5f74 6963            s._tic
-0001edb0: 6b5f 696e 7465 7276 616c 5f6f 6273 6572  k_interval_obser
-0001edc0: 7665 642c 0a20 2020 2020 2020 2020 2020  ved,.           
-0001edd0: 2073 656c 662e 6769 6c5f 636f 6e74 656e   self.gil_conten
-0001ede0: 7469 6f6e 5f73 6368 6564 756c 6572 2c0a  tion_scheduler,.
-0001edf0: 2020 2020 2020 2020 2020 2020 7375 6d28              sum(
-0001ee00: 772e 6d65 7472 6963 735b 2265 7665 6e74  w.metrics["event
-0001ee10: 5f6c 6f6f 705f 696e 7465 7276 616c 225d  _loop_interval"]
-0001ee20: 2066 6f72 2077 2069 6e20 732e 776f 726b   for w in s.work
-0001ee30: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
-0001ee40: 2020 2020 2020 2020 2020 2f20 286c 656e            / (len
-0001ee50: 2873 2e77 6f72 6b65 7273 2920 6f72 2031  (s.workers) or 1
-0001ee60: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-0001ee70: 656c 662e 6769 6c5f 636f 6e74 656e 7469  elf.gil_contenti
-0001ee80: 6f6e 5f77 6f72 6b65 7273 2c0a 2020 2020  on_workers,.    
-0001ee90: 2020 2020 5d5b 3a3a 2031 2069 6620 6d6f      ][:: 1 if mo
-0001eea0: 6e69 746f 725f 6769 6c20 656c 7365 2032  nitor_gil else 2
-0001eeb0: 5d0a 0a20 2020 2020 2020 2023 2046 6f72  ]..        # For
-0001eec0: 6d61 7420 6576 656e 7420 6c6f 6f70 2061  mat event loop a
-0001eed0: 7320 7469 6d65 2061 6e64 2047 494c 2028  s time and GIL (
-0001eee0: 6966 2063 6f6e 6669 6775 7265 6429 2061  if configured) a
-0001eef0: 7320 250a 2020 2020 2020 2020 7365 6c66  s %.        self
-0001ef00: 2e64 6174 615b 2274 6578 7422 5d20 3d20  .data["text"] = 
-0001ef10: 5b0a 2020 2020 2020 2020 2020 2020 6622  [.            f"
-0001ef20: 7b78 202a 2031 3030 3a2e 3166 7d25 2220  {x * 100:.1f}%" 
-0001ef30: 6966 2069 2025 2032 2061 6e64 206d 6f6e  if i % 2 and mon
-0001ef40: 6974 6f72 5f67 696c 2065 6c73 6520 666f  itor_gil else fo
-0001ef50: 726d 6174 5f74 696d 6528 7829 0a20 2020  rmat_time(x).   
-0001ef60: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-0001ef70: 7820 696e 2065 6e75 6d65 7261 7465 2873  x in enumerate(s
-0001ef80: 656c 662e 6461 7461 5b22 7661 6c75 6573  elf.data["values
-0001ef90: 225d 290a 2020 2020 2020 2020 5d0a 2020  "]).        ].  
-0001efa0: 2020 2020 2020 7570 6461 7465 2873 656c        update(sel
-0001efb0: 662e 736f 7572 6365 2c20 7365 6c66 2e64  f.source, self.d
-0001efc0: 6174 6129 0a0a 2020 2020 4070 726f 7065  ata)..    @prope
-0001efd0: 7274 790a 2020 2020 6465 6620 6769 6c5f  rty.    def gil_
-0001efe0: 636f 6e74 656e 7469 6f6e 5f77 6f72 6b65  contention_worke
-0001eff0: 7273 2873 656c 6629 202d 3e20 666c 6f61  rs(self) -> floa
-0001f000: 743a 0a20 2020 2020 2020 2077 6f72 6b65  t:.        worke
-0001f010: 7273 203d 2073 656c 662e 7363 6865 6475  rs = self.schedu
-0001f020: 6c65 722e 776f 726b 6572 730a 2020 2020  ler.workers.    
-0001f030: 2020 2020 6966 2077 6f72 6b65 7273 3a0a      if workers:.
-0001f040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001f050: 726e 2073 756d 280a 2020 2020 2020 2020  rn sum(.        
-0001f060: 2020 2020 2020 2020 772e 6d65 7472 6963          w.metric
-0001f070: 732e 6765 7428 2267 696c 5f63 6f6e 7465  s.get("gil_conte
-0001f080: 6e74 696f 6e22 2c20 3029 2066 6f72 2077  ntion", 0) for w
-0001f090: 2069 6e20 776f 726b 6572 732e 7661 6c75   in workers.valu
-0001f0a0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-0001f0b0: 2029 202f 206c 656e 2877 6f72 6b65 7273   ) / len(workers
-0001f0c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001f0d0: 2066 6c6f 6174 2822 4e61 4e22 290a 0a20   float("NaN").. 
-0001f0e0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-0001f0f0: 2064 6566 2067 696c 5f63 6f6e 7465 6e74   def gil_content
-0001f100: 696f 6e5f 7363 6865 6475 6c65 7228 7365  ion_scheduler(se
-0001f110: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-0001f120: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001f130: 662e 7363 6865 6475 6c65 722e 6d6f 6e69  f.scheduler.moni
-0001f140: 746f 722e 7265 6365 6e74 2829 2e67 6574  tor.recent().get
-0001f150: 2822 6769 6c5f 636f 6e74 656e 7469 6f6e  ("gil_contention
-0001f160: 222c 2066 6c6f 6174 2822 4e61 4e22 2929  ", float("NaN"))
-0001f170: 0a0a 0a63 6c61 7373 2045 7863 6570 7469  ...class Excepti
-0001f180: 6f6e 7354 6162 6c65 2844 6173 6862 6f61  onsTable(Dashboa
-0001f190: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-0001f1a0: 2020 2222 220a 2020 2020 4578 6365 7074    """.    Except
-0001f1b0: 696f 6e73 206c 6f67 6765 6420 696e 2074  ions logged in t
-0001f1c0: 6173 6b73 2e0a 0a20 2020 2053 696e 6365  asks...    Since
-0001f1d0: 2074 6865 7265 206d 6967 6874 2062 6520   there might be 
-0001f1e0: 6d61 6e79 2072 656c 6174 6564 2065 7863  many related exc
-0001f1f0: 6570 7469 6f6e 7320 2865 2e67 2e2c 2061  eptions (e.g., a
-0001f200: 6c6c 2074 6173 6b73 2069 6e20 6120 6769  ll tasks in a gi
-0001f210: 7665 6e0a 2020 2020 7461 736b 2067 726f  ven.    task gro
-0001f220: 7570 2066 6169 6c20 666f 7220 7468 6520  up fail for the 
-0001f230: 7361 6d65 2072 6561 736f 6e29 2c20 7765  same reason), we
-0001f240: 206d 616b 6520 6120 6265 7374 2d65 6666   make a best-eff
-0001f250: 6f72 7420 6174 7465 6d70 7420 746f 0a20  ort attempt to. 
-0001f260: 2020 2028 3129 2061 6767 7265 6761 7465     (1) aggregate
-0001f270: 2074 6f20 7468 6520 7461 736b 2067 726f   to the task gro
-0001f280: 7570 2c20 616e 6420 2832 2920 6465 6475  up, and (2) dedu
-0001f290: 706c 6963 6174 6520 7369 6d69 6c61 7220  plicate similar 
-0001f2a0: 6c6f 6f6b 696e 6720 7461 736b 732e 0a20  looking tasks.. 
-0001f2b0: 2020 2022 2222 0a0a 2020 2020 7363 6865     """..    sche
-0001f2c0: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
-0001f2d0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-0001f2e0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-0001f2f0: 6572 3a20 5363 6865 6475 6c65 722c 2077  er: Scheduler, w
-0001f300: 6964 7468 3a20 696e 7420 3d20 3130 3030  idth: int = 1000
-0001f310: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
-0001f320: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-0001f330: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-0001f340: 756c 6572 0a0a 2020 2020 2020 2020 7365  uler..        se
-0001f350: 6c66 2e6e 616d 6573 203d 205b 0a20 2020  lf.names = [.   
-0001f360: 2020 2020 2020 2020 2022 5461 736b 222c           "Task",
-0001f370: 0a20 2020 2020 2020 2020 2020 2022 4578  .            "Ex
-0001f380: 6365 7074 696f 6e22 2c0a 2020 2020 2020  ception",.      
-0001f390: 2020 2020 2020 2254 7261 6365 6261 636b        "Traceback
-0001f3a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0001f3b0: 576f 726b 6572 2873 2922 2c0a 2020 2020  Worker(s)",.    
-0001f3c0: 2020 2020 2020 2020 2243 6f75 6e74 222c          "Count",
-0001f3d0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
-0001f3e0: 2020 2020 7365 6c66 2e73 6f75 7263 6520      self.source 
-0001f3f0: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-0001f400: 6365 287b 6b3a 205b 5d20 666f 7220 6b20  ce({k: [] for k 
-0001f410: 696e 2073 656c 662e 6e61 6d65 737d 290a  in self.names}).
-0001f420: 0a20 2020 2020 2020 2063 6f64 655f 666f  .        code_fo
-0001f430: 726d 6174 7465 7220 3d20 4854 4d4c 5465  rmatter = HTMLTe
-0001f440: 6d70 6c61 7465 466f 726d 6174 7465 7228  mplateFormatter(
-0001f450: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-0001f460: 706c 6174 653d 273c 636f 6465 2074 6974  plate='<code tit
-0001f470: 6c65 3d22 3c25 2d20 7661 6c75 6520 253e  le="<%- value %>
-0001f480: 223e 3c25 3d20 7661 6c75 6520 253e 3c2f  "><%= value %></
-0001f490: 636f 6465 3e27 0a20 2020 2020 2020 2029  code>'.        )
-0001f4a0: 0a20 2020 2020 2020 2063 6f6c 756d 6e73  .        columns
-0001f4b0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0001f4c0: 2054 6162 6c65 436f 6c75 6d6e 280a 2020   TableColumn(.  
-0001f4d0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001f4e0: 656c 643d 2254 6173 6b22 2c0a 2020 2020  eld="Task",.    
-0001f4f0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0001f500: 653d 2254 6173 6b22 2c0a 2020 2020 2020  e="Task",.      
-0001f510: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0001f520: 7465 723d 636f 6465 5f66 6f72 6d61 7474  ter=code_formatt
-0001f530: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0001f540: 2020 2020 7769 6474 683d 3135 302c 0a20      width=150,. 
-0001f550: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001f560: 2020 2020 2020 2020 2020 5461 626c 6543            TableC
-0001f570: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
-0001f580: 2020 2020 2020 2066 6965 6c64 3d22 4578         field="Ex
-0001f590: 6365 7074 696f 6e22 2c0a 2020 2020 2020  ception",.      
-0001f5a0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0001f5b0: 2245 7863 6570 7469 6f6e 222c 0a20 2020  "Exception",.   
-0001f5c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001f5d0: 6d61 7474 6572 3d63 6f64 655f 666f 726d  matter=code_form
-0001f5e0: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
-0001f5f0: 2020 2020 2020 2077 6964 7468 3d33 3030         width=300
-0001f600: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-0001f610: 0a20 2020 2020 2020 2020 2020 2054 6162  .            Tab
-0001f620: 6c65 436f 6c75 6d6e 280a 2020 2020 2020  leColumn(.      
-0001f630: 2020 2020 2020 2020 2020 6669 656c 643d            field=
-0001f640: 2254 7261 6365 6261 636b 222c 0a20 2020  "Traceback",.   
-0001f650: 2020 2020 2020 2020 2020 2020 2074 6974               tit
-0001f660: 6c65 3d22 5472 6163 6562 6163 6b22 2c0a  le="Traceback",.
-0001f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f680: 666f 726d 6174 7465 723d 636f 6465 5f66  formatter=code_f
-0001f690: 6f72 6d61 7474 6572 2c0a 2020 2020 2020  ormatter,.      
-0001f6a0: 2020 2020 2020 2020 2020 7769 6474 683d            width=
-0001f6b0: 3330 302c 0a20 2020 2020 2020 2020 2020  300,.           
-0001f6c0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0001f6d0: 5461 626c 6543 6f6c 756d 6e28 0a20 2020  TableColumn(.   
-0001f6e0: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-0001f6f0: 6c64 3d22 576f 726b 6572 2873 2922 2c0a  ld="Worker(s)",.
-0001f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f710: 7469 746c 653d 2257 6f72 6b65 7228 7329  title="Worker(s)
-0001f720: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001f730: 2020 2066 6f72 6d61 7474 6572 3d63 6f64     formatter=cod
-0001f740: 655f 666f 726d 6174 7465 722c 0a20 2020  e_formatter,.   
-0001f750: 2020 2020 2020 2020 2020 2020 2077 6964               wid
-0001f760: 7468 3d32 3030 2c0a 2020 2020 2020 2020  th=200,.        
-0001f770: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001f780: 2020 2054 6162 6c65 436f 6c75 6d6e 280a     TableColumn(.
-0001f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7a0: 6669 656c 643d 2243 6f75 6e74 222c 0a20  field="Count",. 
-0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001f7c0: 6974 6c65 3d22 436f 756e 7422 2c0a 2020  itle="Count",.  
-0001f7d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001f7e0: 726d 6174 7465 723d 4e75 6d62 6572 466f  rmatter=NumberFo
-0001f7f0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-0001f800: 302c 3022 292c 0a20 2020 2020 2020 2020  0,0"),.         
-0001f810: 2020 2020 2020 2077 6964 7468 3d35 302c         width=50,
-0001f820: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-0001f830: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
-0001f840: 2020 2069 6620 2273 697a 696e 675f 6d6f     if "sizing_mo
-0001f850: 6465 2220 696e 206b 7761 7267 733a 0a20  de" in kwargs:. 
-0001f860: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
-0001f870: 675f 6d6f 6465 203d 207b 2273 697a 696e  g_mode = {"sizin
-0001f880: 675f 6d6f 6465 223a 206b 7761 7267 735b  g_mode": kwargs[
-0001f890: 2273 697a 696e 675f 6d6f 6465 225d 7d0a  "sizing_mode"]}.
-0001f8a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f8b0: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
-0001f8c0: 5f6d 6f64 6520 3d20 7b7d 0a20 2020 2020  _mode = {}.     
-0001f8d0: 2020 2073 656c 662e 726f 6f74 203d 2044     self.root = D
-0001f8e0: 6174 6154 6162 6c65 280a 2020 2020 2020  ataTable(.      
-0001f8f0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-0001f900: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-0001f910: 2020 2020 2020 636f 6c75 6d6e 733d 636f        columns=co
-0001f920: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
-0001f930: 2020 2072 656f 7264 6572 6162 6c65 3d54     reorderable=T
-0001f940: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0001f950: 2073 6f72 7461 626c 653d 5472 7565 2c0a   sortable=True,.
-0001f960: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0001f970: 683d 7769 6474 682c 0a20 2020 2020 2020  h=width,.       
-0001f980: 2020 2020 2069 6e64 6578 5f70 6f73 6974       index_posit
-0001f990: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-0001f9a0: 2020 2020 2020 2a2a 5f44 4154 4154 4142        **_DATATAB
-0001f9b0: 4c45 5f53 5459 4c45 5348 4545 5453 5f4b  LE_STYLESHEETS_K
-0001f9c0: 5741 5247 532c 0a20 2020 2020 2020 2020  WARGS,.         
-0001f9d0: 2020 202a 2a73 697a 696e 675f 6d6f 6465     **sizing_mode
-0001f9e0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0001f9f0: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
-0001fa00: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
-0001fa10: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
-0001fa20: 6629 3a0a 2020 2020 2020 2020 6e65 775f  f):.        new_
-0001fa30: 6461 7461 203d 207b 6e61 6d65 3a20 5b5d  data = {name: []
-0001fa40: 2066 6f72 206e 616d 6520 696e 2073 656c   for name in sel
-0001fa50: 662e 6e61 6d65 737d 0a20 2020 2020 2020  f.names}.       
-0001fa60: 2065 7272 6564 5f74 6173 6b73 203d 2073   erred_tasks = s
-0001fa70: 656c 662e 7363 6865 6475 6c65 722e 6572  elf.scheduler.er
-0001fa80: 7265 645f 7461 736b 730a 0a20 2020 2020  red_tasks..     
-0001fa90: 2020 2066 6f72 2074 7320 696e 2065 7272     for ts in err
-0001faa0: 6564 5f74 6173 6b73 3a0a 2020 2020 2020  ed_tasks:.      
-0001fab0: 2020 2020 2020 6e65 775f 6461 7461 5b22        new_data["
-0001fac0: 5461 736b 225d 2e61 7070 656e 6428 7473  Task"].append(ts
-0001fad0: 2e6b 6579 290a 2020 2020 2020 2020 2020  .key).          
-0001fae0: 2020 6e65 775f 6461 7461 5b22 4578 6365    new_data["Exce
-0001faf0: 7074 696f 6e22 5d2e 6170 7065 6e64 2874  ption"].append(t
-0001fb00: 732e 6578 6365 7074 696f 6e5f 7465 7874  s.exception_text
-0001fb10: 290a 2020 2020 2020 2020 2020 2020 6e65  ).            ne
-0001fb20: 775f 6461 7461 5b22 5472 6163 6562 6163  w_data["Tracebac
-0001fb30: 6b22 5d2e 6170 7065 6e64 2874 732e 7472  k"].append(ts.tr
-0001fb40: 6163 6562 6163 6b5f 7465 7874 290a 2020  aceback_text).  
-0001fb50: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
-0001fb60: 7461 5b22 576f 726b 6572 2873 2922 5d2e  ta["Worker(s)"].
-0001fb70: 6170 7065 6e64 2822 2c5c 6e22 2e6a 6f69  append(",\n".joi
-0001fb80: 6e28 7473 2e65 7272 6564 5f6f 6e29 290a  n(ts.erred_on)).
-0001fb90: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0001fba0: 6461 7461 5b22 436f 756e 7422 5d2e 6170  data["Count"].ap
-0001fbb0: 7065 6e64 286c 656e 2874 732e 6572 7265  pend(len(ts.erre
-0001fbc0: 645f 6f6e 2929 0a0a 2020 2020 2020 2020  d_on))..        
-0001fbd0: 7570 6461 7465 2873 656c 662e 736f 7572  update(self.sour
-0001fbe0: 6365 2c20 6e65 775f 6461 7461 290a 0a0a  ce, new_data)...
-0001fbf0: 636c 6173 7320 576f 726b 6572 5461 626c  class WorkerTabl
-0001fc00: 6528 4461 7368 626f 6172 6443 6f6d 706f  e(DashboardCompo
-0001fc10: 6e65 6e74 293a 0a20 2020 2022 2222 5374  nent):.    """St
-0001fc20: 6174 7573 206f 6620 7468 6520 6375 7272  atus of the curr
-0001fc30: 656e 7420 776f 726b 6572 730a 0a20 2020  ent workers..   
-0001fc40: 2054 6869 7320 6973 2074 776f 2070 6c6f   This is two plo
-0001fc50: 7473 2c20 6120 7465 7874 2d62 6173 6564  ts, a text-based
-0001fc60: 2074 6162 6c65 2066 6f72 2065 6163 6820   table for each 
-0001fc70: 686f 7374 2061 6e64 2061 2074 6869 6e20  host and a thin 
-0001fc80: 686f 7269 7a6f 6e74 616c 0a20 2020 2070  horizontal.    p
-0001fc90: 6c6f 7420 6c61 7969 6e67 206f 7574 2068  lot laying out h
-0001fca0: 6f73 7473 2062 7920 7468 6569 7220 6375  osts by their cu
-0001fcb0: 7272 656e 7420 6d65 6d6f 7279 2075 7365  rrent memory use
-0001fcc0: 2e0a 2020 2020 2222 220a 0a20 2020 2065  ..    """..    e
-0001fcd0: 7863 6c75 6465 645f 6e61 6d65 7320 3d20  xcluded_names = 
-0001fce0: 7b0a 2020 2020 2020 2020 2265 7865 6375  {.        "execu
-0001fcf0: 7469 6e67 222c 0a20 2020 2020 2020 2022  ting",.        "
-0001fd00: 696e 5f66 6c69 6768 7422 2c0a 2020 2020  in_flight",.    
-0001fd10: 2020 2020 2269 6e5f 6d65 6d6f 7279 222c      "in_memory",
-0001fd20: 0a20 2020 2020 2020 2022 7265 6164 7922  .        "ready"
-0001fd30: 2c0a 2020 2020 2020 2020 2274 696d 6522  ,.        "time"
-0001fd40: 2c0a 2020 2020 2020 2020 2320 5573 6520  ,.        # Use 
-0001fd50: 7363 6865 6475 6c65 722e 576f 726b 6572  scheduler.Worker
-0001fd60: 5374 6174 652e 6d65 6d6f 7279 2e6d 616e  State.memory.man
-0001fd70: 6167 6564 2069 6e73 7465 6164 206f 660a  aged instead of.
-0001fd80: 2020 2020 2020 2020 2320 7363 6865 6475          # schedu
-0001fd90: 6c65 722e 576f 726b 6572 5374 6174 652e  ler.WorkerState.
-0001fda0: 6d65 7472 6963 735b 226d 616e 6167 6564  metrics["managed
-0001fdb0: 5f62 7974 6573 225d 3b20 7468 6520 7477  _bytes"]; the tw
-0001fdc0: 6f20 6d65 6173 7572 6573 2061 7265 2073  o measures are s
-0001fdd0: 6c69 6768 746c 790a 2020 2020 2020 2020  lightly.        
-0001fde0: 2320 6469 6666 6572 656e 742e 2053 6565  # different. See
-0001fdf0: 2065 7870 6c61 6e61 7469 6f6e 2069 6e20   explanation in 
-0001fe00: 7363 6865 6475 6c65 722e 576f 726b 6572  scheduler.Worker
-0001fe10: 5374 6174 652e 6d65 6d6f 7279 2829 2e0a  State.memory()..
-0001fe20: 2020 2020 2020 2020 226d 616e 6167 6564          "managed
-0001fe30: 5f62 7974 6573 222c 0a20 2020 2020 2020  _bytes",.       
-0001fe40: 2022 7370 696c 6c65 645f 6279 7465 7322   "spilled_bytes"
-0001fe50: 2c0a 2020 2020 7d0a 0a20 2020 2064 6566  ,.    }..    def
-0001fe60: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-0001fe70: 7363 6865 6475 6c65 722c 2077 6964 7468  scheduler, width
-0001fe80: 3d38 3030 2c20 2a2a 6b77 6172 6773 293a  =800, **kwargs):
-0001fe90: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-0001fea0: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
-0001feb0: 6c65 720a 2020 2020 2020 2020 7365 6c66  ler.        self
-0001fec0: 2e6e 616d 6573 203d 205b 0a20 2020 2020  .names = [.     
-0001fed0: 2020 2020 2020 2022 6e61 6d65 222c 0a20         "name",. 
-0001fee0: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
-0001fef0: 6573 7322 2c0a 2020 2020 2020 2020 2020  ess",.          
-0001ff00: 2020 226e 7468 7265 6164 7322 2c0a 2020    "nthreads",.  
-0001ff10: 2020 2020 2020 2020 2020 2263 7075 222c            "cpu",
-0001ff20: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-0001ff30: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
-0001ff40: 2020 2022 6d65 6d6f 7279 5f6c 696d 6974     "memory_limit
-0001ff50: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0001ff60: 6d65 6d6f 7279 5f70 6572 6365 6e74 222c  memory_percent",
-0001ff70: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-0001ff80: 6d6f 7279 5f6d 616e 6167 6564 222c 0a20  mory_managed",. 
-0001ff90: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-0001ffa0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-0001ffb0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0001ffc0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-0001ffd0: 5f72 6563 656e 7422 2c0a 2020 2020 2020  _recent",.      
-0001ffe0: 2020 2020 2020 226d 656d 6f72 795f 7370        "memory_sp
-0001fff0: 696c 6c65 6422 2c0a 2020 2020 2020 2020  illed",.        
-00020000: 2020 2020 226e 756d 5f66 6473 222c 0a20      "num_fds",. 
-00020010: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-00020020: 5f6e 6574 5f69 6f2e 7265 6164 5f62 7073  _net_io.read_bps
-00020030: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00020040: 686f 7374 5f6e 6574 5f69 6f2e 7772 6974  host_net_io.writ
-00020050: 655f 6270 7322 2c0a 2020 2020 2020 2020  e_bps",.        
-00020060: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
-00020070: 6f2e 7265 6164 5f62 7073 222c 0a20 2020  o.read_bps",.   
-00020080: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
-00020090: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
-000200a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-000200b0: 6370 755f 6672 6163 7469 6f6e 222c 0a20  cpu_fraction",. 
-000200c0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-000200d0: 2077 6f72 6b65 7273 203d 2073 656c 662e   workers = self.
-000200e0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-000200f0: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
-00020100: 2020 2073 656c 662e 6578 7472 615f 6e61     self.extra_na
-00020110: 6d65 7320 3d20 736f 7274 6564 280a 2020  mes = sorted(.  
-00020120: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00020130: 2020 2020 2020 2020 2020 2020 6d0a 2020              m.  
-00020140: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00020150: 7220 7773 2069 6e20 776f 726b 6572 730a  r ws in workers.
-00020160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020170: 666f 7220 6d2c 2076 2069 6e20 7773 2e6d  for m, v in ws.m
-00020180: 6574 7269 6373 2e69 7465 6d73 2829 0a20  etrics.items(). 
-00020190: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000201a0: 6620 6d20 6e6f 7420 696e 2073 656c 662e  f m not in self.
-000201b0: 6e61 6d65 7320 616e 6420 6973 696e 7374  names and isinst
-000201c0: 616e 6365 2876 2c20 2873 7472 2c20 696e  ance(v, (str, in
-000201d0: 742c 2066 6c6f 6174 2929 0a20 2020 2020  t, float)).     
-000201e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000201f0: 2020 2020 202d 2073 656c 662e 6578 636c       - self.excl
-00020200: 7564 6564 5f6e 616d 6573 0a20 2020 2020  uded_names.     
-00020210: 2020 2029 0a0a 2020 2020 2020 2020 7461     )..        ta
-00020220: 626c 655f 6e61 6d65 7320 3d20 5b0a 2020  ble_names = [.  
-00020230: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
-00020240: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
-00020250: 6464 7265 7373 222c 0a20 2020 2020 2020  ddress",.       
-00020260: 2020 2020 2022 6e74 6872 6561 6473 222c       "nthreads",
-00020270: 0a20 2020 2020 2020 2020 2020 2022 6370  .            "cp
-00020280: 7522 2c0a 2020 2020 2020 2020 2020 2020  u",.            
-00020290: 226d 656d 6f72 7922 2c0a 2020 2020 2020  "memory",.      
-000202a0: 2020 2020 2020 226d 656d 6f72 795f 6c69        "memory_li
-000202b0: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
-000202c0: 2020 226d 656d 6f72 795f 7065 7263 656e    "memory_percen
-000202d0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-000202e0: 226d 656d 6f72 795f 6d61 6e61 6765 6422  "memory_managed"
-000202f0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00020300: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00020310: 6f6c 6422 2c0a 2020 2020 2020 2020 2020  old",.          
-00020320: 2020 226d 656d 6f72 795f 756e 6d61 6e61    "memory_unmana
-00020330: 6765 645f 7265 6365 6e74 222c 0a20 2020  ged_recent",.   
-00020340: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-00020350: 5f73 7069 6c6c 6564 222c 0a20 2020 2020  _spilled",.     
-00020360: 2020 2020 2020 2022 6e75 6d5f 6664 7322         "num_fds"
-00020370: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-00020380: 6f73 745f 6e65 745f 696f 2e72 6561 645f  ost_net_io.read_
-00020390: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
-000203a0: 2020 2268 6f73 745f 6e65 745f 696f 2e77    "host_net_io.w
-000203b0: 7269 7465 5f62 7073 222c 0a20 2020 2020  rite_bps",.     
-000203c0: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
-000203d0: 6b5f 696f 2e72 6561 645f 6270 7322 2c0a  k_io.read_bps",.
-000203e0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
-000203f0: 745f 6469 736b 5f69 6f2e 7772 6974 655f  t_disk_io.write_
-00020400: 6270 7322 2c0a 2020 2020 2020 2020 5d0a  bps",.        ].
-00020410: 2020 2020 2020 2020 636f 6c75 6d6e 5f74          column_t
-00020420: 6974 6c65 5f72 656e 616d 6573 203d 207b  itle_renames = {
-00020430: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00020440: 6d6f 7279 5f6c 696d 6974 223a 2022 6c69  mory_limit": "li
-00020450: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
-00020460: 2020 226d 656d 6f72 795f 7065 7263 656e    "memory_percen
-00020470: 7422 3a20 226d 656d 6f72 7920 2522 2c0a  t": "memory %",.
-00020480: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-00020490: 6f72 795f 6d61 6e61 6765 6422 3a20 226d  ory_managed": "m
-000204a0: 616e 6167 6564 222c 0a20 2020 2020 2020  anaged",.       
-000204b0: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
-000204c0: 616e 6167 6564 5f6f 6c64 223a 2022 756e  anaged_old": "un
-000204d0: 6d61 6e61 6765 6420 6f6c 6422 2c0a 2020  managed old",.  
-000204e0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-000204f0: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
-00020500: 6e74 223a 2022 756e 6d61 6e61 6765 6420  nt": "unmanaged 
-00020510: 7265 6365 6e74 222c 0a20 2020 2020 2020  recent",.       
-00020520: 2020 2020 2022 6d65 6d6f 7279 5f73 7069       "memory_spi
-00020530: 6c6c 6564 223a 2022 7370 696c 6c65 6422  lled": "spilled"
-00020540: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-00020550: 756d 5f66 6473 223a 2022 2320 6664 7322  um_fds": "# fds"
-00020560: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-00020570: 6f73 745f 6e65 745f 696f 2e72 6561 645f  ost_net_io.read_
-00020580: 6270 7322 3a20 226e 6574 2072 6561 6422  bps": "net read"
-00020590: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-000205a0: 6f73 745f 6e65 745f 696f 2e77 7269 7465  ost_net_io.write
-000205b0: 5f62 7073 223a 2022 6e65 7420 7772 6974  _bps": "net writ
-000205c0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-000205d0: 2268 6f73 745f 6469 736b 5f69 6f2e 7265  "host_disk_io.re
-000205e0: 6164 5f62 7073 223a 2022 6469 736b 2072  ad_bps": "disk r
-000205f0: 6561 6422 2c0a 2020 2020 2020 2020 2020  ead",.          
-00020600: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
-00020610: 7772 6974 655f 6270 7322 3a20 2264 6973  write_bps": "dis
-00020620: 6b20 7772 6974 6522 2c0a 2020 2020 2020  k write",.      
-00020630: 2020 7d0a 0a20 2020 2020 2020 2073 656c    }..        sel
-00020640: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
-00020650: 6e44 6174 6153 6f75 7263 6528 7b6b 3a20  nDataSource({k: 
-00020660: 5b5d 2066 6f72 206b 2069 6e20 7365 6c66  [] for k in self
-00020670: 2e6e 616d 6573 7d29 0a0a 2020 2020 2020  .names})..      
-00020680: 2020 636f 6c75 6d6e 7320 3d20 7b0a 2020    columns = {.  
-00020690: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000206a0: 5461 626c 6543 6f6c 756d 6e28 6669 656c  TableColumn(fiel
-000206b0: 643d 6e61 6d65 2c20 7469 746c 653d 636f  d=name, title=co
-000206c0: 6c75 6d6e 5f74 6974 6c65 5f72 656e 616d  lumn_title_renam
-000206d0: 6573 2e67 6574 286e 616d 652c 206e 616d  es.get(name, nam
-000206e0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-000206f0: 666f 7220 6e61 6d65 2069 6e20 7461 626c  for name in tabl
-00020700: 655f 6e61 6d65 730a 2020 2020 2020 2020  e_names.        
-00020710: 7d0a 0a20 2020 2020 2020 2066 6f72 6d61  }..        forma
-00020720: 7474 6572 7320 3d20 7b0a 2020 2020 2020  tters = {.      
-00020730: 2020 2020 2020 2263 7075 223a 204e 756d        "cpu": Num
-00020740: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00020750: 6d61 743d 2230 2025 2229 2c0a 2020 2020  mat="0 %"),.    
-00020760: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
-00020770: 7065 7263 656e 7422 3a20 4e75 6d62 6572  percent": Number
-00020780: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
-00020790: 3d22 302e 3020 2522 292c 0a20 2020 2020  ="0.0 %"),.     
-000207a0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-000207b0: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-000207c0: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
-000207d0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-000207e0: 656d 6f72 795f 6c69 6d69 7422 3a20 4e75  emory_limit": Nu
-000207f0: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
-00020800: 726d 6174 3d22 302e 3020 6222 292c 0a20  rmat="0.0 b"),. 
-00020810: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00020820: 7279 5f6d 616e 6167 6564 223a 204e 756d  ry_managed": Num
-00020830: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00020840: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
-00020850: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00020860: 795f 756e 6d61 6e61 6765 645f 6f6c 6422  y_unmanaged_old"
-00020870: 3a20 4e75 6d62 6572 466f 726d 6174 7465  : NumberFormatte
-00020880: 7228 666f 726d 6174 3d22 302e 3020 6222  r(format="0.0 b"
-00020890: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-000208a0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-000208b0: 5f72 6563 656e 7422 3a20 4e75 6d62 6572  _recent": Number
-000208c0: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
-000208d0: 3d22 302e 3020 6222 292c 0a20 2020 2020  ="0.0 b"),.     
-000208e0: 2020 2020 2020 2022 6d65 6d6f 7279 5f73         "memory_s
-000208f0: 7069 6c6c 6564 223a 204e 756d 6265 7246  pilled": NumberF
-00020900: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-00020910: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
-00020920: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
-00020930: 696f 2e72 6561 645f 6270 7322 3a20 4e75  io.read_bps": Nu
-00020940: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
-00020950: 726d 6174 3d22 3020 6222 292c 0a20 2020  rmat="0 b"),.   
-00020960: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
-00020970: 6574 5f69 6f2e 7772 6974 655f 6270 7322  et_io.write_bps"
-00020980: 3a20 4e75 6d62 6572 466f 726d 6174 7465  : NumberFormatte
-00020990: 7228 666f 726d 6174 3d22 3020 6222 292c  r(format="0 b"),
-000209a0: 0a20 2020 2020 2020 2020 2020 2022 6e75  .            "nu
-000209b0: 6d5f 6664 7322 3a20 4e75 6d62 6572 466f  m_fds": NumberFo
-000209c0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-000209d0: 3022 292c 0a20 2020 2020 2020 2020 2020  0"),.           
-000209e0: 2022 6e74 6872 6561 6473 223a 204e 756d   "nthreads": Num
-000209f0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00020a00: 6d61 743d 2230 2229 2c0a 2020 2020 2020  mat="0"),.      
-00020a10: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
-00020a20: 5f69 6f2e 7265 6164 5f62 7073 223a 204e  _io.read_bps": N
-00020a30: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
-00020a40: 6f72 6d61 743d 2230 2062 2229 2c0a 2020  ormat="0 b"),.  
-00020a50: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
-00020a60: 6469 736b 5f69 6f2e 7772 6974 655f 6270  disk_io.write_bp
-00020a70: 7322 3a20 4e75 6d62 6572 466f 726d 6174  s": NumberFormat
-00020a80: 7465 7228 666f 726d 6174 3d22 3020 6222  ter(format="0 b"
-00020a90: 292c 0a20 2020 2020 2020 207d 0a0a 2020  ),.        }..  
-00020aa0: 2020 2020 2020 7461 626c 6520 3d20 4461        table = Da
-00020ab0: 7461 5461 626c 6528 0a20 2020 2020 2020  taTable(.       
-00020ac0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00020ad0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00020ae0: 2020 2020 2063 6f6c 756d 6e73 3d5b 636f       columns=[co
-00020af0: 6c75 6d6e 735b 6e5d 2066 6f72 206e 2069  lumns[n] for n i
-00020b00: 6e20 7461 626c 655f 6e61 6d65 735d 2c0a  n table_names],.
-00020b10: 2020 2020 2020 2020 2020 2020 7265 6f72              reor
-00020b20: 6465 7261 626c 653d 5472 7565 2c0a 2020  derable=True,.  
-00020b30: 2020 2020 2020 2020 2020 736f 7274 6162            sortab
-00020b40: 6c65 3d54 7275 652c 0a20 2020 2020 2020  le=True,.       
-00020b50: 2020 2020 2077 6964 7468 3d77 6964 7468       width=width
-00020b60: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-00020b70: 6465 785f 706f 7369 7469 6f6e 3d4e 6f6e  dex_position=Non
-00020b80: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
-00020b90: 2a5f 4441 5441 5441 424c 455f 5354 594c  *_DATATABLE_STYL
-00020ba0: 4553 4845 4554 535f 4b57 4152 4753 2c0a  ESHEETS_KWARGS,.
-00020bb0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00020bc0: 2020 2066 6f72 206e 616d 6520 696e 2074     for name in t
-00020bd0: 6162 6c65 5f6e 616d 6573 3a0a 2020 2020  able_names:.    
-00020be0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00020bf0: 696e 2066 6f72 6d61 7474 6572 733a 0a20  in formatters:. 
-00020c00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00020c10: 6162 6c65 2e63 6f6c 756d 6e73 5b74 6162  able.columns[tab
-00020c20: 6c65 5f6e 616d 6573 2e69 6e64 6578 286e  le_names.index(n
-00020c30: 616d 6529 5d2e 666f 726d 6174 7465 7220  ame)].formatter 
-00020c40: 3d20 666f 726d 6174 7465 7273 5b6e 616d  = formatters[nam
-00020c50: 655d 0a0a 2020 2020 2020 2020 6578 7472  e]..        extr
-00020c60: 615f 6e61 6d65 7320 3d20 5b22 6e61 6d65  a_names = ["name
-00020c70: 222c 2022 6164 6472 6573 7322 5d20 2b20  ", "address"] + 
-00020c80: 7365 6c66 2e65 7874 7261 5f6e 616d 6573  self.extra_names
-00020c90: 0a20 2020 2020 2020 2065 7874 7261 5f63  .        extra_c
-00020ca0: 6f6c 756d 6e73 203d 207b 0a20 2020 2020  olumns = {.     
-00020cb0: 2020 2020 2020 206e 616d 653a 2054 6162         name: Tab
-00020cc0: 6c65 436f 6c75 6d6e 2866 6965 6c64 3d6e  leColumn(field=n
-00020cd0: 616d 652c 2074 6974 6c65 3d63 6f6c 756d  ame, title=colum
-00020ce0: 6e5f 7469 746c 655f 7265 6e61 6d65 732e  n_title_renames.
-00020cf0: 6765 7428 6e61 6d65 2c20 6e61 6d65 2929  get(name, name))
-00020d00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00020d10: 206e 616d 6520 696e 2065 7874 7261 5f6e   name in extra_n
-00020d20: 616d 6573 0a20 2020 2020 2020 207d 0a0a  ames.        }..
-00020d30: 2020 2020 2020 2020 6578 7472 615f 7461          extra_ta
-00020d40: 626c 6520 3d20 4461 7461 5461 626c 6528  ble = DataTable(
-00020d50: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00020d60: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00020d70: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-00020d80: 756d 6e73 3d5b 6578 7472 615f 636f 6c75  umns=[extra_colu
-00020d90: 6d6e 735b 6e5d 2066 6f72 206e 2069 6e20  mns[n] for n in 
-00020da0: 6578 7472 615f 6e61 6d65 735d 2c0a 2020  extra_names],.  
-00020db0: 2020 2020 2020 2020 2020 7265 6f72 6465            reorde
-00020dc0: 7261 626c 653d 5472 7565 2c0a 2020 2020  rable=True,.    
-00020dd0: 2020 2020 2020 2020 736f 7274 6162 6c65          sortable
-00020de0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00020df0: 2020 2077 6964 7468 3d77 6964 7468 2c0a     width=width,.
-00020e00: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00020e10: 785f 706f 7369 7469 6f6e 3d4e 6f6e 652c  x_position=None,
-00020e20: 0a20 2020 2020 2020 2020 2020 202a 2a5f  .            **_
-00020e30: 4441 5441 5441 424c 455f 5354 594c 4553  DATATABLE_STYLES
-00020e40: 4845 4554 535f 4b57 4152 4753 2c0a 2020  HEETS_KWARGS,.  
-00020e50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00020e60: 2066 6f72 206e 616d 6520 696e 2065 7874   for name in ext
-00020e70: 7261 5f6e 616d 6573 3a0a 2020 2020 2020  ra_names:.      
-00020e80: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
-00020e90: 2066 6f72 6d61 7474 6572 733a 0a20 2020   formatters:.   
-00020ea0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00020eb0: 7261 5f74 6162 6c65 2e63 6f6c 756d 6e73  ra_table.columns
-00020ec0: 5b65 7874 7261 5f6e 616d 6573 2e69 6e64  [extra_names.ind
-00020ed0: 6578 286e 616d 6529 5d2e 666f 726d 6174  ex(name)].format
-00020ee0: 7465 7220 3d20 666f 726d 6174 7465 7273  ter = formatters
-00020ef0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00020f00: 2020 2020 2020 6e61 6d65 0a20 2020 2020        name.     
-00020f10: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
-00020f20: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
-00020f30: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
-00020f40: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
-00020f50: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
-00020f60: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00020f70: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
-00020f80: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
-00020f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020fa0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-00020fb0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-00020fc0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-00020fd0: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-00020fe0: 223e 576f 726b 6572 2028 406e 616d 6529  ">Worker (@name)
-00020ff0: 3a20 3c2f 7370 616e 3e0a 2020 2020 2020  : </span>.      
-00021000: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-00021010: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00021020: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-00021030: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-00021040: 6f6e 6f73 7061 6365 3b22 3e40 6d65 6d6f  onospace;">@memo
-00021050: 7279 5f70 6572 6365 6e74 7b30 2e30 2025  ry_percent{0.0 %
-00021060: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
-00021070: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
-00021080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021090: 2222 222c 0a20 2020 2020 2020 2029 0a0a  """,.        )..
-000210a0: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
-000210b0: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-000210c0: 2020 2020 2020 2074 6974 6c65 3d22 4d65         title="Me
-000210d0: 6d6f 7279 2055 7365 2028 2529 222c 0a20  mory Use (%)",. 
-000210e0: 2020 2020 2020 2020 2020 2074 6f6f 6c62             toolb
-000210f0: 6172 5f6c 6f63 6174 696f 6e3d 4e6f 6e65  ar_location=None
-00021100: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
-00021110: 7261 6e67 653d 2830 2c20 3129 2c0a 2020  range=(0, 1),.  
-00021120: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
-00021130: 653d 282d 302e 312c 2030 2e31 292c 0a20  e=(-0.1, 0.1),. 
-00021140: 2020 2020 2020 2020 2020 2068 6569 6768             heigh
-00021150: 743d 3630 2c0a 2020 2020 2020 2020 2020  t=60,.          
-00021160: 2020 7769 6474 683d 7769 6474 682c 0a20    width=width,. 
-00021170: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
-00021180: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
-00021190: 206d 696e 5f62 6f72 6465 725f 7269 6768   min_border_righ
-000211a0: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
-000211b0: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-000211c0: 2020 2029 0a20 2020 2020 2020 206d 656d     ).        mem
-000211d0: 5f70 6c6f 742e 6369 7263 6c65 280a 2020  _plot.circle(.  
-000211e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-000211f0: 3d73 656c 662e 736f 7572 6365 2c20 783d  =self.source, x=
-00021200: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
-00021210: 2c20 793d 302c 2073 697a 653d 3130 2c20  , y=0, size=10, 
-00021220: 6669 6c6c 5f61 6c70 6861 3d30 2e35 0a20  fill_alpha=0.5. 
-00021230: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00021240: 206d 656d 5f70 6c6f 742e 7967 7269 642e   mem_plot.ygrid.
-00021250: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
-00021260: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
-00021270: 2e79 6178 6973 2e6d 696e 6f72 5f74 6963  .yaxis.minor_tic
-00021280: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
-00021290: 0a20 2020 2020 2020 206d 656d 5f70 6c6f  .        mem_plo
-000212a0: 742e 7861 7869 732e 7669 7369 626c 6520  t.xaxis.visible 
-000212b0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000212c0: 6d65 6d5f 706c 6f74 2e79 6178 6973 2e76  mem_plot.yaxis.v
-000212d0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-000212e0: 2020 2020 2020 206d 656d 5f70 6c6f 742e         mem_plot.
-000212f0: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
-00021300: 2042 6f78 5365 6c65 6374 546f 6f6c 2829   BoxSelectTool()
-00021310: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
-00021320: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-00021330: 2020 2020 2020 2020 2020 706f 696e 745f            point_
-00021340: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
-00021350: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
-00021360: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
-00021370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021380: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
-00021390: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
-000213a0: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
-000213b0: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
-000213c0: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
-000213d0: 7061 6365 3b22 3e57 6f72 6b65 7220 2840  pace;">Worker (@
-000213e0: 6e61 6d65 293a 203c 2f73 7061 6e3e 0a20  name): </span>. 
-000213f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021400: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
-00021410: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
-00021420: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
-00021430: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
-00021440: 4063 7075 5f66 7261 6374 696f 6e7b 3020  @cpu_fraction{0 
-00021450: 257d 3c2f 7370 616e 3e0a 2020 2020 2020  %}</span>.      
-00021460: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00021470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021480: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
-00021490: 0a20 2020 2020 2020 2063 7075 5f70 6c6f  .        cpu_plo
-000214a0: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
-000214b0: 2020 2020 2020 2020 7469 746c 653d 2243          title="C
-000214c0: 5055 2055 7365 2028 2529 222c 0a20 2020  PU Use (%)",.   
-000214d0: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
-000214e0: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
-000214f0: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
-00021500: 6e67 653d 2830 2c20 3129 2c0a 2020 2020  nge=(0, 1),.    
-00021510: 2020 2020 2020 2020 795f 7261 6e67 653d          y_range=
-00021520: 282d 302e 312c 2030 2e31 292c 0a20 2020  (-0.1, 0.1),.   
-00021530: 2020 2020 2020 2020 2068 6569 6768 743d           height=
-00021540: 3630 2c0a 2020 2020 2020 2020 2020 2020  60,.            
-00021550: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
-00021560: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
-00021570: 222c 0a20 2020 2020 2020 2020 2020 206d  ",.            m
-00021580: 696e 5f62 6f72 6465 725f 7269 6768 743d  in_border_right=
-00021590: 302c 0a20 2020 2020 2020 2020 2020 202a  0,.            *
-000215a0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-000215b0: 2029 0a20 2020 2020 2020 2063 7075 5f70   ).        cpu_p
-000215c0: 6c6f 742e 6369 7263 6c65 280a 2020 2020  lot.circle(.    
-000215d0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-000215e0: 656c 662e 736f 7572 6365 2c20 783d 2263  elf.source, x="c
-000215f0: 7075 5f66 7261 6374 696f 6e22 2c20 793d  pu_fraction", y=
-00021600: 302c 2073 697a 653d 3130 2c20 6669 6c6c  0, size=10, fill
-00021610: 5f61 6c70 6861 3d30 2e35 0a20 2020 2020  _alpha=0.5.     
-00021620: 2020 2029 0a20 2020 2020 2020 2063 7075     ).        cpu
-00021630: 5f70 6c6f 742e 7967 7269 642e 7669 7369  _plot.ygrid.visi
-00021640: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00021650: 2020 2020 6370 755f 706c 6f74 2e79 6178      cpu_plot.yax
-00021660: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-00021670: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-00021680: 2020 2020 2063 7075 5f70 6c6f 742e 7861       cpu_plot.xa
-00021690: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-000216a0: 6c73 650a 2020 2020 2020 2020 6370 755f  lse.        cpu_
-000216b0: 706c 6f74 2e79 6178 6973 2e76 6973 6962  plot.yaxis.visib
-000216c0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-000216d0: 2020 2063 7075 5f70 6c6f 742e 6164 645f     cpu_plot.add_
-000216e0: 746f 6f6c 7328 686f 7665 722c 2042 6f78  tools(hover, Box
-000216f0: 5365 6c65 6374 546f 6f6c 2829 290a 2020  SelectTool()).  
-00021700: 2020 2020 2020 7365 6c66 2e63 7075 5f70        self.cpu_p
-00021710: 6c6f 7420 3d20 6370 755f 706c 6f74 0a0a  lot = cpu_plot..
-00021720: 2020 2020 2020 2020 6966 2022 7369 7a69          if "sizi
-00021730: 6e67 5f6d 6f64 6522 2069 6e20 6b77 6172  ng_mode" in kwar
-00021740: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00021750: 7369 7a69 6e67 5f6d 6f64 6520 3d20 7b22  sizing_mode = {"
-00021760: 7369 7a69 6e67 5f6d 6f64 6522 3a20 6b77  sizing_mode": kw
-00021770: 6172 6773 5b22 7369 7a69 6e67 5f6d 6f64  args["sizing_mod
-00021780: 6522 5d7d 0a20 2020 2020 2020 2065 6c73  e"]}.        els
-00021790: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000217a0: 697a 696e 675f 6d6f 6465 203d 207b 7d0a  izing_mode = {}.
-000217b0: 0a20 2020 2020 2020 2063 6f6d 706f 6e65  .        compone
-000217c0: 6e74 7320 3d20 5b63 7075 5f70 6c6f 742c  nts = [cpu_plot,
-000217d0: 206d 656d 5f70 6c6f 742c 2074 6162 6c65   mem_plot, table
-000217e0: 5d0a 2020 2020 2020 2020 6966 2073 656c  ].        if sel
-000217f0: 662e 6578 7472 615f 6e61 6d65 733a 0a20  f.extra_names:. 
-00021800: 2020 2020 2020 2020 2020 2063 6f6d 706f             compo
-00021810: 6e65 6e74 732e 6170 7065 6e64 2865 7874  nents.append(ext
-00021820: 7261 5f74 6162 6c65 290a 0a20 2020 2020  ra_table)..     
-00021830: 2020 2073 656c 662e 726f 6f74 203d 2063     self.root = c
-00021840: 6f6c 756d 6e28 2a63 6f6d 706f 6e65 6e74  olumn(*component
-00021850: 732c 202a 2a73 697a 696e 675f 6d6f 6465  s, **sizing_mode
-00021860: 290a 0a20 2020 2040 7769 7468 6f75 745f  )..    @without_
-00021870: 7072 6f70 6572 7479 5f76 616c 6964 6174  property_validat
-00021880: 696f 6e0a 2020 2020 6465 6620 7570 6461  ion.    def upda
-00021890: 7465 2873 656c 6629 3a0a 2020 2020 2020  te(self):.      
-000218a0: 2020 6461 7461 203d 207b 6e61 6d65 3a20    data = {name: 
-000218b0: 5b5d 2066 6f72 206e 616d 6520 696e 2073  [] for name in s
-000218c0: 656c 662e 6e61 6d65 7320 2b20 7365 6c66  elf.names + self
-000218d0: 2e65 7874 7261 5f6e 616d 6573 7d0a 2020  .extra_names}.  
-000218e0: 2020 2020 2020 666f 7220 692c 2077 7320        for i, ws 
-000218f0: 696e 2065 6e75 6d65 7261 7465 280a 2020  in enumerate(.  
-00021900: 2020 2020 2020 2020 2020 736f 7274 6564            sorted
-00021910: 2873 656c 662e 7363 6865 6475 6c65 722e  (self.scheduler.
-00021920: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00021930: 2c20 6b65 793d 6c61 6d62 6461 2077 733a  , key=lambda ws:
-00021940: 2073 7472 2877 732e 6e61 6d65 2929 0a20   str(ws.name)). 
-00021950: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00021960: 2020 2020 2020 6d69 6e66 6f20 3d20 7773        minfo = ws
-00021970: 2e6d 656d 6f72 790a 0a20 2020 2020 2020  .memory..       
-00021980: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-00021990: 2073 656c 662e 6e61 6d65 7320 2b20 7365   self.names + se
-000219a0: 6c66 2e65 7874 7261 5f6e 616d 6573 3a0a  lf.extra_names:.
-000219b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219c0: 6966 2022 2e22 2069 6e20 6e61 6d65 3a0a  if "." in name:.
-000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219e0: 2020 2020 6e30 2c20 5f2c 206e 3120 3d20      n0, _, n1 = 
-000219f0: 6e61 6d65 2e70 6172 7469 7469 6f6e 2822  name.partition("
-00021a00: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00021a10: 2020 2020 2020 2020 7620 3d20 7773 2e6d          v = ws.m
-00021a20: 6574 7269 6373 2e67 6574 286e 302c 207b  etrics.get(n0, {
-00021a30: 7d29 2e67 6574 286e 312c 204e 6f6e 6529  }).get(n1, None)
-00021a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021a50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00021a60: 2020 2020 2020 2020 2020 2076 203d 2077             v = w
-00021a70: 732e 6d65 7472 6963 732e 6765 7428 6e61  s.metrics.get(na
-00021a80: 6d65 2c20 4e6f 6e65 290a 2020 2020 2020  me, None).      
-00021a90: 2020 2020 2020 2020 2020 6461 7461 5b6e            data[n
-00021aa0: 616d 655d 2e61 7070 656e 6428 7629 0a0a  ame].append(v)..
-00021ab0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00021ac0: 5b22 6e61 6d65 225d 5b2d 315d 203d 2077  ["name"][-1] = w
-00021ad0: 732e 6e61 6d65 2069 6620 7773 2e6e 616d  s.name if ws.nam
-00021ae0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
-00021af0: 7365 2069 0a20 2020 2020 2020 2020 2020  se i.           
-00021b00: 2064 6174 615b 2261 6464 7265 7373 225d   data["address"]
-00021b10: 5b2d 315d 203d 2077 732e 6164 6472 6573  [-1] = ws.addres
-00021b20: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-00021b30: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
-00021b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021b50: 2020 6461 7461 5b22 6d65 6d6f 7279 5f70    data["memory_p
-00021b60: 6572 6365 6e74 225d 5b2d 315d 203d 2077  ercent"][-1] = w
-00021b70: 732e 6d65 7472 6963 735b 226d 656d 6f72  s.metrics["memor
-00021b80: 7922 5d20 2f20 7773 2e6d 656d 6f72 795f  y"] / ws.memory_
-00021b90: 6c69 6d69 740a 2020 2020 2020 2020 2020  limit.          
-00021ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00021bb0: 2020 2020 2020 2020 6461 7461 5b22 6d65          data["me
-00021bc0: 6d6f 7279 5f70 6572 6365 6e74 225d 5b2d  mory_percent"][-
-00021bd0: 315d 203d 2022 220a 2020 2020 2020 2020  1] = "".        
-00021be0: 2020 2020 6461 7461 5b22 6d65 6d6f 7279      data["memory
-00021bf0: 5f6c 696d 6974 225d 5b2d 315d 203d 2077  _limit"][-1] = w
-00021c00: 732e 6d65 6d6f 7279 5f6c 696d 6974 0a20  s.memory_limit. 
-00021c10: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00021c20: 226d 656d 6f72 795f 6d61 6e61 6765 6422  "memory_managed"
-00021c30: 5d5b 2d31 5d20 3d20 6d69 6e66 6f2e 6d61  ][-1] = minfo.ma
-00021c40: 6e61 6765 640a 2020 2020 2020 2020 2020  naged.          
-00021c50: 2020 6461 7461 5b22 6d65 6d6f 7279 5f75    data["memory_u
-00021c60: 6e6d 616e 6167 6564 5f6f 6c64 225d 5b2d  nmanaged_old"][-
-00021c70: 315d 203d 206d 696e 666f 2e75 6e6d 616e  1] = minfo.unman
-00021c80: 6167 6564 5f6f 6c64 0a20 2020 2020 2020  aged_old.       
-00021c90: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
-00021ca0: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
-00021cb0: 6e74 225d 5b2d 315d 203d 206d 696e 666f  nt"][-1] = minfo
-00021cc0: 2e75 6e6d 616e 6167 6564 5f72 6563 656e  .unmanaged_recen
-00021cd0: 740a 2020 2020 2020 2020 2020 2020 6461  t.            da
-00021ce0: 7461 5b22 6d65 6d6f 7279 5f75 6e6d 616e  ta["memory_unman
-00021cf0: 6167 6564 5f72 6563 656e 7422 5d5b 2d31  aged_recent"][-1
-00021d00: 5d20 3d20 6d69 6e66 6f2e 756e 6d61 6e61  ] = minfo.unmana
-00021d10: 6765 645f 7265 6365 6e74 0a20 2020 2020  ged_recent.     
-00021d20: 2020 2020 2020 2064 6174 615b 226d 656d         data["mem
-00021d30: 6f72 795f 7370 696c 6c65 6422 5d5b 2d31  ory_spilled"][-1
-00021d40: 5d20 3d20 6d69 6e66 6f2e 7370 696c 6c65  ] = minfo.spille
-00021d50: 640a 2020 2020 2020 2020 2020 2020 6461  d.            da
-00021d60: 7461 5b22 6370 7522 5d5b 2d31 5d20 3d20  ta["cpu"][-1] = 
-00021d70: 7773 2e6d 6574 7269 6373 5b22 6370 7522  ws.metrics["cpu"
-00021d80: 5d20 2f20 3130 302e 300a 2020 2020 2020  ] / 100.0.      
-00021d90: 2020 2020 2020 6461 7461 5b22 6370 755f        data["cpu_
-00021da0: 6672 6163 7469 6f6e 225d 5b2d 315d 203d  fraction"][-1] =
-00021db0: 2077 732e 6d65 7472 6963 735b 2263 7075   ws.metrics["cpu
-00021dc0: 225d 202f 2031 3030 2e30 202f 2077 732e  "] / 100.0 / ws.
-00021dd0: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-00021de0: 2020 2020 2064 6174 615b 226e 7468 7265       data["nthre
-00021df0: 6164 7322 5d5b 2d31 5d20 3d20 7773 2e6e  ads"][-1] = ws.n
-00021e00: 7468 7265 6164 730a 0a20 2020 2020 2020  threads..       
-00021e10: 2066 6f72 206e 616d 6520 696e 2073 656c   for name in sel
-00021e20: 662e 6e61 6d65 7320 2b20 7365 6c66 2e65  f.names + self.e
-00021e30: 7874 7261 5f6e 616d 6573 3a0a 2020 2020  xtra_names:.    
-00021e40: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00021e50: 3d3d 2022 6e61 6d65 223a 0a20 2020 2020  == "name":.     
-00021e60: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00021e70: 6e61 6d65 5d2e 696e 7365 7274 2830 2c20  name].insert(0, 
-00021e80: 6622 546f 7461 6c20 287b 6c65 6e28 6461  f"Total ({len(da
-00021e90: 7461 5b6e 616d 655d 297d 2922 290a 2020  ta[name])})").  
-00021ea0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00021eb0: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-00021ec0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00021ed0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00021ee0: 656c 662e 7363 6865 6475 6c65 722e 776f  elf.scheduler.wo
-00021ef0: 726b 6572 7329 203d 3d20 303a 0a20 2020  rkers) == 0:.   
-00021f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f10: 2074 6f74 616c 5f64 6174 6120 3d20 4e6f   total_data = No
-00021f20: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00021f30: 2020 2065 6c69 6620 6e61 6d65 203d 3d20     elif name == 
-00021f40: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
-00021f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021f60: 2020 2020 2020 746f 7461 6c5f 6d65 6d20        total_mem 
-00021f70: 3d20 7375 6d28 0a20 2020 2020 2020 2020  = sum(.         
-00021f80: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00021f90: 732e 6d65 6d6f 7279 5f6c 696d 6974 2066  s.memory_limit f
-00021fa0: 6f72 2077 7320 696e 2073 656c 662e 7363  or ws in self.sc
-00021fb0: 6865 6475 6c65 722e 776f 726b 6572 732e  heduler.workers.
-00021fc0: 7661 6c75 6573 2829 0a20 2020 2020 2020  values().       
-00021fd0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ff0: 2020 2074 6f74 616c 5f64 6174 6120 3d20     total_data = 
-00022000: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00022010: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
-00022020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022030: 2020 2020 2020 2020 7375 6d28 0a20 2020          sum(.   
-00022040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022050: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
-00022060: 6d65 7472 6963 735b 226d 656d 6f72 7922  metrics["memory"
-00022070: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00022080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022090: 2020 666f 7220 7773 2069 6e20 7365 6c66    for ws in self
-000220a0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-000220b0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
-000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000220d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000220e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000220f0: 2020 2020 2020 2f20 746f 7461 6c5f 6d65        / total_me
-00022100: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-00022110: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00022120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022130: 2020 2020 6966 2074 6f74 616c 5f6d 656d      if total_mem
-00022140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022150: 2020 2020 2020 2020 2065 6c73 6520 2222           else ""
-00022160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022170: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00022180: 2020 2020 2020 2065 6c69 6620 6e61 6d65         elif name
-00022190: 203d 3d20 2263 7075 223a 0a20 2020 2020   == "cpu":.     
-000221a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000221b0: 6f74 616c 5f64 6174 6120 3d20 280a 2020  otal_data = (.  
-000221c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221d0: 2020 2020 2020 7375 6d28 7773 2e6d 6574        sum(ws.met
-000221e0: 7269 6373 5b22 6370 7522 5d20 666f 7220  rics["cpu"] for 
-000221f0: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
-00022200: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
-00022210: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
-00022220: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00022230: 2031 3030 0a20 2020 2020 2020 2020 2020   100.           
-00022240: 2020 2020 2020 2020 2020 2020 202f 206c               / l
-00022250: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
-00022260: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
-00022270: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00022280: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00022290: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-000222a0: 616d 6520 3d3d 2022 6370 755f 6672 6163  ame == "cpu_frac
-000222b0: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
-000222c0: 2020 2020 2020 2020 2020 2074 6f74 616c             total
-000222d0: 5f64 6174 6120 3d20 280a 2020 2020 2020  _data = (.      
-000222e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000222f0: 2020 7375 6d28 7773 2e6d 6574 7269 6373    sum(ws.metrics
-00022300: 5b22 6370 7522 5d20 666f 7220 7773 2069  ["cpu"] for ws i
-00022310: 6e20 7365 6c66 2e73 6368 6564 756c 6572  n self.scheduler
-00022320: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00022330: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00022340: 2020 2020 2020 2020 2020 202f 2031 3030             / 100
-00022350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022360: 2020 2020 2020 2020 202f 2073 756d 2877           / sum(w
-00022370: 732e 6e74 6872 6561 6473 2066 6f72 2077  s.nthreads for w
-00022380: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
-00022390: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-000223a0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-000223b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000223c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000223d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000223e0: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
-000223f0: 203d 2073 756d 2864 6174 615b 6e61 6d65   = sum(data[name
-00022400: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-00022410: 2020 2020 6461 7461 5b6e 616d 655d 2e69      data[name].i
-00022420: 6e73 6572 7428 302c 2074 6f74 616c 5f64  nsert(0, total_d
-00022430: 6174 6129 0a20 2020 2020 2020 2020 2020  ata).           
-00022440: 2065 7863 6570 7420 5479 7065 4572 726f   except TypeErro
-00022450: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00022460: 2020 2064 6174 615b 6e61 6d65 5d2e 696e     data[name].in
-00022470: 7365 7274 2830 2c20 4e6f 6e65 290a 0a20  sert(0, None).. 
-00022480: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-00022490: 6365 2e64 6174 612e 7570 6461 7465 2864  ce.data.update(d
-000224a0: 6174 6129 0a0a 0a63 6c61 7373 2053 6875  ata)...class Shu
-000224b0: 6666 6c69 6e67 2844 6173 6862 6f61 7264  ffling(Dashboard
-000224c0: 436f 6d70 6f6e 656e 7429 3a0a 2020 2020  Component):.    
-000224d0: 2222 224f 6363 7570 616e 6379 2028 696e  """Occupancy (in
-000224e0: 2074 696d 6529 2070 6572 2077 6f72 6b65   time) per worke
-000224f0: 7222 2222 0a0a 2020 2020 6465 6620 5f5f  r"""..    def __
-00022500: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-00022510: 6564 756c 6572 2c20 2a2a 6b77 6172 6773  eduler, **kwargs
-00022520: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
-00022530: 6c6f 675f 6572 726f 7273 2829 3a0a 2020  log_errors():.  
-00022540: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00022550: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00022560: 756c 6572 0a20 2020 2020 2020 2020 2020  uler.           
-00022570: 2073 656c 662e 736f 7572 6365 203d 2043   self.source = C
-00022580: 6f6c 756d 6e44 6174 6153 6f75 7263 6528  olumnDataSource(
-00022590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000225a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000225b0: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
-000225c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000225d0: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
-000225e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000225f0: 2020 2020 2020 2263 6f6d 6d5f 6d65 6d6f        "comm_memo
-00022600: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
-00022610: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-00022620: 6d6d 5f6d 656d 6f72 795f 6c69 6d69 7422  mm_memory_limit"
-00022630: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00022640: 2020 2020 2020 2020 2020 2263 6f6d 6d5f            "comm_
-00022650: 6275 636b 6574 7322 3a20 5b5d 2c0a 2020  buckets": [],.  
-00022660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022670: 2020 2263 6f6d 6d5f 6176 675f 6475 7261    "comm_avg_dura
-00022680: 7469 6f6e 223a 205b 5d2c 0a20 2020 2020  tion": [],.     
-00022690: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000226a0: 636f 6d6d 5f61 7667 5f73 697a 6522 3a20  comm_avg_size": 
-000226b0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-000226c0: 2020 2020 2020 2020 2263 6f6d 6d5f 7265          "comm_re
-000226d0: 6164 223a 205b 5d2c 0a20 2020 2020 2020  ad": [],.       
-000226e0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-000226f0: 6d6d 5f77 7269 7474 656e 223a 205b 5d2c  mm_written": [],
-00022700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022710: 2020 2020 2022 636f 6d6d 5f63 6f6c 6f72       "comm_color
-00022720: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00022730: 2020 2020 2020 2020 2020 2022 6469 736b             "disk
-00022740: 5f6d 656d 6f72 7922 3a20 5b5d 2c0a 2020  _memory": [],.  
-00022750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022760: 2020 2264 6973 6b5f 6d65 6d6f 7279 5f6c    "disk_memory_l
-00022770: 696d 6974 223a 205b 5d2c 0a20 2020 2020  imit": [],.     
-00022780: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00022790: 6469 736b 5f62 7563 6b65 7473 223a 205b  disk_buckets": [
-000227a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000227b0: 2020 2020 2020 2022 6469 736b 5f61 7667         "disk_avg
-000227c0: 5f64 7572 6174 696f 6e22 3a20 5b5d 2c0a  _duration": [],.
-000227d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227e0: 2020 2020 2264 6973 6b5f 6176 675f 7369      "disk_avg_si
-000227f0: 7a65 223a 205b 5d2c 0a20 2020 2020 2020  ze": [],.       
-00022800: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-00022810: 736b 5f72 6561 6422 3a20 5b5d 2c0a 2020  sk_read": [],.  
-00022820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022830: 2020 2264 6973 6b5f 7772 6974 7465 6e22    "disk_written"
-00022840: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00022850: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
-00022860: 636f 6c6f 7222 3a20 5b5d 2c0a 2020 2020  color": [],.    
-00022870: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00022880: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00022890: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
-000228a0: 616c 735f 736f 7572 6365 203d 2043 6f6c  als_source = Col
-000228b0: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
-000228c0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-000228d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000228e0: 2020 2020 2022 7822 3a20 5b22 4e65 7477       "x": ["Netw
-000228f0: 6f72 6b20 5365 6e64 222c 2022 4e65 7477  ork Send", "Netw
-00022900: 6f72 6b20 5265 6365 6976 6522 2c20 2244  ork Receive", "D
-00022910: 6973 6b20 5772 6974 6522 2c20 2244 6973  isk Write", "Dis
-00022920: 6b20 5265 6164 225d 2c0a 2020 2020 2020  k Read"],.      
-00022930: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-00022940: 616c 7565 7322 3a20 5b30 2c20 302c 2030  alues": [0, 0, 0
-00022950: 2c20 305d 2c0a 2020 2020 2020 2020 2020  , 0],.          
-00022960: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00022970: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00022980: 2020 2073 656c 662e 636f 6d6d 5f6d 656d     self.comm_mem
-00022990: 6f72 7920 3d20 6669 6775 7265 280a 2020  ory = figure(.  
-000229a0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-000229b0: 746c 653d 2243 6f6d 6d73 2042 7566 6665  tle="Comms Buffe
-000229c0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-000229d0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-000229e0: 2020 2020 2020 2020 2020 2020 2020 746f                to
-000229f0: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
-00022a00: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
-00022a10: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-00022a20: 5261 6e67 6531 6428 302c 2031 3030 5f30  Range1d(0, 100_0
-00022a30: 3030 5f30 3030 292c 0a20 2020 2020 2020  00_000),.       
-00022a40: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00022a50: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
-00022a60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00022a70: 662e 636f 6d6d 5f6d 656d 6f72 792e 6862  f.comm_memory.hb
-00022a80: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
-00022a90: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00022aa0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00022ab0: 2020 2020 2020 2020 7269 6768 743d 2263          right="c
-00022ac0: 6f6d 6d5f 6d65 6d6f 7279 222c 0a20 2020  omm_memory",.   
-00022ad0: 2020 2020 2020 2020 2020 2020 2079 3d22               y="
-00022ae0: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-00022af0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
-00022b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b10: 636f 6c6f 723d 2263 6f6d 6d5f 636f 6c6f  color="comm_colo
-00022b20: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-00022b30: 290a 2020 2020 2020 2020 2020 2020 686f  ).            ho
-00022b40: 7665 7220 3d20 486f 7665 7254 6f6f 6c28  ver = HoverTool(
-00022b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b60: 2074 6f6f 6c74 6970 733d 5b0a 2020 2020   tooltips=[.    
-00022b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b80: 2822 4d65 6d6f 7279 2055 7365 6422 2c20  ("Memory Used", 
-00022b90: 2240 636f 6d6d 5f6d 656d 6f72 797b 302e  "@comm_memory{0.
-00022ba0: 3030 2062 7d22 292c 0a20 2020 2020 2020  00 b}"),.       
-00022bb0: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
-00022bc0: 7665 7261 6765 2057 7269 7465 222c 2022  verage Write", "
-00022bd0: 4063 6f6d 6d5f 6176 675f 7369 7a65 7b30  @comm_avg_size{0
-00022be0: 2e30 3020 627d 2229 2c0a 2020 2020 2020  .00 b}"),.      
-00022bf0: 2020 2020 2020 2020 2020 2020 2020 2822                ("
-00022c00: 2320 4275 636b 6574 7322 2c20 2240 636f  # Buckets", "@co
-00022c10: 6d6d 5f62 7563 6b65 7473 2229 2c0a 2020  mm_buckets"),.  
-00022c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c30: 2020 2822 4176 6572 6167 6520 4475 7261    ("Average Dura
-00022c40: 7469 6f6e 222c 2022 4063 6f6d 6d5f 6176  tion", "@comm_av
-00022c50: 675f 6475 7261 7469 6f6e 2229 2c0a 2020  g_duration"),.  
-00022c60: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00022c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022c80: 2066 6f72 6d61 7474 6572 733d 7b22 4063   formatters={"@c
-00022c90: 6f6d 6d5f 6176 675f 6475 7261 7469 6f6e  omm_avg_duration
-00022ca0: 223a 2022 6461 7465 7469 6d65 227d 2c0a  ": "datetime"},.
-00022cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022cc0: 6d6f 6465 3d22 686c 696e 6522 2c0a 2020  mode="hline",.  
-00022cd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00022ce0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
-00022cf0: 6d5f 6d65 6d6f 7279 2e61 6464 5f74 6f6f  m_memory.add_too
-00022d00: 6c73 2868 6f76 6572 290a 2020 2020 2020  ls(hover).      
-00022d10: 2020 2020 2020 7365 6c66 2e63 6f6d 6d5f        self.comm_
-00022d20: 6d65 6d6f 7279 2e78 5f72 616e 6765 2e73  memory.x_range.s
-00022d30: 7461 7274 203d 2030 0a20 2020 2020 2020  tart = 0.       
-00022d40: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
-00022d50: 656d 6f72 792e 785f 7261 6e67 652e 656e  emory.x_range.en
-00022d60: 6420 3d20 310a 2020 2020 2020 2020 2020  d = 1.          
-00022d70: 2020 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f    self.comm_memo
-00022d80: 7279 2e78 6178 6973 5b30 5d2e 666f 726d  ry.xaxis[0].form
-00022d90: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
-00022da0: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
-00022db0: 6d61 743d 2230 2e30 2062 2229 0a0a 2020  mat="0.0 b")..  
-00022dc0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00022dd0: 6973 6b5f 6d65 6d6f 7279 203d 2066 6967  isk_memory = fig
-00022de0: 7572 6528 0a20 2020 2020 2020 2020 2020  ure(.           
-00022df0: 2020 2020 2074 6974 6c65 3d22 4469 736b       title="Disk
-00022e00: 2042 7566 6665 7222 2c0a 2020 2020 2020   Buffer",.      
-00022e10: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-00022e20: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-00022e30: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
-00022e40: 7469 6f6e 3d22 6162 6f76 6522 2c0a 2020  tion="above",.  
-00022e50: 2020 2020 2020 2020 2020 2020 2020 785f                x_
-00022e60: 7261 6e67 653d 5261 6e67 6531 6428 302c  range=Range1d(0,
-00022e70: 2031 3030 5f30 3030 5f30 3030 292c 0a20   100_000_000),. 
-00022e80: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00022e90: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-00022ea0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00022eb0: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
-00022ec0: 6f72 792e 7961 7869 732e 7669 7369 626c  ory.yaxis.visibl
-00022ed0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-00022ee0: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
-00022ef0: 5f6d 656d 6f72 792e 6862 6172 280a 2020  _memory.hbar(.  
-00022f00: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00022f10: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-00022f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00022f30: 2020 7269 6768 743d 2264 6973 6b5f 6d65    right="disk_me
-00022f40: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
-00022f50: 2020 2020 2020 2079 3d22 7922 2c0a 2020         y="y",.  
-00022f60: 2020 2020 2020 2020 2020 2020 2020 6865                he
-00022f70: 6967 6874 3d30 2e39 2c0a 2020 2020 2020  ight=0.9,.      
-00022f80: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-00022f90: 2264 6973 6b5f 636f 6c6f 7222 2c0a 2020  "disk_color",.  
-00022fa0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00022fb0: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
-00022fc0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-00022fd0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00022fe0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
-00022ff0: 2020 2020 2020 2020 2020 2028 224d 656d             ("Mem
-00023000: 6f72 7920 5573 6564 222c 2022 4064 6973  ory Used", "@dis
-00023010: 6b5f 6d65 6d6f 7279 7b30 2e30 3020 627d  k_memory{0.00 b}
-00023020: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00023030: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
-00023040: 6520 5772 6974 6522 2c20 2240 6469 736b  e Write", "@disk
-00023050: 5f61 7667 5f73 697a 657b 302e 3030 2062  _avg_size{0.00 b
-00023060: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
-00023070: 2020 2020 2020 2020 2028 2223 2042 7563           ("# Buc
-00023080: 6b65 7473 222c 2022 4064 6973 6b5f 6275  kets", "@disk_bu
-00023090: 636b 6574 7322 292c 0a20 2020 2020 2020  ckets"),.       
-000230a0: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
-000230b0: 7665 7261 6765 2044 7572 6174 696f 6e22  verage Duration"
-000230c0: 2c20 2240 6469 736b 5f61 7667 5f64 7572  , "@disk_avg_dur
-000230d0: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
-000230e0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000230f0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00023100: 6174 7465 7273 3d7b 2240 6469 736b 5f61  atters={"@disk_a
-00023110: 7667 5f64 7572 6174 696f 6e22 3a20 2264  vg_duration": "d
-00023120: 6174 6574 696d 6522 7d2c 0a20 2020 2020  atetime"},.     
-00023130: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
-00023140: 2268 6c69 6e65 222c 0a20 2020 2020 2020  "hline",.       
-00023150: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00023160: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
-00023170: 6f72 792e 6164 645f 746f 6f6c 7328 686f  ory.add_tools(ho
-00023180: 7665 7229 0a20 2020 2020 2020 2020 2020  ver).           
-00023190: 2073 656c 662e 6469 736b 5f6d 656d 6f72   self.disk_memor
-000231a0: 792e 7861 7869 735b 305d 2e66 6f72 6d61  y.xaxis[0].forma
-000231b0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
-000231c0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
-000231d0: 6174 3d22 302e 3020 6222 290a 0a20 2020  at="0.0 b")..   
-000231e0: 2020 2020 2020 2020 2073 656c 662e 746f           self.to
-000231f0: 7461 6c73 203d 2066 6967 7572 6528 0a20  tals = figure(. 
-00023200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00023210: 6974 6c65 3d22 546f 7461 6c20 6d6f 7665  itle="Total move
-00023220: 6d65 6e74 222c 0a20 2020 2020 2020 2020  ment",.         
-00023230: 2020 2020 2020 2074 6f6f 6c73 3d22 222c         tools="",
-00023240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023250: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
-00023260: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
-00023270: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-00023280: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
-00023290: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
-000232a0: 6974 6c65 7320 3d20 5b22 4e65 7477 6f72  itles = ["Networ
-000232b0: 6b20 5365 6e64 222c 2022 4e65 7477 6f72  k Send", "Networ
-000232c0: 6b20 5265 6365 6976 6522 2c20 2244 6973  k Receive", "Dis
-000232d0: 6b20 5772 6974 6522 2c20 2244 6973 6b20  k Write", "Disk 
-000232e0: 5265 6164 225d 0a20 2020 2020 2020 2020  Read"].         
-000232f0: 2020 2073 656c 662e 746f 7461 6c73 203d     self.totals =
-00023300: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
-00023310: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-00023320: 3d74 6974 6c65 732c 0a20 2020 2020 2020  =titles,.       
-00023330: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
-00023340: 546f 7461 6c73 222c 0a20 2020 2020 2020  Totals",.       
-00023350: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
-00023360: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
-00023370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023380: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-00023390: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-000233a0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-000233b0: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-000233c0: 656c 662e 746f 7461 6c73 2e76 6261 7228  elf.totals.vbar(
-000233d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000233e0: 2078 3d22 7822 2c0a 2020 2020 2020 2020   x="x",.        
-000233f0: 2020 2020 2020 2020 746f 703d 2276 616c          top="val
-00023400: 7565 7322 2c0a 2020 2020 2020 2020 2020  ues",.          
-00023410: 2020 2020 2020 7769 6474 683d 302e 392c        width=0.9,
-00023420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023430: 2073 6f75 7263 653d 7365 6c66 2e74 6f74   source=self.tot
-00023440: 616c 735f 736f 7572 6365 2c0a 2020 2020  als_source,.    
-00023450: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00023460: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00023470: 6c73 2e78 6772 6964 2e67 7269 645f 6c69  ls.xgrid.grid_li
-00023480: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
-00023490: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000234a0: 2e74 6f74 616c 732e 795f 7261 6e67 652e  .totals.y_range.
-000234b0: 7374 6172 7420 3d20 300a 2020 2020 2020  start = 0.      
-000234c0: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
-000234d0: 732e 7961 7869 735b 305d 2e66 6f72 6d61  s.yaxis[0].forma
-000234e0: 7474 6572 203d 204e 756d 6572 616c 5469  tter = NumeralTi
-000234f0: 636b 466f 726d 6174 7465 7228 666f 726d  ckFormatter(form
-00023500: 6174 3d22 302e 3020 6222 290a 0a20 2020  at="0.0 b")..   
-00023510: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
-00023520: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-00023530: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00023540: 7469 7073 3d5b 2822 546f 7461 6c22 2c20  tips=[("Total", 
-00023550: 2240 7661 6c75 6573 7b30 2e30 3062 7d22  "@values{0.00b}"
-00023560: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
-00023570: 2020 2020 6d6f 6465 3d22 766c 696e 6522      mode="vline"
-00023580: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00023590: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000235a0: 2e74 6f74 616c 732e 6164 645f 746f 6f6c  .totals.add_tool
-000235b0: 7328 686f 7665 7229 0a0a 2020 2020 2020  s(hover)..      
-000235c0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-000235d0: 3d20 726f 7728 7365 6c66 2e63 6f6d 6d5f  = row(self.comm_
-000235e0: 6d65 6d6f 7279 2c20 7365 6c66 2e64 6973  memory, self.dis
-000235f0: 6b5f 6d65 6d6f 7279 290a 0a20 2020 2040  k_memory)..    @
-00023600: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-00023610: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-00023620: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-00023630: 3a0a 2020 2020 2020 2020 7769 7468 206c  :.        with l
-00023640: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
-00023650: 2020 2020 2020 2020 2069 6e70 7574 203d           input =
-00023660: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00023670: 6578 7465 6e73 696f 6e73 5b22 7368 7566  extensions["shuf
-00023680: 666c 6522 5d2e 6865 6172 7462 6561 7473  fle"].heartbeats
-00023690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000236a0: 6e6f 7420 696e 7075 743a 0a20 2020 2020  not input:.     
-000236b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000236c0: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
-000236d0: 6e70 7574 203d 206c 6973 7428 696e 7075  nput = list(inpu
-000236e0: 742e 7661 6c75 6573 2829 295b 2d31 5d20  t.values())[-1] 
-000236f0: 2023 2054 4f44 4f3a 206d 756c 7469 706c   # TODO: multipl
-00023700: 6520 636f 6e63 7572 7265 6e74 2073 6875  e concurrent shu
-00023710: 6666 6c65 730a 0a20 2020 2020 2020 2020  ffles..         
-00023720: 2020 2064 6174 6120 3d20 6465 6661 756c     data = defaul
-00023730: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
-00023740: 2020 2020 2020 2020 6e6f 7720 3d20 7469          now = ti
-00023750: 6d65 2829 0a0a 2020 2020 2020 2020 2020  me()..          
-00023760: 2020 666f 7220 692c 2028 776f 726b 6572    for i, (worker
-00023770: 2c20 6429 2069 6e20 656e 756d 6572 6174  , d) in enumerat
-00023780: 6528 696e 7075 742e 6974 656d 7328 2929  e(input.items())
-00023790: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000237a0: 2020 6461 7461 5b22 7922 5d2e 6170 7065    data["y"].appe
-000237b0: 6e64 2869 290a 2020 2020 2020 2020 2020  nd(i).          
-000237c0: 2020 2020 2020 6461 7461 5b22 776f 726b        data["work
-000237d0: 6572 225d 2e61 7070 656e 6428 776f 726b  er"].append(work
-000237e0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-000237f0: 2020 2020 666f 7220 7072 6566 6978 2069      for prefix i
-00023800: 6e20 5b22 636f 6d6d 222c 2022 6469 736b  n ["comm", "disk
-00023810: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-00023820: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-00023830: 7072 6566 6978 7d5f 746f 7461 6c22 5d2e  prefix}_total"].
-00023840: 6170 7065 6e64 2864 5b70 7265 6669 785d  append(d[prefix]
-00023850: 5b22 746f 7461 6c22 5d29 0a20 2020 2020  ["total"]).     
-00023860: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00023870: 6174 615b 6622 7b70 7265 6669 787d 5f6d  ata[f"{prefix}_m
-00023880: 656d 6f72 7922 5d2e 6170 7065 6e64 2864  emory"].append(d
-00023890: 5b70 7265 6669 785d 5b22 6d65 6d6f 7279  [prefix]["memory
-000238a0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-000238b0: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-000238c0: 7072 6566 6978 7d5f 6d65 6d6f 7279 5f6c  prefix}_memory_l
-000238d0: 696d 6974 225d 2e61 7070 656e 6428 645b  imit"].append(d[
-000238e0: 7072 6566 6978 5d5b 226d 656d 6f72 795f  prefix]["memory_
-000238f0: 6c69 6d69 7422 5d29 0a20 2020 2020 2020  limit"]).       
-00023900: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00023910: 615b 6622 7b70 7265 6669 787d 5f62 7563  a[f"{prefix}_buc
-00023920: 6b65 7473 225d 2e61 7070 656e 6428 645b  kets"].append(d[
-00023930: 7072 6566 6978 5d5b 2262 7563 6b65 7473  prefix]["buckets
-00023940: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-00023950: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
-00023960: 7072 6566 6978 7d5f 6176 675f 6475 7261  prefix}_avg_dura
-00023970: 7469 6f6e 225d 2e61 7070 656e 6428 0a20  tion"].append(. 
-00023980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023990: 2020 2020 2020 2064 5b70 7265 6669 785d         d[prefix]
-000239a0: 5b22 6469 6167 6e6f 7374 6963 7322 5d2e  ["diagnostics"].
-000239b0: 6765 7428 2261 7667 5f64 7572 6174 696f  get("avg_duratio
-000239c0: 6e22 2c20 3029 0a20 2020 2020 2020 2020  n", 0).         
-000239d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000239e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239f0: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
-00023a00: 5f61 7667 5f73 697a 6522 5d2e 6170 7065  _avg_size"].appe
-00023a10: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-00023a20: 2020 2020 2020 2020 2020 2020 645b 7072              d[pr
-00023a30: 6566 6978 5d5b 2264 6961 676e 6f73 7469  efix]["diagnosti
-00023a40: 6373 225d 2e67 6574 2822 6176 675f 7369  cs"].get("avg_si
-00023a50: 7a65 222c 2030 290a 2020 2020 2020 2020  ze", 0).        
-00023a60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00023a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a80: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
-00023a90: 7d5f 7265 6164 225d 2e61 7070 656e 6428  }_read"].append(
-00023aa0: 645b 7072 6566 6978 5d5b 2272 6561 6422  d[prefix]["read"
-00023ab0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00023ac0: 2020 2020 2020 2064 6174 615b 6622 7b70         data[f"{p
-00023ad0: 7265 6669 787d 5f77 7269 7474 656e 225d  refix}_written"]
-00023ae0: 2e61 7070 656e 6428 645b 7072 6566 6978  .append(d[prefix
-00023af0: 5d5b 2277 7269 7474 656e 225d 290a 2020  ]["written"]).  
-00023b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b10: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
-00023b20: 6c65 722e 776f 726b 6572 735b 776f 726b  ler.workers[work
-00023b30: 6572 5d2e 6c61 7374 5f73 6565 6e20 3c20  er].last_seen < 
-00023b40: 6e6f 7720 2d20 353a 0a20 2020 2020 2020  now - 5:.       
-00023b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b60: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
-00023b70: 5f63 6f6c 6f72 225d 2e61 7070 656e 6428  _color"].append(
-00023b80: 2267 7261 7922 290a 2020 2020 2020 2020  "gray").        
-00023b90: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00023ba0: 2064 5b70 7265 6669 785d 5b22 6d65 6d6f   d[prefix]["memo
-00023bb0: 7279 225d 203e 2064 5b70 7265 6669 785d  ry"] > d[prefix]
-00023bc0: 5b22 6d65 6d6f 7279 5f6c 696d 6974 225d  ["memory_limit"]
-00023bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023be0: 2020 2020 2020 2020 2020 6461 7461 5b66            data[f
-00023bf0: 227b 7072 6566 6978 7d5f 636f 6c6f 7222  "{prefix}_color"
-00023c00: 5d2e 6170 7065 6e64 2822 7265 6422 290a  ].append("red").
-00023c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c40: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
-00023c50: 7d5f 636f 6c6f 7222 5d2e 6170 7065 6e64  }_color"].append
-00023c60: 2822 626c 7565 2229 0a0a 2020 2020 2020  ("blue")..      
-00023c70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00023c80: 2020 2020 2020 7369 6e67 6c65 746f 6e73        singletons
-00023c90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00023ca0: 2020 2020 2066 227b 7072 6566 6978 7d5f       f"{prefix}_
-00023cb0: 6176 675f 6475 7261 7469 6f6e 223a 205b  avg_duration": [
-00023cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023cd0: 2020 2020 2073 756d 2864 6174 615b 6622       sum(data[f"
-00023ce0: 7b70 7265 6669 787d 5f61 7667 5f64 7572  {prefix}_avg_dur
-00023cf0: 6174 696f 6e22 5d29 202f 206c 656e 2864  ation"]) / len(d
-00023d00: 6174 615b 6622 7b70 7265 6669 787d 5f61  ata[f"{prefix}_a
-00023d10: 7667 5f64 7572 6174 696f 6e22 5d29 0a20  vg_duration"]). 
-00023d20: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-00023d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023d40: 2020 6622 7b70 7265 6669 787d 5f61 7667    f"{prefix}_avg
-00023d50: 5f73 697a 6522 3a20 5b0a 2020 2020 2020  _size": [.      
-00023d60: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00023d70: 6d28 6461 7461 5b66 227b 7072 6566 6978  m(data[f"{prefix
-00023d80: 7d5f 6176 675f 7369 7a65 225d 2920 2f20  }_avg_size"]) / 
-00023d90: 6c65 6e28 6461 7461 5b66 227b 7072 6566  len(data[f"{pref
-00023da0: 6978 7d5f 6176 675f 7369 7a65 225d 290a  ix}_avg_size"]).
-00023db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023dc0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00023dd0: 2020 2022 6469 736b 5f61 7667 5f64 7572     "disk_avg_dur
-00023de0: 6174 696f 6e22 3a20 5b0a 2020 2020 2020  ation": [.      
-00023df0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00023e00: 6d28 6461 7461 5b22 6469 736b 5f61 7667  m(data["disk_avg
-00023e10: 5f64 7572 6174 696f 6e22 5d29 202f 206c  _duration"]) / l
-00023e20: 656e 2864 6174 615b 2264 6973 6b5f 6176  en(data["disk_av
-00023e30: 675f 6475 7261 7469 6f6e 225d 290a 2020  g_duration"]).  
-00023e40: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
-00023e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023e60: 2022 6469 736b 5f61 7667 5f73 697a 6522   "disk_avg_size"
-00023e70: 3a20 5b0a 2020 2020 2020 2020 2020 2020  : [.            
-00023e80: 2020 2020 2020 2020 7375 6d28 6461 7461          sum(data
-00023e90: 5b22 6469 736b 5f61 7667 5f73 697a 6522  ["disk_avg_size"
-00023ea0: 5d29 202f 206c 656e 2864 6174 615b 2264  ]) / len(data["d
-00023eb0: 6973 6b5f 6176 675f 7369 7a65 225d 290a  isk_avg_size"]).
-00023ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ed0: 5d2c 0a20 2020 2020 2020 2020 2020 207d  ],.            }
-00023ee0: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
-00023ef0: 676c 6574 6f6e 735b 6622 7b70 7265 6669  gletons[f"{prefi
-00023f00: 787d 5f61 7667 5f62 616e 6477 6964 7468  x}_avg_bandwidth
-00023f10: 225d 203d 205b 0a20 2020 2020 2020 2020  "] = [.         
-00023f20: 2020 2020 2020 2073 696e 676c 6574 6f6e         singleton
-00023f30: 735b 6622 7b70 7265 6669 787d 5f61 7667  s[f"{prefix}_avg
-00023f40: 5f73 697a 6522 5d5b 305d 202f 2073 696e  _size"][0] / sin
-00023f50: 676c 6574 6f6e 735b 6622 7b70 7265 6669  gletons[f"{prefi
-00023f60: 787d 5f61 7667 5f64 7572 6174 696f 6e22  x}_avg_duration"
-00023f70: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
-00023f80: 205d 0a20 2020 2020 2020 2020 2020 2073   ].            s
-00023f90: 696e 676c 6574 6f6e 735b 2264 6973 6b5f  ingletons["disk_
-00023fa0: 6176 675f 6261 6e64 7769 6474 6822 5d20  avg_bandwidth"] 
-00023fb0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00023fc0: 2020 2020 7369 6e67 6c65 746f 6e73 5b22      singletons["
-00023fd0: 6469 736b 5f61 7667 5f73 697a 6522 5d5b  disk_avg_size"][
-00023fe0: 305d 202f 2073 696e 676c 6574 6f6e 735b  0] / singletons[
-00023ff0: 2264 6973 6b5f 6176 675f 6475 7261 7469  "disk_avg_durati
-00024000: 6f6e 225d 5b30 5d0a 2020 2020 2020 2020  on"][0].        
-00024010: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-00024020: 2020 7369 6e67 6c65 746f 6e73 5b22 7922    singletons["y"
-00024030: 5d20 3d20 5b64 6174 615b 2279 225d 5b2d  ] = [data["y"][-
-00024040: 315d 202f 2032 5d0a 2020 2020 2020 2020  1] / 2].        
-00024050: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00024060: 2020 2020 2074 6f74 616c 7320 3d20 7b0a       totals = {.
-00024070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024080: 2278 223a 205b 224e 6574 776f 726b 2053  "x": ["Network S
-00024090: 656e 6422 2c20 224e 6574 776f 726b 2052  end", "Network R
-000240a0: 6563 6569 7665 222c 2022 4469 736b 2057  eceive", "Disk W
-000240b0: 7269 7465 222c 2022 4469 736b 2052 6561  rite", "Disk Rea
-000240c0: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
-000240d0: 2020 2020 2022 7661 6c75 6573 223a 205b       "values": [
-000240e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000240f0: 2020 2020 2073 756d 2864 6174 615b 2263       sum(data["c
-00024100: 6f6d 6d5f 7772 6974 7465 6e22 5d29 2c0a  omm_written"]),.
-00024110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024120: 2020 2020 7375 6d28 6461 7461 5b22 636f      sum(data["co
-00024130: 6d6d 5f72 6561 6422 5d29 2c0a 2020 2020  mm_read"]),.    
-00024140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024150: 7375 6d28 6461 7461 5b22 6469 736b 5f77  sum(data["disk_w
-00024160: 7269 7474 656e 225d 292c 0a20 2020 2020  ritten"]),.     
-00024170: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00024180: 756d 2864 6174 615b 2264 6973 6b5f 7265  um(data["disk_re
-00024190: 6164 225d 292c 0a20 2020 2020 2020 2020  ad"]),.         
-000241a0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000241b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000241c0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-000241d0: 746f 7461 6c73 5f73 6f75 7263 652c 2074  totals_source, t
-000241e0: 6f74 616c 7329 0a0a 2020 2020 2020 2020  otals)..        
-000241f0: 2020 2020 7570 6461 7465 2873 656c 662e      update(self.
-00024200: 736f 7572 6365 2c20 6469 6374 2864 6174  source, dict(dat
-00024210: 6129 290a 2020 2020 2020 2020 2020 2020  a)).            
-00024220: 6c69 6d69 7420 3d20 6d61 7828 6461 7461  limit = max(data
-00024230: 5b22 636f 6d6d 5f6d 656d 6f72 795f 6c69  ["comm_memory_li
-00024240: 6d69 7422 5d20 2b20 6461 7461 5b22 6469  mit"] + data["di
-00024250: 736b 5f6d 656d 6f72 795f 6c69 6d69 7422  sk_memory_limit"
-00024260: 5d29 202a 2031 2e32 0a20 2020 2020 2020  ]) * 1.2.       
-00024270: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
-00024280: 656d 6f72 792e 785f 7261 6e67 652e 656e  emory.x_range.en
-00024290: 6420 3d20 6c69 6d69 740a 2020 2020 2020  d = limit.      
-000242a0: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
-000242b0: 6d65 6d6f 7279 2e78 5f72 616e 6765 2e65  memory.x_range.e
-000242c0: 6e64 203d 206c 696d 6974 0a0a 0a5f 5354  nd = limit..._ST
-000242d0: 594c 4553 203d 207b 0a20 2020 2022 7769  YLES = {.    "wi
-000242e0: 6474 6822 3a20 2231 3030 2522 2c0a 2020  dth": "100%",.  
-000242f0: 2020 2268 6569 6768 7422 3a20 2231 3030    "height": "100
-00024300: 2522 2c0a 2020 2020 226d 6178 2d77 6964  %",.    "max-wid
-00024310: 7468 223a 2022 3139 3230 7078 222c 0a20  th": "1920px",. 
-00024320: 2020 2022 6d61 782d 6865 6967 6874 223a     "max-height":
-00024330: 2022 3130 3830 7078 222c 0a20 2020 2022   "1080px",.    "
-00024340: 7061 6464 696e 6722 3a20 2231 3270 7822  padding": "12px"
-00024350: 2c0a 2020 2020 2262 6f72 6465 7222 3a20  ,.    "border": 
-00024360: 2231 7078 2073 6f6c 6964 206c 6967 6874  "1px solid light
-00024370: 6772 6179 222c 0a20 2020 2022 626f 782d  gray",.    "box-
-00024380: 7368 6164 6f77 223a 2022 696e 7365 7420  shadow": "inset 
-00024390: 3170 7820 3020 3870 7820 3020 6c69 6768  1px 0 8px 0 ligh
-000243a0: 7467 7261 7922 2c0a 2020 2020 226f 7665  tgray",.    "ove
-000243b0: 7266 6c6f 7722 3a20 2261 7574 6f22 2c0a  rflow": "auto",.
-000243c0: 7d0a 6966 2042 4f4b 4548 5f56 4552 5349  }.if BOKEH_VERSI
-000243d0: 4f4e 2e6d 616a 6f72 203c 2033 3a0a 2020  ON.major < 3:.  
-000243e0: 2020 5f42 4f4b 4548 5f53 5459 4c45 535f    _BOKEH_STYLES_
-000243f0: 4b57 4152 4753 203d 207b 2273 7479 6c65  KWARGS = {"style
-00024400: 223a 205f 5354 594c 4553 7d0a 656c 7365  ": _STYLES}.else
-00024410: 3a0a 2020 2020 5f42 4f4b 4548 5f53 5459  :.    _BOKEH_STY
-00024420: 4c45 535f 4b57 4152 4753 203d 207b 2273  LES_KWARGS = {"s
-00024430: 7479 6c65 7322 3a20 5f53 5459 4c45 537d  tyles": _STYLES}
-00024440: 0a0a 0a63 6c61 7373 2053 6368 6564 756c  ...class Schedul
-00024450: 6572 4c6f 6773 3a0a 2020 2020 6465 6620  erLogs:.    def 
-00024460: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-00024470: 6368 6564 756c 6572 2c20 7374 6172 743d  cheduler, start=
-00024480: 4e6f 6e65 293a 0a20 2020 2020 2020 206c  None):.        l
-00024490: 6f67 7320 3d20 7363 6865 6475 6c65 722e  ogs = scheduler.
-000244a0: 6765 745f 6c6f 6773 2873 7461 7274 3d73  get_logs(start=s
-000244b0: 7461 7274 2c20 7469 6d65 7374 616d 7073  tart, timestamps
-000244c0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-000244d0: 6966 206e 6f74 206c 6f67 733a 0a20 2020  if not logs:.   
-000244e0: 2020 2020 2020 2020 206c 6f67 735f 6874           logs_ht
-000244f0: 6d6c 203d 2028 0a20 2020 2020 2020 2020  ml = (.         
-00024500: 2020 2020 2020 2027 3c70 2073 7479 6c65         '<p style
-00024510: 3d22 666f 6e74 2d66 616d 696c 793a 206d  ="font-family: m
-00024520: 6f6e 6f73 7061 6365 3b20 6d61 7267 696e  onospace; margin
-00024530: 3a20 303b 223e 4e6f 206c 6f67 7320 746f  : 0;">No logs to
-00024540: 2072 6570 6f72 743c 2f70 3e27 0a20 2020   report</p>'.   
-00024550: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00024560: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00024570: 2020 2020 206c 6f67 735f 6874 6d6c 203d       logs_html =
-00024580: 204c 6f67 280a 2020 2020 2020 2020 2020   Log(.          
-00024590: 2020 2020 2020 225c 6e22 2e6a 6f69 6e28        "\n".join(
-000245a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000245b0: 2020 2020 2022 2573 202d 2025 7322 0a20       "%s - %s". 
-000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245d0: 2020 2025 2028 6461 7465 7469 6d65 2e66     % (datetime.f
-000245e0: 726f 6d74 696d 6573 7461 6d70 2874 696d  romtimestamp(tim
-000245f0: 6529 2e73 7472 6674 696d 6528 2225 483a  e).strftime("%H:
-00024600: 254d 3a25 532e 2566 2229 2c20 6c69 6e65  %M:%S.%f"), line
-00024610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00024620: 2020 2020 2020 666f 7220 7469 6d65 2c20        for time, 
-00024630: 6c65 7665 6c2c 206c 696e 6520 696e 206c  level, line in l
-00024640: 6f67 730a 2020 2020 2020 2020 2020 2020  ogs.            
-00024650: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00024660: 2020 292e 5f72 6570 725f 6874 6d6c 5f28    )._repr_html_(
-00024670: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00024680: 726f 6f74 203d 2044 6976 2874 6578 743d  root = Div(text=
-00024690: 6c6f 6773 5f68 746d 6c2c 202a 2a5f 424f  logs_html, **_BO
-000246a0: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-000246b0: 5329 0a0a 0a40 6c6f 675f 6572 726f 7273  S)...@log_errors
-000246c0: 0a64 6566 2073 7973 7465 6d6d 6f6e 6974  .def systemmonit
-000246d0: 6f72 5f64 6f63 2873 6368 6564 756c 6572  or_doc(scheduler
-000246e0: 2c20 6578 7472 612c 2064 6f63 293a 0a20  , extra, doc):. 
-000246f0: 2020 2073 7973 6d6f 6e20 3d20 5379 7374     sysmon = Syst
-00024700: 656d 4d6f 6e69 746f 7228 7363 6865 6475  emMonitor(schedu
-00024710: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
-00024720: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
-00024730: 0a20 2020 2064 6f63 2e74 6974 6c65 203d  .    doc.title =
-00024740: 2022 4461 736b 3a20 5363 6865 6475 6c65   "Dask: Schedule
-00024750: 7220 5379 7374 656d 204d 6f6e 6974 6f72  r System Monitor
-00024760: 220a 2020 2020 6164 645f 7065 7269 6f64  ".    add_period
-00024770: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00024780: 2073 7973 6d6f 6e2c 2035 3030 290a 0a20   sysmon, 500).. 
-00024790: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-000247a0: 7379 736d 6f6e 2e72 6f6f 7429 0a20 2020  sysmon.root).   
-000247b0: 2064 6f63 2e74 656d 706c 6174 6520 3d20   doc.template = 
-000247c0: 656e 762e 6765 745f 7465 6d70 6c61 7465  env.get_template
-000247d0: 2822 7369 6d70 6c65 2e68 746d 6c22 290a  ("simple.html").
-000247e0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-000247f0: 5f76 6172 6961 626c 6573 2e75 7064 6174  _variables.updat
-00024800: 6528 6578 7472 6129 0a20 2020 2064 6f63  e(extra).    doc
-00024810: 2e74 6865 6d65 203d 2042 4f4b 4548 5f54  .theme = BOKEH_T
-00024820: 4845 4d45 0a0a 0a40 6c6f 675f 6572 726f  HEME...@log_erro
-00024830: 7273 0a64 6566 2073 6875 6666 6c69 6e67  rs.def shuffling
-00024840: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
-00024850: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
-00024860: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
-00024870: 736b 3a20 5368 7566 666c 696e 6722 0a0a  sk: Shuffling"..
-00024880: 2020 2020 7368 7566 666c 696e 6720 3d20      shuffling = 
-00024890: 5368 7566 666c 696e 6728 7363 6865 6475  Shuffling(schedu
-000248a0: 6c65 722c 2077 6964 7468 3d34 3030 2c20  ler, width=400, 
-000248b0: 6865 6967 6874 3d34 3030 290a 2020 2020  height=400).    
-000248c0: 776f 726b 6572 735f 6d65 6d6f 7279 203d  workers_memory =
-000248d0: 2057 6f72 6b65 7273 4d65 6d6f 7279 2873   WorkersMemory(s
-000248e0: 6368 6564 756c 6572 2c20 7769 6474 683d  cheduler, width=
-000248f0: 3430 302c 2068 6569 6768 743d 3430 3029  400, height=400)
-00024900: 0a20 2020 2074 696d 6573 6572 6965 7320  .    timeseries 
-00024910: 3d20 5379 7374 656d 5469 6d65 7365 7269  = SystemTimeseri
-00024920: 6573 280a 2020 2020 2020 2020 7363 6865  es(.        sche
-00024930: 6475 6c65 722c 2077 6964 7468 3d31 3630  duler, width=160
-00024940: 302c 2068 6569 6768 743d 3230 302c 2066  0, height=200, f
-00024950: 6f6c 6c6f 775f 696e 7465 7276 616c 3d33  ollow_interval=3
-00024960: 3030 300a 2020 2020 290a 2020 2020 6576  000.    ).    ev
-00024970: 656e 745f 6c6f 6f70 203d 2043 6f6e 7465  ent_loop = Conte
-00024980: 6e74 696f 6e28 7363 6865 6475 6c65 722c  ntion(scheduler,
-00024990: 2077 6964 7468 3d32 3030 2c20 6865 6967   width=200, heig
-000249a0: 6874 3d34 3030 290a 0a20 2020 2061 6464  ht=400)..    add
-000249b0: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-000249c0: 636b 2864 6f63 2c20 7368 7566 666c 696e  ck(doc, shufflin
-000249d0: 672c 2032 3030 290a 2020 2020 6164 645f  g, 200).    add_
-000249e0: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
-000249f0: 6b28 646f 632c 2077 6f72 6b65 7273 5f6d  k(doc, workers_m
-00024a00: 656d 6f72 792c 2032 3030 290a 2020 2020  emory, 200).    
-00024a10: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00024a20: 6c62 6163 6b28 646f 632c 2074 696d 6573  lback(doc, times
-00024a30: 6572 6965 732c 2035 3030 290a 2020 2020  eries, 500).    
-00024a40: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00024a50: 6c62 6163 6b28 646f 632c 2065 7665 6e74  lback(doc, event
-00024a60: 5f6c 6f6f 702c 2035 3030 290a 0a20 2020  _loop, 500)..   
-00024a70: 2074 696d 6573 6572 6965 732e 6261 6e64   timeseries.band
-00024a80: 7769 6474 682e 795f 7261 6e67 6520 3d20  width.y_range = 
-00024a90: 7469 6d65 7365 7269 6573 2e64 6973 6b2e  timeseries.disk.
-00024aa0: 795f 7261 6e67 650a 0a20 2020 2064 6f63  y_range..    doc
-00024ab0: 2e61 6464 5f72 6f6f 7428 0a20 2020 2020  .add_root(.     
-00024ac0: 2020 2063 6f6c 756d 6e28 0a20 2020 2020     column(.     
-00024ad0: 2020 2020 2020 2072 6f77 280a 2020 2020         row(.    
-00024ae0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00024af0: 6572 735f 6d65 6d6f 7279 2e72 6f6f 742c  ers_memory.root,
-00024b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024b10: 2073 6875 6666 6c69 6e67 2e63 6f6d 6d5f   shuffling.comm_
-00024b20: 6d65 6d6f 7279 2c0a 2020 2020 2020 2020  memory,.        
-00024b30: 2020 2020 2020 2020 7368 7566 666c 696e          shufflin
-00024b40: 672e 6469 736b 5f6d 656d 6f72 792c 0a20  g.disk_memory,. 
-00024b50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00024b60: 6875 6666 6c69 6e67 2e74 6f74 616c 732c  huffling.totals,
-00024b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024b80: 2065 7665 6e74 5f6c 6f6f 702e 726f 6f74   event_loop.root
-00024b90: 2c0a 2020 2020 2020 2020 2020 2020 292c  ,.            ),
-00024ba0: 0a20 2020 2020 2020 2020 2020 2072 6f77  .            row
-00024bb0: 2863 6f6c 756d 6e28 7469 6d65 7365 7269  (column(timeseri
-00024bc0: 6573 2e62 616e 6477 6964 7468 2c20 7469  es.bandwidth, ti
-00024bd0: 6d65 7365 7269 6573 2e64 6973 6b29 292c  meseries.disk)),
-00024be0: 0a20 2020 2020 2020 2029 0a20 2020 2029  .        ).    )
-00024bf0: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
-00024c00: 6520 3d20 656e 762e 6765 745f 7465 6d70  e = env.get_temp
-00024c10: 6c61 7465 2822 7369 6d70 6c65 2e68 746d  late("simple.htm
-00024c20: 6c22 290a 2020 2020 646f 632e 7465 6d70  l").    doc.temp
-00024c30: 6c61 7465 5f76 6172 6961 626c 6573 2e75  late_variables.u
-00024c40: 7064 6174 6528 6578 7472 6129 0a20 2020  pdate(extra).   
-00024c50: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
-00024c60: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
-00024c70: 6572 726f 7273 0a64 6566 2073 7465 616c  errors.def steal
-00024c80: 696e 675f 646f 6328 7363 6865 6475 6c65  ing_doc(schedule
-00024c90: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-00024ca0: 2020 2020 6f63 6375 7061 6e63 7920 3d20      occupancy = 
-00024cb0: 4f63 6375 7061 6e63 7928 7363 6865 6475  Occupancy(schedu
-00024cc0: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
-00024cd0: 675f 7473 203d 2053 7465 616c 696e 6754  g_ts = StealingT
-00024ce0: 696d 6553 6572 6965 7328 7363 6865 6475  imeSeries(schedu
-00024cf0: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
-00024d00: 675f 6576 656e 7473 203d 2053 7465 616c  g_events = Steal
-00024d10: 696e 6745 7665 6e74 7328 7363 6865 6475  ingEvents(schedu
-00024d20: 6c65 7229 0a20 2020 2073 7465 616c 696e  ler).    stealin
-00024d30: 675f 6576 656e 7473 2e72 6f6f 742e 785f  g_events.root.x_
-00024d40: 7261 6e67 6520 3d20 7374 6561 6c69 6e67  range = stealing
-00024d50: 5f74 732e 726f 6f74 2e78 5f72 616e 6765  _ts.root.x_range
-00024d60: 0a20 2020 2064 6f63 2e74 6974 6c65 203d  .    doc.title =
-00024d70: 2022 4461 736b 3a20 576f 726b 2053 7465   "Dask: Work Ste
-00024d80: 616c 696e 6722 0a20 2020 2061 6464 5f70  aling".    add_p
-00024d90: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00024da0: 2864 6f63 2c20 6f63 6375 7061 6e63 792c  (doc, occupancy,
-00024db0: 2035 3030 290a 2020 2020 6164 645f 7065   500).    add_pe
-00024dc0: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
-00024dd0: 646f 632c 2073 7465 616c 696e 675f 7473  doc, stealing_ts
-00024de0: 2c20 3530 3029 0a20 2020 2061 6464 5f70  , 500).    add_p
-00024df0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00024e00: 2864 6f63 2c20 7374 6561 6c69 6e67 5f65  (doc, stealing_e
-00024e10: 7665 6e74 732c 2035 3030 290a 0a20 2020  vents, 500)..   
-00024e20: 2064 6f63 2e61 6464 5f72 6f6f 7428 0a20   doc.add_root(. 
-00024e30: 2020 2020 2020 2072 6f77 280a 2020 2020         row(.    
-00024e40: 2020 2020 2020 2020 6f63 6375 7061 6e63          occupanc
-00024e50: 792e 726f 6f74 2c0a 2020 2020 2020 2020  y.root,.        
-00024e60: 2020 2020 636f 6c75 6d6e 280a 2020 2020      column(.    
-00024e70: 2020 2020 2020 2020 2020 2020 7374 6561              stea
-00024e80: 6c69 6e67 5f74 732e 726f 6f74 2c0a 2020  ling_ts.root,.  
-00024e90: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00024ea0: 6561 6c69 6e67 5f65 7665 6e74 732e 726f  ealing_events.ro
-00024eb0: 6f74 2c0a 2020 2020 2020 2020 2020 2020  ot,.            
-00024ec0: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
-00024ed0: 2273 7472 6574 6368 5f62 6f74 6822 2c0a  "stretch_both",.
-00024ee0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-00024ef0: 2020 2020 2020 2029 0a20 2020 2029 0a0a         ).    )..
-00024f00: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00024f10: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00024f20: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00024f30: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-00024f40: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00024f50: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-00024f60: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-00024f70: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
-00024f80: 7272 6f72 730a 6465 6620 6576 656e 7473  rrors.def events
-00024f90: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
-00024fa0: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
-00024fb0: 2065 7665 6e74 7320 3d20 4576 656e 7473   events = Events
-00024fc0: 2873 6368 6564 756c 6572 2c20 2261 6c6c  (scheduler, "all
-00024fd0: 222c 2068 6569 6768 743d 3235 3029 0a20  ", height=250). 
-00024fe0: 2020 2065 7665 6e74 732e 7570 6461 7465     events.update
-00024ff0: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
-00025000: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00025010: 2c20 6576 656e 7473 2c20 3530 3029 0a20  , events, 500). 
-00025020: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
-00025030: 4461 736b 3a20 5363 6865 6475 6c65 7220  Dask: Scheduler 
-00025040: 4576 656e 7473 220a 2020 2020 646f 632e  Events".    doc.
-00025050: 6164 645f 726f 6f74 2863 6f6c 756d 6e28  add_root(column(
-00025060: 6576 656e 7473 2e72 6f6f 742c 2073 697a  events.root, siz
-00025070: 696e 675f 6d6f 6465 3d22 7363 616c 655f  ing_mode="scale_
-00025080: 7769 6474 6822 2929 0a20 2020 2064 6f63  width")).    doc
-00025090: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
-000250a0: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
-000250b0: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
-000250c0: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
-000250d0: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
-000250e0: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
-000250f0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
-00025100: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
-00025110: 6566 2065 7863 6570 7469 6f6e 735f 646f  ef exceptions_do
-00025120: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
-00025130: 7261 2c20 646f 6329 3a0a 2020 2020 7461  ra, doc):.    ta
-00025140: 626c 6520 3d20 4578 6365 7074 696f 6e73  ble = Exceptions
-00025150: 5461 626c 6528 7363 6865 6475 6c65 7229  Table(scheduler)
-00025160: 0a20 2020 2074 6162 6c65 2e75 7064 6174  .    table.updat
-00025170: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
-00025180: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
-00025190: 632c 2074 6162 6c65 2c20 3130 3030 290a  c, table, 1000).
-000251a0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-000251b0: 2244 6173 6b3a 2045 7863 6570 7469 6f6e  "Dask: Exception
-000251c0: 7322 0a20 2020 2064 6f63 2e61 6464 5f72  s".    doc.add_r
-000251d0: 6f6f 7428 7461 626c 652e 726f 6f74 290a  oot(table.root).
-000251e0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-000251f0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00025200: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00025210: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-00025220: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00025230: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-00025240: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-00025250: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
-00025260: 7272 6f72 730a 6465 6620 776f 726b 6572  rrors.def worker
-00025270: 735f 646f 6328 7363 6865 6475 6c65 722c  s_doc(scheduler,
-00025280: 2065 7874 7261 2c20 646f 6329 3a0a 2020   extra, doc):.  
-00025290: 2020 7461 626c 6520 3d20 576f 726b 6572    table = Worker
-000252a0: 5461 626c 6528 7363 6865 6475 6c65 7229  Table(scheduler)
-000252b0: 0a20 2020 2074 6162 6c65 2e75 7064 6174  .    table.updat
-000252c0: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
-000252d0: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
-000252e0: 632c 2074 6162 6c65 2c20 3530 3029 0a20  c, table, 500). 
-000252f0: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
-00025300: 4461 736b 3a20 576f 726b 6572 7322 0a20  Dask: Workers". 
-00025310: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-00025320: 7461 626c 652e 726f 6f74 290a 2020 2020  table.root).    
-00025330: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00025340: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00025350: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00025360: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00025370: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00025380: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00025390: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-000253a0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-000253b0: 730a 6465 6620 6861 7264 7761 7265 5f64  s.def hardware_d
-000253c0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-000253d0: 7472 612c 2064 6f63 293a 0a20 2020 2068  tra, doc):.    h
-000253e0: 7720 3d20 4861 7264 7761 7265 2873 6368  w = Hardware(sch
-000253f0: 6564 756c 6572 290a 2020 2020 6877 2e75  eduler).    hw.u
-00025400: 7064 6174 6528 290a 2020 2020 646f 632e  pdate().    doc.
-00025410: 7469 746c 6520 3d20 2244 6173 6b3a 2043  title = "Dask: C
-00025420: 6c75 7374 6572 2048 6172 6477 6172 6520  luster Hardware 
-00025430: 4261 6e64 7769 6474 6822 0a20 2020 2064  Bandwidth".    d
-00025440: 6f63 2e61 6464 5f72 6f6f 7428 6877 2e72  oc.add_root(hw.r
-00025450: 6f6f 7429 0a20 2020 2064 6f63 2e74 656d  oot).    doc.tem
-00025460: 706c 6174 6520 3d20 656e 762e 6765 745f  plate = env.get_
-00025470: 7465 6d70 6c61 7465 2822 7369 6d70 6c65  template("simple
-00025480: 2e68 746d 6c22 290a 2020 2020 646f 632e  .html").    doc.
-00025490: 7465 6d70 6c61 7465 5f76 6172 6961 626c  template_variabl
-000254a0: 6573 2e75 7064 6174 6528 6578 7472 6129  es.update(extra)
-000254b0: 0a20 2020 2064 6f63 2e74 6865 6d65 203d  .    doc.theme =
-000254c0: 2042 4f4b 4548 5f54 4845 4d45 0a0a 2020   BOKEH_THEME..  
-000254d0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-000254e0: 616c 6c62 6163 6b28 646f 632c 2068 772c  allback(doc, hw,
-000254f0: 2035 3030 290a 0a0a 406c 6f67 5f65 7272   500)...@log_err
-00025500: 6f72 730a 6465 6620 7461 736b 735f 646f  ors.def tasks_do
-00025510: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
-00025520: 7261 2c20 646f 6329 3a0a 2020 2020 7473  ra, doc):.    ts
-00025530: 203d 2054 6173 6b53 7472 6561 6d28 0a20   = TaskStream(. 
-00025540: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-00025550: 2c0a 2020 2020 2020 2020 6e5f 7265 6374  ,.        n_rect
-00025560: 616e 676c 6573 3d64 6173 6b2e 636f 6e66  angles=dask.conf
-00025570: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
-00025580: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
-00025590: 2e73 6368 6564 756c 6572 2e64 6173 6862  .scheduler.dashb
-000255a0: 6f61 7264 2e74 6173 6b73 2e74 6173 6b2d  oard.tasks.task-
-000255b0: 7374 7265 616d 2d6c 656e 6774 6822 0a20  stream-length". 
-000255c0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-000255d0: 2020 636c 6561 725f 696e 7465 7276 616c    clear_interval
-000255e0: 3d22 3630 7322 2c0a 2020 2020 2020 2020  ="60s",.        
-000255f0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-00025600: 6574 6368 5f62 6f74 6822 2c0a 2020 2020  etch_both",.    
-00025610: 290a 2020 2020 7473 2e75 7064 6174 6528  ).    ts.update(
-00025620: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
-00025630: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00025640: 2074 732c 2035 3030 3029 0a20 2020 2064   ts, 5000).    d
-00025650: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
-00025660: 3a20 5461 736b 2053 7472 6561 6d22 0a20  : Task Stream". 
-00025670: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-00025680: 7473 2e72 6f6f 7429 0a20 2020 2064 6f63  ts.root).    doc
-00025690: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
-000256a0: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
-000256b0: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
-000256c0: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
-000256d0: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
-000256e0: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
-000256f0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
-00025700: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
-00025710: 6566 2067 7261 7068 5f64 6f63 2873 6368  ef graph_doc(sch
-00025720: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-00025730: 6f63 293a 0a20 2020 2067 7261 7068 203d  oc):.    graph =
-00025740: 2054 6173 6b47 7261 7068 2873 6368 6564   TaskGraph(sched
-00025750: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-00025760: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00025770: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
-00025780: 3d20 2244 6173 6b3a 2054 6173 6b20 4772  = "Dask: Task Gr
-00025790: 6170 6822 0a20 2020 2067 7261 7068 2e75  aph".    graph.u
-000257a0: 7064 6174 6528 290a 2020 2020 6164 645f  pdate().    add_
-000257b0: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
-000257c0: 6b28 646f 632c 2067 7261 7068 2c20 3230  k(doc, graph, 20
-000257d0: 3029 0a20 2020 2064 6f63 2e61 6464 5f72  0).    doc.add_r
-000257e0: 6f6f 7428 6772 6170 682e 726f 6f74 290a  oot(graph.root).
-000257f0: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
-00025800: 6520 3d20 656e 762e 6765 745f 7465 6d70  e = env.get_temp
-00025810: 6c61 7465 2822 7369 6d70 6c65 2e68 746d  late("simple.htm
-00025820: 6c22 290a 2020 2020 646f 632e 7465 6d70  l").    doc.temp
-00025830: 6c61 7465 5f76 6172 6961 626c 6573 2e75  late_variables.u
-00025840: 7064 6174 6528 6578 7472 6129 0a20 2020  pdate(extra).   
-00025850: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
-00025860: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
-00025870: 6572 726f 7273 0a64 6566 2074 675f 6772  errors.def tg_gr
-00025880: 6170 685f 646f 6328 7363 6865 6475 6c65  aph_doc(schedule
-00025890: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-000258a0: 2020 2020 7467 5f67 7261 7068 203d 2054      tg_graph = T
-000258b0: 6173 6b47 726f 7570 4772 6170 6828 7363  askGroupGraph(sc
-000258c0: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-000258d0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-000258e0: 7468 2229 0a20 2020 2064 6f63 2e74 6974  th").    doc.tit
-000258f0: 6c65 203d 2022 4461 736b 3a20 5461 736b  le = "Dask: Task
-00025900: 2047 726f 7570 7320 4772 6170 6822 0a20   Groups Graph". 
-00025910: 2020 2074 675f 6772 6170 682e 7570 6461     tg_graph.upda
-00025920: 7465 2829 0a20 2020 2061 6464 5f70 6572  te().    add_per
-00025930: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00025940: 6f63 2c20 7467 5f67 7261 7068 2c20 3230  oc, tg_graph, 20
-00025950: 3029 0a20 2020 2064 6f63 2e61 6464 5f72  0).    doc.add_r
-00025960: 6f6f 7428 7467 5f67 7261 7068 2e72 6f6f  oot(tg_graph.roo
-00025970: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
-00025980: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
-00025990: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
-000259a0: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
-000259b0: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
-000259c0: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
-000259d0: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
-000259e0: 4f4b 4548 5f54 4845 4d45 0a0a 0a40 6c6f  OKEH_THEME...@lo
-000259f0: 675f 6572 726f 7273 0a64 6566 2073 7461  g_errors.def sta
-00025a00: 7475 735f 646f 6328 7363 6865 6475 6c65  tus_doc(schedule
-00025a10: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-00025a20: 2020 2020 636c 7573 7465 725f 6d65 6d6f      cluster_memo
-00025a30: 7279 203d 2043 6c75 7374 6572 4d65 6d6f  ry = ClusterMemo
-00025a40: 7279 2873 6368 6564 756c 6572 2c20 7369  ry(scheduler, si
-00025a50: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-00025a60: 6368 5f62 6f74 6822 290a 2020 2020 636c  ch_both").    cl
-00025a70: 7573 7465 725f 6d65 6d6f 7279 2e75 7064  uster_memory.upd
-00025a80: 6174 6528 290a 2020 2020 6164 645f 7065  ate().    add_pe
-00025a90: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
-00025aa0: 646f 632c 2063 6c75 7374 6572 5f6d 656d  doc, cluster_mem
-00025ab0: 6f72 792c 2031 3030 290a 2020 2020 646f  ory, 100).    do
-00025ac0: 632e 6164 645f 726f 6f74 2863 6c75 7374  c.add_root(clust
-00025ad0: 6572 5f6d 656d 6f72 792e 726f 6f74 290a  er_memory.root).
-00025ae0: 0a20 2020 2069 6620 6c65 6e28 7363 6865  .    if len(sche
-00025af0: 6475 6c65 722e 776f 726b 6572 7329 203c  duler.workers) <
-00025b00: 3d20 3130 303a 0a20 2020 2020 2020 2077  = 100:.        w
-00025b10: 6f72 6b65 7273 5f6d 656d 6f72 7920 3d20  orkers_memory = 
-00025b20: 576f 726b 6572 734d 656d 6f72 7928 7363  WorkersMemory(sc
-00025b30: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00025b40: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00025b50: 7468 2229 0a0a 2020 2020 2020 2020 7072  th")..        pr
-00025b60: 6f63 6573 7369 6e67 203d 2043 7572 7265  ocessing = Curre
-00025b70: 6e74 4c6f 6164 2873 6368 6564 756c 6572  ntLoad(scheduler
-00025b80: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00025b90: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
-00025ba0: 2020 2020 2020 2070 726f 6365 7373 696e         processin
-00025bb0: 675f 726f 6f74 203d 2070 726f 6365 7373  g_root = process
-00025bc0: 696e 672e 7072 6f63 6573 7369 6e67 5f66  ing.processing_f
-00025bd0: 6967 7572 650a 2020 2020 656c 7365 3a0a  igure.    else:.
-00025be0: 2020 2020 2020 2020 776f 726b 6572 735f          workers_
-00025bf0: 6d65 6d6f 7279 203d 2057 6f72 6b65 7273  memory = Workers
-00025c00: 4d65 6d6f 7279 4869 7374 6f67 7261 6d28  MemoryHistogram(
-00025c10: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
-00025c20: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00025c30: 626f 7468 2229 0a20 2020 2020 2020 2070  both").        p
-00025c40: 726f 6365 7373 696e 6720 3d20 5072 6f63  rocessing = Proc
-00025c50: 6573 7369 6e67 4869 7374 6f67 7261 6d28  essingHistogram(
-00025c60: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
-00025c70: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00025c80: 626f 7468 2229 0a0a 2020 2020 2020 2020  both")..        
-00025c90: 7072 6f63 6573 7369 6e67 5f72 6f6f 7420  processing_root 
-00025ca0: 3d20 7072 6f63 6573 7369 6e67 2e72 6f6f  = processing.roo
-00025cb0: 740a 0a20 2020 2063 7572 7265 6e74 5f6c  t..    current_l
-00025cc0: 6f61 6420 3d20 4375 7272 656e 744c 6f61  oad = CurrentLoa
-00025cd0: 6428 7363 6865 6475 6c65 722c 2073 697a  d(scheduler, siz
-00025ce0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00025cf0: 685f 626f 7468 2229 0a20 2020 206f 6363  h_both").    occ
-00025d00: 7570 616e 6379 203d 204f 6363 7570 616e  upancy = Occupan
-00025d10: 6379 2873 6368 6564 756c 6572 2c20 7369  cy(scheduler, si
-00025d20: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-00025d30: 6368 5f62 6f74 6822 290a 2020 2020 776f  ch_both").    wo
-00025d40: 726b 6572 735f 7472 616e 7366 6572 5f62  rkers_transfer_b
-00025d50: 7974 6573 203d 2057 6f72 6b65 7273 5472  ytes = WorkersTr
-00025d60: 616e 7366 6572 4279 7465 7328 7363 6865  ansferBytes(sche
-00025d70: 6475 6c65 722c 2073 697a 696e 675f 6d6f  duler, sizing_mo
-00025d80: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-00025d90: 2229 0a0a 2020 2020 6370 755f 726f 6f74  ")..    cpu_root
-00025da0: 203d 2063 7572 7265 6e74 5f6c 6f61 642e   = current_load.
-00025db0: 6370 755f 6669 6775 7265 0a20 2020 206f  cpu_figure.    o
-00025dc0: 6363 7570 616e 6379 5f72 6f6f 7420 3d20  ccupancy_root = 
-00025dd0: 6f63 6375 7061 6e63 792e 726f 6f74 0a0a  occupancy.root..
-00025de0: 2020 2020 776f 726b 6572 735f 6d65 6d6f      workers_memo
-00025df0: 7279 2e75 7064 6174 6528 290a 2020 2020  ry.update().    
-00025e00: 776f 726b 6572 735f 7472 616e 7366 6572  workers_transfer
-00025e10: 5f62 7974 6573 2e75 7064 6174 6528 290a  _bytes.update().
-00025e20: 2020 2020 7072 6f63 6573 7369 6e67 2e75      processing.u
-00025e30: 7064 6174 6528 290a 2020 2020 6375 7272  pdate().    curr
-00025e40: 656e 745f 6c6f 6164 2e75 7064 6174 6528  ent_load.update(
-00025e50: 290a 2020 2020 6f63 6375 7061 6e63 792e  ).    occupancy.
-00025e60: 7570 6461 7465 2829 0a0a 2020 2020 6164  update()..    ad
-00025e70: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-00025e80: 6163 6b28 646f 632c 2077 6f72 6b65 7273  ack(doc, workers
-00025e90: 5f6d 656d 6f72 792c 2031 3030 290a 2020  _memory, 100).  
-00025ea0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-00025eb0: 616c 6c62 6163 6b28 646f 632c 2077 6f72  allback(doc, wor
-00025ec0: 6b65 7273 5f74 7261 6e73 6665 725f 6279  kers_transfer_by
-00025ed0: 7465 732c 2031 3030 290a 2020 2020 6164  tes, 100).    ad
-00025ee0: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-00025ef0: 6163 6b28 646f 632c 2070 726f 6365 7373  ack(doc, process
-00025f00: 696e 672c 2031 3030 290a 2020 2020 6164  ing, 100).    ad
-00025f10: 645f 7065 7269 6f64 6963 5f63 616c 6c62  d_periodic_callb
-00025f20: 6163 6b28 646f 632c 2063 7572 7265 6e74  ack(doc, current
-00025f30: 5f6c 6f61 642c 2031 3030 290a 2020 2020  _load, 100).    
-00025f40: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00025f50: 6c62 6163 6b28 646f 632c 206f 6363 7570  lback(doc, occup
-00025f60: 616e 6379 2c20 3130 3029 0a0a 2020 2020  ancy, 100)..    
-00025f70: 646f 632e 6164 645f 726f 6f74 2877 6f72  doc.add_root(wor
-00025f80: 6b65 7273 5f6d 656d 6f72 792e 726f 6f74  kers_memory.root
-00025f90: 290a 0a20 2020 2074 6162 7320 3d20 5b0a  )..    tabs = [.
-00025fa0: 2020 2020 2020 2020 5461 6250 616e 656c          TabPanel
-00025fb0: 2863 6869 6c64 3d70 726f 6365 7373 696e  (child=processin
-00025fc0: 675f 726f 6f74 2c20 7469 746c 653d 2250  g_root, title="P
-00025fd0: 726f 6365 7373 696e 6722 292c 0a20 2020  rocessing"),.   
-00025fe0: 2020 2020 2054 6162 5061 6e65 6c28 6368       TabPanel(ch
-00025ff0: 696c 643d 6370 755f 726f 6f74 2c20 7469  ild=cpu_root, ti
-00026000: 746c 653d 2243 5055 2229 2c0a 2020 2020  tle="CPU"),.    
-00026010: 2020 2020 5461 6250 616e 656c 2863 6869      TabPanel(chi
-00026020: 6c64 3d6f 6363 7570 616e 6379 5f72 6f6f  ld=occupancy_roo
-00026030: 742c 2074 6974 6c65 3d22 4f63 6375 7061  t, title="Occupa
-00026040: 6e63 7922 292c 0a20 2020 2020 2020 2054  ncy"),.        T
-00026050: 6162 5061 6e65 6c28 6368 696c 643d 776f  abPanel(child=wo
-00026060: 726b 6572 735f 7472 616e 7366 6572 5f62  rkers_transfer_b
-00026070: 7974 6573 2e72 6f6f 742c 2074 6974 6c65  ytes.root, title
-00026080: 3d22 4461 7461 2054 7261 6e73 6665 7222  ="Data Transfer"
-00026090: 292c 0a20 2020 205d 0a0a 2020 2020 6865  ),.    ]..    he
-000260a0: 6c70 5f20 3d20 4865 6c70 546f 6f6c 280a  lp_ = HelpTool(.
-000260b0: 2020 2020 2020 2020 7265 6469 7265 6374          redirect
-000260c0: 3d22 6874 7470 733a 2f2f 646f 6373 2e64  ="https://docs.d
-000260d0: 6173 6b2e 6f72 672f 656e 2f73 7461 626c  ask.org/en/stabl
-000260e0: 652f 6461 7368 626f 6172 642e 6874 6d6c  e/dashboard.html
-000260f0: 2374 6173 6b2d 7072 6f63 6573 7369 6e67  #task-processing
-00026100: 2d63 7075 2d75 7469 6c69 7a61 7469 6f6e  -cpu-utilization
-00026110: 2d6f 6363 7570 616e 6379 2d64 6174 612d  -occupancy-data-
-00026120: 7472 616e 7366 6572 222c 0a20 2020 2020  transfer",.     
-00026130: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
-00026140: 4120 6465 7363 7269 7074 696f 6e20 6f66  A description of
-00026150: 2054 6173 6b20 5072 6f63 6573 7369 6e67   Task Processing
-00026160: 2f43 5055 2055 7469 6c69 7a61 7469 6f6e  /CPU Utilization
-00026170: 2f4f 6363 7570 616e 6379 222c 0a20 2020  /Occupancy",.   
-00026180: 2029 0a20 2020 2066 6f72 2074 6162 2069   ).    for tab i
-00026190: 6e20 7461 6273 3a0a 2020 2020 2020 2020  n tabs:.        
-000261a0: 7461 622e 6368 696c 642e 746f 6f6c 6261  tab.child.toolba
-000261b0: 725f 6c6f 6361 7469 6f6e 203d 2022 6162  r_location = "ab
-000261c0: 6f76 6522 0a20 2020 2020 2020 2074 6162  ove".        tab
-000261d0: 2e63 6869 6c64 2e61 6464 5f74 6f6f 6c73  .child.add_tools
-000261e0: 2868 656c 705f 290a 0a20 2020 2070 726f  (help_)..    pro
-000261f0: 635f 7461 6273 203d 2054 6162 7328 7461  c_tabs = Tabs(ta
-00026200: 6273 3d74 6162 732c 206e 616d 653d 2270  bs=tabs, name="p
-00026210: 726f 6365 7373 696e 675f 7461 6273 222c  rocessing_tabs",
-00026220: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
-00026230: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00026240: 2064 6f63 2e61 6464 5f72 6f6f 7428 7072   doc.add_root(pr
-00026250: 6f63 5f74 6162 7329 0a0a 2020 2020 7461  oc_tabs)..    ta
-00026260: 736b 5f73 7472 6561 6d20 3d20 5461 736b  sk_stream = Task
-00026270: 5374 7265 616d 280a 2020 2020 2020 2020  Stream(.        
-00026280: 7363 6865 6475 6c65 722c 0a20 2020 2020  scheduler,.     
-00026290: 2020 206e 5f72 6563 7461 6e67 6c65 733d     n_rectangles=
-000262a0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-000262b0: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
-000262c0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-000262d0: 6c65 722e 6461 7368 626f 6172 642e 7374  ler.dashboard.st
-000262e0: 6174 7573 2e74 6173 6b2d 7374 7265 616d  atus.task-stream
-000262f0: 2d6c 656e 6774 6822 0a20 2020 2020 2020  -length".       
-00026300: 2029 2c0a 2020 2020 2020 2020 636c 6561   ),.        clea
-00026310: 725f 696e 7465 7276 616c 3d22 3573 222c  r_interval="5s",
-00026320: 0a20 2020 2020 2020 2073 697a 696e 675f  .        sizing_
-00026330: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00026340: 7468 222c 0a20 2020 2029 0a20 2020 2074  th",.    ).    t
-00026350: 6173 6b5f 7374 7265 616d 2e75 7064 6174  ask_stream.updat
-00026360: 6528 290a 2020 2020 6164 645f 7065 7269  e().    add_peri
-00026370: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
-00026380: 632c 2074 6173 6b5f 7374 7265 616d 2c20  c, task_stream, 
-00026390: 3130 3029 0a20 2020 2064 6f63 2e61 6464  100).    doc.add
-000263a0: 5f72 6f6f 7428 7461 736b 5f73 7472 6561  _root(task_strea
-000263b0: 6d2e 726f 6f74 290a 0a20 2020 2074 6173  m.root)..    tas
-000263c0: 6b5f 7072 6f67 7265 7373 203d 2054 6173  k_progress = Tas
-000263d0: 6b50 726f 6772 6573 7328 7363 6865 6475  kProgress(schedu
-000263e0: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
-000263f0: 3d22 7374 7265 7463 685f 626f 7468 2229  ="stretch_both")
-00026400: 0a20 2020 2074 6173 6b5f 7072 6f67 7265  .    task_progre
-00026410: 7373 2e75 7064 6174 6528 290a 2020 2020  ss.update().    
-00026420: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00026430: 6c62 6163 6b28 646f 632c 2074 6173 6b5f  lback(doc, task_
-00026440: 7072 6f67 7265 7373 2c20 3130 3029 0a20  progress, 100). 
-00026450: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-00026460: 7461 736b 5f70 726f 6772 6573 732e 726f  task_progress.ro
-00026470: 6f74 290a 0a20 2020 2064 6f63 2e74 6974  ot)..    doc.tit
-00026480: 6c65 203d 2022 4461 736b 3a20 5374 6174  le = "Dask: Stat
-00026490: 7573 220a 2020 2020 646f 632e 7468 656d  us".    doc.them
-000264a0: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
-000264b0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-000264c0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-000264d0: 6174 6528 2273 7461 7475 732e 6874 6d6c  ate("status.html
-000264e0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-000264f0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00026500: 6461 7465 2865 7874 7261 290a 0a0a 4063  date(extra)...@c
-00026510: 7572 7279 0a64 6566 2069 6e64 6976 6964  urry.def individ
-00026520: 7561 6c5f 646f 6328 636c 732c 2069 6e74  ual_doc(cls, int
-00026530: 6572 7661 6c2c 2073 6368 6564 756c 6572  erval, scheduler
-00026540: 2c20 6578 7472 612c 2064 6f63 2c20 6669  , extra, doc, fi
-00026550: 675f 6174 7472 3d22 726f 6f74 222c 202a  g_attr="root", *
-00026560: 2a6b 7761 7267 7329 3a0a 2020 2020 2320  *kwargs):.    # 
-00026570: 4e6f 7465 3a20 406c 6f67 5f65 7272 6f72  Note: @log_error
-00026580: 7320 616e 6420 4063 7572 7279 2061 7265  s and @curry are
-00026590: 206e 6f74 2063 6f6d 7061 7469 626c 650a   not compatible.
-000265a0: 2020 2020 7769 7468 206c 6f67 5f65 7272      with log_err
-000265b0: 6f72 7328 293a 0a20 2020 2020 2020 2066  ors():.        f
-000265c0: 6967 203d 2063 6c73 2873 6368 6564 756c  ig = cls(schedul
-000265d0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-000265e0: 2273 7472 6574 6368 5f62 6f74 6822 2c20  "stretch_both", 
-000265f0: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-00026600: 2020 6669 672e 7570 6461 7465 2829 0a20    fig.update(). 
-00026610: 2020 2020 2020 2061 6464 5f70 6572 696f         add_perio
-00026620: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-00026630: 2c20 6669 672c 2069 6e74 6572 7661 6c29  , fig, interval)
-00026640: 0a20 2020 2020 2020 2064 6f63 2e61 6464  .        doc.add
-00026650: 5f72 6f6f 7428 6765 7461 7474 7228 6669  _root(getattr(fi
-00026660: 672c 2066 6967 5f61 7474 7229 290a 2020  g, fig_attr)).  
-00026670: 2020 2020 2020 646f 632e 7468 656d 6520        doc.theme 
-00026680: 3d20 424f 4b45 485f 5448 454d 450a 2020  = BOKEH_THEME.  
-00026690: 2020 2020 2020 646f 632e 7469 746c 6520        doc.title 
-000266a0: 3d20 2244 6173 6b3a 2022 202b 2066 756e  = "Dask: " + fun
-000266b0: 636e 616d 6528 636c 7329 0a0a 0a40 6c6f  cname(cls)...@lo
-000266c0: 675f 6572 726f 7273 0a64 6566 2069 6e64  g_errors.def ind
-000266d0: 6976 6964 7561 6c5f 7072 6f66 696c 655f  ividual_profile_
-000266e0: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
-000266f0: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
-00026700: 7072 6f66 203d 2050 726f 6669 6c65 5469  prof = ProfileTi
-00026710: 6d65 506c 6f74 2873 6368 6564 756c 6572  mePlot(scheduler
-00026720: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00026730: 7472 6574 6368 5f62 6f74 6822 2c20 646f  tretch_both", do
-00026740: 633d 646f 6329 0a20 2020 2064 6f63 2e61  c=doc).    doc.a
-00026750: 6464 5f72 6f6f 7428 7072 6f66 2e72 6f6f  dd_root(prof.roo
-00026760: 7429 0a20 2020 2070 726f 662e 7472 6967  t).    prof.trig
-00026770: 6765 725f 7570 6461 7465 2829 0a20 2020  ger_update().   
-00026780: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
-00026790: 4548 5f54 4845 4d45 0a0a 0a40 6c6f 675f  EH_THEME...@log_
-000267a0: 6572 726f 7273 0a64 6566 2069 6e64 6976  errors.def indiv
-000267b0: 6964 7561 6c5f 7072 6f66 696c 655f 7365  idual_profile_se
-000267c0: 7276 6572 5f64 6f63 2873 6368 6564 756c  rver_doc(schedul
-000267d0: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
-000267e0: 0a20 2020 2070 726f 6620 3d20 5072 6f66  .    prof = Prof
-000267f0: 696c 6553 6572 7665 7228 7363 6865 6475  ileServer(schedu
-00026800: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
-00026810: 3d22 7374 7265 7463 685f 626f 7468 222c  ="stretch_both",
-00026820: 2064 6f63 3d64 6f63 290a 2020 2020 646f   doc=doc).    do
-00026830: 632e 6164 645f 726f 6f74 2870 726f 662e  c.add_root(prof.
-00026840: 726f 6f74 290a 2020 2020 7072 6f66 2e74  root).    prof.t
-00026850: 7269 6767 6572 5f75 7064 6174 6528 290a  rigger_update().
-00026860: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00026870: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-00026880: 6f67 5f65 7272 6f72 730a 6465 6620 7072  og_errors.def pr
-00026890: 6f66 696c 655f 646f 6328 7363 6865 6475  ofile_doc(schedu
-000268a0: 6c65 722c 2065 7874 7261 2c20 646f 6329  ler, extra, doc)
-000268b0: 3a0a 2020 2020 646f 632e 7469 746c 6520  :.    doc.title 
-000268c0: 3d20 2244 6173 6b3a 2050 726f 6669 6c65  = "Dask: Profile
-000268d0: 220a 2020 2020 7072 6f66 203d 2050 726f  ".    prof = Pro
-000268e0: 6669 6c65 5469 6d65 506c 6f74 2873 6368  fileTimePlot(sch
-000268f0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
-00026900: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-00026910: 6822 2c20 646f 633d 646f 6329 0a20 2020  h", doc=doc).   
-00026920: 2064 6f63 2e61 6464 5f72 6f6f 7428 7072   doc.add_root(pr
-00026930: 6f66 2e72 6f6f 7429 0a20 2020 2064 6f63  of.root).    doc
-00026940: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
-00026950: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
-00026960: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
-00026970: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
-00026980: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
-00026990: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
-000269a0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
-000269b0: 0a0a 2020 2020 7072 6f66 2e74 7269 6767  ..    prof.trigg
-000269c0: 6572 5f75 7064 6174 6528 290a 0a0a 406c  er_update()...@l
-000269d0: 6f67 5f65 7272 6f72 730a 6465 6620 7072  og_errors.def pr
-000269e0: 6f66 696c 655f 7365 7276 6572 5f64 6f63  ofile_server_doc
-000269f0: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-00026a00: 612c 2064 6f63 293a 0a20 2020 2064 6f63  a, doc):.    doc
-00026a10: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
-00026a20: 5072 6f66 696c 6520 6f66 2045 7665 6e74  Profile of Event
-00026a30: 204c 6f6f 7022 0a20 2020 2070 726f 6620   Loop".    prof 
-00026a40: 3d20 5072 6f66 696c 6553 6572 7665 7228  = ProfileServer(
-00026a50: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
-00026a60: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00026a70: 626f 7468 222c 2064 6f63 3d64 6f63 290a  both", doc=doc).
-00026a80: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
-00026a90: 2870 726f 662e 726f 6f74 290a 2020 2020  (prof.root).    
-00026aa0: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00026ab0: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00026ac0: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00026ad0: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00026ae0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00026af0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00026b00: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00026b10: 454d 450a 0a20 2020 2070 726f 662e 7472  EME..    prof.tr
-00026b20: 6967 6765 725f 7570 6461 7465 2829 0a    igger_update().
+0001dbd0: 2020 7261 6469 7573 3d30 2e34 2c0a 2020    radius=0.4,.  
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001dbf0: 6172 745f 616e 676c 653d 6375 6d73 756d  art_angle=cumsum
+0001dc00: 2822 616e 676c 6522 2c20 696e 636c 7564  ("angle", includ
+0001dc10: 655f 7a65 726f 3d54 7275 6529 2c0a 2020  e_zero=True),.  
+0001dc20: 2020 2020 2020 2020 2020 2020 2020 656e                en
+0001dc30: 645f 616e 676c 653d 6375 6d73 756d 2822  d_angle=cumsum("
+0001dc40: 616e 676c 6522 292c 0a20 2020 2020 2020  angle"),.       
+0001dc50: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+0001dc60: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
+0001dc70: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0001dc80: 6c5f 636f 6c6f 723d 2263 6f6c 6f72 222c  l_color="color",
+0001dc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dca0: 206c 6567 656e 645f 6669 656c 643d 2261   legend_field="a
+0001dcb0: 6374 6976 6974 7922 2c0a 2020 2020 2020  ctivity",.      
+0001dcc0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0001dcd0: 3d73 656c 662e 7461 736b 5f65 7865 635f  =self.task_exec_
+0001dce0: 6279 5f61 6374 6976 6974 795f 7372 632c  by_activity_src,
+0001dcf0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001dd00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001dd10: 7461 736b 5f65 7865 635f 6279 5f61 6374  task_exec_by_act
+0001dd20: 6976 6974 795f 6368 6172 7420 3d20 7069  ivity_chart = pi
+0001dd30: 6563 6861 7274 0a0a 2020 2020 6465 6620  echart..    def 
+0001dd40: 5f62 7569 6c64 5f74 6173 6b5f 6578 6563  _build_task_exec
+0001dd50: 7574 696f 6e5f 6279 5f70 7265 6669 785f  ution_by_prefix_
+0001dd60: 6368 6172 7428 0a20 2020 2020 2020 2073  chart(.        s
+0001dd70: 656c 662c 2074 6173 6b5f 6578 6563 5f64  elf, task_exec_d
+0001dd80: 6174 613a 2064 6566 6175 6c74 6469 6374  ata: defaultdict
+0001dd90: 5b73 7472 2c20 6c69 7374 5d0a 2020 2020  [str, list].    
+0001dda0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001ddb0: 2020 2066 756e 6374 696f 6e73 203d 2074     functions = t
+0001ddc0: 6173 6b5f 6578 6563 5f64 6174 615b 2266  ask_exec_data["f
+0001ddd0: 756e 6374 696f 6e73 225d 0a20 2020 2020  unctions"].     
+0001dde0: 2020 2062 6173 655f 746f 6f6c 7320 3d20     base_tools = 
+0001ddf0: 2270 616e 2c77 6865 656c 5f7a 6f6f 6d2c  "pan,wheel_zoom,
+0001de00: 626f 785f 7a6f 6f6d 2c72 6573 6574 220a  box_zoom,reset".
+0001de10: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001de20: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001de30: 6566 6978 5f63 6861 7274 2069 7320 4e6f  efix_chart is No
+0001de40: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001de50: 6261 7263 6861 7274 203d 2066 6967 7572  barchart = figur
+0001de60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0001de70: 2020 2078 5f72 616e 6765 3d66 756e 6374     x_range=funct
+0001de80: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0001de90: 2020 2020 2020 6865 6967 6874 3d35 3030        height=500
+0001dea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001deb0: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
+0001dec0: 6361 6c65 5f62 6f74 6822 2c0a 2020 2020  cale_both",.    
+0001ded0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0001dee0: 653d 2254 6173 6b20 6578 6563 7574 696f  e="Task executio
+0001def0: 6e2c 2062 7920 6675 6e63 7469 6f6e 222c  n, by function",
+0001df00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001df10: 2074 6f6f 6c73 3d62 6173 655f 746f 6f6c   tools=base_tool
+0001df20: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0001df30: 0a20 2020 2020 2020 2020 2020 2062 6172  .            bar
+0001df40: 6368 6172 742e 7961 7869 732e 7669 7369  chart.yaxis.visi
+0001df50: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+0001df60: 2020 2020 2020 2020 6261 7263 6861 7274          barchart
+0001df70: 2e78 6178 6973 2e6d 616a 6f72 5f6c 6162  .xaxis.major_lab
+0001df80: 656c 5f6f 7269 656e 7461 7469 6f6e 203d  el_orientation =
+0001df90: 2030 2e32 0a20 2020 2020 2020 2020 2020   0.2.           
+0001dfa0: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
+0001dfb0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
+0001dfc0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0001dfd0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001dfe0: 5f62 795f 7072 6566 6978 5f63 6861 7274  _by_prefix_chart
+0001dff0: 203d 2062 6172 6368 6172 740a 0a20 2020   = barchart..   
+0001e000: 2020 2020 2069 6620 7365 6c66 2e74 6173       if self.tas
+0001e010: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001e020: 5f63 6861 7274 2e78 5f72 616e 6765 2e66  _chart.x_range.f
+0001e030: 6163 746f 7273 2021 3d20 6675 6e63 7469  actors != functi
+0001e040: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0001e050: 2073 656c 662e 7375 6273 7461 6e74 6961   self.substantia
+0001e060: 6c5f 6368 616e 6765 203d 2054 7275 650a  l_change = True.
+0001e070: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e080: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001e090: 6566 6978 5f63 6861 7274 2e78 5f72 616e  efix_chart.x_ran
+0001e0a0: 6765 203d 2046 6163 746f 7252 616e 6765  ge = FactorRange
+0001e0b0: 282a 6675 6e63 7469 6f6e 7329 0a0a 2020  (*functions)..  
+0001e0c0: 2020 2020 2020 7374 6163 6b65 7273 203d        stackers =
+0001e0d0: 205b 0a20 2020 2020 2020 2020 2020 206e   [.            n
+0001e0e0: 616d 6520 666f 7220 6e61 6d65 2069 6e20  ame for name in 
+0001e0f0: 7461 736b 5f65 7865 635f 6461 7461 2069  task_exec_data i
+0001e100: 6620 6e61 6d65 2e65 6e64 7377 6974 6828  f name.endswith(
+0001e110: 7365 6c66 2e75 6e69 745f 7365 6c65 6374  self.unit_select
+0001e120: 6564 290a 2020 2020 2020 2020 5d0a 0a20  ed).        ].. 
+0001e130: 2020 2020 2020 2069 6620 7374 6163 6b65         if stacke
+0001e140: 7273 2061 6e64 2073 7461 636b 6572 7320  rs and stackers 
+0001e150: 213d 2067 6574 6174 7472 2873 656c 662c  != getattr(self,
+0001e160: 2022 5f70 7265 765f 7374 6163 6b65 7273   "_prev_stackers
+0001e170: 222c 205b 5d29 3a0a 2020 2020 2020 2020  ", []):.        
+0001e180: 2020 2020 7365 6c66 2e5f 7072 6576 5f73      self._prev_s
+0001e190: 7461 636b 6572 7320 3d20 7374 6163 6b65  tackers = stacke
+0001e1a0: 7273 0a20 2020 2020 2020 2020 2020 2072  rs.            r
+0001e1b0: 656e 6465 7265 7273 203d 2073 656c 662e  enderers = self.
+0001e1c0: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
+0001e1d0: 6669 785f 6368 6172 742e 7662 6172 5f73  fix_chart.vbar_s
+0001e1e0: 7461 636b 280a 2020 2020 2020 2020 2020  tack(.          
+0001e1f0: 2020 2020 2020 7374 6163 6b65 7273 2c0a        stackers,.
+0001e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e210: 783d 2266 756e 6374 696f 6e73 222c 0a20  x="functions",. 
+0001e220: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001e230: 6964 7468 3d30 2e39 2c0a 2020 2020 2020  idth=0.9,.      
+0001e240: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0001e250: 3d73 656c 662e 7461 736b 5f65 7865 635f  =self.task_exec_
+0001e260: 6279 5f70 7265 6669 785f 7372 632c 0a20  by_prefix_src,. 
+0001e270: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001e280: 6f6c 6f72 3d73 656c 662e 5f67 6574 5f70  olor=self._get_p
+0001e290: 616c 6574 7465 286c 656e 2873 656c 662e  alette(len(self.
+0001e2a0: 7461 736b 5f61 6374 6976 6974 6965 7329  task_activities)
+0001e2b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0001e2c0: 2020 206c 6567 656e 645f 6c61 6265 6c3d     legend_label=
+0001e2d0: 7365 6c66 2e74 6173 6b5f 6163 7469 7669  self.task_activi
+0001e2e0: 7469 6573 2c0a 2020 2020 2020 2020 2020  ties,.          
+0001e2f0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0001e300: 2023 2043 7265 6174 6520 686f 7665 7274   # Create hovert
+0001e310: 6f6f 6c73 206f 6e74 6f70 206f 6620 6261  ools ontop of ba
+0001e320: 7365 2074 6f6f 6c73 0a20 2020 2020 2020  se tools.       
+0001e330: 2020 2020 2074 6f6f 6c73 203d 2073 656c       tools = sel
+0001e340: 662e 7461 736b 5f65 7865 635f 6279 5f70  f.task_exec_by_p
+0001e350: 7265 6669 785f 6368 6172 742e 746f 6f6c  refix_chart.tool
+0001e360: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+0001e370: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
+0001e380: 7072 6566 6978 5f63 6861 7274 2e74 6f6f  prefix_chart.too
+0001e390: 6c73 203d 2074 6f6f 6c73 5b3a 206c 656e  ls = tools[: len
+0001e3a0: 2862 6173 655f 746f 6f6c 732e 7370 6c69  (base_tools.spli
+0001e3b0: 7428 222c 2229 295d 0a0a 2020 2020 2020  t(","))]..      
+0001e3c0: 2020 2020 2020 666f 7220 7662 6172 2069        for vbar i
+0001e3d0: 6e20 7265 6e64 6572 6572 733a 0a20 2020  n renderers:.   
+0001e3e0: 2020 2020 2020 2020 2020 2020 2074 6f6f               too
+0001e3f0: 6c74 6970 7320 3d20 5b0a 2020 2020 2020  ltips = [.      
+0001e400: 2020 2020 2020 2020 2020 2020 2020 280a                (.
+0001e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e420: 2020 2020 2020 2020 7662 6172 2e6e 616d          vbar.nam
+0001e430: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001e440: 2020 2020 2020 2020 2020 2066 2240 7b7b             f"@{{
+0001e450: 7b76 6261 722e 6e61 6d65 7d5f 7465 7874  {vbar.name}_text
+0001e460: 7d7d 222c 0a20 2020 2020 2020 2020 2020  }}",.           
+0001e470: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0001e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e490: 2822 6675 6e63 7469 6f6e 222c 2022 4066  ("function", "@f
+0001e4a0: 756e 6374 696f 6e73 2229 2c0a 2020 2020  unctions"),.    
+0001e4b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0001e4c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001e4d0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
+0001e4e0: 7072 6566 6978 5f63 6861 7274 2e61 6464  prefix_chart.add
+0001e4f0: 5f74 6f6f 6c73 280a 2020 2020 2020 2020  _tools(.        
+0001e500: 2020 2020 2020 2020 2020 2020 486f 7665              Hove
+0001e510: 7254 6f6f 6c28 746f 6f6c 7469 7073 3d74  rTool(tooltips=t
+0001e520: 6f6f 6c74 6970 732c 2072 656e 6465 7265  ooltips, rendere
+0001e530: 7273 3d5b 7662 6172 5d29 0a20 2020 2020  rs=[vbar]).     
+0001e540: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0001e550: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0001e560: 7562 7374 616e 7469 616c 5f63 6861 6e67  ubstantial_chang
+0001e570: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
+0001e580: 2020 2020 2073 656c 662e 7461 736b 5f65       self.task_e
+0001e590: 7865 635f 6279 5f70 7265 6669 785f 6368  xec_by_prefix_ch
+0001e5a0: 6172 742e 7265 6e64 6572 6572 7320 3d20  art.renderers = 
+0001e5b0: 7265 6e64 6572 6572 730a 2020 2020 2020  renderers.      
+0001e5c0: 2020 7365 6c66 2e74 6173 6b5f 6578 6563    self.task_exec
+0001e5d0: 5f62 795f 7072 6566 6978 5f73 7263 2e64  _by_prefix_src.d
+0001e5e0: 6174 6120 3d20 6469 6374 2874 6173 6b5f  ata = dict(task_
+0001e5f0: 6578 6563 5f64 6174 6129 0a0a 2020 2020  exec_data)..    
+0001e600: 6465 6620 5f62 7569 6c64 5f73 656e 6464  def _build_sendd
+0001e610: 6174 615f 6368 6172 7428 7365 6c66 2c20  ata_chart(self, 
+0001e620: 7365 6e64 6461 7461 3a20 6465 6661 756c  senddata: defaul
+0001e630: 7464 6963 745b 7374 722c 206c 6973 745d  tdict[str, list]
+0001e640: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001e650: 2020 2070 6965 6461 7461 203d 207b 7d0a     piedata = {}.
+0001e660: 2020 2020 2020 2020 7069 6564 6174 615b          piedata[
+0001e670: 2261 6374 6976 6974 7922 5d20 3d20 7365  "activity"] = se
+0001e680: 6e64 6461 7461 5b22 6163 7469 7669 7479  nddata["activity
+0001e690: 225d 0a20 2020 2020 2020 2070 6965 6461  "].        pieda
+0001e6a0: 7461 5b22 7661 6c75 6522 5d20 3d20 5b0a  ta["value"] = [.
+0001e6b0: 2020 2020 2020 2020 2020 2020 2873 756d              (sum
+0001e6c0: 2873 656e 6464 6174 615b 6622 7b6f 707d  (senddata[f"{op}
+0001e6d0: 5f7b 7365 6c66 2e75 6e69 745f 7365 6c65  _{self.unit_sele
+0001e6e0: 6374 6564 7d22 5d29 2920 666f 7220 6f70  cted}"])) for op
+0001e6f0: 2069 6e20 7365 6e64 6461 7461 5b22 6163   in senddata["ac
+0001e700: 7469 7669 7479 225d 0a20 2020 2020 2020  tivity"].       
+0001e710: 205d 0a20 2020 2020 2020 2070 6965 6461   ].        pieda
+0001e720: 7461 5b22 7465 7874 225d 203d 205b 7365  ta["text"] = [se
+0001e730: 6c66 2e66 6f72 6d61 7428 7365 6c66 2e75  lf.format(self.u
+0001e740: 6e69 745f 7365 6c65 6374 6564 2c20 7629  nit_selected, v)
+0001e750: 2066 6f72 2076 2069 6e20 7069 6564 6174   for v in piedat
+0001e760: 615b 2276 616c 7565 225d 5d0a 2020 2020  a["value"]].    
+0001e770: 2020 2020 7069 6564 6174 615b 2261 6e67      piedata["ang
+0001e780: 6c65 225d 203d 205b 0a20 2020 2020 2020  le"] = [.       
+0001e790: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+0001e7a0: 2020 2020 2020 2028 7375 6d28 7365 6e64         (sum(send
+0001e7b0: 6461 7461 5b66 227b 6f70 7d5f 7b73 656c  data[f"{op}_{sel
+0001e7c0: 662e 756e 6974 5f73 656c 6563 7465 647d  f.unit_selected}
+0001e7d0: 225d 2920 2f20 7375 6d28 7069 6564 6174  "]) / sum(piedat
+0001e7e0: 615b 2276 616c 7565 225d 2929 0a20 2020  a["value"])).   
+0001e7f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001e800: 7375 6d28 7069 6564 6174 615b 2276 616c  sum(piedata["val
+0001e810: 7565 225d 290a 2020 2020 2020 2020 2020  ue"]).          
+0001e820: 2020 2020 2020 656c 7365 2030 2e30 0a20        else 0.0. 
+0001e830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001e840: 2020 2020 2020 2020 202a 2032 0a20 2020           * 2.   
+0001e850: 2020 2020 2020 2020 202a 206d 6174 682e           * math.
+0001e860: 7069 0a20 2020 2020 2020 2020 2020 2066  pi.            f
+0001e870: 6f72 206f 7020 696e 2070 6965 6461 7461  or op in piedata
+0001e880: 5b22 6163 7469 7669 7479 225d 0a20 2020  ["activity"].   
+0001e890: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
+0001e8a0: 6965 6461 7461 5b22 636f 6c6f 7222 5d20  iedata["color"] 
+0001e8b0: 3d20 7365 6c66 2e5f 6765 745f 7061 6c65  = self._get_pale
+0001e8c0: 7474 6528 6c65 6e28 7069 6564 6174 615b  tte(len(piedata[
+0001e8d0: 2261 6374 6976 6974 7922 5d29 290a 0a20  "activity"])).. 
+0001e8e0: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+0001e8f0: 7372 632e 6461 7461 203d 2070 6965 6461  src.data = pieda
+0001e900: 7461 0a0a 2020 2020 2020 2020 6966 2073  ta..        if s
+0001e910: 656c 662e 7365 6e64 6461 7461 5f62 795f  elf.senddata_by_
+0001e920: 6163 7469 7669 7479 5f63 6861 7274 2069  activity_chart i
+0001e930: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001e940: 2020 2020 7365 6e64 6461 7461 5f70 6965      senddata_pie
+0001e950: 6368 6172 7420 3d20 6669 6775 7265 280a  chart = figure(.
+0001e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e970: 6865 6967 6874 3d35 3030 2c0a 2020 2020  height=500,.    
+0001e980: 2020 2020 2020 2020 2020 2020 7369 7a69              sizi
+0001e990: 6e67 5f6d 6f64 653d 2273 6361 6c65 5f62  ng_mode="scale_b
+0001e9a0: 6f74 6822 2c0a 2020 2020 2020 2020 2020  oth",.          
+0001e9b0: 2020 2020 2020 7469 746c 653d 2253 656e        title="Sen
+0001e9c0: 6420 6461 7461 2c20 6279 2061 6374 6976  d data, by activ
+0001e9d0: 6974 7922 2c0a 2020 2020 2020 2020 2020  ity",.          
+0001e9e0: 2020 2020 2020 746f 6f6c 733d 2268 6f76        tools="hov
+0001e9f0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+0001ea00: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
+0001ea10: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
+0001ea20: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0001ea30: 2020 2020 785f 7261 6e67 653d 282d 302e      x_range=(-0.
+0001ea40: 352c 2031 2e30 292c 0a20 2020 2020 2020  5, 1.0),.       
+0001ea50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001ea60: 2020 2073 656e 6464 6174 615f 7069 6563     senddata_piec
+0001ea70: 6861 7274 2e77 6564 6765 280a 2020 2020  hart.wedge(.    
+0001ea80: 2020 2020 2020 2020 2020 2020 783d 302c              x=0,
+0001ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eaa0: 2079 3d31 2c0a 2020 2020 2020 2020 2020   y=1,.          
+0001eab0: 2020 2020 2020 7261 6469 7573 3d30 2e34        radius=0.4
+0001eac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ead0: 2020 7374 6172 745f 616e 676c 653d 6375    start_angle=cu
+0001eae0: 6d73 756d 2822 616e 676c 6522 2c20 696e  msum("angle", in
+0001eaf0: 636c 7564 655f 7a65 726f 3d54 7275 6529  clude_zero=True)
+0001eb00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001eb10: 2020 656e 645f 616e 676c 653d 6375 6d73    end_angle=cums
+0001eb20: 756d 2822 616e 676c 6522 292c 0a20 2020  um("angle"),.   
+0001eb30: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+0001eb40: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
+0001eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eb60: 2066 696c 6c5f 636f 6c6f 723d 2263 6f6c   fill_color="col
+0001eb70: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
+0001eb80: 2020 2020 206c 6567 656e 645f 6669 656c       legend_fiel
+0001eb90: 643d 2261 6374 6976 6974 7922 2c0a 2020  d="activity",.  
+0001eba0: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0001ebb0: 7572 6365 3d73 656c 662e 7365 6e64 7372  urce=self.sendsr
+0001ebc0: 632c 0a20 2020 2020 2020 2020 2020 2029  c,.            )
+0001ebd0: 0a20 2020 2020 2020 2020 2020 2073 656e  .            sen
+0001ebe0: 6464 6174 615f 7069 6563 6861 7274 2e61  ddata_piechart.a
+0001ebf0: 7869 732e 6178 6973 5f6c 6162 656c 203d  xis.axis_label =
+0001ec00: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0001ec10: 2020 7365 6e64 6461 7461 5f70 6965 6368    senddata_piech
+0001ec20: 6172 742e 6178 6973 2e76 6973 6962 6c65  art.axis.visible
+0001ec30: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0001ec40: 2020 2020 2073 656e 6464 6174 615f 7069       senddata_pi
+0001ec50: 6563 6861 7274 2e67 7269 642e 6772 6964  echart.grid.grid
+0001ec60: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
+0001ec70: 6e65 0a20 2020 2020 2020 2020 2020 2073  ne.            s
+0001ec80: 656c 662e 7365 6e64 6461 7461 5f62 795f  elf.senddata_by_
+0001ec90: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
+0001eca0: 2073 656e 6464 6174 615f 7069 6563 6861   senddata_piecha
+0001ecb0: 7274 0a0a 2020 2020 6465 6620 5f67 6574  rt..    def _get
+0001ecc0: 5f70 616c 6574 7465 2873 656c 662c 206e  _palette(self, n
+0001ecd0: 3a20 696e 7429 202d 3e20 6c69 7374 5b73  : int) -> list[s
+0001ece0: 7472 5d3a 0a20 2020 2020 2020 2072 6574  tr]:.        ret
+0001ecf0: 7572 6e20 696e 7465 7270 5f70 616c 6574  urn interp_palet
+0001ed00: 7465 2859 6c47 6e42 7539 2c20 6e29 0a0a  te(YlGnBu9, n)..
+0001ed10: 0a63 6c61 7373 2043 6f6e 7465 6e74 696f  .class Contentio
+0001ed20: 6e28 4461 7368 626f 6172 6443 6f6d 706f  n(DashboardCompo
+0001ed30: 6e65 6e74 293a 0a20 2020 2022 2222 0a20  nent):.    """. 
+0001ed40: 2020 2045 7665 6e74 204c 6f6f 7020 4865     Event Loop He
+0001ed50: 616c 7468 2028 616e 6420 4749 4c20 436f  alth (and GIL Co
+0001ed60: 6e74 656e 7469 6f6e 2c20 6966 2063 6f6e  ntention, if con
+0001ed70: 6669 6775 7265 6429 0a20 2020 2022 2222  figured).    """
+0001ed80: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+0001ed90: 730a 2020 2020 6465 6620 5f5f 696e 6974  s.    def __init
+0001eda0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+0001edb0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+0001edc0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+0001edd0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+0001ede0: 720a 2020 2020 2020 2020 7365 6c66 2e64  r.        self.d
+0001edf0: 6174 6120 3d20 6469 6374 280a 2020 2020  ata = dict(.    
+0001ee00: 2020 2020 2020 2020 6e61 6d65 733d 5b0a          names=[.
+0001ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee20: 2822 5363 6865 6475 6c65 7222 2c20 2245  ("Scheduler", "E
+0001ee30: 7665 6e74 204c 6f6f 7022 292c 0a20 2020  vent Loop"),.   
+0001ee40: 2020 2020 2020 2020 2020 2020 2028 2253               ("S
+0001ee50: 6368 6564 756c 6572 222c 2022 4749 4c20  cheduler", "GIL 
+0001ee60: 436f 6e74 656e 7469 6f6e 2229 2c0a 2020  Contention"),.  
+0001ee70: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+0001ee80: 576f 726b 6572 7322 2c20 2245 7665 6e74  Workers", "Event
+0001ee90: 204c 6f6f 7022 292c 0a20 2020 2020 2020   Loop"),.       
+0001eea0: 2020 2020 2020 2020 2028 2257 6f72 6b65           ("Worke
+0001eeb0: 7273 222c 2022 4749 4c20 436f 6e74 656e  rs", "GIL Conten
+0001eec0: 7469 6f6e 2229 2c0a 2020 2020 2020 2020  tion"),.        
+0001eed0: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+0001eee0: 2020 2076 616c 7565 733d 5b30 2c20 302c     values=[0, 0,
+0001eef0: 2030 2c20 305d 2c0a 2020 2020 2020 2020   0, 0],.        
+0001ef00: 2020 2020 7465 7874 3d5b 2230 7322 2c20      text=["0s", 
+0001ef10: 2230 2522 2c20 2230 7322 2c20 2230 2522  "0%", "0s", "0%"
+0001ef20: 5d2c 0a20 2020 2020 2020 2029 0a20 2020  ],.        ).   
+0001ef30: 2020 2020 2074 6974 6c65 203d 2022 4576       title = "Ev
+0001ef40: 656e 7420 4c6f 6f70 2026 2047 494c 2043  ent Loop & GIL C
+0001ef50: 6f6e 7465 6e74 696f 6e22 0a0a 2020 2020  ontention"..    
+0001ef60: 2020 2020 2320 5265 6d6f 7665 2047 494c      # Remove GIL
+0001ef70: 2072 656c 6174 6564 206e 616d 6573 2f76   related names/v
+0001ef80: 616c 7565 7320 6966 206e 6f74 206d 6f6e  alues if not mon
+0001ef90: 6974 6f72 696e 6720 4749 4c0a 2020 2020  itoring GIL.    
+0001efa0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0001efb0: 7363 6865 6475 6c65 722e 6d6f 6e69 746f  scheduler.monito
+0001efc0: 722e 6d6f 6e69 746f 725f 6769 6c5f 636f  r.monitor_gil_co
+0001efd0: 6e74 656e 7469 6f6e 3a0a 2020 2020 2020  ntention:.      
+0001efe0: 2020 2020 2020 7469 746c 6520 3d20 2245        title = "E
+0001eff0: 7665 6e74 204c 6f6f 7022 0a20 2020 2020  vent Loop".     
+0001f000: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0001f010: 6e20 7365 6c66 2e64 6174 613a 0a20 2020  n self.data:.   
+0001f020: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001f030: 662e 6461 7461 5b6b 6579 5d20 3d20 7365  f.data[key] = se
+0001f040: 6c66 2e64 6174 615b 6b65 795d 5b3a 3a32  lf.data[key][::2
+0001f050: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
+0001f060: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
+0001f070: 6174 6153 6f75 7263 6528 6461 7461 3d73  ataSource(data=s
+0001f080: 656c 662e 6461 7461 290a 2020 2020 2020  elf.data).      
+0001f090: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+0001f0a0: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+0001f0b0: 2020 7469 746c 653d 7469 746c 652c 0a20    title=title,. 
+0001f0c0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+0001f0d0: 6765 3d46 6163 746f 7252 616e 6765 282a  ge=FactorRange(*
+0001f0e0: 7365 6c66 2e64 6174 615b 226e 616d 6573  self.data["names
+0001f0f0: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
+0001f100: 2079 5f72 616e 6765 3d28 302c 2031 292c   y_range=(0, 1),
+0001f110: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+0001f120: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
+0001f130: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
+0001f140: 696f 6e3d 2261 626f 7665 222c 0a20 2020  ion="above",.   
+0001f150: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0001f160: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+0001f170: 2020 2020 2073 656c 662e 726f 6f74 2e76       self.root.v
+0001f180: 6261 7228 0a20 2020 2020 2020 2020 2020  bar(.           
+0001f190: 2078 3d22 6e61 6d65 7322 2c0a 2020 2020   x="names",.    
+0001f1a0: 2020 2020 2020 2020 746f 703d 2276 616c          top="val
+0001f1b0: 7565 7322 2c0a 2020 2020 2020 2020 2020  ues",.          
+0001f1c0: 2020 7769 6474 683d 302e 392c 0a20 2020    width=0.9,.   
+0001f1d0: 2020 2020 2020 2020 206c 696e 655f 636f           line_co
+0001f1e0: 6c6f 723d 2277 6869 7465 222c 0a20 2020  lor="white",.   
+0001f1f0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0001f200: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+0001f210: 2020 2020 2020 2020 2066 696c 6c5f 636f           fill_co
+0001f220: 6c6f 723d 6661 6374 6f72 5f63 6d61 7028  lor=factor_cmap(
+0001f230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f240: 2066 6965 6c64 5f6e 616d 653d 226e 616d   field_name="nam
+0001f250: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0001f260: 2020 2020 2070 616c 6574 7465 3d5b 2223       palette=["#
+0001f270: 6238 6530 6365 222c 2022 2338 3161 6165  b8e0ce", "#81aae
+0001f280: 3422 5d2c 0a20 2020 2020 2020 2020 2020  4"],.           
+0001f290: 2020 2020 2066 6163 746f 7273 3d5b 2245       factors=["E
+0001f2a0: 7665 6e74 204c 6f6f 7022 2c20 2247 494c  vent Loop", "GIL
+0001f2b0: 2043 6f6e 7465 6e74 696f 6e22 5d2c 0a20   Contention"],. 
+0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001f2d0: 7461 7274 3d31 2c0a 2020 2020 2020 2020  tart=1,.        
+0001f2e0: 2020 2020 2020 2020 656e 643d 322c 0a20          end=2,. 
+0001f2f0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0001f300: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001f310: 2073 656c 662e 726f 6f74 2e78 5f72 616e   self.root.x_ran
+0001f320: 6765 2e67 726f 7570 5f70 6164 6469 6e67  ge.group_padding
+0001f330: 203d 2030 2e32 350a 2020 2020 2020 2020   = 0.25.        
+0001f340: 7365 6c66 2e72 6f6f 742e 7861 7869 732e  self.root.xaxis.
+0001f350: 6d69 6e6f 725f 7469 636b 5f6c 696e 655f  minor_tick_line_
+0001f360: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
+0001f370: 2020 7365 6c66 2e72 6f6f 742e 7967 7269    self.root.ygri
+0001f380: 642e 7669 7369 626c 6520 3d20 5472 7565  d.visible = True
+0001f390: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001f3a0: 6f74 2e78 6772 6964 2e76 6973 6962 6c65  ot.xgrid.visible
+0001f3b0: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0001f3c0: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
+0001f3d0: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
+0001f3e0: 2074 6f6f 6c74 6970 733d 5b28 224e 616d   tooltips=[("Nam
+0001f3f0: 6522 2c20 2240 6e61 6d65 7322 292c 2028  e", "@names"), (
+0001f400: 2256 616c 7565 222c 2022 4074 6578 7422  "Value", "@text"
+0001f410: 295d 2c20 6d6f 6465 3d22 766c 696e 6522  )], mode="vline"
+0001f420: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001f430: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
+0001f440: 5f74 6f6f 6c73 2868 6f76 6572 290a 0a20  _tools(hover).. 
+0001f450: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
+0001f460: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
+0001f470: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0001f480: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
+0001f490: 656c 6629 3a0a 2020 2020 2020 2020 7320  elf):.        s 
+0001f4a0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+0001f4b0: 0a20 2020 2020 2020 206d 6f6e 6974 6f72  .        monitor
+0001f4c0: 5f67 696c 203d 2073 2e6d 6f6e 6974 6f72  _gil = s.monitor
+0001f4d0: 2e6d 6f6e 6974 6f72 5f67 696c 5f63 6f6e  .monitor_gil_con
+0001f4e0: 7465 6e74 696f 6e0a 0a20 2020 2020 2020  tention..       
+0001f4f0: 2073 656c 662e 6461 7461 5b22 7661 6c75   self.data["valu
+0001f500: 6573 225d 203d 205b 0a20 2020 2020 2020  es"] = [.       
+0001f510: 2020 2020 2073 2e5f 7469 636b 5f69 6e74       s._tick_int
+0001f520: 6572 7661 6c5f 6f62 7365 7276 6564 2c0a  erval_observed,.
+0001f530: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001f540: 2e67 696c 5f63 6f6e 7465 6e74 696f 6e5f  .gil_contention_
+0001f550: 7363 6865 6475 6c65 722c 0a20 2020 2020  scheduler,.     
+0001f560: 2020 2020 2020 2073 756d 2877 2e6d 6574         sum(w.met
+0001f570: 7269 6373 5b22 6576 656e 745f 6c6f 6f70  rics["event_loop
+0001f580: 5f69 6e74 6572 7661 6c22 5d20 666f 7220  _interval"] for 
+0001f590: 7720 696e 2073 2e77 6f72 6b65 7273 2e76  w in s.workers.v
+0001f5a0: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
+0001f5b0: 2020 2020 202f 2028 6c65 6e28 732e 776f       / (len(s.wo
+0001f5c0: 726b 6572 7329 206f 7220 3129 2c0a 2020  rkers) or 1),.  
+0001f5d0: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
+0001f5e0: 696c 5f63 6f6e 7465 6e74 696f 6e5f 776f  il_contention_wo
+0001f5f0: 726b 6572 732c 0a20 2020 2020 2020 205d  rkers,.        ]
+0001f600: 5b3a 3a20 3120 6966 206d 6f6e 6974 6f72  [:: 1 if monitor
+0001f610: 5f67 696c 2065 6c73 6520 325d 0a0a 2020  _gil else 2]..  
+0001f620: 2020 2020 2020 2320 466f 726d 6174 2065        # Format e
+0001f630: 7665 6e74 206c 6f6f 7020 6173 2074 696d  vent loop as tim
+0001f640: 6520 616e 6420 4749 4c20 2869 6620 636f  e and GIL (if co
+0001f650: 6e66 6967 7572 6564 2920 6173 2025 0a20  nfigured) as %. 
+0001f660: 2020 2020 2020 2073 656c 662e 6461 7461         self.data
+0001f670: 5b22 7465 7874 225d 203d 205b 0a20 2020  ["text"] = [.   
+0001f680: 2020 2020 2020 2020 2066 227b 7820 2a20           f"{x * 
+0001f690: 3130 303a 2e31 667d 2522 2069 6620 6920  100:.1f}%" if i 
+0001f6a0: 2520 3220 616e 6420 6d6f 6e69 746f 725f  % 2 and monitor_
+0001f6b0: 6769 6c20 656c 7365 2066 6f72 6d61 745f  gil else format_
+0001f6c0: 7469 6d65 2878 290a 2020 2020 2020 2020  time(x).        
+0001f6d0: 2020 2020 666f 7220 692c 2078 2069 6e20      for i, x in 
+0001f6e0: 656e 756d 6572 6174 6528 7365 6c66 2e64  enumerate(self.d
+0001f6f0: 6174 615b 2276 616c 7565 7322 5d29 0a20  ata["values"]). 
+0001f700: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0001f710: 2075 7064 6174 6528 7365 6c66 2e73 6f75   update(self.sou
+0001f720: 7263 652c 2073 656c 662e 6461 7461 290a  rce, self.data).
+0001f730: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0001f740: 2020 2064 6566 2067 696c 5f63 6f6e 7465     def gil_conte
+0001f750: 6e74 696f 6e5f 776f 726b 6572 7328 7365  ntion_workers(se
+0001f760: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
+0001f770: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+0001f780: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+0001f790: 6f72 6b65 7273 0a20 2020 2020 2020 2069  orkers.        i
+0001f7a0: 6620 776f 726b 6572 733a 0a20 2020 2020  f workers:.     
+0001f7b0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+0001f7c0: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
+0001f7d0: 2020 2077 2e6d 6574 7269 6373 2e67 6574     w.metrics.get
+0001f7e0: 2822 6769 6c5f 636f 6e74 656e 7469 6f6e  ("gil_contention
+0001f7f0: 222c 2030 2920 666f 7220 7720 696e 2077  ", 0) for w in w
+0001f800: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
+0001f810: 2020 2020 2020 2020 2020 2020 2920 2f20              ) / 
+0001f820: 6c65 6e28 776f 726b 6572 7329 0a20 2020  len(workers).   
+0001f830: 2020 2020 2072 6574 7572 6e20 666c 6f61       return floa
+0001f840: 7428 224e 614e 2229 0a0a 2020 2020 4070  t("NaN")..    @p
+0001f850: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0001f860: 6769 6c5f 636f 6e74 656e 7469 6f6e 5f73  gil_contention_s
+0001f870: 6368 6564 756c 6572 2873 656c 6629 202d  cheduler(self) -
+0001f880: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+0001f890: 2072 6574 7572 6e20 7365 6c66 2e73 6368   return self.sch
+0001f8a0: 6564 756c 6572 2e6d 6f6e 6974 6f72 2e72  eduler.monitor.r
+0001f8b0: 6563 656e 7428 292e 6765 7428 2267 696c  ecent().get("gil
+0001f8c0: 5f63 6f6e 7465 6e74 696f 6e22 2c20 666c  _contention", fl
+0001f8d0: 6f61 7428 224e 614e 2229 290a 0a0a 636c  oat("NaN"))...cl
+0001f8e0: 6173 7320 4578 6365 7074 696f 6e73 5461  ass ExceptionsTa
+0001f8f0: 626c 6528 4461 7368 626f 6172 6443 6f6d  ble(DashboardCom
+0001f900: 706f 6e65 6e74 293a 0a20 2020 2022 2222  ponent):.    """
+0001f910: 0a20 2020 2045 7863 6570 7469 6f6e 7320  .    Exceptions 
+0001f920: 6c6f 6767 6564 2069 6e20 7461 736b 732e  logged in tasks.
+0001f930: 0a0a 2020 2020 5369 6e63 6520 7468 6572  ..    Since ther
+0001f940: 6520 6d69 6768 7420 6265 206d 616e 7920  e might be many 
+0001f950: 7265 6c61 7465 6420 6578 6365 7074 696f  related exceptio
+0001f960: 6e73 2028 652e 672e 2c20 616c 6c20 7461  ns (e.g., all ta
+0001f970: 736b 7320 696e 2061 2067 6976 656e 0a20  sks in a given. 
+0001f980: 2020 2074 6173 6b20 6772 6f75 7020 6661     task group fa
+0001f990: 696c 2066 6f72 2074 6865 2073 616d 6520  il for the same 
+0001f9a0: 7265 6173 6f6e 292c 2077 6520 6d61 6b65  reason), we make
+0001f9b0: 2061 2062 6573 742d 6566 666f 7274 2061   a best-effort a
+0001f9c0: 7474 656d 7074 2074 6f0a 2020 2020 2831  ttempt to.    (1
+0001f9d0: 2920 6167 6772 6567 6174 6520 746f 2074  ) aggregate to t
+0001f9e0: 6865 2074 6173 6b20 6772 6f75 702c 2061  he task group, a
+0001f9f0: 6e64 2028 3229 2064 6564 7570 6c69 6361  nd (2) deduplica
+0001fa00: 7465 2073 696d 696c 6172 206c 6f6f 6b69  te similar looki
+0001fa10: 6e67 2074 6173 6b73 2e0a 2020 2020 2222  ng tasks..    ""
+0001fa20: 220a 0a20 2020 2073 6368 6564 756c 6572  "..    scheduler
+0001fa30: 3a20 5363 6865 6475 6c65 720a 0a20 2020  : Scheduler..   
+0001fa40: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0001fa50: 6c66 2c20 7363 6865 6475 6c65 723a 2053  lf, scheduler: S
+0001fa60: 6368 6564 756c 6572 2c20 7769 6474 683a  cheduler, width:
+0001fa70: 2069 6e74 203d 2031 3030 302c 202a 2a6b   int = 1000, **k
+0001fa80: 7761 7267 733a 2041 6e79 293a 0a20 2020  wargs: Any):.   
+0001fa90: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+0001faa0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+0001fab0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
+0001fac0: 6d65 7320 3d20 5b0a 2020 2020 2020 2020  mes = [.        
+0001fad0: 2020 2020 2254 6173 6b22 2c0a 2020 2020      "Task",.    
+0001fae0: 2020 2020 2020 2020 2245 7863 6570 7469          "Excepti
+0001faf0: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
+0001fb00: 2022 5472 6163 6562 6163 6b22 2c0a 2020   "Traceback",.  
+0001fb10: 2020 2020 2020 2020 2020 2257 6f72 6b65            "Worke
+0001fb20: 7228 7329 222c 0a20 2020 2020 2020 2020  r(s)",.         
+0001fb30: 2020 2022 436f 756e 7422 2c0a 2020 2020     "Count",.    
+0001fb40: 2020 2020 5d0a 0a20 2020 2020 2020 2073      ]..        s
+0001fb50: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+0001fb60: 756d 6e44 6174 6153 6f75 7263 6528 7b6b  umnDataSource({k
+0001fb70: 3a20 5b5d 2066 6f72 206b 2069 6e20 7365  : [] for k in se
+0001fb80: 6c66 2e6e 616d 6573 7d29 0a0a 2020 2020  lf.names})..    
+0001fb90: 2020 2020 636f 6465 5f66 6f72 6d61 7474      code_formatt
+0001fba0: 6572 203d 2048 544d 4c54 656d 706c 6174  er = HTMLTemplat
+0001fbb0: 6546 6f72 6d61 7474 6572 280a 2020 2020  eFormatter(.    
+0001fbc0: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
+0001fbd0: 3d27 3c63 6f64 6520 7469 746c 653d 223c  ='<code title="<
+0001fbe0: 252d 2076 616c 7565 2025 3e22 3e3c 253d  %- value %>"><%=
+0001fbf0: 2076 616c 7565 2025 3e3c 2f63 6f64 653e   value %></code>
+0001fc00: 270a 2020 2020 2020 2020 290a 2020 2020  '.        ).    
+0001fc10: 2020 2020 636f 6c75 6d6e 7320 3d20 5b0a      columns = [.
+0001fc20: 2020 2020 2020 2020 2020 2020 5461 626c              Tabl
+0001fc30: 6543 6f6c 756d 6e28 0a20 2020 2020 2020  eColumn(.       
+0001fc40: 2020 2020 2020 2020 2066 6965 6c64 3d22           field="
+0001fc50: 5461 736b 222c 0a20 2020 2020 2020 2020  Task",.         
+0001fc60: 2020 2020 2020 2074 6974 6c65 3d22 5461         title="Ta
+0001fc70: 736b 222c 0a20 2020 2020 2020 2020 2020  sk",.           
+0001fc80: 2020 2020 2066 6f72 6d61 7474 6572 3d63       formatter=c
+0001fc90: 6f64 655f 666f 726d 6174 7465 722c 0a20  ode_formatter,. 
+0001fca0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001fcb0: 6964 7468 3d31 3530 2c0a 2020 2020 2020  idth=150,.      
+0001fcc0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0001fcd0: 2020 2020 2054 6162 6c65 436f 6c75 6d6e       TableColumn
+0001fce0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001fcf0: 2020 6669 656c 643d 2245 7863 6570 7469    field="Excepti
+0001fd00: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
+0001fd10: 2020 2020 2074 6974 6c65 3d22 4578 6365       title="Exce
+0001fd20: 7074 696f 6e22 2c0a 2020 2020 2020 2020  ption",.        
+0001fd30: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
+0001fd40: 723d 636f 6465 5f66 6f72 6d61 7474 6572  r=code_formatter
+0001fd50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001fd60: 2020 7769 6474 683d 3330 302c 0a20 2020    width=300,.   
+0001fd70: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+0001fd80: 2020 2020 2020 2020 5461 626c 6543 6f6c          TableCol
+0001fd90: 756d 6e28 0a20 2020 2020 2020 2020 2020  umn(.           
+0001fda0: 2020 2020 2066 6965 6c64 3d22 5472 6163       field="Trac
+0001fdb0: 6562 6163 6b22 2c0a 2020 2020 2020 2020  eback",.        
+0001fdc0: 2020 2020 2020 2020 7469 746c 653d 2254          title="T
+0001fdd0: 7261 6365 6261 636b 222c 0a20 2020 2020  raceback",.     
+0001fde0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0001fdf0: 7474 6572 3d63 6f64 655f 666f 726d 6174  tter=code_format
+0001fe00: 7465 722c 0a20 2020 2020 2020 2020 2020  ter,.           
+0001fe10: 2020 2020 2077 6964 7468 3d33 3030 2c0a       width=300,.
+0001fe20: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+0001fe30: 2020 2020 2020 2020 2020 2054 6162 6c65             Table
+0001fe40: 436f 6c75 6d6e 280a 2020 2020 2020 2020  Column(.        
+0001fe50: 2020 2020 2020 2020 6669 656c 643d 2257          field="W
+0001fe60: 6f72 6b65 7228 7329 222c 0a20 2020 2020  orker(s)",.     
+0001fe70: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+0001fe80: 3d22 576f 726b 6572 2873 2922 2c0a 2020  ="Worker(s)",.  
+0001fe90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001fea0: 726d 6174 7465 723d 636f 6465 5f66 6f72  rmatter=code_for
+0001feb0: 6d61 7474 6572 2c0a 2020 2020 2020 2020  matter,.        
+0001fec0: 2020 2020 2020 2020 7769 6474 683d 3230          width=20
+0001fed0: 302c 0a20 2020 2020 2020 2020 2020 2029  0,.            )
+0001fee0: 2c0a 2020 2020 2020 2020 2020 2020 5461  ,.            Ta
+0001fef0: 626c 6543 6f6c 756d 6e28 0a20 2020 2020  bleColumn(.     
+0001ff00: 2020 2020 2020 2020 2020 2066 6965 6c64             field
+0001ff10: 3d22 436f 756e 7422 2c0a 2020 2020 2020  ="Count",.      
+0001ff20: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0001ff30: 2243 6f75 6e74 222c 0a20 2020 2020 2020  "Count",.       
+0001ff40: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
+0001ff50: 6572 3d4e 756d 6265 7246 6f72 6d61 7474  er=NumberFormatt
+0001ff60: 6572 2866 6f72 6d61 743d 2230 2c30 2229  er(format="0,0")
+0001ff70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ff80: 2020 7769 6474 683d 3530 2c0a 2020 2020    width=50,.    
+0001ff90: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0001ffa0: 2020 205d 0a0a 2020 2020 2020 2020 6966     ]..        if
+0001ffb0: 2022 7369 7a69 6e67 5f6d 6f64 6522 2069   "sizing_mode" i
+0001ffc0: 6e20 6b77 6172 6773 3a0a 2020 2020 2020  n kwargs:.      
+0001ffd0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
+0001ffe0: 6520 3d20 7b22 7369 7a69 6e67 5f6d 6f64  e = {"sizing_mod
+0001fff0: 6522 3a20 6b77 6172 6773 5b22 7369 7a69  e": kwargs["sizi
+00020000: 6e67 5f6d 6f64 6522 5d7d 0a20 2020 2020  ng_mode"]}.     
+00020010: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00020020: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
+00020030: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00020040: 6c66 2e72 6f6f 7420 3d20 4461 7461 5461  lf.root = DataTa
+00020050: 626c 6528 0a20 2020 2020 2020 2020 2020  ble(.           
+00020060: 2073 6f75 7263 653d 7365 6c66 2e73 6f75   source=self.sou
+00020070: 7263 652c 0a20 2020 2020 2020 2020 2020  rce,.           
+00020080: 2063 6f6c 756d 6e73 3d63 6f6c 756d 6e73   columns=columns
+00020090: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+000200a0: 6f72 6465 7261 626c 653d 5472 7565 2c0a  orderable=True,.
+000200b0: 2020 2020 2020 2020 2020 2020 736f 7274              sort
+000200c0: 6162 6c65 3d54 7275 652c 0a20 2020 2020  able=True,.     
+000200d0: 2020 2020 2020 2077 6964 7468 3d77 6964         width=wid
+000200e0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+000200f0: 696e 6465 785f 706f 7369 7469 6f6e 3d4e  index_position=N
+00020100: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00020110: 202a 2a5f 4441 5441 5441 424c 455f 5354   **_DATATABLE_ST
+00020120: 594c 4553 4845 4554 535f 4b57 4152 4753  YLESHEETS_KWARGS
+00020130: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00020140: 7369 7a69 6e67 5f6d 6f64 652c 0a20 2020  sizing_mode,.   
+00020150: 2020 2020 2029 0a0a 2020 2020 4077 6974       )..    @wit
+00020160: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00020170: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
+00020180: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+00020190: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
+000201a0: 3d20 7b6e 616d 653a 205b 5d20 666f 7220  = {name: [] for 
+000201b0: 6e61 6d65 2069 6e20 7365 6c66 2e6e 616d  name in self.nam
+000201c0: 6573 7d0a 2020 2020 2020 2020 6572 7265  es}.        erre
+000201d0: 645f 7461 736b 7320 3d20 7365 6c66 2e73  d_tasks = self.s
+000201e0: 6368 6564 756c 6572 2e65 7272 6564 5f74  cheduler.erred_t
+000201f0: 6173 6b73 0a0a 2020 2020 2020 2020 666f  asks..        fo
+00020200: 7220 7473 2069 6e20 6572 7265 645f 7461  r ts in erred_ta
+00020210: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00020220: 206e 6577 5f64 6174 615b 2254 6173 6b22   new_data["Task"
+00020230: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
+00020240: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+00020250: 5f64 6174 615b 2245 7863 6570 7469 6f6e  _data["Exception
+00020260: 225d 2e61 7070 656e 6428 7473 2e65 7863  "].append(ts.exc
+00020270: 6570 7469 6f6e 5f74 6578 7429 0a20 2020  eption_text).   
+00020280: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
+00020290: 615b 2254 7261 6365 6261 636b 225d 2e61  a["Traceback"].a
+000202a0: 7070 656e 6428 7473 2e74 7261 6365 6261  ppend(ts.traceba
+000202b0: 636b 5f74 6578 7429 0a20 2020 2020 2020  ck_text).       
+000202c0: 2020 2020 206e 6577 5f64 6174 615b 2257       new_data["W
+000202d0: 6f72 6b65 7228 7329 225d 2e61 7070 656e  orker(s)"].appen
+000202e0: 6428 222c 5c6e 222e 6a6f 696e 2874 732e  d(",\n".join(ts.
+000202f0: 6572 7265 645f 6f6e 2929 0a20 2020 2020  erred_on)).     
+00020300: 2020 2020 2020 206e 6577 5f64 6174 615b         new_data[
+00020310: 2243 6f75 6e74 225d 2e61 7070 656e 6428  "Count"].append(
+00020320: 6c65 6e28 7473 2e65 7272 6564 5f6f 6e29  len(ts.erred_on)
+00020330: 290a 0a20 2020 2020 2020 2075 7064 6174  )..        updat
+00020340: 6528 7365 6c66 2e73 6f75 7263 652c 206e  e(self.source, n
+00020350: 6577 5f64 6174 6129 0a0a 0a63 6c61 7373  ew_data)...class
+00020360: 2057 6f72 6b65 7254 6162 6c65 2844 6173   WorkerTable(Das
+00020370: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+00020380: 3a0a 2020 2020 2222 2253 7461 7475 7320  :.    """Status 
+00020390: 6f66 2074 6865 2063 7572 7265 6e74 2077  of the current w
+000203a0: 6f72 6b65 7273 0a0a 2020 2020 5468 6973  orkers..    This
+000203b0: 2069 7320 7477 6f20 706c 6f74 732c 2061   is two plots, a
+000203c0: 2074 6578 742d 6261 7365 6420 7461 626c   text-based tabl
+000203d0: 6520 666f 7220 6561 6368 2068 6f73 7420  e for each host 
+000203e0: 616e 6420 6120 7468 696e 2068 6f72 697a  and a thin horiz
+000203f0: 6f6e 7461 6c0a 2020 2020 706c 6f74 206c  ontal.    plot l
+00020400: 6179 696e 6720 6f75 7420 686f 7374 7320  aying out hosts 
+00020410: 6279 2074 6865 6972 2063 7572 7265 6e74  by their current
+00020420: 206d 656d 6f72 7920 7573 652e 0a20 2020   memory use..   
+00020430: 2022 2222 0a0a 2020 2020 6578 636c 7564   """..    exclud
+00020440: 6564 5f6e 616d 6573 203d 207b 0a20 2020  ed_names = {.   
+00020450: 2020 2020 2022 6578 6563 7574 696e 6722       "executing"
+00020460: 2c0a 2020 2020 2020 2020 2269 6e5f 666c  ,.        "in_fl
+00020470: 6967 6874 222c 0a20 2020 2020 2020 2022  ight",.        "
+00020480: 696e 5f6d 656d 6f72 7922 2c0a 2020 2020  in_memory",.    
+00020490: 2020 2020 2272 6561 6479 222c 0a20 2020      "ready",.   
+000204a0: 2020 2020 2022 7469 6d65 222c 0a20 2020       "time",.   
+000204b0: 2020 2020 2023 2055 7365 2073 6368 6564       # Use sched
+000204c0: 756c 6572 2e57 6f72 6b65 7253 7461 7465  uler.WorkerState
+000204d0: 2e6d 656d 6f72 792e 6d61 6e61 6765 6420  .memory.managed 
+000204e0: 696e 7374 6561 6420 6f66 0a20 2020 2020  instead of.     
+000204f0: 2020 2023 2073 6368 6564 756c 6572 2e57     # scheduler.W
+00020500: 6f72 6b65 7253 7461 7465 2e6d 6574 7269  orkerState.metri
+00020510: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
+00020520: 7322 5d3b 2074 6865 2074 776f 206d 6561  s"]; the two mea
+00020530: 7375 7265 7320 6172 6520 736c 6967 6874  sures are slight
+00020540: 6c79 0a20 2020 2020 2020 2023 2064 6966  ly.        # dif
+00020550: 6665 7265 6e74 2e20 5365 6520 6578 706c  ferent. See expl
+00020560: 616e 6174 696f 6e20 696e 2073 6368 6564  anation in sched
+00020570: 756c 6572 2e57 6f72 6b65 7253 7461 7465  uler.WorkerState
+00020580: 2e6d 656d 6f72 7928 292e 0a20 2020 2020  .memory()..     
+00020590: 2020 2022 6d61 6e61 6765 645f 6279 7465     "managed_byte
+000205a0: 7322 2c0a 2020 2020 2020 2020 2273 7069  s",.        "spi
+000205b0: 6c6c 6564 5f62 7974 6573 222c 0a20 2020  lled_bytes",.   
+000205c0: 207d 0a0a 2020 2020 6465 6620 5f5f 696e   }..    def __in
+000205d0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+000205e0: 756c 6572 2c20 7769 6474 683d 3830 302c  uler, width=800,
+000205f0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00020600: 2020 2020 7365 6c66 2e73 6368 6564 756c      self.schedul
+00020610: 6572 203d 2073 6368 6564 756c 6572 0a20  er = scheduler. 
+00020620: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
+00020630: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00020640: 2020 226e 616d 6522 2c0a 2020 2020 2020    "name",.      
+00020650: 2020 2020 2020 2261 6464 7265 7373 222c        "address",
+00020660: 0a20 2020 2020 2020 2020 2020 2022 6e74  .            "nt
+00020670: 6872 6561 6473 222c 0a20 2020 2020 2020  hreads",.       
+00020680: 2020 2020 2022 6370 7522 2c0a 2020 2020       "cpu",.    
+00020690: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
+000206a0: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+000206b0: 656d 6f72 795f 6c69 6d69 7422 2c0a 2020  emory_limit",.  
+000206c0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+000206d0: 795f 7065 7263 656e 7422 2c0a 2020 2020  y_percent",.    
+000206e0: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+000206f0: 6d61 6e61 6765 6422 2c0a 2020 2020 2020  managed",.      
+00020700: 2020 2020 2020 226d 656d 6f72 795f 756e        "memory_un
+00020710: 6d61 6e61 6765 645f 6f6c 6422 2c0a 2020  managed_old",.  
+00020720: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00020730: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
+00020740: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
+00020750: 2022 6d65 6d6f 7279 5f73 7069 6c6c 6564   "memory_spilled
+00020760: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00020770: 6e75 6d5f 6664 7322 2c0a 2020 2020 2020  num_fds",.      
+00020780: 2020 2020 2020 2268 6f73 745f 6e65 745f        "host_net_
+00020790: 696f 2e72 6561 645f 6270 7322 2c0a 2020  io.read_bps",.  
+000207a0: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
+000207b0: 6e65 745f 696f 2e77 7269 7465 5f62 7073  net_io.write_bps
+000207c0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000207d0: 686f 7374 5f64 6973 6b5f 696f 2e72 6561  host_disk_io.rea
+000207e0: 645f 6270 7322 2c0a 2020 2020 2020 2020  d_bps",.        
+000207f0: 2020 2020 2268 6f73 745f 6469 736b 5f69      "host_disk_i
+00020800: 6f2e 7772 6974 655f 6270 7322 2c0a 2020  o.write_bps",.  
+00020810: 2020 2020 2020 2020 2020 2263 7075 5f66            "cpu_f
+00020820: 7261 6374 696f 6e22 2c0a 2020 2020 2020  raction",.      
+00020830: 2020 5d0a 2020 2020 2020 2020 776f 726b    ].        work
+00020840: 6572 7320 3d20 7365 6c66 2e73 6368 6564  ers = self.sched
+00020850: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+00020860: 7565 7328 290a 2020 2020 2020 2020 7365  ues().        se
+00020870: 6c66 2e65 7874 7261 5f6e 616d 6573 203d  lf.extra_names =
+00020880: 2073 6f72 7465 6428 0a20 2020 2020 2020   sorted(.       
+00020890: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000208a0: 2020 2020 2020 206d 0a20 2020 2020 2020         m.       
+000208b0: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
+000208c0: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
+000208d0: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+000208e0: 2c20 7620 696e 2077 732e 6d65 7472 6963  , v in ws.metric
+000208f0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+00020900: 2020 2020 2020 2020 2020 6966 206d 206e            if m n
+00020910: 6f74 2069 6e20 7365 6c66 2e6e 616d 6573  ot in self.names
+00020920: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+00020930: 762c 2028 7374 722c 2069 6e74 2c20 666c  v, (str, int, fl
+00020940: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
+00020950: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00020960: 2d20 7365 6c66 2e65 7863 6c75 6465 645f  - self.excluded_
+00020970: 6e61 6d65 730a 2020 2020 2020 2020 290a  names.        ).
+00020980: 0a20 2020 2020 2020 2074 6162 6c65 5f6e  .        table_n
+00020990: 616d 6573 203d 205b 0a20 2020 2020 2020  ames = [.       
+000209a0: 2020 2020 2022 6e61 6d65 222c 0a20 2020       "name",.   
+000209b0: 2020 2020 2020 2020 2022 6164 6472 6573           "addres
+000209c0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+000209d0: 226e 7468 7265 6164 7322 2c0a 2020 2020  "nthreads",.    
+000209e0: 2020 2020 2020 2020 2263 7075 222c 0a20          "cpu",. 
+000209f0: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00020a00: 7279 222c 0a20 2020 2020 2020 2020 2020  ry",.           
+00020a10: 2022 6d65 6d6f 7279 5f6c 696d 6974 222c   "memory_limit",
+00020a20: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00020a30: 6d6f 7279 5f70 6572 6365 6e74 222c 0a20  mory_percent",. 
+00020a40: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00020a50: 7279 5f6d 616e 6167 6564 222c 0a20 2020  ry_managed",.   
+00020a60: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00020a70: 5f75 6e6d 616e 6167 6564 5f6f 6c64 222c  _unmanaged_old",
+00020a80: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00020a90: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f72  mory_unmanaged_r
+00020aa0: 6563 656e 7422 2c0a 2020 2020 2020 2020  ecent",.        
+00020ab0: 2020 2020 226d 656d 6f72 795f 7370 696c      "memory_spil
+00020ac0: 6c65 6422 2c0a 2020 2020 2020 2020 2020  led",.          
+00020ad0: 2020 226e 756d 5f66 6473 222c 0a20 2020    "num_fds",.   
+00020ae0: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
+00020af0: 6574 5f69 6f2e 7265 6164 5f62 7073 222c  et_io.read_bps",
+00020b00: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00020b10: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
+00020b20: 6270 7322 2c0a 2020 2020 2020 2020 2020  bps",.          
+00020b30: 2020 2268 6f73 745f 6469 736b 5f69 6f2e    "host_disk_io.
+00020b40: 7265 6164 5f62 7073 222c 0a20 2020 2020  read_bps",.     
+00020b50: 2020 2020 2020 2022 686f 7374 5f64 6973         "host_dis
+00020b60: 6b5f 696f 2e77 7269 7465 5f62 7073 222c  k_io.write_bps",
+00020b70: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+00020b80: 2020 2063 6f6c 756d 6e5f 7469 746c 655f     column_title_
+00020b90: 7265 6e61 6d65 7320 3d20 7b0a 2020 2020  renames = {.    
+00020ba0: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+00020bb0: 6c69 6d69 7422 3a20 226c 696d 6974 222c  limit": "limit",
+00020bc0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00020bd0: 6d6f 7279 5f70 6572 6365 6e74 223a 2022  mory_percent": "
+00020be0: 6d65 6d6f 7279 2025 222c 0a20 2020 2020  memory %",.     
+00020bf0: 2020 2020 2020 2022 6d65 6d6f 7279 5f6d         "memory_m
+00020c00: 616e 6167 6564 223a 2022 6d61 6e61 6765  anaged": "manage
+00020c10: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00020c20: 226d 656d 6f72 795f 756e 6d61 6e61 6765  "memory_unmanage
+00020c30: 645f 6f6c 6422 3a20 2275 6e6d 616e 6167  d_old": "unmanag
+00020c40: 6564 206f 6c64 222c 0a20 2020 2020 2020  ed old",.       
+00020c50: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
+00020c60: 616e 6167 6564 5f72 6563 656e 7422 3a20  anaged_recent": 
+00020c70: 2275 6e6d 616e 6167 6564 2072 6563 656e  "unmanaged recen
+00020c80: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00020c90: 226d 656d 6f72 795f 7370 696c 6c65 6422  "memory_spilled"
+00020ca0: 3a20 2273 7069 6c6c 6564 222c 0a20 2020  : "spilled",.   
+00020cb0: 2020 2020 2020 2020 2022 6e75 6d5f 6664           "num_fd
+00020cc0: 7322 3a20 2223 2066 6473 222c 0a20 2020  s": "# fds",.   
+00020cd0: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
+00020ce0: 6574 5f69 6f2e 7265 6164 5f62 7073 223a  et_io.read_bps":
+00020cf0: 2022 6e65 7420 7265 6164 222c 0a20 2020   "net read",.   
+00020d00: 2020 2020 2020 2020 2022 686f 7374 5f6e           "host_n
+00020d10: 6574 5f69 6f2e 7772 6974 655f 6270 7322  et_io.write_bps"
+00020d20: 3a20 226e 6574 2077 7269 7465 222c 0a20  : "net write",. 
+00020d30: 2020 2020 2020 2020 2020 2022 686f 7374             "host
+00020d40: 5f64 6973 6b5f 696f 2e72 6561 645f 6270  _disk_io.read_bp
+00020d50: 7322 3a20 2264 6973 6b20 7265 6164 222c  s": "disk read",
+00020d60: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00020d70: 7374 5f64 6973 6b5f 696f 2e77 7269 7465  st_disk_io.write
+00020d80: 5f62 7073 223a 2022 6469 736b 2077 7269  _bps": "disk wri
+00020d90: 7465 222c 0a20 2020 2020 2020 207d 0a0a  te",.        }..
+00020da0: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00020db0: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
+00020dc0: 536f 7572 6365 287b 6b3a 205b 5d20 666f  Source({k: [] fo
+00020dd0: 7220 6b20 696e 2073 656c 662e 6e61 6d65  r k in self.name
+00020de0: 737d 290a 0a20 2020 2020 2020 2063 6f6c  s})..        col
+00020df0: 756d 6e73 203d 207b 0a20 2020 2020 2020  umns = {.       
+00020e00: 2020 2020 206e 616d 653a 2054 6162 6c65       name: Table
+00020e10: 436f 6c75 6d6e 2866 6965 6c64 3d6e 616d  Column(field=nam
+00020e20: 652c 2074 6974 6c65 3d63 6f6c 756d 6e5f  e, title=column_
+00020e30: 7469 746c 655f 7265 6e61 6d65 732e 6765  title_renames.ge
+00020e40: 7428 6e61 6d65 2c20 6e61 6d65 2929 0a20  t(name, name)). 
+00020e50: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
+00020e60: 616d 6520 696e 2074 6162 6c65 5f6e 616d  ame in table_nam
+00020e70: 6573 0a20 2020 2020 2020 207d 0a0a 2020  es.        }..  
+00020e80: 2020 2020 2020 666f 726d 6174 7465 7273        formatters
+00020e90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00020ea0: 2022 6370 7522 3a20 4e75 6d62 6572 466f   "cpu": NumberFo
+00020eb0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+00020ec0: 3020 2522 292c 0a20 2020 2020 2020 2020  0 %"),.         
+00020ed0: 2020 2022 6d65 6d6f 7279 5f70 6572 6365     "memory_perce
+00020ee0: 6e74 223a 204e 756d 6265 7246 6f72 6d61  nt": NumberForma
+00020ef0: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00020f00: 2025 2229 2c0a 2020 2020 2020 2020 2020   %"),.          
+00020f10: 2020 226d 656d 6f72 7922 3a20 4e75 6d62    "memory": Numb
+00020f20: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
+00020f30: 6174 3d22 302e 3020 6222 292c 0a20 2020  at="0.0 b"),.   
+00020f40: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00020f50: 5f6c 696d 6974 223a 204e 756d 6265 7246  _limit": NumberF
+00020f60: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00020f70: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
+00020f80: 2020 2020 2020 226d 656d 6f72 795f 6d61        "memory_ma
+00020f90: 6e61 6765 6422 3a20 4e75 6d62 6572 466f  naged": NumberFo
+00020fa0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+00020fb0: 302e 3020 6222 292c 0a20 2020 2020 2020  0.0 b"),.       
+00020fc0: 2020 2020 2022 6d65 6d6f 7279 5f75 6e6d       "memory_unm
+00020fd0: 616e 6167 6564 5f6f 6c64 223a 204e 756d  anaged_old": Num
+00020fe0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00020ff0: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
+00021000: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00021010: 795f 756e 6d61 6e61 6765 645f 7265 6365  y_unmanaged_rece
+00021020: 6e74 223a 204e 756d 6265 7246 6f72 6d61  nt": NumberForma
+00021030: 7474 6572 2866 6f72 6d61 743d 2230 2e30  tter(format="0.0
+00021040: 2062 2229 2c0a 2020 2020 2020 2020 2020   b"),.          
+00021050: 2020 226d 656d 6f72 795f 7370 696c 6c65    "memory_spille
+00021060: 6422 3a20 4e75 6d62 6572 466f 726d 6174  d": NumberFormat
+00021070: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
+00021080: 6222 292c 0a20 2020 2020 2020 2020 2020  b"),.           
+00021090: 2022 686f 7374 5f6e 6574 5f69 6f2e 7265   "host_net_io.re
+000210a0: 6164 5f62 7073 223a 204e 756d 6265 7246  ad_bps": NumberF
+000210b0: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+000210c0: 2230 2062 2229 2c0a 2020 2020 2020 2020  "0 b"),.        
+000210d0: 2020 2020 2268 6f73 745f 6e65 745f 696f      "host_net_io
+000210e0: 2e77 7269 7465 5f62 7073 223a 204e 756d  .write_bps": Num
+000210f0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00021100: 6d61 743d 2230 2062 2229 2c0a 2020 2020  mat="0 b"),.    
+00021110: 2020 2020 2020 2020 226e 756d 5f66 6473          "num_fds
+00021120: 223a 204e 756d 6265 7246 6f72 6d61 7474  ": NumberFormatt
+00021130: 6572 2866 6f72 6d61 743d 2230 2229 2c0a  er(format="0"),.
+00021140: 2020 2020 2020 2020 2020 2020 226e 7468              "nth
+00021150: 7265 6164 7322 3a20 4e75 6d62 6572 466f  reads": NumberFo
+00021160: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+00021170: 3022 292c 0a20 2020 2020 2020 2020 2020  0"),.           
+00021180: 2022 686f 7374 5f64 6973 6b5f 696f 2e72   "host_disk_io.r
+00021190: 6561 645f 6270 7322 3a20 4e75 6d62 6572  ead_bps": Number
+000211a0: 466f 726d 6174 7465 7228 666f 726d 6174  Formatter(format
+000211b0: 3d22 3020 6222 292c 0a20 2020 2020 2020  ="0 b"),.       
+000211c0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
+000211d0: 696f 2e77 7269 7465 5f62 7073 223a 204e  io.write_bps": N
+000211e0: 756d 6265 7246 6f72 6d61 7474 6572 2866  umberFormatter(f
+000211f0: 6f72 6d61 743d 2230 2062 2229 2c0a 2020  ormat="0 b"),.  
+00021200: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00021210: 2074 6162 6c65 203d 2044 6174 6154 6162   table = DataTab
+00021220: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00021230: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+00021240: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+00021250: 636f 6c75 6d6e 733d 5b63 6f6c 756d 6e73  columns=[columns
+00021260: 5b6e 5d20 666f 7220 6e20 696e 2074 6162  [n] for n in tab
+00021270: 6c65 5f6e 616d 6573 5d2c 0a20 2020 2020  le_names],.     
+00021280: 2020 2020 2020 2072 656f 7264 6572 6162         reorderab
+00021290: 6c65 3d54 7275 652c 0a20 2020 2020 2020  le=True,.       
+000212a0: 2020 2020 2073 6f72 7461 626c 653d 5472       sortable=Tr
+000212b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000212c0: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
+000212d0: 2020 2020 2020 2020 2069 6e64 6578 5f70           index_p
+000212e0: 6f73 6974 696f 6e3d 4e6f 6e65 2c0a 2020  osition=None,.  
+000212f0: 2020 2020 2020 2020 2020 2a2a 5f44 4154            **_DAT
+00021300: 4154 4142 4c45 5f53 5459 4c45 5348 4545  ATABLE_STYLESHEE
+00021310: 5453 5f4b 5741 5247 532c 0a20 2020 2020  TS_KWARGS,.     
+00021320: 2020 2029 0a0a 2020 2020 2020 2020 666f     )..        fo
+00021330: 7220 6e61 6d65 2069 6e20 7461 626c 655f  r name in table_
+00021340: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
+00021350: 2020 2069 6620 6e61 6d65 2069 6e20 666f     if name in fo
+00021360: 726d 6174 7465 7273 3a0a 2020 2020 2020  rmatters:.      
+00021370: 2020 2020 2020 2020 2020 7461 626c 652e            table.
+00021380: 636f 6c75 6d6e 735b 7461 626c 655f 6e61  columns[table_na
+00021390: 6d65 732e 696e 6465 7828 6e61 6d65 295d  mes.index(name)]
+000213a0: 2e66 6f72 6d61 7474 6572 203d 2066 6f72  .formatter = for
+000213b0: 6d61 7474 6572 735b 6e61 6d65 5d0a 0a20  matters[name].. 
+000213c0: 2020 2020 2020 2065 7874 7261 5f6e 616d         extra_nam
+000213d0: 6573 203d 205b 226e 616d 6522 2c20 2261  es = ["name", "a
+000213e0: 6464 7265 7373 225d 202b 2073 656c 662e  ddress"] + self.
+000213f0: 6578 7472 615f 6e61 6d65 730a 2020 2020  extra_names.    
+00021400: 2020 2020 6578 7472 615f 636f 6c75 6d6e      extra_column
+00021410: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+00021420: 2020 6e61 6d65 3a20 5461 626c 6543 6f6c    name: TableCol
+00021430: 756d 6e28 6669 656c 643d 6e61 6d65 2c20  umn(field=name, 
+00021440: 7469 746c 653d 636f 6c75 6d6e 5f74 6974  title=column_tit
+00021450: 6c65 5f72 656e 616d 6573 2e67 6574 286e  le_renames.get(n
+00021460: 616d 652c 206e 616d 6529 290a 2020 2020  ame, name)).    
+00021470: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+00021480: 2069 6e20 6578 7472 615f 6e61 6d65 730a   in extra_names.
+00021490: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000214a0: 2020 2065 7874 7261 5f74 6162 6c65 203d     extra_table =
+000214b0: 2044 6174 6154 6162 6c65 280a 2020 2020   DataTable(.    
+000214c0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+000214d0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+000214e0: 2020 2020 2020 2020 636f 6c75 6d6e 733d          columns=
+000214f0: 5b65 7874 7261 5f63 6f6c 756d 6e73 5b6e  [extra_columns[n
+00021500: 5d20 666f 7220 6e20 696e 2065 7874 7261  ] for n in extra
+00021510: 5f6e 616d 6573 5d2c 0a20 2020 2020 2020  _names],.       
+00021520: 2020 2020 2072 656f 7264 6572 6162 6c65       reorderable
+00021530: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00021540: 2020 2073 6f72 7461 626c 653d 5472 7565     sortable=True
+00021550: 2c0a 2020 2020 2020 2020 2020 2020 7769  ,.            wi
+00021560: 6474 683d 7769 6474 682c 0a20 2020 2020  dth=width,.     
+00021570: 2020 2020 2020 2069 6e64 6578 5f70 6f73         index_pos
+00021580: 6974 696f 6e3d 4e6f 6e65 2c0a 2020 2020  ition=None,.    
+00021590: 2020 2020 2020 2020 2a2a 5f44 4154 4154          **_DATAT
+000215a0: 4142 4c45 5f53 5459 4c45 5348 4545 5453  ABLE_STYLESHEETS
+000215b0: 5f4b 5741 5247 532c 0a20 2020 2020 2020  _KWARGS,.       
+000215c0: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
+000215d0: 6e61 6d65 2069 6e20 6578 7472 615f 6e61  name in extra_na
+000215e0: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
+000215f0: 2069 6620 6e61 6d65 2069 6e20 666f 726d   if name in form
+00021600: 6174 7465 7273 3a0a 2020 2020 2020 2020  atters:.        
+00021610: 2020 2020 2020 2020 6578 7472 615f 7461          extra_ta
+00021620: 626c 652e 636f 6c75 6d6e 735b 6578 7472  ble.columns[extr
+00021630: 615f 6e61 6d65 732e 696e 6465 7828 6e61  a_names.index(na
+00021640: 6d65 295d 2e66 6f72 6d61 7474 6572 203d  me)].formatter =
+00021650: 2066 6f72 6d61 7474 6572 735b 0a20 2020   formatters[.   
+00021660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021670: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
+00021680: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
+00021690: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+000216a0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
+000216b0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
+000216c0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
+000216d0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
+000216e0: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
+000216f0: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00021700: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+00021710: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+00021720: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+00021730: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+00021740: 206d 6f6e 6f73 7061 6365 3b22 3e57 6f72   monospace;">Wor
+00021750: 6b65 7220 2840 6e61 6d65 293a 203c 2f73  ker (@name): </s
+00021760: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00021770: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00021780: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00021790: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+000217a0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000217b0: 6163 653b 223e 406d 656d 6f72 795f 7065  ace;">@memory_pe
+000217c0: 7263 656e 747b 302e 3020 257d 3c2f 7370  rcent{0.0 %}</sp
+000217d0: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
+000217e0: 2020 2020 3c2f 6469 763e 0a20 2020 2020      </div>.     
+000217f0: 2020 2020 2020 2020 2020 2022 2222 2c0a             """,.
+00021800: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00021810: 2020 206d 656d 5f70 6c6f 7420 3d20 6669     mem_plot = fi
+00021820: 6775 7265 280a 2020 2020 2020 2020 2020  gure(.          
+00021830: 2020 7469 746c 653d 224d 656d 6f72 7920    title="Memory 
+00021840: 5573 6520 2825 2922 2c0a 2020 2020 2020  Use (%)",.      
+00021850: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
+00021860: 6361 7469 6f6e 3d4e 6f6e 652c 0a20 2020  cation=None,.   
+00021870: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+00021880: 3d28 302c 2031 292c 0a20 2020 2020 2020  =(0, 1),.       
+00021890: 2020 2020 2079 5f72 616e 6765 3d28 2d30       y_range=(-0
+000218a0: 2e31 2c20 302e 3129 2c0a 2020 2020 2020  .1, 0.1),.      
+000218b0: 2020 2020 2020 6865 6967 6874 3d36 302c        height=60,
+000218c0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+000218d0: 7468 3d77 6964 7468 2c0a 2020 2020 2020  th=width,.      
+000218e0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+000218f0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00021900: 626f 7264 6572 5f72 6967 6874 3d30 2c0a  border_right=0,.
+00021910: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00021920: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+00021930: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
+00021940: 2e63 6972 636c 6528 0a20 2020 2020 2020  .circle(.       
+00021950: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00021960: 2e73 6f75 7263 652c 2078 3d22 6d65 6d6f  .source, x="memo
+00021970: 7279 5f70 6572 6365 6e74 222c 2079 3d30  ry_percent", y=0
+00021980: 2c20 7369 7a65 3d31 302c 2066 696c 6c5f  , size=10, fill_
+00021990: 616c 7068 613d 302e 350a 2020 2020 2020  alpha=0.5.      
+000219a0: 2020 290a 2020 2020 2020 2020 6d65 6d5f    ).        mem_
+000219b0: 706c 6f74 2e79 6772 6964 2e76 6973 6962  plot.ygrid.visib
+000219c0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+000219d0: 2020 206d 656d 5f70 6c6f 742e 7961 7869     mem_plot.yaxi
+000219e0: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
+000219f0: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
+00021a00: 2020 2020 6d65 6d5f 706c 6f74 2e78 6178      mem_plot.xax
+00021a10: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
+00021a20: 7365 0a20 2020 2020 2020 206d 656d 5f70  se.        mem_p
+00021a30: 6c6f 742e 7961 7869 732e 7669 7369 626c  lot.yaxis.visibl
+00021a40: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+00021a50: 2020 6d65 6d5f 706c 6f74 2e61 6464 5f74    mem_plot.add_t
+00021a60: 6f6f 6c73 2868 6f76 6572 2c20 426f 7853  ools(hover, BoxS
+00021a70: 656c 6563 7454 6f6f 6c28 2929 0a0a 2020  electTool())..  
+00021a80: 2020 2020 2020 686f 7665 7220 3d20 486f        hover = Ho
+00021a90: 7665 7254 6f6f 6c28 0a20 2020 2020 2020  verTool(.       
+00021aa0: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
+00021ab0: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
+00021ac0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00021ad0: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
+00021ae0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00021af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021b00: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+00021b10: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+00021b20: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+00021b30: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+00021b40: 223e 576f 726b 6572 2028 406e 616d 6529  ">Worker (@name)
+00021b50: 3a20 3c2f 7370 616e 3e0a 2020 2020 2020  : </span>.      
+00021b60: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00021b70: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00021b80: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+00021b90: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+00021ba0: 6f6e 6f73 7061 6365 3b22 3e40 6370 755f  onospace;">@cpu_
+00021bb0: 6672 6163 7469 6f6e 7b30 2025 7d3c 2f73  fraction{0 %}</s
+00021bc0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00021bd0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00021be0: 2020 2020 2020 2020 2020 2020 2222 222c              """,
+00021bf0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00021c00: 2020 2020 6370 755f 706c 6f74 203d 2066      cpu_plot = f
+00021c10: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+00021c20: 2020 2074 6974 6c65 3d22 4350 5520 5573     title="CPU Us
+00021c30: 6520 2825 2922 2c0a 2020 2020 2020 2020  e (%)",.        
+00021c40: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
+00021c50: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
+00021c60: 2020 2020 2020 2078 5f72 616e 6765 3d28         x_range=(
+00021c70: 302c 2031 292c 0a20 2020 2020 2020 2020  0, 1),.         
+00021c80: 2020 2079 5f72 616e 6765 3d28 2d30 2e31     y_range=(-0.1
+00021c90: 2c20 302e 3129 2c0a 2020 2020 2020 2020  , 0.1),.        
+00021ca0: 2020 2020 6865 6967 6874 3d36 302c 0a20      height=60,. 
+00021cb0: 2020 2020 2020 2020 2020 2077 6964 7468             width
+00021cc0: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
+00021cd0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
+00021ce0: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
+00021cf0: 7264 6572 5f72 6967 6874 3d30 2c0a 2020  rder_right=0,.  
+00021d00: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00021d10: 6773 2c0a 2020 2020 2020 2020 290a 2020  gs,.        ).  
+00021d20: 2020 2020 2020 6370 755f 706c 6f74 2e63        cpu_plot.c
+00021d30: 6972 636c 6528 0a20 2020 2020 2020 2020  ircle(.         
+00021d40: 2020 2073 6f75 7263 653d 7365 6c66 2e73     source=self.s
+00021d50: 6f75 7263 652c 2078 3d22 6370 755f 6672  ource, x="cpu_fr
+00021d60: 6163 7469 6f6e 222c 2079 3d30 2c20 7369  action", y=0, si
+00021d70: 7a65 3d31 302c 2066 696c 6c5f 616c 7068  ze=10, fill_alph
+00021d80: 613d 302e 350a 2020 2020 2020 2020 290a  a=0.5.        ).
+00021d90: 2020 2020 2020 2020 6370 755f 706c 6f74          cpu_plot
+00021da0: 2e79 6772 6964 2e76 6973 6962 6c65 203d  .ygrid.visible =
+00021db0: 2046 616c 7365 0a20 2020 2020 2020 2063   False.        c
+00021dc0: 7075 5f70 6c6f 742e 7961 7869 732e 6d69  pu_plot.yaxis.mi
+00021dd0: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+00021de0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+00021df0: 6370 755f 706c 6f74 2e78 6178 6973 2e76  cpu_plot.xaxis.v
+00021e00: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+00021e10: 2020 2020 2020 2063 7075 5f70 6c6f 742e         cpu_plot.
+00021e20: 7961 7869 732e 7669 7369 626c 6520 3d20  yaxis.visible = 
+00021e30: 4661 6c73 650a 2020 2020 2020 2020 6370  False.        cp
+00021e40: 755f 706c 6f74 2e61 6464 5f74 6f6f 6c73  u_plot.add_tools
+00021e50: 2868 6f76 6572 2c20 426f 7853 656c 6563  (hover, BoxSelec
+00021e60: 7454 6f6f 6c28 2929 0a20 2020 2020 2020  tTool()).       
+00021e70: 2073 656c 662e 6370 755f 706c 6f74 203d   self.cpu_plot =
+00021e80: 2063 7075 5f70 6c6f 740a 0a20 2020 2020   cpu_plot..     
+00021e90: 2020 2069 6620 2273 697a 696e 675f 6d6f     if "sizing_mo
+00021ea0: 6465 2220 696e 206b 7761 7267 733a 0a20  de" in kwargs:. 
+00021eb0: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+00021ec0: 675f 6d6f 6465 203d 207b 2273 697a 696e  g_mode = {"sizin
+00021ed0: 675f 6d6f 6465 223a 206b 7761 7267 735b  g_mode": kwargs[
+00021ee0: 2273 697a 696e 675f 6d6f 6465 225d 7d0a  "sizing_mode"]}.
+00021ef0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00021f00: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
+00021f10: 5f6d 6f64 6520 3d20 7b7d 0a0a 2020 2020  _mode = {}..    
+00021f20: 2020 2020 636f 6d70 6f6e 656e 7473 203d      components =
+00021f30: 205b 6370 755f 706c 6f74 2c20 6d65 6d5f   [cpu_plot, mem_
+00021f40: 706c 6f74 2c20 7461 626c 655d 0a20 2020  plot, table].   
+00021f50: 2020 2020 2069 6620 7365 6c66 2e65 7874       if self.ext
+00021f60: 7261 5f6e 616d 6573 3a0a 2020 2020 2020  ra_names:.      
+00021f70: 2020 2020 2020 636f 6d70 6f6e 656e 7473        components
+00021f80: 2e61 7070 656e 6428 6578 7472 615f 7461  .append(extra_ta
+00021f90: 626c 6529 0a0a 2020 2020 2020 2020 7365  ble)..        se
+00021fa0: 6c66 2e72 6f6f 7420 3d20 636f 6c75 6d6e  lf.root = column
+00021fb0: 282a 636f 6d70 6f6e 656e 7473 2c20 2a2a  (*components, **
+00021fc0: 7369 7a69 6e67 5f6d 6f64 6529 0a0a 2020  sizing_mode)..  
+00021fd0: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00021fe0: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00021ff0: 2020 2064 6566 2075 7064 6174 6528 7365     def update(se
+00022000: 6c66 293a 0a20 2020 2020 2020 2064 6174  lf):.        dat
+00022010: 6120 3d20 7b6e 616d 653a 205b 5d20 666f  a = {name: [] fo
+00022020: 7220 6e61 6d65 2069 6e20 7365 6c66 2e6e  r name in self.n
+00022030: 616d 6573 202b 2073 656c 662e 6578 7472  ames + self.extr
+00022040: 615f 6e61 6d65 737d 0a20 2020 2020 2020  a_names}.       
+00022050: 2066 6f72 2069 2c20 7773 2069 6e20 656e   for i, ws in en
+00022060: 756d 6572 6174 6528 0a20 2020 2020 2020  umerate(.       
+00022070: 2020 2020 2073 6f72 7465 6428 7365 6c66       sorted(self
+00022080: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+00022090: 7273 2e76 616c 7565 7328 292c 206b 6579  rs.values(), key
+000220a0: 3d6c 616d 6264 6120 7773 3a20 7374 7228  =lambda ws: str(
+000220b0: 7773 2e6e 616d 6529 290a 2020 2020 2020  ws.name)).      
+000220c0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+000220d0: 206d 696e 666f 203d 2077 732e 6d65 6d6f   minfo = ws.memo
+000220e0: 7279 0a0a 2020 2020 2020 2020 2020 2020  ry..            
+000220f0: 666f 7220 6e61 6d65 2069 6e20 7365 6c66  for name in self
+00022100: 2e6e 616d 6573 202b 2073 656c 662e 6578  .names + self.ex
+00022110: 7472 615f 6e61 6d65 733a 0a20 2020 2020  tra_names:.     
+00022120: 2020 2020 2020 2020 2020 2069 6620 222e             if ".
+00022130: 2220 696e 206e 616d 653a 0a20 2020 2020  " in name:.     
+00022140: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00022150: 302c 205f 2c20 6e31 203d 206e 616d 652e  0, _, n1 = name.
+00022160: 7061 7274 6974 696f 6e28 222e 2229 0a20  partition("."). 
+00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022180: 2020 2076 203d 2077 732e 6d65 7472 6963     v = ws.metric
+00022190: 732e 6765 7428 6e30 2c20 7b7d 292e 6765  s.get(n0, {}).ge
+000221a0: 7428 6e31 2c20 4e6f 6e65 290a 2020 2020  t(n1, None).    
+000221b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000221c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000221d0: 2020 2020 2020 7620 3d20 7773 2e6d 6574        v = ws.met
+000221e0: 7269 6373 2e67 6574 286e 616d 652c 204e  rics.get(name, N
+000221f0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+00022200: 2020 2020 2064 6174 615b 6e61 6d65 5d2e       data[name].
+00022210: 6170 7065 6e64 2876 290a 0a20 2020 2020  append(v)..     
+00022220: 2020 2020 2020 2064 6174 615b 226e 616d         data["nam
+00022230: 6522 5d5b 2d31 5d20 3d20 7773 2e6e 616d  e"][-1] = ws.nam
+00022240: 6520 6966 2077 732e 6e61 6d65 2069 7320  e if ws.name is 
+00022250: 6e6f 7420 4e6f 6e65 2065 6c73 6520 690a  not None else i.
+00022260: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00022270: 5b22 6164 6472 6573 7322 5d5b 2d31 5d20  ["address"][-1] 
+00022280: 3d20 7773 2e61 6464 7265 7373 0a20 2020  = ws.address.   
+00022290: 2020 2020 2020 2020 2069 6620 7773 2e6d           if ws.m
+000222a0: 656d 6f72 795f 6c69 6d69 743a 0a20 2020  emory_limit:.   
+000222b0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000222c0: 615b 226d 656d 6f72 795f 7065 7263 656e  a["memory_percen
+000222d0: 7422 5d5b 2d31 5d20 3d20 7773 2e6d 6574  t"][-1] = ws.met
+000222e0: 7269 6373 5b22 6d65 6d6f 7279 225d 202f  rics["memory"] /
+000222f0: 2077 732e 6d65 6d6f 7279 5f6c 696d 6974   ws.memory_limit
+00022300: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00022310: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00022320: 2020 2064 6174 615b 226d 656d 6f72 795f     data["memory_
+00022330: 7065 7263 656e 7422 5d5b 2d31 5d20 3d20  percent"][-1] = 
+00022340: 2222 0a20 2020 2020 2020 2020 2020 2064  "".            d
+00022350: 6174 615b 226d 656d 6f72 795f 6c69 6d69  ata["memory_limi
+00022360: 7422 5d5b 2d31 5d20 3d20 7773 2e6d 656d  t"][-1] = ws.mem
+00022370: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
+00022380: 2020 2020 2020 6461 7461 5b22 6d65 6d6f        data["memo
+00022390: 7279 5f6d 616e 6167 6564 225d 5b2d 315d  ry_managed"][-1]
+000223a0: 203d 206d 696e 666f 2e6d 616e 6167 6564   = minfo.managed
+000223b0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+000223c0: 615b 226d 656d 6f72 795f 756e 6d61 6e61  a["memory_unmana
+000223d0: 6765 645f 6f6c 6422 5d5b 2d31 5d20 3d20  ged_old"][-1] = 
+000223e0: 6d69 6e66 6f2e 756e 6d61 6e61 6765 645f  minfo.unmanaged_
+000223f0: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
+00022400: 6461 7461 5b22 6d65 6d6f 7279 5f75 6e6d  data["memory_unm
+00022410: 616e 6167 6564 5f72 6563 656e 7422 5d5b  anaged_recent"][
+00022420: 2d31 5d20 3d20 6d69 6e66 6f2e 756e 6d61  -1] = minfo.unma
+00022430: 6e61 6765 645f 7265 6365 6e74 0a20 2020  naged_recent.   
+00022440: 2020 2020 2020 2020 2064 6174 615b 226d           data["m
+00022450: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00022460: 7265 6365 6e74 225d 5b2d 315d 203d 206d  recent"][-1] = m
+00022470: 696e 666f 2e75 6e6d 616e 6167 6564 5f72  info.unmanaged_r
+00022480: 6563 656e 740a 2020 2020 2020 2020 2020  ecent.          
+00022490: 2020 6461 7461 5b22 6d65 6d6f 7279 5f73    data["memory_s
+000224a0: 7069 6c6c 6564 225d 5b2d 315d 203d 206d  pilled"][-1] = m
+000224b0: 696e 666f 2e73 7069 6c6c 6564 0a20 2020  info.spilled.   
+000224c0: 2020 2020 2020 2020 2064 6174 615b 2263           data["c
+000224d0: 7075 225d 5b2d 315d 203d 2077 732e 6d65  pu"][-1] = ws.me
+000224e0: 7472 6963 735b 2263 7075 225d 202f 2031  trics["cpu"] / 1
+000224f0: 3030 2e30 0a20 2020 2020 2020 2020 2020  00.0.           
+00022500: 2064 6174 615b 2263 7075 5f66 7261 6374   data["cpu_fract
+00022510: 696f 6e22 5d5b 2d31 5d20 3d20 7773 2e6d  ion"][-1] = ws.m
+00022520: 6574 7269 6373 5b22 6370 7522 5d20 2f20  etrics["cpu"] / 
+00022530: 3130 302e 3020 2f20 7773 2e6e 7468 7265  100.0 / ws.nthre
+00022540: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+00022550: 6461 7461 5b22 6e74 6872 6561 6473 225d  data["nthreads"]
+00022560: 5b2d 315d 203d 2077 732e 6e74 6872 6561  [-1] = ws.nthrea
+00022570: 6473 0a0a 2020 2020 2020 2020 666f 7220  ds..        for 
+00022580: 6e61 6d65 2069 6e20 7365 6c66 2e6e 616d  name in self.nam
+00022590: 6573 202b 2073 656c 662e 6578 7472 615f  es + self.extra_
+000225a0: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
+000225b0: 2020 2069 6620 6e61 6d65 203d 3d20 226e     if name == "n
+000225c0: 616d 6522 3a0a 2020 2020 2020 2020 2020  ame":.          
+000225d0: 2020 2020 2020 6461 7461 5b6e 616d 655d        data[name]
+000225e0: 2e69 6e73 6572 7428 302c 2066 2254 6f74  .insert(0, f"Tot
+000225f0: 616c 2028 7b6c 656e 2864 6174 615b 6e61  al ({len(data[na
+00022600: 6d65 5d29 7d29 2229 0a20 2020 2020 2020  me])})").       
+00022610: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00022620: 650a 2020 2020 2020 2020 2020 2020 7472  e.            tr
+00022630: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00022640: 2020 2069 6620 6c65 6e28 7365 6c66 2e73     if len(self.s
+00022650: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+00022660: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00022670: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+00022680: 6c5f 6461 7461 203d 204e 6f6e 650a 2020  l_data = None.  
+00022690: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000226a0: 6966 206e 616d 6520 3d3d 2022 6d65 6d6f  if name == "memo
+000226b0: 7279 5f70 6572 6365 6e74 223a 0a20 2020  ry_percent":.   
+000226c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000226d0: 2074 6f74 616c 5f6d 656d 203d 2073 756d   total_mem = sum
+000226e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000226f0: 2020 2020 2020 2020 2020 7773 2e6d 656d            ws.mem
+00022700: 6f72 795f 6c69 6d69 7420 666f 7220 7773  ory_limit for ws
+00022710: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+00022720: 6572 2e77 6f72 6b65 7273 2e76 616c 7565  er.workers.value
+00022730: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00022740: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00022750: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00022760: 7461 6c5f 6461 7461 203d 2028 0a20 2020  tal_data = (.   
+00022770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022780: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+00022790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227a0: 2020 2073 756d 280a 2020 2020 2020 2020     sum(.        
+000227b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227c0: 2020 2020 2020 2020 7773 2e6d 6574 7269          ws.metri
+000227d0: 6373 5b22 6d65 6d6f 7279 225d 0a20 2020  cs["memory"].   
+000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00022800: 2077 7320 696e 2073 656c 662e 7363 6865   ws in self.sche
+00022810: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
+00022820: 6c75 6573 2829 0a20 2020 2020 2020 2020  lues().         
+00022830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022840: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00022850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022860: 202f 2074 6f74 616c 5f6d 656d 0a20 2020   / total_mem.   
+00022870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022880: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00022890: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000228a0: 6620 746f 7461 6c5f 6d65 6d0a 2020 2020  f total_mem.    
+000228b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228c0: 2020 2020 656c 7365 2022 220a 2020 2020      else "".    
+000228d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000228f0: 2020 656c 6966 206e 616d 6520 3d3d 2022    elif name == "
+00022900: 6370 7522 3a0a 2020 2020 2020 2020 2020  cpu":.          
+00022910: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
+00022920: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
+00022930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022940: 2073 756d 2877 732e 6d65 7472 6963 735b   sum(ws.metrics[
+00022950: 2263 7075 225d 2066 6f72 2077 7320 696e  "cpu"] for ws in
+00022960: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00022970: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00022980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00022990: 2020 2020 2020 2020 2020 2f20 3130 300a            / 100.
+000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229b0: 2020 2020 2020 2020 2f20 6c65 6e28 7365          / len(se
+000229c0: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
+000229d0: 6b65 7273 2e76 616c 7565 7328 2929 0a20  kers.values()). 
+000229e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00022a00: 2020 2020 2065 6c69 6620 6e61 6d65 203d       elif name =
+00022a10: 3d20 2263 7075 5f66 7261 6374 696f 6e22  = "cpu_fraction"
+00022a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00022a30: 2020 2020 2020 746f 7461 6c5f 6461 7461        total_data
+00022a40: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00022a50: 2020 2020 2020 2020 2020 2020 2073 756d               sum
+00022a60: 2877 732e 6d65 7472 6963 735b 2263 7075  (ws.metrics["cpu
+00022a70: 225d 2066 6f72 2077 7320 696e 2073 656c  "] for ws in sel
+00022a80: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+00022a90: 6572 732e 7661 6c75 6573 2829 290a 2020  ers.values()).  
+00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ab0: 2020 2020 2020 2f20 3130 300a 2020 2020        / 100.    
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ad0: 2020 2020 2f20 7375 6d28 7773 2e6e 7468      / sum(ws.nth
+00022ae0: 7265 6164 7320 666f 7220 7773 2069 6e20  reads for ws in 
+00022af0: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+00022b00: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
+00022b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00022b30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00022b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b50: 2074 6f74 616c 5f64 6174 6120 3d20 7375   total_data = su
+00022b60: 6d28 6461 7461 5b6e 616d 655d 290a 0a20  m(data[name]).. 
+00022b70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00022b80: 6174 615b 6e61 6d65 5d2e 696e 7365 7274  ata[name].insert
+00022b90: 2830 2c20 746f 7461 6c5f 6461 7461 290a  (0, total_data).
+00022ba0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00022bb0: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
+00022bc0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00022bd0: 7461 5b6e 616d 655d 2e69 6e73 6572 7428  ta[name].insert(
+00022be0: 302c 204e 6f6e 6529 0a0a 2020 2020 2020  0, None)..      
+00022bf0: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
+00022c00: 7461 2e75 7064 6174 6528 6461 7461 290a  ta.update(data).
+00022c10: 0a0a 636c 6173 7320 5368 7566 666c 696e  ..class Shufflin
+00022c20: 6728 4461 7368 626f 6172 6443 6f6d 706f  g(DashboardCompo
+00022c30: 6e65 6e74 293a 0a20 2020 2022 2222 4f63  nent):.    """Oc
+00022c40: 6375 7061 6e63 7920 2869 6e20 7469 6d65  cupancy (in time
+00022c50: 2920 7065 7220 776f 726b 6572 2222 220a  ) per worker""".
+00022c60: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00022c70: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+00022c80: 722c 202a 2a6b 7761 7267 7329 3a0a 2020  r, **kwargs):.  
+00022c90: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
+00022ca0: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
+00022cb0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00022cc0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+00022cd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00022ce0: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
+00022cf0: 4461 7461 536f 7572 6365 280a 2020 2020  DataSource(.    
+00022d00: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00022d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d20: 2020 2277 6f72 6b65 7222 3a20 5b5d 2c0a    "worker": [],.
+00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d40: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
+00022d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d60: 2022 636f 6d6d 5f6d 656d 6f72 7922 3a20   "comm_memory": 
+00022d70: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00022d80: 2020 2020 2020 2020 2263 6f6d 6d5f 6d65          "comm_me
+00022d90: 6d6f 7279 5f6c 696d 6974 223a 205b 5d2c  mory_limit": [],
+00022da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022db0: 2020 2020 2022 636f 6d6d 5f62 7563 6b65       "comm_bucke
+00022dc0: 7473 223a 205b 5d2c 0a20 2020 2020 2020  ts": [],.       
+00022dd0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00022de0: 6d6d 5f61 7667 5f64 7572 6174 696f 6e22  mm_avg_duration"
+00022df0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00022e00: 2020 2020 2020 2020 2020 2263 6f6d 6d5f            "comm_
+00022e10: 6176 675f 7369 7a65 223a 205b 5d2c 0a20  avg_size": [],. 
+00022e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e30: 2020 2022 636f 6d6d 5f72 6561 6422 3a20     "comm_read": 
+00022e40: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00022e50: 2020 2020 2020 2020 2263 6f6d 6d5f 7772          "comm_wr
+00022e60: 6974 7465 6e22 3a20 5b5d 2c0a 2020 2020  itten": [],.    
+00022e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e80: 2263 6f6d 6d5f 636f 6c6f 7222 3a20 5b5d  "comm_color": []
+00022e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022ea0: 2020 2020 2020 2264 6973 6b5f 6d65 6d6f        "disk_memo
+00022eb0: 7279 223a 205b 5d2c 0a20 2020 2020 2020  ry": [],.       
+00022ec0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+00022ed0: 736b 5f6d 656d 6f72 795f 6c69 6d69 7422  sk_memory_limit"
+00022ee0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00022ef0: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
+00022f00: 6275 636b 6574 7322 3a20 5b5d 2c0a 2020  buckets": [],.  
+00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f20: 2020 2264 6973 6b5f 6176 675f 6475 7261    "disk_avg_dura
+00022f30: 7469 6f6e 223a 205b 5d2c 0a20 2020 2020  tion": [],.     
+00022f40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00022f50: 6469 736b 5f61 7667 5f73 697a 6522 3a20  disk_avg_size": 
+00022f60: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00022f70: 2020 2020 2020 2020 2264 6973 6b5f 7265          "disk_re
+00022f80: 6164 223a 205b 5d2c 0a20 2020 2020 2020  ad": [],.       
+00022f90: 2020 2020 2020 2020 2020 2020 2022 6469               "di
+00022fa0: 736b 5f77 7269 7474 656e 223a 205b 5d2c  sk_written": [],
+00022fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022fc0: 2020 2020 2022 6469 736b 5f63 6f6c 6f72       "disk_color
+00022fd0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00022fe0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00022ff0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00023000: 2020 2073 656c 662e 746f 7461 6c73 5f73     self.totals_s
+00023010: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00023020: 7461 536f 7572 6365 280a 2020 2020 2020  taSource(.      
+00023030: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00023040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023050: 2278 223a 205b 224e 6574 776f 726b 2053  "x": ["Network S
+00023060: 656e 6422 2c20 224e 6574 776f 726b 2052  end", "Network R
+00023070: 6563 6569 7665 222c 2022 4469 736b 2057  eceive", "Disk W
+00023080: 7269 7465 222c 2022 4469 736b 2052 6561  rite", "Disk Rea
+00023090: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
+000230a0: 2020 2020 2020 2020 2022 7661 6c75 6573           "values
+000230b0: 223a 205b 302c 2030 2c20 302c 2030 5d2c  ": [0, 0, 0, 0],
+000230c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000230d0: 207d 0a20 2020 2020 2020 2020 2020 2029   }.            )
+000230e0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000230f0: 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279 203d  lf.comm_memory =
+00023100: 2066 6967 7572 6528 0a20 2020 2020 2020   figure(.       
+00023110: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
+00023120: 436f 6d6d 7320 4275 6666 6572 222c 0a20  Comms Buffer",. 
+00023130: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00023140: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
+00023150: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
+00023160: 5f6c 6f63 6174 696f 6e3d 2261 626f 7665  _location="above
+00023170: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00023180: 2020 2078 5f72 616e 6765 3d52 616e 6765     x_range=Range
+00023190: 3164 2830 2c20 3130 305f 3030 305f 3030  1d(0, 100_000_00
+000231a0: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+000231b0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+000231c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000231d0: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
+000231e0: 6d5f 6d65 6d6f 7279 2e68 6261 7228 0a20  m_memory.hbar(. 
+000231f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00023200: 6f75 7263 653d 7365 6c66 2e73 6f75 7263  ource=self.sourc
+00023210: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00023220: 2020 2072 6967 6874 3d22 636f 6d6d 5f6d     right="comm_m
+00023230: 656d 6f72 7922 2c0a 2020 2020 2020 2020  emory",.        
+00023240: 2020 2020 2020 2020 793d 2279 222c 0a20          y="y",. 
+00023250: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00023260: 6569 6768 743d 302e 392c 0a20 2020 2020  eight=0.9,.     
+00023270: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00023280: 3d22 636f 6d6d 5f63 6f6c 6f72 222c 0a20  ="comm_color",. 
+00023290: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000232a0: 2020 2020 2020 2020 2068 6f76 6572 203d           hover =
+000232b0: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
+000232c0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+000232d0: 7469 7073 3d5b 0a20 2020 2020 2020 2020  tips=[.         
+000232e0: 2020 2020 2020 2020 2020 2028 224d 656d             ("Mem
+000232f0: 6f72 7920 5573 6564 222c 2022 4063 6f6d  ory Used", "@com
+00023300: 6d5f 6d65 6d6f 7279 7b30 2e30 3020 627d  m_memory{0.00 b}
+00023310: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00023320: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
+00023330: 6520 5772 6974 6522 2c20 2240 636f 6d6d  e Write", "@comm
+00023340: 5f61 7667 5f73 697a 657b 302e 3030 2062  _avg_size{0.00 b
+00023350: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
+00023360: 2020 2020 2020 2020 2028 2223 2042 7563           ("# Buc
+00023370: 6b65 7473 222c 2022 4063 6f6d 6d5f 6275  kets", "@comm_bu
+00023380: 636b 6574 7322 292c 0a20 2020 2020 2020  ckets"),.       
+00023390: 2020 2020 2020 2020 2020 2020 2028 2241               ("A
+000233a0: 7665 7261 6765 2044 7572 6174 696f 6e22  verage Duration"
+000233b0: 2c20 2240 636f 6d6d 5f61 7667 5f64 7572  , "@comm_avg_dur
+000233c0: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
+000233d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000233e0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+000233f0: 6174 7465 7273 3d7b 2240 636f 6d6d 5f61  atters={"@comm_a
+00023400: 7667 5f64 7572 6174 696f 6e22 3a20 2264  vg_duration": "d
+00023410: 6174 6574 696d 6522 7d2c 0a20 2020 2020  atetime"},.     
+00023420: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+00023430: 2268 6c69 6e65 222c 0a20 2020 2020 2020  "hline",.       
+00023440: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00023450: 2020 2073 656c 662e 636f 6d6d 5f6d 656d     self.comm_mem
+00023460: 6f72 792e 6164 645f 746f 6f6c 7328 686f  ory.add_tools(ho
+00023470: 7665 7229 0a20 2020 2020 2020 2020 2020  ver).           
+00023480: 2073 656c 662e 636f 6d6d 5f6d 656d 6f72   self.comm_memor
+00023490: 792e 785f 7261 6e67 652e 7374 6172 7420  y.x_range.start 
+000234a0: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+000234b0: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
+000234c0: 2e78 5f72 616e 6765 2e65 6e64 203d 2031  .x_range.end = 1
+000234d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000234e0: 662e 636f 6d6d 5f6d 656d 6f72 792e 7861  f.comm_memory.xa
+000234f0: 7869 735b 305d 2e66 6f72 6d61 7474 6572  xis[0].formatter
+00023500: 203d 204e 756d 6572 616c 5469 636b 466f   = NumeralTickFo
+00023510: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+00023520: 302e 3020 6222 290a 0a20 2020 2020 2020  0.0 b")..       
+00023530: 2020 2020 2073 656c 662e 6469 736b 5f6d       self.disk_m
+00023540: 656d 6f72 7920 3d20 6669 6775 7265 280a  emory = figure(.
+00023550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023560: 7469 746c 653d 2244 6973 6b20 4275 6666  title="Disk Buff
+00023570: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+00023580: 2020 2020 2074 6f6f 6c73 3d22 222c 0a20       tools="",. 
+00023590: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000235a0: 6f6f 6c62 6172 5f6c 6f63 6174 696f 6e3d  oolbar_location=
+000235b0: 2261 626f 7665 222c 0a20 2020 2020 2020  "above",.       
+000235c0: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+000235d0: 3d52 616e 6765 3164 2830 2c20 3130 305f  =Range1d(0, 100_
+000235e0: 3030 305f 3030 3029 2c0a 2020 2020 2020  000_000),.      
+000235f0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00023600: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00023610: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00023620: 6c66 2e64 6973 6b5f 6d65 6d6f 7279 2e79  lf.disk_memory.y
+00023630: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
+00023640: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
+00023650: 2020 7365 6c66 2e64 6973 6b5f 6d65 6d6f    self.disk_memo
+00023660: 7279 2e68 6261 7228 0a20 2020 2020 2020  ry.hbar(.       
+00023670: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+00023680: 7365 6c66 2e73 6f75 7263 652c 0a20 2020  self.source,.   
+00023690: 2020 2020 2020 2020 2020 2020 2072 6967               rig
+000236a0: 6874 3d22 6469 736b 5f6d 656d 6f72 7922  ht="disk_memory"
+000236b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000236c0: 2020 793d 2279 222c 0a20 2020 2020 2020    y="y",.       
+000236d0: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+000236e0: 302e 392c 0a20 2020 2020 2020 2020 2020  0.9,.           
+000236f0: 2020 2020 2063 6f6c 6f72 3d22 6469 736b       color="disk
+00023700: 5f63 6f6c 6f72 222c 0a20 2020 2020 2020  _color",.       
+00023710: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00023720: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+00023730: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
+00023740: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
+00023750: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00023760: 2020 2020 2020 2822 4d65 6d6f 7279 2055        ("Memory U
+00023770: 7365 6422 2c20 2240 6469 736b 5f6d 656d  sed", "@disk_mem
+00023780: 6f72 797b 302e 3030 2062 7d22 292c 0a20  ory{0.00 b}"),. 
+00023790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237a0: 2020 2028 2241 7665 7261 6765 2057 7269     ("Average Wri
+000237b0: 7465 222c 2022 4064 6973 6b5f 6176 675f  te", "@disk_avg_
+000237c0: 7369 7a65 7b30 2e30 3020 627d 2229 2c0a  size{0.00 b}"),.
+000237d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237e0: 2020 2020 2822 2320 4275 636b 6574 7322      ("# Buckets"
+000237f0: 2c20 2240 6469 736b 5f62 7563 6b65 7473  , "@disk_buckets
+00023800: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00023810: 2020 2020 2020 2020 2822 4176 6572 6167          ("Averag
+00023820: 6520 4475 7261 7469 6f6e 222c 2022 4064  e Duration", "@d
+00023830: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
+00023840: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00023850: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00023860: 2020 2020 2020 2066 6f72 6d61 7474 6572         formatter
+00023870: 733d 7b22 4064 6973 6b5f 6176 675f 6475  s={"@disk_avg_du
+00023880: 7261 7469 6f6e 223a 2022 6461 7465 7469  ration": "dateti
+00023890: 6d65 227d 2c0a 2020 2020 2020 2020 2020  me"},.          
+000238a0: 2020 2020 2020 6d6f 6465 3d22 686c 696e        mode="hlin
+000238b0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000238c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000238d0: 6c66 2e64 6973 6b5f 6d65 6d6f 7279 2e61  lf.disk_memory.a
+000238e0: 6464 5f74 6f6f 6c73 2868 6f76 6572 290a  dd_tools(hover).
+000238f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00023900: 2e64 6973 6b5f 6d65 6d6f 7279 2e78 6178  .disk_memory.xax
+00023910: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
+00023920: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
+00023930: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+00023940: 2e30 2062 2229 0a0a 2020 2020 2020 2020  .0 b")..        
+00023950: 2020 2020 7365 6c66 2e74 6f74 616c 7320      self.totals 
+00023960: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00023970: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+00023980: 2254 6f74 616c 206d 6f76 656d 656e 7422  "Total movement"
+00023990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000239a0: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+000239b0: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
+000239c0: 6261 725f 6c6f 6361 7469 6f6e 3d22 6162  bar_location="ab
+000239d0: 6f76 6522 2c0a 2020 2020 2020 2020 2020  ove",.          
+000239e0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+000239f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00023a00: 2020 2020 2020 2020 2020 7469 746c 6573            titles
+00023a10: 203d 205b 224e 6574 776f 726b 2053 656e   = ["Network Sen
+00023a20: 6422 2c20 224e 6574 776f 726b 2052 6563  d", "Network Rec
+00023a30: 6569 7665 222c 2022 4469 736b 2057 7269  eive", "Disk Wri
+00023a40: 7465 222c 2022 4469 736b 2052 6561 6422  te", "Disk Read"
+00023a50: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
+00023a60: 6c66 2e74 6f74 616c 7320 3d20 6669 6775  lf.totals = figu
+00023a70: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00023a80: 2020 2020 785f 7261 6e67 653d 7469 746c      x_range=titl
+00023a90: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00023aa0: 2020 2020 7469 746c 653d 2254 6f74 616c      title="Total
+00023ab0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00023ac0: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
+00023ad0: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
+00023ae0: 2020 2020 2020 2020 2020 2074 6f6f 6c73             tools
+00023af0: 3d22 222c 0a20 2020 2020 2020 2020 2020  ="",.           
+00023b00: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00023b10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00023b20: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00023b30: 6f74 616c 732e 7662 6172 280a 2020 2020  otals.vbar(.    
+00023b40: 2020 2020 2020 2020 2020 2020 783d 2278              x="x
+00023b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00023b60: 2020 2074 6f70 3d22 7661 6c75 6573 222c     top="values",
+00023b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023b80: 2077 6964 7468 3d30 2e39 2c0a 2020 2020   width=0.9,.    
+00023b90: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00023ba0: 6365 3d73 656c 662e 746f 7461 6c73 5f73  ce=self.totals_s
+00023bb0: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+00023bc0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00023bd0: 2020 7365 6c66 2e74 6f74 616c 732e 7867    self.totals.xg
+00023be0: 7269 642e 6772 6964 5f6c 696e 655f 636f  rid.grid_line_co
+00023bf0: 6c6f 7220 3d20 4e6f 6e65 0a20 2020 2020  lor = None.     
+00023c00: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
+00023c10: 6c73 2e79 5f72 616e 6765 2e73 7461 7274  ls.y_range.start
+00023c20: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00023c30: 2073 656c 662e 746f 7461 6c73 2e79 6178   self.totals.yax
+00023c40: 6973 5b30 5d2e 666f 726d 6174 7465 7220  is[0].formatter 
+00023c50: 3d20 4e75 6d65 7261 6c54 6963 6b46 6f72  = NumeralTickFor
+00023c60: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+00023c70: 2e30 2062 2229 0a0a 2020 2020 2020 2020  .0 b")..        
+00023c80: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+00023c90: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
+00023ca0: 2020 2020 2020 2074 6f6f 6c74 6970 733d         tooltips=
+00023cb0: 5b28 2254 6f74 616c 222c 2022 4076 616c  [("Total", "@val
+00023cc0: 7565 737b 302e 3030 627d 2229 5d2c 0a20  ues{0.00b}")],. 
+00023cd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00023ce0: 6f64 653d 2276 6c69 6e65 222c 0a20 2020  ode="vline",.   
+00023cf0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00023d00: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
+00023d10: 6c73 2e61 6464 5f74 6f6f 6c73 2868 6f76  ls.add_tools(hov
+00023d20: 6572 290a 0a20 2020 2020 2020 2020 2020  er)..           
+00023d30: 2073 656c 662e 726f 6f74 203d 2072 6f77   self.root = row
+00023d40: 2873 656c 662e 636f 6d6d 5f6d 656d 6f72  (self.comm_memor
+00023d50: 792c 2073 656c 662e 6469 736b 5f6d 656d  y, self.disk_mem
+00023d60: 6f72 7929 0a0a 2020 2020 4077 6974 686f  ory)..    @witho
+00023d70: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00023d80: 6461 7469 6f6e 0a20 2020 2064 6566 2075  dation.    def u
+00023d90: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
+00023da0: 2020 2020 2077 6974 6820 6c6f 675f 6572       with log_er
+00023db0: 726f 7273 2829 3a0a 2020 2020 2020 2020  rors():.        
+00023dc0: 2020 2020 696e 7075 7420 3d20 7365 6c66      input = self
+00023dd0: 2e73 6368 6564 756c 6572 2e65 7874 656e  .scheduler.exten
+00023de0: 7369 6f6e 735b 2273 6875 6666 6c65 225d  sions["shuffle"]
+00023df0: 2e68 6561 7274 6265 6174 730a 2020 2020  .heartbeats.    
+00023e00: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00023e10: 6e70 7574 3a0a 2020 2020 2020 2020 2020  nput:.          
+00023e20: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00023e30: 2020 2020 2020 2020 2020 696e 7075 7420            input 
+00023e40: 3d20 6c69 7374 2869 6e70 7574 2e76 616c  = list(input.val
+00023e50: 7565 7328 2929 5b2d 315d 2020 2320 544f  ues())[-1]  # TO
+00023e60: 444f 3a20 6d75 6c74 6970 6c65 2063 6f6e  DO: multiple con
+00023e70: 6375 7272 656e 7420 7368 7566 666c 6573  current shuffles
+00023e80: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+00023e90: 7461 203d 2064 6566 6175 6c74 6469 6374  ta = defaultdict
+00023ea0: 286c 6973 7429 0a20 2020 2020 2020 2020  (list).         
+00023eb0: 2020 206e 6f77 203d 2074 696d 6528 290a     now = time().
+00023ec0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00023ed0: 2069 2c20 2877 6f72 6b65 722c 2064 2920   i, (worker, d) 
+00023ee0: 696e 2065 6e75 6d65 7261 7465 2869 6e70  in enumerate(inp
+00023ef0: 7574 2e69 7465 6d73 2829 293a 0a20 2020  ut.items()):.   
+00023f00: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00023f10: 615b 2279 225d 2e61 7070 656e 6428 6929  a["y"].append(i)
+00023f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023f30: 2064 6174 615b 2277 6f72 6b65 7222 5d2e   data["worker"].
+00023f40: 6170 7065 6e64 2877 6f72 6b65 7229 0a20  append(worker). 
+00023f50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00023f60: 6f72 2070 7265 6669 7820 696e 205b 2263  or prefix in ["c
+00023f70: 6f6d 6d22 2c20 2264 6973 6b22 5d3a 0a20  omm", "disk"]:. 
+00023f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f90: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
+00023fa0: 787d 5f74 6f74 616c 225d 2e61 7070 656e  x}_total"].appen
+00023fb0: 6428 645b 7072 6566 6978 5d5b 2274 6f74  d(d[prefix]["tot
+00023fc0: 616c 225d 290a 2020 2020 2020 2020 2020  al"]).          
+00023fd0: 2020 2020 2020 2020 2020 6461 7461 5b66            data[f
+00023fe0: 227b 7072 6566 6978 7d5f 6d65 6d6f 7279  "{prefix}_memory
+00023ff0: 225d 2e61 7070 656e 6428 645b 7072 6566  "].append(d[pref
+00024000: 6978 5d5b 226d 656d 6f72 7922 5d29 0a20  ix]["memory"]). 
+00024010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024020: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
+00024030: 787d 5f6d 656d 6f72 795f 6c69 6d69 7422  x}_memory_limit"
+00024040: 5d2e 6170 7065 6e64 2864 5b70 7265 6669  ].append(d[prefi
+00024050: 785d 5b22 6d65 6d6f 7279 5f6c 696d 6974  x]["memory_limit
+00024060: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00024070: 2020 2020 2020 2020 6461 7461 5b66 227b          data[f"{
+00024080: 7072 6566 6978 7d5f 6275 636b 6574 7322  prefix}_buckets"
+00024090: 5d2e 6170 7065 6e64 2864 5b70 7265 6669  ].append(d[prefi
+000240a0: 785d 5b22 6275 636b 6574 7322 5d29 0a20  x]["buckets"]). 
+000240b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000240c0: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
+000240d0: 787d 5f61 7667 5f64 7572 6174 696f 6e22  x}_avg_duration"
+000240e0: 5d2e 6170 7065 6e64 280a 2020 2020 2020  ].append(.      
+000240f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024100: 2020 645b 7072 6566 6978 5d5b 2264 6961    d[prefix]["dia
+00024110: 676e 6f73 7469 6373 225d 2e67 6574 2822  gnostics"].get("
+00024120: 6176 675f 6475 7261 7469 6f6e 222c 2030  avg_duration", 0
+00024130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00024140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00024150: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00024160: 5b66 227b 7072 6566 6978 7d5f 6176 675f  [f"{prefix}_avg_
+00024170: 7369 7a65 225d 2e61 7070 656e 6428 0a20  size"].append(. 
+00024180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024190: 2020 2020 2020 2064 5b70 7265 6669 785d         d[prefix]
+000241a0: 5b22 6469 6167 6e6f 7374 6963 7322 5d2e  ["diagnostics"].
+000241b0: 6765 7428 2261 7667 5f73 697a 6522 2c20  get("avg_size", 
+000241c0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+000241d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000241e0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000241f0: 615b 6622 7b70 7265 6669 787d 5f72 6561  a[f"{prefix}_rea
+00024200: 6422 5d2e 6170 7065 6e64 2864 5b70 7265  d"].append(d[pre
+00024210: 6669 785d 5b22 7265 6164 225d 290a 2020  fix]["read"]).  
+00024220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024230: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
+00024240: 7d5f 7772 6974 7465 6e22 5d2e 6170 7065  }_written"].appe
+00024250: 6e64 2864 5b70 7265 6669 785d 5b22 7772  nd(d[prefix]["wr
+00024260: 6974 7465 6e22 5d29 0a20 2020 2020 2020  itten"]).       
+00024270: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00024280: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+00024290: 6f72 6b65 7273 5b77 6f72 6b65 725d 2e6c  orkers[worker].l
+000242a0: 6173 745f 7365 656e 203c 206e 6f77 202d  ast_seen < now -
+000242b0: 2035 3a0a 2020 2020 2020 2020 2020 2020   5:.            
+000242c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000242d0: 5b66 227b 7072 6566 6978 7d5f 636f 6c6f  [f"{prefix}_colo
+000242e0: 7222 5d2e 6170 7065 6e64 2822 6772 6179  r"].append("gray
+000242f0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00024300: 2020 2020 2020 2065 6c69 6620 645b 7072         elif d[pr
+00024310: 6566 6978 5d5b 226d 656d 6f72 7922 5d20  efix]["memory"] 
+00024320: 3e20 645b 7072 6566 6978 5d5b 226d 656d  > d[prefix]["mem
+00024330: 6f72 795f 6c69 6d69 7422 5d3a 0a20 2020  ory_limit"]:.   
+00024340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024350: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00024360: 6669 787d 5f63 6f6c 6f72 225d 2e61 7070  fix}_color"].app
+00024370: 656e 6428 2272 6564 2229 0a20 2020 2020  end("red").     
+00024380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00024390: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000243a0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+000243b0: 615b 6622 7b70 7265 6669 787d 5f63 6f6c  a[f"{prefix}_col
+000243c0: 6f72 225d 2e61 7070 656e 6428 2262 6c75  or"].append("blu
+000243d0: 6522 290a 0a20 2020 2020 2020 2020 2020  e")..           
+000243e0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+000243f0: 2073 696e 676c 6574 6f6e 7320 3d20 7b0a   singletons = {.
+00024400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024410: 6622 7b70 7265 6669 787d 5f61 7667 5f64  f"{prefix}_avg_d
+00024420: 7572 6174 696f 6e22 3a20 5b0a 2020 2020  uration": [.    
+00024430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024440: 7375 6d28 6461 7461 5b66 227b 7072 6566  sum(data[f"{pref
+00024450: 6978 7d5f 6176 675f 6475 7261 7469 6f6e  ix}_avg_duration
+00024460: 225d 2920 2f20 6c65 6e28 6461 7461 5b66  "]) / len(data[f
+00024470: 227b 7072 6566 6978 7d5f 6176 675f 6475  "{prefix}_avg_du
+00024480: 7261 7469 6f6e 225d 290a 2020 2020 2020  ration"]).      
+00024490: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+000244a0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+000244b0: 7072 6566 6978 7d5f 6176 675f 7369 7a65  prefix}_avg_size
+000244c0: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
+000244d0: 2020 2020 2020 2020 2073 756d 2864 6174           sum(dat
+000244e0: 615b 6622 7b70 7265 6669 787d 5f61 7667  a[f"{prefix}_avg
+000244f0: 5f73 697a 6522 5d29 202f 206c 656e 2864  _size"]) / len(d
+00024500: 6174 615b 6622 7b70 7265 6669 787d 5f61  ata[f"{prefix}_a
+00024510: 7667 5f73 697a 6522 5d29 0a20 2020 2020  vg_size"]).     
+00024520: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00024530: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00024540: 6973 6b5f 6176 675f 6475 7261 7469 6f6e  isk_avg_duration
+00024550: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
+00024560: 2020 2020 2020 2020 2073 756d 2864 6174           sum(dat
+00024570: 615b 2264 6973 6b5f 6176 675f 6475 7261  a["disk_avg_dura
+00024580: 7469 6f6e 225d 2920 2f20 6c65 6e28 6461  tion"]) / len(da
+00024590: 7461 5b22 6469 736b 5f61 7667 5f64 7572  ta["disk_avg_dur
+000245a0: 6174 696f 6e22 5d29 0a20 2020 2020 2020  ation"]).       
+000245b0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000245c0: 2020 2020 2020 2020 2020 2020 2264 6973              "dis
+000245d0: 6b5f 6176 675f 7369 7a65 223a 205b 0a20  k_avg_size": [. 
+000245e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245f0: 2020 2073 756d 2864 6174 615b 2264 6973     sum(data["dis
+00024600: 6b5f 6176 675f 7369 7a65 225d 2920 2f20  k_avg_size"]) / 
+00024610: 6c65 6e28 6461 7461 5b22 6469 736b 5f61  len(data["disk_a
+00024620: 7667 5f73 697a 6522 5d29 0a20 2020 2020  vg_size"]).     
+00024630: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+00024640: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00024650: 2020 2020 2020 2020 7369 6e67 6c65 746f          singleto
+00024660: 6e73 5b66 227b 7072 6566 6978 7d5f 6176  ns[f"{prefix}_av
+00024670: 675f 6261 6e64 7769 6474 6822 5d20 3d20  g_bandwidth"] = 
+00024680: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00024690: 2020 7369 6e67 6c65 746f 6e73 5b66 227b    singletons[f"{
+000246a0: 7072 6566 6978 7d5f 6176 675f 7369 7a65  prefix}_avg_size
+000246b0: 225d 5b30 5d20 2f20 7369 6e67 6c65 746f  "][0] / singleto
+000246c0: 6e73 5b66 227b 7072 6566 6978 7d5f 6176  ns[f"{prefix}_av
+000246d0: 675f 6475 7261 7469 6f6e 225d 5b30 5d0a  g_duration"][0].
+000246e0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+000246f0: 2020 2020 2020 2020 2020 7369 6e67 6c65            single
+00024700: 746f 6e73 5b22 6469 736b 5f61 7667 5f62  tons["disk_avg_b
+00024710: 616e 6477 6964 7468 225d 203d 205b 0a20  andwidth"] = [. 
+00024720: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024730: 696e 676c 6574 6f6e 735b 2264 6973 6b5f  ingletons["disk_
+00024740: 6176 675f 7369 7a65 225d 5b30 5d20 2f20  avg_size"][0] / 
+00024750: 7369 6e67 6c65 746f 6e73 5b22 6469 736b  singletons["disk
+00024760: 5f61 7667 5f64 7572 6174 696f 6e22 5d5b  _avg_duration"][
+00024770: 305d 0a20 2020 2020 2020 2020 2020 205d  0].            ]
+00024780: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
+00024790: 676c 6574 6f6e 735b 2279 225d 203d 205b  gletons["y"] = [
+000247a0: 6461 7461 5b22 7922 5d5b 2d31 5d20 2f20  data["y"][-1] / 
+000247b0: 325d 0a20 2020 2020 2020 2020 2020 2022  2].            "
+000247c0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+000247d0: 746f 7461 6c73 203d 207b 0a20 2020 2020  totals = {.     
+000247e0: 2020 2020 2020 2020 2020 2022 7822 3a20             "x": 
+000247f0: 5b22 4e65 7477 6f72 6b20 5365 6e64 222c  ["Network Send",
+00024800: 2022 4e65 7477 6f72 6b20 5265 6365 6976   "Network Receiv
+00024810: 6522 2c20 2244 6973 6b20 5772 6974 6522  e", "Disk Write"
+00024820: 2c20 2244 6973 6b20 5265 6164 225d 2c0a  , "Disk Read"],.
+00024830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024840: 2276 616c 7565 7322 3a20 5b0a 2020 2020  "values": [.    
+00024850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024860: 7375 6d28 6461 7461 5b22 636f 6d6d 5f77  sum(data["comm_w
+00024870: 7269 7474 656e 225d 292c 0a20 2020 2020  ritten"]),.     
+00024880: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024890: 756d 2864 6174 615b 2263 6f6d 6d5f 7265  um(data["comm_re
+000248a0: 6164 225d 292c 0a20 2020 2020 2020 2020  ad"]),.         
+000248b0: 2020 2020 2020 2020 2020 2073 756d 2864             sum(d
+000248c0: 6174 615b 2264 6973 6b5f 7772 6974 7465  ata["disk_writte
+000248d0: 6e22 5d29 2c0a 2020 2020 2020 2020 2020  n"]),.          
+000248e0: 2020 2020 2020 2020 2020 7375 6d28 6461            sum(da
+000248f0: 7461 5b22 6469 736b 5f72 6561 6422 5d29  ta["disk_read"])
+00024900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024910: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00024920: 207d 0a20 2020 2020 2020 2020 2020 2075   }.            u
+00024930: 7064 6174 6528 7365 6c66 2e74 6f74 616c  pdate(self.total
+00024940: 735f 736f 7572 6365 2c20 746f 7461 6c73  s_source, totals
+00024950: 290a 0a20 2020 2020 2020 2020 2020 2075  )..            u
+00024960: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+00024970: 652c 2064 6963 7428 6461 7461 2929 0a20  e, dict(data)). 
+00024980: 2020 2020 2020 2020 2020 206c 696d 6974             limit
+00024990: 203d 206d 6178 2864 6174 615b 2263 6f6d   = max(data["com
+000249a0: 6d5f 6d65 6d6f 7279 5f6c 696d 6974 225d  m_memory_limit"]
+000249b0: 202b 2064 6174 615b 2264 6973 6b5f 6d65   + data["disk_me
+000249c0: 6d6f 7279 5f6c 696d 6974 225d 2920 2a20  mory_limit"]) * 
+000249d0: 312e 320a 2020 2020 2020 2020 2020 2020  1.2.            
+000249e0: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
+000249f0: 2e78 5f72 616e 6765 2e65 6e64 203d 206c  .x_range.end = l
+00024a00: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
+00024a10: 2073 656c 662e 6469 736b 5f6d 656d 6f72   self.disk_memor
+00024a20: 792e 785f 7261 6e67 652e 656e 6420 3d20  y.x_range.end = 
+00024a30: 6c69 6d69 740a 0a0a 5f53 5459 4c45 5320  limit..._STYLES 
+00024a40: 3d20 7b0a 2020 2020 2277 6964 7468 223a  = {.    "width":
+00024a50: 2022 3130 3025 222c 0a20 2020 2022 6865   "100%",.    "he
+00024a60: 6967 6874 223a 2022 3130 3025 222c 0a20  ight": "100%",. 
+00024a70: 2020 2022 6d61 782d 7769 6474 6822 3a20     "max-width": 
+00024a80: 2231 3932 3070 7822 2c0a 2020 2020 226d  "1920px",.    "m
+00024a90: 6178 2d68 6569 6768 7422 3a20 2231 3038  ax-height": "108
+00024aa0: 3070 7822 2c0a 2020 2020 2270 6164 6469  0px",.    "paddi
+00024ab0: 6e67 223a 2022 3132 7078 222c 0a20 2020  ng": "12px",.   
+00024ac0: 2022 626f 7264 6572 223a 2022 3170 7820   "border": "1px 
+00024ad0: 736f 6c69 6420 6c69 6768 7467 7261 7922  solid lightgray"
+00024ae0: 2c0a 2020 2020 2262 6f78 2d73 6861 646f  ,.    "box-shado
+00024af0: 7722 3a20 2269 6e73 6574 2031 7078 2030  w": "inset 1px 0
+00024b00: 2038 7078 2030 206c 6967 6874 6772 6179   8px 0 lightgray
+00024b10: 222c 0a20 2020 2022 6f76 6572 666c 6f77  ",.    "overflow
+00024b20: 223a 2022 6175 746f 222c 0a7d 0a69 6620  ": "auto",.}.if 
+00024b30: 424f 4b45 485f 5645 5253 494f 4e2e 6d61  BOKEH_VERSION.ma
+00024b40: 6a6f 7220 3c20 333a 0a20 2020 205f 424f  jor < 3:.    _BO
+00024b50: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
+00024b60: 5320 3d20 7b22 7374 796c 6522 3a20 5f53  S = {"style": _S
+00024b70: 5459 4c45 537d 0a65 6c73 653a 0a20 2020  TYLES}.else:.   
+00024b80: 205f 424f 4b45 485f 5354 594c 4553 5f4b   _BOKEH_STYLES_K
+00024b90: 5741 5247 5320 3d20 7b22 7374 796c 6573  WARGS = {"styles
+00024ba0: 223a 205f 5354 594c 4553 7d0a 0a0a 636c  ": _STYLES}...cl
+00024bb0: 6173 7320 5363 6865 6475 6c65 724c 6f67  ass SchedulerLog
+00024bc0: 733a 0a20 2020 2064 6566 205f 5f69 6e69  s:.    def __ini
+00024bd0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+00024be0: 6c65 722c 2073 7461 7274 3d4e 6f6e 6529  ler, start=None)
+00024bf0: 3a0a 2020 2020 2020 2020 6c6f 6773 203d  :.        logs =
+00024c00: 2073 6368 6564 756c 6572 2e67 6574 5f6c   scheduler.get_l
+00024c10: 6f67 7328 7374 6172 743d 7374 6172 742c  ogs(start=start,
+00024c20: 2074 696d 6573 7461 6d70 733d 5472 7565   timestamps=True
+00024c30: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00024c40: 7420 6c6f 6773 3a0a 2020 2020 2020 2020  t logs:.        
+00024c50: 2020 2020 6c6f 6773 5f68 746d 6c20 3d20      logs_html = 
+00024c60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00024c70: 2020 273c 7020 7374 796c 653d 2266 6f6e    '<p style="fon
+00024c80: 742d 6661 6d69 6c79 3a20 6d6f 6e6f 7370  t-family: monosp
+00024c90: 6163 653b 206d 6172 6769 6e3a 2030 3b22  ace; margin: 0;"
+00024ca0: 3e4e 6f20 6c6f 6773 2074 6f20 7265 706f  >No logs to repo
+00024cb0: 7274 3c2f 703e 270a 2020 2020 2020 2020  rt</p>'.        
+00024cc0: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00024cd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00024ce0: 6c6f 6773 5f68 746d 6c20 3d20 4c6f 6728  logs_html = Log(
+00024cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024d00: 2022 5c6e 222e 6a6f 696e 280a 2020 2020   "\n".join(.    
+00024d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d20: 2225 7320 2d20 2573 220a 2020 2020 2020  "%s - %s".      
+00024d30: 2020 2020 2020 2020 2020 2020 2020 2520                % 
+00024d40: 2864 6174 6574 696d 652e 6672 6f6d 7469  (datetime.fromti
+00024d50: 6d65 7374 616d 7028 7469 6d65 292e 7374  mestamp(time).st
+00024d60: 7266 7469 6d65 2822 2548 3a25 4d3a 2553  rftime("%H:%M:%S
+00024d70: 2e25 6622 292c 206c 696e 6529 0a20 2020  .%f"), line).   
+00024d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d90: 2066 6f72 2074 696d 652c 206c 6576 656c   for time, level
+00024da0: 2c20 6c69 6e65 2069 6e20 6c6f 6773 0a20  , line in logs. 
+00024db0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00024dc0: 0a20 2020 2020 2020 2020 2020 2029 2e5f  .            )._
+00024dd0: 7265 7072 5f68 746d 6c5f 2829 0a0a 2020  repr_html_()..  
+00024de0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00024df0: 3d20 4469 7628 7465 7874 3d6c 6f67 735f  = Div(text=logs_
+00024e00: 6874 6d6c 2c20 2a2a 5f42 4f4b 4548 5f53  html, **_BOKEH_S
+00024e10: 5459 4c45 535f 4b57 4152 4753 290a 0a0a  TYLES_KWARGS)...
+00024e20: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
+00024e30: 7379 7374 656d 6d6f 6e69 746f 725f 646f  systemmonitor_do
+00024e40: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
+00024e50: 7261 2c20 646f 6329 3a0a 2020 2020 7379  ra, doc):.    sy
+00024e60: 736d 6f6e 203d 2053 7973 7465 6d4d 6f6e  smon = SystemMon
+00024e70: 6974 6f72 2873 6368 6564 756c 6572 2c20  itor(scheduler, 
+00024e80: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00024e90: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
+00024ea0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+00024eb0: 6b3a 2053 6368 6564 756c 6572 2053 7973  k: Scheduler Sys
+00024ec0: 7465 6d20 4d6f 6e69 746f 7222 0a20 2020  tem Monitor".   
+00024ed0: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
+00024ee0: 6c6c 6261 636b 2864 6f63 2c20 7379 736d  llback(doc, sysm
+00024ef0: 6f6e 2c20 3530 3029 0a0a 2020 2020 646f  on, 500)..    do
+00024f00: 632e 6164 645f 726f 6f74 2873 7973 6d6f  c.add_root(sysmo
+00024f10: 6e2e 726f 6f74 290a 2020 2020 646f 632e  n.root).    doc.
+00024f20: 7465 6d70 6c61 7465 203d 2065 6e76 2e67  template = env.g
+00024f30: 6574 5f74 656d 706c 6174 6528 2273 696d  et_template("sim
+00024f40: 706c 652e 6874 6d6c 2229 0a20 2020 2064  ple.html").    d
+00024f50: 6f63 2e74 656d 706c 6174 655f 7661 7269  oc.template_vari
+00024f60: 6162 6c65 732e 7570 6461 7465 2865 7874  ables.update(ext
+00024f70: 7261 290a 2020 2020 646f 632e 7468 656d  ra).    doc.them
+00024f80: 6520 3d20 424f 4b45 485f 5448 454d 450a  e = BOKEH_THEME.
+00024f90: 0a0a 406c 6f67 5f65 7272 6f72 730a 6465  ..@log_errors.de
+00024fa0: 6620 7368 7566 666c 696e 675f 646f 6328  f shuffling_doc(
+00024fb0: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
+00024fc0: 2c20 646f 6329 3a0a 2020 2020 646f 632e  , doc):.    doc.
+00024fd0: 7469 746c 6520 3d20 2244 6173 6b3a 2053  title = "Dask: S
+00024fe0: 6875 6666 6c69 6e67 220a 0a20 2020 2073  huffling"..    s
+00024ff0: 6875 6666 6c69 6e67 203d 2053 6875 6666  huffling = Shuff
+00025000: 6c69 6e67 2873 6368 6564 756c 6572 2c20  ling(scheduler, 
+00025010: 7769 6474 683d 3430 302c 2068 6569 6768  width=400, heigh
+00025020: 743d 3430 3029 0a20 2020 2077 6f72 6b65  t=400).    worke
+00025030: 7273 5f6d 656d 6f72 7920 3d20 576f 726b  rs_memory = Work
+00025040: 6572 734d 656d 6f72 7928 7363 6865 6475  ersMemory(schedu
+00025050: 6c65 722c 2077 6964 7468 3d34 3030 2c20  ler, width=400, 
+00025060: 6865 6967 6874 3d34 3030 290a 2020 2020  height=400).    
+00025070: 7469 6d65 7365 7269 6573 203d 2053 7973  timeseries = Sys
+00025080: 7465 6d54 696d 6573 6572 6965 7328 0a20  temTimeseries(. 
+00025090: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+000250a0: 2c20 7769 6474 683d 3136 3030 2c20 6865  , width=1600, he
+000250b0: 6967 6874 3d32 3030 2c20 666f 6c6c 6f77  ight=200, follow
+000250c0: 5f69 6e74 6572 7661 6c3d 3330 3030 0a20  _interval=3000. 
+000250d0: 2020 2029 0a20 2020 2065 7665 6e74 5f6c     ).    event_l
+000250e0: 6f6f 7020 3d20 436f 6e74 656e 7469 6f6e  oop = Contention
+000250f0: 2873 6368 6564 756c 6572 2c20 7769 6474  (scheduler, widt
+00025100: 683d 3230 302c 2068 6569 6768 743d 3430  h=200, height=40
+00025110: 3029 0a0a 2020 2020 6164 645f 7065 7269  0)..    add_peri
+00025120: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+00025130: 632c 2073 6875 6666 6c69 6e67 2c20 3230  c, shuffling, 20
+00025140: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
+00025150: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00025160: 2c20 776f 726b 6572 735f 6d65 6d6f 7279  , workers_memory
+00025170: 2c20 3230 3029 0a20 2020 2061 6464 5f70  , 200).    add_p
+00025180: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00025190: 2864 6f63 2c20 7469 6d65 7365 7269 6573  (doc, timeseries
+000251a0: 2c20 3530 3029 0a20 2020 2061 6464 5f70  , 500).    add_p
+000251b0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+000251c0: 2864 6f63 2c20 6576 656e 745f 6c6f 6f70  (doc, event_loop
+000251d0: 2c20 3530 3029 0a0a 2020 2020 7469 6d65  , 500)..    time
+000251e0: 7365 7269 6573 2e62 616e 6477 6964 7468  series.bandwidth
+000251f0: 2e79 5f72 616e 6765 203d 2074 696d 6573  .y_range = times
+00025200: 6572 6965 732e 6469 736b 2e79 5f72 616e  eries.disk.y_ran
+00025210: 6765 0a0a 2020 2020 646f 632e 6164 645f  ge..    doc.add_
+00025220: 726f 6f74 280a 2020 2020 2020 2020 636f  root(.        co
+00025230: 6c75 6d6e 280a 2020 2020 2020 2020 2020  lumn(.          
+00025240: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
+00025250: 2020 2020 2020 2077 6f72 6b65 7273 5f6d         workers_m
+00025260: 656d 6f72 792e 726f 6f74 2c0a 2020 2020  emory.root,.    
+00025270: 2020 2020 2020 2020 2020 2020 7368 7566              shuf
+00025280: 666c 696e 672e 636f 6d6d 5f6d 656d 6f72  fling.comm_memor
+00025290: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+000252a0: 2020 2073 6875 6666 6c69 6e67 2e64 6973     shuffling.dis
+000252b0: 6b5f 6d65 6d6f 7279 2c0a 2020 2020 2020  k_memory,.      
+000252c0: 2020 2020 2020 2020 2020 7368 7566 666c            shuffl
+000252d0: 696e 672e 746f 7461 6c73 2c0a 2020 2020  ing.totals,.    
+000252e0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+000252f0: 745f 6c6f 6f70 2e72 6f6f 742c 0a20 2020  t_loop.root,.   
+00025300: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00025310: 2020 2020 2020 2020 726f 7728 636f 6c75          row(colu
+00025320: 6d6e 2874 696d 6573 6572 6965 732e 6261  mn(timeseries.ba
+00025330: 6e64 7769 6474 682c 2074 696d 6573 6572  ndwidth, timeser
+00025340: 6965 732e 6469 736b 2929 2c0a 2020 2020  ies.disk)),.    
+00025350: 2020 2020 290a 2020 2020 290a 2020 2020      ).    ).    
+00025360: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00025370: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00025380: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+00025390: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+000253a0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+000253b0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+000253c0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+000253d0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+000253e0: 730a 6465 6620 7374 6561 6c69 6e67 5f64  s.def stealing_d
+000253f0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+00025400: 7472 612c 2064 6f63 293a 0a20 2020 206f  tra, doc):.    o
+00025410: 6363 7570 616e 6379 203d 204f 6363 7570  ccupancy = Occup
+00025420: 616e 6379 2873 6368 6564 756c 6572 290a  ancy(scheduler).
+00025430: 2020 2020 7374 6561 6c69 6e67 5f74 7320      stealing_ts 
+00025440: 3d20 5374 6561 6c69 6e67 5469 6d65 5365  = StealingTimeSe
+00025450: 7269 6573 2873 6368 6564 756c 6572 290a  ries(scheduler).
+00025460: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
+00025470: 6e74 7320 3d20 5374 6561 6c69 6e67 4576  nts = StealingEv
+00025480: 656e 7473 2873 6368 6564 756c 6572 290a  ents(scheduler).
+00025490: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
+000254a0: 6e74 732e 726f 6f74 2e78 5f72 616e 6765  nts.root.x_range
+000254b0: 203d 2073 7465 616c 696e 675f 7473 2e72   = stealing_ts.r
+000254c0: 6f6f 742e 785f 7261 6e67 650a 2020 2020  oot.x_range.    
+000254d0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+000254e0: 6b3a 2057 6f72 6b20 5374 6561 6c69 6e67  k: Work Stealing
+000254f0: 220a 2020 2020 6164 645f 7065 7269 6f64  ".    add_period
+00025500: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
+00025510: 206f 6363 7570 616e 6379 2c20 3530 3029   occupancy, 500)
+00025520: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+00025530: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+00025540: 7374 6561 6c69 6e67 5f74 732c 2035 3030  stealing_ts, 500
+00025550: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
+00025560: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
+00025570: 2073 7465 616c 696e 675f 6576 656e 7473   stealing_events
+00025580: 2c20 3530 3029 0a0a 2020 2020 646f 632e  , 500)..    doc.
+00025590: 6164 645f 726f 6f74 280a 2020 2020 2020  add_root(.      
+000255a0: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
+000255b0: 2020 206f 6363 7570 616e 6379 2e72 6f6f     occupancy.roo
+000255c0: 742c 0a20 2020 2020 2020 2020 2020 2063  t,.            c
+000255d0: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
+000255e0: 2020 2020 2020 2073 7465 616c 696e 675f         stealing_
+000255f0: 7473 2e72 6f6f 742c 0a20 2020 2020 2020  ts.root,.       
+00025600: 2020 2020 2020 2020 2073 7465 616c 696e           stealin
+00025610: 675f 6576 656e 7473 2e72 6f6f 742c 0a20  g_events.root,. 
+00025620: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00025630: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+00025640: 7463 685f 626f 7468 222c 0a20 2020 2020  tch_both",.     
+00025650: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00025660: 2020 290a 2020 2020 290a 0a20 2020 2064    ).    )..    d
+00025670: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
+00025680: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
+00025690: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
+000256a0: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
+000256b0: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
+000256c0: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
+000256d0: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
+000256e0: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
+000256f0: 0a64 6566 2065 7665 6e74 735f 646f 6328  .def events_doc(
+00025700: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
+00025710: 2c20 646f 6329 3a0a 2020 2020 6576 656e  , doc):.    even
+00025720: 7473 203d 2045 7665 6e74 7328 7363 6865  ts = Events(sche
+00025730: 6475 6c65 722c 2022 616c 6c22 2c20 6865  duler, "all", he
+00025740: 6967 6874 3d32 3530 290a 2020 2020 6576  ight=250).    ev
+00025750: 656e 7473 2e75 7064 6174 6528 290a 2020  ents.update().  
+00025760: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
+00025770: 616c 6c62 6163 6b28 646f 632c 2065 7665  allback(doc, eve
+00025780: 6e74 732c 2035 3030 290a 2020 2020 646f  nts, 500).    do
+00025790: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
+000257a0: 2053 6368 6564 756c 6572 2045 7665 6e74   Scheduler Event
+000257b0: 7322 0a20 2020 2064 6f63 2e61 6464 5f72  s".    doc.add_r
+000257c0: 6f6f 7428 636f 6c75 6d6e 2865 7665 6e74  oot(column(event
+000257d0: 732e 726f 6f74 2c20 7369 7a69 6e67 5f6d  s.root, sizing_m
+000257e0: 6f64 653d 2273 6361 6c65 5f77 6964 7468  ode="scale_width
+000257f0: 2229 290a 2020 2020 646f 632e 7465 6d70  ")).    doc.temp
+00025800: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
+00025810: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
+00025820: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
+00025830: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
+00025840: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
+00025850: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00025860: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00025870: 6f67 5f65 7272 6f72 730a 6465 6620 6578  og_errors.def ex
+00025880: 6365 7074 696f 6e73 5f64 6f63 2873 6368  ceptions_doc(sch
+00025890: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
+000258a0: 6f63 293a 0a20 2020 2074 6162 6c65 203d  oc):.    table =
+000258b0: 2045 7863 6570 7469 6f6e 7354 6162 6c65   ExceptionsTable
+000258c0: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
+000258d0: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
+000258e0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+000258f0: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
+00025900: 626c 652c 2031 3030 3029 0a20 2020 2064  ble, 1000).    d
+00025910: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
+00025920: 3a20 4578 6365 7074 696f 6e73 220a 2020  : Exceptions".  
+00025930: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
+00025940: 6162 6c65 2e72 6f6f 7429 0a20 2020 2064  able.root).    d
+00025950: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
+00025960: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
+00025970: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
+00025980: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
+00025990: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
+000259a0: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
+000259b0: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
+000259c0: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
+000259d0: 0a64 6566 2077 6f72 6b65 7273 5f64 6f63  .def workers_doc
+000259e0: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
+000259f0: 612c 2064 6f63 293a 0a20 2020 2074 6162  a, doc):.    tab
+00025a00: 6c65 203d 2057 6f72 6b65 7254 6162 6c65  le = WorkerTable
+00025a10: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
+00025a20: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
+00025a30: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00025a40: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
+00025a50: 626c 652c 2035 3030 290a 2020 2020 646f  ble, 500).    do
+00025a60: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
+00025a70: 2057 6f72 6b65 7273 220a 2020 2020 646f   Workers".    do
+00025a80: 632e 6164 645f 726f 6f74 2874 6162 6c65  c.add_root(table
+00025a90: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
+00025aa0: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
+00025ab0: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
+00025ac0: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
+00025ad0: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
+00025ae0: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
+00025af0: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
+00025b00: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
+00025b10: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
+00025b20: 2068 6172 6477 6172 655f 646f 6328 7363   hardware_doc(sc
+00025b30: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
+00025b40: 646f 6329 3a0a 2020 2020 6877 203d 2048  doc):.    hw = H
+00025b50: 6172 6477 6172 6528 7363 6865 6475 6c65  ardware(schedule
+00025b60: 7229 0a20 2020 2068 772e 7570 6461 7465  r).    hw.update
+00025b70: 2829 0a20 2020 2064 6f63 2e74 6974 6c65  ().    doc.title
+00025b80: 203d 2022 4461 736b 3a20 436c 7573 7465   = "Dask: Cluste
+00025b90: 7220 4861 7264 7761 7265 2042 616e 6477  r Hardware Bandw
+00025ba0: 6964 7468 220a 2020 2020 646f 632e 6164  idth".    doc.ad
+00025bb0: 645f 726f 6f74 2868 772e 726f 6f74 290a  d_root(hw.root).
+00025bc0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00025bd0: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+00025be0: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
+00025bf0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+00025c00: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+00025c10: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
+00025c20: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
+00025c30: 485f 5448 454d 450a 0a20 2020 2061 6464  H_THEME..    add
+00025c40: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00025c50: 636b 2864 6f63 2c20 6877 2c20 3530 3029  ck(doc, hw, 500)
+00025c60: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
+00025c70: 6566 2074 6173 6b73 5f64 6f63 2873 6368  ef tasks_doc(sch
+00025c80: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
+00025c90: 6f63 293a 0a20 2020 2074 7320 3d20 5461  oc):.    ts = Ta
+00025ca0: 736b 5374 7265 616d 280a 2020 2020 2020  skStream(.      
+00025cb0: 2020 7363 6865 6475 6c65 722c 0a20 2020    scheduler,.   
+00025cc0: 2020 2020 206e 5f72 6563 7461 6e67 6c65       n_rectangle
+00025cd0: 733d 6461 736b 2e63 6f6e 6669 672e 6765  s=dask.config.ge
+00025ce0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
+00025cf0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+00025d00: 6475 6c65 722e 6461 7368 626f 6172 642e  duler.dashboard.
+00025d10: 7461 736b 732e 7461 736b 2d73 7472 6561  tasks.task-strea
+00025d20: 6d2d 6c65 6e67 7468 220a 2020 2020 2020  m-length".      
+00025d30: 2020 292c 0a20 2020 2020 2020 2063 6c65    ),.        cle
+00025d40: 6172 5f69 6e74 6572 7661 6c3d 2236 3073  ar_interval="60s
+00025d50: 222c 0a20 2020 2020 2020 2073 697a 696e  ",.        sizin
+00025d60: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00025d70: 626f 7468 222c 0a20 2020 2029 0a20 2020  both",.    ).   
+00025d80: 2074 732e 7570 6461 7465 2829 0a20 2020   ts.update().   
+00025d90: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
+00025da0: 6c6c 6261 636b 2864 6f63 2c20 7473 2c20  llback(doc, ts, 
+00025db0: 3530 3030 290a 2020 2020 646f 632e 7469  5000).    doc.ti
+00025dc0: 746c 6520 3d20 2244 6173 6b3a 2054 6173  tle = "Dask: Tas
+00025dd0: 6b20 5374 7265 616d 220a 2020 2020 646f  k Stream".    do
+00025de0: 632e 6164 645f 726f 6f74 2874 732e 726f  c.add_root(ts.ro
+00025df0: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
+00025e00: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
+00025e10: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
+00025e20: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
+00025e30: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
+00025e40: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
+00025e50: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00025e60: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
+00025e70: 6f67 5f65 7272 6f72 730a 6465 6620 6772  og_errors.def gr
+00025e80: 6170 685f 646f 6328 7363 6865 6475 6c65  aph_doc(schedule
+00025e90: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
+00025ea0: 2020 2020 6772 6170 6820 3d20 5461 736b      graph = Task
+00025eb0: 4772 6170 6828 7363 6865 6475 6c65 722c  Graph(scheduler,
+00025ec0: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00025ed0: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00025ee0: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+00025ef0: 736b 3a20 5461 736b 2047 7261 7068 220a  sk: Task Graph".
+00025f00: 2020 2020 6772 6170 682e 7570 6461 7465      graph.update
+00025f10: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
+00025f20: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00025f30: 2c20 6772 6170 682c 2032 3030 290a 2020  , graph, 200).  
+00025f40: 2020 646f 632e 6164 645f 726f 6f74 2867    doc.add_root(g
+00025f50: 7261 7068 2e72 6f6f 7429 0a0a 2020 2020  raph.root)..    
+00025f60: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
+00025f70: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
+00025f80: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
+00025f90: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
+00025fa0: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
+00025fb0: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
+00025fc0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+00025fd0: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+00025fe0: 730a 6465 6620 7467 5f67 7261 7068 5f64  s.def tg_graph_d
+00025ff0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+00026000: 7472 612c 2064 6f63 293a 0a20 2020 2074  tra, doc):.    t
+00026010: 675f 6772 6170 6820 3d20 5461 736b 4772  g_graph = TaskGr
+00026020: 6f75 7047 7261 7068 2873 6368 6564 756c  oupGraph(schedul
+00026030: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
+00026040: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+00026050: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
+00026060: 2244 6173 6b3a 2054 6173 6b20 4772 6f75  "Dask: Task Grou
+00026070: 7073 2047 7261 7068 220a 2020 2020 7467  ps Graph".    tg
+00026080: 5f67 7261 7068 2e75 7064 6174 6528 290a  _graph.update().
+00026090: 2020 2020 6164 645f 7065 7269 6f64 6963      add_periodic
+000260a0: 5f63 616c 6c62 6163 6b28 646f 632c 2074  _callback(doc, t
+000260b0: 675f 6772 6170 682c 2032 3030 290a 2020  g_graph, 200).  
+000260c0: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
+000260d0: 675f 6772 6170 682e 726f 6f74 290a 2020  g_graph.root).  
+000260e0: 2020 646f 632e 7465 6d70 6c61 7465 203d    doc.template =
+000260f0: 2065 6e76 2e67 6574 5f74 656d 706c 6174   env.get_templat
+00026100: 6528 2273 696d 706c 652e 6874 6d6c 2229  e("simple.html")
+00026110: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
+00026120: 655f 7661 7269 6162 6c65 732e 7570 6461  e_variables.upda
+00026130: 7465 2865 7874 7261 290a 2020 2020 646f  te(extra).    do
+00026140: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
+00026150: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
+00026160: 6f72 730a 6465 6620 7374 6174 7573 5f64  ors.def status_d
+00026170: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+00026180: 7472 612c 2064 6f63 293a 0a20 2020 2063  tra, doc):.    c
+00026190: 6c75 7374 6572 5f6d 656d 6f72 7920 3d20  luster_memory = 
+000261a0: 436c 7573 7465 724d 656d 6f72 7928 7363  ClusterMemory(sc
+000261b0: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
+000261c0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+000261d0: 7468 2229 0a20 2020 2063 6c75 7374 6572  th").    cluster
+000261e0: 5f6d 656d 6f72 792e 7570 6461 7465 2829  _memory.update()
+000261f0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+00026200: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+00026210: 636c 7573 7465 725f 6d65 6d6f 7279 2c20  cluster_memory, 
+00026220: 3130 3029 0a20 2020 2064 6f63 2e61 6464  100).    doc.add
+00026230: 5f72 6f6f 7428 636c 7573 7465 725f 6d65  _root(cluster_me
+00026240: 6d6f 7279 2e72 6f6f 7429 0a0a 2020 2020  mory.root)..    
+00026250: 6966 206c 656e 2873 6368 6564 756c 6572  if len(scheduler
+00026260: 2e77 6f72 6b65 7273 2920 3c3d 2031 3030  .workers) <= 100
+00026270: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
+00026280: 735f 6d65 6d6f 7279 203d 2057 6f72 6b65  s_memory = Worke
+00026290: 7273 4d65 6d6f 7279 2873 6368 6564 756c  rsMemory(schedul
+000262a0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
+000262b0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+000262c0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000262d0: 696e 6720 3d20 4375 7272 656e 744c 6f61  ing = CurrentLoa
+000262e0: 6428 7363 6865 6475 6c65 722c 2073 697a  d(scheduler, siz
+000262f0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00026300: 685f 626f 7468 2229 0a0a 2020 2020 2020  h_both")..      
+00026310: 2020 7072 6f63 6573 7369 6e67 5f72 6f6f    processing_roo
+00026320: 7420 3d20 7072 6f63 6573 7369 6e67 2e70  t = processing.p
+00026330: 726f 6365 7373 696e 675f 6669 6775 7265  rocessing_figure
+00026340: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00026350: 2020 2077 6f72 6b65 7273 5f6d 656d 6f72     workers_memor
+00026360: 7920 3d20 576f 726b 6572 734d 656d 6f72  y = WorkersMemor
+00026370: 7948 6973 746f 6772 616d 2873 6368 6564  yHistogram(sched
+00026380: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+00026390: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+000263a0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
+000263b0: 7369 6e67 203d 2050 726f 6365 7373 696e  sing = Processin
+000263c0: 6748 6973 746f 6772 616d 2873 6368 6564  gHistogram(sched
+000263d0: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+000263e0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+000263f0: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+00026400: 7373 696e 675f 726f 6f74 203d 2070 726f  ssing_root = pro
+00026410: 6365 7373 696e 672e 726f 6f74 0a0a 2020  cessing.root..  
+00026420: 2020 6375 7272 656e 745f 6c6f 6164 203d    current_load =
+00026430: 2043 7572 7265 6e74 4c6f 6164 2873 6368   CurrentLoad(sch
+00026440: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+00026450: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00026460: 6822 290a 2020 2020 6f63 6375 7061 6e63  h").    occupanc
+00026470: 7920 3d20 4f63 6375 7061 6e63 7928 7363  y = Occupancy(sc
+00026480: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
+00026490: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+000264a0: 7468 2229 0a20 2020 2077 6f72 6b65 7273  th").    workers
+000264b0: 5f74 7261 6e73 6665 725f 6279 7465 7320  _transfer_bytes 
+000264c0: 3d20 576f 726b 6572 7354 7261 6e73 6665  = WorkersTransfe
+000264d0: 7242 7974 6573 2873 6368 6564 756c 6572  rBytes(scheduler
+000264e0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+000264f0: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
+00026500: 2020 2063 7075 5f72 6f6f 7420 3d20 6375     cpu_root = cu
+00026510: 7272 656e 745f 6c6f 6164 2e63 7075 5f66  rrent_load.cpu_f
+00026520: 6967 7572 650a 2020 2020 6f63 6375 7061  igure.    occupa
+00026530: 6e63 795f 726f 6f74 203d 206f 6363 7570  ncy_root = occup
+00026540: 616e 6379 2e72 6f6f 740a 0a20 2020 2077  ancy.root..    w
+00026550: 6f72 6b65 7273 5f6d 656d 6f72 792e 7570  orkers_memory.up
+00026560: 6461 7465 2829 0a20 2020 2077 6f72 6b65  date().    worke
+00026570: 7273 5f74 7261 6e73 6665 725f 6279 7465  rs_transfer_byte
+00026580: 732e 7570 6461 7465 2829 0a20 2020 2070  s.update().    p
+00026590: 726f 6365 7373 696e 672e 7570 6461 7465  rocessing.update
+000265a0: 2829 0a20 2020 2063 7572 7265 6e74 5f6c  ().    current_l
+000265b0: 6f61 642e 7570 6461 7465 2829 0a20 2020  oad.update().   
+000265c0: 206f 6363 7570 616e 6379 2e75 7064 6174   occupancy.updat
+000265d0: 6528 290a 0a20 2020 2061 6464 5f70 6572  e()..    add_per
+000265e0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+000265f0: 6f63 2c20 776f 726b 6572 735f 6d65 6d6f  oc, workers_memo
+00026600: 7279 2c20 3130 3029 0a20 2020 2061 6464  ry, 100).    add
+00026610: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00026620: 636b 2864 6f63 2c20 776f 726b 6572 735f  ck(doc, workers_
+00026630: 7472 616e 7366 6572 5f62 7974 6573 2c20  transfer_bytes, 
+00026640: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
+00026650: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00026660: 6f63 2c20 7072 6f63 6573 7369 6e67 2c20  oc, processing, 
+00026670: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
+00026680: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00026690: 6f63 2c20 6375 7272 656e 745f 6c6f 6164  oc, current_load
+000266a0: 2c20 3130 3029 0a20 2020 2061 6464 5f70  , 100).    add_p
+000266b0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+000266c0: 2864 6f63 2c20 6f63 6375 7061 6e63 792c  (doc, occupancy,
+000266d0: 2031 3030 290a 0a20 2020 2064 6f63 2e61   100)..    doc.a
+000266e0: 6464 5f72 6f6f 7428 776f 726b 6572 735f  dd_root(workers_
+000266f0: 6d65 6d6f 7279 2e72 6f6f 7429 0a0a 2020  memory.root)..  
+00026700: 2020 7461 6273 203d 205b 0a20 2020 2020    tabs = [.     
+00026710: 2020 2054 6162 5061 6e65 6c28 6368 696c     TabPanel(chil
+00026720: 643d 7072 6f63 6573 7369 6e67 5f72 6f6f  d=processing_roo
+00026730: 742c 2074 6974 6c65 3d22 5072 6f63 6573  t, title="Proces
+00026740: 7369 6e67 2229 2c0a 2020 2020 2020 2020  sing"),.        
+00026750: 5461 6250 616e 656c 2863 6869 6c64 3d63  TabPanel(child=c
+00026760: 7075 5f72 6f6f 742c 2074 6974 6c65 3d22  pu_root, title="
+00026770: 4350 5522 292c 0a20 2020 2020 2020 2054  CPU"),.        T
+00026780: 6162 5061 6e65 6c28 6368 696c 643d 6f63  abPanel(child=oc
+00026790: 6375 7061 6e63 795f 726f 6f74 2c20 7469  cupancy_root, ti
+000267a0: 746c 653d 224f 6363 7570 616e 6379 2229  tle="Occupancy")
+000267b0: 2c0a 2020 2020 2020 2020 5461 6250 616e  ,.        TabPan
+000267c0: 656c 2863 6869 6c64 3d77 6f72 6b65 7273  el(child=workers
+000267d0: 5f74 7261 6e73 6665 725f 6279 7465 732e  _transfer_bytes.
+000267e0: 726f 6f74 2c20 7469 746c 653d 2244 6174  root, title="Dat
+000267f0: 6120 5472 616e 7366 6572 2229 2c0a 2020  a Transfer"),.  
+00026800: 2020 5d0a 0a20 2020 2068 656c 705f 203d    ]..    help_ =
+00026810: 2048 656c 7054 6f6f 6c28 0a20 2020 2020   HelpTool(.     
+00026820: 2020 2072 6564 6972 6563 743d 2268 7474     redirect="htt
+00026830: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
+00026840: 7267 2f65 6e2f 7374 6162 6c65 2f64 6173  rg/en/stable/das
+00026850: 6862 6f61 7264 2e68 746d 6c23 7461 736b  hboard.html#task
+00026860: 2d70 726f 6365 7373 696e 672d 6370 752d  -processing-cpu-
+00026870: 7574 696c 697a 6174 696f 6e2d 6f63 6375  utilization-occu
+00026880: 7061 6e63 792d 6461 7461 2d74 7261 6e73  pancy-data-trans
+00026890: 6665 7222 2c0a 2020 2020 2020 2020 6465  fer",.        de
+000268a0: 7363 7269 7074 696f 6e3d 2241 2064 6573  scription="A des
+000268b0: 6372 6970 7469 6f6e 206f 6620 5461 736b  cription of Task
+000268c0: 2050 726f 6365 7373 696e 672f 4350 5520   Processing/CPU 
+000268d0: 5574 696c 697a 6174 696f 6e2f 4f63 6375  Utilization/Occu
+000268e0: 7061 6e63 7922 2c0a 2020 2020 290a 2020  pancy",.    ).  
+000268f0: 2020 666f 7220 7461 6220 696e 2074 6162    for tab in tab
+00026900: 733a 0a20 2020 2020 2020 2074 6162 2e63  s:.        tab.c
+00026910: 6869 6c64 2e74 6f6f 6c62 6172 5f6c 6f63  hild.toolbar_loc
+00026920: 6174 696f 6e20 3d20 2261 626f 7665 220a  ation = "above".
+00026930: 2020 2020 2020 2020 7461 622e 6368 696c          tab.chil
+00026940: 642e 6164 645f 746f 6f6c 7328 6865 6c70  d.add_tools(help
+00026950: 5f29 0a0a 2020 2020 7072 6f63 5f74 6162  _)..    proc_tab
+00026960: 7320 3d20 5461 6273 2874 6162 733d 7461  s = Tabs(tabs=ta
+00026970: 6273 2c20 6e61 6d65 3d22 7072 6f63 6573  bs, name="proces
+00026980: 7369 6e67 5f74 6162 7322 2c20 7369 7a69  sing_tabs", sizi
+00026990: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+000269a0: 5f62 6f74 6822 290a 2020 2020 646f 632e  _both").    doc.
+000269b0: 6164 645f 726f 6f74 2870 726f 635f 7461  add_root(proc_ta
+000269c0: 6273 290a 0a20 2020 2074 6173 6b5f 7374  bs)..    task_st
+000269d0: 7265 616d 203d 2054 6173 6b53 7472 6561  ream = TaskStrea
+000269e0: 6d28 0a20 2020 2020 2020 2073 6368 6564  m(.        sched
+000269f0: 756c 6572 2c0a 2020 2020 2020 2020 6e5f  uler,.        n_
+00026a00: 7265 6374 616e 676c 6573 3d64 6173 6b2e  rectangles=dask.
+00026a10: 636f 6e66 6967 2e67 6574 280a 2020 2020  config.get(.    
+00026a20: 2020 2020 2020 2020 2264 6973 7472 6962          "distrib
+00026a30: 7574 6564 2e73 6368 6564 756c 6572 2e64  uted.scheduler.d
+00026a40: 6173 6862 6f61 7264 2e73 7461 7475 732e  ashboard.status.
+00026a50: 7461 736b 2d73 7472 6561 6d2d 6c65 6e67  task-stream-leng
+00026a60: 7468 220a 2020 2020 2020 2020 292c 0a20  th".        ),. 
+00026a70: 2020 2020 2020 2063 6c65 6172 5f69 6e74         clear_int
+00026a80: 6572 7661 6c3d 2235 7322 2c0a 2020 2020  erval="5s",.    
+00026a90: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
+00026aa0: 2273 7472 6574 6368 5f62 6f74 6822 2c0a  "stretch_both",.
+00026ab0: 2020 2020 290a 2020 2020 7461 736b 5f73      ).    task_s
+00026ac0: 7472 6561 6d2e 7570 6461 7465 2829 0a20  tream.update(). 
+00026ad0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00026ae0: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
+00026af0: 736b 5f73 7472 6561 6d2c 2031 3030 290a  sk_stream, 100).
+00026b00: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00026b10: 2874 6173 6b5f 7374 7265 616d 2e72 6f6f  (task_stream.roo
+00026b20: 7429 0a0a 2020 2020 7461 736b 5f70 726f  t)..    task_pro
+00026b30: 6772 6573 7320 3d20 5461 736b 5072 6f67  gress = TaskProg
+00026b40: 7265 7373 2873 6368 6564 756c 6572 2c20  ress(scheduler, 
+00026b50: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00026b60: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
+00026b70: 7461 736b 5f70 726f 6772 6573 732e 7570  task_progress.up
+00026b80: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
+00026b90: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00026ba0: 2864 6f63 2c20 7461 736b 5f70 726f 6772  (doc, task_progr
+00026bb0: 6573 732c 2031 3030 290a 2020 2020 646f  ess, 100).    do
+00026bc0: 632e 6164 645f 726f 6f74 2874 6173 6b5f  c.add_root(task_
+00026bd0: 7072 6f67 7265 7373 2e72 6f6f 7429 0a0a  progress.root)..
+00026be0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
+00026bf0: 2244 6173 6b3a 2053 7461 7475 7322 0a20  "Dask: Status". 
+00026c00: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
+00026c10: 4f4b 4548 5f54 4845 4d45 0a20 2020 2064  OKEH_THEME.    d
+00026c20: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
+00026c30: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
+00026c40: 7374 6174 7573 2e68 746d 6c22 290a 2020  status.html").  
+00026c50: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
+00026c60: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
+00026c70: 6578 7472 6129 0a0a 0a40 6375 7272 790a  extra)...@curry.
+00026c80: 6465 6620 696e 6469 7669 6475 616c 5f64  def individual_d
+00026c90: 6f63 2863 6c73 2c20 696e 7465 7276 616c  oc(cls, interval
+00026ca0: 2c20 7363 6865 6475 6c65 722c 2065 7874  , scheduler, ext
+00026cb0: 7261 2c20 646f 632c 2066 6967 5f61 7474  ra, doc, fig_att
+00026cc0: 723d 2272 6f6f 7422 2c20 2a2a 6b77 6172  r="root", **kwar
+00026cd0: 6773 293a 0a20 2020 2023 204e 6f74 653a  gs):.    # Note:
+00026ce0: 2040 6c6f 675f 6572 726f 7273 2061 6e64   @log_errors and
+00026cf0: 2040 6375 7272 7920 6172 6520 6e6f 7420   @curry are not 
+00026d00: 636f 6d70 6174 6962 6c65 0a20 2020 2077  compatible.    w
+00026d10: 6974 6820 6c6f 675f 6572 726f 7273 2829  ith log_errors()
+00026d20: 3a0a 2020 2020 2020 2020 6669 6720 3d20  :.        fig = 
+00026d30: 636c 7328 7363 6865 6475 6c65 722c 2073  cls(scheduler, s
+00026d40: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+00026d50: 7463 685f 626f 7468 222c 202a 2a6b 7761  tch_both", **kwa
+00026d60: 7267 7329 0a20 2020 2020 2020 2066 6967  rgs).        fig
+00026d70: 2e75 7064 6174 6528 290a 2020 2020 2020  .update().      
+00026d80: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
+00026d90: 616c 6c62 6163 6b28 646f 632c 2066 6967  allback(doc, fig
+00026da0: 2c20 696e 7465 7276 616c 290a 2020 2020  , interval).    
+00026db0: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00026dc0: 2867 6574 6174 7472 2866 6967 2c20 6669  (getattr(fig, fi
+00026dd0: 675f 6174 7472 2929 0a20 2020 2020 2020  g_attr)).       
+00026de0: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
+00026df0: 4548 5f54 4845 4d45 0a20 2020 2020 2020  EH_THEME.       
+00026e00: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+00026e10: 736b 3a20 2220 2b20 6675 6e63 6e61 6d65  sk: " + funcname
+00026e20: 2863 6c73 290a 0a0a 406c 6f67 5f65 7272  (cls)...@log_err
+00026e30: 6f72 730a 6465 6620 696e 6469 7669 6475  ors.def individu
+00026e40: 616c 5f70 726f 6669 6c65 5f64 6f63 2873  al_profile_doc(s
+00026e50: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
+00026e60: 2064 6f63 293a 0a20 2020 2070 726f 6620   doc):.    prof 
+00026e70: 3d20 5072 6f66 696c 6554 696d 6550 6c6f  = ProfileTimePlo
+00026e80: 7428 7363 6865 6475 6c65 722c 2073 697a  t(scheduler, siz
+00026e90: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00026ea0: 685f 626f 7468 222c 2064 6f63 3d64 6f63  h_both", doc=doc
+00026eb0: 290a 2020 2020 646f 632e 6164 645f 726f  ).    doc.add_ro
+00026ec0: 6f74 2870 726f 662e 726f 6f74 290a 2020  ot(prof.root).  
+00026ed0: 2020 7072 6f66 2e74 7269 6767 6572 5f75    prof.trigger_u
+00026ee0: 7064 6174 6528 290a 2020 2020 646f 632e  pdate().    doc.
+00026ef0: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
+00026f00: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
+00026f10: 730a 6465 6620 696e 6469 7669 6475 616c  s.def individual
+00026f20: 5f70 726f 6669 6c65 5f73 6572 7665 725f  _profile_server_
+00026f30: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
+00026f40: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
+00026f50: 7072 6f66 203d 2050 726f 6669 6c65 5365  prof = ProfileSe
+00026f60: 7276 6572 2873 6368 6564 756c 6572 2c20  rver(scheduler, 
+00026f70: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
+00026f80: 6574 6368 5f62 6f74 6822 2c20 646f 633d  etch_both", doc=
+00026f90: 646f 6329 0a20 2020 2064 6f63 2e61 6464  doc).    doc.add
+00026fa0: 5f72 6f6f 7428 7072 6f66 2e72 6f6f 7429  _root(prof.root)
+00026fb0: 0a20 2020 2070 726f 662e 7472 6967 6765  .    prof.trigge
+00026fc0: 725f 7570 6461 7465 2829 0a20 2020 2064  r_update().    d
+00026fd0: 6f63 2e74 6865 6d65 203d 2042 4f4b 4548  oc.theme = BOKEH
+00026fe0: 5f54 4845 4d45 0a0a 0a40 6c6f 675f 6572  _THEME...@log_er
+00026ff0: 726f 7273 0a64 6566 2070 726f 6669 6c65  rors.def profile
+00027000: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00027010: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00027020: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+00027030: 736b 3a20 5072 6f66 696c 6522 0a20 2020  sk: Profile".   
+00027040: 2070 726f 6620 3d20 5072 6f66 696c 6554   prof = ProfileT
+00027050: 696d 6550 6c6f 7428 7363 6865 6475 6c65  imePlot(schedule
+00027060: 722c 2073 697a 696e 675f 6d6f 6465 3d22  r, sizing_mode="
+00027070: 7374 7265 7463 685f 626f 7468 222c 2064  stretch_both", d
+00027080: 6f63 3d64 6f63 290a 2020 2020 646f 632e  oc=doc).    doc.
+00027090: 6164 645f 726f 6f74 2870 726f 662e 726f  add_root(prof.ro
+000270a0: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
+000270b0: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
+000270c0: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
+000270d0: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
+000270e0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
+000270f0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
+00027100: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00027110: 424f 4b45 485f 5448 454d 450a 0a20 2020  BOKEH_THEME..   
+00027120: 2070 726f 662e 7472 6967 6765 725f 7570   prof.trigger_up
+00027130: 6461 7465 2829 0a0a 0a40 6c6f 675f 6572  date()...@log_er
+00027140: 726f 7273 0a64 6566 2070 726f 6669 6c65  rors.def profile
+00027150: 5f73 6572 7665 725f 646f 6328 7363 6865  _server_doc(sche
+00027160: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
+00027170: 6329 3a0a 2020 2020 646f 632e 7469 746c  c):.    doc.titl
+00027180: 6520 3d20 2244 6173 6b3a 2050 726f 6669  e = "Dask: Profi
+00027190: 6c65 206f 6620 4576 656e 7420 4c6f 6f70  le of Event Loop
+000271a0: 220a 2020 2020 7072 6f66 203d 2050 726f  ".    prof = Pro
+000271b0: 6669 6c65 5365 7276 6572 2873 6368 6564  fileServer(sched
+000271c0: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+000271d0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+000271e0: 2c20 646f 633d 646f 6329 0a20 2020 2064  , doc=doc).    d
+000271f0: 6f63 2e61 6464 5f72 6f6f 7428 7072 6f66  oc.add_root(prof
+00027200: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
+00027210: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
+00027220: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
+00027230: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
+00027240: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
+00027250: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
+00027260: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
+00027270: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
+00027280: 2020 2020 7072 6f66 2e74 7269 6767 6572      prof.trigger
+00027290: 5f75 7064 6174 6528 290a                 _update().
```

### Comparing `distributed-2023.5.1/distributed/dashboard/components/shared.py` & `distributed-2023.6.0/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/components/worker.py` & `distributed-2023.6.0/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/core.py` & `distributed-2023.6.0/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/export_tool.js` & `distributed-2023.6.0/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/export_tool.py` & `distributed-2023.6.0/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/scheduler.py` & `distributed-2023.6.0/distributed/dashboard/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/utils.py` & `distributed-2023.6.0/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/dashboard/worker.py` & `distributed-2023.6.0/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/adaptive.py` & `distributed-2023.6.0/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/adaptive_core.py` & `distributed-2023.6.0/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/cluster.py` & `distributed-2023.6.0/distributed/deploy/cluster.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/local.py` & `distributed-2023.6.0/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/old_ssh.py` & `distributed-2023.6.0/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/spec.py` & `distributed-2023.6.0/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/ssh.py` & `distributed-2023.6.0/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/subprocess.py` & `distributed-2023.6.0/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/deploy/utils.py` & `distributed-2023.6.0/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/cluster_dump.py` & `distributed-2023.6.0/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/eventstream.py` & `distributed-2023.6.0/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/graph_layout.py` & `distributed-2023.6.0/distributed/diagnostics/graph_layout.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/memory_sampler.py` & `distributed-2023.6.0/distributed/diagnostics/memory_sampler.py`

 * *Files 1% similar despite different names*

```diff
@@ -181,15 +181,14 @@
     """Scheduler extension - server side of MemorySampler"""
 
     scheduler: Scheduler
     samples: dict[str, list[tuple[float, int]]]
 
     def __init__(self, scheduler: Scheduler):
         self.scheduler = scheduler
-        self.scheduler.extensions["memory_sampler"] = self
         self.scheduler.handlers["memory_sampler_start"] = self.start
         self.scheduler.handlers["memory_sampler_stop"] = self.stop
         self.samples = {}
 
     def start(self, client: str, measure: str, interval: float) -> str:
         """Start periodically sampling memory"""
         assert not measure.startswith("_")
```

### Comparing `distributed-2023.5.1/distributed/diagnostics/nvml.py` & `distributed-2023.6.0/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/plugin.py` & `distributed-2023.6.0/distributed/diagnostics/plugin.py`

 * *Files 1% similar despite different names*

```diff
@@ -310,24 +310,25 @@
     else:
         return funcname(type(plugin)) + "-" + str(uuid.uuid4())
 
 
 class SchedulerUploadFile(SchedulerPlugin):
     name = "upload_file"
 
-    def __init__(self, filepath):
+    def __init__(self, filepath: str, load: bool = True):
         """
         Initialize the plugin by reading in the data from the given file.
         """
         self.filename = os.path.basename(filepath)
+        self.load = load
         with open(filepath, "rb") as f:
             self.data = f.read()
 
     async def start(self, scheduler: Scheduler) -> None:
-        await scheduler.upload_file(self.filename, self.data)
+        await scheduler.upload_file(self.filename, self.data, load=self.load)
 
 
 class PackageInstall(WorkerPlugin, abc.ABC):
     """Abstract parent class for a worker plugin to install a set of packages
 
     This accepts a set of packages to install on all workers.
     You can also optionally ask for the worker to restart itself after
@@ -595,25 +596,26 @@
     >>> from distributed.diagnostics.plugin import UploadFile
 
     >>> client.register_worker_plugin(UploadFile("/path/to/file.py"))  # doctest: +SKIP
     """
 
     name = "upload_file"
 
-    def __init__(self, filepath):
+    def __init__(self, filepath: str, load: bool = True):
         """
         Initialize the plugin by reading in the data from the given file.
         """
         self.filename = os.path.basename(filepath)
+        self.load = load
         with open(filepath, "rb") as f:
             self.data = f.read()
 
     async def setup(self, worker):
         response = await worker.upload_file(
-            filename=self.filename, data=self.data, load=True
+            filename=self.filename, data=self.data, load=self.load
         )
         assert len(self.data) == response["nbytes"]
 
 
 class ForwardLoggingPlugin(WorkerPlugin):
     """
     A ``WorkerPlugin`` to forward python logging records from worker to client.
```

### Comparing `distributed-2023.5.1/distributed/diagnostics/progress.py` & `distributed-2023.6.0/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/progress_stream.py` & `distributed-2023.6.0/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/progressbar.py` & `distributed-2023.6.0/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/rmm.py` & `distributed-2023.6.0/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/task_stream.py` & `distributed-2023.6.0/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diagnostics/websocket.py` & `distributed-2023.6.0/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/diskutils.py` & `distributed-2023.6.0/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/distributed-schema.yaml` & `distributed-2023.6.0/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/distributed.yaml` & `distributed-2023.6.0/distributed/distributed.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/event.py` & `distributed-2023.6.0/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/exceptions.py` & `distributed-2023.6.0/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/prometheus.py` & `distributed-2023.6.0/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/proxy.py` & `distributed-2023.6.0/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/routing.py` & `distributed-2023.6.0/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/api.py` & `distributed-2023.6.0/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/info.py` & `distributed-2023.6.0/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/json.py` & `distributed-2023.6.0/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/missing_bokeh.py` & `distributed-2023.6.0/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/prometheus/core.py` & `distributed-2023.6.0/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2023.6.0/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2023.6.0/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/css/base.css` & `distributed-2023.6.0/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/css/individual-cluster-map.css` & `distributed-2023.6.0/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/css/status.css` & `distributed-2023.6.0/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/dask-logo.svg` & `distributed-2023.6.0/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/fa-bars.svg` & `distributed-2023.6.0/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/favicon.ico` & `distributed-2023.6.0/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/jupyter.svg` & `distributed-2023.6.0/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/numpy.png` & `distributed-2023.6.0/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/pandas.png` & `distributed-2023.6.0/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/images/python.png` & `distributed-2023.6.0/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/individual-cluster-map.html` & `distributed-2023.6.0/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/js/anime.min.js` & `distributed-2023.6.0/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/js/individual-cluster-map.js` & `distributed-2023.6.0/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2023.6.0/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/base.html` & `distributed-2023.6.0/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/exceptions.html` & `distributed-2023.6.0/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/status.html` & `distributed-2023.6.0/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/task.html` & `distributed-2023.6.0/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/worker-table.html` & `distributed-2023.6.0/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/templates/worker.html` & `distributed-2023.6.0/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/utils.py` & `distributed-2023.6.0/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/http/worker/prometheus/core.py` & `distributed-2023.6.0/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/lock.py` & `distributed-2023.6.0/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/metrics.py` & `distributed-2023.6.0/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/multi_lock.py` & `distributed-2023.6.0/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/nanny.py` & `distributed-2023.6.0/distributed/nanny.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/node.py` & `distributed-2023.6.0/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/objects.py` & `distributed-2023.6.0/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/preloading.py` & `distributed-2023.6.0/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/process.py` & `distributed-2023.6.0/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/proctitle.py` & `distributed-2023.6.0/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/profile.py` & `distributed-2023.6.0/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/__init__.py` & `distributed-2023.6.0/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/arrow.py` & `distributed-2023.6.0/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/compression.py` & `distributed-2023.6.0/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/core.py` & `distributed-2023.6.0/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/cuda.py` & `distributed-2023.6.0/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/cupy.py` & `distributed-2023.6.0/distributed/protocol/cupy.py`

 * *Files 1% similar despite different names*

```diff
@@ -81,15 +81,15 @@
 
 
 if MatDescriptor is not None:
 
     def reduce_matdescriptor(other):
         # Pickling MatDescriptor errors
         # xref: https://github.com/cupy/cupy/issues/3061
-        return cupy.cusparse.MatDescriptor.create, ()
+        return MatDescriptor.create, ()
 
     copyreg.pickle(MatDescriptor, reduce_matdescriptor)
 
     @cuda_serialize.register(MatDescriptor)
     @dask_serialize.register(MatDescriptor)
     def serialize_cupy_matdescriptor(x):
         header, frames = {}, []
```

### Comparing `distributed-2023.5.1/distributed/protocol/h5py.py` & `distributed-2023.6.0/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/keras.py` & `distributed-2023.6.0/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/netcdf4.py` & `distributed-2023.6.0/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/numba.py` & `distributed-2023.6.0/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/numpy.py` & `distributed-2023.6.0/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/pickle.py` & `distributed-2023.6.0/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/rmm.py` & `distributed-2023.6.0/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/scipy.py` & `distributed-2023.6.0/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/serialize.py` & `distributed-2023.6.0/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/sparse.py` & `distributed-2023.6.0/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/torch.py` & `distributed-2023.6.0/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/protocol/utils.py` & `distributed-2023.6.0/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/publish.py` & `distributed-2023.6.0/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/pubsub.py` & `distributed-2023.6.0/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/queues.py` & `distributed-2023.6.0/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/recreate_tasks.py` & `distributed-2023.6.0/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/scheduler.py` & `distributed-2023.6.0/distributed/scheduler.py`

 * *Files 1% similar despite different names*

```diff
@@ -83,18834 +83,18968 @@
 00000520: 5f6d 616e 6167 6572 2069 6d70 6f72 7420  _manager import 
 00000530: 4163 7469 7665 4d65 6d6f 7279 4d61 6e61  ActiveMemoryMana
 00000540: 6765 7245 7874 656e 7369 6f6e 2c20 5265  gerExtension, Re
 00000550: 7469 7265 576f 726b 6572 0a66 726f 6d20  tireWorker.from 
 00000560: 6469 7374 7269 6275 7465 642e 6261 7463  distributed.batc
 00000570: 6865 6420 696d 706f 7274 2042 6174 6368  hed import Batch
 00000580: 6564 5365 6e64 0a66 726f 6d20 6469 7374  edSend.from dist
-00000590: 7269 6275 7465 642e 636f 6c6c 6563 7469  ributed.collecti
-000005a0: 6f6e 7320 696d 706f 7274 2048 6561 7053  ons import HeapS
-000005b0: 6574 0a66 726f 6d20 6469 7374 7269 6275  et.from distribu
-000005c0: 7465 642e 636f 6d6d 2069 6d70 6f72 7420  ted.comm import 
-000005d0: 280a 2020 2020 436f 6d6d 2c0a 2020 2020  (.    Comm,.    
-000005e0: 436f 6d6d 436c 6f73 6564 4572 726f 722c  CommClosedError,
-000005f0: 0a20 2020 2067 6574 5f61 6464 7265 7373  .    get_address
-00000600: 5f68 6f73 742c 0a20 2020 206e 6f72 6d61  _host,.    norma
-00000610: 6c69 7a65 5f61 6464 7265 7373 2c0a 2020  lize_address,.  
-00000620: 2020 7265 736f 6c76 655f 6164 6472 6573    resolve_addres
-00000630: 732c 0a20 2020 2075 6e70 6172 7365 5f68  s,.    unparse_h
-00000640: 6f73 745f 706f 7274 2c0a 290a 6672 6f6d  ost_port,.).from
-00000650: 2064 6973 7472 6962 7574 6564 2e63 6f6d   distributed.com
-00000660: 6d2e 6164 6472 6573 7369 6e67 2069 6d70  m.addressing imp
-00000670: 6f72 7420 6164 6472 6573 7365 735f 6672  ort addresses_fr
-00000680: 6f6d 5f75 7365 725f 6172 6773 0a66 726f  om_user_args.fro
-00000690: 6d20 6469 7374 7269 6275 7465 642e 636f  m distributed.co
-000006a0: 6d70 6174 6962 696c 6974 7920 696d 706f  mpatibility impo
-000006b0: 7274 2050 6572 696f 6469 6343 616c 6c62  rt PeriodicCallb
-000006c0: 6163 6b0a 6672 6f6d 2064 6973 7472 6962  ack.from distrib
-000006d0: 7574 6564 2e63 6f72 6520 696d 706f 7274  uted.core import
-000006e0: 2053 7461 7475 732c 2063 6c65 616e 5f65   Status, clean_e
-000006f0: 7863 6570 7469 6f6e 2c20 6572 726f 725f  xception, error_
-00000700: 6d65 7373 6167 652c 2072 7063 2c20 7365  message, rpc, se
-00000710: 6e64 5f72 6563 760a 6672 6f6d 2064 6973  nd_recv.from dis
-00000720: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
-00000730: 7469 6373 2e6d 656d 6f72 795f 7361 6d70  tics.memory_samp
-00000740: 6c65 7220 696d 706f 7274 204d 656d 6f72  ler import Memor
-00000750: 7953 616d 706c 6572 4578 7465 6e73 696f  ySamplerExtensio
-00000760: 6e0a 6672 6f6d 2064 6973 7472 6962 7574  n.from distribut
-00000770: 6564 2e64 6961 676e 6f73 7469 6373 2e70  ed.diagnostics.p
-00000780: 6c75 6769 6e20 696d 706f 7274 2053 6368  lugin import Sch
-00000790: 6564 756c 6572 506c 7567 696e 2c20 5f67  edulerPlugin, _g
-000007a0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 0a66  et_plugin_name.f
-000007b0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000007c0: 6576 656e 7420 696d 706f 7274 2045 7665  event import Eve
-000007d0: 6e74 4578 7465 6e73 696f 6e0a 6672 6f6d  ntExtension.from
-000007e0: 2064 6973 7472 6962 7574 6564 2e68 7474   distributed.htt
-000007f0: 7020 696d 706f 7274 2067 6574 5f68 616e  p import get_han
-00000800: 646c 6572 730a 6672 6f6d 2064 6973 7472  dlers.from distr
-00000810: 6962 7574 6564 2e6c 6f63 6b20 696d 706f  ibuted.lock impo
-00000820: 7274 204c 6f63 6b45 7874 656e 7369 6f6e  rt LockExtension
-00000830: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000840: 642e 6d65 7472 6963 7320 696d 706f 7274  d.metrics import
-00000850: 206d 6f6e 6f74 6f6e 6963 2c20 7469 6d65   monotonic, time
-00000860: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
-00000870: 642e 6d75 6c74 695f 6c6f 636b 2069 6d70  d.multi_lock imp
-00000880: 6f72 7420 4d75 6c74 694c 6f63 6b45 7874  ort MultiLockExt
-00000890: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
-000008a0: 7269 6275 7465 642e 6e6f 6465 2069 6d70  ributed.node imp
-000008b0: 6f72 7420 5365 7276 6572 4e6f 6465 0a66  ort ServerNode.f
-000008c0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000008d0: 7072 6f63 7469 746c 6520 696d 706f 7274  proctitle import
-000008e0: 2073 6574 7072 6f63 7469 746c 650a 6672   setproctitle.fr
-000008f0: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
-00000900: 726f 746f 636f 6c2e 7069 636b 6c65 2069  rotocol.pickle i
-00000910: 6d70 6f72 7420 6475 6d70 732c 206c 6f61  mport dumps, loa
-00000920: 6473 0a66 726f 6d20 6469 7374 7269 6275  ds.from distribu
-00000930: 7465 642e 7072 6f74 6f63 6f6c 2e73 6572  ted.protocol.ser
-00000940: 6961 6c69 7a65 2069 6d70 6f72 7420 5365  ialize import Se
-00000950: 7269 616c 697a 6564 2c20 546f 5069 636b  rialized, ToPick
-00000960: 6c65 2c20 7365 7269 616c 697a 650a 6672  le, serialize.fr
-00000970: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
-00000980: 7562 6c69 7368 2069 6d70 6f72 7420 5075  ublish import Pu
-00000990: 626c 6973 6845 7874 656e 7369 6f6e 0a66  blishExtension.f
-000009a0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000009b0: 7075 6273 7562 2069 6d70 6f72 7420 5075  pubsub import Pu
-000009c0: 6253 7562 5363 6865 6475 6c65 7245 7874  bSubSchedulerExt
-000009d0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
-000009e0: 7269 6275 7465 642e 7175 6575 6573 2069  ributed.queues i
-000009f0: 6d70 6f72 7420 5175 6575 6545 7874 656e  mport QueueExten
-00000a00: 7369 6f6e 0a66 726f 6d20 6469 7374 7269  sion.from distri
-00000a10: 6275 7465 642e 7265 6372 6561 7465 5f74  buted.recreate_t
-00000a20: 6173 6b73 2069 6d70 6f72 7420 5265 706c  asks import Repl
-00000a30: 6179 5461 736b 5363 6865 6475 6c65 720a  ayTaskScheduler.
-00000a40: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00000a50: 2e73 6563 7572 6974 7920 696d 706f 7274  .security import
-00000a60: 2053 6563 7572 6974 790a 6672 6f6d 2064   Security.from d
-00000a70: 6973 7472 6962 7574 6564 2e73 656d 6170  istributed.semap
-00000a80: 686f 7265 2069 6d70 6f72 7420 5365 6d61  hore import Sema
-00000a90: 7068 6f72 6545 7874 656e 7369 6f6e 0a66  phoreExtension.f
-00000aa0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000ab0: 7368 7566 666c 6520 696d 706f 7274 2053  shuffle import S
-00000ac0: 6875 6666 6c65 5363 6865 6475 6c65 7245  huffleSchedulerE
-00000ad0: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
-00000ae0: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
-00000af0: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
-00000b00: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
-00000b10: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
-00000b20: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
-00000b30: 2020 2020 5469 6d65 6f75 7445 7272 6f72      TimeoutError
-00000b40: 2c0a 2020 2020 656d 7074 795f 636f 6e74  ,.    empty_cont
-00000b50: 6578 742c 0a20 2020 2066 6f72 6d61 745f  ext,.    format_
-00000b60: 6461 7368 626f 6172 645f 6c69 6e6b 2c0a  dashboard_link,.
-00000b70: 2020 2020 6765 745f 6669 6c65 6e6f 5f6c      get_fileno_l
-00000b80: 696d 6974 2c0a 2020 2020 6b65 795f 7370  imit,.    key_sp
-00000b90: 6c69 745f 6772 6f75 702c 0a20 2020 206c  lit_group,.    l
-00000ba0: 6f67 5f65 7272 6f72 732c 0a20 2020 206e  og_errors,.    n
-00000bb0: 6f5f 6465 6661 756c 742c 0a20 2020 2072  o_default,.    r
-00000bc0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
-00000bd0: 2c0a 2020 2020 7661 6c69 6461 7465 5f6b  ,.    validate_k
-00000be0: 6579 2c0a 2020 2020 7761 6974 5f66 6f72  ey,.    wait_for
-00000bf0: 2c0a 290a 6672 6f6d 2064 6973 7472 6962  ,.).from distrib
-00000c00: 7574 6564 2e75 7469 6c73 5f63 6f6d 6d20  uted.utils_comm 
-00000c10: 696d 706f 7274 2028 0a20 2020 2067 6174  import (.    gat
-00000c20: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
-00000c30: 2c0a 2020 2020 7265 7472 795f 6f70 6572  ,.    retry_oper
-00000c40: 6174 696f 6e2c 0a20 2020 2073 6361 7474  ation,.    scatt
-00000c50: 6572 5f74 6f5f 776f 726b 6572 732c 0a20  er_to_workers,. 
-00000c60: 2020 2075 6e70 6163 6b5f 7265 6d6f 7465     unpack_remote
-00000c70: 6461 7461 2c0a 290a 6672 6f6d 2064 6973  data,.).from dis
-00000c80: 7472 6962 7574 6564 2e75 7469 6c73 5f70  tributed.utils_p
-00000c90: 6572 6620 696d 706f 7274 2064 6973 6162  erf import disab
-00000ca0: 6c65 5f67 635f 6469 6167 6e6f 7369 732c  le_gc_diagnosis,
-00000cb0: 2065 6e61 626c 655f 6763 5f64 6961 676e   enable_gc_diagn
-00000cc0: 6f73 6973 0a66 726f 6d20 6469 7374 7269  osis.from distri
-00000cd0: 6275 7465 642e 7661 7269 6162 6c65 2069  buted.variable i
-00000ce0: 6d70 6f72 7420 5661 7269 6162 6c65 4578  mport VariableEx
-00000cf0: 7465 6e73 696f 6e0a 0a69 6620 5459 5045  tension..if TYPE
-00000d00: 5f43 4845 434b 494e 473a 0a20 2020 2023  _CHECKING:.    #
-00000d10: 2054 4f44 4f20 696d 706f 7274 2066 726f   TODO import fro
-00000d20: 6d20 7479 7069 6e67 2028 7265 7175 6972  m typing (requir
-00000d30: 6573 2050 7974 686f 6e20 3e3d 332e 3130  es Python >=3.10
-00000d40: 290a 2020 2020 6672 6f6d 2074 7970 696e  ).    from typin
-00000d50: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
-00000d60: 6f72 7420 5479 7065 416c 6961 730a 0a20  ort TypeAlias.. 
-00000d70: 2020 2066 726f 6d20 6461 736b 2e68 6967     from dask.hig
-00000d80: 686c 6576 656c 6772 6170 6820 696d 706f  hlevelgraph impo
-00000d90: 7274 2048 6967 684c 6576 656c 4772 6170  rt HighLevelGrap
-00000da0: 680a 0a23 204e 6f74 2074 6f20 6265 2063  h..# Not to be c
-00000db0: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
-00000dc0: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-00000dd0: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
-00000de0: 736b 5374 6174 6553 7461 7465 0a54 6173  skStateState.Tas
-00000df0: 6b53 7461 7465 5374 6174 653a 2054 7970  kStateState: Typ
-00000e00: 6541 6c69 6173 203d 204c 6974 6572 616c  eAlias = Literal
-00000e10: 5b0a 2020 2020 2272 656c 6561 7365 6422  [.    "released"
-00000e20: 2c0a 2020 2020 2277 6169 7469 6e67 222c  ,.    "waiting",
-00000e30: 0a20 2020 2022 6e6f 2d77 6f72 6b65 7222  .    "no-worker"
-00000e40: 2c0a 2020 2020 2271 7565 7565 6422 2c0a  ,.    "queued",.
-00000e50: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
-00000e60: 2c0a 2020 2020 226d 656d 6f72 7922 2c0a  ,.    "memory",.
-00000e70: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
-00000e80: 2022 666f 7267 6f74 7465 6e22 2c0a 5d0a   "forgotten",.].
-00000e90: 0a41 4c4c 5f54 4153 4b5f 5354 4154 4553  .ALL_TASK_STATES
-00000ea0: 3a20 5365 745b 5461 736b 5374 6174 6553  : Set[TaskStateS
-00000eb0: 7461 7465 5d20 3d20 7365 7428 5461 736b  tate] = set(Task
-00000ec0: 5374 6174 6553 7461 7465 2e5f 5f61 7267  StateState.__arg
-00000ed0: 735f 5f29 2020 2320 7479 7065 3a20 6967  s__)  # type: ig
-00000ee0: 6e6f 7265 0a0a 2320 7b74 6173 6b20 6b65  nore..# {task ke
-00000ef0: 7920 2d3e 2066 696e 6973 6820 7374 6174  y -> finish stat
-00000f00: 657d 0a23 204e 6f74 2074 6f20 6265 2063  e}.# Not to be c
-00000f10: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
-00000f20: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-00000f30: 7374 6174 655f 6d61 6368 696e 652e 5265  state_machine.Re
-00000f40: 6373 0a52 6563 733a 2054 7970 6541 6c69  cs.Recs: TypeAli
-00000f50: 6173 203d 2064 6963 745b 7374 722c 2054  as = dict[str, T
-00000f60: 6173 6b53 7461 7465 5374 6174 655d 0a23  askStateState].#
-00000f70: 207b 636c 6965 6e74 206f 7220 776f 726b   {client or work
-00000f80: 6572 2061 6464 7265 7373 3a20 5b7b 6f70  er address: [{op
-00000f90: 3a20 3c6b 6579 3e2c 202e 2e2e 7d2c 202e  : <key>, ...}, .
-00000fa0: 2e2e 5d7d 0a4d 7367 733a 2054 7970 6541  ..]}.Msgs: TypeA
-00000fb0: 6c69 6173 203d 2064 6963 745b 7374 722c  lias = dict[str,
-00000fc0: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
-00000fd0: 416e 795d 5d5d 0a23 2028 7265 636f 6d6d  Any]]].# (recomm
-00000fe0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00000ff0: 7420 6d65 7373 6167 6573 2c20 776f 726b  t messages, work
-00001000: 6572 206d 6573 7361 6765 7329 0a52 6563  er messages).Rec
-00001010: 734d 7367 733a 2054 7970 6541 6c69 6173  sMsgs: TypeAlias
-00001020: 203d 2074 7570 6c65 5b52 6563 732c 204d   = tuple[Recs, M
-00001030: 7367 732c 204d 7367 735d 0a0a 6c6f 6767  sgs, Msgs]..logg
-00001040: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
-00001050: 4c6f 6767 6572 285f 5f6e 616d 655f 5f29  Logger(__name__)
-00001060: 0a4c 4f47 5f50 4442 203d 2064 6173 6b2e  .LOG_PDB = dask.
-00001070: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-00001080: 7269 6275 7465 642e 6164 6d69 6e2e 7064  ributed.admin.pd
-00001090: 622d 6f6e 2d65 7272 2229 0a44 4546 4155  b-on-err").DEFAU
-000010a0: 4c54 5f44 4154 415f 5349 5a45 203d 2070  LT_DATA_SIZE = p
-000010b0: 6172 7365 5f62 7974 6573 280a 2020 2020  arse_bytes(.    
-000010c0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-000010d0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-000010e0: 6564 756c 6572 2e64 6566 6175 6c74 2d64  eduler.default-d
-000010f0: 6174 612d 7369 7a65 2229 0a29 0a53 5449  ata-size").).STI
-00001100: 4d55 4c55 535f 4944 5f55 4e53 4554 203d  MULUS_ID_UNSET =
-00001110: 2022 3c73 7469 6d75 6c75 735f 6964 2075   "<stimulus_id u
-00001120: 6e73 6574 3e22 0a0a 4445 4641 554c 545f  nset>"..DEFAULT_
-00001130: 4558 5445 4e53 494f 4e53 203d 207b 0a20  EXTENSIONS = {. 
-00001140: 2020 2022 6c6f 636b 7322 3a20 4c6f 636b     "locks": Lock
-00001150: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
-00001160: 6d75 6c74 695f 6c6f 636b 7322 3a20 4d75  multi_locks": Mu
-00001170: 6c74 694c 6f63 6b45 7874 656e 7369 6f6e  ltiLockExtension
-00001180: 2c0a 2020 2020 2270 7562 6c69 7368 223a  ,.    "publish":
-00001190: 2050 7562 6c69 7368 4578 7465 6e73 696f   PublishExtensio
-000011a0: 6e2c 0a20 2020 2022 7265 706c 6179 2d74  n,.    "replay-t
-000011b0: 6173 6b73 223a 2052 6570 6c61 7954 6173  asks": ReplayTas
-000011c0: 6b53 6368 6564 756c 6572 2c0a 2020 2020  kScheduler,.    
-000011d0: 2271 7565 7565 7322 3a20 5175 6575 6545  "queues": QueueE
-000011e0: 7874 656e 7369 6f6e 2c0a 2020 2020 2276  xtension,.    "v
-000011f0: 6172 6961 626c 6573 223a 2056 6172 6961  ariables": Varia
-00001200: 626c 6545 7874 656e 7369 6f6e 2c0a 2020  bleExtension,.  
-00001210: 2020 2270 7562 7375 6222 3a20 5075 6253    "pubsub": PubS
-00001220: 7562 5363 6865 6475 6c65 7245 7874 656e  ubSchedulerExten
-00001230: 7369 6f6e 2c0a 2020 2020 2273 656d 6170  sion,.    "semap
-00001240: 686f 7265 7322 3a20 5365 6d61 7068 6f72  hores": Semaphor
-00001250: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
-00001260: 2265 7665 6e74 7322 3a20 4576 656e 7445  "events": EventE
-00001270: 7874 656e 7369 6f6e 2c0a 2020 2020 2261  xtension,.    "a
-00001280: 6d6d 223a 2041 6374 6976 654d 656d 6f72  mm": ActiveMemor
-00001290: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
-000012a0: 6e2c 0a20 2020 2022 6d65 6d6f 7279 5f73  n,.    "memory_s
-000012b0: 616d 706c 6572 223a 204d 656d 6f72 7953  ampler": MemoryS
-000012c0: 616d 706c 6572 4578 7465 6e73 696f 6e2c  amplerExtension,
-000012d0: 0a20 2020 2022 7368 7566 666c 6522 3a20  .    "shuffle": 
-000012e0: 5368 7566 666c 6553 6368 6564 756c 6572  ShuffleScheduler
-000012f0: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
-00001300: 7374 6561 6c69 6e67 223a 2057 6f72 6b53  stealing": WorkS
-00001310: 7465 616c 696e 672c 0a7d 0a0a 0a63 6c61  tealing,.}...cla
-00001320: 7373 2043 6c69 656e 7453 7461 7465 3a0a  ss ClientState:.
-00001330: 2020 2020 2222 2241 2073 696d 706c 6520      """A simple 
-00001340: 6f62 6a65 6374 2068 6f6c 6469 6e67 2069  object holding i
-00001350: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00001360: 2061 2063 6c69 656e 742e 2222 220a 0a20   a client.""".. 
-00001370: 2020 2023 3a20 4120 756e 6971 7565 2069     #: A unique i
-00001380: 6465 6e74 6966 6965 7220 666f 7220 7468  dentifier for th
-00001390: 6973 2063 6c69 656e 742e 2054 6869 7320  is client. This 
-000013a0: 6973 2067 656e 6572 616c 6c79 2061 6e20  is generally an 
-000013b0: 6f70 6171 7565 0a20 2020 2023 3a20 7374  opaque.    #: st
-000013c0: 7269 6e67 2067 656e 6572 6174 6564 2062  ring generated b
-000013d0: 7920 7468 6520 636c 6965 6e74 2069 7473  y the client its
-000013e0: 656c 662e 0a20 2020 2063 6c69 656e 745f  elf..    client_
-000013f0: 6b65 793a 2073 7472 0a0a 2020 2020 233a  key: str..    #:
-00001400: 2043 6163 6865 6420 6861 7368 206f 6620   Cached hash of 
-00001410: 3a61 7474 723a 607e 436c 6965 6e74 5374  :attr:`~ClientSt
-00001420: 6174 652e 636c 6965 6e74 5f6b 6579 600a  ate.client_key`.
-00001430: 2020 2020 5f68 6173 683a 2069 6e74 0a0a      _hash: int..
-00001440: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
-00001450: 7461 736b 7320 7468 6973 2063 6c69 656e  tasks this clien
-00001460: 7420 7761 6e74 7320 746f 2062 6520 6b65  t wants to be ke
-00001470: 7074 2069 6e20 6d65 6d6f 7279 2c20 736f  pt in memory, so
-00001480: 2074 6861 7420 6974 2063 616e 2064 6f77   that it can dow
-00001490: 6e6c 6f61 640a 2020 2020 233a 2069 7473  nload.    #: its
-000014a0: 2072 6573 756c 7420 7768 656e 2064 6573   result when des
-000014b0: 6972 6564 2e20 5468 6973 2069 7320 7468  ired. This is th
-000014c0: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
-000014d0: 6720 6f66 0a20 2020 2023 3a20 3a63 6c61  g of.    #: :cla
-000014e0: 7373 3a60 5461 736b 5374 6174 652e 7768  ss:`TaskState.wh
-000014f0: 6f5f 7761 6e74 7360 2e20 5461 736b 7320  o_wants`. Tasks 
-00001500: 6172 6520 7479 7069 6361 6c6c 7920 7265  are typically re
-00001510: 6d6f 7665 6420 6672 6f6d 2074 6869 7320  moved from this 
-00001520: 7365 7420 7768 656e 2074 6865 0a20 2020  set when the.   
-00001530: 2023 3a20 636f 7272 6573 706f 6e64 696e   #: correspondin
-00001540: 6720 6f62 6a65 6374 2069 6e20 7468 6520  g object in the 
-00001550: 636c 6965 6e74 2773 2073 7061 6365 2028  client's space (
-00001560: 666f 7220 6578 616d 706c 6520 6120 6060  for example a ``
-00001570: 4675 7475 7265 6060 206f 7220 6120 4461  Future`` or a Da
-00001580: 736b 0a20 2020 2023 3a20 636f 6c6c 6563  sk.    #: collec
-00001590: 7469 6f6e 2920 6765 7473 2067 6172 6261  tion) gets garba
-000015a0: 6765 2d63 6f6c 6c65 6374 6564 2e0a 2020  ge-collected..  
-000015b0: 2020 7761 6e74 735f 7768 6174 3a20 7365    wants_what: se
-000015c0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-000015d0: 2020 233a 2054 6865 206c 6173 7420 7469    #: The last ti
-000015e0: 6d65 2077 6520 7265 6365 6976 6564 2061  me we received a
-000015f0: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
-00001600: 7468 6973 2063 6c69 656e 742c 2069 6e20  this client, in 
-00001610: 6c6f 6361 6c20 7363 6865 6475 6c65 7220  local scheduler 
-00001620: 7469 6d65 2e0a 2020 2020 6c61 7374 5f73  time..    last_s
-00001630: 6565 6e3a 2066 6c6f 6174 0a0a 2020 2020  een: float..    
-00001640: 233a 204f 7574 7075 7420 6f66 203a 6675  #: Output of :fu
-00001650: 6e63 3a60 6469 7374 7269 6275 7465 642e  nc:`distributed.
-00001660: 7665 7273 696f 6e73 2e67 6574 5f76 6572  versions.get_ver
-00001670: 7369 6f6e 7360 206f 6e20 7468 6520 636c  sions` on the cl
-00001680: 6965 6e74 0a20 2020 2076 6572 7369 6f6e  ient.    version
-00001690: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
-000016a0: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
-000016b0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
-000016c0: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
-000016d0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000016e0: 2c20 636c 6965 6e74 3a20 7374 722c 202a  , client: str, *
-000016f0: 2c20 7665 7273 696f 6e73 3a20 6469 6374  , versions: dict
-00001700: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
-00001710: 6520 3d20 4e6f 6e65 293a 0a20 2020 2020  e = None):.     
-00001720: 2020 2073 656c 662e 636c 6965 6e74 5f6b     self.client_k
-00001730: 6579 203d 2063 6c69 656e 740a 2020 2020  ey = client.    
-00001740: 2020 2020 7365 6c66 2e5f 6861 7368 203d      self._hash =
-00001750: 2068 6173 6828 636c 6965 6e74 290a 2020   hash(client).  
-00001760: 2020 2020 2020 7365 6c66 2e77 616e 7473        self.wants
-00001770: 5f77 6861 7420 3d20 7365 7428 290a 2020  _what = set().  
-00001780: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-00001790: 7365 656e 203d 2074 696d 6528 290a 2020  seen = time().  
-000017a0: 2020 2020 2020 7365 6c66 2e76 6572 7369        self.versi
-000017b0: 6f6e 7320 3d20 7665 7273 696f 6e73 206f  ons = versions o
-000017c0: 7220 7b7d 0a0a 2020 2020 6465 6620 5f5f  r {}..    def __
-000017d0: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
-000017e0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-000017f0: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
-00001800: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
-00001810: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
-00001820: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
-00001830: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-00001840: 7374 616e 6365 286f 7468 6572 2c20 436c  stance(other, Cl
-00001850: 6965 6e74 5374 6174 6529 3a0a 2020 2020  ientState):.    
-00001860: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00001870: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
-00001880: 7572 6e20 7365 6c66 2e63 6c69 656e 745f  urn self.client_
-00001890: 6b65 7920 3d3d 206f 7468 6572 2e63 6c69  key == other.cli
-000018a0: 656e 745f 6b65 790a 0a20 2020 2064 6566  ent_key..    def
-000018b0: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
-000018c0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-000018d0: 7265 7475 726e 2066 223c 436c 6965 6e74  return f"<Client
-000018e0: 207b 7365 6c66 2e63 6c69 656e 745f 6b65   {self.client_ke
-000018f0: 7921 727d 3e22 0a0a 2020 2020 6465 6620  y!r}>"..    def 
-00001900: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
-00001910: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-00001920: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
-00001930: 5f6b 6579 0a0a 2020 2020 6465 6620 5f74  _key..    def _t
-00001940: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
-00001950: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
-00001960: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
-00001970: 3d20 2829 2920 2d3e 2064 6963 743a 0a20  = ()) -> dict:. 
-00001980: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
-00001990: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
-000019a0: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
-000019b0: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
-000019c0: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
-000019d0: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
-000019e0: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
-000019f0: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
-00001a00: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-00001a10: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00001a20: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
-00001a30: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
-00001a40: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
-00001a50: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
-00001a60: 5f64 6963 740a 2020 2020 2020 2020 5461  _dict.        Ta
-00001a70: 736b 5374 6174 652e 5f74 6f5f 6469 6374  skState._to_dict
-00001a80: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00001a90: 2020 2020 2072 6574 7572 6e20 7265 6375       return recu
-00001aa0: 7273 6976 655f 746f 5f64 6963 7428 0a20  rsive_to_dict(. 
-00001ab0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00001ac0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00001ad0: 6c75 6465 3d73 6574 2865 7863 6c75 6465  lude=set(exclude
-00001ae0: 2920 7c20 7b22 7665 7273 696f 6e73 227d  ) | {"versions"}
-00001af0: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
-00001b00: 650a 2020 2020 2020 2020 2020 2020 6d65  e.            me
-00001b10: 6d62 6572 733d 5472 7565 2c0a 2020 2020  mbers=True,.    
-00001b20: 2020 2020 290a 0a0a 636c 6173 7320 4d65      )...class Me
-00001b30: 6d6f 7279 5374 6174 653a 0a20 2020 2022  moryState:.    "
-00001b40: 2222 4d65 6d6f 7279 2072 6561 6469 6e67  ""Memory reading
-00001b50: 7320 6f6e 2061 2077 6f72 6b65 7220 6f72  s on a worker or
-00001b60: 206f 6e20 7468 6520 7768 6f6c 6520 636c   on the whole cl
-00001b70: 7573 7465 722e 0a0a 2020 2020 5365 6520  uster...    See 
-00001b80: 3a64 6f63 3a60 776f 726b 6572 2d6d 656d  :doc:`worker-mem
-00001b90: 6f72 7960 2e0a 0a20 2020 2041 7474 7269  ory`...    Attri
-00001ba0: 6275 7465 7320 2f20 7072 6f70 6572 7469  butes / properti
-00001bb0: 6573 3a0a 0a20 2020 206d 616e 6167 6564  es:..    managed
-00001bc0: 5f74 6f74 616c 0a20 2020 2020 2020 2053  _total.        S
-00001bd0: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
-00001be0: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
-00001bf0: 2061 6c6c 2064 6173 6b20 6b65 7973 2068   all dask keys h
-00001c00: 656c 6420 6279 2074 6865 2077 6f72 6b65  eld by the worke
-00001c10: 7220 696e 206d 656d 6f72 792c 0a20 2020  r in memory,.   
-00001c20: 2020 2020 2070 6c75 7320 6e75 6d62 6572       plus number
-00001c30: 206f 6620 6279 7465 7320 7370 696c 6c65   of bytes spille
-00001c40: 6420 746f 2064 6973 6b0a 0a20 2020 206d  d to disk..    m
-00001c50: 616e 6167 6564 0a20 2020 2020 2020 2053  anaged.        S
-00001c60: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
-00001c70: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
-00001c80: 2074 6865 2064 6173 6b20 6b65 7973 2068   the dask keys h
-00001c90: 656c 6420 696e 2052 414d 2e20 4e6f 7465  eld in RAM. Note
-00001ca0: 2074 6861 7420 7468 6973 206d 6179 0a20   that this may. 
-00001cb0: 2020 2020 2020 2062 6520 696e 6163 6375         be inaccu
-00001cc0: 7261 7465 2c20 7768 6963 6820 6d61 7920  rate, which may 
-00001cd0: 6361 7573 6520 696e 6163 6375 7261 7465  cause inaccurate
-00001ce0: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
-00001cf0: 7920 2873 6565 2062 656c 6f77 292e 0a0a  y (see below)...
-00001d00: 2020 2020 7370 696c 6c65 640a 2020 2020      spilled.    
-00001d10: 2020 2020 4e75 6d62 6572 206f 6620 6279      Number of by
-00001d20: 7465 7320 2066 6f72 2074 6865 2064 6173  tes  for the das
-00001d30: 6b20 6b65 7973 2073 7069 6c6c 6564 2074  k keys spilled t
-00001d40: 6f20 7468 6520 6861 7264 2064 7269 7665  o the hard drive
-00001d50: 2e0a 2020 2020 2020 2020 4e6f 7465 2074  ..        Note t
-00001d60: 6861 7420 7468 6973 2069 7320 7468 6520  hat this is the 
-00001d70: 7369 7a65 206f 6e20 6469 736b 3b20 7369  size on disk; si
-00001d80: 7a65 2069 6e20 6d65 6d6f 7279 206d 6179  ze in memory may
-00001d90: 2062 6520 6469 6666 6572 656e 7420 6475   be different du
-00001da0: 6520 746f 0a20 2020 2020 2020 2063 6f6d  e to.        com
-00001db0: 7072 6573 7369 6f6e 2061 6e64 2069 6e61  pression and ina
-00001dc0: 6363 7572 6163 6965 7320 696e 2073 697a  ccuracies in siz
-00001dd0: 656f 6628 292e 2049 6e20 6f74 6865 7220  eof(). In other 
-00001de0: 776f 7264 732c 2067 6976 656e 2074 6865  words, given the
-00001df0: 2073 616d 6520 6b65 7973 2c0a 2020 2020   same keys,.    
-00001e00: 2020 2020 276d 616e 6167 6564 2720 7769      'managed' wi
-00001e10: 6c6c 2063 6861 6e67 6520 6465 7065 6e64  ll change depend
-00001e20: 696e 6720 6f6e 2074 6865 206b 6579 7320  ing on the keys 
-00001e30: 6265 696e 6720 696e 206d 656d 6f72 7920  being in memory 
-00001e40: 6f72 2073 7069 6c6c 6564 2e0a 0a20 2020  or spilled...   
-00001e50: 2070 726f 6365 7373 0a20 2020 2020 2020   process.       
-00001e60: 2054 6f74 616c 2052 5353 206d 656d 6f72   Total RSS memor
-00001e70: 7920 6d65 6173 7572 6564 2062 7920 7468  y measured by th
-00001e80: 6520 4f53 206f 6e20 7468 6520 776f 726b  e OS on the work
-00001e90: 6572 2070 726f 6365 7373 2e0a 2020 2020  er process..    
-00001ea0: 2020 2020 5468 6973 2069 7320 616c 7761      This is alwa
-00001eb0: 7973 2065 7861 6374 6c79 2065 7175 616c  ys exactly equal
-00001ec0: 2074 6f20 6d61 6e61 6765 6420 2b20 756e   to managed + un
-00001ed0: 6d61 6e61 6765 642e 0a0a 2020 2020 756e  managed...    un
-00001ee0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
-00001ef0: 7072 6f63 6573 7320 2d20 6d61 6e61 6765  process - manage
-00001f00: 642e 2054 6869 7320 6973 2074 6865 2073  d. This is the s
-00001f10: 756d 206f 660a 0a20 2020 2020 2020 202d  um of..        -
-00001f20: 2050 7974 686f 6e20 696e 7465 7270 7265   Python interpre
-00001f30: 7465 7220 616e 6420 6d6f 6475 6c65 730a  ter and modules.
-00001f40: 2020 2020 2020 2020 2d20 676c 6f62 616c          - global
-00001f50: 2076 6172 6961 626c 6573 0a20 2020 2020   variables.     
-00001f60: 2020 202d 206d 656d 6f72 7920 7465 6d70     - memory temp
-00001f70: 6f72 6172 696c 7920 616c 6c6f 6361 7465  orarily allocate
-00001f80: 6420 6279 2074 6865 2064 6173 6b20 7461  d by the dask ta
-00001f90: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
-00001fa0: 7265 6e74 6c79 2072 756e 6e69 6e67 0a20  rently running. 
-00001fb0: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
-00001fc0: 6672 6167 6d65 6e74 6174 696f 6e0a 2020  fragmentation.  
-00001fd0: 2020 2020 2020 2d20 6d65 6d6f 7279 206c        - memory l
-00001fe0: 6561 6b73 0a20 2020 2020 2020 202d 206d  eaks.        - m
-00001ff0: 656d 6f72 7920 6e6f 7420 7965 7420 6761  emory not yet ga
-00002000: 7262 6167 6520 636f 6c6c 6563 7465 640a  rbage collected.
-00002010: 2020 2020 2020 2020 2d20 6d65 6d6f 7279          - memory
-00002020: 206e 6f74 2079 6574 2066 7265 6528 2927   not yet free()'
-00002030: 6420 6279 2074 6865 2050 7974 686f 6e20  d by the Python 
-00002040: 6d65 6d6f 7279 206d 616e 6167 6572 2074  memory manager t
-00002050: 6f20 7468 6520 4f53 0a0a 2020 2020 756e  o the OS..    un
-00002060: 6d61 6e61 6765 645f 6f6c 640a 2020 2020  managed_old.    
-00002070: 2020 2020 4d69 6e69 6d75 6d20 6f66 2074      Minimum of t
-00002080: 6865 2027 756e 6d61 6e61 6765 6427 206d  he 'unmanaged' m
-00002090: 6561 7375 7265 7320 6f76 6572 2074 6865  easures over the
-000020a0: 206c 6173 740a 2020 2020 2020 2020 6060   last.        ``
-000020b0: 6469 7374 7269 6275 7465 642e 6d65 6d6f  distributed.memo
-000020c0: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-000020d0: 2d74 696d 6560 6020 7365 636f 6e64 730a  -time`` seconds.
-000020e0: 0a20 2020 2075 6e6d 616e 6167 6564 5f72  .    unmanaged_r
-000020f0: 6563 656e 740a 2020 2020 2020 2020 756e  ecent.        un
-00002100: 6d61 6e61 6765 6420 2d20 756e 6d61 6e61  managed - unmana
-00002110: 6765 645f 6f6c 643b 2069 6e20 6f74 6865  ged_old; in othe
-00002120: 7220 776f 7264 7320 7072 6f63 6573 7320  r words process 
-00002130: 6d65 6d6f 7279 2074 6861 7420 6861 7320  memory that has 
-00002140: 6265 656e 2072 6563 656e 746c 790a 2020  been recently.  
-00002150: 2020 2020 2020 616c 6c6f 6361 7465 6420        allocated 
-00002160: 6275 7420 6973 206e 6f74 2061 6363 6f75  but is not accou
-00002170: 6e74 6564 2066 6f72 2062 7920 6461 736b  nted for by dask
-00002180: 3b20 686f 7065 6675 6c6c 7920 6974 2773  ; hopefully it's
-00002190: 206d 6f73 746c 7920 6120 7465 6d70 6f72   mostly a tempor
-000021a0: 6172 790a 2020 2020 2020 2020 7370 696b  ary.        spik
-000021b0: 652e 0a0a 2020 2020 6f70 7469 6d69 7374  e...    optimist
-000021c0: 6963 0a20 2020 2020 2020 206d 616e 6167  ic.        manag
-000021d0: 6564 202b 2075 6e6d 616e 6167 6564 5f6f  ed + unmanaged_o
-000021e0: 6c64 3b20 696e 206f 7468 6572 2077 6f72  ld; in other wor
-000021f0: 6473 2074 6865 206d 656d 6f72 7920 6865  ds the memory he
-00002200: 6c64 206c 6f6e 672d 7465 726d 2062 790a  ld long-term by.
-00002210: 2020 2020 2020 2020 7468 6520 7072 6f63          the proc
-00002220: 6573 7320 756e 6465 7220 7468 6520 686f  ess under the ho
-00002230: 7065 6675 6c20 6173 7375 6d70 7469 6f6e  peful assumption
-00002240: 2074 6861 7420 616c 6c20 756e 6d61 6e61   that all unmana
-00002250: 6765 645f 7265 6365 6e74 206d 656d 6f72  ged_recent memor
-00002260: 7920 6973 2061 0a20 2020 2020 2020 2074  y is a.        t
-00002270: 656d 706f 7261 7279 2073 7069 6b65 0a20  emporary spike. 
-00002280: 2020 2022 2222 0a0a 2020 2020 7072 6f63     """..    proc
-00002290: 6573 733a 2069 6e74 0a20 2020 2075 6e6d  ess: int.    unm
-000022a0: 616e 6167 6564 5f6f 6c64 3a20 696e 740a  anaged_old: int.
-000022b0: 2020 2020 6d61 6e61 6765 643a 2069 6e74      managed: int
-000022c0: 0a20 2020 2073 7069 6c6c 6564 3a20 696e  .    spilled: in
-000022d0: 740a 0a20 2020 205f 5f73 6c6f 7473 5f5f  t..    __slots__
-000022e0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
-000022f0: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
-00002300: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
-00002310: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00002320: 2020 202a 2c0a 2020 2020 2020 2020 7072     *,.        pr
-00002330: 6f63 6573 733a 2069 6e74 2c0a 2020 2020  ocess: int,.    
-00002340: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
-00002350: 643a 2069 6e74 2c0a 2020 2020 2020 2020  d: int,.        
-00002360: 6d61 6e61 6765 643a 2069 6e74 2c0a 2020  managed: int,.  
-00002370: 2020 2020 2020 7370 696c 6c65 643a 2069        spilled: i
-00002380: 6e74 2c0a 2020 2020 293a 0a20 2020 2020  nt,.    ):.     
-00002390: 2020 2023 2053 6f6d 6520 6461 7461 2061     # Some data a
-000023a0: 7272 6976 6573 2077 6974 6820 7468 6520  rrives with the 
-000023b0: 6865 6172 7462 6561 742c 2073 6f6d 6520  heartbeat, some 
-000023c0: 6f74 6865 7220 6172 7269 7665 7320 696e  other arrives in
-000023d0: 2072 6561 6c74 696d 6520 6173 2074 6865   realtime as the
-000023e0: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
-000023f0: 2070 726f 6772 6573 732e 2041 6c73 6f2c   progress. Also,
-00002400: 2073 697a 656f 6628 2920 6973 206e 6f74   sizeof() is not
-00002410: 2067 7561 7261 6e74 6565 6420 746f 2072   guaranteed to r
-00002420: 6574 7572 6e20 636f 7272 6563 7420 7265  eturn correct re
-00002430: 7375 6c74 732e 0a20 2020 2020 2020 2023  sults..        #
-00002440: 2054 6869 7320 6361 6e20 6361 7573 6520   This can cause 
-00002450: 676c 6974 6368 6573 2077 6865 7265 2061  glitches where a
-00002460: 2070 6172 7469 616c 206d 6561 7375 7265   partial measure
-00002470: 2069 7320 6c61 7267 6572 2074 6861 6e20   is larger than 
-00002480: 7468 6520 7768 6f6c 652c 2073 6f0a 2020  the whole, so.  
-00002490: 2020 2020 2020 2320 7765 206e 6565 6420        # we need 
-000024a0: 746f 2066 6f72 6365 2061 6c6c 206e 756d  to force all num
-000024b0: 6265 7273 2074 6f20 6164 6420 7570 2065  bers to add up e
-000024c0: 7861 6374 6c79 2062 7920 6465 6669 6e69  xactly by defini
-000024d0: 7469 6f6e 2e0a 2020 2020 2020 2020 7365  tion..        se
-000024e0: 6c66 2e70 726f 6365 7373 203d 2070 726f  lf.process = pro
-000024f0: 6365 7373 0a20 2020 2020 2020 2073 656c  cess.        sel
-00002500: 662e 6d61 6e61 6765 6420 3d20 6d69 6e28  f.managed = min(
-00002510: 7365 6c66 2e70 726f 6365 7373 2c20 6d61  self.process, ma
-00002520: 6e61 6765 6429 0a20 2020 2020 2020 2073  naged).        s
-00002530: 656c 662e 7370 696c 6c65 6420 3d20 7370  elf.spilled = sp
-00002540: 696c 6c65 640a 2020 2020 2020 2020 2320  illed.        # 
-00002550: 5375 6274 7261 6374 696f 6e73 2062 6574  Subtractions bet
-00002560: 7765 656e 2075 6e73 6967 6e65 6420 696e  ween unsigned in
-00002570: 7473 2067 7561 7261 6e74 6565 6420 6279  ts guaranteed by
-00002580: 2063 6f6e 7374 7275 6374 696f 6e20 746f   construction to
-00002590: 2062 6520 3e3d 2030 0a20 2020 2020 2020   be >= 0.       
-000025a0: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
-000025b0: 6f6c 6420 3d20 6d69 6e28 756e 6d61 6e61  old = min(unmana
-000025c0: 6765 645f 6f6c 642c 2070 726f 6365 7373  ged_old, process
-000025d0: 202d 2073 656c 662e 6d61 6e61 6765 6429   - self.managed)
-000025e0: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
-000025f0: 686f 640a 2020 2020 6465 6620 7375 6d28  hod.    def sum(
-00002600: 2a69 6e66 6f73 3a20 4d65 6d6f 7279 5374  *infos: MemorySt
-00002610: 6174 6529 202d 3e20 4d65 6d6f 7279 5374  ate) -> MemorySt
-00002620: 6174 653a 0a20 2020 2020 2020 2070 726f  ate:.        pro
-00002630: 6365 7373 203d 2030 0a20 2020 2020 2020  cess = 0.       
-00002640: 2075 6e6d 616e 6167 6564 5f6f 6c64 203d   unmanaged_old =
-00002650: 2030 0a20 2020 2020 2020 206d 616e 6167   0.        manag
-00002660: 6564 203d 2030 0a20 2020 2020 2020 2073  ed = 0.        s
-00002670: 7069 6c6c 6564 203d 2030 0a20 2020 2020  pilled = 0.     
-00002680: 2020 2066 6f72 206d 7320 696e 2069 6e66     for ms in inf
-00002690: 6f73 3a0a 2020 2020 2020 2020 2020 2020  os:.            
-000026a0: 7072 6f63 6573 7320 2b3d 206d 732e 7072  process += ms.pr
-000026b0: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
-000026c0: 2020 756e 6d61 6e61 6765 645f 6f6c 6420    unmanaged_old 
-000026d0: 2b3d 206d 732e 756e 6d61 6e61 6765 645f  += ms.unmanaged_
-000026e0: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
-000026f0: 7370 696c 6c65 6420 2b3d 206d 732e 7370  spilled += ms.sp
-00002700: 696c 6c65 640a 2020 2020 2020 2020 2020  illed.          
-00002710: 2020 6d61 6e61 6765 6420 2b3d 206d 732e    managed += ms.
-00002720: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
-00002730: 7265 7475 726e 204d 656d 6f72 7953 7461  return MemorySta
-00002740: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-00002750: 7072 6f63 6573 733d 7072 6f63 6573 732c  process=process,
-00002760: 0a20 2020 2020 2020 2020 2020 2075 6e6d  .            unm
-00002770: 616e 6167 6564 5f6f 6c64 3d75 6e6d 616e  anaged_old=unman
-00002780: 6167 6564 5f6f 6c64 2c0a 2020 2020 2020  aged_old,.      
-00002790: 2020 2020 2020 6d61 6e61 6765 643d 6d61        managed=ma
-000027a0: 6e61 6765 642c 0a20 2020 2020 2020 2020  naged,.         
-000027b0: 2020 2073 7069 6c6c 6564 3d73 7069 6c6c     spilled=spill
-000027c0: 6564 2c0a 2020 2020 2020 2020 290a 0a20  ed,.        ).. 
-000027d0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-000027e0: 2064 6566 206d 616e 6167 6564 5f74 6f74   def managed_tot
-000027f0: 616c 2873 656c 6629 202d 3e20 696e 743a  al(self) -> int:
-00002800: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002810: 7365 6c66 2e6d 616e 6167 6564 202b 2073  self.managed + s
-00002820: 656c 662e 7370 696c 6c65 640a 0a20 2020  elf.spilled..   
-00002830: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00002840: 6566 2075 6e6d 616e 6167 6564 2873 656c  ef unmanaged(sel
-00002850: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-00002860: 2020 2023 2054 6869 7320 6973 206e 6576     # This is nev
-00002870: 6572 206e 6567 6174 6976 6520 7468 616e  er negative than
-00002880: 6b73 2074 6f20 5f5f 696e 6974 5f5f 0a20  ks to __init__. 
-00002890: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000028a0: 6c66 2e70 726f 6365 7373 202d 2073 656c  lf.process - sel
-000028b0: 662e 6d61 6e61 6765 640a 0a20 2020 2040  f.managed..    @
-000028c0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000028d0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-000028e0: 7428 7365 6c66 2920 2d3e 2069 6e74 3a0a  t(self) -> int:.
-000028f0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-00002900: 7320 6e65 7665 7220 6e65 6761 7469 7665  s never negative
-00002910: 2074 6861 6e6b 7320 746f 205f 5f69 6e69   thanks to __ini
-00002920: 745f 5f0a 2020 2020 2020 2020 7265 7475  t__.        retu
-00002930: 726e 2073 656c 662e 7072 6f63 6573 7320  rn self.process 
-00002940: 2d20 7365 6c66 2e6d 616e 6167 6564 202d  - self.managed -
-00002950: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
-00002960: 6f6c 640a 0a20 2020 2040 7072 6f70 6572  old..    @proper
-00002970: 7479 0a20 2020 2064 6566 206f 7074 696d  ty.    def optim
-00002980: 6973 7469 6328 7365 6c66 2920 2d3e 2069  istic(self) -> i
-00002990: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
-000029a0: 726e 2073 656c 662e 6d61 6e61 6765 6420  rn self.managed 
-000029b0: 2b20 7365 6c66 2e75 6e6d 616e 6167 6564  + self.unmanaged
-000029c0: 5f6f 6c64 0a0a 2020 2020 4070 726f 7065  _old..    @prope
-000029d0: 7274 790a 2020 2020 6465 6620 6d61 6e61  rty.    def mana
-000029e0: 6765 645f 696e 5f6d 656d 6f72 7928 7365  ged_in_memory(se
-000029f0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-00002a00: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-00002a10: 6e28 226d 616e 6167 6564 5f69 6e5f 6d65  n("managed_in_me
-00002a20: 6d6f 7279 2068 6173 2062 6565 6e20 7265  mory has been re
-00002a30: 6e61 6d65 6420 746f 206d 616e 6167 6564  named to managed
-00002a40: 222c 2046 7574 7572 6557 6172 6e69 6e67  ", FutureWarning
-00002a50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00002a60: 2073 656c 662e 6d61 6e61 6765 640a 0a20   self.managed.. 
-00002a70: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00002a80: 2064 6566 206d 616e 6167 6564 5f73 7069   def managed_spi
-00002a90: 6c6c 6564 2873 656c 6629 202d 3e20 696e  lled(self) -> in
-00002aa0: 743a 0a20 2020 2020 2020 2077 6172 6e69  t:.        warni
-00002ab0: 6e67 732e 7761 726e 2822 6d61 6e61 6765  ngs.warn("manage
-00002ac0: 645f 7370 696c 6c65 6420 6861 7320 6265  d_spilled has be
-00002ad0: 656e 2072 656e 616d 6564 2074 6f20 7370  en renamed to sp
-00002ae0: 696c 6c65 6422 2c20 4675 7475 7265 5761  illed", FutureWa
-00002af0: 726e 696e 6729 0a20 2020 2020 2020 2072  rning).        r
-00002b00: 6574 7572 6e20 7365 6c66 2e73 7069 6c6c  eturn self.spill
-00002b10: 6564 0a0a 2020 2020 6465 6620 5f5f 7265  ed..    def __re
-00002b20: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
-00002b30: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-00002b40: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00002b50: 6622 5072 6f63 6573 7320 6d65 6d6f 7279  f"Process memory
-00002b60: 2028 5253 5329 2020 3a20 7b66 6f72 6d61   (RSS)  : {forma
-00002b70: 745f 6279 7465 7328 7365 6c66 2e70 726f  t_bytes(self.pro
-00002b80: 6365 7373 297d 5c6e 220a 2020 2020 2020  cess)}\n".      
-00002b90: 2020 2020 2020 6622 2020 2d20 6d61 6e61        f"  - mana
-00002ba0: 6765 6420 6279 2044 6173 6b20 2020 3a20  ged by Dask   : 
-00002bb0: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
-00002bc0: 6c66 2e6d 616e 6167 6564 297d 5c6e 220a  lf.managed)}\n".
-00002bd0: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
-00002be0: 2d20 756e 6d61 6e61 6765 6420 286f 6c64  - unmanaged (old
-00002bf0: 2920 2020 3a20 7b66 6f72 6d61 745f 6279  )   : {format_by
-00002c00: 7465 7328 7365 6c66 2e75 6e6d 616e 6167  tes(self.unmanag
-00002c10: 6564 5f6f 6c64 297d 5c6e 220a 2020 2020  ed_old)}\n".    
-00002c20: 2020 2020 2020 2020 6622 2020 2d20 756e          f"  - un
-00002c30: 6d61 6e61 6765 6420 2872 6563 656e 7429  managed (recent)
-00002c40: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
-00002c50: 7365 6c66 2e75 6e6d 616e 6167 6564 5f72  self.unmanaged_r
-00002c60: 6563 656e 7429 7d5c 6e22 0a20 2020 2020  ecent)}\n".     
-00002c70: 2020 2020 2020 2066 2253 7069 6c6c 6564         f"Spilled
-00002c80: 2074 6f20 6469 736b 2020 2020 2020 203a   to disk       :
-00002c90: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
-00002ca0: 656c 662e 7370 696c 6c65 6429 7d5c 6e22  elf.spilled)}\n"
-00002cb0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00002cc0: 6465 6620 5f74 6f5f 6469 6374 2873 656c  def _to_dict(sel
-00002cd0: 662c 202a 2c20 6578 636c 7564 653a 2043  f, *, exclude: C
-00002ce0: 6f6e 7461 696e 6572 5b73 7472 5d20 3d20  ontainer[str] = 
-00002cf0: 2829 2920 2d3e 2064 6963 743a 0a20 2020  ()) -> dict:.   
-00002d00: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
-00002d10: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
-00002d20: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
-00002d30: 7075 7270 6f73 6573 2e0a 0a20 2020 2020  purposes...     
-00002d40: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-00002d50: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00002d60: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
-00002d70: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
-00002d80: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
-00002d90: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
-00002da0: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
-00002db0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00002dc0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-00002dd0: 2020 2020 6b3a 2067 6574 6174 7472 2873      k: getattr(s
-00002de0: 656c 662c 206b 290a 2020 2020 2020 2020  elf, k).        
-00002df0: 2020 2020 666f 7220 6b20 696e 2064 6972      for k in dir
-00002e00: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
-00002e10: 2020 2069 6620 6e6f 7420 6b2e 7374 6172     if not k.star
-00002e20: 7473 7769 7468 2822 5f22 290a 2020 2020  tswith("_").    
-00002e30: 2020 2020 2020 2020 616e 6420 6b20 6e6f          and k no
-00002e40: 7420 696e 207b 2273 756d 222c 2022 6d61  t in {"sum", "ma
-00002e50: 6e61 6765 645f 696e 5f6d 656d 6f72 7922  naged_in_memory"
-00002e60: 2c20 226d 616e 6167 6564 5f73 7069 6c6c  , "managed_spill
-00002e70: 6564 227d 0a20 2020 2020 2020 207d 0a0a  ed"}.        }..
-00002e80: 0a63 6c61 7373 2057 6f72 6b65 7253 7461  .class WorkerSta
-00002e90: 7465 3a0a 2020 2020 2222 2241 2073 696d  te:.    """A sim
-00002ea0: 706c 6520 6f62 6a65 6374 2068 6f6c 6469  ple object holdi
-00002eb0: 6e67 2069 6e66 6f72 6d61 7469 6f6e 2061  ng information a
-00002ec0: 626f 7574 2061 2077 6f72 6b65 722e 0a0a  bout a worker...
-00002ed0: 2020 2020 4e6f 7420 746f 2062 6520 636f      Not to be co
-00002ee0: 6e66 7573 6564 2077 6974 6820 3a63 6c61  nfused with :cla
-00002ef0: 7373 3a60 6469 7374 7269 6275 7465 642e  ss:`distributed.
-00002f00: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
-00002f10: 6869 6e65 2e57 6f72 6b65 7253 7461 7465  hine.WorkerState
-00002f20: 602e 0a20 2020 2022 2222 0a0a 2020 2020  `..    """..    
-00002f30: 233a 2054 6869 7320 776f 726b 6572 2773  #: This worker's
-00002f40: 2075 6e69 7175 6520 6b65 792e 2054 6869   unique key. Thi
-00002f50: 7320 6361 6e20 6265 2069 7473 2063 6f6e  s can be its con
-00002f60: 6e65 6374 6564 2061 6464 7265 7373 0a20  nected address. 
-00002f70: 2020 2023 3a20 2873 7563 6820 6173 2060     #: (such as `
-00002f80: 6022 7463 703a 2f2f 3132 372e 302e 302e  `"tcp://127.0.0.
-00002f90: 313a 3838 3931 2260 6029 206f 7220 616e  1:8891"``) or an
-00002fa0: 2061 6c69 6173 2028 7375 6368 2061 7320   alias (such as 
-00002fb0: 6060 2261 6c69 6365 2260 6029 2e0a 2020  ``"alice"``)..  
-00002fc0: 2020 6164 6472 6573 733a 2073 7472 0a0a    address: str..
-00002fd0: 2020 2020 7069 643a 2069 6e74 0a20 2020      pid: int.   
-00002fe0: 206e 616d 653a 2048 6173 6861 626c 650a   name: Hashable.
-00002ff0: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
-00003000: 6572 206f 6620 4350 5520 7468 7265 6164  er of CPU thread
-00003010: 7320 6d61 6465 2061 7661 696c 6162 6c65  s made available
-00003020: 206f 6e20 7468 6973 2077 6f72 6b65 720a   on this worker.
-00003030: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
-00003040: 740a 0a20 2020 2023 3a20 4d65 6d6f 7279  t..    #: Memory
-00003050: 2061 7661 696c 6162 6c65 2074 6f20 7468   available to th
-00003060: 6520 776f 726b 6572 2c20 696e 2062 7974  e worker, in byt
-00003070: 6573 0a20 2020 206d 656d 6f72 795f 6c69  es.    memory_li
-00003080: 6d69 743a 2069 6e74 0a0a 2020 2020 6c6f  mit: int..    lo
-00003090: 6361 6c5f 6469 7265 6374 6f72 793a 2073  cal_directory: s
-000030a0: 7472 0a20 2020 2073 6572 7669 6365 733a  tr.    services:
-000030b0: 2064 6963 745b 7374 722c 2069 6e74 5d0a   dict[str, int].
-000030c0: 0a20 2020 2023 3a20 4f75 7470 7574 206f  .    #: Output o
-000030d0: 6620 3a6d 6574 683a 6064 6973 7472 6962  f :meth:`distrib
-000030e0: 7574 6564 2e76 6572 7369 6f6e 732e 6765  uted.versions.ge
-000030f0: 745f 7665 7273 696f 6e73 6020 6f6e 2074  t_versions` on t
-00003100: 6865 2077 6f72 6b65 720a 2020 2020 7665  he worker.    ve
-00003110: 7273 696f 6e73 3a20 6469 6374 5b73 7472  rsions: dict[str
-00003120: 2c20 416e 795d 0a0a 2020 2020 233a 2041  , Any]..    #: A
-00003130: 6464 7265 7373 206f 6620 7468 6520 6173  ddress of the as
-00003140: 736f 6369 6174 6564 203a 636c 6173 733a  sociated :class:
-00003150: 607e 6469 7374 7269 6275 7465 642e 6e61  `~distributed.na
-00003160: 6e6e 792e 4e61 6e6e 7960 2c20 6966 2070  nny.Nanny`, if p
-00003170: 7265 7365 6e74 0a20 2020 206e 616e 6e79  resent.    nanny
-00003180: 3a20 7374 720a 0a20 2020 2023 3a20 5265  : str..    #: Re
-00003190: 6164 2d6f 6e6c 7920 776f 726b 6572 2073  ad-only worker s
-000031a0: 7461 7475 732c 2073 796e 6365 6420 6f6e  tatus, synced on
-000031b0: 6520 7761 7920 6672 6f6d 2074 6865 2072  e way from the r
-000031c0: 656d 6f74 6520 576f 726b 6572 206f 626a  emote Worker obj
-000031d0: 6563 740a 2020 2020 7374 6174 7573 3a20  ect.    status: 
-000031e0: 5374 6174 7573 0a0a 2020 2020 233a 2043  Status..    #: C
-000031f0: 6163 6865 6420 6861 7368 206f 6620 3a61  ached hash of :a
-00003200: 7474 723a 607e 576f 726b 6572 5374 6174  ttr:`~WorkerStat
-00003210: 652e 6164 6472 6573 7360 0a20 2020 205f  e.address`.    _
-00003220: 6861 7368 3a20 696e 740a 0a20 2020 2023  hash: int..    #
-00003230: 3a20 5468 6520 746f 7461 6c20 6d65 6d6f  : The total memo
-00003240: 7279 2073 697a 652c 2069 6e20 6279 7465  ry size, in byte
-00003250: 732c 2075 7365 6420 6279 2074 6865 2074  s, used by the t
-00003260: 6173 6b73 2074 6869 7320 776f 726b 6572  asks this worker
-00003270: 2068 6f6c 6473 2069 6e20 6d65 6d6f 7279   holds in memory
-00003280: 0a20 2020 2023 3a20 2869 2e65 2e20 7468  .    #: (i.e. th
-00003290: 6520 7461 736b 7320 696e 2074 6869 7320  e tasks in this 
-000032a0: 776f 726b 6572 2773 203a 6174 7472 3a60  worker's :attr:`
-000032b0: 7e57 6f72 6b65 7253 7461 7465 2e68 6173  ~WorkerState.has
-000032c0: 5f77 6861 7460 292e 0a20 2020 206e 6279  _what`)..    nby
-000032d0: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
-000032e0: 2057 6f72 6b65 7220 6d65 6d6f 7279 2075   Worker memory u
-000032f0: 6e6b 6e6f 776e 2074 6f20 7468 6520 776f  nknown to the wo
-00003300: 726b 6572 2c20 696e 2062 7974 6573 2c20  rker, in bytes, 
-00003310: 7768 6963 6820 6861 7320 6265 656e 2074  which has been t
-00003320: 6865 7265 2066 6f72 206d 6f72 6520 7468  here for more th
-00003330: 616e 0a20 2020 2023 3a20 3330 2073 6563  an.    #: 30 sec
-00003340: 6f6e 6473 2e20 5365 6520 3a63 6c61 7373  onds. See :class
-00003350: 3a60 4d65 6d6f 7279 5374 6174 6560 2e0a  :`MemoryState`..
-00003360: 2020 2020 5f6d 656d 6f72 795f 756e 6d61      _memory_unma
-00003370: 6e61 6765 645f 6f6c 643a 2069 6e74 0a0a  naged_old: int..
-00003380: 2020 2020 233a 2048 6973 746f 7279 206f      #: History o
-00003390: 6620 7468 6520 6c61 7374 2033 3020 7365  f the last 30 se
-000033a0: 636f 6e64 7327 2077 6f72 7468 206f 6620  conds' worth of 
-000033b0: 756e 6d61 6e61 6765 6420 6d65 6d6f 7279  unmanaged memory
-000033c0: 2e20 5573 6564 2074 6f20 6469 6666 6572  . Used to differ
-000033d0: 656e 7469 6174 650a 2020 2020 233a 2062  entiate.    #: b
-000033e0: 6574 7765 656e 2022 6f6c 6422 2061 6e64  etween "old" and
-000033f0: 2022 6e65 7722 2075 6e6d 616e 6167 6564   "new" unmanaged
-00003400: 206d 656d 6f72 792e 0a20 2020 2023 3a20   memory..    #: 
-00003410: 466f 726d 6174 3a20 6060 5b28 7469 6d65  Format: ``[(time
-00003420: 7374 616d 702c 2062 7974 6573 292c 2028  stamp, bytes), (
-00003430: 7469 6d65 7374 616d 702c 2062 7974 6573  timestamp, bytes
-00003440: 292c 202e 2e2e 5d60 600a 2020 2020 5f6d  ), ...]``.    _m
-00003450: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00003460: 6869 7374 6f72 793a 2064 6571 7565 5b74  history: deque[t
-00003470: 7570 6c65 5b66 6c6f 6174 2c20 696e 745d  uple[float, int]
-00003480: 5d0a 0a20 2020 206d 6574 7269 6373 3a20  ]..    metrics: 
-00003490: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
-000034a0: 2020 2020 233a 2054 6865 206c 6173 7420      #: The last 
-000034b0: 7469 6d65 2077 6520 7265 6365 6976 6564  time we received
-000034c0: 2061 2068 6561 7274 6265 6174 2066 726f   a heartbeat fro
-000034d0: 6d20 7468 6973 2077 6f72 6b65 722c 2069  m this worker, i
-000034e0: 6e20 6c6f 6361 6c20 7363 6865 6475 6c65  n local schedule
-000034f0: 7220 7469 6d65 2e0a 2020 2020 6c61 7374  r time..    last
-00003500: 5f73 6565 6e3a 2066 6c6f 6174 0a0a 2020  _seen: float..  
-00003510: 2020 7469 6d65 5f64 656c 6179 3a20 666c    time_delay: fl
-00003520: 6f61 740a 2020 2020 6261 6e64 7769 6474  oat.    bandwidt
-00003530: 683a 2066 6c6f 6174 0a0a 2020 2020 233a  h: float..    #:
-00003540: 2041 2073 6574 206f 6620 616c 6c20 5461   A set of all Ta
-00003550: 736b 5374 6174 6573 206f 6e20 7468 6973  skStates on this
-00003560: 2077 6f72 6b65 7220 7468 6174 2061 7265   worker that are
-00003570: 2061 6374 6f72 732e 2054 6869 7320 6f6e   actors. This on
-00003580: 6c79 2069 6e63 6c75 6465 7320 7468 6f73  ly includes thos
-00003590: 650a 2020 2020 233a 2061 6374 6f72 7320  e.    #: actors 
-000035a0: 7768 6f73 6520 7374 6174 6520 6163 7475  whose state actu
-000035b0: 616c 6c79 206c 6976 6573 206f 6e20 7468  ally lives on th
-000035c0: 6973 2077 6f72 6b65 722c 206e 6f74 2061  is worker, not a
-000035d0: 6374 6f72 7320 746f 2077 6869 6368 2074  ctors to which t
-000035e0: 6869 7320 776f 726b 6572 0a20 2020 2023  his worker.    #
-000035f0: 3a20 6861 7320 6120 7265 6665 7265 6e63  : has a referenc
-00003600: 652e 0a20 2020 2061 6374 6f72 733a 2073  e..    actors: s
-00003610: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
-00003620: 2020 2023 3a20 556e 6465 726c 7969 6e67     #: Underlying
-00003630: 2064 6174 6120 6f66 203a 6d65 7468 3a60   data of :meth:`
-00003640: 576f 726b 6572 5374 6174 652e 6861 735f  WorkerState.has_
-00003650: 7768 6174 600a 2020 2020 5f68 6173 5f77  what`.    _has_w
-00003660: 6861 743a 2064 6963 745b 5461 736b 5374  hat: dict[TaskSt
-00003670: 6174 652c 204e 6f6e 655d 0a0a 2020 2020  ate, None]..    
-00003680: 233a 2041 2073 6574 206f 6620 7461 736b  #: A set of task
-00003690: 7320 7468 6174 2068 6176 6520 6265 656e  s that have been
-000036a0: 2073 7562 6d69 7474 6564 2074 6f20 7468   submitted to th
-000036b0: 6973 2077 6f72 6b65 722e 204d 756c 7469  is worker. Multi
-000036c0: 706c 6520 7461 736b 7320 6d61 7920 6265  ple tasks may be
-000036d0: 0a20 2020 2023 2073 7562 6d69 7474 6564  .    # submitted
-000036e0: 2074 6f20 6120 776f 726b 6572 2069 6e20   to a worker in 
-000036f0: 6164 7661 6e63 6520 616e 6420 7468 6520  advance and the 
-00003700: 776f 726b 6572 2077 696c 6c20 7275 6e20  worker will run 
-00003710: 7468 656d 2065 7665 6e74 7561 6c6c 792c  them eventually,
-00003720: 0a20 2020 2023 2064 6570 656e 6469 6e67  .    # depending
-00003730: 206f 6e20 6974 7320 6578 6563 7574 696f   on its executio
-00003740: 6e20 7265 736f 7572 6365 7320 2862 7574  n resources (but
-00003750: 2073 6565 203a 646f 633a 6077 6f72 6b2d   see :doc:`work-
-00003760: 7374 6561 6c69 6e67 6029 2e0a 2020 2020  stealing`)..    
-00003770: 233a 0a20 2020 2023 3a20 416c 6c20 7468  #:.    #: All th
-00003780: 6520 7461 736b 7320 6865 7265 2061 7265  e tasks here are
-00003790: 2069 6e20 7468 6520 2270 726f 6365 7373   in the "process
-000037a0: 696e 6722 2073 7461 7465 2e0a 2020 2020  ing" state..    
-000037b0: 233a 2054 6869 7320 6174 7472 6962 7574  #: This attribut
-000037c0: 6520 6973 206b 6570 7420 696e 2073 796e  e is kept in syn
-000037d0: 6320 7769 7468 203a 6174 7472 3a60 5461  c with :attr:`Ta
-000037e0: 736b 5374 6174 652e 7072 6f63 6573 7369  skState.processi
-000037f0: 6e67 5f6f 6e60 2e0a 2020 2020 7072 6f63  ng_on`..    proc
-00003800: 6573 7369 6e67 3a20 7365 745b 5461 736b  essing: set[Task
-00003810: 5374 6174 655d 0a0a 2020 2020 233a 2052  State]..    #: R
-00003820: 756e 6e69 6e67 2074 6173 6b73 2074 6861  unning tasks tha
-00003830: 7420 696e 766f 6b65 6420 3a66 756e 633a  t invoked :func:
-00003840: 6064 6973 7472 6962 7574 6564 2e73 6563  `distributed.sec
-00003850: 6564 6560 0a20 2020 206c 6f6e 675f 7275  ede`.    long_ru
-00003860: 6e6e 696e 673a 2073 6574 5b54 6173 6b53  nning: set[TaskS
-00003870: 7461 7465 5d0a 0a20 2020 2023 3a20 4120  tate]..    #: A 
-00003880: 6469 6374 696f 6e61 7279 206f 6620 7461  dictionary of ta
-00003890: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
-000038a0: 7265 6e74 6c79 2062 6569 6e67 2072 756e  rently being run
-000038b0: 206f 6e20 7468 6973 2077 6f72 6b65 722e   on this worker.
-000038c0: 0a20 2020 2023 3a20 4561 6368 2074 6173  .    #: Each tas
-000038d0: 6b20 7374 6174 6520 6973 2061 7373 6f63  k state is assoc
-000038e0: 6961 7465 6420 7769 7468 2074 6865 2064  iated with the d
-000038f0: 7572 6174 696f 6e20 696e 2073 6563 6f6e  uration in secon
-00003900: 6473 2077 6869 6368 2074 6865 2074 6173  ds which the tas
-00003910: 6b20 6861 730a 2020 2020 233a 2062 6565  k has.    #: bee
-00003920: 6e20 7275 6e6e 696e 672e 0a20 2020 2065  n running..    e
-00003930: 7865 6375 7469 6e67 3a20 6469 6374 5b54  xecuting: dict[T
-00003940: 6173 6b53 7461 7465 2c20 666c 6f61 745d  askState, float]
-00003950: 0a0a 2020 2020 233a 2054 6865 2061 7661  ..    #: The ava
-00003960: 696c 6162 6c65 2072 6573 6f75 7263 6573  ilable resources
-00003970: 206f 6e20 7468 6973 2077 6f72 6b65 722c   on this worker,
-00003980: 2065 2e67 2e20 6060 7b22 4750 5522 3a20   e.g. ``{"GPU": 
-00003990: 327d 6060 2e0a 2020 2020 233a 2054 6865  2}``..    #: The
-000039a0: 7365 2061 7265 2061 6273 7472 6163 7420  se are abstract 
-000039b0: 7175 616e 7469 7469 6573 2074 6861 7420  quantities that 
-000039c0: 636f 6e73 7472 6169 6e20 6365 7274 6169  constrain certai
-000039d0: 6e20 7461 736b 7320 6672 6f6d 2072 756e  n tasks from run
-000039e0: 6e69 6e67 2061 7420 7468 650a 2020 2020  ning at the.    
-000039f0: 233a 2073 616d 6520 7469 6d65 206f 6e20  #: same time on 
-00003a00: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
-00003a10: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
-00003a20: 5b73 7472 2c20 666c 6f61 745d 0a0a 2020  [str, float]..  
-00003a30: 2020 233a 2054 6865 2073 756d 206f 6620    #: The sum of 
-00003a40: 6561 6368 2072 6573 6f75 7263 6520 7573  each resource us
-00003a50: 6564 2062 7920 616c 6c20 7461 736b 7320  ed by all tasks 
-00003a60: 616c 6c6f 6361 7465 6420 746f 2074 6869  allocated to thi
-00003a70: 7320 776f 726b 6572 2e0a 2020 2020 233a  s worker..    #:
-00003a80: 2054 6865 206e 756d 6265 7273 2069 6e20   The numbers in 
-00003a90: 7468 6973 2064 6963 7469 6f6e 6172 7920  this dictionary 
-00003aa0: 6361 6e20 6f6e 6c79 2062 6520 6c65 7373  can only be less
-00003ab0: 206f 7220 6571 7561 6c20 7468 616e 2074   or equal than t
-00003ac0: 686f 7365 2069 6e20 7468 6973 0a20 2020  hose in this.   
-00003ad0: 2023 3a20 776f 726b 6572 2773 203a 6174   #: worker's :at
-00003ae0: 7472 3a60 7e57 6f72 6b65 7253 7461 7465  tr:`~WorkerState
-00003af0: 2e72 6573 6f75 7263 6573 602e 0a20 2020  .resources`..   
-00003b00: 2075 7365 645f 7265 736f 7572 6365 733a   used_resources:
-00003b10: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
-00003b20: 5d0a 0a20 2020 2023 3a20 4172 6269 7472  ]..    #: Arbitr
-00003b30: 6172 7920 6164 6469 7469 6f6e 616c 206d  ary additional m
-00003b40: 6574 6164 6174 6120 746f 2062 6520 6164  etadata to be ad
-00003b50: 6465 6420 746f 203a 6d65 7468 3a60 7e57  ded to :meth:`~W
-00003b60: 6f72 6b65 7253 7461 7465 2e69 6465 6e74  orkerState.ident
-00003b70: 6974 7960 0a20 2020 2065 7874 7261 3a20  ity`.    extra: 
-00003b80: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
-00003b90: 2020 2020 2320 5468 6520 756e 6971 7565      # The unique
-00003ba0: 2073 6572 7665 7220 4944 2074 6869 7320   server ID this 
-00003bb0: 576f 726b 6572 5374 6174 6520 6973 2072  WorkerState is r
-00003bc0: 6566 6572 656e 6369 6e67 0a20 2020 2073  eferencing.    s
-00003bd0: 6572 7665 725f 6964 3a20 7374 720a 0a20  erver_id: str.. 
-00003be0: 2020 2023 2052 6566 6572 656e 6365 2074     # Reference t
-00003bf0: 6f20 7363 6865 6475 6c65 7220 7461 736b  o scheduler task
-00003c00: 5f67 726f 7570 730a 2020 2020 7363 6865  _groups.    sche
-00003c10: 6475 6c65 725f 7265 663a 2077 6561 6b72  duler_ref: weakr
-00003c20: 6566 2e72 6566 5b53 6368 6564 756c 6572  ef.ref[Scheduler
-00003c30: 5374 6174 655d 207c 204e 6f6e 650a 2020  State] | None.  
-00003c40: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
-00003c50: 756e 743a 2064 6566 6175 6c74 6469 6374  unt: defaultdict
-00003c60: 5b73 7472 2c20 696e 745d 0a20 2020 205f  [str, int].    _
-00003c70: 6e65 7477 6f72 6b5f 6f63 633a 2066 6c6f  network_occ: flo
-00003c80: 6174 0a20 2020 205f 6f63 6375 7061 6e63  at.    _occupanc
-00003c90: 795f 6361 6368 653a 2066 6c6f 6174 207c  y_cache: float |
-00003ca0: 204e 6f6e 650a 0a20 2020 2023 3a20 4b65   None..    #: Ke
-00003cb0: 7973 2074 6861 7420 6d61 7920 6e65 6564  ys that may need
-00003cc0: 2074 6f20 6265 2066 6574 6368 6564 2074   to be fetched t
-00003cd0: 6f20 7468 6973 2077 6f72 6b65 722c 2061  o this worker, a
-00003ce0: 6e64 2074 6865 206e 756d 6265 7220 6f66  nd the number of
-00003cf0: 2074 6173 6b73 2074 6861 7420 6e65 6564   tasks that need
-00003d00: 2074 6865 6d2e 0a20 2020 2023 3a20 416c   them..    #: Al
-00003d10: 6c20 7461 736b 7320 6172 6520 6375 7272  l tasks are curr
-00003d20: 656e 746c 7920 696e 2060 6d65 6d6f 7279  ently in `memory
-00003d30: 6020 6f6e 2061 2077 6f72 6b65 7220 6f74  ` on a worker ot
-00003d40: 6865 7220 7468 616e 2074 6869 7320 6f6e  her than this on
-00003d50: 652e 0a20 2020 2023 3a20 4d75 6368 206c  e..    #: Much l
-00003d60: 696b 6520 6070 726f 6365 7373 696e 6760  ike `processing`
-00003d70: 2c20 7468 6973 2064 6f65 7320 6e6f 7420  , this does not 
-00003d80: 6578 6163 746c 7920 7265 666c 6563 7420  exactly reflect 
-00003d90: 776f 726b 6572 2073 7461 7465 3a0a 2020  worker state:.  
-00003da0: 2020 233a 206b 6579 7320 6865 7265 206d    #: keys here m
-00003db0: 6179 2062 6520 7175 6575 6564 2074 6f20  ay be queued to 
-00003dc0: 6665 7463 682c 2069 6e20 666c 6967 6874  fetch, in flight
-00003dd0: 2c20 6f72 2061 6c72 6561 6479 2069 6e20  , or already in 
-00003de0: 6d65 6d6f 7279 0a20 2020 2023 3a20 6f6e  memory.    #: on
-00003df0: 2074 6865 2077 6f72 6b65 722e 0a20 2020   the worker..   
-00003e00: 206e 6565 6473 5f77 6861 743a 2064 6963   needs_what: dic
-00003e10: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
-00003e20: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
-00003e30: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
-00003e40: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
-00003e50: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
-00003e60: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00003e70: 2020 202a 2c0a 2020 2020 2020 2020 6164     *,.        ad
-00003e80: 6472 6573 733a 2073 7472 2c0a 2020 2020  dress: str,.    
-00003e90: 2020 2020 7374 6174 7573 3a20 5374 6174      status: Stat
-00003ea0: 7573 2c0a 2020 2020 2020 2020 7069 643a  us,.        pid:
-00003eb0: 2069 6e74 2c0a 2020 2020 2020 2020 6e61   int,.        na
-00003ec0: 6d65 3a20 6f62 6a65 6374 2c0a 2020 2020  me: object,.    
-00003ed0: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
-00003ee0: 7420 3d20 302c 0a20 2020 2020 2020 206d  t = 0,.        m
-00003ef0: 656d 6f72 795f 6c69 6d69 743a 2069 6e74  emory_limit: int
-00003f00: 2c0a 2020 2020 2020 2020 6c6f 6361 6c5f  ,.        local_
-00003f10: 6469 7265 6374 6f72 793a 2073 7472 2c0a  directory: str,.
-00003f20: 2020 2020 2020 2020 6e61 6e6e 793a 2073          nanny: s
-00003f30: 7472 2c0a 2020 2020 2020 2020 7365 7276  tr,.        serv
-00003f40: 6572 5f69 643a 2073 7472 2c0a 2020 2020  er_id: str,.    
-00003f50: 2020 2020 7365 7276 6963 6573 3a20 6469      services: di
-00003f60: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
-00003f70: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00003f80: 2020 2020 7665 7273 696f 6e73 3a20 6469      versions: di
-00003f90: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
-00003fa0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00003fb0: 2020 2020 6578 7472 613a 2064 6963 745b      extra: dict[
-00003fc0: 7374 722c 2041 6e79 5d20 7c20 4e6f 6e65  str, Any] | None
-00003fd0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00003fe0: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
-00003ff0: 6475 6c65 7253 7461 7465 207c 204e 6f6e  dulerState | Non
-00004000: 6520 3d20 4e6f 6e65 2c0a 2020 2020 293a  e = None,.    ):
-00004010: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00004020: 7276 6572 5f69 6420 3d20 7365 7276 6572  rver_id = server
-00004030: 5f69 640a 2020 2020 2020 2020 7365 6c66  _id.        self
-00004040: 2e61 6464 7265 7373 203d 2061 6464 7265  .address = addre
-00004050: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
-00004060: 7069 6420 3d20 7069 640a 2020 2020 2020  pid = pid.      
-00004070: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
-00004080: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-00004090: 6e74 6872 6561 6473 203d 206e 7468 7265  nthreads = nthre
-000040a0: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
-000040b0: 2e6d 656d 6f72 795f 6c69 6d69 7420 3d20  .memory_limit = 
-000040c0: 6d65 6d6f 7279 5f6c 696d 6974 0a20 2020  memory_limit.   
-000040d0: 2020 2020 2073 656c 662e 6c6f 6361 6c5f       self.local_
-000040e0: 6469 7265 6374 6f72 7920 3d20 6c6f 6361  directory = loca
-000040f0: 6c5f 6469 7265 6374 6f72 790a 2020 2020  l_directory.    
-00004100: 2020 2020 7365 6c66 2e73 6572 7669 6365      self.service
-00004110: 7320 3d20 7365 7276 6963 6573 206f 7220  s = services or 
-00004120: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00004130: 7665 7273 696f 6e73 203d 2076 6572 7369  versions = versi
-00004140: 6f6e 7320 6f72 207b 7d0a 2020 2020 2020  ons or {}.      
-00004150: 2020 7365 6c66 2e6e 616e 6e79 203d 206e    self.nanny = n
-00004160: 616e 6e79 0a20 2020 2020 2020 2073 656c  anny.        sel
-00004170: 662e 7374 6174 7573 203d 2073 7461 7475  f.status = statu
-00004180: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
-00004190: 6861 7368 203d 2068 6173 6828 7365 6c66  hash = hash(self
-000041a0: 2e73 6572 7665 725f 6964 290a 2020 2020  .server_id).    
-000041b0: 2020 2020 7365 6c66 2e6e 6279 7465 7320      self.nbytes 
-000041c0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-000041d0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
-000041e0: 6564 5f6f 6c64 203d 2030 0a20 2020 2020  ed_old = 0.     
-000041f0: 2020 2073 656c 662e 5f6d 656d 6f72 795f     self._memory_
-00004200: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-00004210: 7920 3d20 6465 7175 6528 290a 2020 2020  y = deque().    
-00004220: 2020 2020 7365 6c66 2e6d 6574 7269 6373      self.metrics
-00004230: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00004240: 6c66 2e6c 6173 745f 7365 656e 203d 2030  lf.last_seen = 0
-00004250: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
-00004260: 6d65 5f64 656c 6179 203d 2030 0a20 2020  me_delay = 0.   
-00004270: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00004280: 6474 6820 3d20 7061 7273 655f 6279 7465  dth = parse_byte
-00004290: 7328 6461 736b 2e63 6f6e 6669 672e 6765  s(dask.config.ge
-000042a0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-000042b0: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
-000042c0: 7468 2229 290a 2020 2020 2020 2020 7365  th")).        se
-000042d0: 6c66 2e61 6374 6f72 7320 3d20 7365 7428  lf.actors = set(
-000042e0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-000042f0: 6861 735f 7768 6174 203d 207b 7d0a 2020  has_what = {}.  
-00004300: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
-00004310: 7373 696e 6720 3d20 7365 7428 290a 2020  ssing = set().  
-00004320: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
-00004330: 7275 6e6e 696e 6720 3d20 7365 7428 290a  running = set().
-00004340: 2020 2020 2020 2020 7365 6c66 2e65 7865          self.exe
-00004350: 6375 7469 6e67 203d 207b 7d0a 2020 2020  cuting = {}.    
-00004360: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
-00004370: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
-00004380: 7365 6c66 2e75 7365 645f 7265 736f 7572  self.used_resour
-00004390: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
-000043a0: 2073 656c 662e 6578 7472 6120 3d20 6578   self.extra = ex
-000043b0: 7472 6120 6f72 207b 7d0a 2020 2020 2020  tra or {}.      
-000043c0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-000043d0: 5f72 6566 203d 2077 6561 6b72 6566 2e72  _ref = weakref.r
-000043e0: 6566 2873 6368 6564 756c 6572 2920 6966  ef(scheduler) if
-000043f0: 2073 6368 6564 756c 6572 2065 6c73 6520   scheduler else 
-00004400: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-00004410: 662e 7461 736b 5f70 7265 6669 785f 636f  f.task_prefix_co
-00004420: 756e 7420 3d20 6465 6661 756c 7464 6963  unt = defaultdic
-00004430: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
-00004440: 656c 662e 6e65 6564 735f 7768 6174 203d  elf.needs_what =
-00004450: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-00004460: 2e5f 6e65 7477 6f72 6b5f 6f63 6320 3d20  ._network_occ = 
-00004470: 300a 2020 2020 2020 2020 7365 6c66 2e5f  0.        self._
-00004480: 6f63 6375 7061 6e63 795f 6361 6368 6520  occupancy_cache 
-00004490: 3d20 4e6f 6e65 0a0a 2020 2020 6465 6620  = None..    def 
-000044a0: 5f5f 6861 7368 5f5f 2873 656c 6629 202d  __hash__(self) -
-000044b0: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
-000044c0: 6574 7572 6e20 7365 6c66 2e5f 6861 7368  eturn self._hash
-000044d0: 0a0a 2020 2020 6465 6620 5f5f 6571 5f5f  ..    def __eq__
-000044e0: 2873 656c 662c 206f 7468 6572 3a20 6f62  (self, other: ob
-000044f0: 6a65 6374 2920 2d3e 2062 6f6f 6c3a 0a20  ject) -> bool:. 
-00004500: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
-00004510: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
-00004520: 576f 726b 6572 5374 6174 6529 2061 6e64  WorkerState) and
-00004530: 206f 7468 6572 2e73 6572 7665 725f 6964   other.server_id
-00004540: 203d 3d20 7365 6c66 2e73 6572 7665 725f   == self.server_
-00004550: 6964 0a0a 2020 2020 4070 726f 7065 7274  id..    @propert
-00004560: 790a 2020 2020 6465 6620 6861 735f 7768  y.    def has_wh
-00004570: 6174 2873 656c 6629 202d 3e20 5365 745b  at(self) -> Set[
-00004580: 5461 736b 5374 6174 655d 3a0a 2020 2020  TaskState]:.    
-00004590: 2020 2020 2222 2241 6e20 696e 7365 7274      """An insert
-000045a0: 696f 6e2d 736f 7274 6564 2073 6574 2d6c  ion-sorted set-l
-000045b0: 696b 6520 6f66 2074 6173 6b73 2077 6869  ike of tasks whi
-000045c0: 6368 2063 7572 7265 6e74 6c79 2072 6573  ch currently res
-000045d0: 6964 6520 6f6e 2074 6869 7320 776f 726b  ide on this work
-000045e0: 6572 2e0a 2020 2020 2020 2020 416c 6c20  er..        All 
-000045f0: 7468 6520 7461 736b 7320 6865 7265 2061  the tasks here a
-00004600: 7265 2069 6e20 7468 6520 226d 656d 6f72  re in the "memor
-00004610: 7922 2073 7461 7465 2e0a 2020 2020 2020  y" state..      
-00004620: 2020 5468 6973 2069 7320 7468 6520 7265    This is the re
-00004630: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
-00004640: 203a 6174 7472 3a60 5461 736b 5374 6174   :attr:`TaskStat
-00004650: 652e 7768 6f5f 6861 7360 2e0a 0a20 2020  e.who_has`...   
-00004660: 2020 2020 2054 6869 7320 6973 2061 2072       This is a r
-00004670: 6561 642d 6f6e 6c79 2070 7562 6c69 6320  ead-only public 
-00004680: 6163 6365 7373 6f72 2e20 5468 6520 6461  accessor. The da
-00004690: 7461 2069 7320 696d 706c 656d 656e 7465  ta is implemente
-000046a0: 6420 6173 2061 2064 6963 7420 7769 7468  d as a dict with
-000046b0: 6f75 740a 2020 2020 2020 2020 7661 6c75  out.        valu
-000046c0: 6573 2c20 6265 6361 7573 6520 7265 6261  es, because reba
-000046d0: 6c61 6e63 6528 2920 7265 6c69 6573 206f  lance() relies o
-000046e0: 6e20 6469 6374 7320 6265 696e 6720 696e  n dicts being in
-000046f0: 7365 7274 696f 6e2d 736f 7274 6564 2e0a  sertion-sorted..
-00004700: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00004710: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00004720: 5f68 6173 5f77 6861 742e 6b65 7973 2829  _has_what.keys()
-00004730: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00004740: 2020 2020 6465 6620 686f 7374 2873 656c      def host(sel
-00004750: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-00004760: 2020 2072 6574 7572 6e20 6765 745f 6164     return get_ad
-00004770: 6472 6573 735f 686f 7374 2873 656c 662e  dress_host(self.
-00004780: 6164 6472 6573 7329 0a0a 2020 2020 4070  address)..    @p
-00004790: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000047a0: 6d65 6d6f 7279 2873 656c 6629 202d 3e20  memory(self) -> 
-000047b0: 4d65 6d6f 7279 5374 6174 653a 0a20 2020  MemoryState:.   
-000047c0: 2020 2020 2022 2222 506f 6c69 7368 6564       """Polished
-000047d0: 206d 656d 6f72 7920 6d65 7472 6963 7320   memory metrics 
-000047e0: 666f 7220 7468 6520 776f 726b 6572 2e0a  for the worker..
-000047f0: 0a20 2020 2020 2020 202a 2a44 6573 6967  .        **Desig
-00004800: 6e20 6e6f 7465 206f 6e20 6d61 6e61 6765  n note on manage
-00004810: 6420 6d65 6d6f 7279 2a2a 0a0a 2020 2020  d memory**..    
-00004820: 2020 2020 5468 6572 6520 6172 6520 7477      There are tw
-00004830: 6f20 6d65 6173 7572 6573 2061 7661 696c  o measures avail
-00004840: 6162 6c65 2066 6f72 206d 616e 6167 6564  able for managed
-00004850: 206d 656d 6f72 793a 0a0a 2020 2020 2020   memory:..      
-00004860: 2020 2d20 6060 7365 6c66 2e6e 6279 7465    - ``self.nbyte
-00004870: 7360 600a 2020 2020 2020 2020 2d20 6060  s``.        - ``
-00004880: 7365 6c66 2e6d 6574 7269 6373 5b22 6d61  self.metrics["ma
-00004890: 6e61 6765 645f 6279 7465 7322 5d60 600a  naged_bytes"]``.
-000048a0: 0a20 2020 2020 2020 2041 7420 7265 7374  .        At rest
-000048b0: 2c20 7468 6520 7477 6f20 6e75 6d62 6572  , the two number
-000048c0: 7320 6d75 7374 2062 6520 6964 656e 7469  s must be identi
-000048d0: 6361 6c2e 2048 6f77 6576 6572 2c20 6060  cal. However, ``
-000048e0: 7365 6c66 2e6e 6279 7465 7360 6020 6973  self.nbytes`` is
-000048f0: 0a20 2020 2020 2020 2069 6d6d 6564 6961  .        immedia
-00004900: 7465 6c79 2075 7064 6174 6564 2074 6872  tely updated thr
-00004910: 6f75 6768 2074 6865 2062 6174 6368 6564  ough the batched
-00004920: 2063 6f6d 6d73 2061 7320 736f 6f6e 2061   comms as soon a
-00004930: 7320 6561 6368 2074 6173 6b20 6c61 6e64  s each task land
-00004940: 7320 696e 0a20 2020 2020 2020 206d 656d  s in.        mem
-00004950: 6f72 7920 6f6e 2074 6865 2077 6f72 6b65  ory on the worke
-00004960: 723b 2060 6073 656c 662e 6d65 7472 6963  r; ``self.metric
-00004970: 735b 226d 616e 6167 6564 5f62 7974 6573  s["managed_bytes
-00004980: 225d 6060 2069 6e73 7465 6164 2069 7320  "]`` instead is 
-00004990: 7570 6461 7465 6420 6279 0a20 2020 2020  updated by.     
-000049a0: 2020 2074 6865 2068 6561 7274 6265 6174     the heartbeat
-000049b0: 2c20 7768 6963 6820 6361 6e20 6c61 6720  , which can lag 
-000049c0: 7365 7665 7261 6c20 7365 636f 6e64 7320  several seconds 
-000049d0: 6265 6869 6e64 2e0a 0a20 2020 2020 2020  behind...       
-000049e0: 2042 656c 6f77 2077 6520 6172 6520 6d69   Below we are mi
-000049f0: 7869 6e67 206c 696b 656c 7920 6e65 7765  xing likely newe
-00004a00: 7220 6d61 6e61 6765 6420 6d65 6d6f 7279  r managed memory
-00004a10: 2069 6e66 6f20 6672 6f6d 2060 6073 656c   info from ``sel
-00004a20: 662e 6e62 7974 6573 6060 2077 6974 680a  f.nbytes`` with.
-00004a30: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
-00004a40: 616e 6420 7370 696c 6c65 6420 6d65 6d6f  and spilled memo
-00004a50: 7279 2066 726f 6d20 7468 6520 6865 6172  ry from the hear
-00004a60: 7462 6561 742e 2054 6869 7320 6973 2064  tbeat. This is d
-00004a70: 656c 6962 6572 6174 652c 2073 6f20 7468  eliberate, so th
-00004a80: 6174 0a20 2020 2020 2020 206d 616e 6167  at.        manag
-00004a90: 6564 206d 656d 6f72 7920 746f 7461 6c20  ed memory total 
-00004aa0: 6973 2075 7064 6174 6564 206d 6f72 6520  is updated more 
-00004ab0: 6672 6571 7565 6e74 6c79 2e0a 0a20 2020  frequently...   
-00004ac0: 2020 2020 204d 616e 6167 6564 206d 656d       Managed mem
-00004ad0: 6f72 7920 6469 7265 6374 6c79 2061 6e64  ory directly and
-00004ae0: 2069 6d6d 6564 6961 7465 6c79 2063 6f6e   immediately con
-00004af0: 7472 6962 7574 6573 2074 6f20 6f70 7469  tributes to opti
-00004b00: 6d69 7374 6963 206d 656d 6f72 792c 2077  mistic memory, w
-00004b10: 6869 6368 0a20 2020 2020 2020 2069 7320  hich.        is 
-00004b20: 696e 2074 7572 6e20 7573 6564 2069 6e20  in turn used in 
-00004b30: 4163 7469 7665 204d 656d 6f72 7920 4d61  Active Memory Ma
-00004b40: 6e61 6765 7220 6865 7572 6973 7469 6373  nager heuristics
-00004b50: 2028 6174 2074 6865 206d 6f6d 656e 7420   (at the moment 
-00004b60: 6f66 2077 7269 7469 6e67 3b0a 2020 2020  of writing;.    
-00004b70: 2020 2020 6d6f 7265 2075 7365 7320 7769      more uses wi
-00004b80: 6c6c 206c 696b 656c 7920 6265 2061 6464  ll likely be add
-00004b90: 6564 2069 6e20 7468 6520 6675 7475 7265  ed in the future
-00004ba0: 292e 2053 6f20 6974 2773 2069 6d70 6f72  ). So it's impor
-00004bb0: 7461 6e74 2074 6f20 6861 7665 2069 740a  tant to have it.
-00004bc0: 2020 2020 2020 2020 7570 2074 6f20 6461          up to da
-00004bd0: 7465 3b20 6d75 6368 206d 6f72 6520 7468  te; much more th
-00004be0: 616e 2069 7420 6973 2066 6f72 2070 726f  an it is for pro
-00004bf0: 6365 7373 206d 656d 6f72 792e 0a0a 2020  cess memory...  
-00004c00: 2020 2020 2020 4861 7669 6e67 2075 702d        Having up-
-00004c10: 746f 2d64 6174 6520 6d61 6e61 6765 6420  to-date managed 
-00004c20: 6d65 6d6f 7279 2069 6e66 6f20 6173 2073  memory info as s
-00004c30: 6f6f 6e20 6173 2074 6865 2073 6368 6564  oon as the sched
-00004c40: 756c 6572 206c 6561 726e 7320 6162 6f75  uler learns abou
-00004c50: 740a 2020 2020 2020 2020 7461 736b 2063  t.        task c
-00004c60: 6f6d 706c 6574 696f 6e20 616c 736f 2073  ompletion also s
-00004c70: 7562 7374 616e 7469 616c 6c79 2073 696d  ubstantially sim
-00004c80: 706c 6966 6965 7320 756e 6974 2074 6573  plifies unit tes
-00004c90: 7473 2e0a 0a20 2020 2020 2020 2054 6865  ts...        The
-00004ca0: 2066 6c69 7020 7369 6465 206f 6620 7468   flip side of th
-00004cb0: 6973 2064 6573 6967 6e20 6973 2074 6861  is design is tha
-00004cc0: 7420 6974 206d 6179 2063 6175 7365 2073  t it may cause s
-00004cd0: 6f6d 6520 6e6f 6973 6520 696e 2074 6865  ome noise in the
-00004ce0: 0a20 2020 2020 2020 2075 6e6d 616e 6167  .        unmanag
-00004cf0: 6564 5f72 6563 656e 7420 6d65 6173 7572  ed_recent measur
-00004d00: 652e 2065 2e67 2e3a 0a0a 2020 2020 2020  e. e.g.:..      
-00004d10: 2020 312e 2044 656c 6574 6520 3130 304d    1. Delete 100M
-00004d20: 4220 6f66 206d 616e 6167 6564 2064 6174  B of managed dat
-00004d30: 610a 2020 2020 2020 2020 322e 2054 6865  a.        2. The
-00004d40: 2075 7064 6174 6564 206d 616e 6167 6564   updated managed
-00004d50: 206d 656d 6f72 7920 7265 6163 6865 7320   memory reaches 
-00004d60: 7468 6520 7363 6865 6475 6c65 7220 6661  the scheduler fa
-00004d70: 7374 6572 2074 6861 6e20 7468 650a 2020  ster than the.  
-00004d80: 2020 2020 2020 2020 2075 7064 6174 6564           updated
-00004d90: 2070 726f 6365 7373 206d 656d 6f72 790a   process memory.
-00004da0: 2020 2020 2020 2020 332e 2054 6865 7265          3. There
-00004db0: 2773 2061 2062 6c69 7020 7768 6572 6520  's a blip where 
-00004dc0: 7468 6520 7363 6865 6475 6c65 7220 7468  the scheduler th
-00004dd0: 696e 6b73 2074 6861 7420 7468 6572 6527  inks that there'
-00004de0: 7320 6120 7375 6464 656e 2031 3030 4d42  s a sudden 100MB
-00004df0: 0a20 2020 2020 2020 2020 2020 696e 6372  .           incr
-00004e00: 6561 7365 2069 6e20 756e 6d61 6e61 6765  ease in unmanage
-00004e10: 645f 7265 6365 6e74 2c20 7369 6e63 6520  d_recent, since 
-00004e20: 7072 6f63 6573 7320 6d65 6d6f 7279 2068  process memory h
-00004e30: 6173 6e27 7420 6368 616e 6765 6420 6275  asn't changed bu
-00004e40: 7420 6d61 6e61 6765 640a 2020 2020 2020  t managed.      
-00004e50: 2020 2020 206d 656d 6f72 7920 6861 7320       memory has 
-00004e60: 6465 6372 6561 7365 6420 6279 2031 3030  decreased by 100
-00004e70: 4d42 0a20 2020 2020 2020 2034 2e20 5768  MB.        4. Wh
-00004e80: 656e 2074 6865 2068 6561 7274 6265 6174  en the heartbeat
-00004e90: 2061 7272 6976 6573 2c20 7072 6f63 6573   arrives, proces
-00004ea0: 7320 6d65 6d6f 7279 2067 6f65 7320 646f  s memory goes do
-00004eb0: 776e 2061 6e64 2073 6f20 646f 6573 2074  wn and so does t
-00004ec0: 6865 0a20 2020 2020 2020 2020 2020 756e  he.           un
-00004ed0: 6d61 6e61 6765 645f 7265 6365 6e74 2e0a  managed_recent..
-00004ee0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
-00004ef0: 204f 4b20 2d20 6f6e 6520 6f66 2074 6865   OK - one of the
-00004f00: 206d 6169 6e20 7265 6173 6f6e 7320 666f   main reasons fo
-00004f10: 7220 7468 6520 756e 6d61 6e61 6765 645f  r the unmanaged_
-00004f20: 7265 6365 6e74 202f 2075 6e6d 616e 6167  recent / unmanag
-00004f30: 6564 5f6f 6c64 0a20 2020 2020 2020 2073  ed_old.        s
-00004f40: 706c 6974 2069 7320 6578 6163 746c 7920  plit is exactly 
-00004f50: 746f 2063 6f6e 6365 6e74 7261 7465 2061  to concentrate a
-00004f60: 6c6c 2074 6865 206e 6f69 7365 2069 6e20  ll the noise in 
-00004f70: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-00004f80: 2061 6e64 2065 7863 6c75 6465 2069 740a   and exclude it.
-00004f90: 2020 2020 2020 2020 6672 6f6d 206f 7074          from opt
-00004fa0: 696d 6973 7469 6320 6d65 6d6f 7279 2c20  imistic memory, 
-00004fb0: 7768 6963 6820 6973 2075 7365 6420 666f  which is used fo
-00004fc0: 7220 6865 7572 6973 7469 6373 2e0a 0a20  r heuristics... 
-00004fd0: 2020 2020 2020 2053 6f6d 6574 6869 6e67         Something
-00004fe0: 2074 6861 7420 6973 206c 6573 7320 4f4b   that is less OK
-00004ff0: 2c20 6275 7420 616c 736f 206c 6573 7320  , but also less 
-00005000: 6672 6571 7565 6e74 2c20 6973 2074 6861  frequent, is tha
-00005010: 7420 7468 6520 7375 6464 656e 2064 656c  t the sudden del
-00005020: 6574 696f 6e0a 2020 2020 2020 2020 6f66  etion.        of
-00005030: 2073 7069 6c6c 6564 206b 6579 7320 7769   spilled keys wi
-00005040: 6c6c 2063 6175 7365 2061 206e 6567 6174  ll cause a negat
-00005050: 6976 6520 626c 6970 2069 6e20 6d61 6e61  ive blip in mana
-00005060: 6765 6420 6d65 6d6f 7279 3a0a 0a20 2020  ged memory:..   
-00005070: 2020 2020 2031 2e20 4465 6c65 7465 2031       1. Delete 1
-00005080: 3030 4d42 206f 6620 7370 696c 6c65 6420  00MB of spilled 
-00005090: 6461 7461 0a20 2020 2020 2020 2032 2e20  data.        2. 
-000050a0: 5468 6520 7570 6461 7465 6420 6d61 6e61  The updated mana
-000050b0: 6765 6420 6d65 6d6f 7279 202a 746f 7461  ged memory *tota
-000050c0: 6c2a 2072 6561 6368 6573 2074 6865 2073  l* reaches the s
-000050d0: 6368 6564 756c 6572 2066 6173 7465 7220  cheduler faster 
-000050e0: 7468 616e 2074 6865 0a20 2020 2020 2020  than the.       
-000050f0: 2020 2020 7570 6461 7465 6420 7370 696c      updated spil
-00005100: 6c65 6420 706f 7274 696f 6e0a 2020 2020  led portion.    
-00005110: 2020 2020 332e 2054 6869 7320 6361 7573      3. This caus
-00005120: 6573 2074 6865 206d 616e 6167 6564 206d  es the managed m
-00005130: 656d 6f72 7920 746f 2074 656d 706f 7261  emory to tempora
-00005140: 7269 6c79 2070 6c75 6d6d 6574 2061 6e64  rily plummet and
-00005150: 2062 6520 7265 706c 6163 6564 2062 790a   be replaced by.
-00005160: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-00005170: 6167 6564 5f72 6563 656e 742c 2077 6869  aged_recent, whi
-00005180: 6c65 2073 7069 6c6c 6564 206d 656d 6f72  le spilled memor
-00005190: 7920 7265 6d61 696e 7320 756e 616c 7465  y remains unalte
-000051a0: 7265 640a 2020 2020 2020 2020 342e 2057  red.        4. W
-000051b0: 6865 6e20 7468 6520 6865 6172 7462 6561  hen the heartbea
-000051c0: 7420 6172 7269 7665 732c 206d 616e 6167  t arrives, manag
-000051d0: 6564 2067 6f65 7320 6261 636b 2075 702c  ed goes back up,
-000051e0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-000051f0: 740a 2020 2020 2020 2020 2020 2067 6f65  t.           goe
-00005200: 7320 6261 636b 2064 6f77 6e2c 2061 6e64  s back down, and
-00005210: 2073 7069 6c6c 6564 2067 6f65 7320 646f   spilled goes do
-00005220: 776e 2062 7920 3130 304d 4220 6173 2069  wn by 100MB as i
-00005230: 7420 7368 6f75 6c64 2068 6176 6520 746f  t should have to
-00005240: 0a20 2020 2020 2020 2020 2020 6265 6769  .           begi
-00005250: 6e20 7769 7468 2e0a 0a20 2020 2020 2020  n with...       
-00005260: 203a 6973 7375 653a 6036 3030 3260 2077   :issue:`6002` w
-00005270: 696c 6c20 6c65 7420 7573 2073 6f6c 7665  ill let us solve
-00005280: 2074 6869 732e 0a20 2020 2020 2020 2022   this..        "
-00005290: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-000052a0: 6e20 4d65 6d6f 7279 5374 6174 6528 0a20  n MemoryState(. 
-000052b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-000052c0: 7373 3d73 656c 662e 6d65 7472 6963 735b  ss=self.metrics[
-000052d0: 226d 656d 6f72 7922 5d2c 0a20 2020 2020  "memory"],.     
-000052e0: 2020 2020 2020 206d 616e 6167 6564 3d6d         managed=m
-000052f0: 6178 2830 2c20 7365 6c66 2e6e 6279 7465  ax(0, self.nbyte
-00005300: 7320 2d20 7365 6c66 2e6d 6574 7269 6373  s - self.metrics
-00005310: 5b22 7370 696c 6c65 645f 6279 7465 7322  ["spilled_bytes"
-00005320: 5d5b 226d 656d 6f72 7922 5d29 2c0a 2020  ]["memory"]),.  
-00005330: 2020 2020 2020 2020 2020 7370 696c 6c65            spille
-00005340: 643d 7365 6c66 2e6d 6574 7269 6373 5b22  d=self.metrics["
-00005350: 7370 696c 6c65 645f 6279 7465 7322 5d5b  spilled_bytes"][
-00005360: 2264 6973 6b22 5d2c 0a20 2020 2020 2020  "disk"],.       
-00005370: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
-00005380: 6c64 3d73 656c 662e 5f6d 656d 6f72 795f  ld=self._memory_
-00005390: 756e 6d61 6e61 6765 645f 6f6c 642c 0a20  unmanaged_old,. 
-000053a0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000053b0: 6620 636c 6561 6e28 7365 6c66 2920 2d3e  f clean(self) ->
-000053c0: 2057 6f72 6b65 7253 7461 7465 3a0a 2020   WorkerState:.  
-000053d0: 2020 2020 2020 2222 2252 6574 7572 6e20        """Return 
-000053e0: 6120 7665 7273 696f 6e20 6f66 2074 6869  a version of thi
-000053f0: 7320 6f62 6a65 6374 2074 6861 7420 6973  s object that is
-00005400: 2061 7070 726f 7072 6961 7465 2066 6f72   appropriate for
-00005410: 2073 6572 6961 6c69 7a61 7469 6f6e 2222   serialization""
-00005420: 220a 2020 2020 2020 2020 7773 203d 2057  ".        ws = W
-00005430: 6f72 6b65 7253 7461 7465 280a 2020 2020  orkerState(.    
-00005440: 2020 2020 2020 2020 6164 6472 6573 733d          address=
-00005450: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
-00005460: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00005470: 3d73 656c 662e 7374 6174 7573 2c0a 2020  =self.status,.  
-00005480: 2020 2020 2020 2020 2020 7069 643d 7365            pid=se
-00005490: 6c66 2e70 6964 2c0a 2020 2020 2020 2020  lf.pid,.        
-000054a0: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
-000054b0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-000054c0: 6e74 6872 6561 6473 3d73 656c 662e 6e74  nthreads=self.nt
-000054d0: 6872 6561 6473 2c0a 2020 2020 2020 2020  hreads,.        
-000054e0: 2020 2020 6d65 6d6f 7279 5f6c 696d 6974      memory_limit
-000054f0: 3d73 656c 662e 6d65 6d6f 7279 5f6c 696d  =self.memory_lim
-00005500: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-00005510: 6c6f 6361 6c5f 6469 7265 6374 6f72 793d  local_directory=
-00005520: 7365 6c66 2e6c 6f63 616c 5f64 6972 6563  self.local_direc
-00005530: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
-00005540: 2020 7365 7276 6963 6573 3d73 656c 662e    services=self.
-00005550: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
-00005560: 2020 2020 2020 6e61 6e6e 793d 7365 6c66        nanny=self
-00005570: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
-00005580: 2020 2020 6578 7472 613d 7365 6c66 2e65      extra=self.e
-00005590: 7874 7261 2c0a 2020 2020 2020 2020 2020  xtra,.          
-000055a0: 2020 7365 7276 6572 5f69 643d 7365 6c66    server_id=self
-000055b0: 2e73 6572 7665 725f 6964 2c0a 2020 2020  .server_id,.    
-000055c0: 2020 2020 290a 2020 2020 2020 2020 7773      ).        ws
-000055d0: 2e5f 6f63 6375 7061 6e63 795f 6361 6368  ._occupancy_cach
-000055e0: 6520 3d20 7365 6c66 2e6f 6363 7570 616e  e = self.occupan
-000055f0: 6379 0a0a 2020 2020 2020 2020 7773 2e65  cy..        ws.e
-00005600: 7865 6375 7469 6e67 203d 207b 0a20 2020  xecuting = {.   
-00005610: 2020 2020 2020 2020 2074 732e 6b65 793a           ts.key:
-00005620: 2064 7572 6174 696f 6e20 666f 7220 7473   duration for ts
-00005630: 2c20 6475 7261 7469 6f6e 2069 6e20 7365  , duration in se
-00005640: 6c66 2e65 7865 6375 7469 6e67 2e69 7465  lf.executing.ite
-00005650: 6d73 2829 2020 2320 7479 7065 3a20 6967  ms()  # type: ig
-00005660: 6e6f 7265 0a20 2020 2020 2020 207d 0a20  nore.        }. 
-00005670: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
-00005680: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00005690: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-000056a0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
-000056b0: 6622 2c20 6e61 6d65 3a20 7b73 656c 662e  f", name: {self.
-000056c0: 6e61 6d65 7d22 2069 6620 7365 6c66 2e6e  name}" if self.n
-000056d0: 616d 6520 213d 2073 656c 662e 6164 6472  ame != self.addr
-000056e0: 6573 7320 656c 7365 2022 220a 2020 2020  ess else "".    
-000056f0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
-00005700: 2020 2020 2020 2020 2066 223c 576f 726b           f"<Work
-00005710: 6572 5374 6174 6520 7b73 656c 662e 6164  erState {self.ad
-00005720: 6472 6573 7321 727d 7b6e 616d 657d 2c20  dress!r}{name}, 
-00005730: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00005740: 7374 6174 7573 3a20 7b73 656c 662e 7374  status: {self.st
-00005750: 6174 7573 2e6e 616d 657d 2c20 220a 2020  atus.name}, ".  
-00005760: 2020 2020 2020 2020 2020 6622 6d65 6d6f            f"memo
-00005770: 7279 3a20 7b6c 656e 2873 656c 662e 6861  ry: {len(self.ha
-00005780: 735f 7768 6174 297d 2c20 220a 2020 2020  s_what)}, ".    
-00005790: 2020 2020 2020 2020 6622 7072 6f63 6573          f"proces
-000057a0: 7369 6e67 3a20 7b6c 656e 2873 656c 662e  sing: {len(self.
-000057b0: 7072 6f63 6573 7369 6e67 297d 3e22 0a20  processing)}>". 
-000057c0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000057d0: 6620 5f72 6570 725f 6874 6d6c 5f28 7365  f _repr_html_(se
-000057e0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-000057f0: 2020 2020 7265 7475 726e 2067 6574 5f74      return get_t
-00005800: 656d 706c 6174 6528 2277 6f72 6b65 725f  emplate("worker_
-00005810: 7374 6174 652e 6874 6d6c 2e6a 3222 292e  state.html.j2").
-00005820: 7265 6e64 6572 280a 2020 2020 2020 2020  render(.        
-00005830: 2020 2020 6164 6472 6573 733d 7365 6c66      address=self
-00005840: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
-00005850: 2020 2020 2020 6e61 6d65 3d73 656c 662e        name=self.
-00005860: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00005870: 2020 7374 6174 7573 3d73 656c 662e 7374    status=self.st
-00005880: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
-00005890: 2020 2020 2020 2068 6173 5f77 6861 743d         has_what=
-000058a0: 7365 6c66 2e68 6173 5f77 6861 742c 0a20  self.has_what,. 
-000058b0: 2020 2020 2020 2020 2020 2070 726f 6365             proce
-000058c0: 7373 696e 673d 7365 6c66 2e70 726f 6365  ssing=self.proce
-000058d0: 7373 696e 672c 0a20 2020 2020 2020 2029  ssing,.        )
-000058e0: 0a0a 2020 2020 6465 6620 6964 656e 7469  ..    def identi
-000058f0: 7479 2873 656c 6629 202d 3e20 6469 6374  ty(self) -> dict
-00005900: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
-00005910: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-00005920: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
-00005930: 2022 576f 726b 6572 222c 0a20 2020 2020   "Worker",.     
-00005940: 2020 2020 2020 2022 6964 223a 2073 656c         "id": sel
-00005950: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
-00005960: 2020 2020 2268 6f73 7422 3a20 7365 6c66      "host": self
-00005970: 2e68 6f73 742c 0a20 2020 2020 2020 2020  .host,.         
-00005980: 2020 2022 7265 736f 7572 6365 7322 3a20     "resources": 
-00005990: 7365 6c66 2e72 6573 6f75 7263 6573 2c0a  self.resources,.
-000059a0: 2020 2020 2020 2020 2020 2020 226c 6f63              "loc
-000059b0: 616c 5f64 6972 6563 746f 7279 223a 2073  al_directory": s
-000059c0: 656c 662e 6c6f 6361 6c5f 6469 7265 6374  elf.local_direct
-000059d0: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
-000059e0: 2022 6e61 6d65 223a 2073 656c 662e 6e61   "name": self.na
-000059f0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00005a00: 226e 7468 7265 6164 7322 3a20 7365 6c66  "nthreads": self
-00005a10: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
-00005a20: 2020 2020 2020 2022 6d65 6d6f 7279 5f6c         "memory_l
-00005a30: 696d 6974 223a 2073 656c 662e 6d65 6d6f  imit": self.memo
-00005a40: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
-00005a50: 2020 2020 2020 226c 6173 745f 7365 656e        "last_seen
-00005a60: 223a 2073 656c 662e 6c61 7374 5f73 6565  ": self.last_see
-00005a70: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
-00005a80: 7365 7276 6963 6573 223a 2073 656c 662e  services": self.
-00005a90: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
-00005aa0: 2020 2020 2020 226d 6574 7269 6373 223a        "metrics":
-00005ab0: 2073 656c 662e 6d65 7472 6963 732c 0a20   self.metrics,. 
-00005ac0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00005ad0: 7573 223a 2073 656c 662e 7374 6174 7573  us": self.status
-00005ae0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
-00005af0: 2020 2022 6e61 6e6e 7922 3a20 7365 6c66     "nanny": self
-00005b00: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
-00005b10: 2020 2020 2a2a 7365 6c66 2e65 7874 7261      **self.extra
-00005b20: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-00005b30: 2064 6566 205f 746f 5f64 6963 745f 6e6f   def _to_dict_no
-00005b40: 5f6e 6573 7428 7365 6c66 2c20 2a2c 2065  _nest(self, *, e
-00005b50: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
-00005b60: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
-00005b70: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-00005b80: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
-00005b90: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
-00005ba0: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
-00005bb0: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
-00005bc0: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
-00005bd0: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
-00005be0: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
-00005bf0: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
-00005c00: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
-00005c10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00005c20: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
-00005c30: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
-00005c40: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
-00005c50: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
-00005c60: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
-00005c70: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
-00005c80: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
-00005c90: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
-00005ca0: 7572 7369 7665 5f74 6f5f 6469 6374 280a  ursive_to_dict(.
-00005cb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005cc0: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
-00005cd0: 636c 7564 653d 7365 7428 6578 636c 7564  clude=set(exclud
-00005ce0: 6529 207c 207b 2276 6572 7369 6f6e 7322  e) | {"versions"
-00005cf0: 7d2c 2020 2320 7479 7065 3a20 6967 6e6f  },  # type: igno
-00005d00: 7265 0a20 2020 2020 2020 2020 2020 206d  re.            m
-00005d10: 656d 6265 7273 3d54 7275 652c 0a20 2020  embers=True,.   
-00005d20: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
-00005d30: 7065 7274 790a 2020 2020 6465 6620 7363  perty.    def sc
-00005d40: 6865 6475 6c65 7228 7365 6c66 2920 2d3e  heduler(self) ->
-00005d50: 2053 6368 6564 756c 6572 5374 6174 653a   SchedulerState:
-00005d60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00005d70: 7365 6c66 2e73 6368 6564 756c 6572 5f72  self.scheduler_r
-00005d80: 6566 0a20 2020 2020 2020 2073 203d 2073  ef.        s = s
-00005d90: 656c 662e 7363 6865 6475 6c65 725f 7265  elf.scheduler_re
-00005da0: 6628 290a 2020 2020 2020 2020 6173 7365  f().        asse
-00005db0: 7274 2073 0a20 2020 2020 2020 2072 6574  rt s.        ret
-00005dc0: 7572 6e20 730a 0a20 2020 2064 6566 2061  urn s..    def a
-00005dd0: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
-00005de0: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00005df0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-00005e00: 2020 2020 2020 2022 2222 4173 7369 676e         """Assign
-00005e10: 2061 2074 6173 6b20 746f 2074 6869 7320   a task to this 
-00005e20: 776f 726b 6572 2066 6f72 2063 6f6d 7075  worker for compu
-00005e30: 7465 2e22 2222 0a20 2020 2020 2020 2069  te.""".        i
-00005e40: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-00005e50: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00005e60: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00005e70: 206e 6f74 2069 6e20 7365 6c66 2e70 726f   not in self.pro
-00005e80: 6365 7373 696e 670a 0a20 2020 2020 2020  cessing..       
-00005e90: 2074 7020 3d20 7473 2e70 7265 6669 780a   tp = ts.prefix.
-00005ea0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-00005eb0: 6b5f 7072 6566 6978 5f63 6f75 6e74 5b74  k_prefix_count[t
-00005ec0: 702e 6e61 6d65 5d20 2b3d 2031 0a20 2020  p.name] += 1.   
-00005ed0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-00005ee0: 6c65 722e 5f74 6173 6b5f 7072 6566 6978  ler._task_prefix
-00005ef0: 5f63 6f75 6e74 5f67 6c6f 6261 6c5b 7470  _count_global[tp
-00005f00: 2e6e 616d 655d 202b 3d20 310a 2020 2020  .name] += 1.    
-00005f10: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
-00005f20: 696e 672e 6164 6428 7473 290a 2020 2020  ing.add(ts).    
-00005f30: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-00005f40: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-00005f50: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00005f60: 656c 6620 6e6f 7420 696e 2064 7473 2e77  elf not in dts.w
-00005f70: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-00005f80: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
-00005f90: 635f 6e65 6564 735f 7265 706c 6963 6128  c_needs_replica(
-00005fa0: 6474 7329 0a0a 2020 2020 6465 6620 6164  dts)..    def ad
-00005fb0: 645f 746f 5f6c 6f6e 675f 7275 6e6e 696e  d_to_long_runnin
-00005fc0: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
-00005fd0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00005fe0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005ff0: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
-00006000: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00006010: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
-00006020: 662e 7072 6f63 6573 7369 6e67 0a20 2020  f.processing.   
-00006030: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00006040: 7473 206e 6f74 2069 6e20 7365 6c66 2e6c  ts not in self.l
-00006050: 6f6e 675f 7275 6e6e 696e 670a 0a20 2020  ong_running..   
-00006060: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
-00006070: 655f 6672 6f6d 5f74 6173 6b5f 7072 6566  e_from_task_pref
-00006080: 6978 5f63 6f75 6e74 2874 7329 0a20 2020  ix_count(ts).   
-00006090: 2020 2020 2023 2043 616e 6e6f 7420 7265       # Cannot re
-000060a0: 6d6f 7665 2066 726f 6d20 7072 6f63 6573  move from proces
-000060b0: 7369 6e67 2073 696e 6365 2077 6527 7265  sing since we're
-000060c0: 2075 7369 6e67 2074 6869 7320 666f 7220   using this for 
-000060d0: 7468 696e 6773 206c 696b 650a 2020 2020  things like.    
-000060e0: 2020 2020 2320 6964 6c65 6e65 7373 2064      # idleness d
-000060f0: 6574 6563 7469 6f6e 2e20 4964 6c65 2077  etection. Idle w
-00006100: 6f72 6b65 7273 2061 7265 2074 7970 6963  orkers are typic
-00006110: 616c 6c79 2074 6172 6765 7465 6420 666f  ally targeted fo
-00006120: 720a 2020 2020 2020 2020 2320 646f 776e  r.        # down
-00006130: 7363 616c 696e 6720 6275 7420 7765 2073  scaling but we s
-00006140: 686f 756c 6420 6e6f 7420 646f 776e 7363  hould not downsc
-00006150: 616c 6520 776f 726b 6572 7320 7769 7468  ale workers with
-00006160: 206c 6f6e 6720 7275 6e6e 696e 670a 2020   long running.  
-00006170: 2020 2020 2020 2320 7461 736b 730a 2020        # tasks.  
-00006180: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
-00006190: 7275 6e6e 696e 672e 6164 6428 7473 290a  running.add(ts).
-000061a0: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
-000061b0: 6672 6f6d 5f70 726f 6365 7373 696e 6728  from_processing(
-000061c0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-000061d0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-000061e0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-000061f0: 6120 7461 736b 2066 726f 6d20 6120 776f  a task from a wo
-00006200: 726b 6572 7320 7072 6f63 6573 7369 6e67  rkers processing
-00006210: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00006220: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
-00006230: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-00006240: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-00006250: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
-00006260: 0a0a 2020 2020 2020 2020 6966 2074 7320  ..        if ts 
-00006270: 696e 2073 656c 662e 6c6f 6e67 5f72 756e  in self.long_run
-00006280: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
-00006290: 2020 7365 6c66 2e6c 6f6e 675f 7275 6e6e    self.long_runn
-000062a0: 696e 672e 6469 7363 6172 6428 7473 290a  ing.discard(ts).
-000062b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000062c0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000062d0: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
-000062e0: 5f70 7265 6669 785f 636f 756e 7428 7473  _prefix_count(ts
-000062f0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
-00006300: 726f 6365 7373 696e 672e 7265 6d6f 7665  rocessing.remove
-00006310: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
-00006320: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-00006330: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-00006340: 2020 2020 2069 6620 6474 7320 696e 2073       if dts in s
-00006350: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
-00006360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006370: 7365 6c66 2e5f 6465 635f 6e65 6564 735f  self._dec_needs_
-00006380: 7265 706c 6963 6128 6474 7329 0a0a 2020  replica(dts)..  
-00006390: 2020 6465 6620 5f72 656d 6f76 655f 6672    def _remove_fr
-000063a0: 6f6d 5f74 6173 6b5f 7072 6566 6978 5f63  om_task_prefix_c
-000063b0: 6f75 6e74 2873 656c 662c 2074 733a 2054  ount(self, ts: T
-000063c0: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-000063d0: 653a 0a20 2020 2020 2020 2063 6f75 6e74  e:.        count
-000063e0: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
-000063f0: 6669 785f 636f 756e 745b 7473 2e70 7265  fix_count[ts.pre
-00006400: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
-00006410: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
-00006420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006430: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
-00006440: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
-00006450: 655d 203d 2063 6f75 6e74 0a20 2020 2020  e] = count.     
-00006460: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006470: 2020 2020 2064 656c 2073 656c 662e 7461       del self.ta
-00006480: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
-00006490: 7473 2e70 7265 6669 782e 6e61 6d65 5d0a  ts.prefix.name].
-000064a0: 0a20 2020 2020 2020 2063 6f75 6e74 203d  .        count =
-000064b0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-000064c0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-000064d0: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
-000064e0: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
-000064f0: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
-00006500: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006510: 2e73 6368 6564 756c 6572 2e5f 7461 736b  .scheduler._task
-00006520: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
-00006530: 6f62 616c 5b74 732e 7072 6566 6978 2e6e  obal[ts.prefix.n
-00006540: 616d 655d 203d 2063 6f75 6e74 0a20 2020  ame] = count.   
-00006550: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006560: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00006570: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
-00006580: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
-00006590: 6261 6c5b 7473 2e70 7265 6669 782e 6e61  bal[ts.prefix.na
-000065a0: 6d65 5d0a 0a20 2020 2064 6566 2072 656d  me]..    def rem
-000065b0: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
-000065c0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-000065d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000065e0: 2020 2222 2254 6865 2077 6f72 6b65 7220    """The worker 
-000065f0: 6e6f 206c 6f6e 6765 7220 6861 7320 6120  no longer has a 
-00006600: 7461 736b 2069 6e20 6d65 6d6f 7279 2222  task in memory""
-00006610: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00006620: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
-00006630: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00006640: 2020 6173 7365 7274 2073 656c 6620 696e    assert self in
-00006650: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00006660: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00006670: 7320 696e 2073 656c 662e 6861 735f 7768  s in self.has_wh
-00006680: 6174 0a20 2020 2020 2020 2020 2020 2061  at.            a
-00006690: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-000066a0: 7365 6c66 2e6e 6565 6473 5f77 6861 740a  self.needs_what.
-000066b0: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
-000066c0: 7974 6573 202d 3d20 7473 2e67 6574 5f6e  ytes -= ts.get_n
-000066d0: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
-000066e0: 6465 6c20 7365 6c66 2e5f 6861 735f 7768  del self._has_wh
-000066f0: 6174 5b74 735d 0a20 2020 2020 2020 2074  at[ts].        t
-00006700: 732e 7768 6f5f 6861 732e 7265 6d6f 7665  s.who_has.remove
-00006710: 2873 656c 6629 0a0a 2020 2020 6465 6620  (self)..    def 
-00006720: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
-00006730: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
-00006740: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-00006750: 0a20 2020 2020 2020 2022 2222 4173 7369  .        """Assi
-00006760: 676e 2061 2074 6173 6b20 6665 7463 6820  gn a task fetch 
-00006770: 746f 2074 6869 7320 776f 726b 6572 2061  to this worker a
-00006780: 6e64 2075 7064 6174 6520 6e65 7477 6f72  nd update networ
-00006790: 6b20 6f63 6375 7061 6e63 6965 7322 2222  k occupancies"""
-000067a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000067b0: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
-000067c0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-000067d0: 2061 7373 6572 7420 7365 6c66 206e 6f74   assert self not
-000067e0: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
-000067f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00006800: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
-00006810: 2e68 6173 5f77 6861 740a 2020 2020 2020  .has_what.      
-00006820: 2020 6966 2074 7320 6e6f 7420 696e 2073    if ts not in s
-00006830: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
-00006840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006850: 2e6e 6565 6473 5f77 6861 745b 7473 5d20  .needs_what[ts] 
-00006860: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00006870: 6e62 7974 6573 203d 2074 732e 6765 745f  nbytes = ts.get_
-00006880: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
-00006890: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
-000068a0: 726b 5f6f 6363 202b 3d20 6e62 7974 6573  rk_occ += nbytes
-000068b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000068c0: 662e 7363 6865 6475 6c65 722e 5f6e 6574  f.scheduler._net
-000068d0: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c20  work_occ_global 
-000068e0: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
-000068f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006900: 2020 2020 7365 6c66 2e6e 6565 6473 5f77      self.needs_w
-00006910: 6861 745b 7473 5d20 2b3d 2031 0a0a 2020  hat[ts] += 1..  
-00006920: 2020 6465 6620 5f64 6563 5f6e 6565 6473    def _dec_needs
-00006930: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
-00006940: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-00006950: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00006960: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-00006970: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00006980: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00006990: 2069 6e20 7365 6c66 2e6e 6565 6473 5f77   in self.needs_w
-000069a0: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
-000069b0: 662e 6e65 6564 735f 7768 6174 5b74 735d  f.needs_what[ts]
-000069c0: 202d 3d20 310a 2020 2020 2020 2020 6966   -= 1.        if
-000069d0: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
-000069e0: 5b74 735d 203d 3d20 303a 0a20 2020 2020  [ts] == 0:.     
-000069f0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00006a00: 6e65 6564 735f 7768 6174 5b74 735d 0a20  needs_what[ts]. 
-00006a10: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
-00006a20: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
-00006a30: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00006a40: 7365 6c66 2e5f 6e65 7477 6f72 6b5f 6f63  self._network_oc
-00006a50: 6320 2d3d 206e 6279 7465 730a 2020 2020  c -= nbytes.    
-00006a60: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00006a70: 6564 756c 6572 2e5f 6e65 7477 6f72 6b5f  eduler._network_
-00006a80: 6f63 635f 676c 6f62 616c 202d 3d20 6e62  occ_global -= nb
-00006a90: 7974 6573 0a0a 2020 2020 6465 6620 6164  ytes..    def ad
-00006aa0: 645f 7265 706c 6963 6128 7365 6c66 2c20  d_replica(self, 
-00006ab0: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-00006ac0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006ad0: 2222 2254 6865 2077 6f72 6b65 7220 6163  """The worker ac
-00006ae0: 7175 6972 6564 2061 2072 6570 6c69 6361  quired a replica
-00006af0: 206f 6620 7461 736b 2222 220a 2020 2020   of task""".    
-00006b00: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
-00006b10: 6475 6c65 722e 7661 6c69 6461 7465 3a0a  duler.validate:.
-00006b20: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00006b30: 7274 2073 656c 6620 6e6f 7420 696e 2074  rt self not in t
-00006b40: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-00006b50: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-00006b60: 6e6f 7420 696e 2073 656c 662e 6861 735f  not in self.has_
-00006b70: 7768 6174 0a0a 2020 2020 2020 2020 6e62  what..        nb
-00006b80: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
-00006b90: 7974 6573 2829 0a20 2020 2020 2020 2069  ytes().        i
-00006ba0: 6620 7473 2069 6e20 7365 6c66 2e6e 6565  f ts in self.nee
-00006bb0: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
-00006bc0: 2020 2020 2064 656c 2073 656c 662e 6e65       del self.ne
-00006bd0: 6564 735f 7768 6174 5b74 735d 0a20 2020  eds_what[ts].   
-00006be0: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
-00006bf0: 6574 776f 726b 5f6f 6363 202d 3d20 6e62  etwork_occ -= nb
-00006c00: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
-00006c10: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00006c20: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
-00006c30: 6261 6c20 2d3d 206e 6279 7465 730a 2020  bal -= nbytes.  
-00006c40: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
-00006c50: 2e61 6464 2873 656c 6629 0a20 2020 2020  .add(self).     
-00006c60: 2020 2073 656c 662e 6e62 7974 6573 202b     self.nbytes +
-00006c70: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
-00006c80: 2073 656c 662e 5f68 6173 5f77 6861 745b   self._has_what[
-00006c90: 7473 5d20 3d20 4e6f 6e65 0a0a 2020 2020  ts] = None..    
-00006ca0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00006cb0: 6620 6f63 6375 7061 6e63 7928 7365 6c66  f occupancy(self
-00006cc0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-00006cd0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00006ce0: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
-00006cf0: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
-00006d00: 6572 2e5f 6361 6c63 5f6f 6363 7570 616e  er._calc_occupan
-00006d10: 6379 280a 2020 2020 2020 2020 2020 2020  cy(.            
-00006d20: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
-00006d30: 5f63 6f75 6e74 2c20 7365 6c66 2e5f 6e65  _count, self._ne
-00006d40: 7477 6f72 6b5f 6f63 630a 2020 2020 2020  twork_occ.      
-00006d50: 2020 290a 0a0a 4064 6174 6163 6c61 7373    )...@dataclass
-00006d60: 6573 2e64 6174 6163 6c61 7373 0a63 6c61  es.dataclass.cla
-00006d70: 7373 2045 7272 6564 5461 736b 3a0a 2020  ss ErredTask:.  
-00006d80: 2020 2222 224c 6967 6874 7765 6967 6874    """Lightweight
-00006d90: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00006da0: 6f66 2061 6e20 6572 7265 6420 7461 736b  of an erred task
-00006db0: 2077 6974 686f 7574 2061 6e79 2064 6570   without any dep
-00006dc0: 656e 6465 6e63 7920 696e 666f 726d 6174  endency informat
-00006dd0: 696f 6e0a 2020 2020 6f72 2072 756e 7370  ion.    or runsp
-00006de0: 6563 2e0a 0a20 2020 2053 6565 2061 6c73  ec...    See als
-00006df0: 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  o.    --------. 
-00006e00: 2020 2054 6173 6b53 7461 7465 0a20 2020     TaskState.   
-00006e10: 2022 2222 0a0a 2020 2020 6b65 793a 2048   """..    key: H
-00006e20: 6173 6861 626c 650a 2020 2020 7469 6d65  ashable.    time
-00006e30: 7374 616d 703a 2066 6c6f 6174 0a20 2020  stamp: float.   
-00006e40: 2065 7272 6564 5f6f 6e3a 2073 6574 5b73   erred_on: set[s
-00006e50: 7472 5d0a 2020 2020 6578 6365 7074 696f  tr].    exceptio
-00006e60: 6e5f 7465 7874 3a20 7374 720a 2020 2020  n_text: str.    
-00006e70: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
-00006e80: 7374 720a 0a0a 636c 6173 7320 436f 6d70  str...class Comp
-00006e90: 7574 6174 696f 6e3a 0a20 2020 2022 2222  utation:.    """
-00006ea0: 436f 6c6c 6563 7469 6f6e 2074 7261 636b  Collection track
-00006eb0: 696e 6720 6120 7369 6e67 6c65 2063 6f6d  ing a single com
-00006ec0: 7075 7465 206f 7220 7065 7273 6973 7420  pute or persist 
-00006ed0: 6361 6c6c 0a0a 2020 2020 5365 6520 616c  call..    See al
-00006ee0: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
-00006ef0: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
-00006f00: 2020 2054 6173 6b47 726f 7570 0a20 2020     TaskGroup.   
-00006f10: 2054 6173 6b53 7461 7465 0a20 2020 2022   TaskState.    "
-00006f20: 2222 0a0a 2020 2020 7374 6172 743a 2066  ""..    start: f
-00006f30: 6c6f 6174 0a20 2020 2067 726f 7570 733a  loat.    groups:
-00006f40: 2073 6574 5b54 6173 6b47 726f 7570 5d0a   set[TaskGroup].
-00006f50: 2020 2020 636f 6465 3a20 536f 7274 6564      code: Sorted
-00006f60: 5365 740a 2020 2020 6964 3a20 7575 6964  Set.    id: uuid
-00006f70: 2e55 5549 440a 2020 2020 616e 6e6f 7461  .UUID.    annota
-00006f80: 7469 6f6e 733a 2064 6963 740a 0a20 2020  tions: dict..   
-00006f90: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
-00006fa0: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
-00006fb0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
-00006fc0: 6e69 745f 5f28 7365 6c66 293a 0a20 2020  nit__(self):.   
-00006fd0: 2020 2020 2073 656c 662e 7374 6172 7420       self.start 
-00006fe0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
-00006ff0: 2073 656c 662e 6772 6f75 7073 203d 2073   self.groups = s
-00007000: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00007010: 662e 636f 6465 203d 2053 6f72 7465 6453  f.code = SortedS
-00007020: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00007030: 662e 6964 203d 2075 7569 642e 7575 6964  f.id = uuid.uuid
-00007040: 3428 290a 2020 2020 2020 2020 7365 6c66  4().        self
-00007050: 2e61 6e6e 6f74 6174 696f 6e73 203d 207b  .annotations = {
-00007060: 7d0a 0a20 2020 2040 7072 6f70 6572 7479  }..    @property
-00007070: 0a20 2020 2064 6566 2073 746f 7028 7365  .    def stop(se
-00007080: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-00007090: 2020 2020 2020 6966 2073 656c 662e 6772        if self.gr
-000070a0: 6f75 7073 3a0a 2020 2020 2020 2020 2020  oups:.          
-000070b0: 2020 7265 7475 726e 206d 6178 2874 672e    return max(tg.
-000070c0: 7374 6f70 2066 6f72 2074 6720 696e 2073  stop for tg in s
-000070d0: 656c 662e 6772 6f75 7073 290a 2020 2020  elf.groups).    
-000070e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000070f0: 2020 2020 2020 7265 7475 726e 202d 310a        return -1.
-00007100: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00007110: 2020 2064 6566 2073 7461 7465 7328 7365     def states(se
-00007120: 6c66 2920 2d3e 2064 6963 745b 5461 736b  lf) -> dict[Task
-00007130: 5374 6174 6553 7461 7465 2c20 696e 745d  StateState, int]
-00007140: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00007150: 206d 6572 6765 5f77 6974 6828 7375 6d2c   merge_with(sum,
-00007160: 2028 7467 2e73 7461 7465 7320 666f 7220   (tg.states for 
-00007170: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
-00007180: 7329 290a 0a20 2020 2064 6566 205f 5f72  s))..    def __r
-00007190: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
-000071a0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-000071b0: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-000071c0: 2066 223c 436f 6d70 7574 6174 696f 6e20   f"<Computation 
-000071d0: 7b73 656c 662e 6964 7d3a 2022 0a20 2020  {self.id}: ".   
-000071e0: 2020 2020 2020 2020 202b 2022 5461 736b           + "Task
-000071f0: 733a 2022 0a20 2020 2020 2020 2020 2020  s: ".           
-00007200: 202b 2022 2c20 222e 6a6f 696e 280a 2020   + ", ".join(.  
-00007210: 2020 2020 2020 2020 2020 2020 2020 2225                "%
-00007220: 733a 2025 6422 2025 2028 6b2c 2076 2920  s: %d" % (k, v) 
-00007230: 666f 7220 286b 2c20 7629 2069 6e20 736f  for (k, v) in so
-00007240: 7274 6564 2873 656c 662e 7374 6174 6573  rted(self.states
-00007250: 2e69 7465 6d73 2829 2920 6966 2076 0a20  .items()) if v. 
-00007260: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007270: 2020 2020 2020 2020 202b 2022 3e22 0a20           + ">". 
-00007280: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00007290: 6620 5f72 6570 725f 6874 6d6c 5f28 7365  f _repr_html_(se
-000072a0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-000072b0: 2020 2020 7265 7475 726e 2067 6574 5f74      return get_t
-000072c0: 656d 706c 6174 6528 2263 6f6d 7075 7461  emplate("computa
-000072d0: 7469 6f6e 2e68 746d 6c2e 6a32 2229 2e72  tion.html.j2").r
-000072e0: 656e 6465 7228 0a20 2020 2020 2020 2020  ender(.         
-000072f0: 2020 2069 643d 7365 6c66 2e69 642c 0a20     id=self.id,. 
-00007300: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00007310: 3d73 656c 662e 7374 6172 742c 0a20 2020  =self.start,.   
-00007320: 2020 2020 2020 2020 2073 746f 703d 7365           stop=se
-00007330: 6c66 2e73 746f 702c 0a20 2020 2020 2020  lf.stop,.       
-00007340: 2020 2020 2067 726f 7570 733d 7365 6c66       groups=self
-00007350: 2e67 726f 7570 732c 0a20 2020 2020 2020  .groups,.       
-00007360: 2020 2020 2073 7461 7465 733d 7365 6c66       states=self
-00007370: 2e73 7461 7465 732c 0a20 2020 2020 2020  .states,.       
-00007380: 2020 2020 2063 6f64 653d 7365 6c66 2e63       code=self.c
-00007390: 6f64 652c 0a20 2020 2020 2020 2029 0a0a  ode,.        )..
-000073a0: 0a63 6c61 7373 2054 6173 6b50 7265 6669  .class TaskPrefi
-000073b0: 783a 0a20 2020 2022 2222 436f 6c6c 6563  x:.    """Collec
-000073c0: 7469 6f6e 2074 7261 636b 696e 6720 616c  tion tracking al
-000073d0: 6c20 7461 736b 7320 7769 7468 696e 2061  l tasks within a
-000073e0: 2067 726f 7570 0a0a 2020 2020 4b65 7973   group..    Keys
-000073f0: 206f 6674 656e 2068 6176 6520 6120 7374   often have a st
-00007400: 7275 6374 7572 6520 6c69 6b65 2060 6028  ructure like ``(
-00007410: 2278 2d31 3233 222c 2030 2960 600a 2020  "x-123", 0)``.  
-00007420: 2020 4120 6772 6f75 7020 7461 6b65 7320    A group takes 
-00007430: 7468 6520 6669 7273 7420 7365 6374 696f  the first sectio
-00007440: 6e2c 206c 696b 6520 6060 2278 2260 600a  n, like ``"x"``.
-00007450: 0a20 2020 2053 6565 2041 6c73 6f0a 2020  .    See Also.  
-00007460: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054    --------.    T
-00007470: 6173 6b47 726f 7570 0a20 2020 2022 2222  askGroup.    """
-00007480: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
-00007490: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
-000074a0: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
-000074b0: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
-000074c0: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
-000074d0: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
-000074e0: 6060 2278 2260 600a 2020 2020 6e61 6d65  ``"x"``.    name
-000074f0: 3a20 7374 720a 0a20 2020 2023 3a20 416e  : str..    #: An
-00007500: 2065 7870 6f6e 656e 7469 616c 6c79 2077   exponentially w
-00007510: 6569 6768 7465 6420 6d6f 7669 6e67 2061  eighted moving a
-00007520: 7665 7261 6765 2064 7572 6174 696f 6e20  verage duration 
-00007530: 6f66 2061 6c6c 2074 6173 6b73 2077 6974  of all tasks wit
-00007540: 6820 7468 6973 2070 7265 6669 780a 2020  h this prefix.  
-00007550: 2020 6475 7261 7469 6f6e 5f61 7665 7261    duration_avera
-00007560: 6765 3a20 666c 6f61 740a 0a20 2020 2023  ge: float..    #
-00007570: 3a20 4e75 6d62 6572 7320 6f66 2074 696d  : Numbers of tim
-00007580: 6573 2061 2074 6173 6b20 7761 7320 6d61  es a task was ma
-00007590: 726b 6564 2061 7320 7375 7370 6963 696f  rked as suspicio
-000075a0: 7573 2077 6974 6820 7468 6973 2070 7265  us with this pre
-000075b0: 6669 780a 2020 2020 7375 7370 6963 696f  fix.    suspicio
-000075c0: 7573 3a20 696e 740a 0a20 2020 2023 3a20  us: int..    #: 
-000075d0: 5374 6f72 6520 7469 6d69 6e67 7320 666f  Store timings fo
-000075e0: 7220 6561 6368 2070 7265 6669 782d 6163  r each prefix-ac
-000075f0: 7469 6f6e 0a20 2020 2061 6c6c 5f64 7572  tion.    all_dur
-00007600: 6174 696f 6e73 3a20 6465 6661 756c 7464  ations: defaultd
-00007610: 6963 745b 7374 722c 2066 6c6f 6174 5d0a  ict[str, float].
-00007620: 0a20 2020 2023 3a20 5468 6973 206d 6561  .    #: This mea
-00007630: 7375 7265 7320 7468 6520 6d61 7869 6d75  sures the maximu
-00007640: 6d20 7265 636f 7264 6564 206c 6976 6520  m recorded live 
-00007650: 6578 6563 7574 696f 6e20 7469 6d65 2061  execution time a
-00007660: 6e64 2063 616e 2062 6520 7573 6564 2074  nd can be used t
-00007670: 6f0a 2020 2020 233a 2064 6574 6563 7420  o.    #: detect 
-00007680: 6f75 746c 6965 7273 0a20 2020 206d 6178  outliers.    max
-00007690: 5f65 7865 635f 7469 6d65 3a20 666c 6f61  _exec_time: floa
-000076a0: 740a 0a20 2020 2023 3a20 5461 736b 2067  t..    #: Task g
-000076b0: 726f 7570 7320 6173 736f 6369 6174 6564  roups associated
-000076c0: 2074 6f20 7468 6973 2070 7265 6669 780a   to this prefix.
-000076d0: 2020 2020 6772 6f75 7073 3a20 6c69 7374      groups: list
-000076e0: 5b54 6173 6b47 726f 7570 5d0a 0a20 2020  [TaskGroup]..   
-000076f0: 2023 3a20 4163 6375 6d75 6c61 7465 2063   #: Accumulate c
-00007700: 6f75 6e74 206f 6620 6e75 6d62 6572 206f  ount of number o
-00007710: 6620 7461 736b 7320 696e 2065 6163 6820  f tasks in each 
-00007720: 7374 6174 650a 2020 2020 7374 6174 655f  state.    state_
-00007730: 636f 756e 7473 3a20 6465 6661 756c 7464  counts: defaultd
-00007740: 6963 745b 5461 736b 5374 6174 6553 7461  ict[TaskStateSta
-00007750: 7465 2c20 696e 745d 0a0a 2020 2020 5f5f  te, int]..    __
-00007760: 736c 6f74 735f 5f20 3d20 7475 706c 6528  slots__ = tuple(
-00007770: 5f5f 616e 6e6f 7461 7469 6f6e 735f 5f29  __annotations__)
-00007780: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00007790: 5f5f 2873 656c 662c 206e 616d 653a 2073  __(self, name: s
-000077a0: 7472 293a 0a20 2020 2020 2020 2073 656c  tr):.        sel
-000077b0: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
-000077c0: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
-000077d0: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
-000077e0: 656c 662e 616c 6c5f 6475 7261 7469 6f6e  elf.all_duration
-000077f0: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-00007800: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
-00007810: 656c 662e 7374 6174 655f 636f 756e 7473  elf.state_counts
-00007820: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
-00007830: 6e74 290a 2020 2020 2020 2020 7461 736b  nt).        task
-00007840: 5f64 7572 6174 696f 6e73 203d 2064 6173  _durations = das
-00007850: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-00007860: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-00007870: 6c65 722e 6465 6661 756c 742d 7461 736b  ler.default-task
-00007880: 2d64 7572 6174 696f 6e73 2229 0a20 2020  -durations").   
-00007890: 2020 2020 2069 6620 7365 6c66 2e6e 616d       if self.nam
-000078a0: 6520 696e 2074 6173 6b5f 6475 7261 7469  e in task_durati
-000078b0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-000078c0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
-000078d0: 7665 7261 6765 203d 2070 6172 7365 5f74  verage = parse_t
-000078e0: 696d 6564 656c 7461 2874 6173 6b5f 6475  imedelta(task_du
-000078f0: 7261 7469 6f6e 735b 7365 6c66 2e6e 616d  rations[self.nam
-00007900: 655d 290a 2020 2020 2020 2020 656c 7365  e]).        else
-00007910: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00007920: 6c66 2e64 7572 6174 696f 6e5f 6176 6572  lf.duration_aver
-00007930: 6167 6520 3d20 2d31 0a20 2020 2020 2020  age = -1.       
-00007940: 2073 656c 662e 6d61 785f 6578 6563 5f74   self.max_exec_t
-00007950: 696d 6520 3d20 2d31 0a20 2020 2020 2020  ime = -1.       
-00007960: 2073 656c 662e 7375 7370 6963 696f 7573   self.suspicious
-00007970: 203d 2030 0a0a 2020 2020 6465 6620 6164   = 0..    def ad
-00007980: 645f 6578 6563 5f74 696d 6528 7365 6c66  d_exec_time(self
-00007990: 2c20 6475 7261 7469 6f6e 3a20 666c 6f61  , duration: floa
-000079a0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-000079b0: 2020 2020 7365 6c66 2e6d 6178 5f65 7865      self.max_exe
-000079c0: 635f 7469 6d65 203d 206d 6178 2864 7572  c_time = max(dur
-000079d0: 6174 696f 6e2c 2073 656c 662e 6d61 785f  ation, self.max_
-000079e0: 6578 6563 5f74 696d 6529 0a20 2020 2020  exec_time).     
-000079f0: 2020 2069 6620 6475 7261 7469 6f6e 203e     if duration >
-00007a00: 2032 202a 2073 656c 662e 6475 7261 7469   2 * self.durati
-00007a10: 6f6e 5f61 7665 7261 6765 3a0a 2020 2020  on_average:.    
-00007a20: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
-00007a30: 6174 696f 6e5f 6176 6572 6167 6520 3d20  ation_average = 
-00007a40: 2d31 0a0a 2020 2020 6465 6620 6164 645f  -1..    def add_
-00007a50: 6475 7261 7469 6f6e 2873 656c 662c 2061  duration(self, a
-00007a60: 6374 696f 6e3a 2073 7472 2c20 7374 6172  ction: str, star
-00007a70: 743a 2066 6c6f 6174 2c20 7374 6f70 3a20  t: float, stop: 
-00007a80: 666c 6f61 7429 202d 3e20 4e6f 6e65 3a0a  float) -> None:.
-00007a90: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-00007aa0: 203d 2073 746f 7020 2d20 7374 6172 740a   = stop - start.
-00007ab0: 2020 2020 2020 2020 7365 6c66 2e61 6c6c          self.all
-00007ac0: 5f64 7572 6174 696f 6e73 5b61 6374 696f  _durations[actio
-00007ad0: 6e5d 202b 3d20 6475 7261 7469 6f6e 0a20  n] += duration. 
-00007ae0: 2020 2020 2020 2069 6620 6163 7469 6f6e         if action
-00007af0: 203d 3d20 2263 6f6d 7075 7465 223a 0a20   == "compute":. 
-00007b00: 2020 2020 2020 2020 2020 206f 6c64 203d             old =
-00007b10: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
-00007b20: 7665 7261 6765 0a20 2020 2020 2020 2020  verage.         
-00007b30: 2020 2069 6620 6f6c 6420 3c20 303a 0a20     if old < 0:. 
-00007b40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007b50: 656c 662e 6475 7261 7469 6f6e 5f61 7665  elf.duration_ave
-00007b60: 7261 6765 203d 2064 7572 6174 696f 6e0a  rage = duration.
-00007b70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00007b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007b90: 2020 7365 6c66 2e64 7572 6174 696f 6e5f    self.duration_
-00007ba0: 6176 6572 6167 6520 3d20 302e 3520 2a20  average = 0.5 * 
-00007bb0: 6475 7261 7469 6f6e 202b 2030 2e35 202a  duration + 0.5 *
-00007bc0: 206f 6c64 0a0a 2020 2020 4070 726f 7065   old..    @prope
-00007bd0: 7274 790a 2020 2020 6465 6620 7374 6174  rty.    def stat
-00007be0: 6573 2873 656c 6629 202d 3e20 6469 6374  es(self) -> dict
-00007bf0: 5b73 7472 2c20 696e 745d 3a0a 2020 2020  [str, int]:.    
-00007c00: 2020 2020 2222 2254 6865 206e 756d 6265      """The numbe
-00007c10: 7220 6f66 2074 6173 6b73 2069 6e20 6561  r of tasks in ea
-00007c20: 6368 2073 7461 7465 2c0a 2020 2020 2020  ch state,.      
-00007c30: 2020 6c69 6b65 2060 607b 226d 656d 6f72    like ``{"memor
-00007c40: 7922 3a20 3130 2c20 2270 726f 6365 7373  y": 10, "process
-00007c50: 696e 6722 3a20 332c 2022 7265 6c65 6173  ing": 3, "releas
-00007c60: 6564 223a 2034 2c20 2e2e 2e7d 6060 0a20  ed": 4, ...}``. 
-00007c70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007c80: 2020 2072 6574 7572 6e20 6d65 7267 655f     return merge_
-00007c90: 7769 7468 2873 756d 2c20 5b74 672e 7374  with(sum, [tg.st
-00007ca0: 6174 6573 2066 6f72 2074 6720 696e 2073  ates for tg in s
-00007cb0: 656c 662e 6772 6f75 7073 5d29 0a0a 2020  elf.groups])..  
-00007cc0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00007cd0: 6465 6620 6163 7469 7665 2873 656c 6629  def active(self)
-00007ce0: 202d 3e20 6c69 7374 5b54 6173 6b47 726f   -> list[TaskGro
-00007cf0: 7570 5d3a 0a20 2020 2020 2020 2072 6574  up]:.        ret
-00007d00: 7572 6e20 5b0a 2020 2020 2020 2020 2020  urn [.          
-00007d10: 2020 7467 0a20 2020 2020 2020 2020 2020    tg.           
-00007d20: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
-00007d30: 6772 6f75 7073 0a20 2020 2020 2020 2020  groups.         
-00007d40: 2020 2069 6620 616e 7928 6b20 213d 2022     if any(k != "
-00007d50: 666f 7267 6f74 7465 6e22 2061 6e64 2076  forgotten" and v
-00007d60: 2021 3d20 3020 666f 7220 6b2c 2076 2069   != 0 for k, v i
-00007d70: 6e20 7467 2e73 7461 7465 732e 6974 656d  n tg.states.item
-00007d80: 7328 2929 0a20 2020 2020 2020 205d 0a0a  s()).        ]..
-00007d90: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00007da0: 2020 6465 6620 6163 7469 7665 5f73 7461    def active_sta
-00007db0: 7465 7328 7365 6c66 2920 2d3e 2064 6963  tes(self) -> dic
-00007dc0: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
-00007dd0: 2020 2020 2072 6574 7572 6e20 6d65 7267       return merg
-00007de0: 655f 7769 7468 2873 756d 2c20 5b74 672e  e_with(sum, [tg.
-00007df0: 7374 6174 6573 2066 6f72 2074 6720 696e  states for tg in
-00007e00: 2073 656c 662e 6163 7469 7665 5d29 0a0a   self.active])..
-00007e10: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-00007e20: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00007e30: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
-00007e40: 2020 2020 2020 2020 2020 2020 223c 220a              "<".
-00007e50: 2020 2020 2020 2020 2020 2020 2b20 7365              + se
-00007e60: 6c66 2e6e 616d 650a 2020 2020 2020 2020  lf.name.        
-00007e70: 2020 2020 2b20 223a 2022 0a20 2020 2020      + ": ".     
-00007e80: 2020 2020 2020 202b 2022 2c20 222e 6a6f         + ", ".jo
-00007e90: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-00007ea0: 2020 2020 2225 733a 2025 6422 2025 2028      "%s: %d" % (
-00007eb0: 6b2c 2076 2920 666f 7220 286b 2c20 7629  k, v) for (k, v)
-00007ec0: 2069 6e20 736f 7274 6564 2873 656c 662e   in sorted(self.
-00007ed0: 7374 6174 6573 2e69 7465 6d73 2829 2920  states.items()) 
-00007ee0: 6966 2076 0a20 2020 2020 2020 2020 2020  if v.           
-00007ef0: 2029 0a20 2020 2020 2020 2020 2020 202b   ).            +
-00007f00: 2022 3e22 0a20 2020 2020 2020 2029 0a0a   ">".        )..
-00007f10: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00007f20: 2020 6465 6620 6e62 7974 6573 5f74 6f74    def nbytes_tot
-00007f30: 616c 2873 656c 6629 202d 3e20 696e 743a  al(self) -> int:
-00007f40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007f50: 7375 6d28 7467 2e6e 6279 7465 735f 746f  sum(tg.nbytes_to
-00007f60: 7461 6c20 666f 7220 7467 2069 6e20 7365  tal for tg in se
-00007f70: 6c66 2e67 726f 7570 7329 0a0a 2020 2020  lf.groups)..    
-00007f80: 6465 6620 5f5f 6c65 6e5f 5f28 7365 6c66  def __len__(self
-00007f90: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-00007fa0: 2020 7265 7475 726e 2073 756d 286d 6170    return sum(map
-00007fb0: 286c 656e 2c20 7365 6c66 2e67 726f 7570  (len, self.group
-00007fc0: 7329 290a 0a20 2020 2040 7072 6f70 6572  s))..    @proper
-00007fd0: 7479 0a20 2020 2064 6566 2064 7572 6174  ty.    def durat
-00007fe0: 696f 6e28 7365 6c66 2920 2d3e 2066 6c6f  ion(self) -> flo
-00007ff0: 6174 3a0a 2020 2020 2020 2020 7265 7475  at:.        retu
-00008000: 726e 2073 756d 2874 672e 6475 7261 7469  rn sum(tg.durati
-00008010: 6f6e 2066 6f72 2074 6720 696e 2073 656c  on for tg in sel
-00008020: 662e 6772 6f75 7073 290a 0a20 2020 2040  f.groups)..    @
-00008030: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00008040: 2074 7970 6573 2873 656c 6629 202d 3e20   types(self) -> 
-00008050: 7365 745b 7374 725d 3a0a 2020 2020 2020  set[str]:.      
-00008060: 2020 7265 7475 726e 207b 7479 7020 666f    return {typ fo
-00008070: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
-00008080: 7570 7320 666f 7220 7479 7020 696e 2074  ups for typ in t
-00008090: 672e 7479 7065 737d 0a0a 0a63 6c61 7373  g.types}...class
-000080a0: 2054 6173 6b47 726f 7570 3a0a 2020 2020   TaskGroup:.    
-000080b0: 2222 2243 6f6c 6c65 6374 696f 6e20 7472  """Collection tr
-000080c0: 6163 6b69 6e67 2061 6c6c 2074 6173 6b73  acking all tasks
-000080d0: 2077 6974 6869 6e20 6120 6772 6f75 700a   within a group.
-000080e0: 0a20 2020 204b 6579 7320 6f66 7465 6e20  .    Keys often 
-000080f0: 6861 7665 2061 2073 7472 7563 7475 7265  have a structure
-00008100: 206c 696b 6520 6060 2822 782d 3132 3322   like ``("x-123"
-00008110: 2c20 3029 6060 0a20 2020 2041 2067 726f  , 0)``.    A gro
-00008120: 7570 2074 616b 6573 2074 6865 2066 6972  up takes the fir
-00008130: 7374 2073 6563 7469 6f6e 2c20 6c69 6b65  st section, like
-00008140: 2060 6022 782d 3132 3322 6060 0a0a 2020   ``"x-123"``..  
-00008150: 2020 5365 6520 616c 736f 0a20 2020 202d    See also.    -
-00008160: 2d2d 2d2d 2d2d 2d0a 2020 2020 5461 736b  -------.    Task
-00008170: 5072 6566 6978 0a20 2020 2022 2222 0a0a  Prefix.    """..
-00008180: 2020 2020 233a 2054 6865 206e 616d 6520      #: The name 
-00008190: 6f66 2061 2067 726f 7570 206f 6620 7461  of a group of ta
-000081a0: 736b 732e 0a20 2020 2023 3a20 466f 7220  sks..    #: For 
-000081b0: 6120 7461 736b 206c 696b 6520 6060 2822  a task like ``("
-000081c0: 782d 3132 3322 2c20 3029 6060 2074 6869  x-123", 0)`` thi
-000081d0: 7320 6973 2074 6865 2074 6578 7420 6060  s is the text ``
-000081e0: 2278 2d31 3233 2260 600a 2020 2020 6e61  "x-123"``.    na
-000081f0: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
-00008200: 5468 6520 6e75 6d62 6572 206f 6620 7461  The number of ta
-00008210: 736b 7320 696e 2065 6163 6820 7374 6174  sks in each stat
-00008220: 652c 0a20 2020 2023 3a20 6c69 6b65 2060  e,.    #: like `
-00008230: 607b 226d 656d 6f72 7922 3a20 3130 2c20  `{"memory": 10, 
-00008240: 2270 726f 6365 7373 696e 6722 3a20 332c  "processing": 3,
-00008250: 2022 7265 6c65 6173 6564 223a 2034 2c20   "released": 4, 
-00008260: 2e2e 2e7d 6060 0a20 2020 2073 7461 7465  ...}``.    state
-00008270: 733a 2064 6963 745b 5461 736b 5374 6174  s: dict[TaskStat
-00008280: 6553 7461 7465 2c20 696e 745d 0a0a 2020  eState, int]..  
-00008290: 2020 233a 2054 6865 206f 7468 6572 2054    #: The other T
-000082a0: 6173 6b47 726f 7570 7320 6f6e 2077 6869  askGroups on whi
-000082b0: 6368 2074 6869 7320 6f6e 6520 6465 7065  ch this one depe
-000082c0: 6e64 730a 2020 2020 6465 7065 6e64 656e  nds.    dependen
-000082d0: 6369 6573 3a20 7365 745b 5461 736b 4772  cies: set[TaskGr
-000082e0: 6f75 705d 0a0a 2020 2020 233a 2054 6865  oup]..    #: The
-000082f0: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
-00008300: 2062 7974 6573 2074 6861 7420 7468 6973   bytes that this
-00008310: 2074 6173 6b20 6772 6f75 7020 6861 7320   task group has 
-00008320: 7072 6f64 7563 6564 0a20 2020 206e 6279  produced.    nby
-00008330: 7465 735f 746f 7461 6c3a 2069 6e74 0a0a  tes_total: int..
-00008340: 2020 2020 233a 2054 6865 2074 6f74 616c      #: The total
-00008350: 2061 6d6f 756e 7420 6f66 2074 696d 6520   amount of time 
-00008360: 7370 656e 7420 6f6e 2061 6c6c 2074 6173  spent on all tas
-00008370: 6b73 2069 6e20 7468 6973 2054 6173 6b47  ks in this TaskG
-00008380: 726f 7570 0a20 2020 2064 7572 6174 696f  roup.    duratio
-00008390: 6e3a 2066 6c6f 6174 0a0a 2020 2020 233a  n: float..    #:
-000083a0: 2054 6865 2072 6573 756c 7420 7479 7065   The result type
-000083b0: 7320 6f66 2074 6869 7320 5461 736b 4772  s of this TaskGr
-000083c0: 6f75 700a 2020 2020 7479 7065 733a 2073  oup.    types: s
-000083d0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
-000083e0: 5468 6520 776f 726b 6572 206d 6f73 7420  The worker most 
-000083f0: 7265 6365 6e74 6c79 2061 7373 6967 6e65  recently assigne
-00008400: 6420 6120 7461 736b 2066 726f 6d20 7468  d a task from th
-00008410: 6973 2067 726f 7570 2c20 6f72 204e 6f6e  is group, or Non
-00008420: 6520 7768 656e 2074 6865 2067 726f 7570  e when the group
-00008430: 0a20 2020 2023 3a20 6973 206e 6f74 2069  .    #: is not i
-00008440: 6465 6e74 6966 6965 6420 746f 2062 6520  dentified to be 
-00008450: 726f 6f74 2d6c 696b 6520 6279 2060 5363  root-like by `Sc
-00008460: 6865 6475 6c65 7253 7461 7465 2e64 6563  hedulerState.dec
-00008470: 6964 655f 776f 726b 6572 602e 0a20 2020  ide_worker`..   
-00008480: 206c 6173 745f 776f 726b 6572 3a20 576f   last_worker: Wo
-00008490: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-000084a0: 0a0a 2020 2020 233a 2049 6620 606c 6173  ..    #: If `las
-000084b0: 745f 776f 726b 6572 6020 6973 206e 6f74  t_worker` is not
-000084c0: 204e 6f6e 652c 2074 6865 206e 756d 6265   None, the numbe
-000084d0: 7220 6f66 2074 696d 6573 2074 6861 7420  r of times that 
-000084e0: 776f 726b 6572 2073 686f 756c 6420 6265  worker should be
-000084f0: 2061 7373 6967 6e65 640a 2020 2020 233a   assigned.    #:
-00008500: 2073 7562 7365 7175 656e 7420 7461 736b   subsequent task
-00008510: 7320 756e 7469 6c20 6120 6e65 7720 776f  s until a new wo
-00008520: 726b 6572 2069 7320 6368 6f73 656e 2e0a  rker is chosen..
-00008530: 2020 2020 6c61 7374 5f77 6f72 6b65 725f      last_worker_
-00008540: 7461 736b 735f 6c65 6674 3a20 696e 740a  tasks_left: int.
-00008550: 0a20 2020 2070 7265 6669 783a 2054 6173  .    prefix: Tas
-00008560: 6b50 7265 6669 7820 7c20 4e6f 6e65 0a20  kPrefix | None. 
-00008570: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
-00008580: 2020 2020 7374 6f70 3a20 666c 6f61 740a      stop: float.
-00008590: 2020 2020 616c 6c5f 6475 7261 7469 6f6e      all_duration
-000085a0: 733a 2064 6566 6175 6c74 6469 6374 5b73  s: defaultdict[s
-000085b0: 7472 2c20 666c 6f61 745d 0a0a 2020 2020  tr, float]..    
-000085c0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
-000085d0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
-000085e0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
-000085f0: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
-00008600: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
-00008610: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
-00008620: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
-00008630: 6669 7820 3d20 4e6f 6e65 0a20 2020 2020  fix = None.     
-00008640: 2020 2073 656c 662e 7374 6174 6573 203d     self.states =
-00008650: 2064 6963 742e 6672 6f6d 6b65 7973 2841   dict.fromkeys(A
-00008660: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
-00008670: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-00008680: 6465 7065 6e64 656e 6369 6573 203d 2073  dependencies = s
-00008690: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-000086a0: 662e 6e62 7974 6573 5f74 6f74 616c 203d  f.nbytes_total =
-000086b0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-000086c0: 6475 7261 7469 6f6e 203d 2030 0a20 2020  duration = 0.   
-000086d0: 2020 2020 2073 656c 662e 7479 7065 7320       self.types 
-000086e0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-000086f0: 7365 6c66 2e73 7461 7274 203d 2030 2e30  self.start = 0.0
-00008700: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-00008710: 6f70 203d 2030 2e30 0a20 2020 2020 2020  op = 0.0.       
-00008720: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
-00008730: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
-00008740: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
-00008750: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
-00008760: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-00008770: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
-00008780: 725f 7461 736b 735f 6c65 6674 203d 2030  r_tasks_left = 0
-00008790: 0a0a 2020 2020 6465 6620 6164 645f 6475  ..    def add_du
-000087a0: 7261 7469 6f6e 2873 656c 662c 2061 6374  ration(self, act
-000087b0: 696f 6e3a 2073 7472 2c20 7374 6172 743a  ion: str, start:
-000087c0: 2066 6c6f 6174 2c20 7374 6f70 3a20 666c   float, stop: fl
-000087d0: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
-000087e0: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
-000087f0: 2073 746f 7020 2d20 7374 6172 740a 2020   stop - start.  
-00008800: 2020 2020 2020 7365 6c66 2e61 6c6c 5f64        self.all_d
-00008810: 7572 6174 696f 6e73 5b61 6374 696f 6e5d  urations[action]
-00008820: 202b 3d20 6475 7261 7469 6f6e 0a20 2020   += duration.   
-00008830: 2020 2020 2069 6620 6163 7469 6f6e 203d       if action =
-00008840: 3d20 2263 6f6d 7075 7465 223a 0a20 2020  = "compute":.   
-00008850: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00008860: 2e73 746f 7020 3c20 7374 6f70 3a0a 2020  .stop < stop:.  
-00008870: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00008880: 6c66 2e73 746f 7020 3d20 7374 6f70 0a20  lf.stop = stop. 
-00008890: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000088a0: 7374 6172 7420 3d20 7365 6c66 2e73 7461  start = self.sta
-000088b0: 7274 206f 7220 7374 6172 740a 2020 2020  rt or start.    
-000088c0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
-000088d0: 6e20 2b3d 2064 7572 6174 696f 6e0a 2020  n += duration.  
-000088e0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-000088f0: 662e 7072 6566 6978 2069 7320 6e6f 7420  f.prefix is not 
-00008900: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-00008910: 662e 7072 6566 6978 2e61 6464 5f64 7572  f.prefix.add_dur
-00008920: 6174 696f 6e28 6163 7469 6f6e 2c20 7374  ation(action, st
-00008930: 6172 742c 2073 746f 7029 0a0a 2020 2020  art, stop)..    
-00008940: 6465 6620 6164 6428 7365 6c66 2c20 6f74  def add(self, ot
-00008950: 6865 723a 2054 6173 6b53 7461 7465 2920  her: TaskState) 
-00008960: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00008970: 2073 656c 662e 7374 6174 6573 5b6f 7468   self.states[oth
-00008980: 6572 2e73 7461 7465 5d20 2b3d 2031 0a20  er.state] += 1. 
-00008990: 2020 2020 2020 206f 7468 6572 2e67 726f         other.gro
-000089a0: 7570 203d 2073 656c 660a 0a20 2020 2064  up = self..    d
-000089b0: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-000089c0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-000089d0: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-000089e0: 2020 2020 2020 2022 3c22 0a20 2020 2020         "<".     
-000089f0: 2020 2020 2020 202b 2028 7365 6c66 2e6e         + (self.n
-00008a00: 616d 6520 6f72 2022 6e6f 2d67 726f 7570  ame or "no-group
-00008a10: 2229 0a20 2020 2020 2020 2020 2020 202b  ").            +
-00008a20: 2022 3a20 220a 2020 2020 2020 2020 2020   ": ".          
-00008a30: 2020 2b20 222c 2022 2e6a 6f69 6e28 0a20    + ", ".join(. 
-00008a40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00008a50: 2573 3a20 2564 2220 2520 286b 2c20 7629  %s: %d" % (k, v)
-00008a60: 2066 6f72 2028 6b2c 2076 2920 696e 2073   for (k, v) in s
-00008a70: 6f72 7465 6428 7365 6c66 2e73 7461 7465  orted(self.state
-00008a80: 732e 6974 656d 7328 2929 2069 6620 760a  s.items()) if v.
-00008a90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00008aa0: 2020 2020 2020 2020 2020 2b20 223e 220a            + ">".
-00008ab0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00008ac0: 6566 205f 5f6c 656e 5f5f 2873 656c 6629  ef __len__(self)
-00008ad0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-00008ae0: 2072 6574 7572 6e20 7375 6d28 7365 6c66   return sum(self
-00008af0: 2e73 7461 7465 732e 7661 6c75 6573 2829  .states.values()
-00008b00: 290a 0a20 2020 2064 6566 205f 746f 5f64  )..    def _to_d
-00008b10: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
-00008b20: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
-00008b30: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
-00008b40: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
-00008b50: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-00008b60: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-00008b70: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-00008b80: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-00008b90: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
-00008ba0: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
-00008bb0: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
-00008bc0: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
-00008bd0: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-00008be0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00008bf0: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
-00008c00: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-00008c10: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
-00008c20: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
-00008c30: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
-00008c40: 2020 2020 2054 6173 6b53 7461 7465 2e5f       TaskState._
-00008c50: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
-00008c60: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00008c70: 726e 2072 6563 7572 7369 7665 5f74 6f5f  rn recursive_to_
-00008c80: 6469 6374 2873 656c 662c 2065 7863 6c75  dict(self, exclu
-00008c90: 6465 3d65 7863 6c75 6465 2c20 6d65 6d62  de=exclude, memb
-00008ca0: 6572 733d 5472 7565 290a 0a0a 636c 6173  ers=True)...clas
-00008cb0: 7320 5461 736b 5374 6174 653a 0a20 2020  s TaskState:.   
-00008cc0: 2022 2222 4120 7369 6d70 6c65 206f 626a   """A simple obj
-00008cd0: 6563 7420 686f 6c64 696e 6720 696e 666f  ect holding info
-00008ce0: 726d 6174 696f 6e20 6162 6f75 7420 6120  rmation about a 
-00008cf0: 7461 736b 2e0a 0a20 2020 204e 6f74 2074  task...    Not t
-00008d00: 6f20 6265 2063 6f6e 6675 7365 6420 7769  o be confused wi
-00008d10: 7468 203a 636c 6173 733a 6064 6973 7472  th :class:`distr
-00008d20: 6962 7574 6564 2e77 6f72 6b65 725f 7374  ibuted.worker_st
-00008d30: 6174 655f 6d61 6368 696e 652e 5461 736b  ate_machine.Task
-00008d40: 5374 6174 6560 2c20 7768 6963 680a 2020  State`, which.  
-00008d50: 2020 686f 6c64 7320 7369 6d69 6c61 7220    holds similar 
-00008d60: 696e 666f 726d 6174 696f 6e20 6f6e 2074  information on t
-00008d70: 6865 2057 6f72 6b65 7220 7369 6465 2e0a  he Worker side..
-00008d80: 2020 2020 2222 220a 0a20 2020 2023 3a20      """..    #: 
-00008d90: 5468 6520 6b65 7920 6973 2074 6865 2075  The key is the u
-00008da0: 6e69 7175 6520 6964 656e 7469 6669 6572  nique identifier
-00008db0: 206f 6620 6120 7461 736b 2c20 6765 6e65   of a task, gene
-00008dc0: 7261 6c6c 7920 666f 726d 6564 2066 726f  rally formed fro
-00008dd0: 6d20 7468 6520 6e61 6d65 206f 6620 7468  m the name of th
-00008de0: 650a 2020 2020 233a 2066 756e 6374 696f  e.    #: functio
-00008df0: 6e2c 2066 6f6c 6c6f 7765 6420 6279 2061  n, followed by a
-00008e00: 2068 6173 6820 6f66 2074 6865 2066 756e   hash of the fun
-00008e10: 6374 696f 6e20 616e 6420 6172 6775 6d65  ction and argume
-00008e20: 6e74 732c 206c 696b 650a 2020 2020 233a  nts, like.    #:
-00008e30: 2060 6027 696e 632d 6162 3331 6330 3130   ``'inc-ab31c010
-00008e40: 3434 3439 3737 3030 3464 3635 3636 3130  444977004d656610
-00008e50: 6432 6434 3231 6563 2760 602e 0a20 2020  d2d421ec'``..   
-00008e60: 206b 6579 3a20 7374 720a 0a20 2020 2023   key: str..    #
-00008e70: 3a20 5468 6520 6272 6f61 6420 636c 6173  : The broad clas
-00008e80: 7320 6f66 2074 6173 6b73 2074 6f20 7768  s of tasks to wh
-00008e90: 6963 6820 7468 6973 2074 6173 6b20 6265  ich this task be
-00008ea0: 6c6f 6e67 7320 6c69 6b65 2022 696e 6322  longs like "inc"
-00008eb0: 206f 7220 2272 6561 645f 6373 7622 0a20   or "read_csv". 
-00008ec0: 2020 2070 7265 6669 783a 2054 6173 6b50     prefix: TaskP
-00008ed0: 7265 6669 780a 0a20 2020 2023 3a20 4120  refix..    #: A 
-00008ee0: 7370 6563 6966 6963 6174 696f 6e20 6f66  specification of
-00008ef0: 2068 6f77 2074 6f20 7275 6e20 7468 6520   how to run the 
-00008f00: 7461 736b 2e20 2054 6865 2074 7970 6520  task.  The type 
-00008f10: 616e 6420 6d65 616e 696e 6720 6f66 2074  and meaning of t
-00008f20: 6869 7320 7661 6c75 6520 6973 0a20 2020  his value is.   
-00008f30: 2023 3a20 6f70 6171 7565 2074 6f20 7468   #: opaque to th
-00008f40: 6520 7363 6865 6475 6c65 722c 2061 7320  e scheduler, as 
-00008f50: 6974 2069 7320 6f6e 6c79 2069 6e74 6572  it is only inter
-00008f60: 7072 6574 6564 2062 7920 7468 6520 776f  preted by the wo
-00008f70: 726b 6572 2074 6f20 7768 6963 6820 7468  rker to which th
-00008f80: 650a 2020 2020 233a 2074 6173 6b20 6973  e.    #: task is
-00008f90: 2073 656e 7420 666f 7220 6578 6563 7574   sent for execut
-00008fa0: 696e 672e 0a20 2020 2023 3a0a 2020 2020  ing..    #:.    
-00008fb0: 233a 2041 7320 6120 7370 6563 6961 6c20  #: As a special 
-00008fc0: 6361 7365 2c20 7468 6973 2061 7474 7269  case, this attri
-00008fd0: 6275 7465 206d 6179 2061 6c73 6f20 6265  bute may also be
-00008fe0: 2060 604e 6f6e 6560 602c 2069 6e20 7768   ``None``, in wh
-00008ff0: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
-00009000: 6b20 6973 0a20 2020 2023 3a20 2270 7572  k is.    #: "pur
-00009010: 6520 6461 7461 2220 2873 7563 6820 6173  e data" (such as
-00009020: 2c20 666f 7220 6578 616d 706c 652c 2061  , for example, a
-00009030: 2070 6965 6365 206f 6620 6461 7461 206c   piece of data l
-00009040: 6f61 6465 6420 696e 2074 6865 2073 6368  oaded in the sch
-00009050: 6564 756c 6572 2075 7369 6e67 0a20 2020  eduler using.   
-00009060: 2023 3a20 3a6d 6574 683a 6043 6c69 656e   #: :meth:`Clien
-00009070: 742e 7363 6174 7465 7260 292e 2020 4120  t.scatter`).  A 
-00009080: 2270 7572 6520 6461 7461 2220 7461 736b  "pure data" task
-00009090: 2063 616e 6e6f 7420 6265 2063 6f6d 7075   cannot be compu
-000090a0: 7465 6420 6167 6169 6e20 6966 2069 7473  ted again if its
-000090b0: 0a20 2020 2023 3a20 7661 6c75 6520 6973  .    #: value is
-000090c0: 206c 6f73 742e 0a20 2020 2072 756e 5f73   lost..    run_s
-000090d0: 7065 633a 206f 626a 6563 740a 0a20 2020  pec: object..   
-000090e0: 2023 3a20 5468 6520 7072 696f 7269 7479   #: The priority
-000090f0: 2070 726f 7669 6465 7320 6561 6368 2074   provides each t
-00009100: 6173 6b20 7769 7468 2061 2072 656c 6174  ask with a relat
-00009110: 6976 6520 7261 6e6b 696e 6720 7768 6963  ive ranking whic
-00009120: 6820 6973 2075 7365 6420 746f 2062 7265  h is used to bre
-00009130: 616b 0a20 2020 2023 3a20 7469 6573 2077  ak.    #: ties w
-00009140: 6865 6e20 6d61 6e79 2074 6173 6b73 2061  hen many tasks a
-00009150: 7265 2062 6569 6e67 2063 6f6e 7369 6465  re being conside
-00009160: 7265 6420 666f 7220 6578 6563 7574 696f  red for executio
-00009170: 6e2e 0a20 2020 2023 3a0a 2020 2020 233a  n..    #:.    #:
-00009180: 2054 6869 7320 7261 6e6b 696e 6720 6973   This ranking is
-00009190: 2067 656e 6572 616c 6c79 2061 2032 2d69   generally a 2-i
-000091a0: 7465 6d20 7475 706c 652e 2020 5468 6520  tem tuple.  The 
-000091b0: 6669 7273 7420 2861 6e64 2064 6f6d 696e  first (and domin
-000091c0: 616e 7429 2069 7465 6d0a 2020 2020 233a  ant) item.    #:
-000091d0: 2063 6f72 7265 7370 6f6e 6473 2074 6f20   corresponds to 
-000091e0: 7768 656e 2069 7420 7761 7320 7375 626d  when it was subm
-000091f0: 6974 7465 642e 2020 4765 6e65 7261 6c6c  itted.  Generall
-00009200: 792c 2065 6172 6c69 6572 2074 6173 6b73  y, earlier tasks
-00009210: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
-00009220: 2e0a 2020 2020 233a 2054 6865 2073 6563  ..    #: The sec
-00009230: 6f6e 6420 6974 656d 2069 7320 6465 7465  ond item is dete
-00009240: 726d 696e 6564 2062 7920 7468 6520 636c  rmined by the cl
-00009250: 6965 6e74 2c20 616e 6420 6973 2061 2077  ient, and is a w
-00009260: 6179 2074 6f20 7072 696f 7269 7469 7a65  ay to prioritize
-00009270: 2074 6173 6b73 0a20 2020 2023 3a20 7769   tasks.    #: wi
-00009280: 7468 696e 2061 206c 6172 6765 2067 7261  thin a large gra
-00009290: 7068 2074 6861 7420 6d61 7920 6265 2069  ph that may be i
-000092a0: 6d70 6f72 7461 6e74 2c20 7375 6368 2061  mportant, such a
-000092b0: 7320 6966 2074 6865 7920 6172 6520 6f6e  s if they are on
-000092c0: 2074 6865 2063 7269 7469 6361 6c0a 2020   the critical.  
-000092d0: 2020 233a 2070 6174 682c 206f 7220 676f    #: path, or go
-000092e0: 6f64 2074 6f20 7275 6e20 696e 206f 7264  od to run in ord
-000092f0: 6572 2074 6f20 7265 6c65 6173 6520 6d61  er to release ma
-00009300: 6e79 2064 6570 656e 6465 6e63 6965 732e  ny dependencies.
-00009310: 2020 5468 6973 2069 7320 6578 706c 6169    This is explai
-00009320: 6e65 640a 2020 2020 233a 2066 7572 7468  ned.    #: furth
-00009330: 6572 2069 6e20 3a64 6f63 3a60 5363 6865  er in :doc:`Sche
-00009340: 6475 6c69 6e67 2050 6f6c 6963 7920 3c73  duling Policy <s
-00009350: 6368 6564 756c 696e 672d 706f 6c69 6369  cheduling-polici
-00009360: 6573 3e60 2e0a 2020 2020 7072 696f 7269  es>`..    priori
-00009370: 7479 3a20 7475 706c 655b 666c 6f61 742c  ty: tuple[float,
-00009380: 202e 2e2e 5d20 7c20 4e6f 6e65 0a0a 2020   ...] | None..  
-00009390: 2020 2320 4174 7472 6962 7574 6520 756e    # Attribute un
-000093a0: 6465 726c 7969 6e67 2074 6865 2073 7461  derlying the sta
-000093b0: 7465 2070 726f 7065 7274 790a 2020 2020  te property.    
-000093c0: 5f73 7461 7465 3a20 5461 736b 5374 6174  _state: TaskStat
-000093d0: 6553 7461 7465 0a0a 2020 2020 233a 2054  eState..    #: T
-000093e0: 6865 2073 6574 206f 6620 7461 736b 7320  he set of tasks 
-000093f0: 7468 6973 2074 6173 6b20 6465 7065 6e64  this task depend
-00009400: 7320 6f6e 2066 6f72 2070 726f 7065 7220  s on for proper 
-00009410: 6578 6563 7574 696f 6e2e 204f 6e6c 7920  execution. Only 
-00009420: 7461 736b 7320 7374 696c 6c0a 2020 2020  tasks still.    
-00009430: 233a 2061 6c69 7665 2061 7265 206c 6973  #: alive are lis
-00009440: 7465 6420 696e 2074 6869 7320 7365 742e  ted in this set.
-00009450: 2049 662c 2066 6f72 2077 6861 7465 7665   If, for whateve
-00009460: 7220 7265 6173 6f6e 2c20 7468 6973 2074  r reason, this t
-00009470: 6173 6b20 616c 736f 2064 6570 656e 6473  ask also depends
-00009480: 206f 6e0a 2020 2020 233a 2061 2066 6f72   on.    #: a for
-00009490: 676f 7474 656e 2074 6173 6b2c 2074 6865  gotten task, the
-000094a0: 203a 6174 7472 3a60 6861 735f 6c6f 7374   :attr:`has_lost
-000094b0: 5f64 6570 656e 6465 6e63 6965 7360 2066  _dependencies` f
-000094c0: 6c61 6720 6973 2073 6574 2e0a 2020 2020  lag is set..    
-000094d0: 233a 0a20 2020 2023 3a20 4120 7461 736b  #:.    #: A task
-000094e0: 2063 616e 206f 6e6c 7920 6265 2065 7865   can only be exe
-000094f0: 6375 7465 6420 6f6e 6365 2061 6c6c 2069  cuted once all i
-00009500: 7473 2064 6570 656e 6465 6e63 6965 7320  ts dependencies 
-00009510: 6861 7665 2061 6c72 6561 6479 2062 6565  have already bee
-00009520: 6e0a 2020 2020 233a 2073 7563 6365 7373  n.    #: success
-00009530: 6675 6c6c 7920 6578 6563 7574 6564 2061  fully executed a
-00009540: 6e64 2068 6176 6520 7468 6569 7220 7265  nd have their re
-00009550: 7375 6c74 2073 746f 7265 6420 6f6e 2061  sult stored on a
-00009560: 7420 6c65 6173 7420 6f6e 6520 776f 726b  t least one work
-00009570: 6572 2e20 5468 6973 0a20 2020 2023 3a20  er. This.    #: 
-00009580: 6973 2074 7261 636b 6564 2062 7920 7072  is tracked by pr
-00009590: 6f67 7265 7373 6976 656c 7920 6472 6169  ogressively drai
-000095a0: 6e69 6e67 2074 6865 203a 6174 7472 3a60  ning the :attr:`
-000095b0: 7761 6974 696e 675f 6f6e 6020 7365 742e  waiting_on` set.
-000095c0: 0a20 2020 2064 6570 656e 6465 6e63 6965  .    dependencie
-000095d0: 733a 2073 6574 5b54 6173 6b53 7461 7465  s: set[TaskState
-000095e0: 5d0a 0a20 2020 2023 3a20 5468 6520 7365  ]..    #: The se
-000095f0: 7420 6f66 2074 6173 6b73 2077 6869 6368  t of tasks which
-00009600: 2064 6570 656e 6420 6f6e 2074 6869 7320   depend on this 
-00009610: 7461 736b 2e20 204f 6e6c 7920 7461 736b  task.  Only task
-00009620: 7320 7374 696c 6c20 616c 6976 6520 6172  s still alive ar
-00009630: 6520 6c69 7374 6564 2069 6e0a 2020 2020  e listed in.    
-00009640: 233a 2074 6869 7320 7365 742e 2054 6869  #: this set. Thi
-00009650: 7320 6973 2074 6865 2072 6576 6572 7365  s is the reverse
-00009660: 206d 6170 7069 6e67 206f 6620 3a61 7474   mapping of :att
-00009670: 723a 6064 6570 656e 6465 6e63 6965 7360  r:`dependencies`
-00009680: 2e0a 2020 2020 6465 7065 6e64 656e 7473  ..    dependents
-00009690: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
-000096a0: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
-000096b0: 2061 6e79 206f 6620 7468 6520 6465 7065   any of the depe
-000096c0: 6e64 656e 6369 6573 206f 6620 7468 6973  ndencies of this
-000096d0: 2074 6173 6b20 6861 7320 6265 656e 2066   task has been f
-000096e0: 6f72 676f 7474 656e 2e20 466f 7220 6d65  orgotten. For me
-000096f0: 6d6f 7279 0a20 2020 2023 3a20 636f 6e73  mory.    #: cons
-00009700: 756d 7074 696f 6e20 7265 6173 6f6e 732c  umption reasons,
-00009710: 2066 6f72 676f 7474 656e 2074 6173 6b73   forgotten tasks
-00009720: 2061 7265 206e 6f74 206b 6570 7420 696e   are not kept in
-00009730: 206d 656d 6f72 7920 6576 656e 2074 686f   memory even tho
-00009740: 7567 6820 7468 6579 206d 6179 0a20 2020  ugh they may.   
-00009750: 2023 3a20 6861 7665 2064 6570 656e 6465   #: have depende
-00009760: 6e74 2074 6173 6b73 2e20 2057 6865 6e20  nt tasks.  When 
-00009770: 6120 7461 736b 2069 7320 666f 7267 6f74  a task is forgot
-00009780: 7465 6e2c 2074 6865 7265 666f 7265 2c20  ten, therefore, 
-00009790: 6561 6368 206f 6620 6974 730a 2020 2020  each of its.    
-000097a0: 233a 2064 6570 656e 6465 6e74 7320 6861  #: dependents ha
-000097b0: 7320 7468 6569 7220 3a61 7474 723a 6068  s their :attr:`h
-000097c0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-000097d0: 6369 6573 6020 6174 7472 6962 7574 6520  cies` attribute 
-000097e0: 7365 7420 746f 2060 6054 7275 6560 602e  set to ``True``.
-000097f0: 0a20 2020 2023 3a0a 2020 2020 233a 2049  .    #:.    #: I
-00009800: 6620 3a61 7474 723a 6068 6173 5f6c 6f73  f :attr:`has_los
-00009810: 745f 6465 7065 6e64 656e 6369 6573 6020  t_dependencies` 
-00009820: 6973 2074 7275 652c 2074 6869 7320 7461  is true, this ta
-00009830: 736b 2063 616e 6e6f 7420 676f 2069 6e74  sk cannot go int
-00009840: 6f20 7468 650a 2020 2020 233a 2022 7072  o the.    #: "pr
-00009850: 6f63 6573 7369 6e67 2220 7374 6174 6520  ocessing" state 
-00009860: 616e 796d 6f72 652e 0a20 2020 2068 6173  anymore..    has
-00009870: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-00009880: 6573 3a20 626f 6f6c 0a0a 2020 2020 233a  es: bool..    #:
-00009890: 2054 6865 2073 6574 206f 6620 7461 736b   The set of task
-000098a0: 7320 7468 6973 2074 6173 6b20 6973 2077  s this task is w
-000098b0: 6169 7469 6e67 206f 6e20 2a62 6566 6f72  aiting on *befor
-000098c0: 652a 2069 7420 6361 6e20 6265 2065 7865  e* it can be exe
-000098d0: 6375 7465 642e 2054 6869 7320 6973 0a20  cuted. This is. 
-000098e0: 2020 2023 3a20 616c 7761 7973 2061 2073     #: always a s
-000098f0: 7562 7365 7420 6f66 203a 6174 7472 3a60  ubset of :attr:`
-00009900: 6465 7065 6e64 656e 6369 6573 602e 2020  dependencies`.  
-00009910: 4561 6368 2074 696d 6520 6f6e 6520 6f66  Each time one of
-00009920: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
-00009930: 7320 6861 730a 2020 2020 233a 2066 696e  s has.    #: fin
-00009940: 6973 6865 6420 7072 6f63 6573 7369 6e67  ished processing
-00009950: 2c20 6974 2069 7320 7265 6d6f 7665 6420  , it is removed 
-00009960: 6672 6f6d 2074 6865 203a 6174 7472 3a60  from the :attr:`
-00009970: 7761 6974 696e 675f 6f6e 6020 7365 742e  waiting_on` set.
-00009980: 0a20 2020 2023 3a0a 2020 2020 233a 204f  .    #:.    #: O
-00009990: 6e63 6520 3a61 7474 723a 6077 6169 7469  nce :attr:`waiti
-000099a0: 6e67 5f6f 6e60 2062 6563 6f6d 6573 2065  ng_on` becomes e
-000099b0: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
-000099c0: 6361 6e20 6d6f 7665 2066 726f 6d20 7468  can move from th
-000099d0: 6520 2277 6169 7469 6e67 220a 2020 2020  e "waiting".    
-000099e0: 233a 2073 7461 7465 2074 6f20 7468 6520  #: state to the 
-000099f0: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
-00009a00: 7465 2028 756e 6c65 7373 206f 6e65 206f  te (unless one o
-00009a10: 6620 7468 6520 6465 7065 6e64 656e 6369  f the dependenci
-00009a20: 6573 2065 7272 6f72 6564 206f 7574 2c20  es errored out, 
-00009a30: 696e 0a20 2020 2023 3a20 7768 6963 6820  in.    #: which 
-00009a40: 6361 7365 2074 6869 7320 7461 736b 2069  case this task i
-00009a50: 7320 696e 7374 6561 6420 6d61 726b 6564  s instead marked
-00009a60: 2022 6572 7265 6422 292e 0a20 2020 2077   "erred")..    w
-00009a70: 6169 7469 6e67 5f6f 6e3a 2073 6574 5b54  aiting_on: set[T
-00009a80: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
-00009a90: 3a20 5468 6520 7365 7420 6f66 2074 6173  : The set of tas
-00009aa0: 6b73 2077 6869 6368 206e 6565 6420 7468  ks which need th
-00009ab0: 6973 2074 6173 6b20 746f 2072 656d 6169  is task to remai
-00009ac0: 6e20 616c 6976 652e 2020 5468 6973 2069  n alive.  This i
-00009ad0: 7320 616c 7761 7973 2061 2073 7562 7365  s always a subse
-00009ae0: 740a 2020 2020 233a 206f 6620 3a61 7474  t.    #: of :att
-00009af0: 723a 6064 6570 656e 6465 6e74 7360 2e20  r:`dependents`. 
-00009b00: 2045 6163 6820 7469 6d65 206f 6e65 206f   Each time one o
-00009b10: 6620 7468 6520 6465 7065 6e64 656e 7473  f the dependents
-00009b20: 2068 6173 2066 696e 6973 6865 6420 7072   has finished pr
-00009b30: 6f63 6573 7369 6e67 2c0a 2020 2020 233a  ocessing,.    #:
-00009b40: 2069 7420 6973 2072 656d 6f76 6564 2066   it is removed f
-00009b50: 726f 6d20 7468 6520 3a61 7474 723a 6077  rom the :attr:`w
-00009b60: 6169 7465 7273 6020 7365 742e 0a20 2020  aiters` set..   
-00009b70: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
-00009b80: 626f 7468 203a 6174 7472 3a60 7761 6974  both :attr:`wait
-00009b90: 6572 7360 2061 6e64 203a 6174 7472 3a60  ers` and :attr:`
-00009ba0: 7768 6f5f 7761 6e74 7360 2062 6563 6f6d  who_wants` becom
-00009bb0: 6520 656d 7074 792c 2074 6869 7320 7461  e empty, this ta
-00009bc0: 736b 2063 616e 2062 650a 2020 2020 233a  sk can be.    #:
-00009bd0: 2072 656c 6561 7365 6420 2869 6620 6974   released (if it
-00009be0: 2068 6173 2061 206e 6f6e 2d65 6d70 7479   has a non-empty
-00009bf0: 203a 6174 7472 3a60 7275 6e5f 7370 6563   :attr:`run_spec
-00009c00: 6029 206f 7220 666f 7267 6f74 7465 6e20  `) or forgotten 
-00009c10: 286f 7468 6572 7769 7365 2920 6279 2074  (otherwise) by t
-00009c20: 6865 0a20 2020 2023 3a20 7363 6865 6475  he.    #: schedu
-00009c30: 6c65 722c 2061 6e64 2062 7920 616e 7920  ler, and by any 
-00009c40: 776f 726b 6572 7320 696e 203a 6174 7472  workers in :attr
-00009c50: 3a60 7768 6f5f 6861 7360 2e0a 2020 2020  :`who_has`..    
-00009c60: 233a 0a20 2020 2023 3a20 2e2e 206e 6f74  #:.    #: .. not
-00009c70: 653a 3a0a 2020 2020 233a 2020 2020 436f  e::.    #:    Co
-00009c80: 756e 7465 722d 696e 7475 6974 6976 656c  unter-intuitivel
-00009c90: 792c 203a 6174 7472 3a60 7761 6974 696e  y, :attr:`waitin
-00009ca0: 675f 6f6e 6020 616e 6420 3a61 7474 723a  g_on` and :attr:
-00009cb0: 6077 6169 7465 7273 6020 6172 6520 6e6f  `waiters` are no
-00009cc0: 7420 7265 7665 7273 650a 2020 2020 233a  t reverse.    #:
-00009cd0: 2020 2020 6d61 7070 696e 6773 206f 6620      mappings of 
-00009ce0: 6561 6368 206f 7468 6572 2e0a 2020 2020  each other..    
-00009cf0: 7761 6974 6572 733a 2073 6574 5b54 6173  waiters: set[Tas
-00009d00: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
-00009d10: 5468 6520 7365 7420 6f66 2063 6c69 656e  The set of clien
-00009d20: 7473 2077 686f 2077 616e 7420 7468 6520  ts who want the 
-00009d30: 7265 7375 6c74 206f 6620 7468 6973 2074  result of this t
-00009d40: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
-00009d50: 6976 652e 0a20 2020 2023 3a20 5468 6973  ive..    #: This
-00009d60: 2069 7320 7468 6520 7265 7665 7273 6520   is the reverse 
-00009d70: 6d61 7070 696e 6720 6f66 203a 6174 7472  mapping of :attr
-00009d80: 3a60 436c 6965 6e74 5374 6174 652e 7761  :`ClientState.wa
-00009d90: 6e74 735f 7768 6174 602e 0a20 2020 2023  nts_what`..    #
-00009da0: 3a0a 2020 2020 233a 2057 6865 6e20 6120  :.    #: When a 
-00009db0: 636c 6965 6e74 2073 7562 6d69 7473 2061  client submits a
-00009dc0: 2067 7261 7068 2074 6f20 7468 6520 7363   graph to the sc
-00009dd0: 6865 6475 6c65 7220 6974 2061 6c73 6f20  heduler it also 
-00009de0: 7370 6563 6966 6965 7320 7768 6963 6820  specifies which 
-00009df0: 6f75 7470 7574 0a20 2020 2023 3a20 7461  output.    #: ta
-00009e00: 736b 7320 6974 2064 6573 6972 6573 2c20  sks it desires, 
-00009e10: 7375 6368 2074 6861 7420 7468 6569 7220  such that their 
-00009e20: 7265 7375 6c74 7320 6172 6520 6e6f 7420  results are not 
-00009e30: 7265 6c65 6173 6564 2066 726f 6d20 6d65  released from me
-00009e40: 6d6f 7279 2e0a 2020 2020 233a 0a20 2020  mory..    #:.   
-00009e50: 2023 3a20 4f6e 6365 2061 2074 6173 6b20   #: Once a task 
-00009e60: 6861 7320 6669 6e69 7368 6564 2065 7865  has finished exe
-00009e70: 6375 7469 6e67 2028 692e 652e 206d 6f76  cuting (i.e. mov
-00009e80: 6573 2069 6e74 6f20 7468 6520 226d 656d  es into the "mem
-00009e90: 6f72 7922 206f 7220 2265 7272 6564 220a  ory" or "erred".
-00009ea0: 2020 2020 233a 2073 7461 7465 292c 2074      #: state), t
-00009eb0: 6865 2063 6c69 656e 7473 2069 6e20 3a61  he clients in :a
-00009ec0: 7474 723a 6077 686f 5f77 616e 7473 6020  ttr:`who_wants` 
-00009ed0: 6172 6520 6e6f 7469 6669 6564 2e0a 2020  are notified..  
-00009ee0: 2020 233a 0a20 2020 2023 3a20 4f6e 6365    #:.    #: Once
-00009ef0: 2062 6f74 6820 3a61 7474 723a 6077 6169   both :attr:`wai
-00009f00: 7465 7273 6020 616e 6420 3a61 7474 723a  ters` and :attr:
-00009f10: 6077 686f 5f77 616e 7473 6020 6265 636f  `who_wants` beco
-00009f20: 6d65 2065 6d70 7479 2c20 7468 6973 2074  me empty, this t
-00009f30: 6173 6b20 6361 6e20 6265 0a20 2020 2023  ask can be.    #
-00009f40: 3a20 7265 6c65 6173 6564 2028 6966 2069  : released (if i
-00009f50: 7420 6861 7320 6120 6e6f 6e2d 656d 7074  t has a non-empt
-00009f60: 7920 3a61 7474 723a 6072 756e 5f73 7065  y :attr:`run_spe
-00009f70: 6360 2920 6f72 2066 6f72 676f 7474 656e  c`) or forgotten
-00009f80: 2028 6f74 6865 7277 6973 6529 2062 7920   (otherwise) by 
-00009f90: 7468 650a 2020 2020 233a 2073 6368 6564  the.    #: sched
-00009fa0: 756c 6572 2c20 616e 6420 6279 2061 6e79  uler, and by any
-00009fb0: 2077 6f72 6b65 7273 2069 6e20 3a61 7474   workers in :att
-00009fc0: 723a 6077 686f 5f68 6173 602e 0a20 2020  r:`who_has`..   
-00009fd0: 2077 686f 5f77 616e 7473 3a20 7365 745b   who_wants: set[
-00009fe0: 436c 6965 6e74 5374 6174 655d 0a0a 2020  ClientState]..  
-00009ff0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
-0000a000: 776f 726b 6572 7320 7768 6f20 6861 7665  workers who have
-0000a010: 2074 6869 7320 7461 736b 2773 2072 6573   this task's res
-0000a020: 756c 7420 696e 206d 656d 6f72 792e 2049  ult in memory. I
-0000a030: 7420 6973 206e 6f6e 2d65 6d70 7479 2069  t is non-empty i
-0000a040: 6666 2074 6865 0a20 2020 2023 3a20 7461  ff the.    #: ta
-0000a050: 736b 2069 7320 696e 2074 6865 2022 6d65  sk is in the "me
-0000a060: 6d6f 7279 2220 7374 6174 652e 2020 5468  mory" state.  Th
-0000a070: 6572 6520 6361 6e20 6265 206d 6f72 6520  ere can be more 
-0000a080: 7468 616e 206f 6e65 2077 6f72 6b65 7220  than one worker 
-0000a090: 696e 2074 6869 7320 7365 7420 6966 2c0a  in this set if,.
-0000a0a0: 2020 2020 233a 2066 6f72 2065 7861 6d70      #: for examp
-0000a0b0: 6c65 2c20 3a6d 6574 683a 6043 6c69 656e  le, :meth:`Clien
-0000a0c0: 742e 7363 6174 7465 7260 206f 7220 3a6d  t.scatter` or :m
-0000a0d0: 6574 683a 6043 6c69 656e 742e 7265 706c  eth:`Client.repl
-0000a0e0: 6963 6174 6560 2077 6173 2075 7365 642e  icate` was used.
-0000a0f0: 0a20 2020 2023 3a0a 2020 2020 233a 2054  .    #:.    #: T
-0000a100: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
-0000a110: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
-0000a120: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
-0000a130: 2e68 6173 5f77 6861 7460 2e0a 2020 2020  .has_what`..    
-0000a140: 7768 6f5f 6861 733a 2073 6574 5b57 6f72  who_has: set[Wor
-0000a150: 6b65 7253 7461 7465 5d0a 0a20 2020 2023  kerState]..    #
-0000a160: 3a20 4966 2074 6869 7320 7461 736b 2069  : If this task i
-0000a170: 7320 696e 2074 6865 2022 7072 6f63 6573  s in the "proces
-0000a180: 7369 6e67 2220 7374 6174 652c 2077 6869  sing" state, whi
-0000a190: 6368 2077 6f72 6b65 7220 6973 2063 7572  ch worker is cur
-0000a1a0: 7265 6e74 6c79 2070 726f 6365 7373 696e  rently processin
-0000a1b0: 670a 2020 2020 233a 2069 742e 2054 6869  g.    #: it. Thi
-0000a1c0: 7320 6174 7472 6962 7574 6520 6973 206b  s attribute is k
-0000a1d0: 6570 7420 696e 2073 796e 6320 7769 7468  ept in sync with
-0000a1e0: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
-0000a1f0: 6174 652e 7072 6f63 6573 7369 6e67 602e  ate.processing`.
-0000a200: 0a20 2020 2070 726f 6365 7373 696e 675f  .    processing_
-0000a210: 6f6e 3a20 576f 726b 6572 5374 6174 6520  on: WorkerState 
-0000a220: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2054  | None..    #: T
-0000a230: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
-0000a240: 6573 2074 6869 7320 7461 736b 2063 616e  es this task can
-0000a250: 2061 7574 6f6d 6174 6963 616c 6c79 2062   automatically b
-0000a260: 6520 7265 7472 6965 6420 696e 2063 6173  e retried in cas
-0000a270: 6520 6f66 2066 6169 6c75 7265 2e0a 2020  e of failure..  
-0000a280: 2020 233a 2049 6620 6120 7461 736b 2066    #: If a task f
-0000a290: 6169 6c73 2065 7865 6375 7469 6e67 2028  ails executing (
-0000a2a0: 7468 6520 776f 726b 6572 2072 6574 7572  the worker retur
-0000a2b0: 6e73 2077 6974 6820 616e 2065 7272 6f72  ns with an error
-0000a2c0: 292c 2069 7473 203a 6174 7472 3a60 7265  ), its :attr:`re
-0000a2d0: 7472 6965 7360 0a20 2020 2023 3a20 6174  tries`.    #: at
-0000a2e0: 7472 6962 7574 6520 6973 2063 6865 636b  tribute is check
-0000a2f0: 6564 2e20 4966 2069 7420 6973 2065 7175  ed. If it is equ
-0000a300: 616c 2074 6f20 302c 2074 6865 2074 6173  al to 0, the tas
-0000a310: 6b20 6973 206d 6172 6b65 6420 2265 7272  k is marked "err
-0000a320: 6564 222e 2049 6620 6974 2069 730a 2020  ed". If it is.  
-0000a330: 2020 233a 2067 7265 6174 6572 2074 6861    #: greater tha
-0000a340: 6e20 302c 2074 6865 203a 6174 7472 3a60  n 0, the :attr:`
-0000a350: 7265 7472 6965 7360 2061 7474 7269 6275  retries` attribu
-0000a360: 7465 2069 7320 6465 6372 656d 656e 7465  te is decremente
-0000a370: 6420 616e 6420 6578 6563 7574 696f 6e20  d and execution 
-0000a380: 6973 0a20 2020 2023 3a20 6174 7465 6d70  is.    #: attemp
-0000a390: 7465 6420 6167 6169 6e2e 0a20 2020 2072  ted again..    r
-0000a3a0: 6574 7269 6573 3a20 696e 740a 0a20 2020  etries: int..   
-0000a3b0: 2023 3a20 5468 6520 6e75 6d62 6572 206f   #: The number o
-0000a3c0: 6620 6279 7465 732c 2061 7320 6465 7465  f bytes, as dete
-0000a3d0: 726d 696e 6564 2062 7920 6060 7369 7a65  rmined by ``size
-0000a3e0: 6f66 6060 2c20 6f66 2074 6865 2072 6573  of``, of the res
-0000a3f0: 756c 7420 6f66 2061 2066 696e 6973 6865  ult of a finishe
-0000a400: 640a 2020 2020 233a 2074 6173 6b2e 2054  d.    #: task. T
-0000a410: 6869 7320 6e75 6d62 6572 2069 7320 7573  his number is us
-0000a420: 6564 2066 6f72 2064 6961 676e 6f73 7469  ed for diagnosti
-0000a430: 6373 2061 6e64 2074 6f20 6865 6c70 2070  cs and to help p
-0000a440: 7269 6f72 6974 697a 6520 776f 726b 2e0a  rioritize work..
-0000a450: 2020 2020 233a 2053 6574 2074 6f20 2d31      #: Set to -1
-0000a460: 2066 6f72 2075 6e66 696e 6973 6865 6420   for unfinished 
-0000a470: 7461 736b 732e 0a20 2020 206e 6279 7465  tasks..    nbyte
-0000a480: 733a 2069 6e74 0a0a 2020 2020 233a 2054  s: int..    #: T
-0000a490: 6865 2074 7970 6520 6f66 2074 6865 206f  he type of the o
-0000a4a0: 626a 6563 7420 6173 2061 2073 7472 696e  bject as a strin
-0000a4b0: 672e 204f 6e6c 7920 7072 6573 656e 7420  g. Only present 
-0000a4c0: 666f 7220 7461 736b 7320 7468 6174 2068  for tasks that h
-0000a4d0: 6176 6520 6265 656e 0a20 2020 2023 3a20  ave been.    #: 
-0000a4e0: 636f 6d70 7574 6564 2e0a 2020 2020 7479  computed..    ty
-0000a4f0: 7065 3a20 7374 720a 0a20 2020 2023 3a20  pe: str..    #: 
-0000a500: 4966 2074 6869 7320 7461 736b 2066 6169  If this task fai
-0000a510: 6c65 6420 6578 6563 7574 696e 672c 2074  led executing, t
-0000a520: 6865 2065 7863 6570 7469 6f6e 206f 626a  he exception obj
-0000a530: 6563 7420 6973 2073 746f 7265 6420 6865  ect is stored he
-0000a540: 7265 2e0a 2020 2020 6578 6365 7074 696f  re..    exceptio
-0000a550: 6e3a 2053 6572 6961 6c69 7a65 6420 7c20  n: Serialized | 
-0000a560: 4e6f 6e65 0a0a 2020 2020 233a 2049 6620  None..    #: If 
-0000a570: 7468 6973 2074 6173 6b20 6661 696c 6564  this task failed
-0000a580: 2065 7865 6375 7469 6e67 2c20 7468 6520   executing, the 
-0000a590: 7472 6163 6562 6163 6b20 6f62 6a65 6374  traceback object
-0000a5a0: 2069 7320 7374 6f72 6564 2068 6572 652e   is stored here.
-0000a5b0: 0a20 2020 2074 7261 6365 6261 636b 3a20  .    traceback: 
-0000a5c0: 5365 7269 616c 697a 6564 207c 204e 6f6e  Serialized | Non
-0000a5d0: 650a 0a20 2020 2023 3a20 7374 7269 6e67  e..    #: string
-0000a5e0: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-0000a5f0: 6f66 2065 7863 6570 7469 6f6e 0a20 2020  of exception.   
-0000a600: 2065 7863 6570 7469 6f6e 5f74 6578 743a   exception_text:
-0000a610: 2073 7472 0a0a 2020 2020 233a 2073 7472   str..    #: str
-0000a620: 696e 6720 7265 7072 6573 656e 7461 7469  ing representati
-0000a630: 6f6e 206f 6620 7472 6163 6562 6163 6b0a  on of traceback.
-0000a640: 2020 2020 7472 6163 6562 6163 6b5f 7465      traceback_te
-0000a650: 7874 3a20 7374 720a 0a20 2020 2023 3a20  xt: str..    #: 
-0000a660: 4966 2074 6869 7320 7461 736b 206f 7220  If this task or 
-0000a670: 6f6e 6520 6f66 2069 7473 2064 6570 656e  one of its depen
-0000a680: 6465 6e63 6965 7320 6661 696c 6564 2065  dencies failed e
-0000a690: 7865 6375 7469 6e67 2c20 7468 6520 6661  xecuting, the fa
-0000a6a0: 696c 6564 2074 6173 6b20 6973 0a20 2020  iled task is.   
-0000a6b0: 2023 3a20 7374 6f72 6564 2068 6572 6520   #: stored here 
-0000a6c0: 2870 6f73 7369 626c 7920 6974 7365 6c66  (possibly itself
-0000a6d0: 292e 0a20 2020 2065 7863 6570 7469 6f6e  )..    exception
-0000a6e0: 5f62 6c61 6d65 3a20 5461 736b 5374 6174  _blame: TaskStat
-0000a6f0: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
-0000a700: 2057 6f72 6b65 7220 6164 6472 6573 7365   Worker addresse
-0000a710: 7320 6f6e 2077 6869 6368 2065 7272 6f72  s on which error
-0000a720: 7320 6170 7065 6172 6564 2c20 6361 7573  s appeared, caus
-0000a730: 696e 6720 7468 6973 2074 6173 6b20 746f  ing this task to
-0000a740: 2062 6520 696e 2061 6e20 6572 726f 720a   be in an error.
-0000a750: 2020 2020 233a 2073 7461 7465 2e0a 2020      #: state..  
-0000a760: 2020 6572 7265 645f 6f6e 3a20 7365 745b    erred_on: set[
-0000a770: 7374 725d 0a0a 2020 2020 233a 2054 6865  str]..    #: The
-0000a780: 206e 756d 6265 7220 6f66 2074 696d 6573   number of times
-0000a790: 2074 6869 7320 7461 736b 2068 6173 2062   this task has b
-0000a7a0: 6565 6e20 696e 766f 6c76 6564 2069 6e20  een involved in 
-0000a7b0: 6120 776f 726b 6572 2064 6561 7468 2e0a  a worker death..
-0000a7c0: 2020 2020 233a 0a20 2020 2023 3a20 536f      #:.    #: So
-0000a7d0: 6d65 2074 6173 6b73 206d 6179 2063 6175  me tasks may cau
-0000a7e0: 7365 2077 6f72 6b65 7273 2074 6f20 6469  se workers to di
-0000a7f0: 6520 2873 7563 6820 6173 2063 616c 6c69  e (such as calli
-0000a800: 6e67 2060 606f 732e 5f65 7869 7428 3029  ng ``os._exit(0)
-0000a810: 6060 292e 2057 6865 6e20 610a 2020 2020  ``). When a.    
-0000a820: 233a 2077 6f72 6b65 7220 6469 6573 2c20  #: worker dies, 
-0000a830: 616c 6c20 6f66 2074 6865 2074 6173 6b73  all of the tasks
-0000a840: 206f 6e20 7468 6174 2077 6f72 6b65 7220   on that worker 
-0000a850: 6172 6520 7265 6173 7369 676e 6564 2074  are reassigned t
-0000a860: 6f20 6f74 6865 7273 2e20 5468 6973 0a20  o others. This. 
-0000a870: 2020 2023 3a20 636f 6d62 696e 6174 696f     #: combinatio
-0000a880: 6e20 6f66 2062 6568 6176 696f 7273 2063  n of behaviors c
-0000a890: 616e 2063 6175 7365 2061 2062 6164 2074  an cause a bad t
-0000a8a0: 6173 6b20 746f 2063 6174 6173 7472 6f70  ask to catastrop
-0000a8b0: 6869 6361 6c6c 7920 6465 7374 726f 7920  hically destroy 
-0000a8c0: 616c 6c0a 2020 2020 233a 2077 6f72 6b65  all.    #: worke
-0000a8d0: 7273 206f 6e20 7468 6520 636c 7573 7465  rs on the cluste
-0000a8e0: 722c 206f 6e65 2061 6674 6572 2061 6e6f  r, one after ano
-0000a8f0: 7468 6572 2e20 5768 656e 6576 6572 2061  ther. Whenever a
-0000a900: 2077 6f72 6b65 7220 6469 6573 2c20 7765   worker dies, we
-0000a910: 206d 6172 6b20 6561 6368 0a20 2020 2023   mark each.    #
-0000a920: 3a20 7461 736b 2063 7572 7265 6e74 6c79  : task currently
-0000a930: 2070 726f 6365 7373 696e 6720 6f6e 2074   processing on t
-0000a940: 6861 7420 776f 726b 6572 2028 6173 2072  hat worker (as r
-0000a950: 6563 6f72 6465 6420 6279 0a20 2020 2023  ecorded by.    #
-0000a960: 3a20 3a61 7474 723a 6057 6f72 6b65 7253  : :attr:`WorkerS
-0000a970: 7461 7465 2e70 726f 6365 7373 696e 6760  tate.processing`
-0000a980: 2920 6173 2073 7573 7069 6369 6f75 732e  ) as suspicious.
-0000a990: 2049 6620 6120 7461 736b 2069 7320 696e   If a task is in
-0000a9a0: 766f 6c76 6564 2069 6e20 7468 7265 650a  volved in three.
-0000a9b0: 2020 2020 233a 2064 6561 7468 7320 286f      #: deaths (o
-0000a9c0: 7220 736f 6d65 206f 7468 6572 2066 6978  r some other fix
-0000a9d0: 6564 2063 6f6e 7374 616e 7429 2074 6865  ed constant) the
-0000a9e0: 6e20 7765 206d 6172 6b20 7468 6520 7461  n we mark the ta
-0000a9f0: 736b 2061 7320 6060 6572 7265 6460 602e  sk as ``erred``.
-0000aa00: 0a20 2020 2073 7573 7069 6369 6f75 733a  .    suspicious:
-0000aa10: 2069 6e74 0a0a 2020 2020 233a 2041 2073   int..    #: A s
-0000aa20: 6574 206f 6620 686f 7374 6e61 6d65 7320  et of hostnames 
-0000aa30: 7768 6572 6520 7468 6973 2074 6173 6b20  where this task 
-0000aa40: 6361 6e20 6265 2072 756e 2028 6f72 2060  can be run (or `
-0000aa50: 604e 6f6e 6560 6020 6966 2065 6d70 7479  `None`` if empty
-0000aa60: 292e 2055 7375 616c 6c79 0a20 2020 2023  ). Usually.    #
-0000aa70: 3a20 7468 6973 2069 7320 656d 7074 7920  : this is empty 
-0000aa80: 756e 6c65 7373 2074 6865 2074 6173 6b20  unless the task 
-0000aa90: 6861 7320 6265 656e 2073 7065 6369 6669  has been specifi
-0000aaa0: 6361 6c6c 7920 7265 7374 7269 6374 6564  cally restricted
-0000aab0: 2074 6f20 6f6e 6c79 2072 756e 206f 6e0a   to only run on.
-0000aac0: 2020 2020 233a 2063 6572 7461 696e 2068      #: certain h
-0000aad0: 6f73 7473 2e20 4120 686f 7374 6e61 6d65  osts. A hostname
-0000aae0: 206d 6179 2063 6f72 7265 7370 6f6e 6420   may correspond 
-0000aaf0: 746f 206f 6e65 206f 7220 7365 7665 7261  to one or severa
-0000ab00: 6c20 636f 6e6e 6563 7465 6420 776f 726b  l connected work
-0000ab10: 6572 732e 0a20 2020 2068 6f73 745f 7265  ers..    host_re
-0000ab20: 7374 7269 6374 696f 6e73 3a20 7365 745b  strictions: set[
-0000ab30: 7374 725d 0a0a 2020 2020 233a 2041 2073  str]..    #: A s
-0000ab40: 6574 206f 6620 636f 6d70 6c65 7465 2077  et of complete w
-0000ab50: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-0000ab60: 7768 6572 6520 7468 6973 2063 616e 2062  where this can b
-0000ab70: 6520 7275 6e20 286f 7220 6060 4e6f 6e65  e run (or ``None
-0000ab80: 6060 2069 6620 656d 7074 7929 2e0a 2020  `` if empty)..  
-0000ab90: 2020 233a 2055 7375 616c 6c79 2074 6869    #: Usually thi
-0000aba0: 7320 6973 2065 6d70 7479 2075 6e6c 6573  s is empty unles
-0000abb0: 7320 7468 6520 7461 736b 2068 6173 2062  s the task has b
-0000abc0: 6565 6e20 7370 6563 6966 6963 616c 6c79  een specifically
-0000abd0: 2072 6573 7472 6963 7465 6420 746f 206f   restricted to o
-0000abe0: 6e6c 790a 2020 2020 233a 2072 756e 206f  nly.    #: run o
-0000abf0: 6e20 6365 7274 6169 6e20 776f 726b 6572  n certain worker
-0000ac00: 732e 0a20 2020 2023 3a20 4e6f 7465 2074  s..    #: Note t
-0000ac10: 6869 7320 6973 2074 7261 636b 696e 6720  his is tracking 
-0000ac20: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
-0000ac30: 2c20 6e6f 7420 776f 726b 6572 2073 7461  , not worker sta
-0000ac40: 7465 732c 2073 696e 6365 2074 6865 2073  tes, since the s
-0000ac50: 7065 6369 6669 630a 2020 2020 233a 2077  pecific.    #: w
-0000ac60: 6f72 6b65 7273 206d 6179 206e 6f74 2062  orkers may not b
-0000ac70: 6520 636f 6e6e 6563 7465 6420 6174 2074  e connected at t
-0000ac80: 6869 7320 7469 6d65 2e0a 2020 2020 776f  his time..    wo
-0000ac90: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
-0000aca0: 733a 2073 6574 5b73 7472 5d0a 0a20 2020  s: set[str]..   
-0000acb0: 2023 3a20 5265 736f 7572 6365 7320 7265   #: Resources re
-0000acc0: 7175 6972 6564 2062 7920 7468 6973 2074  quired by this t
-0000acd0: 6173 6b2c 2073 7563 6820 6173 2060 607b  ask, such as ``{
-0000ace0: 2767 7075 273a 2031 7d60 6020 6f72 2060  'gpu': 1}`` or `
-0000acf0: 607b 276d 656d 6f72 7927 3a20 3165 397d  `{'memory': 1e9}
-0000ad00: 6060 0a20 2020 2023 3a20 5468 6573 6520  ``.    #: These 
-0000ad10: 6172 6520 7573 6572 2d64 6566 696e 6564  are user-defined
-0000ad20: 206e 616d 6573 2061 6e64 2061 7265 206d   names and are m
-0000ad30: 6174 6368 6564 2061 6761 696e 7374 2074  atched against t
-0000ad40: 6865 203a 2063 6f6e 7465 6e74 7320 6f66  he : contents of
-0000ad50: 2065 6163 680a 2020 2020 233a 203a 6174   each.    #: :at
-0000ad60: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
-0000ad70: 7265 736f 7572 6365 7360 2064 6963 7469  resources` dicti
-0000ad80: 6f6e 6172 792e 0a20 2020 2072 6573 6f75  onary..    resou
-0000ad90: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0000ada0: 3a20 6469 6374 5b73 7472 2c20 666c 6f61  : dict[str, floa
-0000adb0: 745d 0a0a 2020 2020 233a 2046 616c 7365  t]..    #: False
-0000adc0: 0a20 2020 2023 3a20 2020 2020 4561 6368  .    #:     Each
-0000add0: 206f 6620 3a61 7474 723a 6068 6f73 745f   of :attr:`host_
-0000ade0: 7265 7374 7269 6374 696f 6e73 602c 203a  restrictions`, :
-0000adf0: 6174 7472 3a60 776f 726b 6572 5f72 6573  attr:`worker_res
-0000ae00: 7472 6963 7469 6f6e 7360 2061 6e64 0a20  trictions` and. 
-0000ae10: 2020 2023 3a20 2020 2020 3a61 7474 723a     #:     :attr:
-0000ae20: 6072 6573 6f75 7263 655f 7265 7374 7269  `resource_restri
-0000ae30: 6374 696f 6e73 6020 6973 2061 2068 6172  ctions` is a har
-0000ae40: 6420 636f 6e73 7472 6169 6e74 3a20 6966  d constraint: if
-0000ae50: 206e 6f20 776f 726b 6572 2069 7320 6176   no worker is av
-0000ae60: 6169 6c61 626c 650a 2020 2020 233a 2020  ailable.    #:  
-0000ae70: 2020 2073 6174 6973 6679 696e 6720 7468     satisfying th
-0000ae80: 6f73 6520 7265 7374 7269 6374 696f 6e73  ose restrictions
-0000ae90: 2c20 7468 6520 7461 736b 2063 616e 6e6f  , the task canno
-0000aea0: 7420 676f 2069 6e74 6f20 7468 6520 2270  t go into the "p
-0000aeb0: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
-0000aec0: 0a20 2020 2023 3a20 2020 2020 616e 6420  .    #:     and 
-0000aed0: 7769 6c6c 2069 6e73 7465 6164 2067 6f20  will instead go 
-0000aee0: 696e 746f 2074 6865 2022 6e6f 2d77 6f72  into the "no-wor
-0000aef0: 6b65 7222 2073 7461 7465 2e0a 2020 2020  ker" state..    
-0000af00: 233a 2054 7275 650a 2020 2020 233a 2020  #: True.    #:  
-0000af10: 2020 2054 6865 2061 626f 7665 2072 6573     The above res
-0000af20: 7472 6963 7469 6f6e 7320 6172 6520 6d65  trictions are me
-0000af30: 7265 2070 7265 6665 7265 6e63 6573 3a20  re preferences: 
-0000af40: 6966 206e 6f20 776f 726b 6572 2069 7320  if no worker is 
-0000af50: 6176 6169 6c61 626c 650a 2020 2020 233a  available.    #:
-0000af60: 2020 2020 2073 6174 6973 6679 696e 6720       satisfying 
-0000af70: 7468 6f73 6520 7265 7374 7269 6374 696f  those restrictio
-0000af80: 6e73 2c20 7468 6520 7461 736b 2063 616e  ns, the task can
-0000af90: 2073 7469 6c6c 2067 6f20 696e 746f 2074   still go into t
-0000afa0: 6865 0a20 2020 2023 3a20 2020 2020 2270  he.    #:     "p
-0000afb0: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
-0000afc0: 2061 6e64 2062 6520 7365 6e74 2066 6f72   and be sent for
-0000afd0: 2065 7865 6375 7469 6f6e 2074 6f20 616e   execution to an
-0000afe0: 6f74 6865 7220 636f 6e6e 6563 7465 6420  other connected 
-0000aff0: 776f 726b 6572 2e0a 2020 2020 6c6f 6f73  worker..    loos
-0000b000: 655f 7265 7374 7269 6374 696f 6e73 3a20  e_restrictions: 
-0000b010: 626f 6f6c 0a0a 2020 2020 233a 2057 6865  bool..    #: Whe
-0000b020: 7468 6572 2074 6869 7320 7461 736b 2069  ther this task i
-0000b030: 7320 616e 2041 6374 6f72 0a20 2020 2061  s an Actor.    a
-0000b040: 6374 6f72 3a20 626f 6f6c 0a0a 2020 2020  ctor: bool..    
-0000b050: 233a 2054 6865 2067 726f 7570 206f 6620  #: The group of 
-0000b060: 7461 736b 7320 746f 2077 6869 6368 2074  tasks to which t
-0000b070: 6869 7320 6f6e 6520 6265 6c6f 6e67 730a  his one belongs.
-0000b080: 2020 2020 6772 6f75 703a 2054 6173 6b47      group: TaskG
-0000b090: 726f 7570 0a0a 2020 2020 233a 2053 616d  roup..    #: Sam
-0000b0a0: 6520 6173 206f 6620 6772 6f75 702e 6e61  e as of group.na
-0000b0b0: 6d65 0a20 2020 2067 726f 7570 5f6b 6579  me.    group_key
-0000b0c0: 3a20 7374 720a 0a20 2020 2023 3a20 4d65  : str..    #: Me
-0000b0d0: 7461 6461 7461 2072 656c 6174 6564 2074  tadata related t
-0000b0e0: 6f20 7461 736b 0a20 2020 206d 6574 6164  o task.    metad
-0000b0f0: 6174 613a 2064 6963 745b 7374 722c 2041  ata: dict[str, A
-0000b100: 6e79 5d0a 0a20 2020 2023 3a20 5461 736b  ny]..    #: Task
-0000b110: 2061 6e6e 6f74 6174 696f 6e73 0a20 2020   annotations.   
-0000b120: 2061 6e6e 6f74 6174 696f 6e73 3a20 6469   annotations: di
-0000b130: 6374 5b73 7472 2c20 416e 795d 0a0a 2020  ct[str, Any]..  
-0000b140: 2020 233a 2054 6865 2075 6e69 7175 6520    #: The unique 
-0000b150: 6964 656e 7469 6669 6572 206f 6620 6120  identifier of a 
-0000b160: 7370 6563 6966 6963 2065 7865 6375 7469  specific executi
-0000b170: 6f6e 206f 6620 6120 7461 736b 2e20 5468  on of a task. Th
-0000b180: 6973 2069 6465 6e74 6966 6965 720a 2020  is identifier.  
-0000b190: 2020 233a 2069 7320 7573 6564 2074 6f20    #: is used to 
-0000b1a0: 7369 676e 2061 2074 6173 6b20 7375 6368  sign a task such
-0000b1b0: 2074 6861 7420 7468 6520 6173 7369 676e   that the assign
-0000b1c0: 6564 2077 6f72 6b65 7220 6973 2065 7870  ed worker is exp
-0000b1d0: 6563 7465 6420 746f 2072 6574 7572 6e0a  ected to return.
-0000b1e0: 2020 2020 233a 2074 6865 2073 616d 6520      #: the same 
-0000b1f0: 6964 656e 7469 6669 6572 2069 6e20 7468  identifier in th
-0000b200: 6520 7461 736b 2d66 696e 6973 6865 6420  e task-finished 
-0000b210: 6d65 7373 6167 652e 2054 6869 7320 6973  message. This is
-0000b220: 2075 7365 6420 746f 2063 6f72 7265 6c61   used to correla
-0000b230: 7465 0a20 2020 2023 3a20 7265 7370 6f6e  te.    #: respon
-0000b240: 7365 732e 0a20 2020 2023 3a20 4f6e 6c79  ses..    #: Only
-0000b250: 2074 6865 206d 6f73 7420 7265 6365 6e74   the most recent
-0000b260: 6c79 2061 7373 6967 6e65 6420 776f 726b  ly assigned work
-0000b270: 6572 2069 7320 7472 7573 7465 642e 2041  er is trusted. A
-0000b280: 6c6c 206f 7468 6572 2072 6573 756c 7473  ll other results
-0000b290: 2077 696c 6c0a 2020 2020 233a 2062 6520   will.    #: be 
-0000b2a0: 7265 6a65 6374 6564 2e0a 2020 2020 7275  rejected..    ru
-0000b2b0: 6e5f 6964 3a20 696e 7420 7c20 4e6f 6e65  n_id: int | None
-0000b2c0: 0a0a 2020 2020 233a 2043 6163 6865 6420  ..    #: Cached 
-0000b2d0: 6861 7368 206f 6620 3a61 7474 723a 607e  hash of :attr:`~
-0000b2e0: 5461 736b 5374 6174 652e 636c 6965 6e74  TaskState.client
-0000b2f0: 5f6b 6579 600a 2020 2020 5f68 6173 683a  _key`.    _hash:
-0000b300: 2069 6e74 0a0a 2020 2020 2320 5375 7070   int..    # Supp
-0000b310: 6f72 7420 666f 7220 7765 616b 7265 6673  ort for weakrefs
-0000b320: 2074 6f20 6120 636c 6173 7320 7769 7468   to a class with
-0000b330: 205f 5f73 6c6f 7473 5f5f 0a20 2020 205f   __slots__.    _
-0000b340: 5f77 6561 6b72 6566 5f5f 3a20 416e 7920  _weakref__: Any 
-0000b350: 3d20 4e6f 6e65 0a20 2020 205f 5f73 6c6f  = None.    __slo
-0000b360: 7473 5f5f 203d 2074 7570 6c65 285f 5f61  ts__ = tuple(__a
-0000b370: 6e6e 6f74 6174 696f 6e73 5f5f 290a 0a20  nnotations__).. 
-0000b380: 2020 2023 3a20 476c 6f62 616c 2069 7465     #: Global ite
-0000b390: 7261 746f 7220 7573 6564 2074 6f20 6372  rator used to cr
-0000b3a0: 6561 7465 2075 6e69 7175 6520 7461 736b  eate unique task
-0000b3b0: 2072 756e 2049 4473 0a20 2020 205f 7275   run IDs.    _ru
-0000b3c0: 6e5f 6964 5f69 7465 7261 746f 723a 2043  n_id_iterator: C
-0000b3d0: 6c61 7373 5661 725b 6974 6572 746f 6f6c  lassVar[itertool
-0000b3e0: 732e 636f 756e 745d 203d 2069 7465 7274  s.count] = itert
-0000b3f0: 6f6f 6c73 2e63 6f75 6e74 2829 0a0a 2020  ools.count()..  
-0000b400: 2020 2320 496e 7374 616e 6365 7320 6e6f    # Instances no
-0000b410: 7420 7061 7274 206f 6620 736c 6f74 7320  t part of slots 
-0000b420: 7369 6e63 6520 636c 6173 7320 7661 7269  since class vari
-0000b430: 6162 6c65 0a20 2020 205f 696e 7374 616e  able.    _instan
-0000b440: 6365 733a 2043 6c61 7373 5661 725b 7765  ces: ClassVar[we
-0000b450: 616b 7265 662e 5765 616b 5365 745b 5461  akref.WeakSet[Ta
-0000b460: 736b 5374 6174 655d 5d20 3d20 7765 616b  skState]] = weak
-0000b470: 7265 662e 5765 616b 5365 7428 290a 0a20  ref.WeakSet().. 
-0000b480: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-0000b490: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000b4a0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
-0000b4b0: 0a20 2020 2020 2020 2072 756e 5f73 7065  .        run_spe
-0000b4c0: 633a 206f 626a 6563 742c 0a20 2020 2020  c: object,.     
-0000b4d0: 2020 2073 7461 7465 3a20 5461 736b 5374     state: TaskSt
-0000b4e0: 6174 6553 7461 7465 2c0a 2020 2020 293a  ateState,.    ):
-0000b4f0: 0a20 2020 2020 2020 2073 656c 662e 6b65  .        self.ke
-0000b500: 7920 3d20 6b65 790a 2020 2020 2020 2020  y = key.        
-0000b510: 7365 6c66 2e5f 6861 7368 203d 2068 6173  self._hash = has
-0000b520: 6828 6b65 7929 0a20 2020 2020 2020 2073  h(key).        s
-0000b530: 656c 662e 7275 6e5f 7370 6563 203d 2072  elf.run_spec = r
-0000b540: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
-0000b550: 7365 6c66 2e5f 7374 6174 6520 3d20 7374  self._state = st
-0000b560: 6174 650a 2020 2020 2020 2020 7365 6c66  ate.        self
-0000b570: 2e65 7863 6570 7469 6f6e 203d 204e 6f6e  .exception = Non
-0000b580: 650a 2020 2020 2020 2020 7365 6c66 2e65  e.        self.e
-0000b590: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
-0000b5a0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000b5b0: 6c66 2e74 7261 6365 6261 636b 203d 204e  lf.traceback = N
-0000b5c0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000b5d0: 2e65 7863 6570 7469 6f6e 5f74 6578 7420  .exception_text 
-0000b5e0: 3d20 2222 0a20 2020 2020 2020 2073 656c  = "".        sel
-0000b5f0: 662e 7472 6163 6562 6163 6b5f 7465 7874  f.traceback_text
-0000b600: 203d 2022 220a 2020 2020 2020 2020 7365   = "".        se
-0000b610: 6c66 2e73 7573 7069 6369 6f75 7320 3d20  lf.suspicious = 
-0000b620: 300a 2020 2020 2020 2020 7365 6c66 2e72  0.        self.r
-0000b630: 6574 7269 6573 203d 2030 0a20 2020 2020  etries = 0.     
-0000b640: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
-0000b650: 202d 310a 2020 2020 2020 2020 7365 6c66   -1.        self
-0000b660: 2e70 7269 6f72 6974 7920 3d20 4e6f 6e65  .priority = None
-0000b670: 0a20 2020 2020 2020 2073 656c 662e 7768  .        self.wh
-0000b680: 6f5f 7761 6e74 7320 3d20 7365 7428 290a  o_wants = set().
-0000b690: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
-0000b6a0: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
-0000b6b0: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
-0000b6c0: 6570 656e 6465 6e74 7320 3d20 7365 7428  ependents = set(
-0000b6d0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0000b6e0: 6169 7469 6e67 5f6f 6e20 3d20 7365 7428  aiting_on = set(
-0000b6f0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0000b700: 6169 7465 7273 203d 2073 6574 2829 0a20  aiters = set(). 
-0000b710: 2020 2020 2020 2073 656c 662e 7768 6f5f         self.who_
-0000b720: 6861 7320 3d20 7365 7428 290a 2020 2020  has = set().    
-0000b730: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
-0000b740: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
-0000b750: 2020 2020 2020 7365 6c66 2e68 6173 5f6c        self.has_l
-0000b760: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-0000b770: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0000b780: 2073 656c 662e 686f 7374 5f72 6573 7472   self.host_restr
-0000b790: 6963 7469 6f6e 7320 3d20 7365 7428 290a  ictions = set().
-0000b7a0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
-0000b7b0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-0000b7c0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0000b7d0: 2073 656c 662e 7265 736f 7572 6365 5f72   self.resource_r
-0000b7e0: 6573 7472 6963 7469 6f6e 7320 3d20 7b7d  estrictions = {}
-0000b7f0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0000b800: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
-0000b810: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0000b820: 2073 656c 662e 6163 746f 7220 3d20 4661   self.actor = Fa
-0000b830: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-0000b840: 2e70 7265 6669 7820 3d20 4e6f 6e65 2020  .prefix = None  
-0000b850: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0000b860: 2020 2020 2020 2073 656c 662e 7479 7065         self.type
-0000b870: 203d 204e 6f6e 6520 2023 2074 7970 653a   = None  # type:
-0000b880: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-0000b890: 7365 6c66 2e67 726f 7570 5f6b 6579 203d  self.group_key =
-0000b8a0: 206b 6579 5f73 706c 6974 5f67 726f 7570   key_split_group
-0000b8b0: 286b 6579 290a 2020 2020 2020 2020 7365  (key).        se
-0000b8c0: 6c66 2e67 726f 7570 203d 204e 6f6e 6520  lf.group = None 
-0000b8d0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0000b8e0: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
-0000b8f0: 6164 6174 6120 3d20 7b7d 0a20 2020 2020  adata = {}.     
-0000b900: 2020 2073 656c 662e 616e 6e6f 7461 7469     self.annotati
-0000b910: 6f6e 7320 3d20 7b7d 0a20 2020 2020 2020  ons = {}.       
-0000b920: 2073 656c 662e 6572 7265 645f 6f6e 203d   self.erred_on =
-0000b930: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-0000b940: 656c 662e 7275 6e5f 6964 203d 204e 6f6e  elf.run_id = Non
-0000b950: 650a 2020 2020 2020 2020 5461 736b 5374  e.        TaskSt
-0000b960: 6174 652e 5f69 6e73 7461 6e63 6573 2e61  ate._instances.a
-0000b970: 6464 2873 656c 6629 0a0a 2020 2020 6465  dd(self)..    de
-0000b980: 6620 5f5f 6861 7368 5f5f 2873 656c 6629  f __hash__(self)
-0000b990: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-0000b9a0: 2072 6574 7572 6e20 7365 6c66 2e5f 6861   return self._ha
-0000b9b0: 7368 0a0a 2020 2020 6465 6620 5f5f 6571  sh..    def __eq
-0000b9c0: 5f5f 2873 656c 662c 206f 7468 6572 3a20  __(self, other: 
-0000b9d0: 6f62 6a65 6374 2920 2d3e 2062 6f6f 6c3a  object) -> bool:
-0000b9e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b9f0: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
-0000ba00: 2c20 5461 736b 5374 6174 6529 2061 6e64  , TaskState) and
-0000ba10: 2073 656c 662e 6b65 7920 3d3d 206f 7468   self.key == oth
-0000ba20: 6572 2e6b 6579 0a0a 2020 2020 4070 726f  er.key..    @pro
-0000ba30: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
-0000ba40: 6174 6528 7365 6c66 2920 2d3e 2054 6173  ate(self) -> Tas
-0000ba50: 6b53 7461 7465 5374 6174 653a 0a20 2020  kStateState:.   
-0000ba60: 2020 2020 2022 2222 5468 6973 2074 6173       """This tas
-0000ba70: 6b27 7320 6375 7272 656e 7420 7374 6174  k's current stat
-0000ba80: 652e 2020 5661 6c69 6420 7374 6174 6573  e.  Valid states
-0000ba90: 2061 7265 2060 6072 656c 6561 7365 6460   are ``released`
-0000baa0: 602c 2060 6077 6169 7469 6e67 6060 2c0a  `, ``waiting``,.
-0000bab0: 2020 2020 2020 2020 6060 6e6f 2d77 6f72          ``no-wor
-0000bac0: 6b65 7260 602c 2060 6070 726f 6365 7373  ker``, ``process
-0000bad0: 696e 6760 602c 2060 606d 656d 6f72 7960  ing``, ``memory`
-0000bae0: 602c 2060 6065 7272 6564 6060 2061 6e64  `, ``erred`` and
-0000baf0: 2060 6066 6f72 676f 7474 656e 6060 2e20   ``forgotten``. 
-0000bb00: 2049 6620 6974 0a20 2020 2020 2020 2069   If it.        i
-0000bb10: 7320 6060 666f 7267 6f74 7465 6e60 602c  s ``forgotten``,
-0000bb20: 2074 6865 2074 6173 6b20 6973 6e27 7420   the task isn't 
-0000bb30: 7374 6f72 6564 2069 6e20 7468 6520 6060  stored in the ``
-0000bb40: 7461 736b 7360 6020 6469 6374 696f 6e61  tasks`` dictiona
-0000bb50: 7279 2061 6e79 6d6f 7265 2061 6e64 0a20  ry anymore and. 
-0000bb60: 2020 2020 2020 2077 696c 6c20 7072 6f62         will prob
-0000bb70: 6162 6c79 2064 6973 6170 7065 6172 2073  ably disappear s
-0000bb80: 6f6f 6e20 6672 6f6d 206d 656d 6f72 792e  oon from memory.
-0000bb90: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000bba0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000bbb0: 2e5f 7374 6174 650a 0a20 2020 2040 7374  ._state..    @st
-0000bbc0: 6174 652e 7365 7474 6572 0a20 2020 2064  ate.setter.    d
-0000bbd0: 6566 2073 7461 7465 2873 656c 662c 2076  ef state(self, v
-0000bbe0: 616c 7565 3a20 5461 736b 5374 6174 6553  alue: TaskStateS
-0000bbf0: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-0000bc00: 2020 2020 2020 2073 656c 662e 6772 6f75         self.grou
-0000bc10: 702e 7374 6174 6573 5b73 656c 662e 5f73  p.states[self._s
-0000bc20: 7461 7465 5d20 2d3d 2031 0a20 2020 2020  tate] -= 1.     
-0000bc30: 2020 2073 656c 662e 6772 6f75 702e 7374     self.group.st
-0000bc40: 6174 6573 5b76 616c 7565 5d20 2b3d 2031  ates[value] += 1
-0000bc50: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
-0000bc60: 7461 7465 203d 2076 616c 7565 0a20 2020  tate = value.   
-0000bc70: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
-0000bc80: 2e73 7461 7465 5f63 6f75 6e74 735b 7661  .state_counts[va
-0000bc90: 6c75 655d 202b 3d20 310a 0a20 2020 2064  lue] += 1..    d
-0000bca0: 6566 2061 6464 5f64 6570 656e 6465 6e63  ef add_dependenc
-0000bcb0: 7928 7365 6c66 2c20 6f74 6865 723a 2054  y(self, other: T
-0000bcc0: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-0000bcd0: 653a 0a20 2020 2020 2020 2022 2222 4164  e:.        """Ad
-0000bce0: 6420 616e 6f74 6865 7220 7461 736b 2061  d another task a
-0000bcf0: 7320 6120 6465 7065 6e64 656e 6379 206f  s a dependency o
-0000bd00: 6620 7468 6973 2074 6173 6b22 2222 0a20  f this task""". 
-0000bd10: 2020 2020 2020 2073 656c 662e 6465 7065         self.depe
-0000bd20: 6e64 656e 6369 6573 2e61 6464 286f 7468  ndencies.add(oth
-0000bd30: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
-0000bd40: 2e67 726f 7570 2e64 6570 656e 6465 6e63  .group.dependenc
-0000bd50: 6965 732e 6164 6428 6f74 6865 722e 6772  ies.add(other.gr
-0000bd60: 6f75 7029 0a20 2020 2020 2020 206f 7468  oup).        oth
-0000bd70: 6572 2e64 6570 656e 6465 6e74 732e 6164  er.dependents.ad
-0000bd80: 6428 7365 6c66 290a 0a20 2020 2064 6566  d(self)..    def
-0000bd90: 2067 6574 5f6e 6279 7465 7328 7365 6c66   get_nbytes(self
-0000bda0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-0000bdb0: 2020 7265 7475 726e 2073 656c 662e 6e62    return self.nb
-0000bdc0: 7974 6573 2069 6620 7365 6c66 2e6e 6279  ytes if self.nby
-0000bdd0: 7465 7320 3e3d 2030 2065 6c73 6520 4445  tes >= 0 else DE
-0000bde0: 4641 554c 545f 4441 5441 5f53 495a 450a  FAULT_DATA_SIZE.
-0000bdf0: 0a20 2020 2064 6566 2073 6574 5f6e 6279  .    def set_nby
-0000be00: 7465 7328 7365 6c66 2c20 6e62 7974 6573  tes(self, nbytes
-0000be10: 3a20 696e 7429 202d 3e20 4e6f 6e65 3a0a  : int) -> None:.
-0000be20: 2020 2020 2020 2020 6469 6666 203d 206e          diff = n
-0000be30: 6279 7465 730a 2020 2020 2020 2020 6f6c  bytes.        ol
-0000be40: 645f 6e62 7974 6573 203d 2073 656c 662e  d_nbytes = self.
-0000be50: 6e62 7974 6573 0a20 2020 2020 2020 2069  nbytes.        i
-0000be60: 6620 6f6c 645f 6e62 7974 6573 203e 3d20  f old_nbytes >= 
-0000be70: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
-0000be80: 6966 6620 2d3d 206f 6c64 5f6e 6279 7465  iff -= old_nbyte
-0000be90: 730a 2020 2020 2020 2020 7365 6c66 2e67  s.        self.g
-0000bea0: 726f 7570 2e6e 6279 7465 735f 746f 7461  roup.nbytes_tota
-0000beb0: 6c20 2b3d 2064 6966 660a 2020 2020 2020  l += diff.      
-0000bec0: 2020 666f 7220 7773 2069 6e20 7365 6c66    for ws in self
-0000bed0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-0000bee0: 2020 2020 2020 7773 2e6e 6279 7465 7320        ws.nbytes 
-0000bef0: 2b3d 2064 6966 660a 2020 2020 2020 2020  += diff.        
-0000bf00: 7365 6c66 2e6e 6279 7465 7320 3d20 6e62  self.nbytes = nb
-0000bf10: 7974 6573 0a0a 2020 2020 6465 6620 5f5f  ytes..    def __
-0000bf20: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
-0000bf30: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
-0000bf40: 7572 6e20 6622 3c54 6173 6b53 7461 7465  urn f"<TaskState
-0000bf50: 207b 7365 6c66 2e6b 6579 2172 7d20 7b73   {self.key!r} {s
-0000bf60: 656c 662e 5f73 7461 7465 7d3e 220a 0a20  elf._state}>".. 
-0000bf70: 2020 2064 6566 205f 7265 7072 5f68 746d     def _repr_htm
-0000bf80: 6c5f 2873 656c 6629 202d 3e20 7374 723a  l_(self) -> str:
-0000bf90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000bfa0: 6765 745f 7465 6d70 6c61 7465 2822 7461  get_template("ta
-0000bfb0: 736b 5f73 7461 7465 2e68 746d 6c2e 6a32  sk_state.html.j2
-0000bfc0: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
-0000bfd0: 2020 2020 2020 2073 7461 7465 3d73 656c         state=sel
-0000bfe0: 662e 7374 6174 652c 0a20 2020 2020 2020  f.state,.       
-0000bff0: 2020 2020 206e 6279 7465 733d 7365 6c66       nbytes=self
-0000c000: 2e6e 6279 7465 732c 0a20 2020 2020 2020  .nbytes,.       
-0000c010: 2020 2020 206b 6579 3d73 656c 662e 6b65       key=self.ke
-0000c020: 792c 0a20 2020 2020 2020 2029 0a0a 2020  y,.        )..  
-0000c030: 2020 6465 6620 7661 6c69 6461 7465 2873    def validate(s
-0000c040: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-0000c050: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000c060: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
-0000c070: 2073 656c 662e 7768 6f5f 7761 6e74 733a   self.who_wants:
-0000c080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c090: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0000c0a0: 6365 2863 732c 2043 6c69 656e 7453 7461  ce(cs, ClientSta
-0000c0b0: 7465 292c 2028 7265 7072 2863 7329 2c20  te), (repr(cs), 
-0000c0c0: 7365 6c66 2e77 686f 5f77 616e 7473 290a  self.who_wants).
-0000c0d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c0e0: 7773 2069 6e20 7365 6c66 2e77 686f 5f68  ws in self.who_h
-0000c0f0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
-0000c100: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000c110: 7461 6e63 6528 7773 2c20 576f 726b 6572  tance(ws, Worker
-0000c120: 5374 6174 6529 2c20 2872 6570 7228 7773  State), (repr(ws
-0000c130: 292c 2073 656c 662e 7768 6f5f 6861 7329  ), self.who_has)
-0000c140: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000c150: 2074 7320 696e 2073 656c 662e 6465 7065   ts in self.depe
-0000c160: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0000c170: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000c180: 2069 7369 6e73 7461 6e63 6528 7473 2c20   isinstance(ts, 
-0000c190: 5461 736b 5374 6174 6529 2c20 2872 6570  TaskState), (rep
-0000c1a0: 7228 7473 292c 2073 656c 662e 6465 7065  r(ts), self.depe
-0000c1b0: 6e64 656e 6369 6573 290a 2020 2020 2020  ndencies).      
-0000c1c0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0000c1d0: 7365 6c66 2e64 6570 656e 6465 6e74 733a  self.dependents:
-0000c1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c1f0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0000c200: 6365 2874 732c 2054 6173 6b53 7461 7465  ce(ts, TaskState
-0000c210: 292c 2028 7265 7072 2874 7329 2c20 7365  ), (repr(ts), se
-0000c220: 6c66 2e64 6570 656e 6465 6e74 7329 0a20  lf.dependents). 
-0000c230: 2020 2020 2020 2020 2020 2076 616c 6964             valid
-0000c240: 6174 655f 7461 736b 5f73 7461 7465 2873  ate_task_state(s
-0000c250: 656c 6629 0a20 2020 2020 2020 2065 7863  elf).        exc
-0000c260: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0000c270: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0000c280: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-0000c290: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-0000c2a0: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
-0000c2b0: 2020 2020 2020 2020 2020 2020 696d 706f              impo
-0000c2c0: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
-0000c2d0: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
-0000c2e0: 7472 6163 6528 290a 0a20 2020 2064 6566  trace()..    def
-0000c2f0: 2067 6574 5f6e 6279 7465 735f 6465 7073   get_nbytes_deps
-0000c300: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
-0000c310: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0000c320: 6d28 7473 2e67 6574 5f6e 6279 7465 7328  m(ts.get_nbytes(
-0000c330: 2920 666f 7220 7473 2069 6e20 7365 6c66  ) for ts in self
-0000c340: 2e64 6570 656e 6465 6e63 6965 7329 0a0a  .dependencies)..
-0000c350: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
-0000c360: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
-0000c370: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
-0000c380: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
-0000c390: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
-0000c3a0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
-0000c3b0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
-0000c3c0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
-0000c3d0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
-0000c3e0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
-0000c3f0: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
-0000c400: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
-0000c410: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
-0000c420: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-0000c430: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-0000c440: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
-0000c450: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
-0000c460: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-0000c470: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
-0000c480: 655f 746f 5f64 6963 740a 0a20 2020 2020  e_to_dict..     
-0000c490: 2020 204e 6f74 6573 0a20 2020 2020 2020     Notes.       
-0000c4a0: 202d 2d2d 2d2d 0a20 2020 2020 2020 2054   -----.        T
-0000c4b0: 6869 7320 636c 6173 7320 7573 6573 2060  his class uses `
-0000c4c0: 605f 746f 5f64 6963 745f 6e6f 5f6e 6573  `_to_dict_no_nes
-0000c4d0: 7460 6020 696e 7374 6561 6420 6f66 2060  t`` instead of `
-0000c4e0: 605f 746f 5f64 6963 7460 602e 0a20 2020  `_to_dict``..   
-0000c4f0: 2020 2020 2057 6865 6e20 6120 7461 736b       When a task
-0000c500: 2072 6566 6572 656e 6365 7320 616e 6f74   references anot
-0000c510: 6865 7220 7461 736b 2c20 6f72 2077 6865  her task, or whe
-0000c520: 6e20 6120 576f 726b 6572 5374 6174 652e  n a WorkerState.
-0000c530: 7461 736b 7320 636f 6e74 6169 6e73 2074  tasks contains t
-0000c540: 6173 6b73 2c0a 2020 2020 2020 2020 7468  asks,.        th
-0000c550: 6973 206d 6574 686f 6420 6973 206e 6f74  is method is not
-0000c560: 2065 7865 6375 7465 6420 666f 7220 7468   executed for th
-0000c570: 6520 696e 6e65 7220 7461 736b 2c20 6576  e inner task, ev
-0000c580: 656e 2069 6620 7468 6520 696e 6e65 7220  en if the inner 
-0000c590: 7461 736b 2077 6173 206e 6576 6572 0a20  task was never. 
-0000c5a0: 2020 2020 2020 2073 6565 6e20 6265 666f         seen befo
-0000c5b0: 7265 3b20 796f 7520 6765 7420 6120 7265  re; you get a re
-0000c5c0: 7072 2069 6e73 7465 6164 2e20 416c 6c20  pr instead. All 
-0000c5d0: 7461 736b 7320 7368 6f75 6c64 206e 6561  tasks should nea
-0000c5e0: 746c 7920 6170 7065 6172 2075 6e64 6572  tly appear under
-0000c5f0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-0000c600: 6572 2e74 6173 6b73 2e20 5468 6973 2061  er.tasks. This a
-0000c610: 6c73 6f20 7072 6576 656e 7473 2061 2052  lso prevents a R
-0000c620: 6563 7572 7369 6f6e 4572 726f 7220 6475  ecursionError du
-0000c630: 7269 6e67 2070 6172 7469 6375 6c61 726c  ring particularl
-0000c640: 7920 6865 6176 790a 2020 2020 2020 2020  y heavy.        
-0000c650: 6c6f 6164 732c 2077 6869 6368 2068 6176  loads, which hav
-0000c660: 6520 6265 656e 206f 6273 6572 7665 6420  e been observed 
-0000c670: 746f 2068 6170 7065 6e20 7768 656e 6576  to happen whenev
-0000c680: 6572 2074 6865 7265 2773 2061 6e20 6163  er there's an ac
-0000c690: 7963 6c69 6320 6465 7065 6e64 656e 6379  yclic dependency
-0000c6a0: 0a20 2020 2020 2020 2063 6861 696e 206f  .        chain o
-0000c6b0: 6620 7e32 3030 2b20 7461 736b 732e 0a20  f ~200+ tasks.. 
-0000c6c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000c6d0: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
-0000c6e0: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
-0000c6f0: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
-0000c700: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
-0000c710: 0a0a 0a63 6c61 7373 2054 7261 6e73 6974  ...class Transit
-0000c720: 696f 6e28 4e61 6d65 6454 7570 6c65 293a  ion(NamedTuple):
-0000c730: 0a20 2020 2022 2222 416e 2065 6e74 7279  .    """An entry
-0000c740: 2069 6e20 3a61 7474 723a 6053 6368 6564   in :attr:`Sched
-0000c750: 756c 6572 5374 6174 652e 7472 616e 7369  ulerState.transi
-0000c760: 7469 6f6e 5f6c 6f67 6022 2222 0a0a 2020  tion_log`"""..  
-0000c770: 2020 6b65 793a 2073 7472 0a20 2020 2073    key: str.    s
-0000c780: 7461 7274 3a20 5461 736b 5374 6174 6553  tart: TaskStateS
-0000c790: 7461 7465 0a20 2020 2066 696e 6973 683a  tate.    finish:
-0000c7a0: 2054 6173 6b53 7461 7465 5374 6174 650a   TaskStateState.
-0000c7b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0000c7c0: 6f6e 733a 2052 6563 730a 2020 2020 7374  ons: Recs.    st
-0000c7d0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
-0000c7e0: 2020 2074 696d 6573 7461 6d70 3a20 666c     timestamp: fl
-0000c7f0: 6f61 740a 0a0a 636c 6173 7320 5363 6865  oat...class Sche
-0000c800: 6475 6c65 7253 7461 7465 3a0a 2020 2020  dulerState:.    
-0000c810: 2222 2255 6e64 6572 6c79 696e 6720 7461  """Underlying ta
-0000c820: 736b 2073 7461 7465 206f 6620 6479 6e61  sk state of dyna
-0000c830: 6d69 6320 7363 6865 6475 6c65 720a 0a20  mic scheduler.. 
-0000c840: 2020 2054 7261 636b 7320 7468 6520 6375     Tracks the cu
-0000c850: 7272 656e 7420 7374 6174 6520 6f66 2077  rrent state of w
-0000c860: 6f72 6b65 7273 2c20 6461 7461 2c20 616e  orkers, data, an
-0000c870: 6420 636f 6d70 7574 6174 696f 6e73 2e0a  d computations..
-0000c880: 0a20 2020 2048 616e 646c 6573 2074 7261  .    Handles tra
-0000c890: 6e73 6974 696f 6e73 2062 6574 7765 656e  nsitions between
-0000c8a0: 2064 6966 6665 7265 6e74 2074 6173 6b20   different task 
-0000c8b0: 7374 6174 6573 2e20 4e6f 7469 6669 6573  states. Notifies
-0000c8c0: 2074 6865 0a20 2020 2053 6368 6564 756c   the.    Schedul
-0000c8d0: 6572 206f 6620 6368 616e 6765 7320 6279  er of changes by
-0000c8e0: 206d 6573 7361 6769 6e67 2070 6173 7369   messaging passi
-0000c8f0: 6e67 2074 6872 6f75 6768 2051 7565 7565  ng through Queue
-0000c900: 732c 2077 6869 6368 2074 6865 0a20 2020  s, which the.   
-0000c910: 2053 6368 6564 756c 6572 206c 6973 7465   Scheduler liste
-0000c920: 6e73 2074 6f20 7265 7370 6f6e 6473 2061  ns to responds a
-0000c930: 6363 6f72 6469 6e67 6c79 2e0a 0a20 2020  ccordingly...   
-0000c940: 2041 6c6c 2065 7665 6e74 7320 6172 6520   All events are 
-0000c950: 6861 6e64 6c65 6420 7175 6963 6b6c 792c  handled quickly,
-0000c960: 2069 6e20 6c69 6e65 6172 2074 696d 6520   in linear time 
-0000c970: 7769 7468 2072 6573 7065 6374 2074 6f20  with respect to 
-0000c980: 7468 6569 720a 2020 2020 696e 7075 7420  their.    input 
-0000c990: 2877 6869 6368 2069 7320 6f66 7465 6e20  (which is often 
-0000c9a0: 6f66 2063 6f6e 7374 616e 7420 7369 7a65  of constant size
-0000c9b0: 2920 616e 6420 6765 6e65 7261 6c6c 7920  ) and generally 
-0000c9c0: 7769 7468 696e 2061 0a20 2020 206d 696c  within a.    mil
-0000c9d0: 6c69 7365 636f 6e64 2e0a 0a20 2020 2055  lisecond...    U
-0000c9e0: 7365 7273 2074 7970 6963 616c 6c79 2064  sers typically d
-0000c9f0: 6f20 6e6f 7420 696e 7465 7261 6374 2077  o not interact w
-0000ca00: 6974 6820 6060 5472 616e 7369 7469 6f6e  ith ``Transition
-0000ca10: 7360 6020 6469 7265 6374 6c79 2e20 496e  s`` directly. In
-0000ca20: 7374 6561 640a 2020 2020 7573 6572 7320  stead.    users 
-0000ca30: 696e 7465 7261 6374 2077 6974 6820 7468  interact with th
-0000ca40: 6520 6060 436c 6965 6e74 6060 2c20 7768  e ``Client``, wh
-0000ca50: 6963 6820 696e 2074 7572 6e20 656e 6761  ich in turn enga
-0000ca60: 6765 7320 7468 650a 2020 2020 6060 5363  ges the.    ``Sc
-0000ca70: 6865 6475 6c65 7260 6020 6166 6665 6374  heduler`` affect
-0000ca80: 696e 6720 6469 6666 6572 656e 7420 7472  ing different tr
-0000ca90: 616e 7369 7469 6f6e 7320 6865 7265 2075  ansitions here u
-0000caa0: 6e64 6572 2d74 6865 2d68 6f6f 642e 2049  nder-the-hood. I
-0000cab0: 6e0a 2020 2020 7468 6520 6261 636b 6772  n.    the backgr
-0000cac0: 6f75 6e64 2060 6057 6f72 6b65 7260 6073  ound ``Worker``s
-0000cad0: 2061 6c73 6f20 656e 6761 6765 2077 6974   also engage wit
-0000cae0: 6820 7468 6520 6060 5363 6865 6475 6c65  h the ``Schedule
-0000caf0: 7260 600a 2020 2020 6166 6665 6374 696e  r``.    affectin
-0000cb00: 6720 7468 6573 6520 7374 6174 6520 7472  g these state tr
-0000cb10: 616e 7369 7469 6f6e 7320 6173 2077 656c  ansitions as wel
-0000cb20: 6c2e 0a20 2020 2022 2222 0a0a 2020 2020  l..    """..    
-0000cb30: 6261 6e64 7769 6474 683a 2069 6e74 0a0a  bandwidth: int..
-0000cb40: 2020 2020 233a 2043 6c69 656e 7473 2063      #: Clients c
-0000cb50: 7572 7265 6e74 6c79 2063 6f6e 6e65 6374  urrently connect
-0000cb60: 6564 2074 6f20 7468 6520 7363 6865 6475  ed to the schedu
-0000cb70: 6c65 720a 2020 2020 636c 6965 6e74 733a  ler.    clients:
-0000cb80: 2064 6963 745b 7374 722c 2043 6c69 656e   dict[str, Clien
-0000cb90: 7453 7461 7465 5d0a 0a20 2020 2065 7874  tState]..    ext
-0000cba0: 656e 7369 6f6e 733a 2064 6963 745b 7374  ensions: dict[st
-0000cbb0: 722c 2041 6e79 5d20 2023 2054 4f44 4f20  r, Any]  # TODO 
-0000cbc0: 7772 6974 6520 6120 7363 6865 6475 6c65  write a schedule
-0000cbd0: 7220 6578 7465 6e73 696f 6e20 5072 6f74  r extension Prot
-0000cbe0: 6f63 6f6c 0a20 2020 2070 6c75 6769 6e73  ocol.    plugins
-0000cbf0: 3a20 6469 6374 5b73 7472 2c20 5363 6865  : dict[str, Sche
-0000cc00: 6475 6c65 7250 6c75 6769 6e5d 0a20 2020  dulerPlugin].   
-0000cc10: 2068 6f73 745f 696e 666f 3a20 6469 6374   host_info: dict
-0000cc20: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-0000cc30: 416e 795d 5d0a 0a20 2020 2023 3a20 4966  Any]]..    #: If
-0000cc40: 2054 7275 652c 2065 6e61 626c 6520 6578   True, enable ex
-0000cc50: 7065 6e73 6976 6520 696e 7465 726e 616c  pensive internal
-0000cc60: 2063 6f6e 7369 7374 656e 6379 2063 6865   consistency che
-0000cc70: 636b 2e0a 2020 2020 233a 2054 7970 6963  ck..    #: Typic
-0000cc80: 616c 6c79 2064 6973 6162 6c65 6420 696e  ally disabled in
-0000cc90: 2070 726f 6475 6374 696f 6e2e 0a20 2020   production..   
-0000cca0: 2076 616c 6964 6174 653a 2062 6f6f 6c0a   validate: bool.
-0000ccb0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-0000ccc0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
-0000ccd0: 2023 2057 6f72 6b65 7273 2d72 656c 6174   # Workers-relat
-0000cce0: 6564 2073 7461 7465 0a20 2020 2023 2323  ed state.    ###
-0000ccf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cd00: 2323 2323 0a0a 2020 2020 233a 2057 6f72  ####..    #: Wor
-0000cd10: 6b65 7273 2063 7572 7265 6e74 6c79 2063  kers currently c
-0000cd20: 6f6e 6e65 6374 6564 2074 6f20 7468 6520  onnected to the 
-0000cd30: 7363 6865 6475 6c65 720a 2020 2020 233a  scheduler.    #:
-0000cd40: 2028 6163 7475 616c 6c79 2061 2053 6f72   (actually a Sor
-0000cd50: 7465 6444 6963 742c 2062 7574 2074 6865  tedDict, but the
-0000cd60: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
-0000cd70: 7320 7061 636b 6167 6520 6973 6e27 7420  s package isn't 
-0000cd80: 616e 6e6f 7461 7465 6429 0a20 2020 2077  annotated).    w
-0000cd90: 6f72 6b65 7273 3a20 6469 6374 5b73 7472  orkers: dict[str
-0000cda0: 2c20 576f 726b 6572 5374 6174 655d 0a20  , WorkerState]. 
-0000cdb0: 2020 2023 3a20 576f 726b 6572 207b 6e61     #: Worker {na
-0000cdc0: 6d65 3a20 6164 6472 6573 737d 0a20 2020  me: address}.   
-0000cdd0: 2061 6c69 6173 6573 3a20 6469 6374 5b48   aliases: dict[H
-0000cde0: 6173 6861 626c 652c 2073 7472 5d0a 2020  ashable, str].  
-0000cdf0: 2020 233a 2057 6f72 6b65 7273 2074 6861    #: Workers tha
-0000ce00: 7420 6172 6520 6375 7272 656e 746c 7920  t are currently 
-0000ce10: 696e 2072 756e 6e69 6e67 2073 7461 7465  in running state
-0000ce20: 0a20 2020 2072 756e 6e69 6e67 3a20 7365  .    running: se
-0000ce30: 745b 576f 726b 6572 5374 6174 655d 0a20  t[WorkerState]. 
-0000ce40: 2020 2023 3a20 576f 726b 6572 7320 7468     #: Workers th
-0000ce50: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
-0000ce60: 2069 6e20 7275 6e6e 696e 6720 7374 6174   in running stat
-0000ce70: 6520 616e 6420 6e6f 7420 6675 6c6c 7920  e and not fully 
-0000ce80: 7574 696c 697a 6564 0a20 2020 2023 3a20  utilized.    #: 
-0000ce90: 4465 6669 6e69 7469 6f6e 2062 6173 6564  Definition based
-0000cea0: 206f 6e20 6f63 6375 7061 6e63 790a 2020   on occupancy.  
-0000ceb0: 2020 233a 2028 6163 7475 616c 6c79 2061    #: (actually a
-0000cec0: 2053 6f72 7465 6444 6963 742c 2062 7574   SortedDict, but
-0000ced0: 2074 6865 2073 6f72 7465 6463 6f6e 7461   the sortedconta
-0000cee0: 696e 6572 7320 7061 636b 6167 6520 6973  iners package is
-0000cef0: 6e27 7420 616e 6e6f 7461 7465 6429 2e0a  n't annotated)..
-0000cf00: 2020 2020 233a 204e 6f74 2074 6f20 6265      #: Not to be
-0000cf10: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
-0000cf20: 6d65 7468 3a60 6973 5f69 646c 6560 2e0a  meth:`is_idle`..
-0000cf30: 2020 2020 6964 6c65 3a20 6469 6374 5b73      idle: dict[s
-0000cf40: 7472 2c20 576f 726b 6572 5374 6174 655d  tr, WorkerState]
-0000cf50: 0a20 2020 2023 3a20 5369 6d69 6c61 7220  .    #: Similar 
-0000cf60: 746f 2060 6964 6c65 600a 2020 2020 233a  to `idle`.    #:
-0000cf70: 2044 6566 696e 6974 696f 6e20 6261 7365   Definition base
-0000cf80: 6420 6f6e 2061 7373 6967 6e65 6420 7461  d on assigned ta
-0000cf90: 736b 730a 2020 2020 6964 6c65 5f74 6173  sks.    idle_tas
-0000cfa0: 6b5f 636f 756e 743a 2073 6574 5b57 6f72  k_count: set[Wor
-0000cfb0: 6b65 7253 7461 7465 5d0a 2020 2020 233a  kerState].    #:
-0000cfc0: 2057 6f72 6b65 7273 2074 6861 7420 6172   Workers that ar
-0000cfd0: 6520 6675 6c6c 7920 7574 696c 697a 6564  e fully utilized
-0000cfe0: 2e20 4d61 7920 696e 636c 7564 6520 6e6f  . May include no
-0000cff0: 6e2d 7275 6e6e 696e 6720 776f 726b 6572  n-running worker
-0000d000: 732e 0a20 2020 2073 6174 7572 6174 6564  s..    saturated
-0000d010: 3a20 7365 745b 576f 726b 6572 5374 6174  : set[WorkerStat
-0000d020: 655d 0a20 2020 2074 6f74 616c 5f6e 7468  e].    total_nth
-0000d030: 7265 6164 733a 2069 6e74 0a20 2020 2023  reads: int.    #
-0000d040: 3a20 436c 7573 7465 722d 7769 6465 2072  : Cluster-wide r
-0000d050: 6573 6f75 7263 6573 2e20 7b72 6573 6f75  esources. {resou
-0000d060: 7263 6520 6e61 6d65 3a20 7b77 6f72 6b65  rce name: {worke
-0000d070: 7220 6164 6472 6573 733a 2061 6d6f 756e  r address: amoun
-0000d080: 747d 7d0a 2020 2020 7265 736f 7572 6365  t}}.    resource
-0000d090: 733a 2064 6963 745b 7374 722c 2064 6963  s: dict[str, dic
-0000d0a0: 745b 7374 722c 2066 6c6f 6174 5d5d 0a0a  t[str, float]]..
-0000d0b0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0000d0c0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0000d0d0: 5461 736b 732d 7265 6c61 7465 6420 7374  Tasks-related st
-0000d0e0: 6174 650a 2020 2020 2323 2323 2323 2323  ate.    ########
-0000d0f0: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-0000d100: 2020 2023 3a20 546f 7461 6c20 6e75 6d62     #: Total numb
-0000d110: 6572 206f 6620 7461 736b 7320 6576 6572  er of tasks ever
-0000d120: 2070 726f 6365 7373 6564 0a20 2020 206e   processed.    n
-0000d130: 5f74 6173 6b73 3a20 696e 740a 0a20 2020  _tasks: int..   
-0000d140: 2023 3a20 416c 6c20 7461 736b 7320 6375   #: All tasks cu
-0000d150: 7272 656e 746c 7920 6b6e 6f77 6e20 746f  rrently known to
-0000d160: 2074 6865 2073 6368 6564 756c 6572 0a20   the scheduler. 
-0000d170: 2020 2074 6173 6b73 3a20 6469 6374 5b73     tasks: dict[s
-0000d180: 7472 2c20 5461 736b 5374 6174 655d 0a0a  tr, TaskState]..
-0000d190: 2020 2020 233a 2054 6173 6b73 2069 6e20      #: Tasks in 
-0000d1a0: 7468 6520 2271 7565 7565 6422 2073 7461  the "queued" sta
-0000d1b0: 7465 2c20 6f72 6465 7265 6420 6279 2070  te, ordered by p
-0000d1c0: 7269 6f72 6974 790a 2020 2020 7175 6575  riority.    queu
-0000d1d0: 6564 3a20 4865 6170 5365 745b 5461 736b  ed: HeapSet[Task
-0000d1e0: 5374 6174 655d 0a0a 2020 2020 233a 2054  State]..    #: T
-0000d1f0: 6173 6b73 2069 6e20 7468 6520 226e 6f2d  asks in the "no-
-0000d200: 776f 726b 6572 2220 7374 6174 650a 2020  worker" state.  
-0000d210: 2020 756e 7275 6e6e 6162 6c65 3a20 7365    unrunnable: se
-0000d220: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-0000d230: 2020 233a 2053 7562 7365 7420 6f66 2074    #: Subset of t
-0000d240: 6173 6b73 2074 6861 7420 6578 6973 7420  asks that exist 
-0000d250: 696e 206d 656d 6f72 7920 6f6e 206d 6f72  in memory on mor
-0000d260: 6520 7468 616e 206f 6e65 2077 6f72 6b65  e than one worke
-0000d270: 720a 2020 2020 7265 706c 6963 6174 6564  r.    replicated
-0000d280: 5f74 6173 6b73 3a20 7365 745b 5461 736b  _tasks: set[Task
-0000d290: 5374 6174 655d 0a0a 2020 2020 756e 6b6e  State]..    unkn
-0000d2a0: 6f77 6e5f 6475 7261 7469 6f6e 733a 2064  own_durations: d
-0000d2b0: 6963 745b 7374 722c 2073 6574 5b54 6173  ict[str, set[Tas
-0000d2c0: 6b53 7461 7465 5d5d 0a20 2020 2074 6173  kState]].    tas
-0000d2d0: 6b5f 6772 6f75 7073 3a20 6469 6374 5b73  k_groups: dict[s
-0000d2e0: 7472 2c20 5461 736b 4772 6f75 705d 0a20  tr, TaskGroup]. 
-0000d2f0: 2020 2074 6173 6b5f 7072 6566 6978 6573     task_prefixes
-0000d300: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
-0000d310: 5072 6566 6978 5d0a 2020 2020 7461 736b  Prefix].    task
-0000d320: 5f6d 6574 6164 6174 613a 2064 6963 745b  _metadata: dict[
-0000d330: 7374 722c 2041 6e79 5d0a 0a20 2020 2023  str, Any]..    #
-0000d340: 2323 2323 2323 2323 0a20 2020 2023 2048  ########.    # H
-0000d350: 6973 746f 7279 0a20 2020 2023 2323 2323  istory.    #####
-0000d360: 2323 2323 0a0a 2020 2020 233a 2048 6973  ####..    #: His
-0000d370: 746f 7279 206f 6620 636f 6d70 7574 6174  tory of computat
-0000d380: 696f 6e73 2e0a 2020 2020 233a 2054 6865  ions..    #: The
-0000d390: 206c 656e 6774 6820 6361 6e20 6265 2074   length can be t
-0000d3a0: 7765 616b 6564 2074 6872 6f75 6768 0a20  weaked through. 
-0000d3b0: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
-0000d3c0: 642e 6469 6167 6e6f 7374 6963 732e 636f  d.diagnostics.co
-0000d3d0: 6d70 7574 6174 696f 6e73 2e6d 6178 2d68  mputations.max-h
-0000d3e0: 6973 746f 7279 0a20 2020 2063 6f6d 7075  istory.    compu
-0000d3f0: 7461 7469 6f6e 733a 2064 6571 7565 5b43  tations: deque[C
-0000d400: 6f6d 7075 7461 7469 6f6e 5d0a 0a20 2020  omputation]..   
-0000d410: 2023 3a20 4869 7374 6f72 7920 6f66 2065   #: History of e
-0000d420: 7272 6564 2074 6173 6b73 2e0a 2020 2020  rred tasks..    
-0000d430: 233a 2054 6865 206c 656e 6774 6820 6361  #: The length ca
-0000d440: 6e20 6265 2074 7765 616b 6564 2074 6872  n be tweaked thr
-0000d450: 6f75 6768 0a20 2020 2023 3a20 6469 7374  ough.    #: dist
-0000d460: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
-0000d470: 6963 732e 6572 7265 642d 7461 736b 732e  ics.erred-tasks.
-0000d480: 6d61 782d 6869 7374 6f72 790a 2020 2020  max-history.    
-0000d490: 6572 7265 645f 7461 736b 733a 2064 6571  erred_tasks: deq
-0000d4a0: 7565 5b45 7272 6564 5461 736b 5d0a 0a20  ue[ErredTask].. 
-0000d4b0: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
-0000d4c0: 2074 6173 6b20 7374 6174 6520 7472 616e   task state tran
-0000d4d0: 7369 7469 6f6e 732e 0a20 2020 2023 3a20  sitions..    #: 
-0000d4e0: 5468 6520 6c65 6e67 7468 2063 616e 2062  The length can b
-0000d4f0: 6520 7477 6561 6b65 6420 7468 726f 7567  e tweaked throug
-0000d500: 680a 2020 2020 233a 2064 6973 7472 6962  h.    #: distrib
-0000d510: 7574 6564 2e73 6368 6564 756c 6572 2e74  uted.scheduler.t
-0000d520: 7261 6e73 6974 696f 6e2d 6c6f 672d 6c65  ransition-log-le
-0000d530: 6e67 7468 0a20 2020 2074 7261 6e73 6974  ngth.    transit
-0000d540: 696f 6e5f 6c6f 673a 2064 6571 7565 5b54  ion_log: deque[T
-0000d550: 7261 6e73 6974 696f 6e5d 0a0a 2020 2020  ransition]..    
-0000d560: 233a 2054 6f74 616c 206e 756d 6265 7220  #: Total number 
-0000d570: 6f66 2074 7261 6e73 6974 696f 6e73 2073  of transitions s
-0000d580: 696e 6365 2074 6865 2063 6c75 7374 6572  ince the cluster
-0000d590: 2077 6173 2073 7461 7274 6564 0a20 2020   was started.   
-0000d5a0: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
-0000d5b0: 7465 723a 2069 6e74 0a0a 2020 2020 233a  ter: int..    #:
-0000d5c0: 2054 6f74 616c 206e 756d 6265 7220 6f66   Total number of
-0000d5d0: 2074 7261 6e73 6974 696f 6e73 2061 7320   transitions as 
-0000d5e0: 6f66 2074 6865 2070 7265 7669 6f75 7320  of the previous 
-0000d5f0: 6361 6c6c 2074 6f20 6368 6563 6b5f 6964  call to check_id
-0000d600: 6c65 2829 0a20 2020 205f 6964 6c65 5f74  le().    _idle_t
-0000d610: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0000d620: 723a 2069 6e74 0a0a 2020 2020 233a 2052  r: int..    #: R
-0000d630: 6169 7365 2061 6e20 6572 726f 7220 6966  aise an error if
-0000d640: 2074 6865 203a 6174 7472 3a60 7472 616e   the :attr:`tran
-0000d650: 7369 7469 6f6e 5f63 6f75 6e74 6572 6020  sition_counter` 
-0000d660: 6576 6572 2072 6561 6368 6573 2074 6869  ever reaches thi
-0000d670: 7320 7661 6c75 652e 0a20 2020 2023 3a20  s value..    #: 
-0000d680: 5468 6973 2069 7320 6d65 616e 7420 666f  This is meant fo
-0000d690: 7220 6465 6275 6767 696e 6720 6f6e 6c79  r debugging only
-0000d6a0: 2c20 746f 2063 6174 6368 2069 6e66 696e  , to catch infin
-0000d6b0: 6974 6520 7265 6375 7273 696f 6e20 6c6f  ite recursion lo
-0000d6c0: 6f70 732e 0a20 2020 2023 3a20 496e 2070  ops..    #: In p
-0000d6d0: 726f 6475 6374 696f 6e2c 2069 7420 7368  roduction, it sh
-0000d6e0: 6f75 6c64 2061 6c77 6179 7320 6265 2073  ould always be s
-0000d6f0: 6574 2074 6f20 4661 6c73 652e 0a20 2020  et to False..   
-0000d700: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
-0000d710: 7465 725f 6d61 783a 2069 6e74 207c 204c  ter_max: int | L
-0000d720: 6974 6572 616c 5b46 616c 7365 5d0a 0a20  iteral[False].. 
-0000d730: 2020 205f 7461 736b 5f70 7265 6669 785f     _task_prefix_
-0000d740: 636f 756e 745f 676c 6f62 616c 3a20 6465  count_global: de
-0000d750: 6661 756c 7464 6963 745b 7374 722c 2069  faultdict[str, i
-0000d760: 6e74 5d0a 2020 2020 5f6e 6574 776f 726b  nt].    _network
-0000d770: 5f6f 6363 5f67 6c6f 6261 6c3a 2066 6c6f  _occ_global: flo
-0000d780: 6174 0a20 2020 2023 2323 2323 2323 2323  at.    #########
-0000d790: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-0000d7a0: 2020 2320 4361 6368 6564 2063 6f6e 6669    # Cached confi
-0000d7b0: 6775 7261 7469 6f6e 0a20 2020 2023 2323  guration.    ###
-0000d7c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d7d0: 2323 230a 0a20 2020 2023 3a20 6469 7374  ###..    #: dist
-0000d7e0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0000d7f0: 722e 756e 6b6e 6f77 6e2d 7461 736b 2d64  r.unknown-task-d
-0000d800: 7572 6174 696f 6e0a 2020 2020 554e 4b4e  uration.    UNKN
-0000d810: 4f57 4e5f 5441 534b 5f44 5552 4154 494f  OWN_TASK_DURATIO
-0000d820: 4e3a 2066 6c6f 6174 0a20 2020 2023 3a20  N: float.    #: 
-0000d830: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-0000d840: 6572 2e6d 656d 6f72 792e 7265 6365 6e74  er.memory.recent
-0000d850: 2d74 6f2d 6f6c 642d 7469 6d65 0a20 2020  -to-old-time.   
-0000d860: 204d 454d 4f52 595f 5245 4345 4e54 5f54   MEMORY_RECENT_T
-0000d870: 4f5f 4f4c 445f 5449 4d45 3a20 666c 6f61  O_OLD_TIME: floa
-0000d880: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
-0000d890: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-0000d8a0: 7279 2e72 6562 616c 616e 6365 2e6d 6561  ry.rebalance.mea
-0000d8b0: 7375 7265 0a20 2020 204d 454d 4f52 595f  sure.    MEMORY_
-0000d8c0: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
-0000d8d0: 453a 2073 7472 0a20 2020 2023 3a20 6469  E: str.    #: di
-0000d8e0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-0000d8f0: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
-0000d900: 652e 7365 6e64 6572 2d6d 696e 0a20 2020  e.sender-min.   
-0000d910: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
-0000d920: 455f 5345 4e44 4552 5f4d 494e 3a20 666c  E_SENDER_MIN: fl
-0000d930: 6f61 740a 2020 2020 233a 2064 6973 7472  oat.    #: distr
-0000d940: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-0000d950: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
-0000d960: 6563 6970 6965 6e74 2d6d 6178 0a20 2020  ecipient-max.   
-0000d970: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
-0000d980: 455f 5245 4349 5049 454e 545f 4d41 583a  E_RECIPIENT_MAX:
-0000d990: 2066 6c6f 6174 0a20 2020 2023 3a20 6469   float.    #: di
-0000d9a0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-0000d9b0: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
-0000d9c0: 652e 7365 6e64 6572 2d72 6563 6970 6965  e.sender-recipie
-0000d9d0: 6e74 2d67 6170 202f 2032 0a20 2020 204d  nt-gap / 2.    M
-0000d9e0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-0000d9f0: 4841 4c46 5f47 4150 3a20 666c 6f61 740a  HALF_GAP: float.
-0000da00: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000da10: 6564 2e73 6368 6564 756c 6572 2e77 6f72  ed.scheduler.wor
-0000da20: 6b65 722d 7361 7475 7261 7469 6f6e 0a20  ker-saturation. 
-0000da30: 2020 2057 4f52 4b45 525f 5341 5455 5241     WORKER_SATURA
-0000da40: 5449 4f4e 3a20 666c 6f61 740a 0a20 2020  TION: float..   
-0000da50: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
-0000da60: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
-0000da70: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
-0000da80: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
-0000da90: 656c 662c 0a20 2020 2020 2020 2061 6c69  elf,.        ali
-0000daa0: 6173 6573 3a20 6469 6374 5b48 6173 6861  ases: dict[Hasha
-0000dab0: 626c 652c 2073 7472 5d2c 0a20 2020 2020  ble, str],.     
-0000dac0: 2020 2063 6c69 656e 7473 3a20 6469 6374     clients: dict
-0000dad0: 5b73 7472 2c20 436c 6965 6e74 5374 6174  [str, ClientStat
-0000dae0: 655d 2c0a 2020 2020 2020 2020 776f 726b  e],.        work
-0000daf0: 6572 733a 2053 6f72 7465 6444 6963 745b  ers: SortedDict[
-0000db00: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
-0000db10: 5d2c 0a20 2020 2020 2020 2068 6f73 745f  ],.        host_
-0000db20: 696e 666f 3a20 6469 6374 5b73 7472 2c20  info: dict[str, 
-0000db30: 6469 6374 5b73 7472 2c20 416e 795d 5d2c  dict[str, Any]],
-0000db40: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-0000db50: 6573 3a20 6469 6374 5b73 7472 2c20 6469  es: dict[str, di
-0000db60: 6374 5b73 7472 2c20 666c 6f61 745d 5d2c  ct[str, float]],
-0000db70: 0a20 2020 2020 2020 2074 6173 6b73 3a20  .        tasks: 
-0000db80: 6469 6374 5b73 7472 2c20 5461 736b 5374  dict[str, TaskSt
-0000db90: 6174 655d 2c0a 2020 2020 2020 2020 756e  ate],.        un
-0000dba0: 7275 6e6e 6162 6c65 3a20 7365 745b 5461  runnable: set[Ta
-0000dbb0: 736b 5374 6174 655d 2c0a 2020 2020 2020  skState],.      
-0000dbc0: 2020 7175 6575 6564 3a20 4865 6170 5365    queued: HeapSe
-0000dbd0: 745b 5461 736b 5374 6174 655d 2c0a 2020  t[TaskState],.  
-0000dbe0: 2020 2020 2020 7661 6c69 6461 7465 3a20        validate: 
-0000dbf0: 626f 6f6c 2c0a 2020 2020 2020 2020 706c  bool,.        pl
-0000dc00: 7567 696e 733a 2049 7465 7261 626c 655b  ugins: Iterable[
-0000dc10: 5363 6865 6475 6c65 7250 6c75 6769 6e5d  SchedulerPlugin]
-0000dc20: 203d 2028 292c 0a20 2020 2020 2020 2074   = (),.        t
-0000dc30: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0000dc40: 725f 6d61 783a 2069 6e74 207c 204c 6974  r_max: int | Lit
-0000dc50: 6572 616c 5b46 616c 7365 5d20 3d20 4661  eral[False] = Fa
-0000dc60: 6c73 652c 0a20 2020 2020 2020 202a 2a6b  lse,.        **k
-0000dc70: 7761 7267 733a 2041 6e79 2c20 2023 2050  wargs: Any,  # P
-0000dc80: 6173 7365 6420 7665 7262 6174 696d 2074  assed verbatim t
-0000dc90: 6f20 5365 7276 6572 2e5f 5f69 6e69 745f  o Server.__init_
-0000dca0: 5f28 290a 2020 2020 293a 0a20 2020 2020  _().    ):.     
-0000dcb0: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0000dcc0: 5374 6174 6520 7374 6172 7422 290a 2020  State start").  
-0000dcd0: 2020 2020 2020 7365 6c66 2e61 6c69 6173        self.alias
-0000dce0: 6573 203d 2061 6c69 6173 6573 0a20 2020  es = aliases.   
-0000dcf0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-0000dd00: 6474 6820 3d20 7061 7273 655f 6279 7465  dth = parse_byte
-0000dd10: 7328 6461 736b 2e63 6f6e 6669 672e 6765  s(dask.config.ge
-0000dd20: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0000dd30: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
-0000dd40: 7468 2229 290a 2020 2020 2020 2020 7365  th")).        se
-0000dd50: 6c66 2e63 6c69 656e 7473 203d 2063 6c69  lf.clients = cli
-0000dd60: 656e 7473 0a20 2020 2020 2020 2073 656c  ents.        sel
-0000dd70: 662e 636c 6965 6e74 735b 2266 6972 652d  f.clients["fire-
-0000dd80: 616e 642d 666f 7267 6574 225d 203d 2043  and-forget"] = C
-0000dd90: 6c69 656e 7453 7461 7465 2822 6669 7265  lientState("fire
-0000dda0: 2d61 6e64 2d66 6f72 6765 7422 290a 2020  -and-forget").  
-0000ddb0: 2020 2020 2020 7365 6c66 2e65 7874 656e        self.exten
-0000ddc0: 7369 6f6e 7320 3d20 7b7d 0a20 2020 2020  sions = {}.     
-0000ddd0: 2020 2073 656c 662e 686f 7374 5f69 6e66     self.host_inf
-0000dde0: 6f20 3d20 686f 7374 5f69 6e66 6f0a 2020  o = host_info.  
-0000ddf0: 2020 2020 2020 7365 6c66 2e69 646c 6520        self.idle 
-0000de00: 3d20 536f 7274 6564 4469 6374 2829 0a20  = SortedDict(). 
-0000de10: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0000de20: 5f74 6173 6b5f 636f 756e 7420 3d20 7365  _task_count = se
-0000de30: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000de40: 2e6e 5f74 6173 6b73 203d 2030 0a20 2020  .n_tasks = 0.   
-0000de50: 2020 2020 2073 656c 662e 7265 736f 7572       self.resour
-0000de60: 6365 7320 3d20 7265 736f 7572 6365 730a  ces = resources.
-0000de70: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
-0000de80: 7572 6174 6564 203d 2073 6574 2829 0a20  urated = set(). 
-0000de90: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000dea0: 7320 3d20 7461 736b 730a 2020 2020 2020  s = tasks.      
-0000deb0: 2020 7365 6c66 2e72 6570 6c69 6361 7465    self.replicate
-0000dec0: 645f 7461 736b 7320 3d20 7b0a 2020 2020  d_tasks = {.    
-0000ded0: 2020 2020 2020 2020 7473 2066 6f72 2074          ts for t
-0000dee0: 7320 696e 2073 656c 662e 7461 736b 732e  s in self.tasks.
-0000def0: 7661 6c75 6573 2829 2069 6620 6c65 6e28  values() if len(
-0000df00: 7473 2e77 686f 5f68 6173 2920 3e20 310a  ts.who_has) > 1.
-0000df10: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0000df20: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
-0000df30: 6f6e 7320 3d20 6465 7175 6528 0a20 2020  ons = deque(.   
-0000df40: 2020 2020 2020 2020 206d 6178 6c65 6e3d           maxlen=
-0000df50: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000df60: 2264 6973 7472 6962 7574 6564 2e64 6961  "distributed.dia
-0000df70: 676e 6f73 7469 6373 2e63 6f6d 7075 7461  gnostics.computa
-0000df80: 7469 6f6e 732e 6d61 782d 6869 7374 6f72  tions.max-histor
-0000df90: 7922 290a 2020 2020 2020 2020 290a 2020  y").        ).  
-0000dfa0: 2020 2020 2020 7365 6c66 2e65 7272 6564        self.erred
-0000dfb0: 5f74 6173 6b73 203d 2064 6571 7565 280a  _tasks = deque(.
-0000dfc0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
-0000dfd0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
-0000dfe0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000dff0: 6469 6167 6e6f 7374 6963 732e 6572 7265  diagnostics.erre
-0000e000: 642d 7461 736b 732e 6d61 782d 6869 7374  d-tasks.max-hist
-0000e010: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
-0000e020: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000e030: 6b5f 6772 6f75 7073 203d 207b 7d0a 2020  k_groups = {}.  
-0000e040: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-0000e050: 7072 6566 6978 6573 203d 207b 7d0a 2020  prefixes = {}.  
-0000e060: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-0000e070: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
-0000e080: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
-0000e090: 5f6e 7468 7265 6164 7320 3d20 300a 2020  _nthreads = 0.  
-0000e0a0: 2020 2020 2020 7365 6c66 2e75 6e6b 6e6f        self.unkno
-0000e0b0: 776e 5f64 7572 6174 696f 6e73 203d 207b  wn_durations = {
-0000e0c0: 7d0a 2020 2020 2020 2020 7365 6c66 2e71  }.        self.q
-0000e0d0: 7565 7565 6420 3d20 7175 6575 6564 0a20  ueued = queued. 
-0000e0e0: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
-0000e0f0: 6e6e 6162 6c65 203d 2075 6e72 756e 6e61  nnable = unrunna
-0000e100: 626c 650a 2020 2020 2020 2020 7365 6c66  ble.        self
-0000e110: 2e76 616c 6964 6174 6520 3d20 7661 6c69  .validate = vali
-0000e120: 6461 7465 0a20 2020 2020 2020 2073 656c  date.        sel
-0000e130: 662e 776f 726b 6572 7320 3d20 776f 726b  f.workers = work
-0000e140: 6572 730a 2020 2020 2020 2020 7365 6c66  ers.        self
-0000e150: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
-0000e160: 756e 745f 676c 6f62 616c 203d 2064 6566  unt_global = def
-0000e170: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
-0000e180: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
-0000e190: 6f72 6b5f 6f63 635f 676c 6f62 616c 203d  ork_occ_global =
-0000e1a0: 2030 2e30 0a20 2020 2020 2020 2073 656c   0.0.        sel
-0000e1b0: 662e 7275 6e6e 696e 6720 3d20 7b0a 2020  f.running = {.  
-0000e1c0: 2020 2020 2020 2020 2020 7773 2066 6f72            ws for
-0000e1d0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-0000e1e0: 6572 732e 7661 6c75 6573 2829 2069 6620  ers.values() if 
-0000e1f0: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
-0000e200: 7475 732e 7275 6e6e 696e 670a 2020 2020  tus.running.    
-0000e210: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
-0000e220: 6c66 2e70 6c75 6769 6e73 203d 207b 7d20  lf.plugins = {} 
-0000e230: 6966 206e 6f74 2070 6c75 6769 6e73 2065  if not plugins e
-0000e240: 6c73 6520 7b5f 6765 745f 706c 7567 696e  lse {_get_plugin
-0000e250: 5f6e 616d 6528 7029 3a20 7020 666f 7220  _name(p): p for 
-0000e260: 7020 696e 2070 6c75 6769 6e73 7d0a 0a20  p in plugins}.. 
-0000e270: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-0000e280: 7369 7469 6f6e 5f6c 6f67 203d 2064 6571  sition_log = deq
-0000e290: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-0000e2a0: 6d61 786c 656e 3d64 6173 6b2e 636f 6e66  maxlen=dask.conf
-0000e2b0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0000e2c0: 7465 642e 7363 6865 6475 6c65 722e 7472  ted.scheduler.tr
-0000e2d0: 616e 7369 7469 6f6e 2d6c 6f67 2d6c 656e  ansition-log-len
-0000e2e0: 6774 6822 290a 2020 2020 2020 2020 290a  gth").        ).
-0000e2f0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-0000e300: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
-0000e310: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-0000e320: 2e5f 6964 6c65 5f74 7261 6e73 6974 696f  ._idle_transitio
-0000e330: 6e5f 636f 756e 7465 7220 3d20 300a 2020  n_counter = 0.  
-0000e340: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-0000e350: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
-0000e360: 7820 3d20 7472 616e 7369 7469 6f6e 5f63  x = transition_c
-0000e370: 6f75 6e74 6572 5f6d 6178 0a0a 2020 2020  ounter_max..    
-0000e380: 2020 2020 2320 5661 7269 6162 6c65 7320      # Variables 
-0000e390: 6672 6f6d 2064 6173 6b2e 636f 6e66 6967  from dask.config
-0000e3a0: 2c20 6361 6368 6564 2062 7920 5f5f 696e  , cached by __in
-0000e3b0: 6974 5f5f 2066 6f72 2070 6572 666f 726d  it__ for perform
-0000e3c0: 616e 6365 0a20 2020 2020 2020 2073 656c  ance.        sel
-0000e3d0: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
-0000e3e0: 5552 4154 494f 4e20 3d20 7061 7273 655f  URATION = parse_
-0000e3f0: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
-0000e400: 2020 2020 2020 2064 6173 6b2e 636f 6e66         dask.conf
-0000e410: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0000e420: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
-0000e430: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
-0000e440: 696f 6e22 290a 2020 2020 2020 2020 290a  ion").        ).
-0000e450: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
-0000e460: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
-0000e470: 445f 5449 4d45 203d 2070 6172 7365 5f74  D_TIME = parse_t
-0000e480: 696d 6564 656c 7461 280a 2020 2020 2020  imedelta(.      
-0000e490: 2020 2020 2020 6461 736b 2e63 6f6e 6669        dask.confi
-0000e4a0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0000e4b0: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000e4c0: 2e72 6563 656e 742d 746f 2d6f 6c64 2d74  .recent-to-old-t
-0000e4d0: 696d 6522 290a 2020 2020 2020 2020 290a  ime").        ).
-0000e4e0: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
-0000e4f0: 4f52 595f 5245 4241 4c41 4e43 455f 4d45  ORY_REBALANCE_ME
-0000e500: 4153 5552 4520 3d20 6461 736b 2e63 6f6e  ASURE = dask.con
-0000e510: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0000e520: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
-0000e530: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-0000e540: 7265 6261 6c61 6e63 652e 6d65 6173 7572  rebalance.measur
-0000e550: 6522 0a20 2020 2020 2020 2029 0a20 2020  e".        ).   
-0000e560: 2020 2020 2073 656c 662e 4d45 4d4f 5259       self.MEMORY
-0000e570: 5f52 4542 414c 414e 4345 5f53 454e 4445  _REBALANCE_SENDE
-0000e580: 525f 4d49 4e20 3d20 6461 736b 2e63 6f6e  R_MIN = dask.con
-0000e590: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0000e5a0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
-0000e5b0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-0000e5c0: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
-0000e5d0: 2d6d 696e 220a 2020 2020 2020 2020 290a  -min".        ).
-0000e5e0: 2020 2020 2020 2020 7365 6c66 2e4d 454d          self.MEM
-0000e5f0: 4f52 595f 5245 4241 4c41 4e43 455f 5245  ORY_REBALANCE_RE
-0000e600: 4349 5049 454e 545f 4d41 5820 3d20 6461  CIPIENT_MAX = da
-0000e610: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-0000e620: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-0000e630: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-0000e640: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
-0000e650: 7265 6369 7069 656e 742d 6d61 7822 0a20  recipient-max". 
-0000e660: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000e670: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0000e680: 414c 414e 4345 5f48 414c 465f 4741 5020  ALANCE_HALF_GAP 
-0000e690: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-0000e6a0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000e6b0: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
-0000e6c0: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-0000e6d0: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
-0000e6e0: 7069 656e 742d 6761 7022 290a 2020 2020  pient-gap").    
-0000e6f0: 2020 2020 2020 2020 2f20 322e 300a 2020          / 2.0.  
-0000e700: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000e710: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
-0000e720: 5552 4154 494f 4e20 3d20 6461 736b 2e63  URATION = dask.c
-0000e730: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0000e740: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0000e750: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-0000e760: 726b 6572 2d73 6174 7572 6174 696f 6e22  rker-saturation"
-0000e770: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000e780: 2020 2069 6620 7365 6c66 2e57 4f52 4b45     if self.WORKE
-0000e790: 525f 5341 5455 5241 5449 4f4e 203d 3d20  R_SATURATION == 
-0000e7a0: 2269 6e66 223a 0a20 2020 2020 2020 2020  "inf":.         
-0000e7b0: 2020 2023 2053 7065 6369 616c 2063 6173     # Special cas
-0000e7c0: 6520 6e65 6365 7373 6172 7920 6265 6361  e necessary beca
-0000e7d0: 7573 6520 7468 6572 6527 7320 6e6f 2077  use there's no w
-0000e7e0: 6179 2074 6f20 7061 7273 6520 6120 666c  ay to parse a fl
-0000e7f0: 6f61 7420 696e 6669 6e69 7479 0a20 2020  oat infinity.   
-0000e800: 2020 2020 2020 2020 2023 2066 726f 6d20           # from 
-0000e810: 6120 4441 534b 5f2a 2065 6e76 6972 6f6e  a DASK_* environ
-0000e820: 6d65 6e74 2076 6172 6961 626c 650a 2020  ment variable.  
-0000e830: 2020 2020 2020 2020 2020 7365 6c66 2e57            self.W
-0000e840: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000e850: 203d 206d 6174 682e 696e 660a 2020 2020   = math.inf.    
-0000e860: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-0000e870: 2020 2020 206e 6f74 2069 7369 6e73 7461       not isinsta
-0000e880: 6e63 6528 7365 6c66 2e57 4f52 4b45 525f  nce(self.WORKER_
-0000e890: 5341 5455 5241 5449 4f4e 2c20 2869 6e74  SATURATION, (int
-0000e8a0: 2c20 666c 6f61 7429 290a 2020 2020 2020  , float)).      
-0000e8b0: 2020 2020 2020 6f72 2073 656c 662e 574f        or self.WO
-0000e8c0: 524b 4552 5f53 4154 5552 4154 494f 4e20  RKER_SATURATION 
-0000e8d0: 3c3d 2030 0a20 2020 2020 2020 2029 3a0a  <= 0.        ):.
-0000e8e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000e8f0: 6520 5661 6c75 6545 7272 6f72 2820 2023  e ValueError(  #
-0000e900: 2070 7261 676d 613a 206e 6f63 6f76 6572   pragma: nocover
-0000e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e920: 2022 6064 6973 7472 6962 7574 6564 2e73   "`distributed.s
-0000e930: 6368 6564 756c 6572 2e77 6f72 6b65 722d  cheduler.worker-
-0000e940: 7361 7475 7261 7469 6f6e 6020 6d75 7374  saturation` must
-0000e950: 2062 6520 6120 666c 6f61 7420 3e20 303b   be a float > 0;
-0000e960: 2067 6f74 2022 0a20 2020 2020 2020 2020   got ".         
-0000e970: 2020 2020 2020 202b 2072 6570 7228 7365         + repr(se
-0000e980: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
-0000e990: 5449 4f4e 290a 2020 2020 2020 2020 2020  TION).          
-0000e9a0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
-0000e9b0: 7479 0a20 2020 2064 6566 206d 656d 6f72  ty.    def memor
-0000e9c0: 7928 7365 6c66 2920 2d3e 204d 656d 6f72  y(self) -> Memor
-0000e9d0: 7953 7461 7465 3a0a 2020 2020 2020 2020  yState:.        
-0000e9e0: 7265 7475 726e 204d 656d 6f72 7953 7461  return MemorySta
-0000e9f0: 7465 2e73 756d 282a 2877 2e6d 656d 6f72  te.sum(*(w.memor
-0000ea00: 7920 666f 7220 7720 696e 2073 656c 662e  y for w in self.
-0000ea10: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-0000ea20: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
-0000ea30: 790a 2020 2020 6465 6620 5f5f 7064 6963  y.    def __pdic
-0000ea40: 745f 5f28 7365 6c66 2920 2d3e 2064 6963  t__(self) -> dic
-0000ea50: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-0000ea60: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-0000ea70: 2020 2020 2020 2020 2020 2262 616e 6477            "bandw
-0000ea80: 6964 7468 223a 2073 656c 662e 6261 6e64  idth": self.band
-0000ea90: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
-0000eaa0: 2020 2022 7265 736f 7572 6365 7322 3a20     "resources": 
-0000eab0: 7365 6c66 2e72 6573 6f75 7263 6573 2c0a  self.resources,.
-0000eac0: 2020 2020 2020 2020 2020 2020 2273 6174              "sat
-0000ead0: 7572 6174 6564 223a 2073 656c 662e 7361  urated": self.sa
-0000eae0: 7475 7261 7465 642c 0a20 2020 2020 2020  turated,.       
-0000eaf0: 2020 2020 2022 756e 7275 6e6e 6162 6c65       "unrunnable
-0000eb00: 223a 2073 656c 662e 756e 7275 6e6e 6162  ": self.unrunnab
-0000eb10: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-0000eb20: 2271 7565 7565 6422 3a20 7365 6c66 2e71  "queued": self.q
-0000eb30: 7565 7565 642c 0a20 2020 2020 2020 2020  ueued,.         
-0000eb40: 2020 2022 6e5f 7461 736b 7322 3a20 7365     "n_tasks": se
-0000eb50: 6c66 2e6e 5f74 6173 6b73 2c0a 2020 2020  lf.n_tasks,.    
-0000eb60: 2020 2020 2020 2020 2275 6e6b 6e6f 776e          "unknown
-0000eb70: 5f64 7572 6174 696f 6e73 223a 2073 656c  _durations": sel
-0000eb80: 662e 756e 6b6e 6f77 6e5f 6475 7261 7469  f.unknown_durati
-0000eb90: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0000eba0: 2022 7661 6c69 6461 7465 223a 2073 656c   "validate": sel
-0000ebb0: 662e 7661 6c69 6461 7465 2c0a 2020 2020  f.validate,.    
-0000ebc0: 2020 2020 2020 2020 2274 6173 6b73 223a          "tasks":
-0000ebd0: 2073 656c 662e 7461 736b 732c 0a20 2020   self.tasks,.   
-0000ebe0: 2020 2020 2020 2020 2022 7461 736b 5f67           "task_g
-0000ebf0: 726f 7570 7322 3a20 7365 6c66 2e74 6173  roups": self.tas
-0000ec00: 6b5f 6772 6f75 7073 2c0a 2020 2020 2020  k_groups,.      
-0000ec10: 2020 2020 2020 2274 6173 6b5f 7072 6566        "task_pref
-0000ec20: 6978 6573 223a 2073 656c 662e 7461 736b  ixes": self.task
-0000ec30: 5f70 7265 6669 7865 732c 0a20 2020 2020  _prefixes,.     
-0000ec40: 2020 2020 2020 2022 746f 7461 6c5f 6e74         "total_nt
-0000ec50: 6872 6561 6473 223a 2073 656c 662e 746f  hreads": self.to
-0000ec60: 7461 6c5f 6e74 6872 6561 6473 2c0a 2020  tal_nthreads,.  
-0000ec70: 2020 2020 2020 2020 2020 2274 6f74 616c            "total
-0000ec80: 5f6f 6363 7570 616e 6379 223a 2073 656c  _occupancy": sel
-0000ec90: 662e 746f 7461 6c5f 6f63 6375 7061 6e63  f.total_occupanc
-0000eca0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-0000ecb0: 6572 7265 645f 7461 736b 7322 3a20 7365  erred_tasks": se
-0000ecc0: 6c66 2e65 7272 6564 5f74 6173 6b73 2c0a  lf.erred_tasks,.
-0000ecd0: 2020 2020 2020 2020 2020 2020 2265 7874              "ext
-0000ece0: 656e 7369 6f6e 7322 3a20 7365 6c66 2e65  ensions": self.e
-0000ecf0: 7874 656e 7369 6f6e 732c 0a20 2020 2020  xtensions,.     
-0000ed00: 2020 2020 2020 2022 636c 6965 6e74 7322         "clients"
-0000ed10: 3a20 7365 6c66 2e63 6c69 656e 7473 2c0a  : self.clients,.
-0000ed20: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-0000ed30: 6b65 7273 223a 2073 656c 662e 776f 726b  kers": self.work
-0000ed40: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-0000ed50: 2022 6964 6c65 223a 2073 656c 662e 6964   "idle": self.id
-0000ed60: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-0000ed70: 2268 6f73 745f 696e 666f 223a 2073 656c  "host_info": sel
-0000ed80: 662e 686f 7374 5f69 6e66 6f2c 0a20 2020  f.host_info,.   
-0000ed90: 2020 2020 207d 0a0a 2020 2020 6465 6620       }..    def 
-0000eda0: 6e65 775f 7461 736b 280a 2020 2020 2020  new_task(.      
-0000edb0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0000edc0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
-0000edd0: 2020 7370 6563 3a20 6f62 6a65 6374 2c0a    spec: object,.
-0000ede0: 2020 2020 2020 2020 7374 6174 653a 2054          state: T
-0000edf0: 6173 6b53 7461 7465 5374 6174 652c 0a20  askStateState,. 
-0000ee00: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
-0000ee10: 6f6e 3a20 436f 6d70 7574 6174 696f 6e20  on: Computation 
-0000ee20: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0000ee30: 2020 2029 202d 3e20 5461 736b 5374 6174     ) -> TaskStat
-0000ee40: 653a 0a20 2020 2020 2020 2022 2222 4372  e:.        """Cr
-0000ee50: 6561 7465 2061 206e 6577 2074 6173 6b2c  eate a new task,
-0000ee60: 2061 6e64 2061 7373 6f63 6961 7465 6420   and associated 
-0000ee70: 7374 6174 6573 2222 220a 2020 2020 2020  states""".      
-0000ee80: 2020 7473 203d 2054 6173 6b53 7461 7465    ts = TaskState
-0000ee90: 286b 6579 2c20 7370 6563 2c20 7374 6174  (key, spec, stat
-0000eea0: 6529 0a0a 2020 2020 2020 2020 7072 6566  e)..        pref
-0000eeb0: 6978 5f6b 6579 203d 206b 6579 5f73 706c  ix_key = key_spl
-0000eec0: 6974 286b 6579 290a 2020 2020 2020 2020  it(key).        
-0000eed0: 7470 203d 2073 656c 662e 7461 736b 5f70  tp = self.task_p
-0000eee0: 7265 6669 7865 732e 6765 7428 7072 6566  refixes.get(pref
-0000eef0: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
-0000ef00: 6966 2074 7020 6973 204e 6f6e 653a 0a20  if tp is None:. 
-0000ef10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ef20: 7461 736b 5f70 7265 6669 7865 735b 7072  task_prefixes[pr
-0000ef30: 6566 6978 5f6b 6579 5d20 3d20 7470 203d  efix_key] = tp =
-0000ef40: 2054 6173 6b50 7265 6669 7828 7072 6566   TaskPrefix(pref
-0000ef50: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
-0000ef60: 7473 2e70 7265 6669 7820 3d20 7470 0a0a  ts.prefix = tp..
-0000ef70: 2020 2020 2020 2020 6772 6f75 705f 6b65          group_ke
-0000ef80: 7920 3d20 7473 2e67 726f 7570 5f6b 6579  y = ts.group_key
-0000ef90: 0a20 2020 2020 2020 2074 6720 3d20 7365  .        tg = se
-0000efa0: 6c66 2e74 6173 6b5f 6772 6f75 7073 2e67  lf.task_groups.g
-0000efb0: 6574 2867 726f 7570 5f6b 6579 290a 2020  et(group_key).  
-0000efc0: 2020 2020 2020 6966 2074 6720 6973 204e        if tg is N
-0000efd0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000efe0: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000eff0: 735b 6772 6f75 705f 6b65 795d 203d 2074  s[group_key] = t
-0000f000: 6720 3d20 5461 736b 4772 6f75 7028 6772  g = TaskGroup(gr
-0000f010: 6f75 705f 6b65 7929 0a20 2020 2020 2020  oup_key).       
-0000f020: 2020 2020 2069 6620 636f 6d70 7574 6174       if computat
-0000f030: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-0000f040: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
-0000f050: 2e67 726f 7570 732e 6164 6428 7467 290a  .groups.add(tg).
-0000f060: 2020 2020 2020 2020 2020 2020 7467 2e70              tg.p
-0000f070: 7265 6669 7820 3d20 7470 0a20 2020 2020  refix = tp.     
-0000f080: 2020 2020 2020 2074 702e 6772 6f75 7073         tp.groups
-0000f090: 2e61 7070 656e 6428 7467 290a 2020 2020  .append(tg).    
-0000f0a0: 2020 2020 7467 2e61 6464 2874 7329 0a0a      tg.add(ts)..
-0000f0b0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000f0c0: 6b73 5b6b 6579 5d20 3d20 7473 0a0a 2020  ks[key] = ts..  
-0000f0d0: 2020 2020 2020 7265 7475 726e 2074 730a        return ts.
-0000f0e0: 0a20 2020 2064 6566 205f 636c 6561 725f  .    def _clear_
-0000f0f0: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
-0000f100: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000f110: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0000f120: 436c 6561 7220 7461 736b 2073 7461 7465  Clear task state
-0000f130: 2229 0a20 2020 2020 2020 2066 6f72 2063  ").        for c
-0000f140: 6f6c 6c65 6374 696f 6e20 696e 2028 0a20  ollection in (. 
-0000f150: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000f160: 756e 7275 6e6e 6162 6c65 2c0a 2020 2020  unrunnable,.    
-0000f170: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
-0000f180: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
-0000f190: 2020 2020 2020 7365 6c66 2e63 6f6d 7075        self.compu
-0000f1a0: 7461 7469 6f6e 732c 0a20 2020 2020 2020  tations,.       
-0000f1b0: 2020 2020 2073 656c 662e 7461 736b 5f70       self.task_p
-0000f1c0: 7265 6669 7865 732c 0a20 2020 2020 2020  refixes,.       
-0000f1d0: 2020 2020 2073 656c 662e 7461 736b 5f67       self.task_g
-0000f1e0: 726f 7570 732c 0a20 2020 2020 2020 2020  roups,.         
-0000f1f0: 2020 2073 656c 662e 7461 736b 5f6d 6574     self.task_met
-0000f200: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-0000f210: 2020 2073 656c 662e 756e 6b6e 6f77 6e5f     self.unknown_
-0000f220: 6475 7261 7469 6f6e 732c 0a20 2020 2020  durations,.     
-0000f230: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-0000f240: 6963 6174 6564 5f74 6173 6b73 2c0a 2020  icated_tasks,.  
-0000f250: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0000f260: 2020 2020 2063 6f6c 6c65 6374 696f 6e2e       collection.
-0000f270: 636c 6561 7228 2920 2023 2074 7970 653a  clear()  # type:
-0000f280: 2069 676e 6f72 650a 0a20 2020 2040 7072   ignore..    @pr
-0000f290: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
-0000f2a0: 735f 6964 6c65 2873 656c 6629 202d 3e20  s_idle(self) -> 
-0000f2b0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-0000f2c0: 2252 6574 7572 6e20 5472 7565 2069 6666  "Return True iff
-0000f2d0: 2074 6865 7265 2061 7265 206e 6f20 7461   there are no ta
-0000f2e0: 736b 7320 7468 6174 2068 6176 656e 2774  sks that haven't
-0000f2f0: 2066 696e 6973 6865 6420 636f 6d70 7574   finished comput
-0000f300: 696e 672e 0a0a 2020 2020 2020 2020 556e  ing...        Un
-0000f310: 6c69 6b65 2074 6573 7469 6e67 2060 6073  like testing ``s
-0000f320: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
-0000f330: 6e63 7960 602c 2074 6869 7320 7072 6f70  ncy``, this prop
-0000f340: 6572 7479 2072 6574 7572 6e73 2046 616c  erty returns Fal
-0000f350: 7365 2069 6620 7468 6572 6520 6172 650a  se if there are.
-0000f360: 2020 2020 2020 2020 6c6f 6e67 2d72 756e          long-run
-0000f370: 6e69 6e67 2074 6173 6b73 2c20 6e6f 2d77  ning tasks, no-w
-0000f380: 6f72 6b65 722c 206f 7220 7175 6575 6564  orker, or queued
-0000f390: 2074 6173 6b73 2028 6475 6520 746f 206e   tasks (due to n
-0000f3a0: 6f74 2068 6176 696e 6720 616e 7920 776f  ot having any wo
-0000f3b0: 726b 6572 7329 2e0a 0a20 2020 2020 2020  rkers)...       
-0000f3c0: 204e 6f74 2074 6f20 6265 2063 6f6e 6675   Not to be confu
-0000f3d0: 7365 6420 7769 7468 2060 6069 646c 6560  sed with ``idle`
-0000f3e0: 602e 0a20 2020 2020 2020 2022 2222 0a20  `..        """. 
-0000f3f0: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
-0000f400: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
-0000f410: 6f75 6e74 203d 3d20 3020 6f72 2073 7461  ount == 0 or sta
-0000f420: 7465 2069 6e20 7b22 6d65 6d6f 7279 222c  te in {"memory",
-0000f430: 2022 6572 726f 7222 2c20 2272 656c 6561   "error", "relea
-0000f440: 7365 6422 2c20 2266 6f72 676f 7474 656e  sed", "forgotten
-0000f450: 227d 0a20 2020 2020 2020 2020 2020 2066  "}.            f
-0000f460: 6f72 2074 6720 696e 2073 656c 662e 7461  or tg in self.ta
-0000f470: 736b 5f67 726f 7570 732e 7661 6c75 6573  sk_groups.values
-0000f480: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
-0000f490: 6f72 2073 7461 7465 2c20 636f 756e 7420  or state, count 
-0000f4a0: 696e 2074 672e 7374 6174 6573 2e69 7465  in tg.states.ite
-0000f4b0: 6d73 2829 0a20 2020 2020 2020 2029 0a0a  ms().        )..
-0000f4c0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0000f4d0: 2020 6465 6620 746f 7461 6c5f 6f63 6375    def total_occu
-0000f4e0: 7061 6e63 7928 7365 6c66 2920 2d3e 2066  pancy(self) -> f
-0000f4f0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-0000f500: 7475 726e 2073 656c 662e 5f63 616c 635f  turn self._calc_
-0000f510: 6f63 6375 7061 6e63 7928 0a20 2020 2020  occupancy(.     
-0000f520: 2020 2020 2020 2073 656c 662e 5f74 6173         self._tas
-0000f530: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
-0000f540: 6c6f 6261 6c2c 0a20 2020 2020 2020 2020  lobal,.         
-0000f550: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
-0000f560: 5f6f 6363 5f67 6c6f 6261 6c2c 0a20 2020  _occ_global,.   
-0000f570: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0000f580: 5f63 616c 635f 6f63 6375 7061 6e63 7928  _calc_occupancy(
-0000f590: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-0000f5a0: 2020 2020 2020 2074 6173 6b5f 7072 6566         task_pref
-0000f5b0: 6978 5f63 6f75 6e74 3a20 6469 6374 5b73  ix_count: dict[s
-0000f5c0: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
-0000f5d0: 2020 6e65 7477 6f72 6b5f 6f63 633a 2066    network_occ: f
-0000f5e0: 6c6f 6174 2c0a 2020 2020 2920 2d3e 2066  loat,.    ) -> f
-0000f5f0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-0000f600: 7320 3d20 302e 300a 2020 2020 2020 2020  s = 0.0.        
-0000f610: 666f 7220 7072 6566 6978 5f6e 616d 652c  for prefix_name,
-0000f620: 2063 6f75 6e74 2069 6e20 7461 736b 5f70   count in task_p
-0000f630: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
-0000f640: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000f650: 2023 2054 4f44 4f3a 2044 6561 6c20 7769   # TODO: Deal wi
-0000f660: 7468 2075 6e6b 6e6f 776e 2074 6173 6b73  th unknown tasks
-0000f670: 2062 6574 7465 720a 2020 2020 2020 2020   better.        
-0000f680: 2020 2020 7072 6566 6978 203d 2073 656c      prefix = sel
-0000f690: 662e 7461 736b 5f70 7265 6669 7865 735b  f.task_prefixes[
-0000f6a0: 7072 6566 6978 5f6e 616d 655d 0a20 2020  prefix_name].   
-0000f6b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000f6c0: 7072 6566 6978 2069 7320 6e6f 7420 4e6f  prefix is not No
-0000f6d0: 6e65 0a20 2020 2020 2020 2020 2020 2064  ne.            d
-0000f6e0: 7572 6174 696f 6e20 3d20 7072 6566 6978  uration = prefix
-0000f6f0: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
-0000f700: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0000f710: 2064 7572 6174 696f 6e20 3c20 303a 0a20   duration < 0:. 
-0000f720: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000f730: 6620 7072 6566 6978 2e6d 6178 5f65 7865  f prefix.max_exe
-0000f740: 635f 7469 6d65 203e 2030 3a0a 2020 2020  c_time > 0:.    
-0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f760: 6475 7261 7469 6f6e 203d 2032 202a 2070  duration = 2 * p
-0000f770: 7265 6669 782e 6d61 785f 6578 6563 5f74  refix.max_exec_t
-0000f780: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-0000f790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f7a0: 2020 2020 2020 2020 2020 2020 2020 6475                du
-0000f7b0: 7261 7469 6f6e 203d 2073 656c 662e 554e  ration = self.UN
-0000f7c0: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
-0000f7d0: 494f 4e0a 2020 2020 2020 2020 2020 2020  ION.            
-0000f7e0: 7265 7320 2b3d 2064 7572 6174 696f 6e20  res += duration 
-0000f7f0: 2a20 636f 756e 740a 2020 2020 2020 2020  * count.        
-0000f800: 6f63 6320 3d20 7265 7320 2b20 6e65 7477  occ = res + netw
-0000f810: 6f72 6b5f 6f63 6320 2f20 7365 6c66 2e62  ork_occ / self.b
-0000f820: 616e 6477 6964 7468 0a20 2020 2020 2020  andwidth.       
-0000f830: 2061 7373 6572 7420 6f63 6320 3e3d 2030   assert occ >= 0
-0000f840: 2c20 6f63 630a 2020 2020 2020 2020 7265  , occ.        re
-0000f850: 7475 726e 206f 6363 0a0a 2020 2020 2323  turn occ..    ##
-0000f860: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f870: 2323 230a 2020 2020 2320 5374 6174 6520  ###.    # State 
-0000f880: 5472 616e 7369 7469 6f6e 7320 230a 2020  Transitions #.  
-0000f890: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0000f8a0: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
-0000f8b0: 205f 7472 616e 7369 7469 6f6e 280a 2020   _transition(.  
-0000f8c0: 2020 2020 2020 7365 6c66 2c20 6b65 793a        self, key:
-0000f8d0: 2073 7472 2c20 6669 6e69 7368 3a20 5461   str, finish: Ta
-0000f8e0: 736b 5374 6174 6553 7461 7465 2c20 7374  skStateState, st
-0000f8f0: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
-0000f900: 2a2a 6b77 6172 6773 3a20 416e 790a 2020  **kwargs: Any.  
-0000f910: 2020 2920 2d3e 2052 6563 734d 7367 733a    ) -> RecsMsgs:
-0000f920: 0a20 2020 2020 2020 2022 2222 5472 616e  .        """Tran
-0000f930: 7369 7469 6f6e 2061 206b 6579 2066 726f  sition a key fro
-0000f940: 6d20 6974 7320 6375 7272 656e 7420 7374  m its current st
-0000f950: 6174 6520 746f 2074 6865 2066 696e 6973  ate to the finis
-0000f960: 6820 7374 6174 650a 0a20 2020 2020 2020  h state..       
-0000f970: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
-0000f980: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-0000f990: 2020 203e 3e3e 2073 656c 662e 5f74 7261     >>> self._tra
-0000f9a0: 6e73 6974 696f 6e28 2778 272c 2027 7761  nsition('x', 'wa
-0000f9b0: 6974 696e 6727 290a 2020 2020 2020 2020  iting').        
-0000f9c0: 7b27 7827 3a20 2770 726f 6365 7373 696e  {'x': 'processin
-0000f9d0: 6727 7d2c 207b 7d2c 207b 7d0a 0a20 2020  g'}, {}, {}..   
-0000f9e0: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-0000f9f0: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-0000fa00: 2020 2020 2054 7570 6c65 206f 663a 0a0a       Tuple of:..
-0000fa10: 2020 2020 2020 2020 2d20 4469 6374 696f          - Dictio
-0000fa20: 6e61 7279 206f 6620 7265 636f 6d6d 656e  nary of recommen
-0000fa30: 6461 7469 6f6e 7320 666f 7220 6675 7475  dations for futu
-0000fa40: 7265 2074 7261 6e73 6974 696f 6e73 207b  re transitions {
-0000fa50: 6b65 793a 206e 6577 2073 7461 7465 7d0a  key: new state}.
-0000fa60: 2020 2020 2020 2020 2d20 4d65 7373 6167          - Messag
-0000fa70: 6573 2074 6f20 636c 6965 6e74 7320 7b63  es to clients {c
-0000fa80: 6c69 656e 7420 6164 6472 6573 733a 205b  lient address: [
-0000fa90: 6d73 672c 206d 7367 2c20 2e2e 2e5d 7d0a  msg, msg, ...]}.
-0000faa0: 2020 2020 2020 2020 2d20 4d65 7373 6167          - Messag
-0000fab0: 6573 2074 6f20 776f 726b 6572 7320 7b77  es to workers {w
-0000fac0: 6f72 6b65 7220 6164 6472 6573 733a 205b  orker address: [
-0000fad0: 6d73 672c 206d 7367 2c20 2e2e 2e5d 7d0a  msg, msg, ...]}.
-0000fae0: 0a20 2020 2020 2020 2053 6565 2041 6c73  .        See Als
-0000faf0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-0000fb00: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
-0000fb10: 756c 6572 2e74 7261 6e73 6974 696f 6e73  uler.transitions
-0000fb20: 203a 2074 7261 6e73 6974 6976 6520 7665   : transitive ve
-0000fb30: 7273 696f 6e20 6f66 2074 6869 7320 6675  rsion of this fu
-0000fb40: 6e63 7469 6f6e 0a20 2020 2020 2020 2022  nction.        "
-0000fb50: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
-0000fb60: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0000fb70: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
-0000fb80: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0000fb90: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
-0000fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbb0: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
-0000fbc0: 7d0a 2020 2020 2020 2020 2020 2020 7374  }.            st
-0000fbd0: 6172 7420 3d20 7473 2e5f 7374 6174 650a  art = ts._state.
-0000fbe0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000fbf0: 7461 7274 203d 3d20 6669 6e69 7368 3a0a  tart == finish:.
-0000fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc10: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
-0000fc20: 7d0a 0a20 2020 2020 2020 2020 2020 2023  }..            #
-0000fc30: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
-0000fc40: 2020 2020 2320 2d20 696e 2063 6173 6520      # - in case 
-0000fc50: 6f66 2074 7261 6e73 6974 696f 6e20 7468  of transition th
-0000fc60: 726f 7567 6820 7265 6c65 6173 6564 2c20  rough released, 
-0000fc70: 7468 6973 2063 6f75 6e74 6572 2069 7320  this counter is 
-0000fc80: 696e 6372 656d 656e 7465 6420 6279 2032  incremented by 2
-0000fc90: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
-0000fca0: 2074 6869 7320 696e 6372 6561 7365 2068   this increase h
-0000fcb0: 6170 7065 6e73 2062 6566 6f72 6520 7468  appens before th
-0000fcc0: 6520 6163 7475 616c 2074 7261 6e73 6974  e actual transit
-0000fcd0: 696f 6e73 2c20 736f 2074 6861 7420 6974  ions, so that it
-0000fce0: 2063 616e 0a20 2020 2020 2020 2020 2020   can.           
-0000fcf0: 2023 2020 2063 6174 6368 2070 6f74 656e   #   catch poten
-0000fd00: 7469 616c 2069 6e66 696e 6974 6520 7265  tial infinite re
-0000fd10: 6375 7273 696f 6e73 0a20 2020 2020 2020  cursions.       
-0000fd20: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-0000fd30: 7469 6f6e 5f63 6f75 6e74 6572 202b 3d20  tion_counter += 
-0000fd40: 310a 2020 2020 2020 2020 2020 2020 6966  1.            if
-0000fd50: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0000fd60: 5f63 6f75 6e74 6572 5f6d 6178 3a0a 2020  _counter_max:.  
-0000fd70: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0000fd80: 7365 7274 2073 656c 662e 7472 616e 7369  sert self.transi
-0000fd90: 7469 6f6e 5f63 6f75 6e74 6572 203c 2073  tion_counter < s
-0000fda0: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
-0000fdb0: 6f75 6e74 6572 5f6d 6178 0a0a 2020 2020  ounter_max..    
-0000fdc0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0000fdd0: 6461 7469 6f6e 733a 2064 6963 7420 3d20  dations: dict = 
-0000fde0: 7b7d 0a20 2020 2020 2020 2020 2020 2077  {}.            w
-0000fdf0: 6f72 6b65 725f 6d73 6773 3a20 6469 6374  orker_msgs: dict
-0000fe00: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-0000fe10: 2020 636c 6965 6e74 5f6d 7367 733a 2064    client_msgs: d
-0000fe20: 6963 7420 3d20 7b7d 0a0a 2020 2020 2020  ict = {}..      
-0000fe30: 2020 2020 2020 6966 2073 656c 662e 706c        if self.pl
-0000fe40: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
-0000fe50: 2020 2020 2020 2064 6570 656e 6465 6e74         dependent
-0000fe60: 7320 3d20 7365 7428 7473 2e64 6570 656e  s = set(ts.depen
-0000fe70: 6465 6e74 7329 0a20 2020 2020 2020 2020  dents).         
-0000fe80: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-0000fe90: 6965 7320 3d20 7365 7428 7473 2e64 6570  ies = set(ts.dep
-0000fea0: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
-0000feb0: 2020 2020 2020 2020 6675 6e63 203d 2073          func = s
-0000fec0: 656c 662e 5f54 5241 4e53 4954 494f 4e53  elf._TRANSITIONS
-0000fed0: 5f54 4142 4c45 2e67 6574 2828 7374 6172  _TABLE.get((star
-0000fee0: 742c 2066 696e 6973 6829 290a 2020 2020  t, finish)).    
-0000fef0: 2020 2020 2020 2020 6966 2066 756e 6320          if func 
-0000ff00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000ff10: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0000ff20: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-0000ff30: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-0000ff40: 725f 6d73 6773 203d 2066 756e 6328 0a20  r_msgs = func(. 
-0000ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff60: 2020 2073 656c 662c 206b 6579 2c20 7374     self, key, st
-0000ff70: 696d 756c 7573 5f69 642c 202a 2a6b 7761  imulus_id, **kwa
-0000ff80: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-0000ff90: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000ffa0: 2020 2065 6c69 6620 2272 656c 6561 7365     elif "release
-0000ffb0: 6422 206e 6f74 2069 6e20 2873 7461 7274  d" not in (start
-0000ffc0: 2c20 6669 6e69 7368 293a 0a20 2020 2020  , finish):.     
-0000ffd0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000ffe0: 7420 6e6f 7420 6b77 6172 6773 2c20 286b  t not kwargs, (k
-0000fff0: 7761 7267 732c 2073 7461 7274 2c20 6669  wargs, start, fi
-00010000: 6e69 7368 290a 2020 2020 2020 2020 2020  nish).          
-00010010: 2020 2020 2020 615f 7265 6373 2c20 615f        a_recs, a_
-00010020: 636d 7367 732c 2061 5f77 6d73 6773 203d  cmsgs, a_wmsgs =
-00010030: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
-00010040: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00010050: 2020 2020 2020 206b 6579 2c20 2272 656c         key, "rel
-00010060: 6561 7365 6422 2c20 7374 696d 756c 7573  eased", stimulus
-00010070: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-00010080: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00010090: 2020 2020 2020 2076 203d 2061 5f72 6563         v = a_rec
-000100a0: 732e 6765 7428 6b65 792c 2066 696e 6973  s.get(key, finis
-000100b0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-000100c0: 2020 2066 756e 6320 3d20 7365 6c66 2e5f     func = self._
-000100d0: 5452 414e 5349 5449 4f4e 535f 5441 424c  TRANSITIONS_TABL
-000100e0: 455b 2272 656c 6561 7365 6422 2c20 765d  E["released", v]
-000100f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010100: 2062 5f72 6563 732c 2062 5f63 6d73 6773   b_recs, b_cmsgs
-00010110: 2c20 625f 776d 7367 7320 3d20 6675 6e63  , b_wmsgs = func
-00010120: 2873 656c 662c 206b 6579 2c20 7374 696d  (self, key, stim
-00010130: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-00010140: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00010150: 656e 6461 7469 6f6e 732e 7570 6461 7465  endations.update
-00010160: 2861 5f72 6563 7329 0a20 2020 2020 2020  (a_recs).       
-00010170: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
-00010180: 6e65 775f 6d73 6773 2069 6e20 615f 636d  new_msgs in a_cm
-00010190: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
-000101a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101b0: 2063 6c69 656e 745f 6d73 6773 2e73 6574   client_msgs.set
-000101c0: 6465 6661 756c 7428 632c 205b 5d29 2e65  default(c, []).e
-000101d0: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
-000101e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101f0: 666f 7220 772c 206e 6577 5f6d 7367 7320  for w, new_msgs 
-00010200: 696e 2061 5f77 6d73 6773 2e69 7465 6d73  in a_wmsgs.items
-00010210: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00010220: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-00010230: 7367 732e 7365 7464 6566 6175 6c74 2877  sgs.setdefault(w
-00010240: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
-00010250: 5f6d 7367 7329 0a0a 2020 2020 2020 2020  _msgs)..        
-00010260: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00010270: 6461 7469 6f6e 732e 7570 6461 7465 2862  dations.update(b
-00010280: 5f72 6563 7329 0a20 2020 2020 2020 2020  _recs).         
-00010290: 2020 2020 2020 2066 6f72 2063 2c20 6e65         for c, ne
-000102a0: 775f 6d73 6773 2069 6e20 625f 636d 7367  w_msgs in b_cmsg
-000102b0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-000102c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000102d0: 6c69 656e 745f 6d73 6773 2e73 6574 6465  lient_msgs.setde
-000102e0: 6661 756c 7428 632c 205b 5d29 2e65 7874  fault(c, []).ext
-000102f0: 656e 6428 6e65 775f 6d73 6773 290a 2020  end(new_msgs).  
-00010300: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00010310: 7220 772c 206e 6577 5f6d 7367 7320 696e  r w, new_msgs in
-00010320: 2062 5f77 6d73 6773 2e69 7465 6d73 2829   b_wmsgs.items()
-00010330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010340: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00010350: 732e 7365 7464 6566 6175 6c74 2877 2c20  s.setdefault(w, 
-00010360: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
-00010370: 7367 7329 0a0a 2020 2020 2020 2020 2020  sgs)..          
-00010380: 2020 2020 2020 7374 6172 7420 3d20 2272        start = "r
-00010390: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
-000103a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000103b0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000103c0: 2052 756e 7469 6d65 4572 726f 7228 0a20   RuntimeError(. 
-000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103e0: 2020 2066 2249 6d70 6f73 7369 626c 6520     f"Impossible 
-000103f0: 7472 616e 7369 7469 6f6e 2066 726f 6d20  transition from 
-00010400: 7b73 7461 7274 7d20 746f 207b 6669 6e69  {start} to {fini
-00010410: 7368 7d20 666f 7220 7b6b 6579 2172 7d3a  sh} for {key!r}:
-00010420: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00010430: 2020 2020 2020 2066 227b 7374 696d 756c         f"{stimul
-00010440: 7573 5f69 643d 7d2c 207b 6b77 6172 6773  us_id=}, {kwargs
-00010450: 3d7d 2c20 7374 6f72 793d 7b73 656c 662e  =}, story={self.
-00010460: 7374 6f72 7928 7473 297d 220a 2020 2020  story(ts)}".    
-00010470: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00010480: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00010490: 7420 7374 696d 756c 7573 5f69 643a 0a20  t stimulus_id:. 
-000104a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000104b0: 7469 6d75 6c75 735f 6964 203d 2053 5449  timulus_id = STI
-000104c0: 4d55 4c55 535f 4944 5f55 4e53 4554 0a0a  MULUS_ID_UNSET..
-000104d0: 2020 2020 2020 2020 2020 2020 6163 7475              actu
-000104e0: 616c 5f66 696e 6973 6820 3d20 7473 2e5f  al_finish = ts._
-000104f0: 7374 6174 650a 2020 2020 2020 2020 2020  state.          
-00010500: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-00010510: 6e5f 6c6f 672e 6170 7065 6e64 280a 2020  n_log.append(.  
-00010520: 2020 2020 2020 2020 2020 2020 2020 5472                Tr
-00010530: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
-00010540: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00010550: 792c 2073 7461 7274 2c20 6163 7475 616c  y, start, actual
-00010560: 5f66 696e 6973 682c 2072 6563 6f6d 6d65  _finish, recomme
-00010570: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
-00010580: 7573 5f69 642c 2074 696d 6528 290a 2020  us_id, time().  
-00010590: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000105a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000105b0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000105c0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-000105d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000105e0: 7469 6d75 6c75 735f 6964 203d 3d20 5354  timulus_id == ST
-000105f0: 494d 554c 5553 5f49 445f 554e 5345 543a  IMULUS_ID_UNSET:
-00010600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010610: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00010620: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
-00010630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010640: 2022 7374 696d 756c 7573 5f69 6420 6e6f   "stimulus_id no
-00010650: 7420 7365 7420 6475 7269 6e67 2053 6368  t set during Sch
-00010660: 6564 756c 6572 2074 7261 6e73 6974 696f  eduler transitio
-00010670: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-00010680: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010690: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000106a0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-000106b0: 2020 2020 2020 2020 2020 2022 5472 616e             "Tran
-000106c0: 7369 7469 6f6e 6564 2025 7220 2573 2d3e  sitioned %r %s->
-000106d0: 2573 2028 6163 7475 616c 3a20 2573 292e  %s (actual: %s).
-000106e0: 2020 436f 6e73 6571 7565 6e63 653a 2025    Consequence: %
-000106f0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00010700: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-00010710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010720: 2073 7461 7274 2c0a 2020 2020 2020 2020   start,.        
-00010730: 2020 2020 2020 2020 2020 2020 6669 6e69              fini
-00010740: 7368 2c0a 2020 2020 2020 2020 2020 2020  sh,.            
-00010750: 2020 2020 2020 2020 6163 7475 616c 5f66          actual_f
-00010760: 696e 6973 682c 0a20 2020 2020 2020 2020  inish,.         
-00010770: 2020 2020 2020 2020 2020 2064 6963 7428             dict(
-00010780: 7265 636f 6d6d 656e 6461 7469 6f6e 7329  recommendations)
-00010790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000107a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000107b0: 6966 2073 656c 662e 706c 7567 696e 733a  if self.plugins:
-000107c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000107d0: 2023 2054 656d 706f 7261 7269 6c79 2070   # Temporarily p
-000107e0: 7574 2062 6163 6b20 666f 7267 6f74 7465  ut back forgotte
-000107f0: 6e20 6b65 7920 666f 7220 706c 7567 696e  n key for plugin
-00010800: 2074 6f20 7265 7472 6965 7665 2069 740a   to retrieve it.
-00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010820: 6966 2074 732e 5f73 7461 7465 203d 3d20  if ts._state == 
-00010830: 2266 6f72 676f 7474 656e 223a 0a20 2020  "forgotten":.   
-00010840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010850: 2074 732e 6465 7065 6e64 656e 7473 203d   ts.dependents =
-00010860: 2064 6570 656e 6465 6e74 730a 2020 2020   dependents.    
+00000590: 7269 6275 7465 642e 636c 6965 6e74 2069  ributed.client i
+000005a0: 6d70 6f72 7420 536f 7572 6365 436f 6465  mport SourceCode
+000005b0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+000005c0: 642e 636f 6c6c 6563 7469 6f6e 7320 696d  d.collections im
+000005d0: 706f 7274 2048 6561 7053 6574 0a66 726f  port HeapSet.fro
+000005e0: 6d20 6469 7374 7269 6275 7465 642e 636f  m distributed.co
+000005f0: 6d6d 2069 6d70 6f72 7420 280a 2020 2020  mm import (.    
+00000600: 436f 6d6d 2c0a 2020 2020 436f 6d6d 436c  Comm,.    CommCl
+00000610: 6f73 6564 4572 726f 722c 0a20 2020 2067  osedError,.    g
+00000620: 6574 5f61 6464 7265 7373 5f68 6f73 742c  et_address_host,
+00000630: 0a20 2020 206e 6f72 6d61 6c69 7a65 5f61  .    normalize_a
+00000640: 6464 7265 7373 2c0a 2020 2020 7265 736f  ddress,.    reso
+00000650: 6c76 655f 6164 6472 6573 732c 0a20 2020  lve_address,.   
+00000660: 2075 6e70 6172 7365 5f68 6f73 745f 706f   unparse_host_po
+00000670: 7274 2c0a 290a 6672 6f6d 2064 6973 7472  rt,.).from distr
+00000680: 6962 7574 6564 2e63 6f6d 6d2e 6164 6472  ibuted.comm.addr
+00000690: 6573 7369 6e67 2069 6d70 6f72 7420 6164  essing import ad
+000006a0: 6472 6573 7365 735f 6672 6f6d 5f75 7365  dresses_from_use
+000006b0: 725f 6172 6773 0a66 726f 6d20 6469 7374  r_args.from dist
+000006c0: 7269 6275 7465 642e 636f 6d70 6174 6962  ributed.compatib
+000006d0: 696c 6974 7920 696d 706f 7274 2050 6572  ility import Per
+000006e0: 696f 6469 6343 616c 6c62 6163 6b0a 6672  iodicCallback.fr
+000006f0: 6f6d 2064 6973 7472 6962 7574 6564 2e63  om distributed.c
+00000700: 6f72 6520 696d 706f 7274 2053 7461 7475  ore import Statu
+00000710: 732c 2063 6c65 616e 5f65 7863 6570 7469  s, clean_excepti
+00000720: 6f6e 2c20 6572 726f 725f 6d65 7373 6167  on, error_messag
+00000730: 652c 2072 7063 2c20 7365 6e64 5f72 6563  e, rpc, send_rec
+00000740: 760a 6672 6f6d 2064 6973 7472 6962 7574  v.from distribut
+00000750: 6564 2e64 6961 676e 6f73 7469 6373 2e6d  ed.diagnostics.m
+00000760: 656d 6f72 795f 7361 6d70 6c65 7220 696d  emory_sampler im
+00000770: 706f 7274 204d 656d 6f72 7953 616d 706c  port MemorySampl
+00000780: 6572 4578 7465 6e73 696f 6e0a 6672 6f6d  erExtension.from
+00000790: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
+000007a0: 676e 6f73 7469 6373 2e70 6c75 6769 6e20  gnostics.plugin 
+000007b0: 696d 706f 7274 2053 6368 6564 756c 6572  import Scheduler
+000007c0: 506c 7567 696e 2c20 5f67 6574 5f70 6c75  Plugin, _get_plu
+000007d0: 6769 6e5f 6e61 6d65 0a66 726f 6d20 6469  gin_name.from di
+000007e0: 7374 7269 6275 7465 642e 6576 656e 7420  stributed.event 
+000007f0: 696d 706f 7274 2045 7665 6e74 4578 7465  import EventExte
+00000800: 6e73 696f 6e0a 6672 6f6d 2064 6973 7472  nsion.from distr
+00000810: 6962 7574 6564 2e68 7474 7020 696d 706f  ibuted.http impo
+00000820: 7274 2067 6574 5f68 616e 646c 6572 730a  rt get_handlers.
+00000830: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00000840: 2e6c 6f63 6b20 696d 706f 7274 204c 6f63  .lock import Loc
+00000850: 6b45 7874 656e 7369 6f6e 0a66 726f 6d20  kExtension.from 
+00000860: 6469 7374 7269 6275 7465 642e 6d65 7472  distributed.metr
+00000870: 6963 7320 696d 706f 7274 206d 6f6e 6f74  ics import monot
+00000880: 6f6e 6963 2c20 7469 6d65 0a66 726f 6d20  onic, time.from 
+00000890: 6469 7374 7269 6275 7465 642e 6d75 6c74  distributed.mult
+000008a0: 695f 6c6f 636b 2069 6d70 6f72 7420 4d75  i_lock import Mu
+000008b0: 6c74 694c 6f63 6b45 7874 656e 7369 6f6e  ltiLockExtension
+000008c0: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+000008d0: 642e 6e6f 6465 2069 6d70 6f72 7420 5365  d.node import Se
+000008e0: 7276 6572 4e6f 6465 0a66 726f 6d20 6469  rverNode.from di
+000008f0: 7374 7269 6275 7465 642e 7072 6f63 7469  stributed.procti
+00000900: 746c 6520 696d 706f 7274 2073 6574 7072  tle import setpr
+00000910: 6f63 7469 746c 650a 6672 6f6d 2064 6973  octitle.from dis
+00000920: 7472 6962 7574 6564 2e70 726f 746f 636f  tributed.protoco
+00000930: 6c2e 7069 636b 6c65 2069 6d70 6f72 7420  l.pickle import 
+00000940: 6475 6d70 732c 206c 6f61 6473 0a66 726f  dumps, loads.fro
+00000950: 6d20 6469 7374 7269 6275 7465 642e 7072  m distributed.pr
+00000960: 6f74 6f63 6f6c 2e73 6572 6961 6c69 7a65  otocol.serialize
+00000970: 2069 6d70 6f72 7420 5365 7269 616c 697a   import Serializ
+00000980: 6564 2c20 546f 5069 636b 6c65 2c20 7365  ed, ToPickle, se
+00000990: 7269 616c 697a 650a 6672 6f6d 2064 6973  rialize.from dis
+000009a0: 7472 6962 7574 6564 2e70 7562 6c69 7368  tributed.publish
+000009b0: 2069 6d70 6f72 7420 5075 626c 6973 6845   import PublishE
+000009c0: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+000009d0: 7374 7269 6275 7465 642e 7075 6273 7562  stributed.pubsub
+000009e0: 2069 6d70 6f72 7420 5075 6253 7562 5363   import PubSubSc
+000009f0: 6865 6475 6c65 7245 7874 656e 7369 6f6e  hedulerExtension
+00000a00: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000a10: 642e 7175 6575 6573 2069 6d70 6f72 7420  d.queues import 
+00000a20: 5175 6575 6545 7874 656e 7369 6f6e 0a66  QueueExtension.f
+00000a30: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+00000a40: 7265 6372 6561 7465 5f74 6173 6b73 2069  recreate_tasks i
+00000a50: 6d70 6f72 7420 5265 706c 6179 5461 736b  mport ReplayTask
+00000a60: 5363 6865 6475 6c65 720a 6672 6f6d 2064  Scheduler.from d
+00000a70: 6973 7472 6962 7574 6564 2e73 6563 7572  istributed.secur
+00000a80: 6974 7920 696d 706f 7274 2053 6563 7572  ity import Secur
+00000a90: 6974 790a 6672 6f6d 2064 6973 7472 6962  ity.from distrib
+00000aa0: 7574 6564 2e73 656d 6170 686f 7265 2069  uted.semaphore i
+00000ab0: 6d70 6f72 7420 5365 6d61 7068 6f72 6545  mport SemaphoreE
+00000ac0: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+00000ad0: 7374 7269 6275 7465 642e 7368 7566 666c  stributed.shuffl
+00000ae0: 6520 696d 706f 7274 2053 6875 6666 6c65  e import Shuffle
+00000af0: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
+00000b00: 6f6e 0a66 726f 6d20 6469 7374 7269 6275  on.from distribu
+00000b10: 7465 642e 7370 616e 7320 696d 706f 7274  ted.spans import
+00000b20: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
+00000b30: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+00000b40: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
+00000b50: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
+00000b60: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
+00000b70: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
+00000b80: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
+00000b90: 2020 2020 5469 6d65 6f75 7445 7272 6f72      TimeoutError
+00000ba0: 2c0a 2020 2020 656d 7074 795f 636f 6e74  ,.    empty_cont
+00000bb0: 6578 742c 0a20 2020 2066 6f72 6d61 745f  ext,.    format_
+00000bc0: 6461 7368 626f 6172 645f 6c69 6e6b 2c0a  dashboard_link,.
+00000bd0: 2020 2020 6765 745f 6669 6c65 6e6f 5f6c      get_fileno_l
+00000be0: 696d 6974 2c0a 2020 2020 6b65 795f 7370  imit,.    key_sp
+00000bf0: 6c69 745f 6772 6f75 702c 0a20 2020 206c  lit_group,.    l
+00000c00: 6f67 5f65 7272 6f72 732c 0a20 2020 206e  og_errors,.    n
+00000c10: 6f5f 6465 6661 756c 742c 0a20 2020 2072  o_default,.    r
+00000c20: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
+00000c30: 2c0a 2020 2020 7661 6c69 6461 7465 5f6b  ,.    validate_k
+00000c40: 6579 2c0a 2020 2020 7761 6974 5f66 6f72  ey,.    wait_for
+00000c50: 2c0a 290a 6672 6f6d 2064 6973 7472 6962  ,.).from distrib
+00000c60: 7574 6564 2e75 7469 6c73 5f63 6f6d 6d20  uted.utils_comm 
+00000c70: 696d 706f 7274 2028 0a20 2020 2067 6174  import (.    gat
+00000c80: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
+00000c90: 2c0a 2020 2020 7265 7472 795f 6f70 6572  ,.    retry_oper
+00000ca0: 6174 696f 6e2c 0a20 2020 2073 6361 7474  ation,.    scatt
+00000cb0: 6572 5f74 6f5f 776f 726b 6572 732c 0a20  er_to_workers,. 
+00000cc0: 2020 2075 6e70 6163 6b5f 7265 6d6f 7465     unpack_remote
+00000cd0: 6461 7461 2c0a 290a 6672 6f6d 2064 6973  data,.).from dis
+00000ce0: 7472 6962 7574 6564 2e75 7469 6c73 5f70  tributed.utils_p
+00000cf0: 6572 6620 696d 706f 7274 2064 6973 6162  erf import disab
+00000d00: 6c65 5f67 635f 6469 6167 6e6f 7369 732c  le_gc_diagnosis,
+00000d10: 2065 6e61 626c 655f 6763 5f64 6961 676e   enable_gc_diagn
+00000d20: 6f73 6973 0a66 726f 6d20 6469 7374 7269  osis.from distri
+00000d30: 6275 7465 642e 7661 7269 6162 6c65 2069  buted.variable i
+00000d40: 6d70 6f72 7420 5661 7269 6162 6c65 4578  mport VariableEx
+00000d50: 7465 6e73 696f 6e0a 0a69 6620 5459 5045  tension..if TYPE
+00000d60: 5f43 4845 434b 494e 473a 0a20 2020 2023  _CHECKING:.    #
+00000d70: 2054 4f44 4f20 696d 706f 7274 2066 726f   TODO import fro
+00000d80: 6d20 7479 7069 6e67 2028 7265 7175 6972  m typing (requir
+00000d90: 6573 2050 7974 686f 6e20 3e3d 332e 3130  es Python >=3.10
+00000da0: 290a 2020 2020 6672 6f6d 2074 7970 696e  ).    from typin
+00000db0: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
+00000dc0: 6f72 7420 5479 7065 416c 6961 730a 0a20  ort TypeAlias.. 
+00000dd0: 2020 2066 726f 6d20 6461 736b 2e68 6967     from dask.hig
+00000de0: 686c 6576 656c 6772 6170 6820 696d 706f  hlevelgraph impo
+00000df0: 7274 2048 6967 684c 6576 656c 4772 6170  rt HighLevelGrap
+00000e00: 680a 0a23 204e 6f74 2074 6f20 6265 2063  h..# Not to be c
+00000e10: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
+00000e20: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+00000e30: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
+00000e40: 736b 5374 6174 6553 7461 7465 0a54 6173  skStateState.Tas
+00000e50: 6b53 7461 7465 5374 6174 653a 2054 7970  kStateState: Typ
+00000e60: 6541 6c69 6173 203d 204c 6974 6572 616c  eAlias = Literal
+00000e70: 5b0a 2020 2020 2272 656c 6561 7365 6422  [.    "released"
+00000e80: 2c0a 2020 2020 2277 6169 7469 6e67 222c  ,.    "waiting",
+00000e90: 0a20 2020 2022 6e6f 2d77 6f72 6b65 7222  .    "no-worker"
+00000ea0: 2c0a 2020 2020 2271 7565 7565 6422 2c0a  ,.    "queued",.
+00000eb0: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
+00000ec0: 2c0a 2020 2020 226d 656d 6f72 7922 2c0a  ,.    "memory",.
+00000ed0: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
+00000ee0: 2022 666f 7267 6f74 7465 6e22 2c0a 5d0a   "forgotten",.].
+00000ef0: 0a41 4c4c 5f54 4153 4b5f 5354 4154 4553  .ALL_TASK_STATES
+00000f00: 3a20 5365 745b 5461 736b 5374 6174 6553  : Set[TaskStateS
+00000f10: 7461 7465 5d20 3d20 7365 7428 5461 736b  tate] = set(Task
+00000f20: 5374 6174 6553 7461 7465 2e5f 5f61 7267  StateState.__arg
+00000f30: 735f 5f29 2020 2320 7479 7065 3a20 6967  s__)  # type: ig
+00000f40: 6e6f 7265 0a0a 2320 7b74 6173 6b20 6b65  nore..# {task ke
+00000f50: 7920 2d3e 2066 696e 6973 6820 7374 6174  y -> finish stat
+00000f60: 657d 0a23 204e 6f74 2074 6f20 6265 2063  e}.# Not to be c
+00000f70: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
+00000f80: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+00000f90: 7374 6174 655f 6d61 6368 696e 652e 5265  state_machine.Re
+00000fa0: 6373 0a52 6563 733a 2054 7970 6541 6c69  cs.Recs: TypeAli
+00000fb0: 6173 203d 2064 6963 745b 7374 722c 2054  as = dict[str, T
+00000fc0: 6173 6b53 7461 7465 5374 6174 655d 0a23  askStateState].#
+00000fd0: 207b 636c 6965 6e74 206f 7220 776f 726b   {client or work
+00000fe0: 6572 2061 6464 7265 7373 3a20 5b7b 6f70  er address: [{op
+00000ff0: 3a20 3c6b 6579 3e2c 202e 2e2e 7d2c 202e  : <key>, ...}, .
+00001000: 2e2e 5d7d 0a4d 7367 733a 2054 7970 6541  ..]}.Msgs: TypeA
+00001010: 6c69 6173 203d 2064 6963 745b 7374 722c  lias = dict[str,
+00001020: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
+00001030: 416e 795d 5d5d 0a23 2028 7265 636f 6d6d  Any]]].# (recomm
+00001040: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00001050: 7420 6d65 7373 6167 6573 2c20 776f 726b  t messages, work
+00001060: 6572 206d 6573 7361 6765 7329 0a52 6563  er messages).Rec
+00001070: 734d 7367 733a 2054 7970 6541 6c69 6173  sMsgs: TypeAlias
+00001080: 203d 2074 7570 6c65 5b52 6563 732c 204d   = tuple[Recs, M
+00001090: 7367 732c 204d 7367 735d 0a0a 6c6f 6767  sgs, Msgs]..logg
+000010a0: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
+000010b0: 4c6f 6767 6572 285f 5f6e 616d 655f 5f29  Logger(__name__)
+000010c0: 0a4c 4f47 5f50 4442 203d 2064 6173 6b2e  .LOG_PDB = dask.
+000010d0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+000010e0: 7269 6275 7465 642e 6164 6d69 6e2e 7064  ributed.admin.pd
+000010f0: 622d 6f6e 2d65 7272 2229 0a44 4546 4155  b-on-err").DEFAU
+00001100: 4c54 5f44 4154 415f 5349 5a45 203d 2070  LT_DATA_SIZE = p
+00001110: 6172 7365 5f62 7974 6573 280a 2020 2020  arse_bytes(.    
+00001120: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+00001130: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+00001140: 6564 756c 6572 2e64 6566 6175 6c74 2d64  eduler.default-d
+00001150: 6174 612d 7369 7a65 2229 0a29 0a53 5449  ata-size").).STI
+00001160: 4d55 4c55 535f 4944 5f55 4e53 4554 203d  MULUS_ID_UNSET =
+00001170: 2022 3c73 7469 6d75 6c75 735f 6964 2075   "<stimulus_id u
+00001180: 6e73 6574 3e22 0a0a 4445 4641 554c 545f  nset>"..DEFAULT_
+00001190: 4558 5445 4e53 494f 4e53 203d 207b 0a20  EXTENSIONS = {. 
+000011a0: 2020 2022 6c6f 636b 7322 3a20 4c6f 636b     "locks": Lock
+000011b0: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+000011c0: 6d75 6c74 695f 6c6f 636b 7322 3a20 4d75  multi_locks": Mu
+000011d0: 6c74 694c 6f63 6b45 7874 656e 7369 6f6e  ltiLockExtension
+000011e0: 2c0a 2020 2020 2270 7562 6c69 7368 223a  ,.    "publish":
+000011f0: 2050 7562 6c69 7368 4578 7465 6e73 696f   PublishExtensio
+00001200: 6e2c 0a20 2020 2022 7265 706c 6179 2d74  n,.    "replay-t
+00001210: 6173 6b73 223a 2052 6570 6c61 7954 6173  asks": ReplayTas
+00001220: 6b53 6368 6564 756c 6572 2c0a 2020 2020  kScheduler,.    
+00001230: 2271 7565 7565 7322 3a20 5175 6575 6545  "queues": QueueE
+00001240: 7874 656e 7369 6f6e 2c0a 2020 2020 2276  xtension,.    "v
+00001250: 6172 6961 626c 6573 223a 2056 6172 6961  ariables": Varia
+00001260: 626c 6545 7874 656e 7369 6f6e 2c0a 2020  bleExtension,.  
+00001270: 2020 2270 7562 7375 6222 3a20 5075 6253    "pubsub": PubS
+00001280: 7562 5363 6865 6475 6c65 7245 7874 656e  ubSchedulerExten
+00001290: 7369 6f6e 2c0a 2020 2020 2273 656d 6170  sion,.    "semap
+000012a0: 686f 7265 7322 3a20 5365 6d61 7068 6f72  hores": Semaphor
+000012b0: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
+000012c0: 2265 7665 6e74 7322 3a20 4576 656e 7445  "events": EventE
+000012d0: 7874 656e 7369 6f6e 2c0a 2020 2020 2261  xtension,.    "a
+000012e0: 6d6d 223a 2041 6374 6976 654d 656d 6f72  mm": ActiveMemor
+000012f0: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
+00001300: 6e2c 0a20 2020 2022 6d65 6d6f 7279 5f73  n,.    "memory_s
+00001310: 616d 706c 6572 223a 204d 656d 6f72 7953  ampler": MemoryS
+00001320: 616d 706c 6572 4578 7465 6e73 696f 6e2c  amplerExtension,
+00001330: 0a20 2020 2022 7368 7566 666c 6522 3a20  .    "shuffle": 
+00001340: 5368 7566 666c 6553 6368 6564 756c 6572  ShuffleScheduler
+00001350: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+00001360: 7370 616e 7322 3a20 5370 616e 7353 6368  spans": SpansSch
+00001370: 6564 756c 6572 4578 7465 6e73 696f 6e2c  edulerExtension,
+00001380: 0a20 2020 2022 7374 6561 6c69 6e67 223a  .    "stealing":
+00001390: 2057 6f72 6b53 7465 616c 696e 672c 0a7d   WorkStealing,.}
+000013a0: 0a0a 0a63 6c61 7373 2043 6c69 656e 7453  ...class ClientS
+000013b0: 7461 7465 3a0a 2020 2020 2222 2241 2073  tate:.    """A s
+000013c0: 696d 706c 6520 6f62 6a65 6374 2068 6f6c  imple object hol
+000013d0: 6469 6e67 2069 6e66 6f72 6d61 7469 6f6e  ding information
+000013e0: 2061 626f 7574 2061 2063 6c69 656e 742e   about a client.
+000013f0: 2222 220a 0a20 2020 2023 3a20 4120 756e  """..    #: A un
+00001400: 6971 7565 2069 6465 6e74 6966 6965 7220  ique identifier 
+00001410: 666f 7220 7468 6973 2063 6c69 656e 742e  for this client.
+00001420: 2054 6869 7320 6973 2067 656e 6572 616c   This is general
+00001430: 6c79 2061 6e20 6f70 6171 7565 0a20 2020  ly an opaque.   
+00001440: 2023 3a20 7374 7269 6e67 2067 656e 6572   #: string gener
+00001450: 6174 6564 2062 7920 7468 6520 636c 6965  ated by the clie
+00001460: 6e74 2069 7473 656c 662e 0a20 2020 2063  nt itself..    c
+00001470: 6c69 656e 745f 6b65 793a 2073 7472 0a0a  lient_key: str..
+00001480: 2020 2020 233a 2043 6163 6865 6420 6861      #: Cached ha
+00001490: 7368 206f 6620 3a61 7474 723a 607e 436c  sh of :attr:`~Cl
+000014a0: 6965 6e74 5374 6174 652e 636c 6965 6e74  ientState.client
+000014b0: 5f6b 6579 600a 2020 2020 5f68 6173 683a  _key`.    _hash:
+000014c0: 2069 6e74 0a0a 2020 2020 233a 2041 2073   int..    #: A s
+000014d0: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
+000014e0: 2063 6c69 656e 7420 7761 6e74 7320 746f   client wants to
+000014f0: 2062 6520 6b65 7074 2069 6e20 6d65 6d6f   be kept in memo
+00001500: 7279 2c20 736f 2074 6861 7420 6974 2063  ry, so that it c
+00001510: 616e 2064 6f77 6e6c 6f61 640a 2020 2020  an download.    
+00001520: 233a 2069 7473 2072 6573 756c 7420 7768  #: its result wh
+00001530: 656e 2064 6573 6972 6564 2e20 5468 6973  en desired. This
+00001540: 2069 7320 7468 6520 7265 7665 7273 6520   is the reverse 
+00001550: 6d61 7070 696e 6720 6f66 0a20 2020 2023  mapping of.    #
+00001560: 3a20 3a63 6c61 7373 3a60 5461 736b 5374  : :class:`TaskSt
+00001570: 6174 652e 7768 6f5f 7761 6e74 7360 2e20  ate.who_wants`. 
+00001580: 5461 736b 7320 6172 6520 7479 7069 6361  Tasks are typica
+00001590: 6c6c 7920 7265 6d6f 7665 6420 6672 6f6d  lly removed from
+000015a0: 2074 6869 7320 7365 7420 7768 656e 2074   this set when t
+000015b0: 6865 0a20 2020 2023 3a20 636f 7272 6573  he.    #: corres
+000015c0: 706f 6e64 696e 6720 6f62 6a65 6374 2069  ponding object i
+000015d0: 6e20 7468 6520 636c 6965 6e74 2773 2073  n the client's s
+000015e0: 7061 6365 2028 666f 7220 6578 616d 706c  pace (for exampl
+000015f0: 6520 6120 6060 4675 7475 7265 6060 206f  e a ``Future`` o
+00001600: 7220 6120 4461 736b 0a20 2020 2023 3a20  r a Dask.    #: 
+00001610: 636f 6c6c 6563 7469 6f6e 2920 6765 7473  collection) gets
+00001620: 2067 6172 6261 6765 2d63 6f6c 6c65 6374   garbage-collect
+00001630: 6564 2e0a 2020 2020 7761 6e74 735f 7768  ed..    wants_wh
+00001640: 6174 3a20 7365 745b 5461 736b 5374 6174  at: set[TaskStat
+00001650: 655d 0a0a 2020 2020 233a 2054 6865 206c  e]..    #: The l
+00001660: 6173 7420 7469 6d65 2077 6520 7265 6365  ast time we rece
+00001670: 6976 6564 2061 2068 6561 7274 6265 6174  ived a heartbeat
+00001680: 2066 726f 6d20 7468 6973 2063 6c69 656e   from this clien
+00001690: 742c 2069 6e20 6c6f 6361 6c20 7363 6865  t, in local sche
+000016a0: 6475 6c65 7220 7469 6d65 2e0a 2020 2020  duler time..    
+000016b0: 6c61 7374 5f73 6565 6e3a 2066 6c6f 6174  last_seen: float
+000016c0: 0a0a 2020 2020 233a 204f 7574 7075 7420  ..    #: Output 
+000016d0: 6f66 203a 6675 6e63 3a60 6469 7374 7269  of :func:`distri
+000016e0: 6275 7465 642e 7665 7273 696f 6e73 2e67  buted.versions.g
+000016f0: 6574 5f76 6572 7369 6f6e 7360 206f 6e20  et_versions` on 
+00001700: 7468 6520 636c 6965 6e74 0a20 2020 2076  the client.    v
+00001710: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
+00001720: 722c 2041 6e79 5d0a 0a20 2020 205f 5f73  r, Any]..    __s
+00001730: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+00001740: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+00001750: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00001760: 5f28 7365 6c66 2c20 636c 6965 6e74 3a20  _(self, client: 
+00001770: 7374 722c 202a 2c20 7665 7273 696f 6e73  str, *, versions
+00001780: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00001790: 207c 204e 6f6e 6520 3d20 4e6f 6e65 293a   | None = None):
+000017a0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+000017b0: 6965 6e74 5f6b 6579 203d 2063 6c69 656e  ient_key = clien
+000017c0: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
+000017d0: 6861 7368 203d 2068 6173 6828 636c 6965  hash = hash(clie
+000017e0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
+000017f0: 2e77 616e 7473 5f77 6861 7420 3d20 7365  .wants_what = se
+00001800: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+00001810: 2e6c 6173 745f 7365 656e 203d 2074 696d  .last_seen = tim
+00001820: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
+00001830: 2e76 6572 7369 6f6e 7320 3d20 7665 7273  .versions = vers
+00001840: 696f 6e73 206f 7220 7b7d 0a0a 2020 2020  ions or {}..    
+00001850: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
+00001860: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00001870: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00001880: 6861 7368 0a0a 2020 2020 6465 6620 5f5f  hash..    def __
+00001890: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
+000018a0: 3a20 6f62 6a65 6374 2920 2d3e 2062 6f6f  : object) -> boo
+000018b0: 6c3a 0a20 2020 2020 2020 2069 6620 6e6f  l:.        if no
+000018c0: 7420 6973 696e 7374 616e 6365 286f 7468  t isinstance(oth
+000018d0: 6572 2c20 436c 6965 6e74 5374 6174 6529  er, ClientState)
+000018e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000018f0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+00001900: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00001910: 6c69 656e 745f 6b65 7920 3d3d 206f 7468  lient_key == oth
+00001920: 6572 2e63 6c69 656e 745f 6b65 790a 0a20  er.client_key.. 
+00001930: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
+00001940: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00001950: 2020 2020 2020 7265 7475 726e 2066 223c        return f"<
+00001960: 436c 6965 6e74 207b 7365 6c66 2e63 6c69  Client {self.cli
+00001970: 656e 745f 6b65 7921 727d 3e22 0a0a 2020  ent_key!r}>"..  
+00001980: 2020 6465 6620 5f5f 7374 725f 5f28 7365    def __str__(se
+00001990: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+000019a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+000019b0: 636c 6965 6e74 5f6b 6579 0a0a 2020 2020  client_key..    
+000019c0: 6465 6620 5f74 6f5f 6469 6374 5f6e 6f5f  def _to_dict_no_
+000019d0: 6e65 7374 2873 656c 662c 202a 2c20 6578  nest(self, *, ex
+000019e0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
+000019f0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
+00001a00: 6963 743a 0a20 2020 2020 2020 2022 2222  ict:.        """
+00001a10: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
+00001a20: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
+00001a30: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
+00001a40: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
+00001a50: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
+00001a60: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
+00001a70: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
+00001a80: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00001a90: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00001aa0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
+00001ab0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
+00001ac0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+00001ad0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
+00001ae0: 6976 655f 746f 5f64 6963 740a 2020 2020  ive_to_dict.    
+00001af0: 2020 2020 5461 736b 5374 6174 652e 5f74      TaskState._t
+00001b00: 6f5f 6469 6374 0a20 2020 2020 2020 2022  o_dict.        "
+00001b10: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00001b20: 6e20 7265 6375 7273 6976 655f 746f 5f64  n recursive_to_d
+00001b30: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
+00001b40: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
+00001b50: 2020 2065 7863 6c75 6465 3d73 6574 2865     exclude=set(e
+00001b60: 7863 6c75 6465 2920 7c20 7b22 7665 7273  xclude) | {"vers
+00001b70: 696f 6e73 227d 2c20 2023 2074 7970 653a  ions"},  # type:
+00001b80: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00001b90: 2020 2020 6d65 6d62 6572 733d 5472 7565      members=True
+00001ba0: 2c0a 2020 2020 2020 2020 290a 0a0a 636c  ,.        )...cl
+00001bb0: 6173 7320 4d65 6d6f 7279 5374 6174 653a  ass MemoryState:
+00001bc0: 0a20 2020 2022 2222 4d65 6d6f 7279 2072  .    """Memory r
+00001bd0: 6561 6469 6e67 7320 6f6e 2061 2077 6f72  eadings on a wor
+00001be0: 6b65 7220 6f72 206f 6e20 7468 6520 7768  ker or on the wh
+00001bf0: 6f6c 6520 636c 7573 7465 722e 0a0a 2020  ole cluster...  
+00001c00: 2020 5365 6520 3a64 6f63 3a60 776f 726b    See :doc:`work
+00001c10: 6572 2d6d 656d 6f72 7960 2e0a 0a20 2020  er-memory`...   
+00001c20: 2041 7474 7269 6275 7465 7320 2f20 7072   Attributes / pr
+00001c30: 6f70 6572 7469 6573 3a0a 0a20 2020 206d  operties:..    m
+00001c40: 616e 6167 6564 5f74 6f74 616c 0a20 2020  anaged_total.   
+00001c50: 2020 2020 2053 756d 206f 6620 7468 6520       Sum of the 
+00001c60: 6f75 7470 7574 206f 6620 7369 7a65 6f66  output of sizeof
+00001c70: 2829 2066 6f72 2061 6c6c 2064 6173 6b20  () for all dask 
+00001c80: 6b65 7973 2068 656c 6420 6279 2074 6865  keys held by the
+00001c90: 2077 6f72 6b65 7220 696e 206d 656d 6f72   worker in memor
+00001ca0: 792c 0a20 2020 2020 2020 2070 6c75 7320  y,.        plus 
+00001cb0: 6e75 6d62 6572 206f 6620 6279 7465 7320  number of bytes 
+00001cc0: 7370 696c 6c65 6420 746f 2064 6973 6b0a  spilled to disk.
+00001cd0: 0a20 2020 206d 616e 6167 6564 0a20 2020  .    managed.   
+00001ce0: 2020 2020 2053 756d 206f 6620 7468 6520       Sum of the 
+00001cf0: 6f75 7470 7574 206f 6620 7369 7a65 6f66  output of sizeof
+00001d00: 2829 2066 6f72 2074 6865 2064 6173 6b20  () for the dask 
+00001d10: 6b65 7973 2068 656c 6420 696e 2052 414d  keys held in RAM
+00001d20: 2e20 4e6f 7465 2074 6861 7420 7468 6973  . Note that this
+00001d30: 206d 6179 0a20 2020 2020 2020 2062 6520   may.        be 
+00001d40: 696e 6163 6375 7261 7465 2c20 7768 6963  inaccurate, whic
+00001d50: 6820 6d61 7920 6361 7573 6520 696e 6163  h may cause inac
+00001d60: 6375 7261 7465 2075 6e6d 616e 6167 6564  curate unmanaged
+00001d70: 206d 656d 6f72 7920 2873 6565 2062 656c   memory (see bel
+00001d80: 6f77 292e 0a0a 2020 2020 7370 696c 6c65  ow)...    spille
+00001d90: 640a 2020 2020 2020 2020 4e75 6d62 6572  d.        Number
+00001da0: 206f 6620 6279 7465 7320 2066 6f72 2074   of bytes  for t
+00001db0: 6865 2064 6173 6b20 6b65 7973 2073 7069  he dask keys spi
+00001dc0: 6c6c 6564 2074 6f20 7468 6520 6861 7264  lled to the hard
+00001dd0: 2064 7269 7665 2e0a 2020 2020 2020 2020   drive..        
+00001de0: 4e6f 7465 2074 6861 7420 7468 6973 2069  Note that this i
+00001df0: 7320 7468 6520 7369 7a65 206f 6e20 6469  s the size on di
+00001e00: 736b 3b20 7369 7a65 2069 6e20 6d65 6d6f  sk; size in memo
+00001e10: 7279 206d 6179 2062 6520 6469 6666 6572  ry may be differ
+00001e20: 656e 7420 6475 6520 746f 0a20 2020 2020  ent due to.     
+00001e30: 2020 2063 6f6d 7072 6573 7369 6f6e 2061     compression a
+00001e40: 6e64 2069 6e61 6363 7572 6163 6965 7320  nd inaccuracies 
+00001e50: 696e 2073 697a 656f 6628 292e 2049 6e20  in sizeof(). In 
+00001e60: 6f74 6865 7220 776f 7264 732c 2067 6976  other words, giv
+00001e70: 656e 2074 6865 2073 616d 6520 6b65 7973  en the same keys
+00001e80: 2c0a 2020 2020 2020 2020 276d 616e 6167  ,.        'manag
+00001e90: 6564 2720 7769 6c6c 2063 6861 6e67 6520  ed' will change 
+00001ea0: 6465 7065 6e64 696e 6720 6f6e 2074 6865  depending on the
+00001eb0: 206b 6579 7320 6265 696e 6720 696e 206d   keys being in m
+00001ec0: 656d 6f72 7920 6f72 2073 7069 6c6c 6564  emory or spilled
+00001ed0: 2e0a 0a20 2020 2070 726f 6365 7373 0a20  ...    process. 
+00001ee0: 2020 2020 2020 2054 6f74 616c 2052 5353         Total RSS
+00001ef0: 206d 656d 6f72 7920 6d65 6173 7572 6564   memory measured
+00001f00: 2062 7920 7468 6520 4f53 206f 6e20 7468   by the OS on th
+00001f10: 6520 776f 726b 6572 2070 726f 6365 7373  e worker process
+00001f20: 2e0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
+00001f30: 7320 616c 7761 7973 2065 7861 6374 6c79  s always exactly
+00001f40: 2065 7175 616c 2074 6f20 6d61 6e61 6765   equal to manage
+00001f50: 6420 2b20 756e 6d61 6e61 6765 642e 0a0a  d + unmanaged...
+00001f60: 2020 2020 756e 6d61 6e61 6765 640a 2020      unmanaged.  
+00001f70: 2020 2020 2020 7072 6f63 6573 7320 2d20        process - 
+00001f80: 6d61 6e61 6765 642e 2054 6869 7320 6973  managed. This is
+00001f90: 2074 6865 2073 756d 206f 660a 0a20 2020   the sum of..   
+00001fa0: 2020 2020 202d 2050 7974 686f 6e20 696e       - Python in
+00001fb0: 7465 7270 7265 7465 7220 616e 6420 6d6f  terpreter and mo
+00001fc0: 6475 6c65 730a 2020 2020 2020 2020 2d20  dules.        - 
+00001fd0: 676c 6f62 616c 2076 6172 6961 626c 6573  global variables
+00001fe0: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
+00001ff0: 7920 7465 6d70 6f72 6172 696c 7920 616c  y temporarily al
+00002000: 6c6f 6361 7465 6420 6279 2074 6865 2064  located by the d
+00002010: 6173 6b20 7461 736b 7320 7468 6174 2061  ask tasks that a
+00002020: 7265 2063 7572 7265 6e74 6c79 2072 756e  re currently run
+00002030: 6e69 6e67 0a20 2020 2020 2020 202d 206d  ning.        - m
+00002040: 656d 6f72 7920 6672 6167 6d65 6e74 6174  emory fragmentat
+00002050: 696f 6e0a 2020 2020 2020 2020 2d20 6d65  ion.        - me
+00002060: 6d6f 7279 206c 6561 6b73 0a20 2020 2020  mory leaks.     
+00002070: 2020 202d 206d 656d 6f72 7920 6e6f 7420     - memory not 
+00002080: 7965 7420 6761 7262 6167 6520 636f 6c6c  yet garbage coll
+00002090: 6563 7465 640a 2020 2020 2020 2020 2d20  ected.        - 
+000020a0: 6d65 6d6f 7279 206e 6f74 2079 6574 2066  memory not yet f
+000020b0: 7265 6528 2927 6420 6279 2074 6865 2050  ree()'d by the P
+000020c0: 7974 686f 6e20 6d65 6d6f 7279 206d 616e  ython memory man
+000020d0: 6167 6572 2074 6f20 7468 6520 4f53 0a0a  ager to the OS..
+000020e0: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
+000020f0: 640a 2020 2020 2020 2020 4d69 6e69 6d75  d.        Minimu
+00002100: 6d20 6f66 2074 6865 2027 756e 6d61 6e61  m of the 'unmana
+00002110: 6765 6427 206d 6561 7375 7265 7320 6f76  ged' measures ov
+00002120: 6572 2074 6865 206c 6173 740a 2020 2020  er the last.    
+00002130: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
+00002140: 642e 6d65 6d6f 7279 2e72 6563 656e 742d  d.memory.recent-
+00002150: 746f 2d6f 6c64 2d74 696d 6560 6020 7365  to-old-time`` se
+00002160: 636f 6e64 730a 0a20 2020 2075 6e6d 616e  conds..    unman
+00002170: 6167 6564 5f72 6563 656e 740a 2020 2020  aged_recent.    
+00002180: 2020 2020 756e 6d61 6e61 6765 6420 2d20      unmanaged - 
+00002190: 756e 6d61 6e61 6765 645f 6f6c 643b 2069  unmanaged_old; i
+000021a0: 6e20 6f74 6865 7220 776f 7264 7320 7072  n other words pr
+000021b0: 6f63 6573 7320 6d65 6d6f 7279 2074 6861  ocess memory tha
+000021c0: 7420 6861 7320 6265 656e 2072 6563 656e  t has been recen
+000021d0: 746c 790a 2020 2020 2020 2020 616c 6c6f  tly.        allo
+000021e0: 6361 7465 6420 6275 7420 6973 206e 6f74  cated but is not
+000021f0: 2061 6363 6f75 6e74 6564 2066 6f72 2062   accounted for b
+00002200: 7920 6461 736b 3b20 686f 7065 6675 6c6c  y dask; hopefull
+00002210: 7920 6974 2773 206d 6f73 746c 7920 6120  y it's mostly a 
+00002220: 7465 6d70 6f72 6172 790a 2020 2020 2020  temporary.      
+00002230: 2020 7370 696b 652e 0a0a 2020 2020 6f70    spike...    op
+00002240: 7469 6d69 7374 6963 0a20 2020 2020 2020  timistic.       
+00002250: 206d 616e 6167 6564 202b 2075 6e6d 616e   managed + unman
+00002260: 6167 6564 5f6f 6c64 3b20 696e 206f 7468  aged_old; in oth
+00002270: 6572 2077 6f72 6473 2074 6865 206d 656d  er words the mem
+00002280: 6f72 7920 6865 6c64 206c 6f6e 672d 7465  ory held long-te
+00002290: 726d 2062 790a 2020 2020 2020 2020 7468  rm by.        th
+000022a0: 6520 7072 6f63 6573 7320 756e 6465 7220  e process under 
+000022b0: 7468 6520 686f 7065 6675 6c20 6173 7375  the hopeful assu
+000022c0: 6d70 7469 6f6e 2074 6861 7420 616c 6c20  mption that all 
+000022d0: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+000022e0: 206d 656d 6f72 7920 6973 2061 0a20 2020   memory is a.   
+000022f0: 2020 2020 2074 656d 706f 7261 7279 2073       temporary s
+00002300: 7069 6b65 0a20 2020 2022 2222 0a0a 2020  pike.    """..  
+00002310: 2020 7072 6f63 6573 733a 2069 6e74 0a20    process: int. 
+00002320: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
+00002330: 3a20 696e 740a 2020 2020 6d61 6e61 6765  : int.    manage
+00002340: 643a 2069 6e74 0a20 2020 2073 7069 6c6c  d: int.    spill
+00002350: 6564 3a20 696e 740a 0a20 2020 205f 5f73  ed: int..    __s
+00002360: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+00002370: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+00002380: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00002390: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+000023a0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+000023b0: 2020 2020 7072 6f63 6573 733a 2069 6e74      process: int
+000023c0: 2c0a 2020 2020 2020 2020 756e 6d61 6e61  ,.        unmana
+000023d0: 6765 645f 6f6c 643a 2069 6e74 2c0a 2020  ged_old: int,.  
+000023e0: 2020 2020 2020 6d61 6e61 6765 643a 2069        managed: i
+000023f0: 6e74 2c0a 2020 2020 2020 2020 7370 696c  nt,.        spil
+00002400: 6c65 643a 2069 6e74 2c0a 2020 2020 293a  led: int,.    ):
+00002410: 0a20 2020 2020 2020 2023 2053 6f6d 6520  .        # Some 
+00002420: 6461 7461 2061 7272 6976 6573 2077 6974  data arrives wit
+00002430: 6820 7468 6520 6865 6172 7462 6561 742c  h the heartbeat,
+00002440: 2073 6f6d 6520 6f74 6865 7220 6172 7269   some other arri
+00002450: 7665 7320 696e 2072 6561 6c74 696d 6520  ves in realtime 
+00002460: 6173 2074 6865 0a20 2020 2020 2020 2023  as the.        #
+00002470: 2074 6173 6b73 2070 726f 6772 6573 732e   tasks progress.
+00002480: 2041 6c73 6f2c 2073 697a 656f 6628 2920   Also, sizeof() 
+00002490: 6973 206e 6f74 2067 7561 7261 6e74 6565  is not guarantee
+000024a0: 6420 746f 2072 6574 7572 6e20 636f 7272  d to return corr
+000024b0: 6563 7420 7265 7375 6c74 732e 0a20 2020  ect results..   
+000024c0: 2020 2020 2023 2054 6869 7320 6361 6e20       # This can 
+000024d0: 6361 7573 6520 676c 6974 6368 6573 2077  cause glitches w
+000024e0: 6865 7265 2061 2070 6172 7469 616c 206d  here a partial m
+000024f0: 6561 7375 7265 2069 7320 6c61 7267 6572  easure is larger
+00002500: 2074 6861 6e20 7468 6520 7768 6f6c 652c   than the whole,
+00002510: 2073 6f0a 2020 2020 2020 2020 2320 7765   so.        # we
+00002520: 206e 6565 6420 746f 2066 6f72 6365 2061   need to force a
+00002530: 6c6c 206e 756d 6265 7273 2074 6f20 6164  ll numbers to ad
+00002540: 6420 7570 2065 7861 6374 6c79 2062 7920  d up exactly by 
+00002550: 6465 6669 6e69 7469 6f6e 2e0a 2020 2020  definition..    
+00002560: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
+00002570: 203d 2070 726f 6365 7373 0a20 2020 2020   = process.     
+00002580: 2020 2073 656c 662e 6d61 6e61 6765 6420     self.managed 
+00002590: 3d20 6d69 6e28 7365 6c66 2e70 726f 6365  = min(self.proce
+000025a0: 7373 2c20 6d61 6e61 6765 6429 0a20 2020  ss, managed).   
+000025b0: 2020 2020 2073 656c 662e 7370 696c 6c65       self.spille
+000025c0: 6420 3d20 7370 696c 6c65 640a 2020 2020  d = spilled.    
+000025d0: 2020 2020 2320 5375 6274 7261 6374 696f      # Subtractio
+000025e0: 6e73 2062 6574 7765 656e 2075 6e73 6967  ns between unsig
+000025f0: 6e65 6420 696e 7473 2067 7561 7261 6e74  ned ints guarant
+00002600: 6565 6420 6279 2063 6f6e 7374 7275 6374  eed by construct
+00002610: 696f 6e20 746f 2062 6520 3e3d 2030 0a20  ion to be >= 0. 
+00002620: 2020 2020 2020 2073 656c 662e 756e 6d61         self.unma
+00002630: 6e61 6765 645f 6f6c 6420 3d20 6d69 6e28  naged_old = min(
+00002640: 756e 6d61 6e61 6765 645f 6f6c 642c 2070  unmanaged_old, p
+00002650: 726f 6365 7373 202d 2073 656c 662e 6d61  rocess - self.ma
+00002660: 6e61 6765 6429 0a0a 2020 2020 4073 7461  naged)..    @sta
+00002670: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00002680: 6620 7375 6d28 2a69 6e66 6f73 3a20 4d65  f sum(*infos: Me
+00002690: 6d6f 7279 5374 6174 6529 202d 3e20 4d65  moryState) -> Me
+000026a0: 6d6f 7279 5374 6174 653a 0a20 2020 2020  moryState:.     
+000026b0: 2020 2070 726f 6365 7373 203d 2030 0a20     process = 0. 
+000026c0: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
+000026d0: 5f6f 6c64 203d 2030 0a20 2020 2020 2020  _old = 0.       
+000026e0: 206d 616e 6167 6564 203d 2030 0a20 2020   managed = 0.   
+000026f0: 2020 2020 2073 7069 6c6c 6564 203d 2030       spilled = 0
+00002700: 0a20 2020 2020 2020 2066 6f72 206d 7320  .        for ms 
+00002710: 696e 2069 6e66 6f73 3a0a 2020 2020 2020  in infos:.      
+00002720: 2020 2020 2020 7072 6f63 6573 7320 2b3d        process +=
+00002730: 206d 732e 7072 6f63 6573 730a 2020 2020   ms.process.    
+00002740: 2020 2020 2020 2020 756e 6d61 6e61 6765          unmanage
+00002750: 645f 6f6c 6420 2b3d 206d 732e 756e 6d61  d_old += ms.unma
+00002760: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
+00002770: 2020 2020 2020 7370 696c 6c65 6420 2b3d        spilled +=
+00002780: 206d 732e 7370 696c 6c65 640a 2020 2020   ms.spilled.    
+00002790: 2020 2020 2020 2020 6d61 6e61 6765 6420          managed 
+000027a0: 2b3d 206d 732e 6d61 6e61 6765 640a 2020  += ms.managed.  
+000027b0: 2020 2020 2020 7265 7475 726e 204d 656d        return Mem
+000027c0: 6f72 7953 7461 7465 280a 2020 2020 2020  oryState(.      
+000027d0: 2020 2020 2020 7072 6f63 6573 733d 7072        process=pr
+000027e0: 6f63 6573 732c 0a20 2020 2020 2020 2020  ocess,.         
+000027f0: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
+00002800: 3d75 6e6d 616e 6167 6564 5f6f 6c64 2c0a  =unmanaged_old,.
+00002810: 2020 2020 2020 2020 2020 2020 6d61 6e61              mana
+00002820: 6765 643d 6d61 6e61 6765 642c 0a20 2020  ged=managed,.   
+00002830: 2020 2020 2020 2020 2073 7069 6c6c 6564           spilled
+00002840: 3d73 7069 6c6c 6564 2c0a 2020 2020 2020  =spilled,.      
+00002850: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
+00002860: 7479 0a20 2020 2064 6566 206d 616e 6167  ty.    def manag
+00002870: 6564 5f74 6f74 616c 2873 656c 6629 202d  ed_total(self) -
+00002880: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+00002890: 6574 7572 6e20 7365 6c66 2e6d 616e 6167  eturn self.manag
+000028a0: 6564 202b 2073 656c 662e 7370 696c 6c65  ed + self.spille
+000028b0: 640a 0a20 2020 2040 7072 6f70 6572 7479  d..    @property
+000028c0: 0a20 2020 2064 6566 2075 6e6d 616e 6167  .    def unmanag
+000028d0: 6564 2873 656c 6629 202d 3e20 696e 743a  ed(self) -> int:
+000028e0: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+000028f0: 6973 206e 6576 6572 206e 6567 6174 6976  is never negativ
+00002900: 6520 7468 616e 6b73 2074 6f20 5f5f 696e  e thanks to __in
+00002910: 6974 5f5f 0a20 2020 2020 2020 2072 6574  it__.        ret
+00002920: 7572 6e20 7365 6c66 2e70 726f 6365 7373  urn self.process
+00002930: 202d 2073 656c 662e 6d61 6e61 6765 640a   - self.managed.
+00002940: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00002950: 2020 2064 6566 2075 6e6d 616e 6167 6564     def unmanaged
+00002960: 5f72 6563 656e 7428 7365 6c66 2920 2d3e  _recent(self) ->
+00002970: 2069 6e74 3a0a 2020 2020 2020 2020 2320   int:.        # 
+00002980: 5468 6973 2069 7320 6e65 7665 7220 6e65  This is never ne
+00002990: 6761 7469 7665 2074 6861 6e6b 7320 746f  gative thanks to
+000029a0: 205f 5f69 6e69 745f 5f0a 2020 2020 2020   __init__.      
+000029b0: 2020 7265 7475 726e 2073 656c 662e 7072    return self.pr
+000029c0: 6f63 6573 7320 2d20 7365 6c66 2e6d 616e  ocess - self.man
+000029d0: 6167 6564 202d 2073 656c 662e 756e 6d61  aged - self.unma
+000029e0: 6e61 6765 645f 6f6c 640a 0a20 2020 2040  naged_old..    @
+000029f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00002a00: 206f 7074 696d 6973 7469 6328 7365 6c66   optimistic(self
+00002a10: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+00002a20: 2020 7265 7475 726e 2073 656c 662e 6d61    return self.ma
+00002a30: 6e61 6765 6420 2b20 7365 6c66 2e75 6e6d  naged + self.unm
+00002a40: 616e 6167 6564 5f6f 6c64 0a0a 2020 2020  anaged_old..    
+00002a50: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00002a60: 6620 6d61 6e61 6765 645f 696e 5f6d 656d  f managed_in_mem
+00002a70: 6f72 7928 7365 6c66 2920 2d3e 2069 6e74  ory(self) -> int
+00002a80: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+00002a90: 6773 2e77 6172 6e28 226d 616e 6167 6564  gs.warn("managed
+00002aa0: 5f69 6e5f 6d65 6d6f 7279 2068 6173 2062  _in_memory has b
+00002ab0: 6565 6e20 7265 6e61 6d65 6420 746f 206d  een renamed to m
+00002ac0: 616e 6167 6564 222c 2046 7574 7572 6557  anaged", FutureW
+00002ad0: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
+00002ae0: 7265 7475 726e 2073 656c 662e 6d61 6e61  return self.mana
+00002af0: 6765 640a 0a20 2020 2040 7072 6f70 6572  ged..    @proper
+00002b00: 7479 0a20 2020 2064 6566 206d 616e 6167  ty.    def manag
+00002b10: 6564 5f73 7069 6c6c 6564 2873 656c 6629  ed_spilled(self)
+00002b20: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+00002b30: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
+00002b40: 6d61 6e61 6765 645f 7370 696c 6c65 6420  managed_spilled 
+00002b50: 6861 7320 6265 656e 2072 656e 616d 6564  has been renamed
+00002b60: 2074 6f20 7370 696c 6c65 6422 2c20 4675   to spilled", Fu
+00002b70: 7475 7265 5761 726e 696e 6729 0a20 2020  tureWarning).   
+00002b80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00002b90: 2e73 7069 6c6c 6564 0a0a 2020 2020 6465  .spilled..    de
+00002ba0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00002bb0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00002bc0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
+00002bd0: 2020 2020 2020 6622 5072 6f63 6573 7320        f"Process 
+00002be0: 6d65 6d6f 7279 2028 5253 5329 2020 3a20  memory (RSS)  : 
+00002bf0: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
+00002c00: 6c66 2e70 726f 6365 7373 297d 5c6e 220a  lf.process)}\n".
+00002c10: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
+00002c20: 2d20 6d61 6e61 6765 6420 6279 2044 6173  - managed by Das
+00002c30: 6b20 2020 3a20 7b66 6f72 6d61 745f 6279  k   : {format_by
+00002c40: 7465 7328 7365 6c66 2e6d 616e 6167 6564  tes(self.managed
+00002c50: 297d 5c6e 220a 2020 2020 2020 2020 2020  )}\n".          
+00002c60: 2020 6622 2020 2d20 756e 6d61 6e61 6765    f"  - unmanage
+00002c70: 6420 286f 6c64 2920 2020 3a20 7b66 6f72  d (old)   : {for
+00002c80: 6d61 745f 6279 7465 7328 7365 6c66 2e75  mat_bytes(self.u
+00002c90: 6e6d 616e 6167 6564 5f6f 6c64 297d 5c6e  nmanaged_old)}\n
+00002ca0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00002cb0: 2020 2d20 756e 6d61 6e61 6765 6420 2872    - unmanaged (r
+00002cc0: 6563 656e 7429 3a20 7b66 6f72 6d61 745f  ecent): {format_
+00002cd0: 6279 7465 7328 7365 6c66 2e75 6e6d 616e  bytes(self.unman
+00002ce0: 6167 6564 5f72 6563 656e 7429 7d5c 6e22  aged_recent)}\n"
+00002cf0: 0a20 2020 2020 2020 2020 2020 2066 2253  .            f"S
+00002d00: 7069 6c6c 6564 2074 6f20 6469 736b 2020  pilled to disk  
+00002d10: 2020 2020 203a 207b 666f 726d 6174 5f62       : {format_b
+00002d20: 7974 6573 2873 656c 662e 7370 696c 6c65  ytes(self.spille
+00002d30: 6429 7d5c 6e22 0a20 2020 2020 2020 2029  d)}\n".        )
+00002d40: 0a0a 2020 2020 6465 6620 5f74 6f5f 6469  ..    def _to_di
+00002d50: 6374 2873 656c 662c 202a 2c20 6578 636c  ct(self, *, excl
+00002d60: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
+00002d70: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
+00002d80: 743a 0a20 2020 2020 2020 2022 2222 4469  t:.        """Di
+00002d90: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
+00002da0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
+00002db0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
+00002dc0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+00002dd0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+00002de0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
+00002df0: 742e 6475 6d70 5f63 6c75 7374 6572 5f73  t.dump_cluster_s
+00002e00: 7461 7465 0a20 2020 2020 2020 2064 6973  tate.        dis
+00002e10: 7472 6962 7574 6564 2e75 7469 6c73 2e72  tributed.utils.r
+00002e20: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
+00002e30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00002e40: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+00002e50: 2020 2020 2020 2020 2020 6b3a 2067 6574            k: get
+00002e60: 6174 7472 2873 656c 662c 206b 290a 2020  attr(self, k).  
+00002e70: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
+00002e80: 696e 2064 6972 2873 656c 6629 0a20 2020  in dir(self).   
+00002e90: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00002ea0: 6b2e 7374 6172 7473 7769 7468 2822 5f22  k.startswith("_"
+00002eb0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
+00002ec0: 6420 6b20 6e6f 7420 696e 207b 2273 756d  d k not in {"sum
+00002ed0: 222c 2022 6d61 6e61 6765 645f 696e 5f6d  ", "managed_in_m
+00002ee0: 656d 6f72 7922 2c20 226d 616e 6167 6564  emory", "managed
+00002ef0: 5f73 7069 6c6c 6564 227d 0a20 2020 2020  _spilled"}.     
+00002f00: 2020 207d 0a0a 0a63 6c61 7373 2057 6f72     }...class Wor
+00002f10: 6b65 7253 7461 7465 3a0a 2020 2020 2222  kerState:.    ""
+00002f20: 2241 2073 696d 706c 6520 6f62 6a65 6374  "A simple object
+00002f30: 2068 6f6c 6469 6e67 2069 6e66 6f72 6d61   holding informa
+00002f40: 7469 6f6e 2061 626f 7574 2061 2077 6f72  tion about a wor
+00002f50: 6b65 722e 0a0a 2020 2020 4e6f 7420 746f  ker...    Not to
+00002f60: 2062 6520 636f 6e66 7573 6564 2077 6974   be confused wit
+00002f70: 6820 3a63 6c61 7373 3a60 6469 7374 7269  h :class:`distri
+00002f80: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00002f90: 7465 5f6d 6163 6869 6e65 2e57 6f72 6b65  te_machine.Worke
+00002fa0: 7253 7461 7465 602e 0a20 2020 2022 2222  rState`..    """
+00002fb0: 0a0a 2020 2020 233a 2054 6869 7320 776f  ..    #: This wo
+00002fc0: 726b 6572 2773 2075 6e69 7175 6520 6b65  rker's unique ke
+00002fd0: 792e 2054 6869 7320 6361 6e20 6265 2069  y. This can be i
+00002fe0: 7473 2063 6f6e 6e65 6374 6564 2061 6464  ts connected add
+00002ff0: 7265 7373 0a20 2020 2023 3a20 2873 7563  ress.    #: (suc
+00003000: 6820 6173 2060 6022 7463 703a 2f2f 3132  h as ``"tcp://12
+00003010: 372e 302e 302e 313a 3838 3931 2260 6029  7.0.0.1:8891"``)
+00003020: 206f 7220 616e 2061 6c69 6173 2028 7375   or an alias (su
+00003030: 6368 2061 7320 6060 2261 6c69 6365 2260  ch as ``"alice"`
+00003040: 6029 2e0a 2020 2020 6164 6472 6573 733a  `)..    address:
+00003050: 2073 7472 0a0a 2020 2020 7069 643a 2069   str..    pid: i
+00003060: 6e74 0a20 2020 206e 616d 653a 2048 6173  nt.    name: Has
+00003070: 6861 626c 650a 0a20 2020 2023 3a20 5468  hable..    #: Th
+00003080: 6520 6e75 6d62 6572 206f 6620 4350 5520  e number of CPU 
+00003090: 7468 7265 6164 7320 6d61 6465 2061 7661  threads made ava
+000030a0: 696c 6162 6c65 206f 6e20 7468 6973 2077  ilable on this w
+000030b0: 6f72 6b65 720a 2020 2020 6e74 6872 6561  orker.    nthrea
+000030c0: 6473 3a20 696e 740a 0a20 2020 2023 3a20  ds: int..    #: 
+000030d0: 4d65 6d6f 7279 2061 7661 696c 6162 6c65  Memory available
+000030e0: 2074 6f20 7468 6520 776f 726b 6572 2c20   to the worker, 
+000030f0: 696e 2062 7974 6573 0a20 2020 206d 656d  in bytes.    mem
+00003100: 6f72 795f 6c69 6d69 743a 2069 6e74 0a0a  ory_limit: int..
+00003110: 2020 2020 6c6f 6361 6c5f 6469 7265 6374      local_direct
+00003120: 6f72 793a 2073 7472 0a20 2020 2073 6572  ory: str.    ser
+00003130: 7669 6365 733a 2064 6963 745b 7374 722c  vices: dict[str,
+00003140: 2069 6e74 5d0a 0a20 2020 2023 3a20 4f75   int]..    #: Ou
+00003150: 7470 7574 206f 6620 3a6d 6574 683a 6064  tput of :meth:`d
+00003160: 6973 7472 6962 7574 6564 2e76 6572 7369  istributed.versi
+00003170: 6f6e 732e 6765 745f 7665 7273 696f 6e73  ons.get_versions
+00003180: 6020 6f6e 2074 6865 2077 6f72 6b65 720a  ` on the worker.
+00003190: 2020 2020 7665 7273 696f 6e73 3a20 6469      versions: di
+000031a0: 6374 5b73 7472 2c20 416e 795d 0a0a 2020  ct[str, Any]..  
+000031b0: 2020 233a 2041 6464 7265 7373 206f 6620    #: Address of 
+000031c0: 7468 6520 6173 736f 6369 6174 6564 203a  the associated :
+000031d0: 636c 6173 733a 607e 6469 7374 7269 6275  class:`~distribu
+000031e0: 7465 642e 6e61 6e6e 792e 4e61 6e6e 7960  ted.nanny.Nanny`
+000031f0: 2c20 6966 2070 7265 7365 6e74 0a20 2020  , if present.   
+00003200: 206e 616e 6e79 3a20 7374 720a 0a20 2020   nanny: str..   
+00003210: 2023 3a20 5265 6164 2d6f 6e6c 7920 776f   #: Read-only wo
+00003220: 726b 6572 2073 7461 7475 732c 2073 796e  rker status, syn
+00003230: 6365 6420 6f6e 6520 7761 7920 6672 6f6d  ced one way from
+00003240: 2074 6865 2072 656d 6f74 6520 576f 726b   the remote Work
+00003250: 6572 206f 626a 6563 740a 2020 2020 7374  er object.    st
+00003260: 6174 7573 3a20 5374 6174 7573 0a0a 2020  atus: Status..  
+00003270: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
+00003280: 206f 6620 3a61 7474 723a 607e 576f 726b   of :attr:`~Work
+00003290: 6572 5374 6174 652e 6164 6472 6573 7360  erState.address`
+000032a0: 0a20 2020 205f 6861 7368 3a20 696e 740a  .    _hash: int.
+000032b0: 0a20 2020 2023 3a20 5468 6520 746f 7461  .    #: The tota
+000032c0: 6c20 6d65 6d6f 7279 2073 697a 652c 2069  l memory size, i
+000032d0: 6e20 6279 7465 732c 2075 7365 6420 6279  n bytes, used by
+000032e0: 2074 6865 2074 6173 6b73 2074 6869 7320   the tasks this 
+000032f0: 776f 726b 6572 2068 6f6c 6473 2069 6e20  worker holds in 
+00003300: 6d65 6d6f 7279 0a20 2020 2023 3a20 2869  memory.    #: (i
+00003310: 2e65 2e20 7468 6520 7461 736b 7320 696e  .e. the tasks in
+00003320: 2074 6869 7320 776f 726b 6572 2773 203a   this worker's :
+00003330: 6174 7472 3a60 7e57 6f72 6b65 7253 7461  attr:`~WorkerSta
+00003340: 7465 2e68 6173 5f77 6861 7460 292e 0a20  te.has_what`).. 
+00003350: 2020 206e 6279 7465 733a 2069 6e74 0a0a     nbytes: int..
+00003360: 2020 2020 233a 2057 6f72 6b65 7220 6d65      #: Worker me
+00003370: 6d6f 7279 2075 6e6b 6e6f 776e 2074 6f20  mory unknown to 
+00003380: 7468 6520 776f 726b 6572 2c20 696e 2062  the worker, in b
+00003390: 7974 6573 2c20 7768 6963 6820 6861 7320  ytes, which has 
+000033a0: 6265 656e 2074 6865 7265 2066 6f72 206d  been there for m
+000033b0: 6f72 6520 7468 616e 0a20 2020 2023 3a20  ore than.    #: 
+000033c0: 3330 2073 6563 6f6e 6473 2e20 5365 6520  30 seconds. See 
+000033d0: 3a63 6c61 7373 3a60 4d65 6d6f 7279 5374  :class:`MemorySt
+000033e0: 6174 6560 2e0a 2020 2020 5f6d 656d 6f72  ate`..    _memor
+000033f0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
+00003400: 2069 6e74 0a0a 2020 2020 233a 2048 6973   int..    #: His
+00003410: 746f 7279 206f 6620 7468 6520 6c61 7374  tory of the last
+00003420: 2033 3020 7365 636f 6e64 7327 2077 6f72   30 seconds' wor
+00003430: 7468 206f 6620 756e 6d61 6e61 6765 6420  th of unmanaged 
+00003440: 6d65 6d6f 7279 2e20 5573 6564 2074 6f20  memory. Used to 
+00003450: 6469 6666 6572 656e 7469 6174 650a 2020  differentiate.  
+00003460: 2020 233a 2062 6574 7765 656e 2022 6f6c    #: between "ol
+00003470: 6422 2061 6e64 2022 6e65 7722 2075 6e6d  d" and "new" unm
+00003480: 616e 6167 6564 206d 656d 6f72 792e 0a20  anaged memory.. 
+00003490: 2020 2023 3a20 466f 726d 6174 3a20 6060     #: Format: ``
+000034a0: 5b28 7469 6d65 7374 616d 702c 2062 7974  [(timestamp, byt
+000034b0: 6573 292c 2028 7469 6d65 7374 616d 702c  es), (timestamp,
+000034c0: 2062 7974 6573 292c 202e 2e2e 5d60 600a   bytes), ...]``.
+000034d0: 2020 2020 5f6d 656d 6f72 795f 756e 6d61      _memory_unma
+000034e0: 6e61 6765 645f 6869 7374 6f72 793a 2064  naged_history: d
+000034f0: 6571 7565 5b74 7570 6c65 5b66 6c6f 6174  eque[tuple[float
+00003500: 2c20 696e 745d 5d0a 0a20 2020 206d 6574  , int]]..    met
+00003510: 7269 6373 3a20 6469 6374 5b73 7472 2c20  rics: dict[str, 
+00003520: 416e 795d 0a0a 2020 2020 233a 2054 6865  Any]..    #: The
+00003530: 206c 6173 7420 7469 6d65 2077 6520 7265   last time we re
+00003540: 6365 6976 6564 2061 2068 6561 7274 6265  ceived a heartbe
+00003550: 6174 2066 726f 6d20 7468 6973 2077 6f72  at from this wor
+00003560: 6b65 722c 2069 6e20 6c6f 6361 6c20 7363  ker, in local sc
+00003570: 6865 6475 6c65 7220 7469 6d65 2e0a 2020  heduler time..  
+00003580: 2020 6c61 7374 5f73 6565 6e3a 2066 6c6f    last_seen: flo
+00003590: 6174 0a0a 2020 2020 7469 6d65 5f64 656c  at..    time_del
+000035a0: 6179 3a20 666c 6f61 740a 2020 2020 6261  ay: float.    ba
+000035b0: 6e64 7769 6474 683a 2066 6c6f 6174 0a0a  ndwidth: float..
+000035c0: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
+000035d0: 616c 6c20 5461 736b 5374 6174 6573 206f  all TaskStates o
+000035e0: 6e20 7468 6973 2077 6f72 6b65 7220 7468  n this worker th
+000035f0: 6174 2061 7265 2061 6374 6f72 732e 2054  at are actors. T
+00003600: 6869 7320 6f6e 6c79 2069 6e63 6c75 6465  his only include
+00003610: 7320 7468 6f73 650a 2020 2020 233a 2061  s those.    #: a
+00003620: 6374 6f72 7320 7768 6f73 6520 7374 6174  ctors whose stat
+00003630: 6520 6163 7475 616c 6c79 206c 6976 6573  e actually lives
+00003640: 206f 6e20 7468 6973 2077 6f72 6b65 722c   on this worker,
+00003650: 206e 6f74 2061 6374 6f72 7320 746f 2077   not actors to w
+00003660: 6869 6368 2074 6869 7320 776f 726b 6572  hich this worker
+00003670: 0a20 2020 2023 3a20 6861 7320 6120 7265  .    #: has a re
+00003680: 6665 7265 6e63 652e 0a20 2020 2061 6374  ference..    act
+00003690: 6f72 733a 2073 6574 5b54 6173 6b53 7461  ors: set[TaskSta
+000036a0: 7465 5d0a 0a20 2020 2023 3a20 556e 6465  te]..    #: Unde
+000036b0: 726c 7969 6e67 2064 6174 6120 6f66 203a  rlying data of :
+000036c0: 6d65 7468 3a60 576f 726b 6572 5374 6174  meth:`WorkerStat
+000036d0: 652e 6861 735f 7768 6174 600a 2020 2020  e.has_what`.    
+000036e0: 5f68 6173 5f77 6861 743a 2064 6963 745b  _has_what: dict[
+000036f0: 5461 736b 5374 6174 652c 204e 6f6e 655d  TaskState, None]
+00003700: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+00003710: 6620 7461 736b 7320 7468 6174 2068 6176  f tasks that hav
+00003720: 6520 6265 656e 2073 7562 6d69 7474 6564  e been submitted
+00003730: 2074 6f20 7468 6973 2077 6f72 6b65 722e   to this worker.
+00003740: 204d 756c 7469 706c 6520 7461 736b 7320   Multiple tasks 
+00003750: 6d61 7920 6265 0a20 2020 2023 2073 7562  may be.    # sub
+00003760: 6d69 7474 6564 2074 6f20 6120 776f 726b  mitted to a work
+00003770: 6572 2069 6e20 6164 7661 6e63 6520 616e  er in advance an
+00003780: 6420 7468 6520 776f 726b 6572 2077 696c  d the worker wil
+00003790: 6c20 7275 6e20 7468 656d 2065 7665 6e74  l run them event
+000037a0: 7561 6c6c 792c 0a20 2020 2023 2064 6570  ually,.    # dep
+000037b0: 656e 6469 6e67 206f 6e20 6974 7320 6578  ending on its ex
+000037c0: 6563 7574 696f 6e20 7265 736f 7572 6365  ecution resource
+000037d0: 7320 2862 7574 2073 6565 203a 646f 633a  s (but see :doc:
+000037e0: 6077 6f72 6b2d 7374 6561 6c69 6e67 6029  `work-stealing`)
+000037f0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+00003800: 416c 6c20 7468 6520 7461 736b 7320 6865  All the tasks he
+00003810: 7265 2061 7265 2069 6e20 7468 6520 2270  re are in the "p
+00003820: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
+00003830: 2e0a 2020 2020 233a 2054 6869 7320 6174  ..    #: This at
+00003840: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
+00003850: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
+00003860: 7472 3a60 5461 736b 5374 6174 652e 7072  tr:`TaskState.pr
+00003870: 6f63 6573 7369 6e67 5f6f 6e60 2e0a 2020  ocessing_on`..  
+00003880: 2020 7072 6f63 6573 7369 6e67 3a20 7365    processing: se
+00003890: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+000038a0: 2020 233a 2052 756e 6e69 6e67 2074 6173    #: Running tas
+000038b0: 6b73 2074 6861 7420 696e 766f 6b65 6420  ks that invoked 
+000038c0: 3a66 756e 633a 6064 6973 7472 6962 7574  :func:`distribut
+000038d0: 6564 2e73 6563 6564 6560 0a20 2020 206c  ed.secede`.    l
+000038e0: 6f6e 675f 7275 6e6e 696e 673a 2073 6574  ong_running: set
+000038f0: 5b54 6173 6b53 7461 7465 5d0a 0a20 2020  [TaskState]..   
+00003900: 2023 3a20 4120 6469 6374 696f 6e61 7279   #: A dictionary
+00003910: 206f 6620 7461 736b 7320 7468 6174 2061   of tasks that a
+00003920: 7265 2063 7572 7265 6e74 6c79 2062 6569  re currently bei
+00003930: 6e67 2072 756e 206f 6e20 7468 6973 2077  ng run on this w
+00003940: 6f72 6b65 722e 0a20 2020 2023 3a20 4561  orker..    #: Ea
+00003950: 6368 2074 6173 6b20 7374 6174 6520 6973  ch task state is
+00003960: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
+00003970: 2074 6865 2064 7572 6174 696f 6e20 696e   the duration in
+00003980: 2073 6563 6f6e 6473 2077 6869 6368 2074   seconds which t
+00003990: 6865 2074 6173 6b20 6861 730a 2020 2020  he task has.    
+000039a0: 233a 2062 6565 6e20 7275 6e6e 696e 672e  #: been running.
+000039b0: 0a20 2020 2065 7865 6375 7469 6e67 3a20  .    executing: 
+000039c0: 6469 6374 5b54 6173 6b53 7461 7465 2c20  dict[TaskState, 
+000039d0: 666c 6f61 745d 0a0a 2020 2020 233a 2054  float]..    #: T
+000039e0: 6865 2061 7661 696c 6162 6c65 2072 6573  he available res
+000039f0: 6f75 7263 6573 206f 6e20 7468 6973 2077  ources on this w
+00003a00: 6f72 6b65 722c 2065 2e67 2e20 6060 7b22  orker, e.g. ``{"
+00003a10: 4750 5522 3a20 327d 6060 2e0a 2020 2020  GPU": 2}``..    
+00003a20: 233a 2054 6865 7365 2061 7265 2061 6273  #: These are abs
+00003a30: 7472 6163 7420 7175 616e 7469 7469 6573  tract quantities
+00003a40: 2074 6861 7420 636f 6e73 7472 6169 6e20   that constrain 
+00003a50: 6365 7274 6169 6e20 7461 736b 7320 6672  certain tasks fr
+00003a60: 6f6d 2072 756e 6e69 6e67 2061 7420 7468  om running at th
+00003a70: 650a 2020 2020 233a 2073 616d 6520 7469  e.    #: same ti
+00003a80: 6d65 206f 6e20 7468 6973 2077 6f72 6b65  me on this worke
+00003a90: 722e 0a20 2020 2072 6573 6f75 7263 6573  r..    resources
+00003aa0: 3a20 6469 6374 5b73 7472 2c20 666c 6f61  : dict[str, floa
+00003ab0: 745d 0a0a 2020 2020 233a 2054 6865 2073  t]..    #: The s
+00003ac0: 756d 206f 6620 6561 6368 2072 6573 6f75  um of each resou
+00003ad0: 7263 6520 7573 6564 2062 7920 616c 6c20  rce used by all 
+00003ae0: 7461 736b 7320 616c 6c6f 6361 7465 6420  tasks allocated 
+00003af0: 746f 2074 6869 7320 776f 726b 6572 2e0a  to this worker..
+00003b00: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
+00003b10: 7273 2069 6e20 7468 6973 2064 6963 7469  rs in this dicti
+00003b20: 6f6e 6172 7920 6361 6e20 6f6e 6c79 2062  onary can only b
+00003b30: 6520 6c65 7373 206f 7220 6571 7561 6c20  e less or equal 
+00003b40: 7468 616e 2074 686f 7365 2069 6e20 7468  than those in th
+00003b50: 6973 0a20 2020 2023 3a20 776f 726b 6572  is.    #: worker
+00003b60: 2773 203a 6174 7472 3a60 7e57 6f72 6b65  's :attr:`~Worke
+00003b70: 7253 7461 7465 2e72 6573 6f75 7263 6573  rState.resources
+00003b80: 602e 0a20 2020 2075 7365 645f 7265 736f  `..    used_reso
+00003b90: 7572 6365 733a 2064 6963 745b 7374 722c  urces: dict[str,
+00003ba0: 2066 6c6f 6174 5d0a 0a20 2020 2023 3a20   float]..    #: 
+00003bb0: 4172 6269 7472 6172 7920 6164 6469 7469  Arbitrary additi
+00003bc0: 6f6e 616c 206d 6574 6164 6174 6120 746f  onal metadata to
+00003bd0: 2062 6520 6164 6465 6420 746f 203a 6d65   be added to :me
+00003be0: 7468 3a60 7e57 6f72 6b65 7253 7461 7465  th:`~WorkerState
+00003bf0: 2e69 6465 6e74 6974 7960 0a20 2020 2065  .identity`.    e
+00003c00: 7874 7261 3a20 6469 6374 5b73 7472 2c20  xtra: dict[str, 
+00003c10: 416e 795d 0a0a 2020 2020 2320 5468 6520  Any]..    # The 
+00003c20: 756e 6971 7565 2073 6572 7665 7220 4944  unique server ID
+00003c30: 2074 6869 7320 576f 726b 6572 5374 6174   this WorkerStat
+00003c40: 6520 6973 2072 6566 6572 656e 6369 6e67  e is referencing
+00003c50: 0a20 2020 2073 6572 7665 725f 6964 3a20  .    server_id: 
+00003c60: 7374 720a 0a20 2020 2023 2052 6566 6572  str..    # Refer
+00003c70: 656e 6365 2074 6f20 7363 6865 6475 6c65  ence to schedule
+00003c80: 7220 7461 736b 5f67 726f 7570 730a 2020  r task_groups.  
+00003c90: 2020 7363 6865 6475 6c65 725f 7265 663a    scheduler_ref:
+00003ca0: 2077 6561 6b72 6566 2e72 6566 5b53 6368   weakref.ref[Sch
+00003cb0: 6564 756c 6572 5374 6174 655d 207c 204e  edulerState] | N
+00003cc0: 6f6e 650a 2020 2020 7461 736b 5f70 7265  one.    task_pre
+00003cd0: 6669 785f 636f 756e 743a 2064 6566 6175  fix_count: defau
+00003ce0: 6c74 6469 6374 5b73 7472 2c20 696e 745d  ltdict[str, int]
+00003cf0: 0a20 2020 205f 6e65 7477 6f72 6b5f 6f63  .    _network_oc
+00003d00: 633a 2066 6c6f 6174 0a20 2020 205f 6f63  c: float.    _oc
+00003d10: 6375 7061 6e63 795f 6361 6368 653a 2066  cupancy_cache: f
+00003d20: 6c6f 6174 207c 204e 6f6e 650a 0a20 2020  loat | None..   
+00003d30: 2023 3a20 4b65 7973 2074 6861 7420 6d61   #: Keys that ma
+00003d40: 7920 6e65 6564 2074 6f20 6265 2066 6574  y need to be fet
+00003d50: 6368 6564 2074 6f20 7468 6973 2077 6f72  ched to this wor
+00003d60: 6b65 722c 2061 6e64 2074 6865 206e 756d  ker, and the num
+00003d70: 6265 7220 6f66 2074 6173 6b73 2074 6861  ber of tasks tha
+00003d80: 7420 6e65 6564 2074 6865 6d2e 0a20 2020  t need them..   
+00003d90: 2023 3a20 416c 6c20 7461 736b 7320 6172   #: All tasks ar
+00003da0: 6520 6375 7272 656e 746c 7920 696e 2060  e currently in `
+00003db0: 6d65 6d6f 7279 6020 6f6e 2061 2077 6f72  memory` on a wor
+00003dc0: 6b65 7220 6f74 6865 7220 7468 616e 2074  ker other than t
+00003dd0: 6869 7320 6f6e 652e 0a20 2020 2023 3a20  his one..    #: 
+00003de0: 4d75 6368 206c 696b 6520 6070 726f 6365  Much like `proce
+00003df0: 7373 696e 6760 2c20 7468 6973 2064 6f65  ssing`, this doe
+00003e00: 7320 6e6f 7420 6578 6163 746c 7920 7265  s not exactly re
+00003e10: 666c 6563 7420 776f 726b 6572 2073 7461  flect worker sta
+00003e20: 7465 3a0a 2020 2020 233a 206b 6579 7320  te:.    #: keys 
+00003e30: 6865 7265 206d 6179 2062 6520 7175 6575  here may be queu
+00003e40: 6564 2074 6f20 6665 7463 682c 2069 6e20  ed to fetch, in 
+00003e50: 666c 6967 6874 2c20 6f72 2061 6c72 6561  flight, or alrea
+00003e60: 6479 2069 6e20 6d65 6d6f 7279 0a20 2020  dy in memory.   
+00003e70: 2023 3a20 6f6e 2074 6865 2077 6f72 6b65   #: on the worke
+00003e80: 722e 0a20 2020 206e 6565 6473 5f77 6861  r..    needs_wha
+00003e90: 743a 2064 6963 745b 5461 736b 5374 6174  t: dict[TaskStat
+00003ea0: 652c 2069 6e74 5d0a 0a20 2020 205f 5f73  e, int]..    __s
+00003eb0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+00003ec0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+00003ed0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00003ee0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+00003ef0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00003f00: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
+00003f10: 2c0a 2020 2020 2020 2020 7374 6174 7573  ,.        status
+00003f20: 3a20 5374 6174 7573 2c0a 2020 2020 2020  : Status,.      
+00003f30: 2020 7069 643a 2069 6e74 2c0a 2020 2020    pid: int,.    
+00003f40: 2020 2020 6e61 6d65 3a20 6f62 6a65 6374      name: object
+00003f50: 2c0a 2020 2020 2020 2020 6e74 6872 6561  ,.        nthrea
+00003f60: 6473 3a20 696e 7420 3d20 302c 0a20 2020  ds: int = 0,.   
+00003f70: 2020 2020 206d 656d 6f72 795f 6c69 6d69       memory_limi
+00003f80: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
+00003f90: 6c6f 6361 6c5f 6469 7265 6374 6f72 793a  local_directory:
+00003fa0: 2073 7472 2c0a 2020 2020 2020 2020 6e61   str,.        na
+00003fb0: 6e6e 793a 2073 7472 2c0a 2020 2020 2020  nny: str,.      
+00003fc0: 2020 7365 7276 6572 5f69 643a 2073 7472    server_id: str
+00003fd0: 2c0a 2020 2020 2020 2020 7365 7276 6963  ,.        servic
+00003fe0: 6573 3a20 6469 6374 5b73 7472 2c20 696e  es: dict[str, in
+00003ff0: 745d 207c 204e 6f6e 6520 3d20 4e6f 6e65  t] | None = None
+00004000: 2c0a 2020 2020 2020 2020 7665 7273 696f  ,.        versio
+00004010: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
+00004020: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
+00004030: 2c0a 2020 2020 2020 2020 6578 7472 613a  ,.        extra:
+00004040: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
+00004050: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00004060: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00004070: 3a20 5363 6865 6475 6c65 7253 7461 7465  : SchedulerState
+00004080: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00004090: 2020 2020 293a 0a20 2020 2020 2020 2073      ):.        s
+000040a0: 656c 662e 7365 7276 6572 5f69 6420 3d20  elf.server_id = 
+000040b0: 7365 7276 6572 5f69 640a 2020 2020 2020  server_id.      
+000040c0: 2020 7365 6c66 2e61 6464 7265 7373 203d    self.address =
+000040d0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+000040e0: 2073 656c 662e 7069 6420 3d20 7069 640a   self.pid = pid.
+000040f0: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
+00004100: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
+00004110: 2073 656c 662e 6e74 6872 6561 6473 203d   self.nthreads =
+00004120: 206e 7468 7265 6164 730a 2020 2020 2020   nthreads.      
+00004130: 2020 7365 6c66 2e6d 656d 6f72 795f 6c69    self.memory_li
+00004140: 6d69 7420 3d20 6d65 6d6f 7279 5f6c 696d  mit = memory_lim
+00004150: 6974 0a20 2020 2020 2020 2073 656c 662e  it.        self.
+00004160: 6c6f 6361 6c5f 6469 7265 6374 6f72 7920  local_directory 
+00004170: 3d20 6c6f 6361 6c5f 6469 7265 6374 6f72  = local_director
+00004180: 790a 2020 2020 2020 2020 7365 6c66 2e73  y.        self.s
+00004190: 6572 7669 6365 7320 3d20 7365 7276 6963  ervices = servic
+000041a0: 6573 206f 7220 7b7d 0a20 2020 2020 2020  es or {}.       
+000041b0: 2073 656c 662e 7665 7273 696f 6e73 203d   self.versions =
+000041c0: 2076 6572 7369 6f6e 7320 6f72 207b 7d0a   versions or {}.
+000041d0: 2020 2020 2020 2020 7365 6c66 2e6e 616e          self.nan
+000041e0: 6e79 203d 206e 616e 6e79 0a20 2020 2020  ny = nanny.     
+000041f0: 2020 2073 656c 662e 7374 6174 7573 203d     self.status =
+00004200: 2073 7461 7475 730a 2020 2020 2020 2020   status.        
+00004210: 7365 6c66 2e5f 6861 7368 203d 2068 6173  self._hash = has
+00004220: 6828 7365 6c66 2e73 6572 7665 725f 6964  h(self.server_id
+00004230: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00004240: 6279 7465 7320 3d20 300a 2020 2020 2020  bytes = 0.      
+00004250: 2020 7365 6c66 2e5f 6d65 6d6f 7279 5f75    self._memory_u
+00004260: 6e6d 616e 6167 6564 5f6f 6c64 203d 2030  nmanaged_old = 0
+00004270: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
+00004280: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00004290: 6869 7374 6f72 7920 3d20 6465 7175 6528  history = deque(
+000042a0: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
+000042b0: 6574 7269 6373 203d 207b 7d0a 2020 2020  etrics = {}.    
+000042c0: 2020 2020 7365 6c66 2e6c 6173 745f 7365      self.last_se
+000042d0: 656e 203d 2030 0a20 2020 2020 2020 2073  en = 0.        s
+000042e0: 656c 662e 7469 6d65 5f64 656c 6179 203d  elf.time_delay =
+000042f0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00004300: 6261 6e64 7769 6474 6820 3d20 7061 7273  bandwidth = pars
+00004310: 655f 6279 7465 7328 6461 736b 2e63 6f6e  e_bytes(dask.con
+00004320: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+00004330: 7574 6564 2e73 6368 6564 756c 6572 2e62  uted.scheduler.b
+00004340: 616e 6477 6964 7468 2229 290a 2020 2020  andwidth")).    
+00004350: 2020 2020 7365 6c66 2e61 6374 6f72 7320      self.actors 
+00004360: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00004370: 7365 6c66 2e5f 6861 735f 7768 6174 203d  self._has_what =
+00004380: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+00004390: 2e70 726f 6365 7373 696e 6720 3d20 7365  .processing = se
+000043a0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+000043b0: 2e6c 6f6e 675f 7275 6e6e 696e 6720 3d20  .long_running = 
+000043c0: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
+000043d0: 6c66 2e65 7865 6375 7469 6e67 203d 207b  lf.executing = {
+000043e0: 7d0a 2020 2020 2020 2020 7365 6c66 2e72  }.        self.r
+000043f0: 6573 6f75 7263 6573 203d 207b 7d0a 2020  esources = {}.  
+00004400: 2020 2020 2020 7365 6c66 2e75 7365 645f        self.used_
+00004410: 7265 736f 7572 6365 7320 3d20 7b7d 0a20  resources = {}. 
+00004420: 2020 2020 2020 2073 656c 662e 6578 7472         self.extr
+00004430: 6120 3d20 6578 7472 6120 6f72 207b 7d0a  a = extra or {}.
+00004440: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00004450: 6564 756c 6572 5f72 6566 203d 2077 6561  eduler_ref = wea
+00004460: 6b72 6566 2e72 6566 2873 6368 6564 756c  kref.ref(schedul
+00004470: 6572 2920 6966 2073 6368 6564 756c 6572  er) if scheduler
+00004480: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00004490: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
+000044a0: 6669 785f 636f 756e 7420 3d20 6465 6661  fix_count = defa
+000044b0: 756c 7464 6963 7428 696e 7429 0a20 2020  ultdict(int).   
+000044c0: 2020 2020 2073 656c 662e 6e65 6564 735f       self.needs_
+000044d0: 7768 6174 203d 207b 7d0a 2020 2020 2020  what = {}.      
+000044e0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
+000044f0: 6f63 6320 3d20 300a 2020 2020 2020 2020  occ = 0.        
+00004500: 7365 6c66 2e5f 6f63 6375 7061 6e63 795f  self._occupancy_
+00004510: 6361 6368 6520 3d20 4e6f 6e65 0a0a 2020  cache = None..  
+00004520: 2020 6465 6620 5f5f 6861 7368 5f5f 2873    def __hash__(s
+00004530: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+00004540: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00004550: 2e5f 6861 7368 0a0a 2020 2020 6465 6620  ._hash..    def 
+00004560: 5f5f 6571 5f5f 2873 656c 662c 206f 7468  __eq__(self, oth
+00004570: 6572 3a20 6f62 6a65 6374 2920 2d3e 2062  er: object) -> b
+00004580: 6f6f 6c3a 0a20 2020 2020 2020 2072 6574  ool:.        ret
+00004590: 7572 6e20 6973 696e 7374 616e 6365 286f  urn isinstance(o
+000045a0: 7468 6572 2c20 576f 726b 6572 5374 6174  ther, WorkerStat
+000045b0: 6529 2061 6e64 206f 7468 6572 2e73 6572  e) and other.ser
+000045c0: 7665 725f 6964 203d 3d20 7365 6c66 2e73  ver_id == self.s
+000045d0: 6572 7665 725f 6964 0a0a 2020 2020 4070  erver_id..    @p
+000045e0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000045f0: 6861 735f 7768 6174 2873 656c 6629 202d  has_what(self) -
+00004600: 3e20 5365 745b 5461 736b 5374 6174 655d  > Set[TaskState]
+00004610: 3a0a 2020 2020 2020 2020 2222 2241 6e20  :.        """An 
+00004620: 696e 7365 7274 696f 6e2d 736f 7274 6564  insertion-sorted
+00004630: 2073 6574 2d6c 696b 6520 6f66 2074 6173   set-like of tas
+00004640: 6b73 2077 6869 6368 2063 7572 7265 6e74  ks which current
+00004650: 6c79 2072 6573 6964 6520 6f6e 2074 6869  ly reside on thi
+00004660: 7320 776f 726b 6572 2e0a 2020 2020 2020  s worker..      
+00004670: 2020 416c 6c20 7468 6520 7461 736b 7320    All the tasks 
+00004680: 6865 7265 2061 7265 2069 6e20 7468 6520  here are in the 
+00004690: 226d 656d 6f72 7922 2073 7461 7465 2e0a  "memory" state..
+000046a0: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
+000046b0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
+000046c0: 696e 6720 6f66 203a 6174 7472 3a60 5461  ing of :attr:`Ta
+000046d0: 736b 5374 6174 652e 7768 6f5f 6861 7360  skState.who_has`
+000046e0: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
+000046f0: 6973 2061 2072 6561 642d 6f6e 6c79 2070  is a read-only p
+00004700: 7562 6c69 6320 6163 6365 7373 6f72 2e20  ublic accessor. 
+00004710: 5468 6520 6461 7461 2069 7320 696d 706c  The data is impl
+00004720: 656d 656e 7465 6420 6173 2061 2064 6963  emented as a dic
+00004730: 7420 7769 7468 6f75 740a 2020 2020 2020  t without.      
+00004740: 2020 7661 6c75 6573 2c20 6265 6361 7573    values, becaus
+00004750: 6520 7265 6261 6c61 6e63 6528 2920 7265  e rebalance() re
+00004760: 6c69 6573 206f 6e20 6469 6374 7320 6265  lies on dicts be
+00004770: 696e 6720 696e 7365 7274 696f 6e2d 736f  ing insertion-so
+00004780: 7274 6564 2e0a 2020 2020 2020 2020 2222  rted..        ""
+00004790: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+000047a0: 2073 656c 662e 5f68 6173 5f77 6861 742e   self._has_what.
+000047b0: 6b65 7973 2829 0a0a 2020 2020 4070 726f  keys()..    @pro
+000047c0: 7065 7274 790a 2020 2020 6465 6620 686f  perty.    def ho
+000047d0: 7374 2873 656c 6629 202d 3e20 7374 723a  st(self) -> str:
+000047e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000047f0: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
+00004800: 2873 656c 662e 6164 6472 6573 7329 0a0a  (self.address)..
+00004810: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00004820: 2020 6465 6620 6d65 6d6f 7279 2873 656c    def memory(sel
+00004830: 6629 202d 3e20 4d65 6d6f 7279 5374 6174  f) -> MemoryStat
+00004840: 653a 0a20 2020 2020 2020 2022 2222 506f  e:.        """Po
+00004850: 6c69 7368 6564 206d 656d 6f72 7920 6d65  lished memory me
+00004860: 7472 6963 7320 666f 7220 7468 6520 776f  trics for the wo
+00004870: 726b 6572 2e0a 0a20 2020 2020 2020 202a  rker...        *
+00004880: 2a44 6573 6967 6e20 6e6f 7465 206f 6e20  *Design note on 
+00004890: 6d61 6e61 6765 6420 6d65 6d6f 7279 2a2a  managed memory**
+000048a0: 0a0a 2020 2020 2020 2020 5468 6572 6520  ..        There 
+000048b0: 6172 6520 7477 6f20 6d65 6173 7572 6573  are two measures
+000048c0: 2061 7661 696c 6162 6c65 2066 6f72 206d   available for m
+000048d0: 616e 6167 6564 206d 656d 6f72 793a 0a0a  anaged memory:..
+000048e0: 2020 2020 2020 2020 2d20 6060 7365 6c66          - ``self
+000048f0: 2e6e 6279 7465 7360 600a 2020 2020 2020  .nbytes``.      
+00004900: 2020 2d20 6060 7365 6c66 2e6d 6574 7269    - ``self.metri
+00004910: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
+00004920: 7322 5d60 600a 0a20 2020 2020 2020 2041  s"]``..        A
+00004930: 7420 7265 7374 2c20 7468 6520 7477 6f20  t rest, the two 
+00004940: 6e75 6d62 6572 7320 6d75 7374 2062 6520  numbers must be 
+00004950: 6964 656e 7469 6361 6c2e 2048 6f77 6576  identical. Howev
+00004960: 6572 2c20 6060 7365 6c66 2e6e 6279 7465  er, ``self.nbyte
+00004970: 7360 6020 6973 0a20 2020 2020 2020 2069  s`` is.        i
+00004980: 6d6d 6564 6961 7465 6c79 2075 7064 6174  mmediately updat
+00004990: 6564 2074 6872 6f75 6768 2074 6865 2062  ed through the b
+000049a0: 6174 6368 6564 2063 6f6d 6d73 2061 7320  atched comms as 
+000049b0: 736f 6f6e 2061 7320 6561 6368 2074 6173  soon as each tas
+000049c0: 6b20 6c61 6e64 7320 696e 0a20 2020 2020  k lands in.     
+000049d0: 2020 206d 656d 6f72 7920 6f6e 2074 6865     memory on the
+000049e0: 2077 6f72 6b65 723b 2060 6073 656c 662e   worker; ``self.
+000049f0: 6d65 7472 6963 735b 226d 616e 6167 6564  metrics["managed
+00004a00: 5f62 7974 6573 225d 6060 2069 6e73 7465  _bytes"]`` inste
+00004a10: 6164 2069 7320 7570 6461 7465 6420 6279  ad is updated by
+00004a20: 0a20 2020 2020 2020 2074 6865 2068 6561  .        the hea
+00004a30: 7274 6265 6174 2c20 7768 6963 6820 6361  rtbeat, which ca
+00004a40: 6e20 6c61 6720 7365 7665 7261 6c20 7365  n lag several se
+00004a50: 636f 6e64 7320 6265 6869 6e64 2e0a 0a20  conds behind... 
+00004a60: 2020 2020 2020 2042 656c 6f77 2077 6520         Below we 
+00004a70: 6172 6520 6d69 7869 6e67 206c 696b 656c  are mixing likel
+00004a80: 7920 6e65 7765 7220 6d61 6e61 6765 6420  y newer managed 
+00004a90: 6d65 6d6f 7279 2069 6e66 6f20 6672 6f6d  memory info from
+00004aa0: 2060 6073 656c 662e 6e62 7974 6573 6060   ``self.nbytes``
+00004ab0: 2077 6974 680a 2020 2020 2020 2020 7072   with.        pr
+00004ac0: 6f63 6573 7320 616e 6420 7370 696c 6c65  ocess and spille
+00004ad0: 6420 6d65 6d6f 7279 2066 726f 6d20 7468  d memory from th
+00004ae0: 6520 6865 6172 7462 6561 742e 2054 6869  e heartbeat. Thi
+00004af0: 7320 6973 2064 656c 6962 6572 6174 652c  s is deliberate,
+00004b00: 2073 6f20 7468 6174 0a20 2020 2020 2020   so that.       
+00004b10: 206d 616e 6167 6564 206d 656d 6f72 7920   managed memory 
+00004b20: 746f 7461 6c20 6973 2075 7064 6174 6564  total is updated
+00004b30: 206d 6f72 6520 6672 6571 7565 6e74 6c79   more frequently
+00004b40: 2e0a 0a20 2020 2020 2020 204d 616e 6167  ...        Manag
+00004b50: 6564 206d 656d 6f72 7920 6469 7265 6374  ed memory direct
+00004b60: 6c79 2061 6e64 2069 6d6d 6564 6961 7465  ly and immediate
+00004b70: 6c79 2063 6f6e 7472 6962 7574 6573 2074  ly contributes t
+00004b80: 6f20 6f70 7469 6d69 7374 6963 206d 656d  o optimistic mem
+00004b90: 6f72 792c 2077 6869 6368 0a20 2020 2020  ory, which.     
+00004ba0: 2020 2069 7320 696e 2074 7572 6e20 7573     is in turn us
+00004bb0: 6564 2069 6e20 4163 7469 7665 204d 656d  ed in Active Mem
+00004bc0: 6f72 7920 4d61 6e61 6765 7220 6865 7572  ory Manager heur
+00004bd0: 6973 7469 6373 2028 6174 2074 6865 206d  istics (at the m
+00004be0: 6f6d 656e 7420 6f66 2077 7269 7469 6e67  oment of writing
+00004bf0: 3b0a 2020 2020 2020 2020 6d6f 7265 2075  ;.        more u
+00004c00: 7365 7320 7769 6c6c 206c 696b 656c 7920  ses will likely 
+00004c10: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+00004c20: 6675 7475 7265 292e 2053 6f20 6974 2773  future). So it's
+00004c30: 2069 6d70 6f72 7461 6e74 2074 6f20 6861   important to ha
+00004c40: 7665 2069 740a 2020 2020 2020 2020 7570  ve it.        up
+00004c50: 2074 6f20 6461 7465 3b20 6d75 6368 206d   to date; much m
+00004c60: 6f72 6520 7468 616e 2069 7420 6973 2066  ore than it is f
+00004c70: 6f72 2070 726f 6365 7373 206d 656d 6f72  or process memor
+00004c80: 792e 0a0a 2020 2020 2020 2020 4861 7669  y...        Havi
+00004c90: 6e67 2075 702d 746f 2d64 6174 6520 6d61  ng up-to-date ma
+00004ca0: 6e61 6765 6420 6d65 6d6f 7279 2069 6e66  naged memory inf
+00004cb0: 6f20 6173 2073 6f6f 6e20 6173 2074 6865  o as soon as the
+00004cc0: 2073 6368 6564 756c 6572 206c 6561 726e   scheduler learn
+00004cd0: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
+00004ce0: 7461 736b 2063 6f6d 706c 6574 696f 6e20  task completion 
+00004cf0: 616c 736f 2073 7562 7374 616e 7469 616c  also substantial
+00004d00: 6c79 2073 696d 706c 6966 6965 7320 756e  ly simplifies un
+00004d10: 6974 2074 6573 7473 2e0a 0a20 2020 2020  it tests...     
+00004d20: 2020 2054 6865 2066 6c69 7020 7369 6465     The flip side
+00004d30: 206f 6620 7468 6973 2064 6573 6967 6e20   of this design 
+00004d40: 6973 2074 6861 7420 6974 206d 6179 2063  is that it may c
+00004d50: 6175 7365 2073 6f6d 6520 6e6f 6973 6520  ause some noise 
+00004d60: 696e 2074 6865 0a20 2020 2020 2020 2075  in the.        u
+00004d70: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
+00004d80: 6d65 6173 7572 652e 2065 2e67 2e3a 0a0a  measure. e.g.:..
+00004d90: 2020 2020 2020 2020 312e 2044 656c 6574          1. Delet
+00004da0: 6520 3130 304d 4220 6f66 206d 616e 6167  e 100MB of manag
+00004db0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+00004dc0: 322e 2054 6865 2075 7064 6174 6564 206d  2. The updated m
+00004dd0: 616e 6167 6564 206d 656d 6f72 7920 7265  anaged memory re
+00004de0: 6163 6865 7320 7468 6520 7363 6865 6475  aches the schedu
+00004df0: 6c65 7220 6661 7374 6572 2074 6861 6e20  ler faster than 
+00004e00: 7468 650a 2020 2020 2020 2020 2020 2075  the.           u
+00004e10: 7064 6174 6564 2070 726f 6365 7373 206d  pdated process m
+00004e20: 656d 6f72 790a 2020 2020 2020 2020 332e  emory.        3.
+00004e30: 2054 6865 7265 2773 2061 2062 6c69 7020   There's a blip 
+00004e40: 7768 6572 6520 7468 6520 7363 6865 6475  where the schedu
+00004e50: 6c65 7220 7468 696e 6b73 2074 6861 7420  ler thinks that 
+00004e60: 7468 6572 6527 7320 6120 7375 6464 656e  there's a sudden
+00004e70: 2031 3030 4d42 0a20 2020 2020 2020 2020   100MB.         
+00004e80: 2020 696e 6372 6561 7365 2069 6e20 756e    increase in un
+00004e90: 6d61 6e61 6765 645f 7265 6365 6e74 2c20  managed_recent, 
+00004ea0: 7369 6e63 6520 7072 6f63 6573 7320 6d65  since process me
+00004eb0: 6d6f 7279 2068 6173 6e27 7420 6368 616e  mory hasn't chan
+00004ec0: 6765 6420 6275 7420 6d61 6e61 6765 640a  ged but managed.
+00004ed0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
+00004ee0: 7920 6861 7320 6465 6372 6561 7365 6420  y has decreased 
+00004ef0: 6279 2031 3030 4d42 0a20 2020 2020 2020  by 100MB.       
+00004f00: 2034 2e20 5768 656e 2074 6865 2068 6561   4. When the hea
+00004f10: 7274 6265 6174 2061 7272 6976 6573 2c20  rtbeat arrives, 
+00004f20: 7072 6f63 6573 7320 6d65 6d6f 7279 2067  process memory g
+00004f30: 6f65 7320 646f 776e 2061 6e64 2073 6f20  oes down and so 
+00004f40: 646f 6573 2074 6865 0a20 2020 2020 2020  does the.       
+00004f50: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
+00004f60: 6365 6e74 2e0a 0a20 2020 2020 2020 2054  cent...        T
+00004f70: 6869 7320 6973 204f 4b20 2d20 6f6e 6520  his is OK - one 
+00004f80: 6f66 2074 6865 206d 6169 6e20 7265 6173  of the main reas
+00004f90: 6f6e 7320 666f 7220 7468 6520 756e 6d61  ons for the unma
+00004fa0: 6e61 6765 645f 7265 6365 6e74 202f 2075  naged_recent / u
+00004fb0: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
+00004fc0: 2020 2020 2073 706c 6974 2069 7320 6578       split is ex
+00004fd0: 6163 746c 7920 746f 2063 6f6e 6365 6e74  actly to concent
+00004fe0: 7261 7465 2061 6c6c 2074 6865 206e 6f69  rate all the noi
+00004ff0: 7365 2069 6e20 756e 6d61 6e61 6765 645f  se in unmanaged_
+00005000: 7265 6365 6e74 2061 6e64 2065 7863 6c75  recent and exclu
+00005010: 6465 2069 740a 2020 2020 2020 2020 6672  de it.        fr
+00005020: 6f6d 206f 7074 696d 6973 7469 6320 6d65  om optimistic me
+00005030: 6d6f 7279 2c20 7768 6963 6820 6973 2075  mory, which is u
+00005040: 7365 6420 666f 7220 6865 7572 6973 7469  sed for heuristi
+00005050: 6373 2e0a 0a20 2020 2020 2020 2053 6f6d  cs...        Som
+00005060: 6574 6869 6e67 2074 6861 7420 6973 206c  ething that is l
+00005070: 6573 7320 4f4b 2c20 6275 7420 616c 736f  ess OK, but also
+00005080: 206c 6573 7320 6672 6571 7565 6e74 2c20   less frequent, 
+00005090: 6973 2074 6861 7420 7468 6520 7375 6464  is that the sudd
+000050a0: 656e 2064 656c 6574 696f 6e0a 2020 2020  en deletion.    
+000050b0: 2020 2020 6f66 2073 7069 6c6c 6564 206b      of spilled k
+000050c0: 6579 7320 7769 6c6c 2063 6175 7365 2061  eys will cause a
+000050d0: 206e 6567 6174 6976 6520 626c 6970 2069   negative blip i
+000050e0: 6e20 6d61 6e61 6765 6420 6d65 6d6f 7279  n managed memory
+000050f0: 3a0a 0a20 2020 2020 2020 2031 2e20 4465  :..        1. De
+00005100: 6c65 7465 2031 3030 4d42 206f 6620 7370  lete 100MB of sp
+00005110: 696c 6c65 6420 6461 7461 0a20 2020 2020  illed data.     
+00005120: 2020 2032 2e20 5468 6520 7570 6461 7465     2. The update
+00005130: 6420 6d61 6e61 6765 6420 6d65 6d6f 7279  d managed memory
+00005140: 202a 746f 7461 6c2a 2072 6561 6368 6573   *total* reaches
+00005150: 2074 6865 2073 6368 6564 756c 6572 2066   the scheduler f
+00005160: 6173 7465 7220 7468 616e 2074 6865 0a20  aster than the. 
+00005170: 2020 2020 2020 2020 2020 7570 6461 7465            update
+00005180: 6420 7370 696c 6c65 6420 706f 7274 696f  d spilled portio
+00005190: 6e0a 2020 2020 2020 2020 332e 2054 6869  n.        3. Thi
+000051a0: 7320 6361 7573 6573 2074 6865 206d 616e  s causes the man
+000051b0: 6167 6564 206d 656d 6f72 7920 746f 2074  aged memory to t
+000051c0: 656d 706f 7261 7269 6c79 2070 6c75 6d6d  emporarily plumm
+000051d0: 6574 2061 6e64 2062 6520 7265 706c 6163  et and be replac
+000051e0: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
+000051f0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+00005200: 742c 2077 6869 6c65 2073 7069 6c6c 6564  t, while spilled
+00005210: 206d 656d 6f72 7920 7265 6d61 696e 7320   memory remains 
+00005220: 756e 616c 7465 7265 640a 2020 2020 2020  unaltered.      
+00005230: 2020 342e 2057 6865 6e20 7468 6520 6865    4. When the he
+00005240: 6172 7462 6561 7420 6172 7269 7665 732c  artbeat arrives,
+00005250: 206d 616e 6167 6564 2067 6f65 7320 6261   managed goes ba
+00005260: 636b 2075 702c 2075 6e6d 616e 6167 6564  ck up, unmanaged
+00005270: 5f72 6563 656e 740a 2020 2020 2020 2020  _recent.        
+00005280: 2020 2067 6f65 7320 6261 636b 2064 6f77     goes back dow
+00005290: 6e2c 2061 6e64 2073 7069 6c6c 6564 2067  n, and spilled g
+000052a0: 6f65 7320 646f 776e 2062 7920 3130 304d  oes down by 100M
+000052b0: 4220 6173 2069 7420 7368 6f75 6c64 2068  B as it should h
+000052c0: 6176 6520 746f 0a20 2020 2020 2020 2020  ave to.         
+000052d0: 2020 6265 6769 6e20 7769 7468 2e0a 0a20    begin with... 
+000052e0: 2020 2020 2020 203a 6973 7375 653a 6036         :issue:`6
+000052f0: 3030 3260 2077 696c 6c20 6c65 7420 7573  002` will let us
+00005300: 2073 6f6c 7665 2074 6869 732e 0a20 2020   solve this..   
+00005310: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00005320: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
+00005330: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+00005340: 2070 726f 6365 7373 3d73 656c 662e 6d65   process=self.me
+00005350: 7472 6963 735b 226d 656d 6f72 7922 5d2c  trics["memory"],
+00005360: 0a20 2020 2020 2020 2020 2020 206d 616e  .            man
+00005370: 6167 6564 3d6d 6178 2830 2c20 7365 6c66  aged=max(0, self
+00005380: 2e6e 6279 7465 7320 2d20 7365 6c66 2e6d  .nbytes - self.m
+00005390: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
+000053a0: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
+000053b0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000053c0: 7370 696c 6c65 643d 7365 6c66 2e6d 6574  spilled=self.met
+000053d0: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
+000053e0: 7465 7322 5d5b 2264 6973 6b22 5d2c 0a20  tes"]["disk"],. 
+000053f0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
+00005400: 6167 6564 5f6f 6c64 3d73 656c 662e 5f6d  aged_old=self._m
+00005410: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00005420: 6f6c 642c 0a20 2020 2020 2020 2029 0a0a  old,.        )..
+00005430: 2020 2020 6465 6620 636c 6561 6e28 7365      def clean(se
+00005440: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
+00005450: 7465 3a0a 2020 2020 2020 2020 2222 2252  te:.        """R
+00005460: 6574 7572 6e20 6120 7665 7273 696f 6e20  eturn a version 
+00005470: 6f66 2074 6869 7320 6f62 6a65 6374 2074  of this object t
+00005480: 6861 7420 6973 2061 7070 726f 7072 6961  hat is appropria
+00005490: 7465 2066 6f72 2073 6572 6961 6c69 7a61  te for serializa
+000054a0: 7469 6f6e 2222 220a 2020 2020 2020 2020  tion""".        
+000054b0: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
+000054c0: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
+000054d0: 6472 6573 733d 7365 6c66 2e61 6464 7265  dress=self.addre
+000054e0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+000054f0: 7374 6174 7573 3d73 656c 662e 7374 6174  status=self.stat
+00005500: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
+00005510: 7069 643d 7365 6c66 2e70 6964 2c0a 2020  pid=self.pid,.  
+00005520: 2020 2020 2020 2020 2020 6e61 6d65 3d73            name=s
+00005530: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
+00005540: 2020 2020 2020 6e74 6872 6561 6473 3d73        nthreads=s
+00005550: 656c 662e 6e74 6872 6561 6473 2c0a 2020  elf.nthreads,.  
+00005560: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
+00005570: 5f6c 696d 6974 3d73 656c 662e 6d65 6d6f  _limit=self.memo
+00005580: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
+00005590: 2020 2020 2020 6c6f 6361 6c5f 6469 7265        local_dire
+000055a0: 6374 6f72 793d 7365 6c66 2e6c 6f63 616c  ctory=self.local
+000055b0: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
+000055c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
+000055d0: 3d73 656c 662e 7365 7276 6963 6573 2c0a  =self.services,.
+000055e0: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
+000055f0: 793d 7365 6c66 2e6e 616e 6e79 2c0a 2020  y=self.nanny,.  
+00005600: 2020 2020 2020 2020 2020 6578 7472 613d            extra=
+00005610: 7365 6c66 2e65 7874 7261 2c0a 2020 2020  self.extra,.    
+00005620: 2020 2020 2020 2020 7365 7276 6572 5f69          server_i
+00005630: 643d 7365 6c66 2e73 6572 7665 725f 6964  d=self.server_id
+00005640: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00005650: 2020 2020 7773 2e5f 6f63 6375 7061 6e63      ws._occupanc
+00005660: 795f 6361 6368 6520 3d20 7365 6c66 2e6f  y_cache = self.o
+00005670: 6363 7570 616e 6379 0a0a 2020 2020 2020  ccupancy..      
+00005680: 2020 7773 2e65 7865 6375 7469 6e67 203d    ws.executing =
+00005690: 207b 0a20 2020 2020 2020 2020 2020 2074   {.            t
+000056a0: 732e 6b65 793a 2064 7572 6174 696f 6e20  s.key: duration 
+000056b0: 666f 7220 7473 2c20 6475 7261 7469 6f6e  for ts, duration
+000056c0: 2069 6e20 7365 6c66 2e65 7865 6375 7469   in self.executi
+000056d0: 6e67 2e69 7465 6d73 2829 2020 2320 7479  ng.items()  # ty
+000056e0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+000056f0: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
+00005700: 7572 6e20 7773 0a0a 2020 2020 6465 6620  urn ws..    def 
+00005710: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+00005720: 3e20 7374 723a 0a20 2020 2020 2020 206e  > str:.        n
+00005730: 616d 6520 3d20 6622 2c20 6e61 6d65 3a20  ame = f", name: 
+00005740: 7b73 656c 662e 6e61 6d65 7d22 2069 6620  {self.name}" if 
+00005750: 7365 6c66 2e6e 616d 6520 213d 2073 656c  self.name != sel
+00005760: 662e 6164 6472 6573 7320 656c 7365 2022  f.address else "
+00005770: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00005780: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+00005790: 223c 576f 726b 6572 5374 6174 6520 7b73  "<WorkerState {s
+000057a0: 656c 662e 6164 6472 6573 7321 727d 7b6e  elf.address!r}{n
+000057b0: 616d 657d 2c20 220a 2020 2020 2020 2020  ame}, ".        
+000057c0: 2020 2020 6622 7374 6174 7573 3a20 7b73      f"status: {s
+000057d0: 656c 662e 7374 6174 7573 2e6e 616d 657d  elf.status.name}
+000057e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+000057f0: 6622 6d65 6d6f 7279 3a20 7b6c 656e 2873  f"memory: {len(s
+00005800: 656c 662e 6861 735f 7768 6174 297d 2c20  elf.has_what)}, 
+00005810: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00005820: 7072 6f63 6573 7369 6e67 3a20 7b6c 656e  processing: {len
+00005830: 2873 656c 662e 7072 6f63 6573 7369 6e67  (self.processing
+00005840: 297d 3e22 0a20 2020 2020 2020 2029 0a0a  )}>".        )..
+00005850: 2020 2020 6465 6620 5f72 6570 725f 6874      def _repr_ht
+00005860: 6d6c 5f28 7365 6c66 2920 2d3e 2073 7472  ml_(self) -> str
+00005870: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00005880: 2067 6574 5f74 656d 706c 6174 6528 2277   get_template("w
+00005890: 6f72 6b65 725f 7374 6174 652e 6874 6d6c  orker_state.html
+000058a0: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
+000058b0: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+000058c0: 733d 7365 6c66 2e61 6464 7265 7373 2c0a  s=self.address,.
+000058d0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000058e0: 3d73 656c 662e 6e61 6d65 2c0a 2020 2020  =self.name,.    
+000058f0: 2020 2020 2020 2020 7374 6174 7573 3d73          status=s
+00005900: 656c 662e 7374 6174 7573 2e6e 616d 652c  elf.status.name,
+00005910: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
+00005920: 5f77 6861 743d 7365 6c66 2e68 6173 5f77  _what=self.has_w
+00005930: 6861 742c 0a20 2020 2020 2020 2020 2020  hat,.           
+00005940: 2070 726f 6365 7373 696e 673d 7365 6c66   processing=self
+00005950: 2e70 726f 6365 7373 696e 672c 0a20 2020  .processing,.   
+00005960: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00005970: 6964 656e 7469 7479 2873 656c 6629 202d  identity(self) -
+00005980: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
+00005990: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000059a0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+000059b0: 7479 7065 223a 2022 576f 726b 6572 222c  type": "Worker",
+000059c0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
+000059d0: 223a 2073 656c 662e 6e61 6d65 2c0a 2020  ": self.name,.  
+000059e0: 2020 2020 2020 2020 2020 2268 6f73 7422            "host"
+000059f0: 3a20 7365 6c66 2e68 6f73 742c 0a20 2020  : self.host,.   
+00005a00: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
+00005a10: 6365 7322 3a20 7365 6c66 2e72 6573 6f75  ces": self.resou
+00005a20: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
+00005a30: 2020 226c 6f63 616c 5f64 6972 6563 746f    "local_directo
+00005a40: 7279 223a 2073 656c 662e 6c6f 6361 6c5f  ry": self.local_
+00005a50: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
+00005a60: 2020 2020 2020 2022 6e61 6d65 223a 2073         "name": s
+00005a70: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
+00005a80: 2020 2020 2020 226e 7468 7265 6164 7322        "nthreads"
+00005a90: 3a20 7365 6c66 2e6e 7468 7265 6164 732c  : self.nthreads,
+00005aa0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00005ab0: 6d6f 7279 5f6c 696d 6974 223a 2073 656c  mory_limit": sel
+00005ac0: 662e 6d65 6d6f 7279 5f6c 696d 6974 2c0a  f.memory_limit,.
+00005ad0: 2020 2020 2020 2020 2020 2020 226c 6173              "las
+00005ae0: 745f 7365 656e 223a 2073 656c 662e 6c61  t_seen": self.la
+00005af0: 7374 5f73 6565 6e2c 0a20 2020 2020 2020  st_seen,.       
+00005b00: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
+00005b10: 2073 656c 662e 7365 7276 6963 6573 2c0a   self.services,.
+00005b20: 2020 2020 2020 2020 2020 2020 226d 6574              "met
+00005b30: 7269 6373 223a 2073 656c 662e 6d65 7472  rics": self.metr
+00005b40: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
+00005b50: 2022 7374 6174 7573 223a 2073 656c 662e   "status": self.
+00005b60: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
+00005b70: 2020 2020 2020 2020 2022 6e61 6e6e 7922           "nanny"
+00005b80: 3a20 7365 6c66 2e6e 616e 6e79 2c0a 2020  : self.nanny,.  
+00005b90: 2020 2020 2020 2020 2020 2a2a 7365 6c66            **self
+00005ba0: 2e65 7874 7261 2c0a 2020 2020 2020 2020  .extra,.        
+00005bb0: 7d0a 0a20 2020 2064 6566 205f 746f 5f64  }..    def _to_d
+00005bc0: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
+00005bd0: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
+00005be0: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
+00005bf0: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
+00005c00: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
+00005c10: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
+00005c20: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
+00005c30: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
+00005c40: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
+00005c50: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
+00005c60: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
+00005c70: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
+00005c80: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+00005c90: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+00005ca0: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
+00005cb0: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
+00005cc0: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
+00005cd0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
+00005ce0: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
+00005cf0: 2020 2020 2054 6173 6b53 7461 7465 2e5f       TaskState._
+00005d00: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
+00005d10: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00005d20: 726e 2072 6563 7572 7369 7665 5f74 6f5f  rn recursive_to_
+00005d30: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
+00005d40: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00005d50: 2020 2020 6578 636c 7564 653d 7365 7428      exclude=set(
+00005d60: 6578 636c 7564 6529 207c 207b 2276 6572  exclude) | {"ver
+00005d70: 7369 6f6e 7322 7d2c 2020 2320 7479 7065  sions"},  # type
+00005d80: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00005d90: 2020 2020 206d 656d 6265 7273 3d54 7275       members=Tru
+00005da0: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
+00005db0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00005dc0: 6465 6620 7363 6865 6475 6c65 7228 7365  def scheduler(se
+00005dd0: 6c66 2920 2d3e 2053 6368 6564 756c 6572  lf) -> Scheduler
+00005de0: 5374 6174 653a 0a20 2020 2020 2020 2061  State:.        a
+00005df0: 7373 6572 7420 7365 6c66 2e73 6368 6564  ssert self.sched
+00005e00: 756c 6572 5f72 6566 0a20 2020 2020 2020  uler_ref.       
+00005e10: 2073 203d 2073 656c 662e 7363 6865 6475   s = self.schedu
+00005e20: 6c65 725f 7265 6628 290a 2020 2020 2020  ler_ref().      
+00005e30: 2020 6173 7365 7274 2073 0a20 2020 2020    assert s.     
+00005e40: 2020 2072 6574 7572 6e20 730a 0a20 2020     return s..   
+00005e50: 2064 6566 2061 6464 5f74 6f5f 7072 6f63   def add_to_proc
+00005e60: 6573 7369 6e67 2873 656c 662c 2074 733a  essing(self, ts:
+00005e70: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
+00005e80: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00005e90: 4173 7369 676e 2061 2074 6173 6b20 746f  Assign a task to
+00005ea0: 2074 6869 7320 776f 726b 6572 2066 6f72   this worker for
+00005eb0: 2063 6f6d 7075 7465 2e22 2222 0a20 2020   compute.""".   
+00005ec0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
+00005ed0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
+00005ee0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00005ef0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+00005f00: 6c66 2e70 726f 6365 7373 696e 670a 0a20  lf.processing.. 
+00005f10: 2020 2020 2020 2074 7020 3d20 7473 2e70         tp = ts.p
+00005f20: 7265 6669 780a 2020 2020 2020 2020 7365  refix.        se
+00005f30: 6c66 2e74 6173 6b5f 7072 6566 6978 5f63  lf.task_prefix_c
+00005f40: 6f75 6e74 5b74 702e 6e61 6d65 5d20 2b3d  ount[tp.name] +=
+00005f50: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
+00005f60: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
+00005f70: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+00005f80: 6261 6c5b 7470 2e6e 616d 655d 202b 3d20  bal[tp.name] += 
+00005f90: 310a 2020 2020 2020 2020 7365 6c66 2e70  1.        self.p
+00005fa0: 726f 6365 7373 696e 672e 6164 6428 7473  rocessing.add(ts
+00005fb0: 290a 2020 2020 2020 2020 666f 7220 6474  ).        for dt
+00005fc0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00005fd0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00005fe0: 2020 6966 2073 656c 6620 6e6f 7420 696e    if self not in
+00005ff0: 2064 7473 2e77 686f 5f68 6173 3a0a 2020   dts.who_has:.  
+00006000: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00006010: 6c66 2e5f 696e 635f 6e65 6564 735f 7265  lf._inc_needs_re
+00006020: 706c 6963 6128 6474 7329 0a0a 2020 2020  plica(dts)..    
+00006030: 6465 6620 6164 645f 746f 5f6c 6f6e 675f  def add_to_long_
+00006040: 7275 6e6e 696e 6728 7365 6c66 2c20 7473  running(self, ts
+00006050: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00006060: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+00006070: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006080: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00006090: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+000060a0: 696e 2073 656c 662e 7072 6f63 6573 7369  in self.processi
+000060b0: 6e67 0a20 2020 2020 2020 2020 2020 2061  ng.            a
+000060c0: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+000060d0: 7365 6c66 2e6c 6f6e 675f 7275 6e6e 696e  self.long_runnin
+000060e0: 670a 0a20 2020 2020 2020 2073 656c 662e  g..        self.
+000060f0: 5f72 656d 6f76 655f 6672 6f6d 5f74 6173  _remove_from_tas
+00006100: 6b5f 7072 6566 6978 5f63 6f75 6e74 2874  k_prefix_count(t
+00006110: 7329 0a20 2020 2020 2020 2023 2043 616e  s).        # Can
+00006120: 6e6f 7420 7265 6d6f 7665 2066 726f 6d20  not remove from 
+00006130: 7072 6f63 6573 7369 6e67 2073 696e 6365  processing since
+00006140: 2077 6527 7265 2075 7369 6e67 2074 6869   we're using thi
+00006150: 7320 666f 7220 7468 696e 6773 206c 696b  s for things lik
+00006160: 650a 2020 2020 2020 2020 2320 6964 6c65  e.        # idle
+00006170: 6e65 7373 2064 6574 6563 7469 6f6e 2e20  ness detection. 
+00006180: 4964 6c65 2077 6f72 6b65 7273 2061 7265  Idle workers are
+00006190: 2074 7970 6963 616c 6c79 2074 6172 6765   typically targe
+000061a0: 7465 6420 666f 720a 2020 2020 2020 2020  ted for.        
+000061b0: 2320 646f 776e 7363 616c 696e 6720 6275  # downscaling bu
+000061c0: 7420 7765 2073 686f 756c 6420 6e6f 7420  t we should not 
+000061d0: 646f 776e 7363 616c 6520 776f 726b 6572  downscale worker
+000061e0: 7320 7769 7468 206c 6f6e 6720 7275 6e6e  s with long runn
+000061f0: 696e 670a 2020 2020 2020 2020 2320 7461  ing.        # ta
+00006200: 736b 730a 2020 2020 2020 2020 7365 6c66  sks.        self
+00006210: 2e6c 6f6e 675f 7275 6e6e 696e 672e 6164  .long_running.ad
+00006220: 6428 7473 290a 0a20 2020 2064 6566 2072  d(ts)..    def r
+00006230: 656d 6f76 655f 6672 6f6d 5f70 726f 6365  emove_from_proce
+00006240: 7373 696e 6728 7365 6c66 2c20 7473 3a20  ssing(self, ts: 
+00006250: 5461 736b 5374 6174 6529 202d 3e20 4e6f  TaskState) -> No
+00006260: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00006270: 656d 6f76 6520 6120 7461 736b 2066 726f  emove a task fro
+00006280: 6d20 6120 776f 726b 6572 7320 7072 6f63  m a workers proc
+00006290: 6573 7369 6e67 2222 220a 2020 2020 2020  essing""".      
+000062a0: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
+000062b0: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
+000062c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000062d0: 2074 7320 696e 2073 656c 662e 7072 6f63   ts in self.proc
+000062e0: 6573 7369 6e67 0a0a 2020 2020 2020 2020  essing..        
+000062f0: 6966 2074 7320 696e 2073 656c 662e 6c6f  if ts in self.lo
+00006300: 6e67 5f72 756e 6e69 6e67 3a0a 2020 2020  ng_running:.    
+00006310: 2020 2020 2020 2020 7365 6c66 2e6c 6f6e          self.lon
+00006320: 675f 7275 6e6e 696e 672e 6469 7363 6172  g_running.discar
+00006330: 6428 7473 290a 2020 2020 2020 2020 656c  d(ts).        el
+00006340: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006350: 7365 6c66 2e5f 7265 6d6f 7665 5f66 726f  self._remove_fro
+00006360: 6d5f 7461 736b 5f70 7265 6669 785f 636f  m_task_prefix_co
+00006370: 756e 7428 7473 290a 2020 2020 2020 2020  unt(ts).        
+00006380: 7365 6c66 2e70 726f 6365 7373 696e 672e  self.processing.
+00006390: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
+000063a0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+000063b0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+000063c0: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
+000063d0: 7320 696e 2073 656c 662e 6e65 6564 735f  s in self.needs_
+000063e0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
+000063f0: 2020 2020 2020 7365 6c66 2e5f 6465 635f        self._dec_
+00006400: 6e65 6564 735f 7265 706c 6963 6128 6474  needs_replica(dt
+00006410: 7329 0a0a 2020 2020 6465 6620 5f72 656d  s)..    def _rem
+00006420: 6f76 655f 6672 6f6d 5f74 6173 6b5f 7072  ove_from_task_pr
+00006430: 6566 6978 5f63 6f75 6e74 2873 656c 662c  efix_count(self,
+00006440: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
+00006450: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00006460: 2063 6f75 6e74 203d 2073 656c 662e 7461   count = self.ta
+00006470: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
+00006480: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
+00006490: 2d20 310a 2020 2020 2020 2020 6966 2063  - 1.        if c
+000064a0: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
+000064b0: 2020 7365 6c66 2e74 6173 6b5f 7072 6566    self.task_pref
+000064c0: 6978 5f63 6f75 6e74 5b74 732e 7072 6566  ix_count[ts.pref
+000064d0: 6978 2e6e 616d 655d 203d 2063 6f75 6e74  ix.name] = count
+000064e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000064f0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+00006500: 656c 662e 7461 736b 5f70 7265 6669 785f  elf.task_prefix_
+00006510: 636f 756e 745b 7473 2e70 7265 6669 782e  count[ts.prefix.
+00006520: 6e61 6d65 5d0a 0a20 2020 2020 2020 2063  name]..        c
+00006530: 6f75 6e74 203d 2073 656c 662e 7363 6865  ount = self.sche
+00006540: 6475 6c65 722e 5f74 6173 6b5f 7072 6566  duler._task_pref
+00006550: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c5b  ix_count_global[
+00006560: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
+00006570: 2d20 310a 2020 2020 2020 2020 6966 2063  - 1.        if c
+00006580: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
+00006590: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+000065a0: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
+000065b0: 756e 745f 676c 6f62 616c 5b74 732e 7072  unt_global[ts.pr
+000065c0: 6566 6978 2e6e 616d 655d 203d 2063 6f75  efix.name] = cou
+000065d0: 6e74 0a20 2020 2020 2020 2065 6c73 653a  nt.        else:
+000065e0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+000065f0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006600: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+00006610: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
+00006620: 6669 782e 6e61 6d65 5d0a 0a20 2020 2064  fix.name]..    d
+00006630: 6566 2072 656d 6f76 655f 7265 706c 6963  ef remove_replic
+00006640: 6128 7365 6c66 2c20 7473 3a20 5461 736b  a(self, ts: Task
+00006650: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00006660: 2020 2020 2020 2020 2222 2254 6865 2077          """The w
+00006670: 6f72 6b65 7220 6e6f 206c 6f6e 6765 7220  orker no longer 
+00006680: 6861 7320 6120 7461 736b 2069 6e20 6d65  has a task in me
+00006690: 6d6f 7279 2222 220a 2020 2020 2020 2020  mory""".        
+000066a0: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
+000066b0: 722e 7661 6c69 6461 7465 3a0a 2020 2020  r.validate:.    
+000066c0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+000066d0: 656c 6620 696e 2074 732e 7768 6f5f 6861  elf in ts.who_ha
+000066e0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+000066f0: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
+00006700: 6861 735f 7768 6174 0a20 2020 2020 2020  has_what.       
+00006710: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+00006720: 6f74 2069 6e20 7365 6c66 2e6e 6565 6473  ot in self.needs
+00006730: 5f77 6861 740a 0a20 2020 2020 2020 2073  _what..        s
+00006740: 656c 662e 6e62 7974 6573 202d 3d20 7473  elf.nbytes -= ts
+00006750: 2e67 6574 5f6e 6279 7465 7328 290a 2020  .get_nbytes().  
+00006760: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
+00006770: 6861 735f 7768 6174 5b74 735d 0a20 2020  has_what[ts].   
+00006780: 2020 2020 2074 732e 7768 6f5f 6861 732e       ts.who_has.
+00006790: 7265 6d6f 7665 2873 656c 6629 0a0a 2020  remove(self)..  
+000067a0: 2020 6465 6620 5f69 6e63 5f6e 6565 6473    def _inc_needs
+000067b0: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
+000067c0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+000067d0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+000067e0: 2222 4173 7369 676e 2061 2074 6173 6b20  ""Assign a task 
+000067f0: 6665 7463 6820 746f 2074 6869 7320 776f  fetch to this wo
+00006800: 726b 6572 2061 6e64 2075 7064 6174 6520  rker and update 
+00006810: 6e65 7477 6f72 6b20 6f63 6375 7061 6e63  network occupanc
+00006820: 6965 7322 2222 0a20 2020 2020 2020 2069  ies""".        i
+00006830: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00006840: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00006850: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+00006860: 6c66 206e 6f74 2069 6e20 7473 2e77 686f  lf not in ts.who
+00006870: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00006880: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
+00006890: 6e20 7365 6c66 2e68 6173 5f77 6861 740a  n self.has_what.
+000068a0: 2020 2020 2020 2020 6966 2074 7320 6e6f          if ts no
+000068b0: 7420 696e 2073 656c 662e 6e65 6564 735f  t in self.needs_
+000068c0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
+000068d0: 2020 7365 6c66 2e6e 6565 6473 5f77 6861    self.needs_wha
+000068e0: 745b 7473 5d20 3d20 310a 2020 2020 2020  t[ts] = 1.      
+000068f0: 2020 2020 2020 6e62 7974 6573 203d 2074        nbytes = t
+00006900: 732e 6765 745f 6e62 7974 6573 2829 0a20  s.get_nbytes(). 
+00006910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006920: 5f6e 6574 776f 726b 5f6f 6363 202b 3d20  _network_occ += 
+00006930: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
+00006940: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+00006950: 722e 5f6e 6574 776f 726b 5f6f 6363 5f67  r._network_occ_g
+00006960: 6c6f 6261 6c20 2b3d 206e 6279 7465 730a  lobal += nbytes.
+00006970: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006980: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+00006990: 6565 6473 5f77 6861 745b 7473 5d20 2b3d  eeds_what[ts] +=
+000069a0: 2031 0a0a 2020 2020 6465 6620 5f64 6563   1..    def _dec
+000069b0: 5f6e 6565 6473 5f72 6570 6c69 6361 2873  _needs_replica(s
+000069c0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+000069d0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+000069e0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
+000069f0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
+00006a00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00006a10: 6572 7420 7473 2069 6e20 7365 6c66 2e6e  ert ts in self.n
+00006a20: 6565 6473 5f77 6861 740a 0a20 2020 2020  eeds_what..     
+00006a30: 2020 2073 656c 662e 6e65 6564 735f 7768     self.needs_wh
+00006a40: 6174 5b74 735d 202d 3d20 310a 2020 2020  at[ts] -= 1.    
+00006a50: 2020 2020 6966 2073 656c 662e 6e65 6564      if self.need
+00006a60: 735f 7768 6174 5b74 735d 203d 3d20 303a  s_what[ts] == 0:
+00006a70: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00006a80: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
+00006a90: 5b74 735d 0a20 2020 2020 2020 2020 2020  [ts].           
+00006aa0: 206e 6279 7465 7320 3d20 7473 2e67 6574   nbytes = ts.get
+00006ab0: 5f6e 6279 7465 7328 290a 2020 2020 2020  _nbytes().      
+00006ac0: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
+00006ad0: 6f72 6b5f 6f63 6320 2d3d 206e 6279 7465  ork_occ -= nbyte
+00006ae0: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+00006af0: 6c66 2e73 6368 6564 756c 6572 2e5f 6e65  lf.scheduler._ne
+00006b00: 7477 6f72 6b5f 6f63 635f 676c 6f62 616c  twork_occ_global
+00006b10: 202d 3d20 6e62 7974 6573 0a0a 2020 2020   -= nbytes..    
+00006b20: 6465 6620 6164 645f 7265 706c 6963 6128  def add_replica(
+00006b30: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00006b40: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+00006b50: 2020 2020 2020 2222 2254 6865 2077 6f72        """The wor
+00006b60: 6b65 7220 6163 7175 6972 6564 2061 2072  ker acquired a r
+00006b70: 6570 6c69 6361 206f 6620 7461 736b 2222  eplica of task""
+00006b80: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+00006b90: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
+00006ba0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00006bb0: 2020 6173 7365 7274 2073 656c 6620 6e6f    assert self no
+00006bc0: 7420 696e 2074 732e 7768 6f5f 6861 730a  t in ts.who_has.
+00006bd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006be0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+00006bf0: 662e 6861 735f 7768 6174 0a0a 2020 2020  f.has_what..    
+00006c00: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
+00006c10: 6765 745f 6e62 7974 6573 2829 0a20 2020  get_nbytes().   
+00006c20: 2020 2020 2069 6620 7473 2069 6e20 7365       if ts in se
+00006c30: 6c66 2e6e 6565 6473 5f77 6861 743a 0a20  lf.needs_what:. 
+00006c40: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+00006c50: 656c 662e 6e65 6564 735f 7768 6174 5b74  elf.needs_what[t
+00006c60: 735d 0a20 2020 2020 2020 2020 2020 2073  s].            s
+00006c70: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
+00006c80: 202d 3d20 6e62 7974 6573 0a20 2020 2020   -= nbytes.     
+00006c90: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00006ca0: 6475 6c65 722e 5f6e 6574 776f 726b 5f6f  duler._network_o
+00006cb0: 6363 5f67 6c6f 6261 6c20 2d3d 206e 6279  cc_global -= nby
+00006cc0: 7465 730a 2020 2020 2020 2020 7473 2e77  tes.        ts.w
+00006cd0: 686f 5f68 6173 2e61 6464 2873 656c 6629  ho_has.add(self)
+00006ce0: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
+00006cf0: 7974 6573 202b 3d20 6e62 7974 6573 0a20  ytes += nbytes. 
+00006d00: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
+00006d10: 5f77 6861 745b 7473 5d20 3d20 4e6f 6e65  _what[ts] = None
+00006d20: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00006d30: 2020 2020 6465 6620 6f63 6375 7061 6e63      def occupanc
+00006d40: 7928 7365 6c66 2920 2d3e 2066 6c6f 6174  y(self) -> float
+00006d50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00006d60: 2073 656c 662e 5f6f 6363 7570 616e 6379   self._occupancy
+00006d70: 5f63 6163 6865 206f 7220 7365 6c66 2e73  _cache or self.s
+00006d80: 6368 6564 756c 6572 2e5f 6361 6c63 5f6f  cheduler._calc_o
+00006d90: 6363 7570 616e 6379 280a 2020 2020 2020  ccupancy(.      
+00006da0: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+00006db0: 7072 6566 6978 5f63 6f75 6e74 2c20 7365  prefix_count, se
+00006dc0: 6c66 2e5f 6e65 7477 6f72 6b5f 6f63 630a  lf._network_occ.
+00006dd0: 2020 2020 2020 2020 290a 0a0a 4064 6174          )...@dat
+00006de0: 6163 6c61 7373 6573 2e64 6174 6163 6c61  aclasses.datacla
+00006df0: 7373 0a63 6c61 7373 2045 7272 6564 5461  ss.class ErredTa
+00006e00: 736b 3a0a 2020 2020 2222 224c 6967 6874  sk:.    """Light
+00006e10: 7765 6967 6874 2072 6570 7265 7365 6e74  weight represent
+00006e20: 6174 696f 6e20 6f66 2061 6e20 6572 7265  ation of an erre
+00006e30: 6420 7461 736b 2077 6974 686f 7574 2061  d task without a
+00006e40: 6e79 2064 6570 656e 6465 6e63 7920 696e  ny dependency in
+00006e50: 666f 726d 6174 696f 6e0a 2020 2020 6f72  formation.    or
+00006e60: 2072 756e 7370 6563 2e0a 0a20 2020 2053   runspec...    S
+00006e70: 6565 2061 6c73 6f0a 2020 2020 2d2d 2d2d  ee also.    ----
+00006e80: 2d2d 2d2d 0a20 2020 2054 6173 6b53 7461  ----.    TaskSta
+00006e90: 7465 0a20 2020 2022 2222 0a0a 2020 2020  te.    """..    
+00006ea0: 6b65 793a 2048 6173 6861 626c 650a 2020  key: Hashable.  
+00006eb0: 2020 7469 6d65 7374 616d 703a 2066 6c6f    timestamp: flo
+00006ec0: 6174 0a20 2020 2065 7272 6564 5f6f 6e3a  at.    erred_on:
+00006ed0: 2073 6574 5b73 7472 5d0a 2020 2020 6578   set[str].    ex
+00006ee0: 6365 7074 696f 6e5f 7465 7874 3a20 7374  ception_text: st
+00006ef0: 720a 2020 2020 7472 6163 6562 6163 6b5f  r.    traceback_
+00006f00: 7465 7874 3a20 7374 720a 0a0a 636c 6173  text: str...clas
+00006f10: 7320 436f 6d70 7574 6174 696f 6e3a 0a20  s Computation:. 
+00006f20: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
+00006f30: 2074 7261 636b 696e 6720 6120 7369 6e67   tracking a sing
+00006f40: 6c65 2063 6f6d 7075 7465 206f 7220 7065  le compute or pe
+00006f50: 7273 6973 7420 6361 6c6c 0a0a 2020 2020  rsist call..    
+00006f60: 5365 6520 616c 736f 0a20 2020 202d 2d2d  See also.    ---
+00006f70: 2d2d 2d2d 2d0a 2020 2020 5461 736b 5072  -----.    TaskPr
+00006f80: 6566 6978 0a20 2020 2054 6173 6b47 726f  efix.    TaskGro
+00006f90: 7570 0a20 2020 2054 6173 6b53 7461 7465  up.    TaskState
+00006fa0: 0a20 2020 2022 2222 0a0a 2020 2020 7374  .    """..    st
+00006fb0: 6172 743a 2066 6c6f 6174 0a20 2020 2067  art: float.    g
+00006fc0: 726f 7570 733a 2073 6574 5b54 6173 6b47  roups: set[TaskG
+00006fd0: 726f 7570 5d0a 2020 2020 636f 6465 3a20  roup].    code: 
+00006fe0: 536f 7274 6564 5365 745b 536f 7572 6365  SortedSet[Source
+00006ff0: 436f 6465 5d0a 2020 2020 6964 3a20 7575  Code].    id: uu
+00007000: 6964 2e55 5549 440a 2020 2020 616e 6e6f  id.UUID.    anno
+00007010: 7461 7469 6f6e 733a 2064 6963 740a 0a20  tations: dict.. 
+00007020: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+00007030: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+00007040: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00007050: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00007060: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
+00007070: 7420 3d20 7469 6d65 2829 0a20 2020 2020  t = time().     
+00007080: 2020 2073 656c 662e 6772 6f75 7073 203d     self.groups =
+00007090: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+000070a0: 656c 662e 636f 6465 203d 2053 6f72 7465  elf.code = Sorte
+000070b0: 6453 6574 2829 0a20 2020 2020 2020 2073  dSet().        s
+000070c0: 656c 662e 6964 203d 2075 7569 642e 7575  elf.id = uuid.uu
+000070d0: 6964 3428 290a 2020 2020 2020 2020 7365  id4().        se
+000070e0: 6c66 2e61 6e6e 6f74 6174 696f 6e73 203d  lf.annotations =
+000070f0: 207b 7d0a 0a20 2020 2040 7072 6f70 6572   {}..    @proper
+00007100: 7479 0a20 2020 2064 6566 2073 746f 7028  ty.    def stop(
+00007110: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
+00007120: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00007130: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
+00007140: 2020 2020 7265 7475 726e 206d 6178 2874      return max(t
+00007150: 672e 7374 6f70 2066 6f72 2074 6720 696e  g.stop for tg in
+00007160: 2073 656c 662e 6772 6f75 7073 290a 2020   self.groups).  
+00007170: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007180: 2020 2020 2020 2020 7265 7475 726e 202d          return -
+00007190: 310a 0a20 2020 2040 7072 6f70 6572 7479  1..    @property
+000071a0: 0a20 2020 2064 6566 2073 7461 7465 7328  .    def states(
+000071b0: 7365 6c66 2920 2d3e 2064 6963 745b 5461  self) -> dict[Ta
+000071c0: 736b 5374 6174 6553 7461 7465 2c20 696e  skStateState, in
+000071d0: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
+000071e0: 726e 206d 6572 6765 5f77 6974 6828 7375  rn merge_with(su
+000071f0: 6d2c 2028 7467 2e73 7461 7465 7320 666f  m, (tg.states fo
+00007200: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
+00007210: 7570 7329 290a 0a20 2020 2064 6566 205f  ups))..    def _
+00007220: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
+00007230: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00007240: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00007250: 2020 2066 223c 436f 6d70 7574 6174 696f     f"<Computatio
+00007260: 6e20 7b73 656c 662e 6964 7d3a 2022 0a20  n {self.id}: ". 
+00007270: 2020 2020 2020 2020 2020 202b 2022 5461             + "Ta
+00007280: 736b 733a 2022 0a20 2020 2020 2020 2020  sks: ".         
+00007290: 2020 202b 2022 2c20 222e 6a6f 696e 280a     + ", ".join(.
+000072a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072b0: 2225 733a 2025 6422 2025 2028 6b2c 2076  "%s: %d" % (k, v
+000072c0: 2920 666f 7220 286b 2c20 7629 2069 6e20  ) for (k, v) in 
+000072d0: 736f 7274 6564 2873 656c 662e 7374 6174  sorted(self.stat
+000072e0: 6573 2e69 7465 6d73 2829 2920 6966 2076  es.items()) if v
+000072f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00007300: 2020 2020 2020 2020 2020 202b 2022 3e22             + ">"
+00007310: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00007320: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
+00007330: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00007340: 2020 2020 2020 7265 7475 726e 2067 6574        return get
+00007350: 5f74 656d 706c 6174 6528 2263 6f6d 7075  _template("compu
+00007360: 7461 7469 6f6e 2e68 746d 6c2e 6a32 2229  tation.html.j2")
+00007370: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
+00007380: 2020 2020 2069 643d 7365 6c66 2e69 642c       id=self.id,
+00007390: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000073a0: 7274 3d73 656c 662e 7374 6172 742c 0a20  rt=self.start,. 
+000073b0: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
+000073c0: 7365 6c66 2e73 746f 702c 0a20 2020 2020  self.stop,.     
+000073d0: 2020 2020 2020 2067 726f 7570 733d 7365         groups=se
+000073e0: 6c66 2e67 726f 7570 732c 0a20 2020 2020  lf.groups,.     
+000073f0: 2020 2020 2020 2073 7461 7465 733d 7365         states=se
+00007400: 6c66 2e73 7461 7465 732c 0a20 2020 2020  lf.states,.     
+00007410: 2020 2020 2020 2063 6f64 653d 7365 6c66         code=self
+00007420: 2e63 6f64 652c 0a20 2020 2020 2020 2029  .code,.        )
+00007430: 0a0a 0a63 6c61 7373 2054 6173 6b50 7265  ...class TaskPre
+00007440: 6669 783a 0a20 2020 2022 2222 436f 6c6c  fix:.    """Coll
+00007450: 6563 7469 6f6e 2074 7261 636b 696e 6720  ection tracking 
+00007460: 616c 6c20 7461 736b 7320 7769 7468 696e  all tasks within
+00007470: 2061 2067 726f 7570 0a0a 2020 2020 4b65   a group..    Ke
+00007480: 7973 206f 6674 656e 2068 6176 6520 6120  ys often have a 
+00007490: 7374 7275 6374 7572 6520 6c69 6b65 2060  structure like `
+000074a0: 6028 2278 2d31 3233 222c 2030 2960 600a  `("x-123", 0)``.
+000074b0: 2020 2020 4120 6772 6f75 7020 7461 6b65      A group take
+000074c0: 7320 7468 6520 6669 7273 7420 7365 6374  s the first sect
+000074d0: 696f 6e2c 206c 696b 6520 6060 2278 2260  ion, like ``"x"`
+000074e0: 600a 0a20 2020 2053 6565 2041 6c73 6f0a  `..    See Also.
+000074f0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00007500: 2054 6173 6b47 726f 7570 0a20 2020 2022   TaskGroup.    "
+00007510: 2222 0a0a 2020 2020 233a 2054 6865 206e  ""..    #: The n
+00007520: 616d 6520 6f66 2061 2067 726f 7570 206f  ame of a group o
+00007530: 6620 7461 736b 732e 0a20 2020 2023 3a20  f tasks..    #: 
+00007540: 466f 7220 6120 7461 736b 206c 696b 6520  For a task like 
+00007550: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
+00007560: 2074 6869 7320 6973 2074 6865 2074 6578   this is the tex
+00007570: 7420 6060 2278 2260 600a 2020 2020 6e61  t ``"x"``.    na
+00007580: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
+00007590: 416e 2065 7870 6f6e 656e 7469 616c 6c79  An exponentially
+000075a0: 2077 6569 6768 7465 6420 6d6f 7669 6e67   weighted moving
+000075b0: 2061 7665 7261 6765 2064 7572 6174 696f   average duratio
+000075c0: 6e20 6f66 2061 6c6c 2074 6173 6b73 2077  n of all tasks w
+000075d0: 6974 6820 7468 6973 2070 7265 6669 780a  ith this prefix.
+000075e0: 2020 2020 6475 7261 7469 6f6e 5f61 7665      duration_ave
+000075f0: 7261 6765 3a20 666c 6f61 740a 0a20 2020  rage: float..   
+00007600: 2023 3a20 4e75 6d62 6572 7320 6f66 2074   #: Numbers of t
+00007610: 696d 6573 2061 2074 6173 6b20 7761 7320  imes a task was 
+00007620: 6d61 726b 6564 2061 7320 7375 7370 6963  marked as suspic
+00007630: 696f 7573 2077 6974 6820 7468 6973 2070  ious with this p
+00007640: 7265 6669 780a 2020 2020 7375 7370 6963  refix.    suspic
+00007650: 696f 7573 3a20 696e 740a 0a20 2020 2023  ious: int..    #
+00007660: 3a20 5374 6f72 6520 7469 6d69 6e67 7320  : Store timings 
+00007670: 666f 7220 6561 6368 2070 7265 6669 782d  for each prefix-
+00007680: 6163 7469 6f6e 0a20 2020 2061 6c6c 5f64  action.    all_d
+00007690: 7572 6174 696f 6e73 3a20 6465 6661 756c  urations: defaul
+000076a0: 7464 6963 745b 7374 722c 2066 6c6f 6174  tdict[str, float
+000076b0: 5d0a 0a20 2020 2023 3a20 5468 6973 206d  ]..    #: This m
+000076c0: 6561 7375 7265 7320 7468 6520 6d61 7869  easures the maxi
+000076d0: 6d75 6d20 7265 636f 7264 6564 206c 6976  mum recorded liv
+000076e0: 6520 6578 6563 7574 696f 6e20 7469 6d65  e execution time
+000076f0: 2061 6e64 2063 616e 2062 6520 7573 6564   and can be used
+00007700: 2074 6f0a 2020 2020 233a 2064 6574 6563   to.    #: detec
+00007710: 7420 6f75 746c 6965 7273 0a20 2020 206d  t outliers.    m
+00007720: 6178 5f65 7865 635f 7469 6d65 3a20 666c  ax_exec_time: fl
+00007730: 6f61 740a 0a20 2020 2023 3a20 5461 736b  oat..    #: Task
+00007740: 2067 726f 7570 7320 6173 736f 6369 6174   groups associat
+00007750: 6564 2074 6f20 7468 6973 2070 7265 6669  ed to this prefi
+00007760: 780a 2020 2020 6772 6f75 7073 3a20 6c69  x.    groups: li
+00007770: 7374 5b54 6173 6b47 726f 7570 5d0a 0a20  st[TaskGroup].. 
+00007780: 2020 2023 3a20 4163 6375 6d75 6c61 7465     #: Accumulate
+00007790: 2063 6f75 6e74 206f 6620 6e75 6d62 6572   count of number
+000077a0: 206f 6620 7461 736b 7320 696e 2065 6163   of tasks in eac
+000077b0: 6820 7374 6174 650a 2020 2020 7374 6174  h state.    stat
+000077c0: 655f 636f 756e 7473 3a20 6465 6661 756c  e_counts: defaul
+000077d0: 7464 6963 745b 5461 736b 5374 6174 6553  tdict[TaskStateS
+000077e0: 7461 7465 2c20 696e 745d 0a0a 2020 2020  tate, int]..    
+000077f0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+00007800: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+00007810: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+00007820: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
+00007830: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
+00007840: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+00007850: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+00007860: 7570 7320 3d20 5b5d 0a20 2020 2020 2020  ups = [].       
+00007870: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00007880: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
+00007890: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+000078a0: 2073 656c 662e 7374 6174 655f 636f 756e   self.state_coun
+000078b0: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
+000078c0: 2869 6e74 290a 2020 2020 2020 2020 7461  (int).        ta
+000078d0: 736b 5f64 7572 6174 696f 6e73 203d 2064  sk_durations = d
+000078e0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+000078f0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+00007900: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
+00007910: 736b 2d64 7572 6174 696f 6e73 2229 0a20  sk-durations"). 
+00007920: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+00007930: 616d 6520 696e 2074 6173 6b5f 6475 7261  ame in task_dura
+00007940: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00007950: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
+00007960: 5f61 7665 7261 6765 203d 2070 6172 7365  _average = parse
+00007970: 5f74 696d 6564 656c 7461 2874 6173 6b5f  _timedelta(task_
+00007980: 6475 7261 7469 6f6e 735b 7365 6c66 2e6e  durations[self.n
+00007990: 616d 655d 290a 2020 2020 2020 2020 656c  ame]).        el
+000079a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000079b0: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+000079c0: 6572 6167 6520 3d20 2d31 0a20 2020 2020  erage = -1.     
+000079d0: 2020 2073 656c 662e 6d61 785f 6578 6563     self.max_exec
+000079e0: 5f74 696d 6520 3d20 2d31 0a20 2020 2020  _time = -1.     
+000079f0: 2020 2073 656c 662e 7375 7370 6963 696f     self.suspicio
+00007a00: 7573 203d 2030 0a0a 2020 2020 6465 6620  us = 0..    def 
+00007a10: 6164 645f 6578 6563 5f74 696d 6528 7365  add_exec_time(se
+00007a20: 6c66 2c20 6475 7261 7469 6f6e 3a20 666c  lf, duration: fl
+00007a30: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
+00007a40: 2020 2020 2020 7365 6c66 2e6d 6178 5f65        self.max_e
+00007a50: 7865 635f 7469 6d65 203d 206d 6178 2864  xec_time = max(d
+00007a60: 7572 6174 696f 6e2c 2073 656c 662e 6d61  uration, self.ma
+00007a70: 785f 6578 6563 5f74 696d 6529 0a20 2020  x_exec_time).   
+00007a80: 2020 2020 2069 6620 6475 7261 7469 6f6e       if duration
+00007a90: 203e 2032 202a 2073 656c 662e 6475 7261   > 2 * self.dura
+00007aa0: 7469 6f6e 5f61 7665 7261 6765 3a0a 2020  tion_average:.  
+00007ab0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00007ac0: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
+00007ad0: 3d20 2d31 0a0a 2020 2020 6465 6620 6164  = -1..    def ad
+00007ae0: 645f 6475 7261 7469 6f6e 2873 656c 662c  d_duration(self,
+00007af0: 2061 6374 696f 6e3a 2073 7472 2c20 7374   action: str, st
+00007b00: 6172 743a 2066 6c6f 6174 2c20 7374 6f70  art: float, stop
+00007b10: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
+00007b20: 3a0a 2020 2020 2020 2020 6475 7261 7469  :.        durati
+00007b30: 6f6e 203d 2073 746f 7020 2d20 7374 6172  on = stop - star
+00007b40: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
+00007b50: 6c6c 5f64 7572 6174 696f 6e73 5b61 6374  ll_durations[act
+00007b60: 696f 6e5d 202b 3d20 6475 7261 7469 6f6e  ion] += duration
+00007b70: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
+00007b80: 6f6e 203d 3d20 2263 6f6d 7075 7465 223a  on == "compute":
+00007b90: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
+00007ba0: 203d 2073 656c 662e 6475 7261 7469 6f6e   = self.duration
+00007bb0: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+00007bc0: 2020 2020 2069 6620 6f6c 6420 3c20 303a       if old < 0:
+00007bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007be0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007bf0: 7665 7261 6765 203d 2064 7572 6174 696f  verage = duratio
+00007c00: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+00007c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007c20: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
+00007c30: 6e5f 6176 6572 6167 6520 3d20 302e 3520  n_average = 0.5 
+00007c40: 2a20 6475 7261 7469 6f6e 202b 2030 2e35  * duration + 0.5
+00007c50: 202a 206f 6c64 0a0a 2020 2020 4070 726f   * old..    @pro
+00007c60: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
+00007c70: 6174 6573 2873 656c 6629 202d 3e20 6469  ates(self) -> di
+00007c80: 6374 5b73 7472 2c20 696e 745d 3a0a 2020  ct[str, int]:.  
+00007c90: 2020 2020 2020 2222 2254 6865 206e 756d        """The num
+00007ca0: 6265 7220 6f66 2074 6173 6b73 2069 6e20  ber of tasks in 
+00007cb0: 6561 6368 2073 7461 7465 2c0a 2020 2020  each state,.    
+00007cc0: 2020 2020 6c69 6b65 2060 607b 226d 656d      like ``{"mem
+00007cd0: 6f72 7922 3a20 3130 2c20 2270 726f 6365  ory": 10, "proce
+00007ce0: 7373 696e 6722 3a20 332c 2022 7265 6c65  ssing": 3, "rele
+00007cf0: 6173 6564 223a 2034 2c20 2e2e 2e7d 6060  ased": 4, ...}``
+00007d00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00007d10: 2020 2020 2072 6574 7572 6e20 6d65 7267       return merg
+00007d20: 655f 7769 7468 2873 756d 2c20 5b74 672e  e_with(sum, [tg.
+00007d30: 7374 6174 6573 2066 6f72 2074 6720 696e  states for tg in
+00007d40: 2073 656c 662e 6772 6f75 7073 5d29 0a0a   self.groups])..
+00007d50: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00007d60: 2020 6465 6620 6163 7469 7665 2873 656c    def active(sel
+00007d70: 6629 202d 3e20 6c69 7374 5b54 6173 6b47  f) -> list[TaskG
+00007d80: 726f 7570 5d3a 0a20 2020 2020 2020 2072  roup]:.        r
+00007d90: 6574 7572 6e20 5b0a 2020 2020 2020 2020  eturn [.        
+00007da0: 2020 2020 7467 0a20 2020 2020 2020 2020      tg.         
+00007db0: 2020 2066 6f72 2074 6720 696e 2073 656c     for tg in sel
+00007dc0: 662e 6772 6f75 7073 0a20 2020 2020 2020  f.groups.       
+00007dd0: 2020 2020 2069 6620 616e 7928 6b20 213d       if any(k !=
+00007de0: 2022 666f 7267 6f74 7465 6e22 2061 6e64   "forgotten" and
+00007df0: 2076 2021 3d20 3020 666f 7220 6b2c 2076   v != 0 for k, v
+00007e00: 2069 6e20 7467 2e73 7461 7465 732e 6974   in tg.states.it
+00007e10: 656d 7328 2929 0a20 2020 2020 2020 205d  ems()).        ]
+00007e20: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00007e30: 2020 2020 6465 6620 6163 7469 7665 5f73      def active_s
+00007e40: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
+00007e50: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+00007e60: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
+00007e70: 7267 655f 7769 7468 2873 756d 2c20 5b74  rge_with(sum, [t
+00007e80: 672e 7374 6174 6573 2066 6f72 2074 6720  g.states for tg 
+00007e90: 696e 2073 656c 662e 6163 7469 7665 5d29  in self.active])
+00007ea0: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00007eb0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+00007ec0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007ed0: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
+00007ee0: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+00007ef0: 7365 6c66 2e6e 616d 650a 2020 2020 2020  self.name.      
+00007f00: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
+00007f10: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
+00007f20: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00007f30: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
+00007f40: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
+00007f50: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
+00007f60: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
+00007f70: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
+00007f80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007f90: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
+00007fa0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00007fb0: 2020 2020 6465 6620 6e62 7974 6573 5f74      def nbytes_t
+00007fc0: 6f74 616c 2873 656c 6629 202d 3e20 696e  otal(self) -> in
+00007fd0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+00007fe0: 6e20 7375 6d28 7467 2e6e 6279 7465 735f  n sum(tg.nbytes_
+00007ff0: 746f 7461 6c20 666f 7220 7467 2069 6e20  total for tg in 
+00008000: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
+00008010: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
+00008020: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00008030: 2020 2020 7265 7475 726e 2073 756d 286d      return sum(m
+00008040: 6170 286c 656e 2c20 7365 6c66 2e67 726f  ap(len, self.gro
+00008050: 7570 7329 290a 0a20 2020 2040 7072 6f70  ups))..    @prop
+00008060: 6572 7479 0a20 2020 2064 6566 2064 7572  erty.    def dur
+00008070: 6174 696f 6e28 7365 6c66 2920 2d3e 2066  ation(self) -> f
+00008080: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
+00008090: 7475 726e 2073 756d 2874 672e 6475 7261  turn sum(tg.dura
+000080a0: 7469 6f6e 2066 6f72 2074 6720 696e 2073  tion for tg in s
+000080b0: 656c 662e 6772 6f75 7073 290a 0a20 2020  elf.groups)..   
+000080c0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000080d0: 6566 2074 7970 6573 2873 656c 6629 202d  ef types(self) -
+000080e0: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
+000080f0: 2020 2020 7265 7475 726e 207b 7479 7020      return {typ 
+00008100: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
+00008110: 726f 7570 7320 666f 7220 7479 7020 696e  roups for typ in
+00008120: 2074 672e 7479 7065 737d 0a0a 0a63 6c61   tg.types}...cla
+00008130: 7373 2054 6173 6b47 726f 7570 3a0a 2020  ss TaskGroup:.  
+00008140: 2020 2222 2243 6f6c 6c65 6374 696f 6e20    """Collection 
+00008150: 7472 6163 6b69 6e67 2061 6c6c 2074 6173  tracking all tas
+00008160: 6b73 2077 6974 6869 6e20 6120 6772 6f75  ks within a grou
+00008170: 700a 0a20 2020 204b 6579 7320 6f66 7465  p..    Keys ofte
+00008180: 6e20 6861 7665 2061 2073 7472 7563 7475  n have a structu
+00008190: 7265 206c 696b 6520 6060 2822 782d 3132  re like ``("x-12
+000081a0: 3322 2c20 3029 6060 0a20 2020 2041 2067  3", 0)``.    A g
+000081b0: 726f 7570 2074 616b 6573 2074 6865 2066  roup takes the f
+000081c0: 6972 7374 2073 6563 7469 6f6e 2c20 6c69  irst section, li
+000081d0: 6b65 2060 6022 782d 3132 3322 6060 0a0a  ke ``"x-123"``..
+000081e0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+000081f0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
+00008200: 736b 5072 6566 6978 0a20 2020 2022 2222  skPrefix.    """
+00008210: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
+00008220: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
+00008230: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
+00008240: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
+00008250: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
+00008260: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
+00008270: 6060 2278 2d31 3233 2260 600a 2020 2020  ``"x-123"``.    
+00008280: 6e61 6d65 3a20 7374 720a 0a20 2020 2023  name: str..    #
+00008290: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
+000082a0: 7461 736b 7320 696e 2065 6163 6820 7374  tasks in each st
+000082b0: 6174 652c 0a20 2020 2023 3a20 6c69 6b65  ate,.    #: like
+000082c0: 2060 607b 226d 656d 6f72 7922 3a20 3130   ``{"memory": 10
+000082d0: 2c20 2270 726f 6365 7373 696e 6722 3a20  , "processing": 
+000082e0: 332c 2022 7265 6c65 6173 6564 223a 2034  3, "released": 4
+000082f0: 2c20 2e2e 2e7d 6060 0a20 2020 2073 7461  , ...}``.    sta
+00008300: 7465 733a 2064 6963 745b 5461 736b 5374  tes: dict[TaskSt
+00008310: 6174 6553 7461 7465 2c20 696e 745d 0a0a  ateState, int]..
+00008320: 2020 2020 233a 2054 6865 206f 7468 6572      #: The other
+00008330: 2054 6173 6b47 726f 7570 7320 6f6e 2077   TaskGroups on w
+00008340: 6869 6368 2074 6869 7320 6f6e 6520 6465  hich this one de
+00008350: 7065 6e64 730a 2020 2020 6465 7065 6e64  pends.    depend
+00008360: 656e 6369 6573 3a20 7365 745b 5461 736b  encies: set[Task
+00008370: 4772 6f75 705d 0a0a 2020 2020 233a 2054  Group]..    #: T
+00008380: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
+00008390: 6f66 2062 7974 6573 2074 6861 7420 7468  of bytes that th
+000083a0: 6973 2074 6173 6b20 6772 6f75 7020 6861  is task group ha
+000083b0: 7320 7072 6f64 7563 6564 0a20 2020 206e  s produced.    n
+000083c0: 6279 7465 735f 746f 7461 6c3a 2069 6e74  bytes_total: int
+000083d0: 0a0a 2020 2020 233a 2054 6865 2074 6f74  ..    #: The tot
+000083e0: 616c 2061 6d6f 756e 7420 6f66 2074 696d  al amount of tim
+000083f0: 6520 7370 656e 7420 6f6e 2061 6c6c 2074  e spent on all t
+00008400: 6173 6b73 2069 6e20 7468 6973 2054 6173  asks in this Tas
+00008410: 6b47 726f 7570 0a20 2020 2064 7572 6174  kGroup.    durat
+00008420: 696f 6e3a 2066 6c6f 6174 0a0a 2020 2020  ion: float..    
+00008430: 233a 2054 6865 2072 6573 756c 7420 7479  #: The result ty
+00008440: 7065 7320 6f66 2074 6869 7320 5461 736b  pes of this Task
+00008450: 4772 6f75 700a 2020 2020 7479 7065 733a  Group.    types:
+00008460: 2073 6574 5b73 7472 5d0a 0a20 2020 2023   set[str]..    #
+00008470: 3a20 5468 6520 776f 726b 6572 206d 6f73  : The worker mos
+00008480: 7420 7265 6365 6e74 6c79 2061 7373 6967  t recently assig
+00008490: 6e65 6420 6120 7461 736b 2066 726f 6d20  ned a task from 
+000084a0: 7468 6973 2067 726f 7570 2c20 6f72 204e  this group, or N
+000084b0: 6f6e 6520 7768 656e 2074 6865 2067 726f  one when the gro
+000084c0: 7570 0a20 2020 2023 3a20 6973 206e 6f74  up.    #: is not
+000084d0: 2069 6465 6e74 6966 6965 6420 746f 2062   identified to b
+000084e0: 6520 726f 6f74 2d6c 696b 6520 6279 2060  e root-like by `
+000084f0: 5363 6865 6475 6c65 7253 7461 7465 2e64  SchedulerState.d
+00008500: 6563 6964 655f 776f 726b 6572 602e 0a20  ecide_worker`.. 
+00008510: 2020 206c 6173 745f 776f 726b 6572 3a20     last_worker: 
+00008520: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00008530: 6e65 0a0a 2020 2020 233a 2049 6620 606c  ne..    #: If `l
+00008540: 6173 745f 776f 726b 6572 6020 6973 206e  ast_worker` is n
+00008550: 6f74 204e 6f6e 652c 2074 6865 206e 756d  ot None, the num
+00008560: 6265 7220 6f66 2074 696d 6573 2074 6861  ber of times tha
+00008570: 7420 776f 726b 6572 2073 686f 756c 6420  t worker should 
+00008580: 6265 2061 7373 6967 6e65 640a 2020 2020  be assigned.    
+00008590: 233a 2073 7562 7365 7175 656e 7420 7461  #: subsequent ta
+000085a0: 736b 7320 756e 7469 6c20 6120 6e65 7720  sks until a new 
+000085b0: 776f 726b 6572 2069 7320 6368 6f73 656e  worker is chosen
+000085c0: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
+000085d0: 725f 7461 736b 735f 6c65 6674 3a20 696e  r_tasks_left: in
+000085e0: 740a 0a20 2020 2070 7265 6669 783a 2054  t..    prefix: T
+000085f0: 6173 6b50 7265 6669 7820 7c20 4e6f 6e65  askPrefix | None
+00008600: 0a0a 2020 2020 233a 2045 6172 6c69 6573  ..    #: Earlies
+00008610: 7420 7469 6d65 2077 6865 6e20 6120 7461  t time when a ta
+00008620: 736b 2062 656c 6f6e 6769 6e67 2074 6f20  sk belonging to 
+00008630: 7468 6973 2067 726f 7570 2073 7461 7274  this group start
+00008640: 6564 2063 6f6d 7075 7469 6e67 3b0a 2020  ed computing;.  
+00008650: 2020 233a 2030 2069 6620 6e6f 2074 6173    #: 0 if no tas
+00008660: 6b20 6861 7320 2a66 696e 6973 6865 642a  k has *finished*
+00008670: 2063 6f6d 7075 7469 6e67 2079 6574 0a20   computing yet. 
+00008680: 2020 2023 3a0a 2020 2020 233a 204e 6f74     #:.    #: Not
+00008690: 6573 0a20 2020 2023 3a20 2d2d 2d2d 2d0a  es.    #: -----.
+000086a0: 2020 2020 233a 2054 6869 7320 6973 206e      #: This is n
+000086b0: 6f74 2075 7064 6174 6564 2075 6e74 696c  ot updated until
+000086c0: 2061 7420 6c65 6173 7420 6f6e 6520 7461   at least one ta
+000086d0: 736b 2068 6173 202a 6669 6e69 7368 6564  sk has *finished
+000086e0: 2a20 636f 6d70 7574 696e 672e 0a20 2020  * computing..   
+000086f0: 2023 3a20 4974 2063 6f75 6c64 206d 6f76   #: It could mov
+00008700: 6520 6261 636b 7761 7264 7320 6173 2074  e backwards as t
+00008710: 6173 6b73 2063 6f6d 706c 6574 652e 0a20  asks complete.. 
+00008720: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
+00008730: 0a20 2020 2023 3a20 4c61 7465 7374 2074  .    #: Latest t
+00008740: 696d 6520 7768 656e 2061 2074 6173 6b20  ime when a task 
+00008750: 6265 6c6f 6e67 696e 6720 746f 2074 6869  belonging to thi
+00008760: 7320 6772 6f75 7020 6669 6e69 7368 6564  s group finished
+00008770: 2063 6f6d 7075 7469 6e67 2c0a 2020 2020   computing,.    
+00008780: 233a 2030 2069 6620 6e6f 2074 6173 6b20  #: 0 if no task 
+00008790: 6861 7320 6669 6e69 7368 6564 2063 6f6d  has finished com
+000087a0: 7075 7469 6e67 2079 6574 0a20 2020 2073  puting yet.    s
+000087b0: 746f 703a 2066 6c6f 6174 0a0a 2020 2020  top: float..    
+000087c0: 233a 2043 756d 756c 6174 6976 6520 6475  #: Cumulative du
+000087d0: 7261 7469 6f6e 206f 6620 616c 6c20 636f  ration of all co
+000087e0: 6d70 6c65 7465 6420 6163 7469 6f6e 732c  mpleted actions,
+000087f0: 2062 7920 6163 7469 6f6e 0a20 2020 2061   by action.    a
+00008800: 6c6c 5f64 7572 6174 696f 6e73 3a20 6465  ll_durations: de
+00008810: 6661 756c 7464 6963 745b 7374 722c 2066  faultdict[str, f
+00008820: 6c6f 6174 5d0a 0a20 2020 2023 3a20 5370  loat]..    #: Sp
+00008830: 616e 2049 4420 2873 6565 2060 6064 6973  an ID (see ``dis
+00008840: 7472 6962 7574 6564 2e73 7061 6e73 6060  tributed.spans``
+00008850: 292e 0a20 2020 2023 3a20 4d61 7463 6865  )..    #: Matche
+00008860: 7320 6060 6469 7374 7269 6275 7465 642e  s ``distributed.
+00008870: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
+00008880: 6869 6e65 2e54 6173 6b53 7461 7465 2e73  hine.TaskState.s
+00008890: 7061 6e5f 6964 6060 2e0a 2020 2020 233a  pan_id``..    #:
+000088a0: 2049 7420 6973 2070 6f73 7369 626c 6520   It is possible 
+000088b0: 746f 2065 6e64 2075 7020 696e 2073 6974  to end up in sit
+000088c0: 7561 7469 6f6e 2077 6865 7265 2064 6966  uation where dif
+000088d0: 6665 7265 6e74 2074 6173 6b73 206f 6620  ferent tasks of 
+000088e0: 7468 6520 7361 6d65 2054 6173 6b47 726f  the same TaskGro
+000088f0: 7570 0a20 2020 2023 3a20 6265 6c6f 6e67  up.    #: belong
+00008900: 2074 6f20 6469 6666 6572 656e 7420 7370   to different sp
+00008910: 616e 733b 2074 6865 2070 7572 706f 7365  ans; the purpose
+00008920: 206f 6620 7468 6973 2061 7474 7269 6275   of this attribu
+00008930: 7465 2069 7320 746f 2061 7262 6974 7261  te is to arbitra
+00008940: 7269 6c79 2066 6f72 6365 0a20 2020 2023  rily force.    #
+00008950: 3a20 6576 6572 7974 6869 6e67 206f 6e74  : everything ont
+00008960: 6f20 7468 6520 6561 726c 6965 7374 2065  o the earliest e
+00008970: 6e63 6f75 6e74 6572 6564 206f 6e65 2e0a  ncountered one..
+00008980: 2020 2020 7370 616e 5f69 643a 2073 7472      span_id: str
+00008990: 207c 204e 6f6e 650a 0a20 2020 205f 5f73   | None..    __s
+000089a0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+000089b0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+000089c0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000089d0: 5f28 7365 6c66 2c20 6e61 6d65 3a20 7374  _(self, name: st
+000089e0: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
+000089f0: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
+00008a00: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
+00008a10: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00008a20: 7365 6c66 2e73 7461 7465 7320 3d20 6469  self.states = di
+00008a30: 6374 2e66 726f 6d6b 6579 7328 414c 4c5f  ct.fromkeys(ALL_
+00008a40: 5441 534b 5f53 5441 5445 532c 2030 290a  TASK_STATES, 0).
+00008a50: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
+00008a60: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
+00008a70: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00008a80: 6279 7465 735f 746f 7461 6c20 3d20 300a  bytes_total = 0.
+00008a90: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
+00008aa0: 6174 696f 6e20 3d20 300a 2020 2020 2020  ation = 0.      
+00008ab0: 2020 7365 6c66 2e74 7970 6573 203d 2073    self.types = s
+00008ac0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00008ad0: 662e 7374 6172 7420 3d20 302e 300a 2020  f.start = 0.0.  
+00008ae0: 2020 2020 2020 7365 6c66 2e73 746f 7020        self.stop 
+00008af0: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
+00008b00: 6c66 2e61 6c6c 5f64 7572 6174 696f 6e73  lf.all_durations
+00008b10: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+00008b20: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
+00008b30: 6c66 2e6c 6173 745f 776f 726b 6572 203d  lf.last_worker =
+00008b40: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+00008b50: 6c66 2e6c 6173 745f 776f 726b 6572 5f74  lf.last_worker_t
+00008b60: 6173 6b73 5f6c 6566 7420 3d20 300a 2020  asks_left = 0.  
+00008b70: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
+00008b80: 6964 203d 204e 6f6e 650a 0a20 2020 2064  id = None..    d
+00008b90: 6566 2061 6464 5f64 7572 6174 696f 6e28  ef add_duration(
+00008ba0: 7365 6c66 2c20 6163 7469 6f6e 3a20 7374  self, action: st
+00008bb0: 722c 2073 7461 7274 3a20 666c 6f61 742c  r, start: float,
+00008bc0: 2073 746f 703a 2066 6c6f 6174 2920 2d3e   stop: float) ->
+00008bd0: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
+00008be0: 7572 6174 696f 6e20 3d20 7374 6f70 202d  uration = stop -
+00008bf0: 2073 7461 7274 0a20 2020 2020 2020 2073   start.        s
+00008c00: 656c 662e 6475 7261 7469 6f6e 202b 3d20  elf.duration += 
+00008c10: 6475 7261 7469 6f6e 0a20 2020 2020 2020  duration.       
+00008c20: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00008c30: 6f6e 735b 6163 7469 6f6e 5d20 2b3d 2064  ons[action] += d
+00008c40: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+00008c50: 6966 2061 6374 696f 6e20 3d3d 2022 636f  if action == "co
+00008c60: 6d70 7574 6522 3a0a 2020 2020 2020 2020  mpute":.        
+00008c70: 2020 2020 6966 2073 656c 662e 7374 6f70      if self.stop
+00008c80: 203c 2073 746f 703a 0a20 2020 2020 2020   < stop:.       
+00008c90: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+00008ca0: 6f70 203d 2073 746f 700a 2020 2020 2020  op = stop.      
+00008cb0: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00008cc0: 6172 7420 3d3d 2030 2e30 206f 7220 7365  art == 0.0 or se
+00008cd0: 6c66 2e73 7461 7274 203e 2073 7461 7274  lf.start > start
+00008ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008cf0: 2020 7365 6c66 2e73 7461 7274 203d 2073    self.start = s
+00008d00: 7461 7274 0a20 2020 2020 2020 2061 7373  tart.        ass
+00008d10: 6572 7420 7365 6c66 2e70 7265 6669 7820  ert self.prefix 
+00008d20: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00008d30: 2020 2020 7365 6c66 2e70 7265 6669 782e      self.prefix.
+00008d40: 6164 645f 6475 7261 7469 6f6e 2861 6374  add_duration(act
+00008d50: 696f 6e2c 2073 7461 7274 2c20 7374 6f70  ion, start, stop
+00008d60: 290a 0a20 2020 2064 6566 2061 6464 2873  )..    def add(s
+00008d70: 656c 662c 206f 7468 6572 3a20 5461 736b  elf, other: Task
+00008d80: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00008d90: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00008da0: 7465 735b 6f74 6865 722e 7374 6174 655d  tes[other.state]
+00008db0: 202b 3d20 310a 2020 2020 2020 2020 6f74   += 1.        ot
+00008dc0: 6865 722e 6772 6f75 7020 3d20 7365 6c66  her.group = self
+00008dd0: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00008de0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+00008df0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00008e00: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
+00008e10: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+00008e20: 2873 656c 662e 6e61 6d65 206f 7220 226e  (self.name or "n
+00008e30: 6f2d 6772 6f75 7022 290a 2020 2020 2020  o-group").      
+00008e40: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
+00008e50: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
+00008e60: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00008e70: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
+00008e80: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
+00008e90: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
+00008ea0: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
+00008eb0: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
+00008ec0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00008ed0: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
+00008ee0: 0a0a 2020 2020 6465 6620 5f5f 6c65 6e5f  ..    def __len_
+00008ef0: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
+00008f00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00008f10: 756d 2873 656c 662e 7374 6174 6573 2e76  um(self.states.v
+00008f20: 616c 7565 7328 2929 0a0a 2020 2020 6465  alues())..    de
+00008f30: 6620 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  f _to_dict_no_ne
+00008f40: 7374 2873 656c 662c 202a 2c20 6578 636c  st(self, *, excl
+00008f50: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
+00008f60: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
+00008f70: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+00008f80: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
+00008f90: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
+00008fa0: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
+00008fb0: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
+00008fc0: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
+00008fd0: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
+00008fe0: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
+00008ff0: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
+00009000: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
+00009010: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
+00009020: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
+00009030: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
+00009040: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
+00009050: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
+00009060: 6963 740a 2020 2020 2020 2020 5461 736b  ict.        Task
+00009070: 5374 6174 652e 5f74 6f5f 6469 6374 0a20  State._to_dict. 
+00009080: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00009090: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
+000090a0: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
+000090b0: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
+000090c0: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
+000090d0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000090e0: 2020 2020 6465 6620 646f 6e65 2873 656c      def done(sel
+000090f0: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
+00009100: 2020 2020 2222 2252 6574 7572 6e20 5472      """Return Tr
+00009110: 7565 2069 6620 616c 6c20 636f 6d70 7574  ue if all comput
+00009120: 6174 696f 6e73 2066 6f72 2074 6869 7320  ations for this 
+00009130: 6772 6f75 7020 6861 7665 2063 6f6d 706c  group have compl
+00009140: 6574 6564 3b20 4661 6c73 650a 2020 2020  eted; False.    
+00009150: 2020 2020 6f74 6865 7277 6973 652e 0a0a      otherwise...
+00009160: 2020 2020 2020 2020 4e6f 7465 730a 2020          Notes.  
+00009170: 2020 2020 2020 2d2d 2d2d 2d0a 2020 2020        -----.    
+00009180: 2020 2020 5468 6973 2070 726f 7065 7274      This propert
+00009190: 7920 6d61 7920 7472 616e 7369 7469 6f6e  y may transition
+000091a0: 2066 726f 6d20 5472 7565 2074 6f20 4661   from True to Fa
+000091b0: 6c73 652c 2065 2e67 2e20 7768 656e 2061  lse, e.g. when a
+000091c0: 2077 6f72 6b65 7220 7468 6174 0a20 2020   worker that.   
+000091d0: 2020 2020 2063 6f6e 7461 696e 6564 2074       contained t
+000091e0: 6865 206f 6e6c 7920 7265 706c 6963 6120  he only replica 
+000091f0: 6f66 2061 2074 6173 6b20 696e 206d 656d  of a task in mem
+00009200: 6f72 7920 6372 6173 6865 7320 616e 6420  ory crashes and 
+00009210: 7468 6520 7461 736b 206e 6565 6420 746f  the task need to
+00009220: 2062 650a 2020 2020 2020 2020 7265 636f   be.        reco
+00009230: 6d70 7574 6564 2e0a 2020 2020 2020 2020  mputed..        
+00009240: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00009250: 726e 2061 6c6c 280a 2020 2020 2020 2020  rn all(.        
+00009260: 2020 2020 636f 756e 7420 3d3d 2030 206f      count == 0 o
+00009270: 7220 7374 6174 6520 696e 207b 226d 656d  r state in {"mem
+00009280: 6f72 7922 2c20 2265 7272 6564 222c 2022  ory", "erred", "
+00009290: 7265 6c65 6173 6564 222c 2022 666f 7267  released", "forg
+000092a0: 6f74 7465 6e22 7d0a 2020 2020 2020 2020  otten"}.        
+000092b0: 2020 2020 666f 7220 7374 6174 652c 2063      for state, c
+000092c0: 6f75 6e74 2069 6e20 7365 6c66 2e73 7461  ount in self.sta
+000092d0: 7465 732e 6974 656d 7328 290a 2020 2020  tes.items().    
+000092e0: 2020 2020 290a 0a0a 636c 6173 7320 5461      )...class Ta
+000092f0: 736b 5374 6174 653a 0a20 2020 2022 2222  skState:.    """
+00009300: 4120 7369 6d70 6c65 206f 626a 6563 7420  A simple object 
+00009310: 686f 6c64 696e 6720 696e 666f 726d 6174  holding informat
+00009320: 696f 6e20 6162 6f75 7420 6120 7461 736b  ion about a task
+00009330: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
+00009340: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
+00009350: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
+00009360: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
+00009370: 6d61 6368 696e 652e 5461 736b 5374 6174  machine.TaskStat
+00009380: 6560 2c20 7768 6963 680a 2020 2020 686f  e`, which.    ho
+00009390: 6c64 7320 7369 6d69 6c61 7220 696e 666f  lds similar info
+000093a0: 726d 6174 696f 6e20 6f6e 2074 6865 2057  rmation on the W
+000093b0: 6f72 6b65 7220 7369 6465 2e0a 2020 2020  orker side..    
+000093c0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
+000093d0: 6b65 7920 6973 2074 6865 2075 6e69 7175  key is the uniqu
+000093e0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
+000093f0: 6120 7461 736b 2c20 6765 6e65 7261 6c6c  a task, generall
+00009400: 7920 666f 726d 6564 2066 726f 6d20 7468  y formed from th
+00009410: 6520 6e61 6d65 206f 6620 7468 650a 2020  e name of the.  
+00009420: 2020 233a 2066 756e 6374 696f 6e2c 2066    #: function, f
+00009430: 6f6c 6c6f 7765 6420 6279 2061 2068 6173  ollowed by a has
+00009440: 6820 6f66 2074 6865 2066 756e 6374 696f  h of the functio
+00009450: 6e20 616e 6420 6172 6775 6d65 6e74 732c  n and arguments,
+00009460: 206c 696b 650a 2020 2020 233a 2060 6027   like.    #: ``'
+00009470: 696e 632d 6162 3331 6330 3130 3434 3439  inc-ab31c0104449
+00009480: 3737 3030 3464 3635 3636 3130 6432 6434  77004d656610d2d4
+00009490: 3231 6563 2760 602e 0a20 2020 206b 6579  21ec'``..    key
+000094a0: 3a20 7374 720a 0a20 2020 2023 3a20 5468  : str..    #: Th
+000094b0: 6520 6272 6f61 6420 636c 6173 7320 6f66  e broad class of
+000094c0: 2074 6173 6b73 2074 6f20 7768 6963 6820   tasks to which 
+000094d0: 7468 6973 2074 6173 6b20 6265 6c6f 6e67  this task belong
+000094e0: 7320 6c69 6b65 2022 696e 6322 206f 7220  s like "inc" or 
+000094f0: 2272 6561 645f 6373 7622 0a20 2020 2070  "read_csv".    p
+00009500: 7265 6669 783a 2054 6173 6b50 7265 6669  refix: TaskPrefi
+00009510: 780a 0a20 2020 2023 3a20 4120 7370 6563  x..    #: A spec
+00009520: 6966 6963 6174 696f 6e20 6f66 2068 6f77  ification of how
+00009530: 2074 6f20 7275 6e20 7468 6520 7461 736b   to run the task
+00009540: 2e20 2054 6865 2074 7970 6520 616e 6420  .  The type and 
+00009550: 6d65 616e 696e 6720 6f66 2074 6869 7320  meaning of this 
+00009560: 7661 6c75 6520 6973 0a20 2020 2023 3a20  value is.    #: 
+00009570: 6f70 6171 7565 2074 6f20 7468 6520 7363  opaque to the sc
+00009580: 6865 6475 6c65 722c 2061 7320 6974 2069  heduler, as it i
+00009590: 7320 6f6e 6c79 2069 6e74 6572 7072 6574  s only interpret
+000095a0: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
+000095b0: 2074 6f20 7768 6963 6820 7468 650a 2020   to which the.  
+000095c0: 2020 233a 2074 6173 6b20 6973 2073 656e    #: task is sen
+000095d0: 7420 666f 7220 6578 6563 7574 696e 672e  t for executing.
+000095e0: 0a20 2020 2023 3a0a 2020 2020 233a 2041  .    #:.    #: A
+000095f0: 7320 6120 7370 6563 6961 6c20 6361 7365  s a special case
+00009600: 2c20 7468 6973 2061 7474 7269 6275 7465  , this attribute
+00009610: 206d 6179 2061 6c73 6f20 6265 2060 604e   may also be ``N
+00009620: 6f6e 6560 602c 2069 6e20 7768 6963 6820  one``, in which 
+00009630: 6361 7365 2074 6865 2074 6173 6b20 6973  case the task is
+00009640: 0a20 2020 2023 3a20 2270 7572 6520 6461  .    #: "pure da
+00009650: 7461 2220 2873 7563 6820 6173 2c20 666f  ta" (such as, fo
+00009660: 7220 6578 616d 706c 652c 2061 2070 6965  r example, a pie
+00009670: 6365 206f 6620 6461 7461 206c 6f61 6465  ce of data loade
+00009680: 6420 696e 2074 6865 2073 6368 6564 756c  d in the schedul
+00009690: 6572 2075 7369 6e67 0a20 2020 2023 3a20  er using.    #: 
+000096a0: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
+000096b0: 6174 7465 7260 292e 2020 4120 2270 7572  atter`).  A "pur
+000096c0: 6520 6461 7461 2220 7461 736b 2063 616e  e data" task can
+000096d0: 6e6f 7420 6265 2063 6f6d 7075 7465 6420  not be computed 
+000096e0: 6167 6169 6e20 6966 2069 7473 0a20 2020  again if its.   
+000096f0: 2023 3a20 7661 6c75 6520 6973 206c 6f73   #: value is los
+00009700: 742e 0a20 2020 2072 756e 5f73 7065 633a  t..    run_spec:
+00009710: 206f 626a 6563 740a 0a20 2020 2023 3a20   object..    #: 
+00009720: 5468 6520 7072 696f 7269 7479 2070 726f  The priority pro
+00009730: 7669 6465 7320 6561 6368 2074 6173 6b20  vides each task 
+00009740: 7769 7468 2061 2072 656c 6174 6976 6520  with a relative 
+00009750: 7261 6e6b 696e 6720 7768 6963 6820 6973  ranking which is
+00009760: 2075 7365 6420 746f 2062 7265 616b 0a20   used to break. 
+00009770: 2020 2023 3a20 7469 6573 2077 6865 6e20     #: ties when 
+00009780: 6d61 6e79 2074 6173 6b73 2061 7265 2062  many tasks are b
+00009790: 6569 6e67 2063 6f6e 7369 6465 7265 6420  eing considered 
+000097a0: 666f 7220 6578 6563 7574 696f 6e2e 0a20  for execution.. 
+000097b0: 2020 2023 3a0a 2020 2020 233a 2054 6869     #:.    #: Thi
+000097c0: 7320 7261 6e6b 696e 6720 6973 2067 656e  s ranking is gen
+000097d0: 6572 616c 6c79 2061 2032 2d69 7465 6d20  erally a 2-item 
+000097e0: 7475 706c 652e 2020 5468 6520 6669 7273  tuple.  The firs
+000097f0: 7420 2861 6e64 2064 6f6d 696e 616e 7429  t (and dominant)
+00009800: 2069 7465 6d0a 2020 2020 233a 2063 6f72   item.    #: cor
+00009810: 7265 7370 6f6e 6473 2074 6f20 7768 656e  responds to when
+00009820: 2069 7420 7761 7320 7375 626d 6974 7465   it was submitte
+00009830: 642e 2020 4765 6e65 7261 6c6c 792c 2065  d.  Generally, e
+00009840: 6172 6c69 6572 2074 6173 6b73 2074 616b  arlier tasks tak
+00009850: 6520 7072 6563 6564 656e 6365 2e0a 2020  e precedence..  
+00009860: 2020 233a 2054 6865 2073 6563 6f6e 6420    #: The second 
+00009870: 6974 656d 2069 7320 6465 7465 726d 696e  item is determin
+00009880: 6564 2062 7920 7468 6520 636c 6965 6e74  ed by the client
+00009890: 2c20 616e 6420 6973 2061 2077 6179 2074  , and is a way t
+000098a0: 6f20 7072 696f 7269 7469 7a65 2074 6173  o prioritize tas
+000098b0: 6b73 0a20 2020 2023 3a20 7769 7468 696e  ks.    #: within
+000098c0: 2061 206c 6172 6765 2067 7261 7068 2074   a large graph t
+000098d0: 6861 7420 6d61 7920 6265 2069 6d70 6f72  hat may be impor
+000098e0: 7461 6e74 2c20 7375 6368 2061 7320 6966  tant, such as if
+000098f0: 2074 6865 7920 6172 6520 6f6e 2074 6865   they are on the
+00009900: 2063 7269 7469 6361 6c0a 2020 2020 233a   critical.    #:
+00009910: 2070 6174 682c 206f 7220 676f 6f64 2074   path, or good t
+00009920: 6f20 7275 6e20 696e 206f 7264 6572 2074  o run in order t
+00009930: 6f20 7265 6c65 6173 6520 6d61 6e79 2064  o release many d
+00009940: 6570 656e 6465 6e63 6965 732e 2020 5468  ependencies.  Th
+00009950: 6973 2069 7320 6578 706c 6169 6e65 640a  is is explained.
+00009960: 2020 2020 233a 2066 7572 7468 6572 2069      #: further i
+00009970: 6e20 3a64 6f63 3a60 5363 6865 6475 6c69  n :doc:`Scheduli
+00009980: 6e67 2050 6f6c 6963 7920 3c73 6368 6564  ng Policy <sched
+00009990: 756c 696e 672d 706f 6c69 6369 6573 3e60  uling-policies>`
+000099a0: 2e0a 2020 2020 7072 696f 7269 7479 3a20  ..    priority: 
+000099b0: 7475 706c 655b 666c 6f61 742c 202e 2e2e  tuple[float, ...
+000099c0: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 2320  ] | None..    # 
+000099d0: 4174 7472 6962 7574 6520 756e 6465 726c  Attribute underl
+000099e0: 7969 6e67 2074 6865 2073 7461 7465 2070  ying the state p
+000099f0: 726f 7065 7274 790a 2020 2020 5f73 7461  roperty.    _sta
+00009a00: 7465 3a20 5461 736b 5374 6174 6553 7461  te: TaskStateSta
+00009a10: 7465 0a0a 2020 2020 233a 2054 6865 2073  te..    #: The s
+00009a20: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
+00009a30: 2074 6173 6b20 6465 7065 6e64 7320 6f6e   task depends on
+00009a40: 2066 6f72 2070 726f 7065 7220 6578 6563   for proper exec
+00009a50: 7574 696f 6e2e 204f 6e6c 7920 7461 736b  ution. Only task
+00009a60: 7320 7374 696c 6c0a 2020 2020 233a 2061  s still.    #: a
+00009a70: 6c69 7665 2061 7265 206c 6973 7465 6420  live are listed 
+00009a80: 696e 2074 6869 7320 7365 742e 2049 662c  in this set. If,
+00009a90: 2066 6f72 2077 6861 7465 7665 7220 7265   for whatever re
+00009aa0: 6173 6f6e 2c20 7468 6973 2074 6173 6b20  ason, this task 
+00009ab0: 616c 736f 2064 6570 656e 6473 206f 6e0a  also depends on.
+00009ac0: 2020 2020 233a 2061 2066 6f72 676f 7474      #: a forgott
+00009ad0: 656e 2074 6173 6b2c 2074 6865 203a 6174  en task, the :at
+00009ae0: 7472 3a60 6861 735f 6c6f 7374 5f64 6570  tr:`has_lost_dep
+00009af0: 656e 6465 6e63 6965 7360 2066 6c61 6720  endencies` flag 
+00009b00: 6973 2073 6574 2e0a 2020 2020 233a 0a20  is set..    #:. 
+00009b10: 2020 2023 3a20 4120 7461 736b 2063 616e     #: A task can
+00009b20: 206f 6e6c 7920 6265 2065 7865 6375 7465   only be execute
+00009b30: 6420 6f6e 6365 2061 6c6c 2069 7473 2064  d once all its d
+00009b40: 6570 656e 6465 6e63 6965 7320 6861 7665  ependencies have
+00009b50: 2061 6c72 6561 6479 2062 6565 6e0a 2020   already been.  
+00009b60: 2020 233a 2073 7563 6365 7373 6675 6c6c    #: successfull
+00009b70: 7920 6578 6563 7574 6564 2061 6e64 2068  y executed and h
+00009b80: 6176 6520 7468 6569 7220 7265 7375 6c74  ave their result
+00009b90: 2073 746f 7265 6420 6f6e 2061 7420 6c65   stored on at le
+00009ba0: 6173 7420 6f6e 6520 776f 726b 6572 2e20  ast one worker. 
+00009bb0: 5468 6973 0a20 2020 2023 3a20 6973 2074  This.    #: is t
+00009bc0: 7261 636b 6564 2062 7920 7072 6f67 7265  racked by progre
+00009bd0: 7373 6976 656c 7920 6472 6169 6e69 6e67  ssively draining
+00009be0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+00009bf0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+00009c00: 2064 6570 656e 6465 6e63 6965 733a 2073   dependencies: s
+00009c10: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00009c20: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
+00009c30: 2074 6173 6b73 2077 6869 6368 2064 6570   tasks which dep
+00009c40: 656e 6420 6f6e 2074 6869 7320 7461 736b  end on this task
+00009c50: 2e20 204f 6e6c 7920 7461 736b 7320 7374  .  Only tasks st
+00009c60: 696c 6c20 616c 6976 6520 6172 6520 6c69  ill alive are li
+00009c70: 7374 6564 2069 6e0a 2020 2020 233a 2074  sted in.    #: t
+00009c80: 6869 7320 7365 742e 2054 6869 7320 6973  his set. This is
+00009c90: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
+00009ca0: 7069 6e67 206f 6620 3a61 7474 723a 6064  ping of :attr:`d
+00009cb0: 6570 656e 6465 6e63 6965 7360 2e0a 2020  ependencies`..  
+00009cc0: 2020 6465 7065 6e64 656e 7473 3a20 7365    dependents: se
+00009cd0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+00009ce0: 2020 233a 2057 6865 7468 6572 2061 6e79    #: Whether any
+00009cf0: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+00009d00: 6369 6573 206f 6620 7468 6973 2074 6173  cies of this tas
+00009d10: 6b20 6861 7320 6265 656e 2066 6f72 676f  k has been forgo
+00009d20: 7474 656e 2e20 466f 7220 6d65 6d6f 7279  tten. For memory
+00009d30: 0a20 2020 2023 3a20 636f 6e73 756d 7074  .    #: consumpt
+00009d40: 696f 6e20 7265 6173 6f6e 732c 2066 6f72  ion reasons, for
+00009d50: 676f 7474 656e 2074 6173 6b73 2061 7265  gotten tasks are
+00009d60: 206e 6f74 206b 6570 7420 696e 206d 656d   not kept in mem
+00009d70: 6f72 7920 6576 656e 2074 686f 7567 6820  ory even though 
+00009d80: 7468 6579 206d 6179 0a20 2020 2023 3a20  they may.    #: 
+00009d90: 6861 7665 2064 6570 656e 6465 6e74 2074  have dependent t
+00009da0: 6173 6b73 2e20 2057 6865 6e20 6120 7461  asks.  When a ta
+00009db0: 736b 2069 7320 666f 7267 6f74 7465 6e2c  sk is forgotten,
+00009dc0: 2074 6865 7265 666f 7265 2c20 6561 6368   therefore, each
+00009dd0: 206f 6620 6974 730a 2020 2020 233a 2064   of its.    #: d
+00009de0: 6570 656e 6465 6e74 7320 6861 7320 7468  ependents has th
+00009df0: 6569 7220 3a61 7474 723a 6068 6173 5f6c  eir :attr:`has_l
+00009e00: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+00009e10: 6020 6174 7472 6962 7574 6520 7365 7420  ` attribute set 
+00009e20: 746f 2060 6054 7275 6560 602e 0a20 2020  to ``True``..   
+00009e30: 2023 3a0a 2020 2020 233a 2049 6620 3a61   #:.    #: If :a
+00009e40: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
+00009e50: 7065 6e64 656e 6369 6573 6020 6973 2074  pendencies` is t
+00009e60: 7275 652c 2074 6869 7320 7461 736b 2063  rue, this task c
+00009e70: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
+00009e80: 650a 2020 2020 233a 2022 7072 6f63 6573  e.    #: "proces
+00009e90: 7369 6e67 2220 7374 6174 6520 616e 796d  sing" state anym
+00009ea0: 6f72 652e 0a20 2020 2068 6173 5f6c 6f73  ore..    has_los
+00009eb0: 745f 6465 7065 6e64 656e 6369 6573 3a20  t_dependencies: 
+00009ec0: 626f 6f6c 0a0a 2020 2020 233a 2054 6865  bool..    #: The
+00009ed0: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
+00009ee0: 6973 2074 6173 6b20 6973 2077 6169 7469  is task is waiti
+00009ef0: 6e67 206f 6e20 2a62 6566 6f72 652a 2069  ng on *before* i
+00009f00: 7420 6361 6e20 6265 2065 7865 6375 7465  t can be execute
+00009f10: 642e 2054 6869 7320 6973 0a20 2020 2023  d. This is.    #
+00009f20: 3a20 616c 7761 7973 2061 2073 7562 7365  : always a subse
+00009f30: 7420 6f66 203a 6174 7472 3a60 6465 7065  t of :attr:`depe
+00009f40: 6e64 656e 6369 6573 602e 2020 4561 6368  ndencies`.  Each
+00009f50: 2074 696d 6520 6f6e 6520 6f66 2074 6865   time one of the
+00009f60: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
+00009f70: 730a 2020 2020 233a 2066 696e 6973 6865  s.    #: finishe
+00009f80: 6420 7072 6f63 6573 7369 6e67 2c20 6974  d processing, it
+00009f90: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
+00009fa0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+00009fb0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+00009fc0: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+00009fd0: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
+00009fe0: 6e60 2062 6563 6f6d 6573 2065 6d70 7479  n` becomes empty
+00009ff0: 2c20 7468 6973 2074 6173 6b20 6361 6e20  , this task can 
+0000a000: 6d6f 7665 2066 726f 6d20 7468 6520 2277  move from the "w
+0000a010: 6169 7469 6e67 220a 2020 2020 233a 2073  aiting".    #: s
+0000a020: 7461 7465 2074 6f20 7468 6520 2270 726f  tate to the "pro
+0000a030: 6365 7373 696e 6722 2073 7461 7465 2028  cessing" state (
+0000a040: 756e 6c65 7373 206f 6e65 206f 6620 7468  unless one of th
+0000a050: 6520 6465 7065 6e64 656e 6369 6573 2065  e dependencies e
+0000a060: 7272 6f72 6564 206f 7574 2c20 696e 0a20  rrored out, in. 
+0000a070: 2020 2023 3a20 7768 6963 6820 6361 7365     #: which case
+0000a080: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
+0000a090: 7374 6561 6420 6d61 726b 6564 2022 6572  stead marked "er
+0000a0a0: 7265 6422 292e 0a20 2020 2077 6169 7469  red")..    waiti
+0000a0b0: 6e67 5f6f 6e3a 2073 6574 5b54 6173 6b53  ng_on: set[TaskS
+0000a0c0: 7461 7465 5d0a 0a20 2020 2023 3a20 5468  tate]..    #: Th
+0000a0d0: 6520 7365 7420 6f66 2074 6173 6b73 2077  e set of tasks w
+0000a0e0: 6869 6368 206e 6565 6420 7468 6973 2074  hich need this t
+0000a0f0: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
+0000a100: 6976 652e 2020 5468 6973 2069 7320 616c  ive.  This is al
+0000a110: 7761 7973 2061 2073 7562 7365 740a 2020  ways a subset.  
+0000a120: 2020 233a 206f 6620 3a61 7474 723a 6064    #: of :attr:`d
+0000a130: 6570 656e 6465 6e74 7360 2e20 2045 6163  ependents`.  Eac
+0000a140: 6820 7469 6d65 206f 6e65 206f 6620 7468  h time one of th
+0000a150: 6520 6465 7065 6e64 656e 7473 2068 6173  e dependents has
+0000a160: 2066 696e 6973 6865 6420 7072 6f63 6573   finished proces
+0000a170: 7369 6e67 2c0a 2020 2020 233a 2069 7420  sing,.    #: it 
+0000a180: 6973 2072 656d 6f76 6564 2066 726f 6d20  is removed from 
+0000a190: 7468 6520 3a61 7474 723a 6077 6169 7465  the :attr:`waite
+0000a1a0: 7273 6020 7365 742e 0a20 2020 2023 3a0a  rs` set..    #:.
+0000a1b0: 2020 2020 233a 204f 6e63 6520 626f 7468      #: Once both
+0000a1c0: 203a 6174 7472 3a60 7761 6974 6572 7360   :attr:`waiters`
+0000a1d0: 2061 6e64 203a 6174 7472 3a60 7768 6f5f   and :attr:`who_
+0000a1e0: 7761 6e74 7360 2062 6563 6f6d 6520 656d  wants` become em
+0000a1f0: 7074 792c 2074 6869 7320 7461 736b 2063  pty, this task c
+0000a200: 616e 2062 650a 2020 2020 233a 2072 656c  an be.    #: rel
+0000a210: 6561 7365 6420 2869 6620 6974 2068 6173  eased (if it has
+0000a220: 2061 206e 6f6e 2d65 6d70 7479 203a 6174   a non-empty :at
+0000a230: 7472 3a60 7275 6e5f 7370 6563 6029 206f  tr:`run_spec`) o
+0000a240: 7220 666f 7267 6f74 7465 6e20 286f 7468  r forgotten (oth
+0000a250: 6572 7769 7365 2920 6279 2074 6865 0a20  erwise) by the. 
+0000a260: 2020 2023 3a20 7363 6865 6475 6c65 722c     #: scheduler,
+0000a270: 2061 6e64 2062 7920 616e 7920 776f 726b   and by any work
+0000a280: 6572 7320 696e 203a 6174 7472 3a60 7768  ers in :attr:`wh
+0000a290: 6f5f 6861 7360 2e0a 2020 2020 233a 0a20  o_has`..    #:. 
+0000a2a0: 2020 2023 3a20 2e2e 206e 6f74 653a 3a0a     #: .. note::.
+0000a2b0: 2020 2020 233a 2020 2020 436f 756e 7465      #:    Counte
+0000a2c0: 722d 696e 7475 6974 6976 656c 792c 203a  r-intuitively, :
+0000a2d0: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
+0000a2e0: 6020 616e 6420 3a61 7474 723a 6077 6169  ` and :attr:`wai
+0000a2f0: 7465 7273 6020 6172 6520 6e6f 7420 7265  ters` are not re
+0000a300: 7665 7273 650a 2020 2020 233a 2020 2020  verse.    #:    
+0000a310: 6d61 7070 696e 6773 206f 6620 6561 6368  mappings of each
+0000a320: 206f 7468 6572 2e0a 2020 2020 7761 6974   other..    wait
+0000a330: 6572 733a 2073 6574 5b54 6173 6b53 7461  ers: set[TaskSta
+0000a340: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
+0000a350: 7365 7420 6f66 2063 6c69 656e 7473 2077  set of clients w
+0000a360: 686f 2077 616e 7420 7468 6520 7265 7375  ho want the resu
+0000a370: 6c74 206f 6620 7468 6973 2074 6173 6b20  lt of this task 
+0000a380: 746f 2072 656d 6169 6e20 616c 6976 652e  to remain alive.
+0000a390: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
+0000a3a0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
+0000a3b0: 696e 6720 6f66 203a 6174 7472 3a60 436c  ing of :attr:`Cl
+0000a3c0: 6965 6e74 5374 6174 652e 7761 6e74 735f  ientState.wants_
+0000a3d0: 7768 6174 602e 0a20 2020 2023 3a0a 2020  what`..    #:.  
+0000a3e0: 2020 233a 2057 6865 6e20 6120 636c 6965    #: When a clie
+0000a3f0: 6e74 2073 7562 6d69 7473 2061 2067 7261  nt submits a gra
+0000a400: 7068 2074 6f20 7468 6520 7363 6865 6475  ph to the schedu
+0000a410: 6c65 7220 6974 2061 6c73 6f20 7370 6563  ler it also spec
+0000a420: 6966 6965 7320 7768 6963 6820 6f75 7470  ifies which outp
+0000a430: 7574 0a20 2020 2023 3a20 7461 736b 7320  ut.    #: tasks 
+0000a440: 6974 2064 6573 6972 6573 2c20 7375 6368  it desires, such
+0000a450: 2074 6861 7420 7468 6569 7220 7265 7375   that their resu
+0000a460: 6c74 7320 6172 6520 6e6f 7420 7265 6c65  lts are not rele
+0000a470: 6173 6564 2066 726f 6d20 6d65 6d6f 7279  ased from memory
+0000a480: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+0000a490: 4f6e 6365 2061 2074 6173 6b20 6861 7320  Once a task has 
+0000a4a0: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
+0000a4b0: 6e67 2028 692e 652e 206d 6f76 6573 2069  ng (i.e. moves i
+0000a4c0: 6e74 6f20 7468 6520 226d 656d 6f72 7922  nto the "memory"
+0000a4d0: 206f 7220 2265 7272 6564 220a 2020 2020   or "erred".    
+0000a4e0: 233a 2073 7461 7465 292c 2074 6865 2063  #: state), the c
+0000a4f0: 6c69 656e 7473 2069 6e20 3a61 7474 723a  lients in :attr:
+0000a500: 6077 686f 5f77 616e 7473 6020 6172 6520  `who_wants` are 
+0000a510: 6e6f 7469 6669 6564 2e0a 2020 2020 233a  notified..    #:
+0000a520: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
+0000a530: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
+0000a540: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
+0000a550: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
+0000a560: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
+0000a570: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
+0000a580: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
+0000a590: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
+0000a5a0: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
+0000a5b0: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
+0000a5c0: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
+0000a5d0: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
+0000a5e0: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
+0000a5f0: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
+0000a600: 686f 5f68 6173 602e 0a20 2020 2077 686f  ho_has`..    who
+0000a610: 5f77 616e 7473 3a20 7365 745b 436c 6965  _wants: set[Clie
+0000a620: 6e74 5374 6174 655d 0a0a 2020 2020 233a  ntState]..    #:
+0000a630: 2054 6865 2073 6574 206f 6620 776f 726b   The set of work
+0000a640: 6572 7320 7768 6f20 6861 7665 2074 6869  ers who have thi
+0000a650: 7320 7461 736b 2773 2072 6573 756c 7420  s task's result 
+0000a660: 696e 206d 656d 6f72 792e 2049 7420 6973  in memory. It is
+0000a670: 206e 6f6e 2d65 6d70 7479 2069 6666 2074   non-empty iff t
+0000a680: 6865 0a20 2020 2023 3a20 7461 736b 2069  he.    #: task i
+0000a690: 7320 696e 2074 6865 2022 6d65 6d6f 7279  s in the "memory
+0000a6a0: 2220 7374 6174 652e 2020 5468 6572 6520  " state.  There 
+0000a6b0: 6361 6e20 6265 206d 6f72 6520 7468 616e  can be more than
+0000a6c0: 206f 6e65 2077 6f72 6b65 7220 696e 2074   one worker in t
+0000a6d0: 6869 7320 7365 7420 6966 2c0a 2020 2020  his set if,.    
+0000a6e0: 233a 2066 6f72 2065 7861 6d70 6c65 2c20  #: for example, 
+0000a6f0: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
+0000a700: 6174 7465 7260 206f 7220 3a6d 6574 683a  atter` or :meth:
+0000a710: 6043 6c69 656e 742e 7265 706c 6963 6174  `Client.replicat
+0000a720: 6560 2077 6173 2075 7365 642e 0a20 2020  e` was used..   
+0000a730: 2023 3a0a 2020 2020 233a 2054 6869 7320   #:.    #: This 
+0000a740: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
+0000a750: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
+0000a760: 6057 6f72 6b65 7253 7461 7465 2e68 6173  `WorkerState.has
+0000a770: 5f77 6861 7460 2e0a 2020 2020 7768 6f5f  _what`..    who_
+0000a780: 6861 733a 2073 6574 5b57 6f72 6b65 7253  has: set[WorkerS
+0000a790: 7461 7465 5d0a 0a20 2020 2023 3a20 4966  tate]..    #: If
+0000a7a0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
+0000a7b0: 2074 6865 2022 7072 6f63 6573 7369 6e67   the "processing
+0000a7c0: 2220 7374 6174 652c 2077 6869 6368 2077  " state, which w
+0000a7d0: 6f72 6b65 7220 6973 2063 7572 7265 6e74  orker is current
+0000a7e0: 6c79 2070 726f 6365 7373 696e 670a 2020  ly processing.  
+0000a7f0: 2020 233a 2069 742e 2054 6869 7320 6174    #: it. This at
+0000a800: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
+0000a810: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
+0000a820: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
+0000a830: 7072 6f63 6573 7369 6e67 602e 0a20 2020  processing`..   
+0000a840: 2070 726f 6365 7373 696e 675f 6f6e 3a20   processing_on: 
+0000a850: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+0000a860: 6e65 0a0a 2020 2020 233a 2054 6865 206e  ne..    #: The n
+0000a870: 756d 6265 7220 6f66 2074 696d 6573 2074  umber of times t
+0000a880: 6869 7320 7461 736b 2063 616e 2061 7574  his task can aut
+0000a890: 6f6d 6174 6963 616c 6c79 2062 6520 7265  omatically be re
+0000a8a0: 7472 6965 6420 696e 2063 6173 6520 6f66  tried in case of
+0000a8b0: 2066 6169 6c75 7265 2e0a 2020 2020 233a   failure..    #:
+0000a8c0: 2049 6620 6120 7461 736b 2066 6169 6c73   If a task fails
+0000a8d0: 2065 7865 6375 7469 6e67 2028 7468 6520   executing (the 
+0000a8e0: 776f 726b 6572 2072 6574 7572 6e73 2077  worker returns w
+0000a8f0: 6974 6820 616e 2065 7272 6f72 292c 2069  ith an error), i
+0000a900: 7473 203a 6174 7472 3a60 7265 7472 6965  ts :attr:`retrie
+0000a910: 7360 0a20 2020 2023 3a20 6174 7472 6962  s`.    #: attrib
+0000a920: 7574 6520 6973 2063 6865 636b 6564 2e20  ute is checked. 
+0000a930: 4966 2069 7420 6973 2065 7175 616c 2074  If it is equal t
+0000a940: 6f20 302c 2074 6865 2074 6173 6b20 6973  o 0, the task is
+0000a950: 206d 6172 6b65 6420 2265 7272 6564 222e   marked "erred".
+0000a960: 2049 6620 6974 2069 730a 2020 2020 233a   If it is.    #:
+0000a970: 2067 7265 6174 6572 2074 6861 6e20 302c   greater than 0,
+0000a980: 2074 6865 203a 6174 7472 3a60 7265 7472   the :attr:`retr
+0000a990: 6965 7360 2061 7474 7269 6275 7465 2069  ies` attribute i
+0000a9a0: 7320 6465 6372 656d 656e 7465 6420 616e  s decremented an
+0000a9b0: 6420 6578 6563 7574 696f 6e20 6973 0a20  d execution is. 
+0000a9c0: 2020 2023 3a20 6174 7465 6d70 7465 6420     #: attempted 
+0000a9d0: 6167 6169 6e2e 0a20 2020 2072 6574 7269  again..    retri
+0000a9e0: 6573 3a20 696e 740a 0a20 2020 2023 3a20  es: int..    #: 
+0000a9f0: 5468 6520 6e75 6d62 6572 206f 6620 6279  The number of by
+0000aa00: 7465 732c 2061 7320 6465 7465 726d 696e  tes, as determin
+0000aa10: 6564 2062 7920 6060 7369 7a65 6f66 6060  ed by ``sizeof``
+0000aa20: 2c20 6f66 2074 6865 2072 6573 756c 7420  , of the result 
+0000aa30: 6f66 2061 2066 696e 6973 6865 640a 2020  of a finished.  
+0000aa40: 2020 233a 2074 6173 6b2e 2054 6869 7320    #: task. This 
+0000aa50: 6e75 6d62 6572 2069 7320 7573 6564 2066  number is used f
+0000aa60: 6f72 2064 6961 676e 6f73 7469 6373 2061  or diagnostics a
+0000aa70: 6e64 2074 6f20 6865 6c70 2070 7269 6f72  nd to help prior
+0000aa80: 6974 697a 6520 776f 726b 2e0a 2020 2020  itize work..    
+0000aa90: 233a 2053 6574 2074 6f20 2d31 2066 6f72  #: Set to -1 for
+0000aaa0: 2075 6e66 696e 6973 6865 6420 7461 736b   unfinished task
+0000aab0: 732e 0a20 2020 206e 6279 7465 733a 2069  s..    nbytes: i
+0000aac0: 6e74 0a0a 2020 2020 233a 2054 6865 2074  nt..    #: The t
+0000aad0: 7970 6520 6f66 2074 6865 206f 626a 6563  ype of the objec
+0000aae0: 7420 6173 2061 2073 7472 696e 672e 204f  t as a string. O
+0000aaf0: 6e6c 7920 7072 6573 656e 7420 666f 7220  nly present for 
+0000ab00: 7461 736b 7320 7468 6174 2068 6176 6520  tasks that have 
+0000ab10: 6265 656e 0a20 2020 2023 3a20 636f 6d70  been.    #: comp
+0000ab20: 7574 6564 2e0a 2020 2020 7479 7065 3a20  uted..    type: 
+0000ab30: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
+0000ab40: 6869 7320 7461 736b 2066 6169 6c65 6420  his task failed 
+0000ab50: 6578 6563 7574 696e 672c 2074 6865 2065  executing, the e
+0000ab60: 7863 6570 7469 6f6e 206f 626a 6563 7420  xception object 
+0000ab70: 6973 2073 746f 7265 6420 6865 7265 2e0a  is stored here..
+0000ab80: 2020 2020 6578 6365 7074 696f 6e3a 2053      exception: S
+0000ab90: 6572 6961 6c69 7a65 6420 7c20 4e6f 6e65  erialized | None
+0000aba0: 0a0a 2020 2020 233a 2049 6620 7468 6973  ..    #: If this
+0000abb0: 2074 6173 6b20 6661 696c 6564 2065 7865   task failed exe
+0000abc0: 6375 7469 6e67 2c20 7468 6520 7472 6163  cuting, the trac
+0000abd0: 6562 6163 6b20 6f62 6a65 6374 2069 7320  eback object is 
+0000abe0: 7374 6f72 6564 2068 6572 652e 0a20 2020  stored here..   
+0000abf0: 2074 7261 6365 6261 636b 3a20 5365 7269   traceback: Seri
+0000ac00: 616c 697a 6564 207c 204e 6f6e 650a 0a20  alized | None.. 
+0000ac10: 2020 2023 3a20 7374 7269 6e67 2072 6570     #: string rep
+0000ac20: 7265 7365 6e74 6174 696f 6e20 6f66 2065  resentation of e
+0000ac30: 7863 6570 7469 6f6e 0a20 2020 2065 7863  xception.    exc
+0000ac40: 6570 7469 6f6e 5f74 6578 743a 2073 7472  eption_text: str
+0000ac50: 0a0a 2020 2020 233a 2073 7472 696e 6720  ..    #: string 
+0000ac60: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+0000ac70: 6620 7472 6163 6562 6163 6b0a 2020 2020  f traceback.    
+0000ac80: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+0000ac90: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
+0000aca0: 6869 7320 7461 736b 206f 7220 6f6e 6520  his task or one 
+0000acb0: 6f66 2069 7473 2064 6570 656e 6465 6e63  of its dependenc
+0000acc0: 6965 7320 6661 696c 6564 2065 7865 6375  ies failed execu
+0000acd0: 7469 6e67 2c20 7468 6520 6661 696c 6564  ting, the failed
+0000ace0: 2074 6173 6b20 6973 0a20 2020 2023 3a20   task is.    #: 
+0000acf0: 7374 6f72 6564 2068 6572 6520 2870 6f73  stored here (pos
+0000ad00: 7369 626c 7920 6974 7365 6c66 292e 0a20  sibly itself).. 
+0000ad10: 2020 2065 7863 6570 7469 6f6e 5f62 6c61     exception_bla
+0000ad20: 6d65 3a20 5461 736b 5374 6174 6520 7c20  me: TaskState | 
+0000ad30: 4e6f 6e65 0a0a 2020 2020 233a 2057 6f72  None..    #: Wor
+0000ad40: 6b65 7220 6164 6472 6573 7365 7320 6f6e  ker addresses on
+0000ad50: 2077 6869 6368 2065 7272 6f72 7320 6170   which errors ap
+0000ad60: 7065 6172 6564 2c20 6361 7573 696e 6720  peared, causing 
+0000ad70: 7468 6973 2074 6173 6b20 746f 2062 6520  this task to be 
+0000ad80: 696e 2061 6e20 6572 726f 720a 2020 2020  in an error.    
+0000ad90: 233a 2073 7461 7465 2e0a 2020 2020 6572  #: state..    er
+0000ada0: 7265 645f 6f6e 3a20 7365 745b 7374 725d  red_on: set[str]
+0000adb0: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
+0000adc0: 6265 7220 6f66 2074 696d 6573 2074 6869  ber of times thi
+0000add0: 7320 7461 736b 2068 6173 2062 6565 6e20  s task has been 
+0000ade0: 696e 766f 6c76 6564 2069 6e20 6120 776f  involved in a wo
+0000adf0: 726b 6572 2064 6561 7468 2e0a 2020 2020  rker death..    
+0000ae00: 233a 0a20 2020 2023 3a20 536f 6d65 2074  #:.    #: Some t
+0000ae10: 6173 6b73 206d 6179 2063 6175 7365 2077  asks may cause w
+0000ae20: 6f72 6b65 7273 2074 6f20 6469 6520 2873  orkers to die (s
+0000ae30: 7563 6820 6173 2063 616c 6c69 6e67 2060  uch as calling `
+0000ae40: 606f 732e 5f65 7869 7428 3029 6060 292e  `os._exit(0)``).
+0000ae50: 2057 6865 6e20 610a 2020 2020 233a 2077   When a.    #: w
+0000ae60: 6f72 6b65 7220 6469 6573 2c20 616c 6c20  orker dies, all 
+0000ae70: 6f66 2074 6865 2074 6173 6b73 206f 6e20  of the tasks on 
+0000ae80: 7468 6174 2077 6f72 6b65 7220 6172 6520  that worker are 
+0000ae90: 7265 6173 7369 676e 6564 2074 6f20 6f74  reassigned to ot
+0000aea0: 6865 7273 2e20 5468 6973 0a20 2020 2023  hers. This.    #
+0000aeb0: 3a20 636f 6d62 696e 6174 696f 6e20 6f66  : combination of
+0000aec0: 2062 6568 6176 696f 7273 2063 616e 2063   behaviors can c
+0000aed0: 6175 7365 2061 2062 6164 2074 6173 6b20  ause a bad task 
+0000aee0: 746f 2063 6174 6173 7472 6f70 6869 6361  to catastrophica
+0000aef0: 6c6c 7920 6465 7374 726f 7920 616c 6c0a  lly destroy all.
+0000af00: 2020 2020 233a 2077 6f72 6b65 7273 206f      #: workers o
+0000af10: 6e20 7468 6520 636c 7573 7465 722c 206f  n the cluster, o
+0000af20: 6e65 2061 6674 6572 2061 6e6f 7468 6572  ne after another
+0000af30: 2e20 5768 656e 6576 6572 2061 2077 6f72  . Whenever a wor
+0000af40: 6b65 7220 6469 6573 2c20 7765 206d 6172  ker dies, we mar
+0000af50: 6b20 6561 6368 0a20 2020 2023 3a20 7461  k each.    #: ta
+0000af60: 736b 2063 7572 7265 6e74 6c79 2070 726f  sk currently pro
+0000af70: 6365 7373 696e 6720 6f6e 2074 6861 7420  cessing on that 
+0000af80: 776f 726b 6572 2028 6173 2072 6563 6f72  worker (as recor
+0000af90: 6465 6420 6279 0a20 2020 2023 3a20 3a61  ded by.    #: :a
+0000afa0: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
+0000afb0: 2e70 726f 6365 7373 696e 6760 2920 6173  .processing`) as
+0000afc0: 2073 7573 7069 6369 6f75 732e 2049 6620   suspicious. If 
+0000afd0: 6120 7461 736b 2069 7320 696e 766f 6c76  a task is involv
+0000afe0: 6564 2069 6e20 7468 7265 650a 2020 2020  ed in three.    
+0000aff0: 233a 2064 6561 7468 7320 286f 7220 736f  #: deaths (or so
+0000b000: 6d65 206f 7468 6572 2066 6978 6564 2063  me other fixed c
+0000b010: 6f6e 7374 616e 7429 2074 6865 6e20 7765  onstant) then we
+0000b020: 206d 6172 6b20 7468 6520 7461 736b 2061   mark the task a
+0000b030: 7320 6060 6572 7265 6460 602e 0a20 2020  s ``erred``..   
+0000b040: 2073 7573 7069 6369 6f75 733a 2069 6e74   suspicious: int
+0000b050: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+0000b060: 6620 686f 7374 6e61 6d65 7320 7768 6572  f hostnames wher
+0000b070: 6520 7468 6973 2074 6173 6b20 6361 6e20  e this task can 
+0000b080: 6265 2072 756e 2028 6f72 2060 604e 6f6e  be run (or ``Non
+0000b090: 6560 6020 6966 2065 6d70 7479 292e 2055  e`` if empty). U
+0000b0a0: 7375 616c 6c79 0a20 2020 2023 3a20 7468  sually.    #: th
+0000b0b0: 6973 2069 7320 656d 7074 7920 756e 6c65  is is empty unle
+0000b0c0: 7373 2074 6865 2074 6173 6b20 6861 7320  ss the task has 
+0000b0d0: 6265 656e 2073 7065 6369 6669 6361 6c6c  been specificall
+0000b0e0: 7920 7265 7374 7269 6374 6564 2074 6f20  y restricted to 
+0000b0f0: 6f6e 6c79 2072 756e 206f 6e0a 2020 2020  only run on.    
+0000b100: 233a 2063 6572 7461 696e 2068 6f73 7473  #: certain hosts
+0000b110: 2e20 4120 686f 7374 6e61 6d65 206d 6179  . A hostname may
+0000b120: 2063 6f72 7265 7370 6f6e 6420 746f 206f   correspond to o
+0000b130: 6e65 206f 7220 7365 7665 7261 6c20 636f  ne or several co
+0000b140: 6e6e 6563 7465 6420 776f 726b 6572 732e  nnected workers.
+0000b150: 0a20 2020 2068 6f73 745f 7265 7374 7269  .    host_restri
+0000b160: 6374 696f 6e73 3a20 7365 745b 7374 725d  ctions: set[str]
+0000b170: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+0000b180: 6620 636f 6d70 6c65 7465 2077 6f72 6b65  f complete worke
+0000b190: 7220 6164 6472 6573 7365 7320 7768 6572  r addresses wher
+0000b1a0: 6520 7468 6973 2063 616e 2062 6520 7275  e this can be ru
+0000b1b0: 6e20 286f 7220 6060 4e6f 6e65 6060 2069  n (or ``None`` i
+0000b1c0: 6620 656d 7074 7929 2e0a 2020 2020 233a  f empty)..    #:
+0000b1d0: 2055 7375 616c 6c79 2074 6869 7320 6973   Usually this is
+0000b1e0: 2065 6d70 7479 2075 6e6c 6573 7320 7468   empty unless th
+0000b1f0: 6520 7461 736b 2068 6173 2062 6565 6e20  e task has been 
+0000b200: 7370 6563 6966 6963 616c 6c79 2072 6573  specifically res
+0000b210: 7472 6963 7465 6420 746f 206f 6e6c 790a  tricted to only.
+0000b220: 2020 2020 233a 2072 756e 206f 6e20 6365      #: run on ce
+0000b230: 7274 6169 6e20 776f 726b 6572 732e 0a20  rtain workers.. 
+0000b240: 2020 2023 3a20 4e6f 7465 2074 6869 7320     #: Note this 
+0000b250: 6973 2074 7261 636b 696e 6720 776f 726b  is tracking work
+0000b260: 6572 2061 6464 7265 7373 6573 2c20 6e6f  er addresses, no
+0000b270: 7420 776f 726b 6572 2073 7461 7465 732c  t worker states,
+0000b280: 2073 696e 6365 2074 6865 2073 7065 6369   since the speci
+0000b290: 6669 630a 2020 2020 233a 2077 6f72 6b65  fic.    #: worke
+0000b2a0: 7273 206d 6179 206e 6f74 2062 6520 636f  rs may not be co
+0000b2b0: 6e6e 6563 7465 6420 6174 2074 6869 7320  nnected at this 
+0000b2c0: 7469 6d65 2e0a 2020 2020 776f 726b 6572  time..    worker
+0000b2d0: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
+0000b2e0: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
+0000b2f0: 5265 736f 7572 6365 7320 7265 7175 6972  Resources requir
+0000b300: 6564 2062 7920 7468 6973 2074 6173 6b2c  ed by this task,
+0000b310: 2073 7563 6820 6173 2060 607b 2767 7075   such as ``{'gpu
+0000b320: 273a 2031 7d60 6020 6f72 2060 607b 276d  ': 1}`` or ``{'m
+0000b330: 656d 6f72 7927 3a20 3165 397d 6060 0a20  emory': 1e9}``. 
+0000b340: 2020 2023 3a20 5468 6573 6520 6172 6520     #: These are 
+0000b350: 7573 6572 2d64 6566 696e 6564 206e 616d  user-defined nam
+0000b360: 6573 2061 6e64 2061 7265 206d 6174 6368  es and are match
+0000b370: 6564 2061 6761 696e 7374 2074 6865 203a  ed against the :
+0000b380: 2063 6f6e 7465 6e74 7320 6f66 2065 6163   contents of eac
+0000b390: 680a 2020 2020 233a 203a 6174 7472 3a60  h.    #: :attr:`
+0000b3a0: 576f 726b 6572 5374 6174 652e 7265 736f  WorkerState.reso
+0000b3b0: 7572 6365 7360 2064 6963 7469 6f6e 6172  urces` dictionar
+0000b3c0: 792e 0a20 2020 2072 6573 6f75 7263 655f  y..    resource_
+0000b3d0: 7265 7374 7269 6374 696f 6e73 3a20 6469  restrictions: di
+0000b3e0: 6374 5b73 7472 2c20 666c 6f61 745d 0a0a  ct[str, float]..
+0000b3f0: 2020 2020 233a 2046 616c 7365 0a20 2020      #: False.   
+0000b400: 2023 3a20 2020 2020 4561 6368 206f 6620   #:     Each of 
+0000b410: 3a61 7474 723a 6068 6f73 745f 7265 7374  :attr:`host_rest
+0000b420: 7269 6374 696f 6e73 602c 203a 6174 7472  rictions`, :attr
+0000b430: 3a60 776f 726b 6572 5f72 6573 7472 6963  :`worker_restric
+0000b440: 7469 6f6e 7360 2061 6e64 0a20 2020 2023  tions` and.    #
+0000b450: 3a20 2020 2020 3a61 7474 723a 6072 6573  :     :attr:`res
+0000b460: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0000b470: 6e73 6020 6973 2061 2068 6172 6420 636f  ns` is a hard co
+0000b480: 6e73 7472 6169 6e74 3a20 6966 206e 6f20  nstraint: if no 
+0000b490: 776f 726b 6572 2069 7320 6176 6169 6c61  worker is availa
+0000b4a0: 626c 650a 2020 2020 233a 2020 2020 2073  ble.    #:     s
+0000b4b0: 6174 6973 6679 696e 6720 7468 6f73 6520  atisfying those 
+0000b4c0: 7265 7374 7269 6374 696f 6e73 2c20 7468  restrictions, th
+0000b4d0: 6520 7461 736b 2063 616e 6e6f 7420 676f  e task cannot go
+0000b4e0: 2069 6e74 6f20 7468 6520 2270 726f 6365   into the "proce
+0000b4f0: 7373 696e 6722 2073 7461 7465 0a20 2020  ssing" state.   
+0000b500: 2023 3a20 2020 2020 616e 6420 7769 6c6c   #:     and will
+0000b510: 2069 6e73 7465 6164 2067 6f20 696e 746f   instead go into
+0000b520: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
+0000b530: 2073 7461 7465 2e0a 2020 2020 233a 2054   state..    #: T
+0000b540: 7275 650a 2020 2020 233a 2020 2020 2054  rue.    #:     T
+0000b550: 6865 2061 626f 7665 2072 6573 7472 6963  he above restric
+0000b560: 7469 6f6e 7320 6172 6520 6d65 7265 2070  tions are mere p
+0000b570: 7265 6665 7265 6e63 6573 3a20 6966 206e  references: if n
+0000b580: 6f20 776f 726b 6572 2069 7320 6176 6169  o worker is avai
+0000b590: 6c61 626c 650a 2020 2020 233a 2020 2020  lable.    #:    
+0000b5a0: 2073 6174 6973 6679 696e 6720 7468 6f73   satisfying thos
+0000b5b0: 6520 7265 7374 7269 6374 696f 6e73 2c20  e restrictions, 
+0000b5c0: 7468 6520 7461 736b 2063 616e 2073 7469  the task can sti
+0000b5d0: 6c6c 2067 6f20 696e 746f 2074 6865 0a20  ll go into the. 
+0000b5e0: 2020 2023 3a20 2020 2020 2270 726f 6365     #:     "proce
+0000b5f0: 7373 696e 6722 2073 7461 7465 2061 6e64  ssing" state and
+0000b600: 2062 6520 7365 6e74 2066 6f72 2065 7865   be sent for exe
+0000b610: 6375 7469 6f6e 2074 6f20 616e 6f74 6865  cution to anothe
+0000b620: 7220 636f 6e6e 6563 7465 6420 776f 726b  r connected work
+0000b630: 6572 2e0a 2020 2020 6c6f 6f73 655f 7265  er..    loose_re
+0000b640: 7374 7269 6374 696f 6e73 3a20 626f 6f6c  strictions: bool
+0000b650: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
+0000b660: 2074 6869 7320 7461 736b 2069 7320 616e   this task is an
+0000b670: 2041 6374 6f72 0a20 2020 2061 6374 6f72   Actor.    actor
+0000b680: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
+0000b690: 6865 2067 726f 7570 206f 6620 7461 736b  he group of task
+0000b6a0: 7320 746f 2077 6869 6368 2074 6869 7320  s to which this 
+0000b6b0: 6f6e 6520 6265 6c6f 6e67 730a 2020 2020  one belongs.    
+0000b6c0: 6772 6f75 703a 2054 6173 6b47 726f 7570  group: TaskGroup
+0000b6d0: 0a0a 2020 2020 233a 2053 616d 6520 6173  ..    #: Same as
+0000b6e0: 206f 6620 6772 6f75 702e 6e61 6d65 0a20   of group.name. 
+0000b6f0: 2020 2067 726f 7570 5f6b 6579 3a20 7374     group_key: st
+0000b700: 720a 0a20 2020 2023 3a20 4d65 7461 6461  r..    #: Metada
+0000b710: 7461 2072 656c 6174 6564 2074 6f20 7461  ta related to ta
+0000b720: 736b 0a20 2020 206d 6574 6164 6174 613a  sk.    metadata:
+0000b730: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
+0000b740: 0a20 2020 2023 3a20 5461 736b 2061 6e6e  .    #: Task ann
+0000b750: 6f74 6174 696f 6e73 0a20 2020 2061 6e6e  otations.    ann
+0000b760: 6f74 6174 696f 6e73 3a20 6469 6374 5b73  otations: dict[s
+0000b770: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
+0000b780: 2054 6865 2075 6e69 7175 6520 6964 656e   The unique iden
+0000b790: 7469 6669 6572 206f 6620 6120 7370 6563  tifier of a spec
+0000b7a0: 6966 6963 2065 7865 6375 7469 6f6e 206f  ific execution o
+0000b7b0: 6620 6120 7461 736b 2e20 5468 6973 2069  f a task. This i
+0000b7c0: 6465 6e74 6966 6965 720a 2020 2020 233a  dentifier.    #:
+0000b7d0: 2069 7320 7573 6564 2074 6f20 7369 676e   is used to sign
+0000b7e0: 2061 2074 6173 6b20 7375 6368 2074 6861   a task such tha
+0000b7f0: 7420 7468 6520 6173 7369 676e 6564 2077  t the assigned w
+0000b800: 6f72 6b65 7220 6973 2065 7870 6563 7465  orker is expecte
+0000b810: 6420 746f 2072 6574 7572 6e0a 2020 2020  d to return.    
+0000b820: 233a 2074 6865 2073 616d 6520 6964 656e  #: the same iden
+0000b830: 7469 6669 6572 2069 6e20 7468 6520 7461  tifier in the ta
+0000b840: 736b 2d66 696e 6973 6865 6420 6d65 7373  sk-finished mess
+0000b850: 6167 652e 2054 6869 7320 6973 2075 7365  age. This is use
+0000b860: 6420 746f 2063 6f72 7265 6c61 7465 0a20  d to correlate. 
+0000b870: 2020 2023 3a20 7265 7370 6f6e 7365 732e     #: responses.
+0000b880: 0a20 2020 2023 3a20 4f6e 6c79 2074 6865  .    #: Only the
+0000b890: 206d 6f73 7420 7265 6365 6e74 6c79 2061   most recently a
+0000b8a0: 7373 6967 6e65 6420 776f 726b 6572 2069  ssigned worker i
+0000b8b0: 7320 7472 7573 7465 642e 2041 6c6c 206f  s trusted. All o
+0000b8c0: 7468 6572 2072 6573 756c 7473 2077 696c  ther results wil
+0000b8d0: 6c0a 2020 2020 233a 2062 6520 7265 6a65  l.    #: be reje
+0000b8e0: 6374 6564 2e0a 2020 2020 7275 6e5f 6964  cted..    run_id
+0000b8f0: 3a20 696e 7420 7c20 4e6f 6e65 0a0a 2020  : int | None..  
+0000b900: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
+0000b910: 206f 6620 3a61 7474 723a 607e 5461 736b   of :attr:`~Task
+0000b920: 5374 6174 652e 636c 6965 6e74 5f6b 6579  State.client_key
+0000b930: 600a 2020 2020 5f68 6173 683a 2069 6e74  `.    _hash: int
+0000b940: 0a0a 2020 2020 2320 5375 7070 6f72 7420  ..    # Support 
+0000b950: 666f 7220 7765 616b 7265 6673 2074 6f20  for weakrefs to 
+0000b960: 6120 636c 6173 7320 7769 7468 205f 5f73  a class with __s
+0000b970: 6c6f 7473 5f5f 0a20 2020 205f 5f77 6561  lots__.    __wea
+0000b980: 6b72 6566 5f5f 3a20 416e 7920 3d20 4e6f  kref__: Any = No
+0000b990: 6e65 0a20 2020 205f 5f73 6c6f 7473 5f5f  ne.    __slots__
+0000b9a0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+0000b9b0: 6174 696f 6e73 5f5f 290a 0a20 2020 2023  ations__)..    #
+0000b9c0: 3a20 476c 6f62 616c 2069 7465 7261 746f  : Global iterato
+0000b9d0: 7220 7573 6564 2074 6f20 6372 6561 7465  r used to create
+0000b9e0: 2075 6e69 7175 6520 7461 736b 2072 756e   unique task run
+0000b9f0: 2049 4473 0a20 2020 205f 7275 6e5f 6964   IDs.    _run_id
+0000ba00: 5f69 7465 7261 746f 723a 2043 6c61 7373  _iterator: Class
+0000ba10: 5661 725b 6974 6572 746f 6f6c 732e 636f  Var[itertools.co
+0000ba20: 756e 745d 203d 2069 7465 7274 6f6f 6c73  unt] = itertools
+0000ba30: 2e63 6f75 6e74 2829 0a0a 2020 2020 2320  .count()..    # 
+0000ba40: 496e 7374 616e 6365 7320 6e6f 7420 7061  Instances not pa
+0000ba50: 7274 206f 6620 736c 6f74 7320 7369 6e63  rt of slots sinc
+0000ba60: 6520 636c 6173 7320 7661 7269 6162 6c65  e class variable
+0000ba70: 0a20 2020 205f 696e 7374 616e 6365 733a  .    _instances:
+0000ba80: 2043 6c61 7373 5661 725b 7765 616b 7265   ClassVar[weakre
+0000ba90: 662e 5765 616b 5365 745b 5461 736b 5374  f.WeakSet[TaskSt
+0000baa0: 6174 655d 5d20 3d20 7765 616b 7265 662e  ate]] = weakref.
+0000bab0: 5765 616b 5365 7428 290a 0a20 2020 2064  WeakSet()..    d
+0000bac0: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+0000bad0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000bae0: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
+0000baf0: 2020 2020 2072 756e 5f73 7065 633a 206f       run_spec: o
+0000bb00: 626a 6563 742c 0a20 2020 2020 2020 2073  bject,.        s
+0000bb10: 7461 7465 3a20 5461 736b 5374 6174 6553  tate: TaskStateS
+0000bb20: 7461 7465 2c0a 2020 2020 293a 0a20 2020  tate,.    ):.   
+0000bb30: 2020 2020 2073 656c 662e 6b65 7920 3d20       self.key = 
+0000bb40: 6b65 790a 2020 2020 2020 2020 7365 6c66  key.        self
+0000bb50: 2e5f 6861 7368 203d 2068 6173 6828 6b65  ._hash = hash(ke
+0000bb60: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+0000bb70: 7275 6e5f 7370 6563 203d 2072 756e 5f73  run_spec = run_s
+0000bb80: 7065 630a 2020 2020 2020 2020 7365 6c66  pec.        self
+0000bb90: 2e5f 7374 6174 6520 3d20 7374 6174 650a  ._state = state.
+0000bba0: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
+0000bbb0: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
+0000bbc0: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
+0000bbd0: 7469 6f6e 5f62 6c61 6d65 203d 204e 6f6e  tion_blame = Non
+0000bbe0: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+0000bbf0: 7261 6365 6261 636b 203d 204e 6f6e 650a  raceback = None.
+0000bc00: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
+0000bc10: 6570 7469 6f6e 5f74 6578 7420 3d20 2222  eption_text = ""
+0000bc20: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0000bc30: 6163 6562 6163 6b5f 7465 7874 203d 2022  aceback_text = "
+0000bc40: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
+0000bc50: 7573 7069 6369 6f75 7320 3d20 300a 2020  uspicious = 0.  
+0000bc60: 2020 2020 2020 7365 6c66 2e72 6574 7269        self.retri
+0000bc70: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
+0000bc80: 656c 662e 6e62 7974 6573 203d 202d 310a  elf.nbytes = -1.
+0000bc90: 2020 2020 2020 2020 7365 6c66 2e70 7269          self.pri
+0000bca0: 6f72 6974 7920 3d20 4e6f 6e65 0a20 2020  ority = None.   
+0000bcb0: 2020 2020 2073 656c 662e 7768 6f5f 7761       self.who_wa
+0000bcc0: 6e74 7320 3d20 7365 7428 290a 2020 2020  nts = set().    
+0000bcd0: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
+0000bce0: 6e63 6965 7320 3d20 7365 7428 290a 2020  ncies = set().  
+0000bcf0: 2020 2020 2020 7365 6c66 2e64 6570 656e        self.depen
+0000bd00: 6465 6e74 7320 3d20 7365 7428 290a 2020  dents = set().  
+0000bd10: 2020 2020 2020 7365 6c66 2e77 6169 7469        self.waiti
+0000bd20: 6e67 5f6f 6e20 3d20 7365 7428 290a 2020  ng_on = set().  
+0000bd30: 2020 2020 2020 7365 6c66 2e77 6169 7465        self.waite
+0000bd40: 7273 203d 2073 6574 2829 0a20 2020 2020  rs = set().     
+0000bd50: 2020 2073 656c 662e 7768 6f5f 6861 7320     self.who_has 
+0000bd60: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+0000bd70: 7365 6c66 2e70 726f 6365 7373 696e 675f  self.processing_
+0000bd80: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
+0000bd90: 2020 7365 6c66 2e68 6173 5f6c 6f73 745f    self.has_lost_
+0000bda0: 6465 7065 6e64 656e 6369 6573 203d 2046  dependencies = F
+0000bdb0: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
+0000bdc0: 662e 686f 7374 5f72 6573 7472 6963 7469  f.host_restricti
+0000bdd0: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+0000bde0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
+0000bdf0: 7265 7374 7269 6374 696f 6e73 203d 2073  restrictions = s
+0000be00: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0000be10: 662e 7265 736f 7572 6365 5f72 6573 7472  f.resource_restr
+0000be20: 6963 7469 6f6e 7320 3d20 7b7d 0a20 2020  ictions = {}.   
+0000be30: 2020 2020 2073 656c 662e 6c6f 6f73 655f       self.loose_
+0000be40: 7265 7374 7269 6374 696f 6e73 203d 2046  restrictions = F
+0000be50: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
+0000be60: 662e 6163 746f 7220 3d20 4661 6c73 650a  f.actor = False.
+0000be70: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+0000be80: 6669 7820 3d20 4e6f 6e65 2020 2320 7479  fix = None  # ty
+0000be90: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+0000bea0: 2020 2073 656c 662e 7479 7065 203d 204e     self.type = N
+0000beb0: 6f6e 6520 2023 2074 7970 653a 2069 676e  one  # type: ign
+0000bec0: 6f72 650a 2020 2020 2020 2020 7365 6c66  ore.        self
+0000bed0: 2e67 726f 7570 5f6b 6579 203d 206b 6579  .group_key = key
+0000bee0: 5f73 706c 6974 5f67 726f 7570 286b 6579  _split_group(key
+0000bef0: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
+0000bf00: 726f 7570 203d 204e 6f6e 6520 2023 2074  roup = None  # t
+0000bf10: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+0000bf20: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
+0000bf30: 6120 3d20 7b7d 0a20 2020 2020 2020 2073  a = {}.        s
+0000bf40: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
+0000bf50: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+0000bf60: 662e 6572 7265 645f 6f6e 203d 2073 6574  f.erred_on = set
+0000bf70: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000bf80: 7275 6e5f 6964 203d 204e 6f6e 650a 2020  run_id = None.  
+0000bf90: 2020 2020 2020 5461 736b 5374 6174 652e        TaskState.
+0000bfa0: 5f69 6e73 7461 6e63 6573 2e61 6464 2873  _instances.add(s
+0000bfb0: 656c 6629 0a0a 2020 2020 6465 6620 5f5f  elf)..    def __
+0000bfc0: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
+0000bfd0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
+0000bfe0: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
+0000bff0: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
+0000c000: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
+0000c010: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
+0000c020: 2020 2020 2072 6574 7572 6e20 6973 696e       return isin
+0000c030: 7374 616e 6365 286f 7468 6572 2c20 5461  stance(other, Ta
+0000c040: 736b 5374 6174 6529 2061 6e64 2073 656c  skState) and sel
+0000c050: 662e 6b65 7920 3d3d 206f 7468 6572 2e6b  f.key == other.k
+0000c060: 6579 0a0a 2020 2020 4070 726f 7065 7274  ey..    @propert
+0000c070: 790a 2020 2020 6465 6620 7374 6174 6528  y.    def state(
+0000c080: 7365 6c66 2920 2d3e 2054 6173 6b53 7461  self) -> TaskSta
+0000c090: 7465 5374 6174 653a 0a20 2020 2020 2020  teState:.       
+0000c0a0: 2022 2222 5468 6973 2074 6173 6b27 7320   """This task's 
+0000c0b0: 6375 7272 656e 7420 7374 6174 652e 2020  current state.  
+0000c0c0: 5661 6c69 6420 7374 6174 6573 2061 7265  Valid states are
+0000c0d0: 2060 6072 656c 6561 7365 6460 602c 2060   ``released``, `
+0000c0e0: 6077 6169 7469 6e67 6060 2c0a 2020 2020  `waiting``,.    
+0000c0f0: 2020 2020 6060 6e6f 2d77 6f72 6b65 7260      ``no-worker`
+0000c100: 602c 2060 6070 726f 6365 7373 696e 6760  `, ``processing`
+0000c110: 602c 2060 606d 656d 6f72 7960 602c 2060  `, ``memory``, `
+0000c120: 6065 7272 6564 6060 2061 6e64 2060 6066  `erred`` and ``f
+0000c130: 6f72 676f 7474 656e 6060 2e20 2049 6620  orgotten``.  If 
+0000c140: 6974 0a20 2020 2020 2020 2069 7320 6060  it.        is ``
+0000c150: 666f 7267 6f74 7465 6e60 602c 2074 6865  forgotten``, the
+0000c160: 2074 6173 6b20 6973 6e27 7420 7374 6f72   task isn't stor
+0000c170: 6564 2069 6e20 7468 6520 6060 7461 736b  ed in the ``task
+0000c180: 7360 6020 6469 6374 696f 6e61 7279 2061  s`` dictionary a
+0000c190: 6e79 6d6f 7265 2061 6e64 0a20 2020 2020  nymore and.     
+0000c1a0: 2020 2077 696c 6c20 7072 6f62 6162 6c79     will probably
+0000c1b0: 2064 6973 6170 7065 6172 2073 6f6f 6e20   disappear soon 
+0000c1c0: 6672 6f6d 206d 656d 6f72 792e 0a20 2020  from memory..   
+0000c1d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000c1e0: 2072 6574 7572 6e20 7365 6c66 2e5f 7374   return self._st
+0000c1f0: 6174 650a 0a20 2020 2040 7374 6174 652e  ate..    @state.
+0000c200: 7365 7474 6572 0a20 2020 2064 6566 2073  setter.    def s
+0000c210: 7461 7465 2873 656c 662c 2076 616c 7565  tate(self, value
+0000c220: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000c230: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0000c240: 2020 2073 656c 662e 6772 6f75 702e 7374     self.group.st
+0000c250: 6174 6573 5b73 656c 662e 5f73 7461 7465  ates[self._state
+0000c260: 5d20 2d3d 2031 0a20 2020 2020 2020 2073  ] -= 1.        s
+0000c270: 656c 662e 6772 6f75 702e 7374 6174 6573  elf.group.states
+0000c280: 5b76 616c 7565 5d20 2b3d 2031 0a20 2020  [value] += 1.   
+0000c290: 2020 2020 2073 656c 662e 5f73 7461 7465       self._state
+0000c2a0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0000c2b0: 2073 656c 662e 7072 6566 6978 2e73 7461   self.prefix.sta
+0000c2c0: 7465 5f63 6f75 6e74 735b 7661 6c75 655d  te_counts[value]
+0000c2d0: 202b 3d20 310a 0a20 2020 2064 6566 2061   += 1..    def a
+0000c2e0: 6464 5f64 6570 656e 6465 6e63 7928 7365  dd_dependency(se
+0000c2f0: 6c66 2c20 6f74 6865 723a 2054 6173 6b53  lf, other: TaskS
+0000c300: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+0000c310: 2020 2020 2020 2022 2222 4164 6420 616e         """Add an
+0000c320: 6f74 6865 7220 7461 736b 2061 7320 6120  other task as a 
+0000c330: 6465 7065 6e64 656e 6379 206f 6620 7468  dependency of th
+0000c340: 6973 2074 6173 6b22 2222 0a20 2020 2020  is task""".     
+0000c350: 2020 2073 656c 662e 6465 7065 6e64 656e     self.dependen
+0000c360: 6369 6573 2e61 6464 286f 7468 6572 290a  cies.add(other).
+0000c370: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+0000c380: 7570 2e64 6570 656e 6465 6e63 6965 732e  up.dependencies.
+0000c390: 6164 6428 6f74 6865 722e 6772 6f75 7029  add(other.group)
+0000c3a0: 0a20 2020 2020 2020 206f 7468 6572 2e64  .        other.d
+0000c3b0: 6570 656e 6465 6e74 732e 6164 6428 7365  ependents.add(se
+0000c3c0: 6c66 290a 0a20 2020 2064 6566 2067 6574  lf)..    def get
+0000c3d0: 5f6e 6279 7465 7328 7365 6c66 2920 2d3e  _nbytes(self) ->
+0000c3e0: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+0000c3f0: 7475 726e 2073 656c 662e 6e62 7974 6573  turn self.nbytes
+0000c400: 2069 6620 7365 6c66 2e6e 6279 7465 7320   if self.nbytes 
+0000c410: 3e3d 2030 2065 6c73 6520 4445 4641 554c  >= 0 else DEFAUL
+0000c420: 545f 4441 5441 5f53 495a 450a 0a20 2020  T_DATA_SIZE..   
+0000c430: 2064 6566 2073 6574 5f6e 6279 7465 7328   def set_nbytes(
+0000c440: 7365 6c66 2c20 6e62 7974 6573 3a20 696e  self, nbytes: in
+0000c450: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+0000c460: 2020 2020 6469 6666 203d 206e 6279 7465      diff = nbyte
+0000c470: 730a 2020 2020 2020 2020 6f6c 645f 6e62  s.        old_nb
+0000c480: 7974 6573 203d 2073 656c 662e 6e62 7974  ytes = self.nbyt
+0000c490: 6573 0a20 2020 2020 2020 2069 6620 6f6c  es.        if ol
+0000c4a0: 645f 6e62 7974 6573 203e 3d20 303a 0a20  d_nbytes >= 0:. 
+0000c4b0: 2020 2020 2020 2020 2020 2064 6966 6620             diff 
+0000c4c0: 2d3d 206f 6c64 5f6e 6279 7465 730a 2020  -= old_nbytes.  
+0000c4d0: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
+0000c4e0: 2e6e 6279 7465 735f 746f 7461 6c20 2b3d  .nbytes_total +=
+0000c4f0: 2064 6966 660a 2020 2020 2020 2020 666f   diff.        fo
+0000c500: 7220 7773 2069 6e20 7365 6c66 2e77 686f  r ws in self.who
+0000c510: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0000c520: 2020 7773 2e6e 6279 7465 7320 2b3d 2064    ws.nbytes += d
+0000c530: 6966 660a 2020 2020 2020 2020 7365 6c66  iff.        self
+0000c540: 2e6e 6279 7465 7320 3d20 6e62 7974 6573  .nbytes = nbytes
+0000c550: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+0000c560: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+0000c570: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c580: 6622 3c54 6173 6b53 7461 7465 207b 7365  f"<TaskState {se
+0000c590: 6c66 2e6b 6579 2172 7d20 7b73 656c 662e  lf.key!r} {self.
+0000c5a0: 5f73 7461 7465 7d3e 220a 0a20 2020 2064  _state}>"..    d
+0000c5b0: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
+0000c5c0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+0000c5d0: 2020 2020 2072 6574 7572 6e20 6765 745f       return get_
+0000c5e0: 7465 6d70 6c61 7465 2822 7461 736b 5f73  template("task_s
+0000c5f0: 7461 7465 2e68 746d 6c2e 6a32 2229 2e72  tate.html.j2").r
+0000c600: 656e 6465 7228 0a20 2020 2020 2020 2020  ender(.         
+0000c610: 2020 2073 7461 7465 3d73 656c 662e 7374     state=self.st
+0000c620: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+0000c630: 206e 6279 7465 733d 7365 6c66 2e6e 6279   nbytes=self.nby
+0000c640: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+0000c650: 206b 6579 3d73 656c 662e 6b65 792c 0a20   key=self.key,. 
+0000c660: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0000c670: 6620 7661 6c69 6461 7465 2873 656c 6629  f validate(self)
+0000c680: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000c690: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000c6a0: 2020 2066 6f72 2063 7320 696e 2073 656c     for cs in sel
+0000c6b0: 662e 7768 6f5f 7761 6e74 733a 0a20 2020  f.who_wants:.   
+0000c6c0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c6d0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
+0000c6e0: 732c 2043 6c69 656e 7453 7461 7465 292c  s, ClientState),
+0000c6f0: 2028 7265 7072 2863 7329 2c20 7365 6c66   (repr(cs), self
+0000c700: 2e77 686f 5f77 616e 7473 290a 2020 2020  .who_wants).    
+0000c710: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+0000c720: 6e20 7365 6c66 2e77 686f 5f68 6173 3a0a  n self.who_has:.
+0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c740: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000c750: 6528 7773 2c20 576f 726b 6572 5374 6174  e(ws, WorkerStat
+0000c760: 6529 2c20 2872 6570 7228 7773 292c 2073  e), (repr(ws), s
+0000c770: 656c 662e 7768 6f5f 6861 7329 0a20 2020  elf.who_has).   
+0000c780: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
+0000c790: 696e 2073 656c 662e 6465 7065 6e64 656e  in self.dependen
+0000c7a0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+0000c7b0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000c7c0: 6e73 7461 6e63 6528 7473 2c20 5461 736b  nstance(ts, Task
+0000c7d0: 5374 6174 6529 2c20 2872 6570 7228 7473  State), (repr(ts
+0000c7e0: 292c 2073 656c 662e 6465 7065 6e64 656e  ), self.dependen
+0000c7f0: 6369 6573 290a 2020 2020 2020 2020 2020  cies).          
+0000c800: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
+0000c810: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+0000c820: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c830: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
+0000c840: 732c 2054 6173 6b53 7461 7465 292c 2028  s, TaskState), (
+0000c850: 7265 7072 2874 7329 2c20 7365 6c66 2e64  repr(ts), self.d
+0000c860: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
+0000c870: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
+0000c880: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
+0000c890: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000c8a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0000c8b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000c8c0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+0000c8d0: 2020 2020 2020 2020 2020 2020 6966 204c              if L
+0000c8e0: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
+0000c8f0: 2020 2020 2020 2020 696d 706f 7274 2070          import p
+0000c900: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
+0000c910: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
+0000c920: 6528 290a 0a20 2020 2064 6566 2067 6574  e()..    def get
+0000c930: 5f6e 6279 7465 735f 6465 7073 2873 656c  _nbytes_deps(sel
+0000c940: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+0000c950: 2020 2072 6574 7572 6e20 7375 6d28 7473     return sum(ts
+0000c960: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
+0000c970: 7220 7473 2069 6e20 7365 6c66 2e64 6570  r ts in self.dep
+0000c980: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
+0000c990: 6465 6620 5f74 6f5f 6469 6374 5f6e 6f5f  def _to_dict_no_
+0000c9a0: 6e65 7374 2873 656c 662c 202a 2c20 6578  nest(self, *, ex
+0000c9b0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
+0000c9c0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
+0000c9d0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0000c9e0: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
+0000c9f0: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
+0000ca00: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
+0000ca10: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
+0000ca20: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
+0000ca30: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
+0000ca40: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
+0000ca50: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
+0000ca60: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+0000ca70: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0000ca80: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
+0000ca90: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
+0000caa0: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
+0000cab0: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
+0000cac0: 5f64 6963 740a 0a20 2020 2020 2020 204e  _dict..        N
+0000cad0: 6f74 6573 0a20 2020 2020 2020 202d 2d2d  otes.        ---
+0000cae0: 2d2d 0a20 2020 2020 2020 2054 6869 7320  --.        This 
+0000caf0: 636c 6173 7320 7573 6573 2060 605f 746f  class uses ``_to
+0000cb00: 5f64 6963 745f 6e6f 5f6e 6573 7460 6020  _dict_no_nest`` 
+0000cb10: 696e 7374 6561 6420 6f66 2060 605f 746f  instead of ``_to
+0000cb20: 5f64 6963 7460 602e 0a20 2020 2020 2020  _dict``..       
+0000cb30: 2057 6865 6e20 6120 7461 736b 2072 6566   When a task ref
+0000cb40: 6572 656e 6365 7320 616e 6f74 6865 7220  erences another 
+0000cb50: 7461 736b 2c20 6f72 2077 6865 6e20 6120  task, or when a 
+0000cb60: 576f 726b 6572 5374 6174 652e 7461 736b  WorkerState.task
+0000cb70: 7320 636f 6e74 6169 6e73 2074 6173 6b73  s contains tasks
+0000cb80: 2c0a 2020 2020 2020 2020 7468 6973 206d  ,.        this m
+0000cb90: 6574 686f 6420 6973 206e 6f74 2065 7865  ethod is not exe
+0000cba0: 6375 7465 6420 666f 7220 7468 6520 696e  cuted for the in
+0000cbb0: 6e65 7220 7461 736b 2c20 6576 656e 2069  ner task, even i
+0000cbc0: 6620 7468 6520 696e 6e65 7220 7461 736b  f the inner task
+0000cbd0: 2077 6173 206e 6576 6572 0a20 2020 2020   was never.     
+0000cbe0: 2020 2073 6565 6e20 6265 666f 7265 3b20     seen before; 
+0000cbf0: 796f 7520 6765 7420 6120 7265 7072 2069  you get a repr i
+0000cc00: 6e73 7465 6164 2e20 416c 6c20 7461 736b  nstead. All task
+0000cc10: 7320 7368 6f75 6c64 206e 6561 746c 7920  s should neatly 
+0000cc20: 6170 7065 6172 2075 6e64 6572 0a20 2020  appear under.   
+0000cc30: 2020 2020 2053 6368 6564 756c 6572 2e74       Scheduler.t
+0000cc40: 6173 6b73 2e20 5468 6973 2061 6c73 6f20  asks. This also 
+0000cc50: 7072 6576 656e 7473 2061 2052 6563 7572  prevents a Recur
+0000cc60: 7369 6f6e 4572 726f 7220 6475 7269 6e67  sionError during
+0000cc70: 2070 6172 7469 6375 6c61 726c 7920 6865   particularly he
+0000cc80: 6176 790a 2020 2020 2020 2020 6c6f 6164  avy.        load
+0000cc90: 732c 2077 6869 6368 2068 6176 6520 6265  s, which have be
+0000cca0: 656e 206f 6273 6572 7665 6420 746f 2068  en observed to h
+0000ccb0: 6170 7065 6e20 7768 656e 6576 6572 2074  appen whenever t
+0000ccc0: 6865 7265 2773 2061 6e20 6163 7963 6c69  here's an acycli
+0000ccd0: 6320 6465 7065 6e64 656e 6379 0a20 2020  c dependency.   
+0000cce0: 2020 2020 2063 6861 696e 206f 6620 7e32       chain of ~2
+0000ccf0: 3030 2b20 7461 736b 732e 0a20 2020 2020  00+ tasks..     
+0000cd00: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000cd10: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
+0000cd20: 746f 5f64 6963 7428 7365 6c66 2c20 6578  to_dict(self, ex
+0000cd30: 636c 7564 653d 6578 636c 7564 652c 206d  clude=exclude, m
+0000cd40: 656d 6265 7273 3d54 7275 6529 0a0a 0a63  embers=True)...c
+0000cd50: 6c61 7373 2054 7261 6e73 6974 696f 6e28  lass Transition(
+0000cd60: 4e61 6d65 6454 7570 6c65 293a 0a20 2020  NamedTuple):.   
+0000cd70: 2022 2222 416e 2065 6e74 7279 2069 6e20   """An entry in 
+0000cd80: 3a61 7474 723a 6053 6368 6564 756c 6572  :attr:`Scheduler
+0000cd90: 5374 6174 652e 7472 616e 7369 7469 6f6e  State.transition
+0000cda0: 5f6c 6f67 6022 2222 0a0a 2020 2020 6b65  _log`"""..    ke
+0000cdb0: 793a 2073 7472 0a20 2020 2073 7461 7274  y: str.    start
+0000cdc0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000cdd0: 0a20 2020 2066 696e 6973 683a 2054 6173  .    finish: Tas
+0000cde0: 6b53 7461 7465 5374 6174 650a 2020 2020  kStateState.    
+0000cdf0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+0000ce00: 2052 6563 730a 2020 2020 7374 696d 756c   Recs.    stimul
+0000ce10: 7573 5f69 643a 2073 7472 0a20 2020 2074  us_id: str.    t
+0000ce20: 696d 6573 7461 6d70 3a20 666c 6f61 740a  imestamp: float.
+0000ce30: 0a0a 636c 6173 7320 5363 6865 6475 6c65  ..class Schedule
+0000ce40: 7253 7461 7465 3a0a 2020 2020 2222 2255  rState:.    """U
+0000ce50: 6e64 6572 6c79 696e 6720 7461 736b 2073  nderlying task s
+0000ce60: 7461 7465 206f 6620 6479 6e61 6d69 6320  tate of dynamic 
+0000ce70: 7363 6865 6475 6c65 720a 0a20 2020 2054  scheduler..    T
+0000ce80: 7261 636b 7320 7468 6520 6375 7272 656e  racks the curren
+0000ce90: 7420 7374 6174 6520 6f66 2077 6f72 6b65  t state of worke
+0000cea0: 7273 2c20 6461 7461 2c20 616e 6420 636f  rs, data, and co
+0000ceb0: 6d70 7574 6174 696f 6e73 2e0a 0a20 2020  mputations...   
+0000cec0: 2048 616e 646c 6573 2074 7261 6e73 6974   Handles transit
+0000ced0: 696f 6e73 2062 6574 7765 656e 2064 6966  ions between dif
+0000cee0: 6665 7265 6e74 2074 6173 6b20 7374 6174  ferent task stat
+0000cef0: 6573 2e20 4e6f 7469 6669 6573 2074 6865  es. Notifies the
+0000cf00: 0a20 2020 2053 6368 6564 756c 6572 206f  .    Scheduler o
+0000cf10: 6620 6368 616e 6765 7320 6279 206d 6573  f changes by mes
+0000cf20: 7361 6769 6e67 2070 6173 7369 6e67 2074  saging passing t
+0000cf30: 6872 6f75 6768 2051 7565 7565 732c 2077  hrough Queues, w
+0000cf40: 6869 6368 2074 6865 0a20 2020 2053 6368  hich the.    Sch
+0000cf50: 6564 756c 6572 206c 6973 7465 6e73 2074  eduler listens t
+0000cf60: 6f20 7265 7370 6f6e 6473 2061 6363 6f72  o responds accor
+0000cf70: 6469 6e67 6c79 2e0a 0a20 2020 2041 6c6c  dingly...    All
+0000cf80: 2065 7665 6e74 7320 6172 6520 6861 6e64   events are hand
+0000cf90: 6c65 6420 7175 6963 6b6c 792c 2069 6e20  led quickly, in 
+0000cfa0: 6c69 6e65 6172 2074 696d 6520 7769 7468  linear time with
+0000cfb0: 2072 6573 7065 6374 2074 6f20 7468 6569   respect to thei
+0000cfc0: 720a 2020 2020 696e 7075 7420 2877 6869  r.    input (whi
+0000cfd0: 6368 2069 7320 6f66 7465 6e20 6f66 2063  ch is often of c
+0000cfe0: 6f6e 7374 616e 7420 7369 7a65 2920 616e  onstant size) an
+0000cff0: 6420 6765 6e65 7261 6c6c 7920 7769 7468  d generally with
+0000d000: 696e 2061 0a20 2020 206d 696c 6c69 7365  in a.    millise
+0000d010: 636f 6e64 2e0a 0a20 2020 2055 7365 7273  cond...    Users
+0000d020: 2074 7970 6963 616c 6c79 2064 6f20 6e6f   typically do no
+0000d030: 7420 696e 7465 7261 6374 2077 6974 6820  t interact with 
+0000d040: 6060 5472 616e 7369 7469 6f6e 7360 6020  ``Transitions`` 
+0000d050: 6469 7265 6374 6c79 2e20 496e 7374 6561  directly. Instea
+0000d060: 640a 2020 2020 7573 6572 7320 696e 7465  d.    users inte
+0000d070: 7261 6374 2077 6974 6820 7468 6520 6060  ract with the ``
+0000d080: 436c 6965 6e74 6060 2c20 7768 6963 6820  Client``, which 
+0000d090: 696e 2074 7572 6e20 656e 6761 6765 7320  in turn engages 
+0000d0a0: 7468 650a 2020 2020 6060 5363 6865 6475  the.    ``Schedu
+0000d0b0: 6c65 7260 6020 6166 6665 6374 696e 6720  ler`` affecting 
+0000d0c0: 6469 6666 6572 656e 7420 7472 616e 7369  different transi
+0000d0d0: 7469 6f6e 7320 6865 7265 2075 6e64 6572  tions here under
+0000d0e0: 2d74 6865 2d68 6f6f 642e 2049 6e0a 2020  -the-hood. In.  
+0000d0f0: 2020 7468 6520 6261 636b 6772 6f75 6e64    the background
+0000d100: 2060 6057 6f72 6b65 7260 6073 2061 6c73   ``Worker``s als
+0000d110: 6f20 656e 6761 6765 2077 6974 6820 7468  o engage with th
+0000d120: 6520 6060 5363 6865 6475 6c65 7260 600a  e ``Scheduler``.
+0000d130: 2020 2020 6166 6665 6374 696e 6720 7468      affecting th
+0000d140: 6573 6520 7374 6174 6520 7472 616e 7369  ese state transi
+0000d150: 7469 6f6e 7320 6173 2077 656c 6c2e 0a20  tions as well.. 
+0000d160: 2020 2022 2222 0a0a 2020 2020 6261 6e64     """..    band
+0000d170: 7769 6474 683a 2069 6e74 0a0a 2020 2020  width: int..    
+0000d180: 233a 2043 6c69 656e 7473 2063 7572 7265  #: Clients curre
+0000d190: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
+0000d1a0: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
+0000d1b0: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
+0000d1c0: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
+0000d1d0: 7465 5d0a 0a20 2020 2065 7874 656e 7369  te]..    extensi
+0000d1e0: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
+0000d1f0: 6e79 5d20 2023 2054 4f44 4f20 7772 6974  ny]  # TODO writ
+0000d200: 6520 6120 7363 6865 6475 6c65 7220 6578  e a scheduler ex
+0000d210: 7465 6e73 696f 6e20 5072 6f74 6f63 6f6c  tension Protocol
+0000d220: 0a20 2020 2070 6c75 6769 6e73 3a20 6469  .    plugins: di
+0000d230: 6374 5b73 7472 2c20 5363 6865 6475 6c65  ct[str, Schedule
+0000d240: 7250 6c75 6769 6e5d 0a20 2020 2068 6f73  rPlugin].    hos
+0000d250: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
+0000d260: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
+0000d270: 5d0a 0a20 2020 2023 3a20 4966 2054 7275  ]..    #: If Tru
+0000d280: 652c 2065 6e61 626c 6520 6578 7065 6e73  e, enable expens
+0000d290: 6976 6520 696e 7465 726e 616c 2063 6f6e  ive internal con
+0000d2a0: 7369 7374 656e 6379 2063 6865 636b 2e0a  sistency check..
+0000d2b0: 2020 2020 233a 2054 7970 6963 616c 6c79      #: Typically
+0000d2c0: 2064 6973 6162 6c65 6420 696e 2070 726f   disabled in pro
+0000d2d0: 6475 6374 696f 6e2e 0a20 2020 2076 616c  duction..    val
+0000d2e0: 6964 6174 653a 2062 6f6f 6c0a 0a20 2020  idate: bool..   
+0000d2f0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0000d300: 2323 2323 2323 2323 0a20 2020 2023 2057  ########.    # W
+0000d310: 6f72 6b65 7273 2d72 656c 6174 6564 2073  orkers-related s
+0000d320: 7461 7465 0a20 2020 2023 2323 2323 2323  tate.    #######
+0000d330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d340: 0a0a 2020 2020 233a 2057 6f72 6b65 7273  ..    #: Workers
+0000d350: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
+0000d360: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
+0000d370: 6475 6c65 720a 2020 2020 233a 2028 6163  duler.    #: (ac
+0000d380: 7475 616c 6c79 2061 2053 6f72 7465 6444  tually a SortedD
+0000d390: 6963 742c 2062 7574 2074 6865 2073 6f72  ict, but the sor
+0000d3a0: 7465 6463 6f6e 7461 696e 6572 7320 7061  tedcontainers pa
+0000d3b0: 636b 6167 6520 6973 6e27 7420 616e 6e6f  ckage isn't anno
+0000d3c0: 7461 7465 6429 0a20 2020 2077 6f72 6b65  tated).    worke
+0000d3d0: 7273 3a20 6469 6374 5b73 7472 2c20 576f  rs: dict[str, Wo
+0000d3e0: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
+0000d3f0: 3a20 576f 726b 6572 207b 6e61 6d65 3a20  : Worker {name: 
+0000d400: 6164 6472 6573 737d 0a20 2020 2061 6c69  address}.    ali
+0000d410: 6173 6573 3a20 6469 6374 5b48 6173 6861  ases: dict[Hasha
+0000d420: 626c 652c 2073 7472 5d0a 2020 2020 233a  ble, str].    #:
+0000d430: 2057 6f72 6b65 7273 2074 6861 7420 6172   Workers that ar
+0000d440: 6520 6375 7272 656e 746c 7920 696e 2072  e currently in r
+0000d450: 756e 6e69 6e67 2073 7461 7465 0a20 2020  unning state.   
+0000d460: 2072 756e 6e69 6e67 3a20 7365 745b 576f   running: set[Wo
+0000d470: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
+0000d480: 3a20 576f 726b 6572 7320 7468 6174 2061  : Workers that a
+0000d490: 7265 2063 7572 7265 6e74 6c79 2069 6e20  re currently in 
+0000d4a0: 7275 6e6e 696e 6720 7374 6174 6520 616e  running state an
+0000d4b0: 6420 6e6f 7420 6675 6c6c 7920 7574 696c  d not fully util
+0000d4c0: 697a 6564 0a20 2020 2023 3a20 4465 6669  ized.    #: Defi
+0000d4d0: 6e69 7469 6f6e 2062 6173 6564 206f 6e20  nition based on 
+0000d4e0: 6f63 6375 7061 6e63 790a 2020 2020 233a  occupancy.    #:
+0000d4f0: 2028 6163 7475 616c 6c79 2061 2053 6f72   (actually a Sor
+0000d500: 7465 6444 6963 742c 2062 7574 2074 6865  tedDict, but the
+0000d510: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
+0000d520: 7320 7061 636b 6167 6520 6973 6e27 7420  s package isn't 
+0000d530: 616e 6e6f 7461 7465 6429 2e0a 2020 2020  annotated)..    
+0000d540: 233a 204e 6f74 2074 6f20 6265 2063 6f6e  #: Not to be con
+0000d550: 6675 7365 6420 7769 7468 203a 6d65 7468  fused with :meth
+0000d560: 3a60 6973 5f69 646c 6560 2e0a 2020 2020  :`is_idle`..    
+0000d570: 6964 6c65 3a20 6469 6374 5b73 7472 2c20  idle: dict[str, 
+0000d580: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
+0000d590: 2023 3a20 5369 6d69 6c61 7220 746f 2060   #: Similar to `
+0000d5a0: 6964 6c65 600a 2020 2020 233a 2044 6566  idle`.    #: Def
+0000d5b0: 696e 6974 696f 6e20 6261 7365 6420 6f6e  inition based on
+0000d5c0: 2061 7373 6967 6e65 6420 7461 736b 730a   assigned tasks.
+0000d5d0: 2020 2020 6964 6c65 5f74 6173 6b5f 636f      idle_task_co
+0000d5e0: 756e 743a 2073 6574 5b57 6f72 6b65 7253  unt: set[WorkerS
+0000d5f0: 7461 7465 5d0a 2020 2020 233a 2057 6f72  tate].    #: Wor
+0000d600: 6b65 7273 2074 6861 7420 6172 6520 6675  kers that are fu
+0000d610: 6c6c 7920 7574 696c 697a 6564 2e20 4d61  lly utilized. Ma
+0000d620: 7920 696e 636c 7564 6520 6e6f 6e2d 7275  y include non-ru
+0000d630: 6e6e 696e 6720 776f 726b 6572 732e 0a20  nning workers.. 
+0000d640: 2020 2073 6174 7572 6174 6564 3a20 7365     saturated: se
+0000d650: 745b 576f 726b 6572 5374 6174 655d 0a20  t[WorkerState]. 
+0000d660: 2020 2074 6f74 616c 5f6e 7468 7265 6164     total_nthread
+0000d670: 733a 2069 6e74 0a20 2020 2023 3a20 436c  s: int.    #: Cl
+0000d680: 7573 7465 722d 7769 6465 2072 6573 6f75  uster-wide resou
+0000d690: 7263 6573 2e20 7b72 6573 6f75 7263 6520  rces. {resource 
+0000d6a0: 6e61 6d65 3a20 7b77 6f72 6b65 7220 6164  name: {worker ad
+0000d6b0: 6472 6573 733a 2061 6d6f 756e 747d 7d0a  dress: amount}}.
+0000d6c0: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
+0000d6d0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
+0000d6e0: 722c 2066 6c6f 6174 5d5d 0a0a 2020 2020  r, float]]..    
+0000d6f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d700: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
+0000d710: 732d 7265 6c61 7465 6420 7374 6174 650a  s-related state.
+0000d720: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0000d730: 2323 2323 2323 2323 230a 0a20 2020 2023  #########..    #
+0000d740: 3a20 546f 7461 6c20 6e75 6d62 6572 206f  : Total number o
+0000d750: 6620 7461 736b 7320 6576 6572 2070 726f  f tasks ever pro
+0000d760: 6365 7373 6564 0a20 2020 206e 5f74 6173  cessed.    n_tas
+0000d770: 6b73 3a20 696e 740a 0a20 2020 2023 3a20  ks: int..    #: 
+0000d780: 416c 6c20 7461 736b 7320 6375 7272 656e  All tasks curren
+0000d790: 746c 7920 6b6e 6f77 6e20 746f 2074 6865  tly known to the
+0000d7a0: 2073 6368 6564 756c 6572 0a20 2020 2074   scheduler.    t
+0000d7b0: 6173 6b73 3a20 6469 6374 5b73 7472 2c20  asks: dict[str, 
+0000d7c0: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
+0000d7d0: 233a 2054 6173 6b73 2069 6e20 7468 6520  #: Tasks in the 
+0000d7e0: 2271 7565 7565 6422 2073 7461 7465 2c20  "queued" state, 
+0000d7f0: 6f72 6465 7265 6420 6279 2070 7269 6f72  ordered by prior
+0000d800: 6974 790a 2020 2020 7175 6575 6564 3a20  ity.    queued: 
+0000d810: 4865 6170 5365 745b 5461 736b 5374 6174  HeapSet[TaskStat
+0000d820: 655d 0a0a 2020 2020 233a 2054 6173 6b73  e]..    #: Tasks
+0000d830: 2069 6e20 7468 6520 226e 6f2d 776f 726b   in the "no-work
+0000d840: 6572 2220 7374 6174 650a 2020 2020 756e  er" state.    un
+0000d850: 7275 6e6e 6162 6c65 3a20 7365 745b 5461  runnable: set[Ta
+0000d860: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
+0000d870: 2053 7562 7365 7420 6f66 2074 6173 6b73   Subset of tasks
+0000d880: 2074 6861 7420 6578 6973 7420 696e 206d   that exist in m
+0000d890: 656d 6f72 7920 6f6e 206d 6f72 6520 7468  emory on more th
+0000d8a0: 616e 206f 6e65 2077 6f72 6b65 720a 2020  an one worker.  
+0000d8b0: 2020 7265 706c 6963 6174 6564 5f74 6173    replicated_tas
+0000d8c0: 6b73 3a20 7365 745b 5461 736b 5374 6174  ks: set[TaskStat
+0000d8d0: 655d 0a0a 2020 2020 756e 6b6e 6f77 6e5f  e]..    unknown_
+0000d8e0: 6475 7261 7469 6f6e 733a 2064 6963 745b  durations: dict[
+0000d8f0: 7374 722c 2073 6574 5b54 6173 6b53 7461  str, set[TaskSta
+0000d900: 7465 5d5d 0a20 2020 2074 6173 6b5f 6772  te]].    task_gr
+0000d910: 6f75 7073 3a20 6469 6374 5b73 7472 2c20  oups: dict[str, 
+0000d920: 5461 736b 4772 6f75 705d 0a20 2020 2074  TaskGroup].    t
+0000d930: 6173 6b5f 7072 6566 6978 6573 3a20 6469  ask_prefixes: di
+0000d940: 6374 5b73 7472 2c20 5461 736b 5072 6566  ct[str, TaskPref
+0000d950: 6978 5d0a 2020 2020 7461 736b 5f6d 6574  ix].    task_met
+0000d960: 6164 6174 613a 2064 6963 745b 7374 722c  adata: dict[str,
+0000d970: 2041 6e79 5d0a 0a20 2020 2023 2323 2323   Any]..    #####
+0000d980: 2323 2323 0a20 2020 2023 2048 6973 746f  ####.    # Histo
+0000d990: 7279 0a20 2020 2023 2323 2323 2323 2323  ry.    #########
+0000d9a0: 0a0a 2020 2020 233a 2048 6973 746f 7279  ..    #: History
+0000d9b0: 206f 6620 636f 6d70 7574 6174 696f 6e73   of computations
+0000d9c0: 2e0a 2020 2020 233a 2054 6865 206c 656e  ..    #: The len
+0000d9d0: 6774 6820 6361 6e20 6265 2074 7765 616b  gth can be tweak
+0000d9e0: 6564 2074 6872 6f75 6768 0a20 2020 2023  ed through.    #
+0000d9f0: 3a20 6469 7374 7269 6275 7465 642e 6469  : distributed.di
+0000da00: 6167 6e6f 7374 6963 732e 636f 6d70 7574  agnostics.comput
+0000da10: 6174 696f 6e73 2e6d 6178 2d68 6973 746f  ations.max-histo
+0000da20: 7279 0a20 2020 2063 6f6d 7075 7461 7469  ry.    computati
+0000da30: 6f6e 733a 2064 6571 7565 5b43 6f6d 7075  ons: deque[Compu
+0000da40: 7461 7469 6f6e 5d0a 0a20 2020 2023 3a20  tation]..    #: 
+0000da50: 4869 7374 6f72 7920 6f66 2065 7272 6564  History of erred
+0000da60: 2074 6173 6b73 2e0a 2020 2020 233a 2054   tasks..    #: T
+0000da70: 6865 206c 656e 6774 6820 6361 6e20 6265  he length can be
+0000da80: 2074 7765 616b 6564 2074 6872 6f75 6768   tweaked through
+0000da90: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000daa0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
+0000dab0: 6572 7265 642d 7461 736b 732e 6d61 782d  erred-tasks.max-
+0000dac0: 6869 7374 6f72 790a 2020 2020 6572 7265  history.    erre
+0000dad0: 645f 7461 736b 733a 2064 6571 7565 5b45  d_tasks: deque[E
+0000dae0: 7272 6564 5461 736b 5d0a 0a20 2020 2023  rredTask]..    #
+0000daf0: 3a20 4869 7374 6f72 7920 6f66 2074 6173  : History of tas
+0000db00: 6b20 7374 6174 6520 7472 616e 7369 7469  k state transiti
+0000db10: 6f6e 732e 0a20 2020 2023 3a20 5468 6520  ons..    #: The 
+0000db20: 6c65 6e67 7468 2063 616e 2062 6520 7477  length can be tw
+0000db30: 6561 6b65 6420 7468 726f 7567 680a 2020  eaked through.  
+0000db40: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
+0000db50: 2e73 6368 6564 756c 6572 2e74 7261 6e73  .scheduler.trans
+0000db60: 6974 696f 6e2d 6c6f 672d 6c65 6e67 7468  ition-log-length
+0000db70: 0a20 2020 2074 7261 6e73 6974 696f 6e5f  .    transition_
+0000db80: 6c6f 673a 2064 6571 7565 5b54 7261 6e73  log: deque[Trans
+0000db90: 6974 696f 6e5d 0a0a 2020 2020 233a 2054  ition]..    #: T
+0000dba0: 6f74 616c 206e 756d 6265 7220 6f66 2074  otal number of t
+0000dbb0: 7261 6e73 6974 696f 6e73 2073 696e 6365  ransitions since
+0000dbc0: 2074 6865 2063 6c75 7374 6572 2077 6173   the cluster was
+0000dbd0: 2073 7461 7274 6564 0a20 2020 2074 7261   started.    tra
+0000dbe0: 6e73 6974 696f 6e5f 636f 756e 7465 723a  nsition_counter:
+0000dbf0: 2069 6e74 0a0a 2020 2020 233a 2054 6f74   int..    #: Tot
+0000dc00: 616c 206e 756d 6265 7220 6f66 2074 7261  al number of tra
+0000dc10: 6e73 6974 696f 6e73 2061 7320 6f66 2074  nsitions as of t
+0000dc20: 6865 2070 7265 7669 6f75 7320 6361 6c6c  he previous call
+0000dc30: 2074 6f20 6368 6563 6b5f 6964 6c65 2829   to check_idle()
+0000dc40: 0a20 2020 205f 6964 6c65 5f74 7261 6e73  .    _idle_trans
+0000dc50: 6974 696f 6e5f 636f 756e 7465 723a 2069  ition_counter: i
+0000dc60: 6e74 0a0a 2020 2020 233a 2052 6169 7365  nt..    #: Raise
+0000dc70: 2061 6e20 6572 726f 7220 6966 2074 6865   an error if the
+0000dc80: 203a 6174 7472 3a60 7472 616e 7369 7469   :attr:`transiti
+0000dc90: 6f6e 5f63 6f75 6e74 6572 6020 6576 6572  on_counter` ever
+0000dca0: 2072 6561 6368 6573 2074 6869 7320 7661   reaches this va
+0000dcb0: 6c75 652e 0a20 2020 2023 3a20 5468 6973  lue..    #: This
+0000dcc0: 2069 7320 6d65 616e 7420 666f 7220 6465   is meant for de
+0000dcd0: 6275 6767 696e 6720 6f6e 6c79 2c20 746f  bugging only, to
+0000dce0: 2063 6174 6368 2069 6e66 696e 6974 6520   catch infinite 
+0000dcf0: 7265 6375 7273 696f 6e20 6c6f 6f70 732e  recursion loops.
+0000dd00: 0a20 2020 2023 3a20 496e 2070 726f 6475  .    #: In produ
+0000dd10: 6374 696f 6e2c 2069 7420 7368 6f75 6c64  ction, it should
+0000dd20: 2061 6c77 6179 7320 6265 2073 6574 2074   always be set t
+0000dd30: 6f20 4661 6c73 652e 0a20 2020 2074 7261  o False..    tra
+0000dd40: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+0000dd50: 6d61 783a 2069 6e74 207c 204c 6974 6572  max: int | Liter
+0000dd60: 616c 5b46 616c 7365 5d0a 0a20 2020 205f  al[False]..    _
+0000dd70: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+0000dd80: 745f 676c 6f62 616c 3a20 6465 6661 756c  t_global: defaul
+0000dd90: 7464 6963 745b 7374 722c 2069 6e74 5d0a  tdict[str, int].
+0000dda0: 2020 2020 5f6e 6574 776f 726b 5f6f 6363      _network_occ
+0000ddb0: 5f67 6c6f 6261 6c3a 2066 6c6f 6174 0a20  _global: float. 
+0000ddc0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+0000ddd0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000dde0: 4361 6368 6564 2063 6f6e 6669 6775 7261  Cached configura
+0000ddf0: 7469 6f6e 0a20 2020 2023 2323 2323 2323  tion.    #######
+0000de00: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000de10: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000de20: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
+0000de30: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
+0000de40: 696f 6e0a 2020 2020 554e 4b4e 4f57 4e5f  ion.    UNKNOWN_
+0000de50: 5441 534b 5f44 5552 4154 494f 4e3a 2066  TASK_DURATION: f
+0000de60: 6c6f 6174 0a20 2020 2023 3a20 6469 7374  loat.    #: dist
+0000de70: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0000de80: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
+0000de90: 6f6c 642d 7469 6d65 0a20 2020 204d 454d  old-time.    MEM
+0000dea0: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
+0000deb0: 445f 5449 4d45 3a20 666c 6f61 740a 2020  D_TIME: float.  
+0000dec0: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
+0000ded0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+0000dee0: 6562 616c 616e 6365 2e6d 6561 7375 7265  ebalance.measure
+0000def0: 0a20 2020 204d 454d 4f52 595f 5245 4241  .    MEMORY_REBA
+0000df00: 4c41 4e43 455f 4d45 4153 5552 453a 2073  LANCE_MEASURE: s
+0000df10: 7472 0a20 2020 2023 3a20 6469 7374 7269  tr.    #: distri
+0000df20: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000df30: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+0000df40: 6e64 6572 2d6d 696e 0a20 2020 204d 454d  nder-min.    MEM
+0000df50: 4f52 595f 5245 4241 4c41 4e43 455f 5345  ORY_REBALANCE_SE
+0000df60: 4e44 4552 5f4d 494e 3a20 666c 6f61 740a  NDER_MIN: float.
+0000df70: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
+0000df80: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000df90: 2e72 6562 616c 616e 6365 2e72 6563 6970  .rebalance.recip
+0000dfa0: 6965 6e74 2d6d 6178 0a20 2020 204d 454d  ient-max.    MEM
+0000dfb0: 4f52 595f 5245 4241 4c41 4e43 455f 5245  ORY_REBALANCE_RE
+0000dfc0: 4349 5049 454e 545f 4d41 583a 2066 6c6f  CIPIENT_MAX: flo
+0000dfd0: 6174 0a20 2020 2023 3a20 6469 7374 7269  at.    #: distri
+0000dfe0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000dff0: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+0000e000: 6e64 6572 2d72 6563 6970 6965 6e74 2d67  nder-recipient-g
+0000e010: 6170 202f 2032 0a20 2020 204d 454d 4f52  ap / 2.    MEMOR
+0000e020: 595f 5245 4241 4c41 4e43 455f 4841 4c46  Y_REBALANCE_HALF
+0000e030: 5f47 4150 3a20 666c 6f61 740a 2020 2020  _GAP: float.    
+0000e040: 233a 2064 6973 7472 6962 7574 6564 2e73  #: distributed.s
+0000e050: 6368 6564 756c 6572 2e77 6f72 6b65 722d  cheduler.worker-
+0000e060: 7361 7475 7261 7469 6f6e 0a20 2020 2057  saturation.    W
+0000e070: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000e080: 3a20 666c 6f61 740a 0a20 2020 205f 5f73  : float..    __s
+0000e090: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+0000e0a0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+0000e0b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000e0c0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+0000e0d0: 0a20 2020 2020 2020 2061 6c69 6173 6573  .        aliases
+0000e0e0: 3a20 6469 6374 5b48 6173 6861 626c 652c  : dict[Hashable,
+0000e0f0: 2073 7472 5d2c 0a20 2020 2020 2020 2063   str],.        c
+0000e100: 6c69 656e 7473 3a20 6469 6374 5b73 7472  lients: dict[str
+0000e110: 2c20 436c 6965 6e74 5374 6174 655d 2c0a  , ClientState],.
+0000e120: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+0000e130: 2053 6f72 7465 6444 6963 745b 7374 722c   SortedDict[str,
+0000e140: 2057 6f72 6b65 7253 7461 7465 5d2c 0a20   WorkerState],. 
+0000e150: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
+0000e160: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
+0000e170: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
+0000e180: 2020 2020 2072 6573 6f75 7263 6573 3a20       resources: 
+0000e190: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+0000e1a0: 7472 2c20 666c 6f61 745d 5d2c 0a20 2020  tr, float]],.   
+0000e1b0: 2020 2020 2074 6173 6b73 3a20 6469 6374       tasks: dict
+0000e1c0: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
+0000e1d0: 2c0a 2020 2020 2020 2020 756e 7275 6e6e  ,.        unrunn
+0000e1e0: 6162 6c65 3a20 7365 745b 5461 736b 5374  able: set[TaskSt
+0000e1f0: 6174 655d 2c0a 2020 2020 2020 2020 7175  ate],.        qu
+0000e200: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
+0000e210: 736b 5374 6174 655d 2c0a 2020 2020 2020  skState],.      
+0000e220: 2020 7661 6c69 6461 7465 3a20 626f 6f6c    validate: bool
+0000e230: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
+0000e240: 733a 2049 7465 7261 626c 655b 5363 6865  s: Iterable[Sche
+0000e250: 6475 6c65 7250 6c75 6769 6e5d 203d 2028  dulerPlugin] = (
+0000e260: 292c 0a20 2020 2020 2020 2074 7261 6e73  ),.        trans
+0000e270: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+0000e280: 783a 2069 6e74 207c 204c 6974 6572 616c  x: int | Literal
+0000e290: 5b46 616c 7365 5d20 3d20 4661 6c73 652c  [False] = False,
+0000e2a0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0000e2b0: 733a 2041 6e79 2c20 2023 2050 6173 7365  s: Any,  # Passe
+0000e2c0: 6420 7665 7262 6174 696d 2074 6f20 5365  d verbatim to Se
+0000e2d0: 7276 6572 2e5f 5f69 6e69 745f 5f28 290a  rver.__init__().
+0000e2e0: 2020 2020 293a 0a20 2020 2020 2020 206c      ):.        l
+0000e2f0: 6f67 6765 722e 696e 666f 2822 5374 6174  ogger.info("Stat
+0000e300: 6520 7374 6172 7422 290a 2020 2020 2020  e start").      
+0000e310: 2020 7365 6c66 2e61 6c69 6173 6573 203d    self.aliases =
+0000e320: 2061 6c69 6173 6573 0a20 2020 2020 2020   aliases.       
+0000e330: 2073 656c 662e 6261 6e64 7769 6474 6820   self.bandwidth 
+0000e340: 3d20 7061 7273 655f 6279 7465 7328 6461  = parse_bytes(da
+0000e350: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0000e360: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0000e370: 756c 6572 2e62 616e 6477 6964 7468 2229  uler.bandwidth")
+0000e380: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000e390: 6c69 656e 7473 203d 2063 6c69 656e 7473  lients = clients
+0000e3a0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000e3b0: 6965 6e74 735b 2266 6972 652d 616e 642d  ients["fire-and-
+0000e3c0: 666f 7267 6574 225d 203d 2043 6c69 656e  forget"] = Clien
+0000e3d0: 7453 7461 7465 2822 6669 7265 2d61 6e64  tState("fire-and
+0000e3e0: 2d66 6f72 6765 7422 290a 2020 2020 2020  -forget").      
+0000e3f0: 2020 7365 6c66 2e65 7874 656e 7369 6f6e    self.extension
+0000e400: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
+0000e410: 656c 662e 686f 7374 5f69 6e66 6f20 3d20  elf.host_info = 
+0000e420: 686f 7374 5f69 6e66 6f0a 2020 2020 2020  host_info.      
+0000e430: 2020 7365 6c66 2e69 646c 6520 3d20 536f    self.idle = So
+0000e440: 7274 6564 4469 6374 2829 0a20 2020 2020  rtedDict().     
+0000e450: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+0000e460: 6b5f 636f 756e 7420 3d20 7365 7428 290a  k_count = set().
+0000e470: 2020 2020 2020 2020 7365 6c66 2e6e 5f74          self.n_t
+0000e480: 6173 6b73 203d 2030 0a20 2020 2020 2020  asks = 0.       
+0000e490: 2073 656c 662e 7265 736f 7572 6365 7320   self.resources 
+0000e4a0: 3d20 7265 736f 7572 6365 730a 2020 2020  = resources.    
+0000e4b0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
+0000e4c0: 6564 203d 2073 6574 2829 0a20 2020 2020  ed = set().     
+0000e4d0: 2020 2073 656c 662e 7461 736b 7320 3d20     self.tasks = 
+0000e4e0: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
+0000e4f0: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0000e500: 736b 7320 3d20 7b0a 2020 2020 2020 2020  sks = {.        
+0000e510: 2020 2020 7473 2066 6f72 2074 7320 696e      ts for ts in
+0000e520: 2073 656c 662e 7461 736b 732e 7661 6c75   self.tasks.valu
+0000e530: 6573 2829 2069 6620 6c65 6e28 7473 2e77  es() if len(ts.w
+0000e540: 686f 5f68 6173 2920 3e20 310a 2020 2020  ho_has) > 1.    
+0000e550: 2020 2020 7d0a 2020 2020 2020 2020 7365      }.        se
+0000e560: 6c66 2e63 6f6d 7075 7461 7469 6f6e 7320  lf.computations 
+0000e570: 3d20 6465 7175 6528 0a20 2020 2020 2020  = deque(.       
+0000e580: 2020 2020 206d 6178 6c65 6e3d 6461 736b       maxlen=dask
+0000e590: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0000e5a0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
+0000e5b0: 7469 6373 2e63 6f6d 7075 7461 7469 6f6e  tics.computation
+0000e5c0: 732e 6d61 782d 6869 7374 6f72 7922 290a  s.max-history").
+0000e5d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000e5e0: 2020 7365 6c66 2e65 7272 6564 5f74 6173    self.erred_tas
+0000e5f0: 6b73 203d 2064 6571 7565 280a 2020 2020  ks = deque(.    
+0000e600: 2020 2020 2020 2020 6d61 786c 656e 3d64          maxlen=d
+0000e610: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0000e620: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
+0000e630: 6e6f 7374 6963 732e 6572 7265 642d 7461  nostics.erred-ta
+0000e640: 736b 732e 6d61 782d 6869 7374 6f72 7922  sks.max-history"
+0000e650: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000e660: 2020 2020 7365 6c66 2e74 6173 6b5f 6772      self.task_gr
+0000e670: 6f75 7073 203d 207b 7d0a 2020 2020 2020  oups = {}.      
+0000e680: 2020 7365 6c66 2e74 6173 6b5f 7072 6566    self.task_pref
+0000e690: 6978 6573 203d 207b 7d0a 2020 2020 2020  ixes = {}.      
+0000e6a0: 2020 7365 6c66 2e74 6173 6b5f 6d65 7461    self.task_meta
+0000e6b0: 6461 7461 203d 207b 7d0a 2020 2020 2020  data = {}.      
+0000e6c0: 2020 7365 6c66 2e74 6f74 616c 5f6e 7468    self.total_nth
+0000e6d0: 7265 6164 7320 3d20 300a 2020 2020 2020  reads = 0.      
+0000e6e0: 2020 7365 6c66 2e75 6e6b 6e6f 776e 5f64    self.unknown_d
+0000e6f0: 7572 6174 696f 6e73 203d 207b 7d0a 2020  urations = {}.  
+0000e700: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
+0000e710: 6420 3d20 7175 6575 6564 0a20 2020 2020  d = queued.     
+0000e720: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
+0000e730: 6c65 203d 2075 6e72 756e 6e61 626c 650a  le = unrunnable.
+0000e740: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
+0000e750: 6964 6174 6520 3d20 7661 6c69 6461 7465  idate = validate
+0000e760: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+0000e770: 726b 6572 7320 3d20 776f 726b 6572 730a  rkers = workers.
+0000e780: 2020 2020 2020 2020 7365 6c66 2e5f 7461          self._ta
+0000e790: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
+0000e7a0: 676c 6f62 616c 203d 2064 6566 6175 6c74  global = default
+0000e7b0: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
+0000e7c0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
+0000e7d0: 6f63 635f 676c 6f62 616c 203d 2030 2e30  occ_global = 0.0
+0000e7e0: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+0000e7f0: 6e6e 696e 6720 3d20 7b0a 2020 2020 2020  nning = {.      
+0000e800: 2020 2020 2020 7773 2066 6f72 2077 7320        ws for ws 
+0000e810: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0000e820: 7661 6c75 6573 2829 2069 6620 7773 2e73  values() if ws.s
+0000e830: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+0000e840: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+0000e850: 7d0a 2020 2020 2020 2020 7365 6c66 2e70  }.        self.p
+0000e860: 6c75 6769 6e73 203d 207b 7d20 6966 206e  lugins = {} if n
+0000e870: 6f74 2070 6c75 6769 6e73 2065 6c73 6520  ot plugins else 
+0000e880: 7b5f 6765 745f 706c 7567 696e 5f6e 616d  {_get_plugin_nam
+0000e890: 6528 7029 3a20 7020 666f 7220 7020 696e  e(p): p for p in
+0000e8a0: 2070 6c75 6769 6e73 7d0a 0a20 2020 2020   plugins}..     
+0000e8b0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+0000e8c0: 6f6e 5f6c 6f67 203d 2064 6571 7565 280a  on_log = deque(.
+0000e8d0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
+0000e8e0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
+0000e8f0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0000e900: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
+0000e910: 7469 6f6e 2d6c 6f67 2d6c 656e 6774 6822  tion-log-length"
+0000e920: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000e930: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+0000e940: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
+0000e950: 2020 2020 2020 2020 7365 6c66 2e5f 6964          self._id
+0000e960: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
+0000e970: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
+0000e980: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+0000e990: 6e5f 636f 756e 7465 725f 6d61 7820 3d20  n_counter_max = 
+0000e9a0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+0000e9b0: 6572 5f6d 6178 0a0a 2020 2020 2020 2020  er_max..        
+0000e9c0: 2320 5661 7269 6162 6c65 7320 6672 6f6d  # Variables from
+0000e9d0: 2064 6173 6b2e 636f 6e66 6967 2c20 6361   dask.config, ca
+0000e9e0: 6368 6564 2062 7920 5f5f 696e 6974 5f5f  ched by __init__
+0000e9f0: 2066 6f72 2070 6572 666f 726d 616e 6365   for performance
+0000ea00: 0a20 2020 2020 2020 2073 656c 662e 554e  .        self.UN
+0000ea10: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+0000ea20: 494f 4e20 3d20 7061 7273 655f 7469 6d65  ION = parse_time
+0000ea30: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
+0000ea40: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
+0000ea50: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0000ea60: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
+0000ea70: 6e2d 7461 736b 2d64 7572 6174 696f 6e22  n-task-duration"
+0000ea80: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000ea90: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000eaa0: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
+0000eab0: 4d45 203d 2070 6172 7365 5f74 696d 6564  ME = parse_timed
+0000eac0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
+0000ead0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
+0000eae0: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
+0000eaf0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
+0000eb00: 656e 742d 746f 2d6f 6c64 2d74 696d 6522  ent-to-old-time"
+0000eb10: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0000eb20: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000eb30: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
+0000eb40: 4520 3d20 6461 736b 2e63 6f6e 6669 672e  E = dask.config.
+0000eb50: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0000eb60: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+0000eb70: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000eb80: 6c61 6e63 652e 6d65 6173 7572 6522 0a20  lance.measure". 
+0000eb90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000eba0: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
+0000ebb0: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
+0000ebc0: 4e20 3d20 6461 736b 2e63 6f6e 6669 672e  N = dask.config.
+0000ebd0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0000ebe0: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+0000ebf0: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000ec00: 6c61 6e63 652e 7365 6e64 6572 2d6d 696e  lance.sender-min
+0000ec10: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0000ec20: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
+0000ec30: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
+0000ec40: 454e 545f 4d41 5820 3d20 6461 736b 2e63  ENT_MAX = dask.c
+0000ec50: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0000ec60: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0000ec70: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000ec80: 792e 7265 6261 6c61 6e63 652e 7265 6369  y.rebalance.reci
+0000ec90: 7069 656e 742d 6d61 7822 0a20 2020 2020  pient-max".     
+0000eca0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0000ecb0: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
+0000ecc0: 4345 5f48 414c 465f 4741 5020 3d20 280a  CE_HALF_GAP = (.
+0000ecd0: 2020 2020 2020 2020 2020 2020 6461 736b              dask
+0000ece0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0000ecf0: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000ed00: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000ed10: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
+0000ed20: 742d 6761 7022 290a 2020 2020 2020 2020  t-gap").        
+0000ed30: 2020 2020 2f20 322e 300a 2020 2020 2020      / 2.0.      
+0000ed40: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+0000ed50: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
+0000ed60: 494f 4e20 3d20 6461 736b 2e63 6f6e 6669  ION = dask.confi
+0000ed70: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
+0000ed80: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
+0000ed90: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+0000eda0: 2d73 6174 7572 6174 696f 6e22 0a20 2020  -saturation".   
+0000edb0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+0000edc0: 6620 7365 6c66 2e57 4f52 4b45 525f 5341  f self.WORKER_SA
+0000edd0: 5455 5241 5449 4f4e 203d 3d20 2269 6e66  TURATION == "inf
+0000ede0: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
+0000edf0: 2053 7065 6369 616c 2063 6173 6520 6e65   Special case ne
+0000ee00: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
+0000ee10: 7468 6572 6527 7320 6e6f 2077 6179 2074  there's no way t
+0000ee20: 6f20 7061 7273 6520 6120 666c 6f61 7420  o parse a float 
+0000ee30: 696e 6669 6e69 7479 0a20 2020 2020 2020  infinity.       
+0000ee40: 2020 2020 2023 2066 726f 6d20 6120 4441       # from a DA
+0000ee50: 534b 5f2a 2065 6e76 6972 6f6e 6d65 6e74  SK_* environment
+0000ee60: 2076 6172 6961 626c 650a 2020 2020 2020   variable.      
+0000ee70: 2020 2020 2020 7365 6c66 2e57 4f52 4b45        self.WORKE
+0000ee80: 525f 5341 5455 5241 5449 4f4e 203d 206d  R_SATURATION = m
+0000ee90: 6174 682e 696e 660a 2020 2020 2020 2020  ath.inf.        
+0000eea0: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+0000eeb0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000eec0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+0000eed0: 5241 5449 4f4e 2c20 2869 6e74 2c20 666c  RATION, (int, fl
+0000eee0: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
+0000eef0: 2020 6f72 2073 656c 662e 574f 524b 4552    or self.WORKER
+0000ef00: 5f53 4154 5552 4154 494f 4e20 3c3d 2030  _SATURATION <= 0
+0000ef10: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+0000ef20: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000ef30: 6c75 6545 7272 6f72 2820 2023 2070 7261  lueError(  # pra
+0000ef40: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
+0000ef50: 2020 2020 2020 2020 2020 2020 2022 6064               "`d
+0000ef60: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0000ef70: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
+0000ef80: 7261 7469 6f6e 6020 6d75 7374 2062 6520  ration` must be 
+0000ef90: 6120 666c 6f61 7420 3e20 303b 2067 6f74  a float > 0; got
+0000efa0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000efb0: 2020 202b 2072 6570 7228 7365 6c66 2e57     + repr(self.W
+0000efc0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000efd0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+0000efe0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0000eff0: 2020 2064 6566 206d 656d 6f72 7928 7365     def memory(se
+0000f000: 6c66 2920 2d3e 204d 656d 6f72 7953 7461  lf) -> MemorySta
+0000f010: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
+0000f020: 726e 204d 656d 6f72 7953 7461 7465 2e73  rn MemoryState.s
+0000f030: 756d 282a 2877 2e6d 656d 6f72 7920 666f  um(*(w.memory fo
+0000f040: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
+0000f050: 6572 732e 7661 6c75 6573 2829 2929 0a0a  ers.values()))..
+0000f060: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+0000f070: 2020 6465 6620 5f5f 7064 6963 745f 5f28    def __pdict__(
+0000f080: 7365 6c66 2920 2d3e 2064 6963 745b 7374  self) -> dict[st
+0000f090: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+0000f0a0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+0000f0b0: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
+0000f0c0: 223a 2073 656c 662e 6261 6e64 7769 6474  ": self.bandwidt
+0000f0d0: 682c 0a20 2020 2020 2020 2020 2020 2022  h,.            "
+0000f0e0: 7265 736f 7572 6365 7322 3a20 7365 6c66  resources": self
+0000f0f0: 2e72 6573 6f75 7263 6573 2c0a 2020 2020  .resources,.    
+0000f100: 2020 2020 2020 2020 2273 6174 7572 6174          "saturat
+0000f110: 6564 223a 2073 656c 662e 7361 7475 7261  ed": self.satura
+0000f120: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
+0000f130: 2022 756e 7275 6e6e 6162 6c65 223a 2073   "unrunnable": s
+0000f140: 656c 662e 756e 7275 6e6e 6162 6c65 2c0a  elf.unrunnable,.
+0000f150: 2020 2020 2020 2020 2020 2020 2271 7565              "que
+0000f160: 7565 6422 3a20 7365 6c66 2e71 7565 7565  ued": self.queue
+0000f170: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
+0000f180: 6e5f 7461 736b 7322 3a20 7365 6c66 2e6e  n_tasks": self.n
+0000f190: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
+0000f1a0: 2020 2020 2275 6e6b 6e6f 776e 5f64 7572      "unknown_dur
+0000f1b0: 6174 696f 6e73 223a 2073 656c 662e 756e  ations": self.un
+0000f1c0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732c  known_durations,
+0000f1d0: 0a20 2020 2020 2020 2020 2020 2022 7661  .            "va
+0000f1e0: 6c69 6461 7465 223a 2073 656c 662e 7661  lidate": self.va
+0000f1f0: 6c69 6461 7465 2c0a 2020 2020 2020 2020  lidate,.        
+0000f200: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
+0000f210: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
+0000f220: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
+0000f230: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
+0000f240: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
+0000f250: 2020 2274 6173 6b5f 7072 6566 6978 6573    "task_prefixes
+0000f260: 223a 2073 656c 662e 7461 736b 5f70 7265  ": self.task_pre
+0000f270: 6669 7865 732c 0a20 2020 2020 2020 2020  fixes,.         
+0000f280: 2020 2022 746f 7461 6c5f 6e74 6872 6561     "total_nthrea
+0000f290: 6473 223a 2073 656c 662e 746f 7461 6c5f  ds": self.total_
+0000f2a0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
+0000f2b0: 2020 2020 2020 2274 6f74 616c 5f6f 6363        "total_occ
+0000f2c0: 7570 616e 6379 223a 2073 656c 662e 746f  upancy": self.to
+0000f2d0: 7461 6c5f 6f63 6375 7061 6e63 792c 0a20  tal_occupancy,. 
+0000f2e0: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
+0000f2f0: 645f 7461 736b 7322 3a20 7365 6c66 2e65  d_tasks": self.e
+0000f300: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
+0000f310: 2020 2020 2020 2020 2265 7874 656e 7369          "extensi
+0000f320: 6f6e 7322 3a20 7365 6c66 2e65 7874 656e  ons": self.exten
+0000f330: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
+0000f340: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
+0000f350: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
+0000f360: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
+0000f370: 223a 2073 656c 662e 776f 726b 6572 732c  ": self.workers,
+0000f380: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
+0000f390: 6c65 223a 2073 656c 662e 6964 6c65 2c0a  le": self.idle,.
+0000f3a0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
+0000f3b0: 745f 696e 666f 223a 2073 656c 662e 686f  t_info": self.ho
+0000f3c0: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
+0000f3d0: 207d 0a0a 2020 2020 6465 6620 6e65 775f   }..    def new_
+0000f3e0: 7461 736b 280a 2020 2020 2020 2020 7365  task(.        se
+0000f3f0: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+0000f400: 2073 7472 2c0a 2020 2020 2020 2020 7370   str,.        sp
+0000f410: 6563 3a20 6f62 6a65 6374 2c0a 2020 2020  ec: object,.    
+0000f420: 2020 2020 7374 6174 653a 2054 6173 6b53      state: TaskS
+0000f430: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
+0000f440: 2020 2063 6f6d 7075 7461 7469 6f6e 3a20     computation: 
+0000f450: 436f 6d70 7574 6174 696f 6e20 7c20 4e6f  Computation | No
+0000f460: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+0000f470: 202d 3e20 5461 736b 5374 6174 653a 0a20   -> TaskState:. 
+0000f480: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
+0000f490: 2061 206e 6577 2074 6173 6b2c 2061 6e64   a new task, and
+0000f4a0: 2061 7373 6f63 6961 7465 6420 7374 6174   associated stat
+0000f4b0: 6573 2222 220a 2020 2020 2020 2020 7473  es""".        ts
+0000f4c0: 203d 2054 6173 6b53 7461 7465 286b 6579   = TaskState(key
+0000f4d0: 2c20 7370 6563 2c20 7374 6174 6529 0a0a  , spec, state)..
+0000f4e0: 2020 2020 2020 2020 7072 6566 6978 5f6b          prefix_k
+0000f4f0: 6579 203d 206b 6579 5f73 706c 6974 286b  ey = key_split(k
+0000f500: 6579 290a 2020 2020 2020 2020 7470 203d  ey).        tp =
+0000f510: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000f520: 7865 732e 6765 7428 7072 6566 6978 5f6b  xes.get(prefix_k
+0000f530: 6579 290a 2020 2020 2020 2020 6966 2074  ey).        if t
+0000f540: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+0000f550: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000f560: 5f70 7265 6669 7865 735b 7072 6566 6978  _prefixes[prefix
+0000f570: 5f6b 6579 5d20 3d20 7470 203d 2054 6173  _key] = tp = Tas
+0000f580: 6b50 7265 6669 7828 7072 6566 6978 5f6b  kPrefix(prefix_k
+0000f590: 6579 290a 2020 2020 2020 2020 7473 2e70  ey).        ts.p
+0000f5a0: 7265 6669 7820 3d20 7470 0a0a 2020 2020  refix = tp..    
+0000f5b0: 2020 2020 6772 6f75 705f 6b65 7920 3d20      group_key = 
+0000f5c0: 7473 2e67 726f 7570 5f6b 6579 0a20 2020  ts.group_key.   
+0000f5d0: 2020 2020 2074 6720 3d20 7365 6c66 2e74       tg = self.t
+0000f5e0: 6173 6b5f 6772 6f75 7073 2e67 6574 2867  ask_groups.get(g
+0000f5f0: 726f 7570 5f6b 6579 290a 2020 2020 2020  roup_key).      
+0000f600: 2020 6966 2074 6720 6973 204e 6f6e 653a    if tg is None:
+0000f610: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f620: 662e 7461 736b 5f67 726f 7570 735b 6772  f.task_groups[gr
+0000f630: 6f75 705f 6b65 795d 203d 2074 6720 3d20  oup_key] = tg = 
+0000f640: 5461 736b 4772 6f75 7028 6772 6f75 705f  TaskGroup(group_
+0000f650: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0000f660: 2069 6620 636f 6d70 7574 6174 696f 6e3a   if computation:
+0000f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f680: 2063 6f6d 7075 7461 7469 6f6e 2e67 726f   computation.gro
+0000f690: 7570 732e 6164 6428 7467 290a 2020 2020  ups.add(tg).    
+0000f6a0: 2020 2020 2020 2020 7467 2e70 7265 6669          tg.prefi
+0000f6b0: 7820 3d20 7470 0a20 2020 2020 2020 2020  x = tp.         
+0000f6c0: 2020 2074 702e 6772 6f75 7073 2e61 7070     tp.groups.app
+0000f6d0: 656e 6428 7467 290a 2020 2020 2020 2020  end(tg).        
+0000f6e0: 7467 2e61 6464 2874 7329 0a0a 2020 2020  tg.add(ts)..    
+0000f6f0: 2020 2020 7365 6c66 2e74 6173 6b73 5b6b      self.tasks[k
+0000f700: 6579 5d20 3d20 7473 0a0a 2020 2020 2020  ey] = ts..      
+0000f710: 2020 7265 7475 726e 2074 730a 0a20 2020    return ts..   
+0000f720: 2064 6566 205f 636c 6561 725f 7461 736b   def _clear_task
+0000f730: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
+0000f740: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c6f  None:.        lo
+0000f750: 6767 6572 2e64 6562 7567 2822 436c 6561  gger.debug("Clea
+0000f760: 7220 7461 736b 2073 7461 7465 2229 0a20  r task state"). 
+0000f770: 2020 2020 2020 2066 6f72 2063 6f6c 6c65         for colle
+0000f780: 6374 696f 6e20 696e 2028 0a20 2020 2020  ction in (.     
+0000f790: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
+0000f7a0: 6e6e 6162 6c65 2c0a 2020 2020 2020 2020  nnable,.        
+0000f7b0: 2020 2020 7365 6c66 2e65 7272 6564 5f74      self.erred_t
+0000f7c0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+0000f7d0: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
+0000f7e0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000f7f0: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000f800: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
+0000f810: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
+0000f820: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+0000f830: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
+0000f840: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
+0000f850: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+0000f860: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000f870: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
+0000f880: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
+0000f890: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0000f8a0: 2063 6f6c 6c65 6374 696f 6e2e 636c 6561   collection.clea
+0000f8b0: 7228 2920 2023 2074 7970 653a 2069 676e  r()  # type: ign
+0000f8c0: 6f72 650a 0a20 2020 2040 7072 6f70 6572  ore..    @proper
+0000f8d0: 7479 0a20 2020 2064 6566 2069 735f 6964  ty.    def is_id
+0000f8e0: 6c65 2873 656c 6629 202d 3e20 626f 6f6c  le(self) -> bool
+0000f8f0: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
+0000f900: 7572 6e20 5472 7565 2069 6666 2074 6865  urn True iff the
+0000f910: 7265 2061 7265 206e 6f20 7461 736b 7320  re are no tasks 
+0000f920: 7468 6174 2068 6176 656e 2774 2066 696e  that haven't fin
+0000f930: 6973 6865 6420 636f 6d70 7574 696e 672e  ished computing.
+0000f940: 0a0a 2020 2020 2020 2020 556e 6c69 6b65  ..        Unlike
+0000f950: 2074 6573 7469 6e67 2060 6073 656c 662e   testing ``self.
+0000f960: 746f 7461 6c5f 6f63 6375 7061 6e63 7960  total_occupancy`
+0000f970: 602c 2074 6869 7320 7072 6f70 6572 7479  `, this property
+0000f980: 2072 6574 7572 6e73 2046 616c 7365 2069   returns False i
+0000f990: 6620 7468 6572 650a 2020 2020 2020 2020  f there.        
+0000f9a0: 6172 6520 6c6f 6e67 2d72 756e 6e69 6e67  are long-running
+0000f9b0: 2074 6173 6b73 2c20 6e6f 2d77 6f72 6b65   tasks, no-worke
+0000f9c0: 722c 206f 7220 7175 6575 6564 2074 6173  r, or queued tas
+0000f9d0: 6b73 2028 6475 6520 746f 206e 6f74 2068  ks (due to not h
+0000f9e0: 6176 696e 6720 616e 790a 2020 2020 2020  aving any.      
+0000f9f0: 2020 776f 726b 6572 7329 2e0a 0a20 2020    workers)...   
+0000fa00: 2020 2020 204e 6f74 2074 6f20 6265 2063       Not to be c
+0000fa10: 6f6e 6675 7365 6420 7769 7468 2060 6069  onfused with ``i
+0000fa20: 646c 6560 602e 0a20 2020 2020 2020 2022  dle``..        "
+0000fa30: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+0000fa40: 6e20 616c 6c28 7467 2e64 6f6e 6520 666f  n all(tg.done fo
+0000fa50: 7220 7467 2069 6e20 7365 6c66 2e74 6173  r tg in self.tas
+0000fa60: 6b5f 6772 6f75 7073 2e76 616c 7565 7328  k_groups.values(
+0000fa70: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
+0000fa80: 790a 2020 2020 6465 6620 746f 7461 6c5f  y.    def total_
+0000fa90: 6f63 6375 7061 6e63 7928 7365 6c66 2920  occupancy(self) 
+0000faa0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+0000fab0: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
+0000fac0: 616c 635f 6f63 6375 7061 6e63 7928 0a20  alc_occupancy(. 
+0000fad0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000fae0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+0000faf0: 6e74 5f67 6c6f 6261 6c2c 0a20 2020 2020  nt_global,.     
+0000fb00: 2020 2020 2020 2073 656c 662e 5f6e 6574         self._net
+0000fb10: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c2c  work_occ_global,
+0000fb20: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000fb30: 6465 6620 5f63 616c 635f 6f63 6375 7061  def _calc_occupa
+0000fb40: 6e63 7928 0a20 2020 2020 2020 2073 656c  ncy(.        sel
+0000fb50: 662c 0a20 2020 2020 2020 2074 6173 6b5f  f,.        task_
+0000fb60: 7072 6566 6978 5f63 6f75 6e74 3a20 6469  prefix_count: di
+0000fb70: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
+0000fb80: 2020 2020 2020 6e65 7477 6f72 6b5f 6f63        network_oc
+0000fb90: 633a 2066 6c6f 6174 2c0a 2020 2020 2920  c: float,.    ) 
+0000fba0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+0000fbb0: 2020 7265 7320 3d20 302e 300a 2020 2020    res = 0.0.    
+0000fbc0: 2020 2020 666f 7220 7072 6566 6978 5f6e      for prefix_n
+0000fbd0: 616d 652c 2063 6f75 6e74 2069 6e20 7461  ame, count in ta
+0000fbe0: 736b 5f70 7265 6669 785f 636f 756e 742e  sk_prefix_count.
+0000fbf0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0000fc00: 2020 2020 2023 2054 4f44 4f3a 2044 6561       # TODO: Dea
+0000fc10: 6c20 7769 7468 2075 6e6b 6e6f 776e 2074  l with unknown t
+0000fc20: 6173 6b73 2062 6574 7465 720a 2020 2020  asks better.    
+0000fc30: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
+0000fc40: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000fc50: 7865 735b 7072 6566 6978 5f6e 616d 655d  xes[prefix_name]
+0000fc60: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000fc70: 6572 7420 7072 6566 6978 2069 7320 6e6f  ert prefix is no
+0000fc80: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+0000fc90: 2020 2064 7572 6174 696f 6e20 3d20 7072     duration = pr
+0000fca0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
+0000fcb0: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
+0000fcc0: 2020 6966 2064 7572 6174 696f 6e20 3c20    if duration < 
+0000fcd0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000fce0: 2020 2069 6620 7072 6566 6978 2e6d 6178     if prefix.max
+0000fcf0: 5f65 7865 635f 7469 6d65 203e 2030 3a0a  _exec_time > 0:.
+0000fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd10: 2020 2020 6475 7261 7469 6f6e 203d 2032      duration = 2
+0000fd20: 202a 2070 7265 6669 782e 6d61 785f 6578   * prefix.max_ex
+0000fd30: 6563 5f74 696d 650a 2020 2020 2020 2020  ec_time.        
+0000fd40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd60: 2020 6475 7261 7469 6f6e 203d 2073 656c    duration = sel
+0000fd70: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
+0000fd80: 5552 4154 494f 4e0a 2020 2020 2020 2020  URATION.        
+0000fd90: 2020 2020 7265 7320 2b3d 2064 7572 6174      res += durat
+0000fda0: 696f 6e20 2a20 636f 756e 740a 2020 2020  ion * count.    
+0000fdb0: 2020 2020 6f63 6320 3d20 7265 7320 2b20      occ = res + 
+0000fdc0: 6e65 7477 6f72 6b5f 6f63 6320 2f20 7365  network_occ / se
+0000fdd0: 6c66 2e62 616e 6477 6964 7468 0a20 2020  lf.bandwidth.   
+0000fde0: 2020 2020 2061 7373 6572 7420 6f63 6320       assert occ 
+0000fdf0: 3e3d 2030 2c20 6f63 630a 2020 2020 2020  >= 0, occ.      
+0000fe00: 2020 7265 7475 726e 206f 6363 0a0a 2020    return occ..  
+0000fe10: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0000fe20: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
+0000fe30: 6174 6520 5472 616e 7369 7469 6f6e 7320  ate Transitions 
+0000fe40: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
+0000fe50: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+0000fe60: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
+0000fe70: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0000fe80: 6b65 793a 2073 7472 2c20 6669 6e69 7368  key: str, finish
+0000fe90: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000fea0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0000feb0: 7472 2c20 2a2a 6b77 6172 6773 3a20 416e  tr, **kwargs: An
+0000fec0: 790a 2020 2020 2920 2d3e 2052 6563 734d  y.    ) -> RecsM
+0000fed0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
+0000fee0: 5472 616e 7369 7469 6f6e 2061 206b 6579  Transition a key
+0000fef0: 2066 726f 6d20 6974 7320 6375 7272 656e   from its curren
+0000ff00: 7420 7374 6174 6520 746f 2074 6865 2066  t state to the f
+0000ff10: 696e 6973 6820 7374 6174 650a 0a20 2020  inish state..   
+0000ff20: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
+0000ff30: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+0000ff40: 2020 2020 2020 203e 3e3e 2073 656c 662e         >>> self.
+0000ff50: 5f74 7261 6e73 6974 696f 6e28 2778 272c  _transition('x',
+0000ff60: 2027 7761 6974 696e 6727 290a 2020 2020   'waiting').    
+0000ff70: 2020 2020 7b27 7827 3a20 2770 726f 6365      {'x': 'proce
+0000ff80: 7373 696e 6727 7d2c 207b 7d2c 207b 7d0a  ssing'}, {}, {}.
+0000ff90: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000ffa0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0000ffb0: 0a20 2020 2020 2020 2054 7570 6c65 206f  .        Tuple o
+0000ffc0: 663a 0a0a 2020 2020 2020 2020 2d20 4469  f:..        - Di
+0000ffd0: 6374 696f 6e61 7279 206f 6620 7265 636f  ctionary of reco
+0000ffe0: 6d6d 656e 6461 7469 6f6e 7320 666f 7220  mmendations for 
+0000fff0: 6675 7475 7265 2074 7261 6e73 6974 696f  future transitio
+00010000: 6e73 207b 6b65 793a 206e 6577 2073 7461  ns {key: new sta
+00010010: 7465 7d0a 2020 2020 2020 2020 2d20 4d65  te}.        - Me
+00010020: 7373 6167 6573 2074 6f20 636c 6965 6e74  ssages to client
+00010030: 7320 7b63 6c69 656e 7420 6164 6472 6573  s {client addres
+00010040: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
+00010050: 2e5d 7d0a 2020 2020 2020 2020 2d20 4d65  .]}.        - Me
+00010060: 7373 6167 6573 2074 6f20 776f 726b 6572  ssages to worker
+00010070: 7320 7b77 6f72 6b65 7220 6164 6472 6573  s {worker addres
+00010080: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
+00010090: 2e5d 7d0a 0a20 2020 2020 2020 2053 6565  .]}..        See
+000100a0: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
+000100b0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
+000100c0: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+000100d0: 696f 6e73 203a 2074 7261 6e73 6974 6976  ions : transitiv
+000100e0: 6520 7665 7273 696f 6e20 6f66 2074 6869  e version of thi
+000100f0: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
+00010100: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+00010110: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00010120: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
+00010130: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+00010140: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+00010150: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010160: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
+00010170: 7d2c 207b 7d0a 2020 2020 2020 2020 2020  }, {}.          
+00010180: 2020 7374 6172 7420 3d20 7473 2e5f 7374    start = ts._st
+00010190: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+000101a0: 6966 2073 7461 7274 203d 3d20 6669 6e69  if start == fini
+000101b0: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
+000101c0: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
+000101d0: 7d2c 207b 7d0a 0a20 2020 2020 2020 2020  }, {}..         
+000101e0: 2020 2023 204e 6f74 6573 3a0a 2020 2020     # Notes:.    
+000101f0: 2020 2020 2020 2020 2320 2d20 696e 2063          # - in c
+00010200: 6173 6520 6f66 2074 7261 6e73 6974 696f  ase of transitio
+00010210: 6e20 7468 726f 7567 6820 7265 6c65 6173  n through releas
+00010220: 6564 2c20 7468 6973 2063 6f75 6e74 6572  ed, this counter
+00010230: 2069 7320 696e 6372 656d 656e 7465 6420   is incremented 
+00010240: 6279 2032 0a20 2020 2020 2020 2020 2020  by 2.           
+00010250: 2023 202d 2074 6869 7320 696e 6372 6561   # - this increa
+00010260: 7365 2068 6170 7065 6e73 2062 6566 6f72  se happens befor
+00010270: 6520 7468 6520 6163 7475 616c 2074 7261  e the actual tra
+00010280: 6e73 6974 696f 6e73 2c20 736f 2074 6861  nsitions, so tha
+00010290: 7420 6974 2063 616e 0a20 2020 2020 2020  t it can.       
+000102a0: 2020 2020 2023 2020 2063 6174 6368 2070       #   catch p
+000102b0: 6f74 656e 7469 616c 2069 6e66 696e 6974  otential infinit
+000102c0: 6520 7265 6375 7273 696f 6e73 0a20 2020  e recursions.   
+000102d0: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+000102e0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+000102f0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00010300: 2020 6966 2073 656c 662e 7472 616e 7369    if self.transi
+00010310: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
+00010320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010330: 2020 6173 7365 7274 2073 656c 662e 7472    assert self.tr
+00010340: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00010350: 203c 2073 656c 662e 7472 616e 7369 7469   < self.transiti
+00010360: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 0a0a  on_counter_max..
+00010370: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00010380: 6d6d 656e 6461 7469 6f6e 733a 2064 6963  mmendations: dic
+00010390: 7420 3d20 7b7d 0a20 2020 2020 2020 2020  t = {}.         
+000103a0: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
+000103b0: 6469 6374 203d 207b 7d0a 2020 2020 2020  dict = {}.      
+000103c0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+000103d0: 733a 2064 6963 7420 3d20 7b7d 0a0a 2020  s: dict = {}..  
+000103e0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000103f0: 662e 706c 7567 696e 733a 0a20 2020 2020  f.plugins:.     
+00010400: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00010410: 6465 6e74 7320 3d20 7365 7428 7473 2e64  dents = set(ts.d
+00010420: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
+00010430: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00010440: 6465 6e63 6965 7320 3d20 7365 7428 7473  dencies = set(ts
+00010450: 2e64 6570 656e 6465 6e63 6965 7329 0a0a  .dependencies)..
+00010460: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+00010470: 203d 2073 656c 662e 5f54 5241 4e53 4954   = self._TRANSIT
+00010480: 494f 4e53 5f54 4142 4c45 2e67 6574 2828  IONS_TABLE.get((
+00010490: 7374 6172 742c 2066 696e 6973 6829 290a  start, finish)).
+000104a0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000104b0: 756e 6320 6973 206e 6f74 204e 6f6e 653a  unc is not None:
+000104c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000104d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000104e0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+000104f0: 6f72 6b65 725f 6d73 6773 203d 2066 756e  orker_msgs = fun
+00010500: 6328 0a20 2020 2020 2020 2020 2020 2020  c(.             
+00010510: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
+00010520: 2c20 7374 696d 756c 7573 5f69 642c 202a  , stimulus_id, *
+00010530: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
+00010540: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00010550: 2020 2020 2020 2065 6c69 6620 2272 656c         elif "rel
+00010560: 6561 7365 6422 206e 6f74 2069 6e20 2873  eased" not in (s
+00010570: 7461 7274 2c20 6669 6e69 7368 293a 0a20  tart, finish):. 
+00010580: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00010590: 7373 6572 7420 6e6f 7420 6b77 6172 6773  ssert not kwargs
+000105a0: 2c20 286b 7761 7267 732c 2073 7461 7274  , (kwargs, start
+000105b0: 2c20 6669 6e69 7368 290a 2020 2020 2020  , finish).      
+000105c0: 2020 2020 2020 2020 2020 615f 7265 6373            a_recs
+000105d0: 2c20 615f 636d 7367 732c 2061 5f77 6d73  , a_cmsgs, a_wms
+000105e0: 6773 203d 2073 656c 662e 5f74 7261 6e73  gs = self._trans
+000105f0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+00010600: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
+00010610: 2272 656c 6561 7365 6422 2c20 7374 696d  "released", stim
+00010620: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
+00010630: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00010640: 2020 2020 2020 2020 2020 2076 203d 2061             v = a
+00010650: 5f72 6563 732e 6765 7428 6b65 792c 2066  _recs.get(key, f
+00010660: 696e 6973 6829 0a20 2020 2020 2020 2020  inish).         
+00010670: 2020 2020 2020 2066 756e 6320 3d20 7365         func = se
+00010680: 6c66 2e5f 5452 414e 5349 5449 4f4e 535f  lf._TRANSITIONS_
+00010690: 5441 424c 455b 2272 656c 6561 7365 6422  TABLE["released"
+000106a0: 2c20 765d 0a20 2020 2020 2020 2020 2020  , v].           
+000106b0: 2020 2020 2062 5f72 6563 732c 2062 5f63       b_recs, b_c
+000106c0: 6d73 6773 2c20 625f 776d 7367 7320 3d20  msgs, b_wmsgs = 
+000106d0: 6675 6e63 2873 656c 662c 206b 6579 2c20  func(self, key, 
+000106e0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+000106f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00010700: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
+00010710: 6461 7465 2861 5f72 6563 7329 0a20 2020  date(a_recs).   
+00010720: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010730: 2063 2c20 6e65 775f 6d73 6773 2069 6e20   c, new_msgs in 
+00010740: 615f 636d 7367 732e 6974 656d 7328 293a  a_cmsgs.items():
+00010750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010760: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+00010770: 2e73 6574 6465 6661 756c 7428 632c 205b  .setdefault(c, [
+00010780: 5d29 2e65 7874 656e 6428 6e65 775f 6d73  ]).extend(new_ms
+00010790: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+000107a0: 2020 2020 666f 7220 772c 206e 6577 5f6d      for w, new_m
+000107b0: 7367 7320 696e 2061 5f77 6d73 6773 2e69  sgs in a_wmsgs.i
+000107c0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+000107d0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+000107e0: 6572 5f6d 7367 732e 7365 7464 6566 6175  er_msgs.setdefau
+000107f0: 6c74 2877 2c20 5b5d 292e 6578 7465 6e64  lt(w, []).extend
+00010800: 286e 6577 5f6d 7367 7329 0a0a 2020 2020  (new_msgs)..    
+00010810: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00010820: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
+00010830: 7465 2862 5f72 6563 7329 0a20 2020 2020  te(b_recs).     
+00010840: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00010850: 2c20 6e65 775f 6d73 6773 2069 6e20 625f  , new_msgs in b_
+00010860: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
 00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010880: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
-00010890: 3d20 6465 7065 6e64 656e 6369 6573 0a20  = dependencies. 
-000108a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108b0: 2020 2073 656c 662e 7461 736b 735b 7473     self.tasks[ts
-000108c0: 2e6b 6579 5d20 3d20 7473 0a20 2020 2020  .key] = ts.     
-000108d0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-000108e0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-000108f0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-00010900: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00010910: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00010920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010930: 2020 2020 2020 2070 6c75 6769 6e2e 7472         plugin.tr
-00010940: 616e 7369 7469 6f6e 286b 6579 2c20 7374  ansition(key, st
-00010950: 6172 742c 2061 6374 7561 6c5f 6669 6e69  art, actual_fini
-00010960: 7368 2c20 2a2a 6b77 6172 6773 290a 2020  sh, **kwargs).  
-00010970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010980: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00010990: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000109a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-000109b0: 6572 2e69 6e66 6f28 2250 6c75 6769 6e20  er.info("Plugin 
-000109c0: 6661 696c 6564 2077 6974 6820 6578 6365  failed with exce
-000109d0: 7074 696f 6e22 2c20 6578 635f 696e 666f  ption", exc_info
-000109e0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-000109f0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-00010a00: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
-00010a10: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00010a20: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00010a30: 7461 736b 735b 7473 2e6b 6579 5d0a 0a20  tasks[ts.key].. 
-00010a40: 2020 2020 2020 2020 2020 2074 6720 3d20             tg = 
-00010a50: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
-00010a60: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-00010a70: 203d 3d20 2266 6f72 676f 7474 656e 2220   == "forgotten" 
-00010a80: 616e 6420 7467 2e6e 616d 6520 696e 2073  and tg.name in s
-00010a90: 656c 662e 7461 736b 5f67 726f 7570 733a  elf.task_groups:
-00010aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ab0: 2023 2052 656d 6f76 6520 5461 736b 4772   # Remove TaskGr
-00010ac0: 6f75 7020 6966 2061 6c6c 2074 6173 6b73  oup if all tasks
-00010ad0: 2061 7265 2069 6e20 7468 6520 666f 7267   are in the forg
-00010ae0: 6f74 7465 6e20 7374 6174 650a 2020 2020  otten state.    
-00010af0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00010b00: 6c6c 2876 203d 3d20 3020 6f72 206b 203d  ll(v == 0 or k =
-00010b10: 3d20 2266 6f72 676f 7474 656e 2220 666f  = "forgotten" fo
-00010b20: 7220 6b2c 2076 2069 6e20 7467 2e73 7461  r k, v in tg.sta
-00010b30: 7465 732e 6974 656d 7328 2929 3a0a 2020  tes.items()):.  
-00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b50: 2020 7473 2e70 7265 6669 782e 6772 6f75    ts.prefix.grou
-00010b60: 7073 2e72 656d 6f76 6528 7467 290a 2020  ps.remove(tg).  
-00010b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b80: 2020 6465 6c20 7365 6c66 2e74 6173 6b5f    del self.task_
-00010b90: 6772 6f75 7073 5b74 672e 6e61 6d65 5d0a  groups[tg.name].
-00010ba0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010bb0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00010bc0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-00010bd0: 2c20 776f 726b 6572 5f6d 7367 730a 2020  , worker_msgs.  
-00010be0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00010bf0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00010c00: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-00010c10: 7469 6f6e 2822 4572 726f 7220 7472 616e  tion("Error tran
-00010c20: 7369 7469 6f6e 696e 6720 2572 2066 726f  sitioning %r fro
-00010c30: 6d20 2572 2074 6f20 2572 222c 206b 6579  m %r to %r", key
-00010c40: 2c20 7374 6172 742c 2066 696e 6973 6829  , start, finish)
-00010c50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00010c60: 4c4f 475f 5044 423a 0a20 2020 2020 2020  LOG_PDB:.       
-00010c70: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
-00010c80: 7064 620a 0a20 2020 2020 2020 2020 2020  pdb..           
-00010c90: 2020 2020 2070 6462 2e73 6574 5f74 7261       pdb.set_tra
-00010ca0: 6365 2829 0a20 2020 2020 2020 2020 2020  ce().           
-00010cb0: 2072 6169 7365 0a0a 2020 2020 6465 6620   raise..    def 
-00010cc0: 5f74 7261 6e73 6974 696f 6e73 280a 2020  _transitions(.  
-00010cd0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00010ce0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00010cf0: 6f6e 733a 2052 6563 732c 0a20 2020 2020  ons: Recs,.     
-00010d00: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
-00010d10: 4d73 6773 2c0a 2020 2020 2020 2020 776f  Msgs,.        wo
-00010d20: 726b 6572 5f6d 7367 733a 204d 7367 732c  rker_msgs: Msgs,
-00010d30: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00010d40: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
-00010d50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00010d60: 2020 2222 2250 726f 6365 7373 2074 7261    """Process tra
-00010d70: 6e73 6974 696f 6e73 2075 6e74 696c 206e  nsitions until n
-00010d80: 6f6e 6520 6172 6520 6c65 6674 0a0a 2020  one are left..  
-00010d90: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
-00010da0: 6465 7320 6665 6564 6261 636b 2066 726f  des feedback fro
-00010db0: 6d20 7072 6576 696f 7573 2074 7261 6e73  m previous trans
-00010dc0: 6974 696f 6e73 2061 6e64 2063 6f6e 7469  itions and conti
-00010dd0: 6e75 6573 2075 6e74 696c 2077 650a 2020  nues until we.  
-00010de0: 2020 2020 2020 7265 6163 6820 6120 7374        reach a st
-00010df0: 6561 6479 2073 7461 7465 0a20 2020 2020  eady state.     
-00010e00: 2020 2022 2222 0a20 2020 2020 2020 206b     """.        k
-00010e10: 6579 733a 2073 6574 5b73 7472 5d20 3d20  eys: set[str] = 
-00010e20: 7365 7428 290a 2020 2020 2020 2020 7265  set().        re
-00010e30: 636f 6d6d 656e 6461 7469 6f6e 7320 3d20  commendations = 
-00010e40: 7265 636f 6d6d 656e 6461 7469 6f6e 732e  recommendations.
-00010e50: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
-00010e60: 7768 696c 6520 7265 636f 6d6d 656e 6461  while recommenda
-00010e70: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-00010e80: 2020 206b 6579 2c20 6669 6e69 7368 203d     key, finish =
-00010e90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00010ea0: 2e70 6f70 6974 656d 2829 0a20 2020 2020  .popitem().     
-00010eb0: 2020 2020 2020 206b 6579 732e 6164 6428         keys.add(
-00010ec0: 6b65 7929 0a0a 2020 2020 2020 2020 2020  key)..          
-00010ed0: 2020 6e65 775f 7265 6373 2c20 6e65 775f    new_recs, new_
-00010ee0: 636d 7367 732c 206e 6577 5f77 6d73 6773  cmsgs, new_wmsgs
-00010ef0: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
-00010f00: 696f 6e28 6b65 792c 2066 696e 6973 682c  ion(key, finish,
-00010f10: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
-00010f20: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00010f30: 6d65 6e64 6174 696f 6e73 2e75 7064 6174  mendations.updat
-00010f40: 6528 6e65 775f 7265 6373 290a 2020 2020  e(new_recs).    
-00010f50: 2020 2020 2020 2020 666f 7220 632c 206e          for c, n
-00010f60: 6577 5f6d 7367 7320 696e 206e 6577 5f63  ew_msgs in new_c
-00010f70: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-00010f80: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00010f90: 6965 6e74 5f6d 7367 732e 7365 7464 6566  ient_msgs.setdef
-00010fa0: 6175 6c74 2863 2c20 5b5d 292e 6578 7465  ault(c, []).exte
-00010fb0: 6e64 286e 6577 5f6d 7367 7329 0a20 2020  nd(new_msgs).   
-00010fc0: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
-00010fd0: 6e65 775f 6d73 6773 2069 6e20 6e65 775f  new_msgs in new_
-00010fe0: 776d 7367 732e 6974 656d 7328 293a 0a20  wmsgs.items():. 
-00010ff0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00011000: 6f72 6b65 725f 6d73 6773 2e73 6574 6465  orker_msgs.setde
-00011010: 6661 756c 7428 772c 205b 5d29 2e65 7874  fault(w, []).ext
-00011020: 656e 6428 6e65 775f 6d73 6773 290a 0a20  end(new_msgs).. 
-00011030: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00011040: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00011050: 2020 2020 2023 2046 4958 4d45 2064 6f77       # FIXME dow
-00011060: 6e63 6173 7420 616e 7469 7061 7474 6572  ncast antipatter
-00011070: 6e0a 2020 2020 2020 2020 2020 2020 7363  n.            sc
-00011080: 6865 6475 6c65 7220 3d20 6361 7374 2853  heduler = cast(S
-00011090: 6368 6564 756c 6572 2c20 7365 6c66 290a  cheduler, self).
-000110a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000110b0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
-000110c0: 2020 2020 2020 2020 2020 2020 2073 6368               sch
-000110d0: 6564 756c 6572 2e76 616c 6964 6174 655f  eduler.validate_
-000110e0: 6b65 7928 6b65 7929 0a0a 2020 2020 6465  key(key)..    de
-000110f0: 6620 7472 616e 7369 7469 6f6e 5f72 656c  f transition_rel
-00011100: 6561 7365 645f 7761 6974 696e 6728 7365  eased_waiting(se
-00011110: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
-00011120: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
-00011130: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00011140: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00011150: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
-00011160: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00011170: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00011180: 2061 7373 6572 7420 7473 2e72 756e 5f73   assert ts.run_s
-00011190: 7065 630a 2020 2020 2020 2020 2020 2020  pec.            
-000111a0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-000111b0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-000111c0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-000111d0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-000111e0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-000111f0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00011200: 6f6e 0a20 2020 2020 2020 2020 2020 2066  on.            f
-00011210: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00011220: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00011230: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00011240: 7420 6474 732e 7374 6174 6520 6e6f 7420  t dts.state not 
-00011250: 696e 207b 2266 6f72 676f 7474 656e 222c  in {"forgotten",
-00011260: 2022 6572 7265 6422 7d0a 0a20 2020 2020   "erred"}..     
-00011270: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
-00011280: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
-00011290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000112a0: 726e 207b 6b65 793a 2022 666f 7267 6f74  rn {key: "forgot
-000112b0: 7465 6e22 7d2c 207b 7d2c 207b 7d0a 0a20  ten"}, {}, {}.. 
-000112c0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-000112d0: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
-000112e0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-000112f0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00011300: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
-00011310: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-00011320: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00011330: 2069 6620 6e6f 7420 6474 732e 7768 6f5f   if not dts.who_
-00011340: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-00011350: 2020 2020 2074 732e 7761 6974 696e 675f       ts.waiting_
-00011360: 6f6e 2e61 6464 2864 7473 290a 2020 2020  on.add(dts).    
-00011370: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
-00011380: 7461 7465 203d 3d20 2272 656c 6561 7365  tate == "release
-00011390: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-000113a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000113b0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
-000113c0: 7761 6974 696e 6722 0a20 2020 2020 2020  waiting".       
-000113d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000113e0: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
-000113f0: 6169 7465 7273 2e61 6464 2874 7329 0a0a  aiters.add(ts)..
-00011400: 2020 2020 2020 2020 7473 2e77 6169 7465          ts.waite
-00011410: 7273 203d 207b 6474 7320 666f 7220 6474  rs = {dts for dt
-00011420: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00011430: 7473 2069 6620 6474 732e 7374 6174 6520  ts if dts.state 
-00011440: 3d3d 2022 7761 6974 696e 6722 7d0a 0a20  == "waiting"}.. 
-00011450: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-00011460: 2e77 6169 7469 6e67 5f6f 6e3a 0a20 2020  .waiting_on:.   
-00011470: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
-00011480: 2077 6169 7469 6e67 2d3e 7072 6f63 6573   waiting->proces
-00011490: 7369 6e67 2077 696c 6c20 7365 6e64 2074  sing will send t
-000114a0: 6173 6b73 2074 6f20 7175 6575 6564 206f  asks to queued o
-000114b0: 7220 6e6f 2d77 6f72 6b65 7220 6173 0a20  r no-worker as. 
-000114c0: 2020 2020 2020 2020 2020 2023 206e 6563             # nec
-000114d0: 6573 7361 7279 0a20 2020 2020 2020 2020  essary.         
-000114e0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-000114f0: 6e73 5b6b 6579 5d20 3d20 2270 726f 6365  ns[key] = "proce
-00011500: 7373 696e 6722 0a0a 2020 2020 2020 2020  ssing"..        
-00011510: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
-00011520: 6174 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a  ations, {}, {}..
-00011530: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-00011540: 6f6e 5f6e 6f5f 776f 726b 6572 5f70 726f  on_no_worker_pro
-00011550: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
-00011560: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
-00011570: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
-00011580: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00011590: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-000115a0: 6579 5d0a 2020 2020 2020 2020 776f 726b  ey].        work
-000115b0: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
-000115c0: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
-000115d0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-000115e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000115f0: 206e 6f74 2074 732e 6163 746f 722c 2066   not ts.actor, f
-00011600: 2241 6374 6f72 7320 6361 6e27 7420 6265  "Actors can't be
-00011610: 2069 6e20 606e 6f2d 776f 726b 6572 603a   in `no-worker`:
-00011620: 207b 7473 7d22 0a20 2020 2020 2020 2020   {ts}".         
-00011630: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00011640: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-00011650: 0a20 2020 2020 2020 2069 6620 7773 203a  .        if ws :
-00011660: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
-00011670: 726b 6572 5f6e 6f6e 5f72 6f6f 7469 7368  rker_non_rootish
-00011680: 2874 7329 3a0a 2020 2020 2020 2020 2020  (ts):.          
-00011690: 2020 7365 6c66 2e75 6e72 756e 6e61 626c    self.unrunnabl
-000116a0: 652e 6469 7363 6172 6428 7473 290a 2020  e.discard(ts).  
-000116b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-000116c0: 5f6d 7367 7320 3d20 7365 6c66 2e5f 6164  _msgs = self._ad
-000116d0: 645f 746f 5f70 726f 6365 7373 696e 6728  d_to_processing(
-000116e0: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
-000116f0: 2320 4966 206e 6f20 776f 726b 6572 2c20  # If no worker, 
-00011700: 7461 736b 206a 7573 7420 7374 6179 7320  task just stays 
-00011710: 696e 2060 6e6f 2d77 6f72 6b65 7260 0a0a  in `no-worker`..
-00011720: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00011730: 7d2c 207b 7d2c 2077 6f72 6b65 725f 6d73  }, {}, worker_ms
-00011740: 6773 0a0a 2020 2020 6465 6620 6465 6369  gs..    def deci
-00011750: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
-00011760: 685f 7175 6575 696e 675f 6469 7361 626c  h_queuing_disabl
-00011770: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
-00011780: 2c20 7473 3a20 5461 736b 5374 6174 650a  , ts: TaskState.
-00011790: 2020 2020 2920 2d3e 2057 6f72 6b65 7253      ) -> WorkerS
-000117a0: 7461 7465 207c 204e 6f6e 653a 0a20 2020  tate | None:.   
-000117b0: 2020 2020 2022 2222 5069 636b 2061 2077       """Pick a w
-000117c0: 6f72 6b65 7220 666f 7220 6120 7275 6e6e  orker for a runn
-000117d0: 6162 6c65 2072 6f6f 742d 6973 6820 7461  able root-ish ta
-000117e0: 736b 2c20 7769 7468 6f75 7420 7175 6575  sk, without queu
-000117f0: 696e 672e 0a0a 2020 2020 2020 2020 5468  ing...        Th
-00011800: 6973 2061 7474 656d 7074 7320 746f 2073  is attempts to s
-00011810: 6368 6564 756c 6520 7369 626c 696e 6720  chedule sibling 
-00011820: 7461 736b 7320 6f6e 2074 6865 2073 616d  tasks on the sam
-00011830: 6520 776f 726b 6572 2c20 7265 6475 6369  e worker, reduci
-00011840: 6e67 2066 7574 7572 6520 6461 7461 0a20  ng future data. 
-00011850: 2020 2020 2020 2074 7261 6e73 6665 722e         transfer.
-00011860: 2049 7420 646f 6573 206e 6f74 2063 6f6e   It does not con
-00011870: 7369 6465 7220 7468 6520 6c6f 6361 7469  sider the locati
-00011880: 6f6e 206f 6620 6465 7065 6e64 656e 6369  on of dependenci
-00011890: 6573 2c20 7369 6e63 6520 7468 6579 276c  es, since they'l
-000118a0: 6c20 656e 640a 2020 2020 2020 2020 7570  l end.        up
-000118b0: 206f 6e20 6576 6572 7920 776f 726b 6572   on every worker
-000118c0: 2061 6e79 7761 792e 0a0a 2020 2020 2020   anyway...      
-000118d0: 2020 4974 2061 7373 756d 6573 2069 7427    It assumes it'
-000118e0: 7320 6265 696e 6720 6361 6c6c 6564 206f  s being called o
-000118f0: 6e20 6120 6261 7463 6820 6f66 2074 6173  n a batch of tas
-00011900: 6b73 2069 6e20 7072 696f 7269 7479 206f  ks in priority o
-00011910: 7264 6572 2c20 616e 640a 2020 2020 2020  rder, and.      
-00011920: 2020 6d61 696e 7461 696e 7320 7374 6174    maintains stat
-00011930: 6520 696e 2060 5363 6865 6475 6c65 7253  e in `SchedulerS
-00011940: 7461 7465 2e6c 6173 745f 726f 6f74 5f77  tate.last_root_w
-00011950: 6f72 6b65 7260 2061 6e64 0a20 2020 2020  orker` and.     
-00011960: 2020 2060 5363 6865 6475 6c65 7253 7461     `SchedulerSta
-00011970: 7465 2e6c 6173 745f 726f 6f74 5f77 6f72  te.last_root_wor
-00011980: 6b65 725f 7461 736b 735f 6c65 6674 6020  ker_tasks_left` 
-00011990: 746f 2061 6368 6965 7665 2074 6869 732e  to achieve this.
-000119a0: 0a0a 2020 2020 2020 2020 5468 6973 2077  ..        This w
-000119b0: 696c 6c20 7365 6e64 2065 7665 7279 2072  ill send every r
-000119c0: 756e 6e61 626c 6520 7461 736b 2074 6f20  unnable task to 
-000119d0: 6120 776f 726b 6572 2c20 6f66 7465 6e20  a worker, often 
-000119e0: 6361 7573 696e 6720 726f 6f74 2074 6173  causing root tas
-000119f0: 6b0a 2020 2020 2020 2020 6f76 6572 7072  k.        overpr
-00011a00: 6f64 7563 7469 6f6e 2e0a 0a20 2020 2020  oduction...     
-00011a10: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00011a20: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00011a30: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
-00011a40: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
-00011a50: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
-00011a60: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
-00011a70: 6173 6b20 746f 2e20 4966 2074 6865 7265  ask to. If there
-00011a80: 2061 7265 206e 6f20 776f 726b 6572 7320   are no workers 
-00011a90: 696e 2074 6865 2063 6c75 7374 6572 2c0a  in the cluster,.
-00011aa0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00011ab0: 726e 7320 4e6f 6e65 2c20 696e 2077 6869  rns None, in whi
-00011ac0: 6368 2063 6173 6520 7468 6520 7461 736b  ch case the task
-00011ad0: 2073 686f 756c 6420 6265 2074 7261 6e73   should be trans
-00011ae0: 6974 696f 6e65 6420 746f 0a20 2020 2020  itioned to.     
-00011af0: 2020 2020 2020 2060 606e 6f2d 776f 726b         ``no-work
-00011b00: 6572 6060 2e0a 2020 2020 2020 2020 2222  er``..        ""
-00011b10: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00011b20: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-00011b30: 2020 2020 2020 2020 2320 5365 6520 726f          # See ro
-00011b40: 6f74 2d69 7368 2d6e 6573 7320 6e6f 7465  ot-ish-ness note
-00011b50: 2062 656c 6f77 2069 6e20 6064 6563 6964   below in `decid
-00011b60: 655f 776f 726b 6572 5f72 6f6f 7469 7368  e_worker_rootish
-00011b70: 5f71 7565 7569 6e67 5f65 6e61 626c 6564  _queuing_enabled
-00011b80: 600a 2020 2020 2020 2020 2020 2020 6173  `.            as
-00011b90: 7365 7274 206d 6174 682e 6973 696e 6628  sert math.isinf(
-00011ba0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-00011bb0: 5241 5449 4f4e 290a 0a20 2020 2020 2020  RATION)..       
-00011bc0: 2070 6f6f 6c20 3d20 7365 6c66 2e69 646c   pool = self.idl
-00011bd0: 652e 7661 6c75 6573 2829 2069 6620 7365  e.values() if se
-00011be0: 6c66 2e69 646c 6520 656c 7365 2073 656c  lf.idle else sel
-00011bf0: 662e 7275 6e6e 696e 670a 2020 2020 2020  f.running.      
-00011c00: 2020 6966 206e 6f74 2070 6f6f 6c3a 0a20    if not pool:. 
-00011c10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00011c20: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
-00011c30: 7467 203d 2074 732e 6772 6f75 700a 2020  tg = ts.group.  
-00011c40: 2020 2020 2020 6c77 7320 3d20 7467 2e6c        lws = tg.l
-00011c50: 6173 745f 776f 726b 6572 0a20 2020 2020  ast_worker.     
-00011c60: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-00011c70: 2020 2020 6c77 730a 2020 2020 2020 2020      lws.        
-00011c80: 2020 2020 616e 6420 7467 2e6c 6173 745f      and tg.last_
-00011c90: 776f 726b 6572 5f74 6173 6b73 5f6c 6566  worker_tasks_lef
-00011ca0: 740a 2020 2020 2020 2020 2020 2020 616e  t.            an
-00011cb0: 6420 6c77 732e 7374 6174 7573 203d 3d20  d lws.status == 
-00011cc0: 5374 6174 7573 2e72 756e 6e69 6e67 0a20  Status.running. 
-00011cd0: 2020 2020 2020 2020 2020 2061 6e64 2073             and s
-00011ce0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
-00011cf0: 6c77 732e 6164 6472 6573 7329 2069 7320  lws.address) is 
-00011d00: 6c77 730a 2020 2020 2020 2020 293a 0a20  lws.        ):. 
-00011d10: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
-00011d20: 6c77 730a 2020 2020 2020 2020 656c 7365  lws.        else
-00011d30: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00011d40: 4c61 7374 2d75 7365 6420 776f 726b 6572  Last-used worker
-00011d50: 2069 7320 6675 6c6c 2c20 756e 6b6e 6f77   is full, unknow
-00011d60: 6e2c 2072 6574 6972 696e 672c 206f 7220  n, retiring, or 
-00011d70: 7061 7573 6564 3b0a 2020 2020 2020 2020  paused;.        
-00011d80: 2020 2020 2320 7069 636b 2061 206e 6577      # pick a new
-00011d90: 2077 6f72 6b65 7220 666f 7220 7468 6520   worker for the 
-00011da0: 6e65 7874 2066 6577 2074 6173 6b73 0a20  next few tasks. 
-00011db0: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
-00011dc0: 6d69 6e28 706f 6f6c 2c20 6b65 793d 7061  min(pool, key=pa
-00011dd0: 7274 6961 6c28 7365 6c66 2e77 6f72 6b65  rtial(self.worke
-00011de0: 725f 6f62 6a65 6374 6976 652c 2074 7329  r_objective, ts)
-00011df0: 290a 2020 2020 2020 2020 2020 2020 7467  ).            tg
-00011e00: 2e6c 6173 745f 776f 726b 6572 5f74 6173  .last_worker_tas
-00011e10: 6b73 5f6c 6566 7420 3d20 6d61 7468 2e66  ks_left = math.f
-00011e20: 6c6f 6f72 280a 2020 2020 2020 2020 2020  loor(.          
-00011e30: 2020 2020 2020 286c 656e 2874 6729 202f        (len(tg) /
-00011e40: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
-00011e50: 6561 6473 2920 2a20 7773 2e6e 7468 7265  eads) * ws.nthre
-00011e60: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
-00011e70: 290a 0a20 2020 2020 2020 2023 2052 6563  )..        # Rec
-00011e80: 6f72 6420 606c 6173 745f 776f 726b 6572  ord `last_worker
-00011e90: 602c 206f 7220 636c 6561 7220 6974 206f  `, or clear it o
-00011ea0: 6e20 7468 6520 6669 6e61 6c20 7461 736b  n the final task
-00011eb0: 0a20 2020 2020 2020 2074 672e 6c61 7374  .        tg.last
-00011ec0: 5f77 6f72 6b65 7220 3d20 280a 2020 2020  _worker = (.    
-00011ed0: 2020 2020 2020 2020 7773 2069 6620 7467          ws if tg
-00011ee0: 2e73 7461 7465 735b 2272 656c 6561 7365  .states["release
-00011ef0: 6422 5d20 2b20 7467 2e73 7461 7465 735b  d"] + tg.states[
-00011f00: 2277 6169 7469 6e67 225d 203e 2031 2065  "waiting"] > 1 e
-00011f10: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00011f20: 2029 0a20 2020 2020 2020 2074 672e 6c61   ).        tg.la
-00011f30: 7374 5f77 6f72 6b65 725f 7461 736b 735f  st_worker_tasks_
-00011f40: 6c65 6674 202d 3d20 310a 0a20 2020 2020  left -= 1..     
-00011f50: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00011f60: 6174 6520 616e 6420 7773 2069 7320 6e6f  ate and ws is no
-00011f70: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00011f80: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-00011f90: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
-00011fa0: 6464 7265 7373 2920 6973 2077 730a 2020  ddress) is ws.  
-00011fb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00011fc0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-00011fd0: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
-00011fe0: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
-00011ff0: 2072 6574 7572 6e20 7773 0a0a 2020 2020   return ws..    
-00012000: 6465 6620 6465 6369 6465 5f77 6f72 6b65  def decide_worke
-00012010: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
-00012020: 675f 656e 6162 6c65 6428 7365 6c66 2920  g_enabled(self) 
-00012030: 2d3e 2057 6f72 6b65 7253 7461 7465 207c  -> WorkerState |
-00012040: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00012050: 2222 5069 636b 2061 2077 6f72 6b65 7220  ""Pick a worker 
-00012060: 666f 7220 6120 7275 6e6e 6162 6c65 2072  for a runnable r
-00012070: 6f6f 742d 6973 6820 7461 736b 2c20 6966  oot-ish task, if
-00012080: 206e 6f74 2061 6c6c 2061 7265 2062 7573   not all are bus
-00012090: 792e 0a0a 2020 2020 2020 2020 5069 636b  y...        Pick
-000120a0: 7320 7468 6520 6c65 6173 742d 6275 7379  s the least-busy
-000120b0: 2077 6f72 6b65 7220 6f75 7420 6f66 2074   worker out of t
-000120c0: 6865 2060 6069 646c 6560 6020 776f 726b  he ``idle`` work
-000120d0: 6572 7320 2869 646c 6520 776f 726b 6572  ers (idle worker
-000120e0: 7320 6861 7665 2066 6577 6572 0a20 2020  s have fewer.   
-000120f0: 2020 2020 2074 6173 6b73 2072 756e 6e69       tasks runni
-00012100: 6e67 2074 6861 6e20 7468 7265 6164 732c  ng than threads,
-00012110: 2061 7320 7365 7420 6279 2060 6064 6973   as set by ``dis
-00012120: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-00012130: 6572 2e77 6f72 6b65 722d 7361 7475 7261  er.worker-satura
-00012140: 7469 6f6e 6060 292e 0a20 2020 2020 2020  tion``)..       
-00012150: 2049 7420 646f 6573 206e 6f74 2063 6f6e   It does not con
-00012160: 7369 6465 7220 7468 6520 6c6f 6361 7469  sider the locati
-00012170: 6f6e 206f 6620 6465 7065 6e64 656e 6369  on of dependenci
-00012180: 6573 2c20 7369 6e63 6520 7468 6579 276c  es, since they'l
-00012190: 6c20 656e 6420 7570 206f 6e20 6576 6572  l end up on ever
-000121a0: 790a 2020 2020 2020 2020 776f 726b 6572  y.        worker
-000121b0: 2061 6e79 7761 792e 0a0a 2020 2020 2020   anyway...      
-000121c0: 2020 4966 2061 6c6c 2077 6f72 6b65 7273    If all workers
-000121d0: 2061 7265 2066 756c 6c2c 2072 6574 7572   are full, retur
-000121e0: 6e73 204e 6f6e 652c 206d 6561 6e69 6e67  ns None, meaning
-000121f0: 2074 6865 2074 6173 6b20 7368 6f75 6c64   the task should
-00012200: 2074 7261 6e73 6974 696f 6e20 746f 0a20   transition to. 
-00012210: 2020 2020 2020 2060 6071 7565 7565 6460         ``queued`
-00012220: 602e 2054 6865 2073 6368 6564 756c 6572  `. The scheduler
-00012230: 2077 696c 6c20 7761 6974 2074 6f20 7365   will wait to se
-00012240: 6e64 2069 7420 746f 2061 2077 6f72 6b65  nd it to a worke
-00012250: 7220 756e 7469 6c20 6120 7468 7265 6164  r until a thread
-00012260: 206f 7065 6e73 0a20 2020 2020 2020 2075   opens.        u
-00012270: 702e 2054 6869 7320 656e 7375 7265 7320  p. This ensures 
-00012280: 7468 6174 2064 6f77 6e73 7472 6561 6d20  that downstream 
-00012290: 7461 736b 7320 616c 7761 7973 2072 756e  tasks always run
-000122a0: 2062 6566 6f72 6520 6e65 7720 726f 6f74   before new root
-000122b0: 2074 6173 6b73 2061 7265 0a20 2020 2020   tasks are.     
-000122c0: 2020 2073 7461 7274 6564 2e0a 0a20 2020     started...   
-000122d0: 2020 2020 2054 6869 7320 646f 6573 206e       This does n
-000122e0: 6f74 2074 7279 2074 6f20 7363 6865 6475  ot try to schedu
-000122f0: 6c65 2073 6962 6c69 6e67 2074 6173 6b73  le sibling tasks
-00012300: 206f 6e20 7468 6520 7361 6d65 2077 6f72   on the same wor
-00012310: 6b65 723b 2069 6e20 6661 6374 2c20 6974  ker; in fact, it
-00012320: 0a20 2020 2020 2020 2075 7375 616c 6c79  .        usually
-00012330: 2064 6f65 7320 7468 6520 6f70 706f 7369   does the opposi
-00012340: 7465 2e20 4576 656e 2074 686f 7567 6820  te. Even though 
-00012350: 7468 6973 2069 6e63 7265 6173 6573 2073  this increases s
-00012360: 7562 7365 7175 656e 7420 6461 7461 2074  ubsequent data t
-00012370: 7261 6e73 6665 722c 0a20 2020 2020 2020  ransfer,.       
-00012380: 2069 7420 7479 7069 6361 6c6c 7920 7265   it typically re
-00012390: 6475 6365 7320 6f76 6572 616c 6c20 6d65  duces overall me
-000123a0: 6d6f 7279 2075 7365 2062 7920 656c 696d  mory use by elim
-000123b0: 696e 6174 696e 6720 726f 6f74 2074 6173  inating root tas
-000123c0: 6b20 6f76 6572 7072 6f64 7563 7469 6f6e  k overproduction
-000123d0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-000123e0: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-000123f0: 2d2d 0a20 2020 2020 2020 2077 733a 2057  --.        ws: W
-00012400: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
-00012410: 650a 2020 2020 2020 2020 2020 2020 5468  e.            Th
-00012420: 6520 776f 726b 6572 2074 6f20 6173 7369  e worker to assi
-00012430: 676e 2074 6865 2074 6173 6b20 746f 2e20  gn the task to. 
-00012440: 4966 2074 6865 7265 2061 7265 206e 6f20  If there are no 
-00012450: 6964 6c65 2077 6f72 6b65 7273 2c20 7265  idle workers, re
-00012460: 7475 726e 730a 2020 2020 2020 2020 2020  turns.          
-00012470: 2020 4e6f 6e65 2c20 696e 2077 6869 6368    None, in which
-00012480: 2063 6173 6520 7468 6520 7461 736b 2073   case the task s
-00012490: 686f 756c 6420 6265 2074 7261 6e73 6974  hould be transit
-000124a0: 696f 6e65 6420 746f 2060 6071 7565 7565  ioned to ``queue
-000124b0: 6460 602e 0a0a 2020 2020 2020 2020 2222  d``...        ""
-000124c0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-000124d0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-000124e0: 2020 2020 2020 2020 2320 5765 2064 6f6e          # We don
-000124f0: 2774 2060 6173 7365 7274 2073 656c 662e  't `assert self.
-00012500: 6973 5f72 6f6f 7469 7368 2874 7329 6020  is_rootish(ts)` 
-00012510: 6865 7265 2c20 6265 6361 7573 6520 7468  here, because th
-00012520: 6174 2063 6865 636b 2069 730a 2020 2020  at check is.    
-00012530: 2020 2020 2020 2020 2320 6465 7065 6e64          # depend
-00012540: 656e 7420 6f6e 2063 6c75 7374 6572 2073  ent on cluster s
-00012550: 697a 652e 2049 7427 7320 706f 7373 6962  ize. It's possib
-00012560: 6c65 2061 2074 6173 6b20 6c6f 6f6b 6564  le a task looked
-00012570: 2072 6f6f 742d 6973 6820 7768 656e 2069   root-ish when i
-00012580: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-00012590: 7761 7320 7175 6575 6564 2c20 6275 7420  was queued, but 
-000125a0: 7468 6520 636c 7573 7465 7220 6861 7320  the cluster has 
-000125b0: 7369 6e63 6520 7363 616c 6564 2075 7020  since scaled up 
-000125c0: 616e 6420 6974 206e 6f20 6c6f 6e67 6572  and it no longer
-000125d0: 2064 6f65 7320 7768 656e 0a20 2020 2020   does when.     
-000125e0: 2020 2020 2020 2023 2063 6f6d 696e 6720         # coming 
-000125f0: 6f75 7420 6f66 2074 6865 2071 7565 7565  out of the queue
-00012600: 2e20 4966 2060 6973 5f72 6f6f 7469 7368  . If `is_rootish
-00012610: 6020 6368 616e 6765 7320 746f 2061 2073  ` changes to a s
-00012620: 7461 7469 6320 6465 6669 6e69 7469 6f6e  tatic definition
-00012630: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012640: 7468 656e 2061 6464 2074 6861 7420 6173  then add that as
-00012650: 7365 7274 696f 6e20 6865 7265 2028 616e  sertion here (an
-00012660: 6420 6163 7475 616c 6c79 2070 6173 7320  d actually pass 
-00012670: 696e 2074 6865 2074 6173 6b29 2e0a 2020  in the task)..  
-00012680: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00012690: 206e 6f74 206d 6174 682e 6973 696e 6628   not math.isinf(
-000126a0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-000126b0: 5241 5449 4f4e 290a 0a20 2020 2020 2020  RATION)..       
-000126c0: 2069 6620 6e6f 7420 7365 6c66 2e69 646c   if not self.idl
-000126d0: 655f 7461 736b 5f63 6f75 6e74 3a0a 2020  e_task_count:.  
-000126e0: 2020 2020 2020 2020 2020 2320 416c 6c20            # All 
-000126f0: 776f 726b 6572 7320 6275 7379 3f20 5461  workers busy? Ta
-00012700: 736b 2067 6574 732f 7374 6179 7320 7175  sk gets/stays qu
-00012710: 6575 6564 2e0a 2020 2020 2020 2020 2020  eued..          
-00012720: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00012730: 2020 2020 2020 2023 204a 7573 7420 7069         # Just pi
-00012740: 636b 2074 6865 206c 6561 7374 2062 7573  ck the least bus
-00012750: 7920 776f 726b 6572 2e0a 2020 2020 2020  y worker..      
-00012760: 2020 2320 4e4f 5445 3a20 7468 6973 2077    # NOTE: this w
-00012770: 696c 6c20 6c65 6164 2074 6f20 776f 7273  ill lead to wors
-00012780: 742d 6361 7365 2073 6368 6564 756c 696e  t-case schedulin
-00012790: 6720 7769 7468 2072 6567 6172 6473 2074  g with regards t
-000127a0: 6f20 636f 2d61 7373 6967 6e6d 656e 742e  o co-assignment.
-000127b0: 0a20 2020 2020 2020 2077 7320 3d20 6d69  .        ws = mi
-000127c0: 6e28 0a20 2020 2020 2020 2020 2020 2073  n(.            s
-000127d0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-000127e0: 756e 742c 0a20 2020 2020 2020 2020 2020  unt,.           
-000127f0: 206b 6579 3d6c 616d 6264 6120 7773 3a20   key=lambda ws: 
-00012800: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-00012810: 6729 202f 2077 732e 6e74 6872 6561 6473  g) / ws.nthreads
-00012820: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00012830: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00012840: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00012850: 2020 6173 7365 7274 206e 6f74 205f 776f    assert not _wo
-00012860: 726b 6572 5f66 756c 6c28 7773 2c20 7365  rker_full(ws, se
-00012870: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
-00012880: 5449 4f4e 292c 2028 0a20 2020 2020 2020  TION), (.       
-00012890: 2020 2020 2020 2020 2077 732c 0a20 2020           ws,.   
-000128a0: 2020 2020 2020 2020 2020 2020 205f 7461               _ta
-000128b0: 736b 5f73 6c6f 7473 5f61 7661 696c 6162  sk_slots_availab
-000128c0: 6c65 2877 732c 2073 656c 662e 574f 524b  le(ws, self.WORK
-000128d0: 4552 5f53 4154 5552 4154 494f 4e29 2c0a  ER_SATURATION),.
-000128e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000128f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00012900: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-00012910: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
-00012920: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
-00012930: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00012940: 6520 616e 6420 7773 2069 7320 6e6f 7420  e and ws is not 
-00012950: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00012960: 2020 6173 7365 7274 2073 656c 662e 776f    assert self.wo
-00012970: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
-00012980: 7265 7373 2920 6973 2077 730a 2020 2020  ress) is ws.    
-00012990: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-000129a0: 7320 696e 2073 656c 662e 7275 6e6e 696e  s in self.runnin
-000129b0: 672c 2028 7773 2c20 7365 6c66 2e72 756e  g, (ws, self.run
-000129c0: 6e69 6e67 290a 0a20 2020 2020 2020 2072  ning)..        r
-000129d0: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
-000129e0: 6620 6465 6369 6465 5f77 6f72 6b65 725f  f decide_worker_
-000129f0: 6e6f 6e5f 726f 6f74 6973 6828 7365 6c66  non_rootish(self
-00012a00: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-00012a10: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
-00012a20: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
-00012a30: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
-00012a40: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
-00012a50: 6e6f 6e2d 726f 6f74 2074 6173 6b2c 2063  non-root task, c
-00012a60: 6f6e 7369 6465 7269 6e67 2064 6570 656e  onsidering depen
-00012a70: 6465 6e63 6965 7320 616e 640a 2020 2020  dencies and.    
-00012a80: 2020 2020 7265 7374 7269 6374 696f 6e73      restrictions
-00012a90: 2e0a 0a20 2020 2020 2020 204f 7574 206f  ...        Out o
-00012aa0: 6620 656c 6967 6962 6c65 2077 6f72 6b65  f eligible worke
-00012ab0: 7273 2068 6f6c 6469 6e67 2064 6570 656e  rs holding depen
-00012ac0: 6465 6e63 6965 7320 6f66 2060 6074 7360  dencies of ``ts`
-00012ad0: 602c 2073 656c 6563 7473 2074 6865 2077  `, selects the w
-00012ae0: 6f72 6b65 720a 2020 2020 2020 2020 7768  orker.        wh
-00012af0: 6572 652c 2063 6f6e 7369 6465 7269 6e67  ere, considering
-00012b00: 2077 6f72 6b65 7220 6261 636b 6c6f 6e67   worker backlong
-00012b10: 2061 6e64 2064 6174 612d 7472 616e 7366   and data-transf
-00012b20: 6572 2063 6f73 7473 2c20 7468 6520 7461  er costs, the ta
-00012b30: 736b 2069 730a 2020 2020 2020 2020 6573  sk is.        es
-00012b40: 7469 6d61 7465 6420 746f 2073 7461 7274  timated to start
-00012b50: 2072 756e 6e69 6e67 2074 6865 2073 6f6f   running the soo
-00012b60: 6e65 7374 2e0a 0a20 2020 2020 2020 2052  nest...        R
-00012b70: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-00012b80: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
-00012b90: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
-00012ba0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00012bb0: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
-00012bc0: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
-00012bd0: 746f 2e20 4966 206e 6f20 776f 726b 6572  to. If no worker
-00012be0: 7320 7361 7469 7366 7920 7468 6520 7265  s satisfy the re
-00012bf0: 7374 7269 6374 696f 6e73 206f 660a 2020  strictions of.  
-00012c00: 2020 2020 2020 2020 2020 6060 7473 6060            ``ts``
-00012c10: 206f 7220 7468 6572 6520 6172 6520 6e6f   or there are no
-00012c20: 2072 756e 6e69 6e67 2077 6f72 6b65 7273   running workers
-00012c30: 2c20 7265 7475 726e 7320 4e6f 6e65 2c20  , returns None, 
-00012c40: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
-00012c50: 6520 7461 736b 0a20 2020 2020 2020 2020  e task.         
-00012c60: 2020 2073 686f 756c 6420 6265 2074 7261     should be tra
-00012c70: 6e73 6974 696f 6e65 6420 746f 2060 606e  nsitioned to ``n
-00012c80: 6f2d 776f 726b 6572 6060 2e0a 2020 2020  o-worker``..    
-00012c90: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00012ca0: 6966 206e 6f74 2073 656c 662e 7275 6e6e  if not self.runn
-00012cb0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00012cc0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00012cd0: 2020 2020 2020 7661 6c69 645f 776f 726b        valid_work
-00012ce0: 6572 7320 3d20 7365 6c66 2e76 616c 6964  ers = self.valid
-00012cf0: 5f77 6f72 6b65 7273 2874 7329 0a20 2020  _workers(ts).   
-00012d00: 2020 2020 2069 6620 7661 6c69 645f 776f       if valid_wo
-00012d10: 726b 6572 7320 6973 204e 6f6e 6520 616e  rkers is None an
-00012d20: 6420 6c65 6e28 7365 6c66 2e72 756e 6e69  d len(self.runni
-00012d30: 6e67 2920 3c20 6c65 6e28 7365 6c66 2e77  ng) < len(self.w
-00012d40: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
-00012d50: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00012d60: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
-00012d70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00012d80: 204e 6f6e 650a 0a20 2020 2020 2020 2020   None..         
-00012d90: 2020 2023 2049 6620 7468 6572 6520 7765     # If there we
-00012da0: 7265 206e 6f20 7265 7374 7269 6374 696f  re no restrictio
-00012db0: 6e73 2c20 6076 616c 6964 5f77 6f72 6b65  ns, `valid_worke
-00012dc0: 7273 2829 6020 6469 646e 2774 2073 7562  rs()` didn't sub
-00012dd0: 7365 7420 6279 0a20 2020 2020 2020 2020  set by.         
-00012de0: 2020 2023 2060 7275 6e6e 696e 6760 2e0a     # `running`..
-00012df0: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
-00012e00: 645f 776f 726b 6572 7320 3d20 7365 6c66  d_workers = self
-00012e10: 2e72 756e 6e69 6e67 0a0a 2020 2020 2020  .running..      
-00012e20: 2020 6966 2074 732e 6465 7065 6e64 656e    if ts.dependen
-00012e30: 6369 6573 206f 7220 7661 6c69 645f 776f  cies or valid_wo
-00012e40: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
-00012e50: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00012e60: 7320 3d20 6465 6369 6465 5f77 6f72 6b65  s = decide_worke
-00012e70: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00012e80: 2020 2074 732c 0a20 2020 2020 2020 2020     ts,.         
-00012e90: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
-00012ea0: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-00012eb0: 2020 2020 2076 616c 6964 5f77 6f72 6b65       valid_worke
-00012ec0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00012ed0: 2020 2020 7061 7274 6961 6c28 7365 6c66      partial(self
-00012ee0: 2e77 6f72 6b65 725f 6f62 6a65 6374 6976  .worker_objectiv
-00012ef0: 652c 2074 7329 2c0a 2020 2020 2020 2020  e, ts),.        
-00012f00: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
-00012f10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00012f20: 2320 544f 444f 2069 6620 6069 735f 726f  # TODO if `is_ro
-00012f30: 6f74 6973 6860 2077 6f75 6c64 2061 6c77  otish` would alw
-00012f40: 6179 7320 7265 7475 726e 2054 7275 6520  ays return True 
-00012f50: 666f 7220 7461 736b 7320 7769 7468 6f75  for tasks withou
-00012f60: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-00012f70: 6465 7065 6e64 656e 6369 6573 2c20 7765  dependencies, we
-00012f80: 2063 6f75 6c64 2072 656d 6f76 6520 616c   could remove al
-00012f90: 6c20 7468 6973 206c 6f67 6963 2e20 5468  l this logic. Th
-00012fa0: 6520 726f 6f74 6973 6820 6173 7369 676e  e rootish assign
-00012fb0: 6d65 6e74 206c 6f67 6963 0a20 2020 2020  ment logic.     
-00012fc0: 2020 2020 2020 2023 2077 6f75 6c64 2062         # would b
-00012fd0: 6568 6176 6520 6d6f 7265 206f 7220 6c65  ehave more or le
-00012fe0: 7373 2074 6865 2073 616d 6520 6173 2074  ss the same as t
-00012ff0: 6869 732c 206d 6179 6265 2077 6974 686f  his, maybe witho
-00013000: 7574 2067 7561 7261 6e74 6565 640a 2020  ut guaranteed.  
-00013010: 2020 2020 2020 2020 2020 2320 726f 756e            # roun
-00013020: 642d 726f 6269 6e20 7468 6f75 6768 3f20  d-robin though? 
-00013030: 5468 6973 2070 6174 6820 6973 206f 6e6c  This path is onl
-00013040: 7920 7265 6163 6861 626c 6520 7768 656e  y reachable when
-00013050: 2060 7473 6020 646f 6573 6e27 7420 6861   `ts` doesn't ha
-00013060: 7665 0a20 2020 2020 2020 2020 2020 2023  ve.            #
-00013070: 2064 6570 656e 6465 6e63 6965 732c 2062   dependencies, b
-00013080: 7574 2069 7473 2067 726f 7570 2069 7320  ut its group is 
-00013090: 616c 736f 2073 6d61 6c6c 6572 2074 6861  also smaller tha
-000130a0: 6e20 7468 6520 636c 7573 7465 722e 0a0a  n the cluster...
-000130b0: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
-000130c0: 7374 7061 7468 2077 6865 6e20 7468 6572  stpath when ther
-000130d0: 6520 6172 6520 6e6f 2072 656c 6174 6564  e are no related
-000130e0: 2074 6173 6b73 206f 7220 7265 7374 7269   tasks or restri
-000130f0: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
-00013100: 2020 2077 6f72 6b65 725f 706f 6f6c 203d     worker_pool =
-00013110: 2073 656c 662e 6964 6c65 206f 7220 7365   self.idle or se
-00013120: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
-00013130: 2020 2020 2020 2023 2046 4958 4d45 2069         # FIXME i
-00013140: 646c 6520 616e 6420 776f 726b 6572 7320  dle and workers 
-00013150: 6172 6520 536f 7274 6564 4469 6374 2773  are SortedDict's
-00013160: 2064 6563 6c61 7265 6420 6173 2064 6963   declared as dic
-00013170: 7473 0a20 2020 2020 2020 2020 2020 2023  ts.            #
-00013180: 2020 2020 2020 2062 6563 6175 7365 2073         because s
-00013190: 6f72 7465 6463 6f6e 7461 696e 6572 7320  ortedcontainers 
-000131a0: 6973 206e 6f74 2061 6e6e 6f74 6174 6564  is not annotated
-000131b0: 0a20 2020 2020 2020 2020 2020 2077 705f  .            wp_
-000131c0: 7661 6c73 203d 2063 6173 7428 2253 6571  vals = cast("Seq
-000131d0: 7565 6e63 655b 576f 726b 6572 5374 6174  uence[WorkerStat
-000131e0: 655d 222c 2077 6f72 6b65 725f 706f 6f6c  e]", worker_pool
-000131f0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-00013200: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
-00013210: 203d 206c 656e 2877 705f 7661 6c73 290a   = len(wp_vals).
-00013220: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00013230: 5f77 6f72 6b65 7273 203c 2032 303a 2020  _workers < 20:  
-00013240: 2320 736d 6172 7420 6275 7420 6c69 6e65  # smart but line
-00013250: 6172 2069 6e20 736d 616c 6c20 6361 7365  ar in small case
-00013260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013270: 2077 7320 3d20 6d69 6e28 7770 5f76 616c   ws = min(wp_val
-00013280: 732c 206b 6579 3d6f 7065 7261 746f 722e  s, key=operator.
-00013290: 6174 7472 6765 7474 6572 2822 6f63 6375  attrgetter("occu
-000132a0: 7061 6e63 7922 2929 0a20 2020 2020 2020  pancy")).       
-000132b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000132c0: 7773 0a20 2020 2020 2020 2020 2020 2020  ws.             
-000132d0: 2020 2069 6620 7773 2e6f 6363 7570 616e     if ws.occupan
-000132e0: 6379 203d 3d20 303a 0a20 2020 2020 2020  cy == 0:.       
-000132f0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
-00013300: 7065 6369 616c 2063 6173 6520 746f 2075  pecial case to u
-00013310: 7365 2072 6f75 6e64 2d72 6f62 696e 3b20  se round-robin; 
-00013320: 6c69 6e65 6172 2073 6561 7263 680a 2020  linear search.  
-00013330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013340: 2020 2320 666f 7220 6e65 7874 2077 6f72    # for next wor
-00013350: 6b65 7220 7769 7468 207a 6572 6f20 6f63  ker with zero oc
-00013360: 6375 7061 6e63 7920 286f 7220 6a75 7374  cupancy (or just
-00013370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013380: 2020 2020 2023 206c 616e 6420 6261 636b       # land back
-00013390: 2077 6865 7265 2077 6520 7374 6172 7465   where we starte
-000133a0: 6429 2e0a 2020 2020 2020 2020 2020 2020  d)..            
-000133b0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-000133c0: 7365 6c66 2e6e 5f74 6173 6b73 2025 206e  self.n_tasks % n
-000133d0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-000133e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000133f0: 2069 2069 6e20 7261 6e67 6528 6e5f 776f   i in range(n_wo
-00013400: 726b 6572 7329 3a0a 2020 2020 2020 2020  rkers):.        
-00013410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013420: 7770 5f69 203d 2077 705f 7661 6c73 5b28  wp_i = wp_vals[(
-00013430: 6920 2b20 7374 6172 7429 2025 206e 5f77  i + start) % n_w
-00013440: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
-00013450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013460: 6966 2077 705f 692e 6f63 6375 7061 6e63  if wp_i.occupanc
-00013470: 7920 3d3d 2030 3a0a 2020 2020 2020 2020  y == 0:.        
-00013480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013490: 2020 2020 7773 203d 2077 705f 690a 2020      ws = wp_i.  
-000134a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134b0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-000134c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000134d0: 3a20 2023 2064 756d 6220 6275 7420 6661  :  # dumb but fa
-000134e0: 7374 2069 6e20 6c61 7267 6520 6361 7365  st in large case
-000134f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013500: 2077 7320 3d20 7770 5f76 616c 735b 7365   ws = wp_vals[se
-00013510: 6c66 2e6e 5f74 6173 6b73 2025 206e 5f77  lf.n_tasks % n_w
-00013520: 6f72 6b65 7273 5d0a 0a20 2020 2020 2020  orkers]..       
-00013530: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00013540: 6520 616e 6420 7773 2069 7320 6e6f 7420  e and ws is not 
-00013550: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00013560: 2020 6173 7365 7274 2073 656c 662e 776f    assert self.wo
-00013570: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
-00013580: 7265 7373 2920 6973 2077 730a 2020 2020  ress) is ws.    
-00013590: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-000135a0: 7320 696e 2073 656c 662e 7275 6e6e 696e  s in self.runnin
-000135b0: 672c 2028 7773 2c20 7365 6c66 2e72 756e  g, (ws, self.run
-000135c0: 6e69 6e67 290a 0a20 2020 2020 2020 2072  ning)..        r
-000135d0: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
-000135e0: 6620 7472 616e 7369 7469 6f6e 5f77 6169  f transition_wai
-000135f0: 7469 6e67 5f70 726f 6365 7373 696e 6728  ting_processing(
-00013600: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00013610: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00013620: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00013630: 2020 2020 2020 2022 2222 506f 7373 6962         """Possib
-00013640: 6c79 2073 6368 6564 756c 6520 6120 7265  ly schedule a re
-00013650: 6164 7920 7461 736b 2e20 5468 6973 2069  ady task. This i
-00013660: 7320 7468 6520 7072 696d 6172 7920 6469  s the primary di
-00013670: 7370 6174 6368 2066 6f72 2072 6561 6479  spatch for ready
-00013680: 2074 6173 6b73 2e0a 0a20 2020 2020 2020   tasks...       
-00013690: 2049 6620 7468 6572 6527 7320 6e6f 2061   If there's no a
-000136a0: 7070 726f 7072 6961 7465 2077 6f72 6b65  ppropriate worke
-000136b0: 7220 666f 7220 7468 6520 7461 736b 2028  r for the task (
-000136c0: 6275 7420 7468 6520 7461 736b 2069 7320  but the task is 
-000136d0: 6f74 6865 7277 6973 650a 2020 2020 2020  otherwise.      
-000136e0: 2020 7275 6e6e 6162 6c65 292c 2069 7420    runnable), it 
-000136f0: 7769 6c6c 2062 6520 7265 636f 6d6d 656e  will be recommen
-00013700: 6465 6420 746f 2060 606e 6f2d 776f 726b  ded to ``no-work
-00013710: 6572 6060 206f 7220 6060 7175 6575 6564  er`` or ``queued
-00013720: 6060 2e0a 2020 2020 2020 2020 2222 220a  ``..        """.
-00013730: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00013740: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
-00013750: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-00013760: 5f72 6f6f 7469 7368 2874 7329 3a0a 2020  _rootish(ts):.  
-00013770: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-00013780: 3a20 6861 7669 6e67 2074 776f 2072 6f6f  : having two roo
-00013790: 742d 6973 6820 6d65 7468 6f64 7320 6973  t-ish methods is
-000137a0: 2074 656d 706f 7261 7279 2e20 5768 656e   temporary. When
-000137b0: 2074 6865 2066 6561 7475 7265 2066 6c61   the feature fla
-000137c0: 6720 6973 0a20 2020 2020 2020 2020 2020  g is.           
-000137d0: 2023 2072 656d 6f76 6564 2c20 7468 6572   # removed, ther
-000137e0: 6520 7368 6f75 6c64 206f 6e6c 7920 6265  e should only be
-000137f0: 206f 6e65 2c20 7768 6963 6820 636f 6d62   one, which comb
-00013800: 696e 6573 2063 6f2d 6173 7369 676e 6d65  ines co-assignme
-00013810: 6e74 2061 6e64 0a20 2020 2020 2020 2020  nt and.         
-00013820: 2020 2023 2071 7565 7569 6e67 2e20 4576     # queuing. Ev
-00013830: 656e 7475 616c 6c79 2c20 7370 6563 6961  entually, specia
-00013840: 6c2d 6361 7369 6e67 2072 6f6f 7420 7461  l-casing root ta
-00013850: 736b 7320 6d69 6768 7420 6265 2072 656d  sks might be rem
-00013860: 6f76 6564 2065 6e74 6972 656c 792c 0a20  oved entirely,. 
-00013870: 2020 2020 2020 2020 2020 2023 2077 6974             # wit
-00013880: 6820 6265 7474 6572 2068 6575 7269 7374  h better heurist
-00013890: 6963 732e 0a20 2020 2020 2020 2020 2020  ics..           
-000138a0: 2069 6620 6d61 7468 2e69 7369 6e66 2873   if math.isinf(s
-000138b0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-000138c0: 4154 494f 4e29 3a0a 2020 2020 2020 2020  ATION):.        
-000138d0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
-000138e0: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
-000138f0: 655f 776f 726b 6572 5f72 6f6f 7469 7368  e_worker_rootish
-00013900: 5f71 7565 7569 6e67 5f64 6973 6162 6c65  _queuing_disable
-00013910: 6428 7473 2929 3a0a 2020 2020 2020 2020  d(ts)):.        
-00013920: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013930: 726e 207b 7473 2e6b 6579 3a20 226e 6f2d  rn {ts.key: "no-
-00013940: 776f 726b 6572 227d 2c20 7b7d 2c20 7b7d  worker"}, {}, {}
-00013950: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00013960: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00013970: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
-00013980: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
-00013990: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-000139a0: 696e 675f 656e 6162 6c65 6428 2929 3a0a  ing_enabled()):.
-000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139c0: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
-000139d0: 6579 3a20 2271 7565 7565 6422 7d2c 207b  ey: "queued"}, {
-000139e0: 7d2c 207b 7d0a 2020 2020 2020 2020 656c  }, {}.        el
-000139f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013a00: 6966 206e 6f74 2028 7773 203a 3d20 7365  if not (ws := se
-00013a10: 6c66 2e64 6563 6964 655f 776f 726b 6572  lf.decide_worker
-00013a20: 5f6e 6f6e 5f72 6f6f 7469 7368 2874 7329  _non_rootish(ts)
-00013a30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013a40: 2020 2072 6574 7572 6e20 7b74 732e 6b65     return {ts.ke
-00013a50: 793a 2022 6e6f 2d77 6f72 6b65 7222 7d2c  y: "no-worker"},
-00013a60: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
-00013a70: 2077 6f72 6b65 725f 6d73 6773 203d 2073   worker_msgs = s
-00013a80: 656c 662e 5f61 6464 5f74 6f5f 7072 6f63  elf._add_to_proc
-00013a90: 6573 7369 6e67 2874 732c 2077 7329 0a20  essing(ts, ws). 
-00013aa0: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-00013ab0: 2c20 7b7d 2c20 776f 726b 6572 5f6d 7367  , {}, worker_msg
-00013ac0: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00013ad0: 6974 696f 6e5f 7761 6974 696e 675f 6d65  ition_waiting_me
-00013ae0: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
-00013af0: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
-00013b00: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-00013b10: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
-00013b20: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00013b30: 2020 206e 6279 7465 733a 2069 6e74 207c     nbytes: int |
-00013b40: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00013b50: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
-00013b60: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
-00013b70: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
-00013b80: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
-00013b90: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
-00013ba0: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
-00013bb0: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
-00013bc0: 2c0a 2020 2020 2920 2d3e 2052 6563 734d  ,.    ) -> RecsM
-00013bd0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
-00013be0: 5468 6973 2074 7261 6e73 6974 696f 6e20  This transition 
-00013bf0: 6578 636c 7573 6976 656c 7920 6861 7070  exclusively happ
-00013c00: 656e 7320 696e 2061 2072 6163 6520 636f  ens in a race co
-00013c10: 6e64 6974 696f 6e20 7768 6572 6520 7468  ndition where th
-00013c20: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
-00013c30: 2020 2020 6265 6c69 6576 6573 2074 6861      believes tha
-00013c40: 7420 7468 6520 6f6e 6c79 2063 6f70 7920  t the only copy 
-00013c50: 6f66 2061 2064 6570 656e 6465 6e63 7920  of a dependency 
-00013c60: 7461 736b 2068 6173 206a 7573 7420 6265  task has just be
-00013c70: 656e 206c 6f73 742c 2073 6f20 6974 0a20  en lost, so it. 
-00013c80: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
-00013c90: 6e73 2061 6c6c 2064 6570 656e 6465 6e74  ns all dependent
-00013ca0: 7320 6261 636b 2074 6f20 7761 6974 696e  s back to waitin
-00013cb0: 672c 2062 7574 2061 6374 7561 6c6c 7920  g, but actually 
-00013cc0: 6120 7265 706c 6963 6120 6861 7320 616c  a replica has al
-00013cd0: 7265 6164 790a 2020 2020 2020 2020 6265  ready.        be
-00013ce0: 656e 2061 6371 7569 7265 6420 6279 2061  en acquired by a
-00013cf0: 2077 6f72 6b65 7220 636f 6d70 7574 696e   worker computin
-00013d00: 6720 7468 6520 6465 7065 6e64 656e 6379  g the dependency
-00013d10: 202d 2074 6865 2073 6368 6564 756c 6572   - the scheduler
-00013d20: 206a 7573 7420 646f 6573 6e27 740a 2020   just doesn't.  
-00013d30: 2020 2020 2020 6b6e 6f77 2079 6574 202d        know yet -
-00013d40: 2061 6e64 2074 6865 2065 7865 6375 7469   and the executi
-00013d50: 6f6e 2066 696e 6973 6865 7320 6265 666f  on finishes befo
-00013d60: 7265 2074 6865 2063 616e 6365 6c6c 6174  re the cancellat
-00013d70: 696f 6e20 6d65 7373 6167 6520 6672 6f6d  ion message from
-00013d80: 2074 6865 0a20 2020 2020 2020 2073 6368   the.        sch
-00013d90: 6564 756c 6572 2068 6173 2061 2063 6861  eduler has a cha
-00013da0: 6e63 6520 746f 2072 6561 6368 2074 6865  nce to reach the
-00013db0: 2077 6f72 6b65 722e 2053 686f 7274 6c79   worker. Shortly
-00013dc0: 2c20 7468 6520 6361 6e63 656c 6c61 7469  , the cancellati
-00013dd0: 6f6e 2072 6571 7565 7374 0a20 2020 2020  on request.     
-00013de0: 2020 2077 696c 6c20 7265 6163 6820 7468     will reach th
-00013df0: 6520 776f 726b 6572 2c20 7468 7573 2064  e worker, thus d
-00013e00: 656c 6574 696e 6720 7468 6520 6461 7461  eleting the data
-00013e10: 2066 726f 6d20 6d65 6d6f 7279 2e0a 2020   from memory..  
-00013e20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00013e30: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00013e40: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
-00013e50: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00013e60: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00013e70: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
-00013e80: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-00013e90: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00013ea0: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
-00013eb0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00013ec0: 2e73 7461 7465 203d 3d20 2277 6169 7469  .state == "waiti
-00013ed0: 6e67 220a 0a20 2020 2020 2020 2072 6574  ng"..        ret
-00013ee0: 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a  urn {}, {}, {}..
-00013ef0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-00013f00: 6f6e 5f70 726f 6365 7373 696e 675f 6d65  on_processing_me
-00013f10: 6d6f 7279 280a 2020 2020 2020 2020 7365  mory(.        se
-00013f20: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
-00013f30: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-00013f40: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
-00013f50: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00013f60: 2020 206e 6279 7465 733a 2069 6e74 207c     nbytes: int |
-00013f70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00013f80: 2020 2020 2020 7479 7065 3a20 6279 7465        type: byte
-00013f90: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
-00013fa0: 0a20 2020 2020 2020 2074 7970 656e 616d  .        typenam
-00013fb0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
-00013fc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
-00013fd0: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
-00013fe0: 2020 2073 7461 7274 7374 6f70 733a 206c     startstops: l
-00013ff0: 6973 745b 6469 6374 5d20 7c20 4e6f 6e65  ist[dict] | None
-00014000: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00014010: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-00014020: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
-00014030: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
-00014040: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00014050: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00014060: 776f 726b 6572 0a20 2020 2020 2020 2061  worker.        a
-00014070: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-00014080: 2877 6f72 6b65 722c 2073 7472 290a 0a20  (worker, str).. 
-00014090: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-000140a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-000140b0: 2020 2020 2061 7373 6572 7420 7473 2e70       assert ts.p
-000140c0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-000140d0: 2020 2020 2020 2020 2077 7373 203d 2074           wss = t
-000140e0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-000140f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014100: 7274 2077 7373 0a20 2020 2020 2020 2020  rt wss.         
-00014110: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00014120: 7773 732e 7072 6f63 6573 7369 6e67 0a20  wss.processing. 
-00014130: 2020 2020 2020 2020 2020 2064 656c 2077             del w
-00014140: 7373 0a20 2020 2020 2020 2020 2020 2061  ss.            a
-00014150: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00014160: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
-00014170: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00014180: 732e 7768 6f5f 6861 732c 2028 7473 2c20  s.who_has, (ts, 
-00014190: 7473 2e77 686f 5f68 6173 290a 2020 2020  ts.who_has).    
-000141a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000141b0: 6f74 2074 732e 6578 6365 7074 696f 6e5f  ot ts.exception_
-000141c0: 626c 616d 650a 2020 2020 2020 2020 2020  blame.          
-000141d0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-000141e0: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
-000141f0: 220a 0a20 2020 2020 2020 2077 7320 3d20  "..        ws = 
-00014200: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
-00014210: 2877 6f72 6b65 7229 0a20 2020 2020 2020  (worker).       
-00014220: 2069 6620 7773 2069 7320 4e6f 6e65 3a0a   if ws is None:.
-00014230: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00014240: 726e 207b 6b65 793a 2022 7265 6c65 6173  rn {key: "releas
-00014250: 6564 227d 2c20 7b7d 2c20 7b7d 0a0a 2020  ed"}, {}, {}..  
-00014260: 2020 2020 2020 6966 2077 7320 213d 2074        if ws != t
-00014270: 732e 7072 6f63 6573 7369 6e67 5f6f 6e3a  s.processing_on:
-00014280: 2020 2320 7072 6167 6d61 3a20 6e6f 636f    # pragma: noco
-00014290: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
-000142a0: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
-000142b0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-000142c0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-000142d0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-000142e0: 2020 2020 2020 2020 6622 5461 736b 207b          f"Task {
-000142f0: 7473 2e6b 6579 2172 7d20 7472 616e 7369  ts.key!r} transi
-00014300: 7469 6f6e 6564 2066 726f 6d20 7072 6f63  tioned from proc
-00014310: 6573 7369 6e67 2074 6f20 6d65 6d6f 7279  essing to memory
-00014320: 206f 6e20 776f 726b 6572 2022 0a20 2020   on worker ".   
-00014330: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
-00014340: 7773 7d2c 2077 6869 6c65 2069 7420 7761  ws}, while it wa
-00014350: 7320 6578 7065 6374 6564 2066 726f 6d20  s expected from 
-00014360: 7b74 732e 7072 6f63 6573 7369 6e67 5f6f  {ts.processing_o
-00014370: 6e7d 2e20 5468 6973 2073 686f 756c 6420  n}. This should 
-00014380: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00014390: 2020 6622 6265 2069 6d70 6f73 7369 626c    f"be impossibl
-000143a0: 652e 207b 7374 696d 756c 7573 5f69 643d  e. {stimulus_id=
-000143b0: 7d2c 2073 746f 7279 3d7b 7365 6c66 2e73  }, story={self.s
-000143c0: 746f 7279 2874 7329 7d22 0a20 2020 2020  tory(ts)}".     
-000143d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000143e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-000143f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00014400: 2020 2020 2020 2020 2320 5570 6461 7465          # Update
-00014410: 2054 696d 696e 6720 496e 666f 726d 6174   Timing Informat
-00014420: 696f 6e20 230a 2020 2020 2020 2020 2323  ion #.        ##
-00014430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014440: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00014450: 2020 2020 6966 2073 7461 7274 7374 6f70      if startstop
-00014460: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
-00014470: 6f72 2073 7461 7274 7374 6f70 2069 6e20  or startstop in 
-00014480: 7374 6172 7473 746f 7073 3a0a 2020 2020  startstops:.    
-00014490: 2020 2020 2020 2020 2020 2020 7473 2e67              ts.g
-000144a0: 726f 7570 2e61 6464 5f64 7572 6174 696f  roup.add_duratio
-000144b0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-000144c0: 2020 2020 2020 2073 746f 703d 7374 6172         stop=star
-000144d0: 7473 746f 705b 2273 746f 7022 5d2c 0a20  tstop["stop"],. 
-000144e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144f0: 2020 2073 7461 7274 3d73 7461 7274 7374     start=startst
-00014500: 6f70 5b22 7374 6172 7422 5d2c 0a20 2020  op["start"],.   
-00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014520: 2061 6374 696f 6e3d 7374 6172 7473 746f   action=startsto
-00014530: 705b 2261 6374 696f 6e22 5d2c 0a20 2020  p["action"],.   
-00014540: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00014550: 2020 2020 2020 2020 7320 3d20 7365 6c66          s = self
-00014560: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
-00014570: 6e73 2e70 6f70 2874 732e 7072 6566 6978  ns.pop(ts.prefix
-00014580: 2e6e 616d 652c 2073 6574 2829 290a 2020  .name, set()).  
-00014590: 2020 2020 2020 7374 6561 6c20 3d20 7365        steal = se
-000145a0: 6c66 2e65 7874 656e 7369 6f6e 732e 6765  lf.extensions.ge
-000145b0: 7428 2273 7465 616c 696e 6722 290a 2020  t("stealing").  
-000145c0: 2020 2020 2020 6966 2073 7465 616c 3a0a        if steal:.
-000145d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000145e0: 7474 7320 696e 2073 3a0a 2020 2020 2020  tts in s:.      
-000145f0: 2020 2020 2020 2020 2020 6966 2074 7473            if tts
-00014600: 2e70 726f 6365 7373 696e 675f 6f6e 3a0a  .processing_on:.
-00014610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014620: 2020 2020 7374 6561 6c2e 7265 6361 6c63      steal.recalc
-00014630: 756c 6174 655f 636f 7374 2874 7473 290a  ulate_cost(tts).
-00014640: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-00014650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014660: 2323 2323 230a 2020 2020 2020 2020 2320  #####.        # 
-00014670: 5570 6461 7465 2053 7461 7465 2049 6e66  Update State Inf
-00014680: 6f72 6d61 7469 6f6e 2023 0a20 2020 2020  ormation #.     
-00014690: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-000146a0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-000146b0: 2020 2020 2020 2020 6966 206e 6279 7465          if nbyte
-000146c0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-000146d0: 2020 2020 2020 2020 2020 2074 732e 7365             ts.se
-000146e0: 745f 6e62 7974 6573 286e 6279 7465 7329  t_nbytes(nbytes)
-000146f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00014700: 6578 6974 5f70 726f 6365 7373 696e 675f  exit_processing_
-00014710: 636f 6d6d 6f6e 2874 7329 0a0a 2020 2020  common(ts)..    
-00014720: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00014730: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-00014740: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-00014750: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
-00014760: 2020 2020 2020 7365 6c66 2e5f 6164 645f        self._add_
-00014770: 746f 5f6d 656d 6f72 7928 0a20 2020 2020  to_memory(.     
-00014780: 2020 2020 2020 2074 732c 2077 732c 2072         ts, ws, r
-00014790: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-000147a0: 636c 6965 6e74 5f6d 7367 732c 2074 7970  client_msgs, typ
-000147b0: 653d 7479 7065 2c20 7479 7065 6e61 6d65  e=type, typename
-000147c0: 3d74 7970 656e 616d 650a 2020 2020 2020  =typename.      
-000147d0: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-000147e0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-000147f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014800: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00014810: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
-00014820: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00014830: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
-00014840: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00014850: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00014860: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
-00014870: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00014880: 5f6d 656d 6f72 795f 7265 6c65 6173 6564  _memory_released
-00014890: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-000148a0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-000148b0: 7573 5f69 643a 2073 7472 2c20 2a2c 2073  us_id: str, *, s
-000148c0: 6166 653a 2062 6f6f 6c20 3d20 4661 6c73  afe: bool = Fals
-000148d0: 650a 2020 2020 2920 2d3e 2052 6563 734d  e.    ) -> RecsM
-000148e0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-000148f0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00014900: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00014910: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00014920: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014930: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00014940: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00014950: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
-00014960: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-00014970: 2020 2020 2020 6966 2073 6166 653a 0a20        if safe:. 
-00014980: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00014990: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-000149a0: 7465 7273 0a0a 2020 2020 2020 2020 6966  ters..        if
-000149b0: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
-000149c0: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
-000149d0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
-000149e0: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
-000149f0: 6163 746f 7273 2e64 6973 6361 7264 2874  actors.discard(t
-00014a00: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-00014a10: 6620 7473 2e77 686f 5f77 616e 7473 3a0a  f ts.who_wants:.
-00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a30: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-00014a40: 6d65 203d 2074 730a 2020 2020 2020 2020  me = ts.        
-00014a50: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
-00014a60: 7469 6f6e 203d 2053 6572 6961 6c69 7a65  tion = Serialize
-00014a70: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00014a80: 2020 2020 2020 202a 7365 7269 616c 697a         *serializ
-00014a90: 6528 5661 6c75 6545 7272 6f72 2822 576f  e(ValueError("Wo
-00014aa0: 726b 6572 2068 6f6c 6469 6e67 2041 6374  rker holding Act
-00014ab0: 6f72 2077 6173 206c 6f73 7422 2929 0a20  or was lost")). 
-00014ac0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00014ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ae0: 2072 6574 7572 6e20 7b74 732e 6b65 793a   return {ts.key:
-00014af0: 2022 6572 7265 6422 7d2c 207b 7d2c 207b   "erred"}, {}, {
-00014b00: 7d20 2023 2064 6f6e 2774 2074 7279 2074  }  # don't try t
-00014b10: 6f20 7265 6372 6561 7465 0a0a 2020 2020  o recreate..    
-00014b20: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00014b30: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-00014b40: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-00014b50: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
-00014b60: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00014b70: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
-00014b80: 2020 2020 2020 2320 5858 5820 6661 6374        # XXX fact
-00014b90: 6f72 2074 6869 7320 6f75 743f 0a20 2020  or this out?.   
-00014ba0: 2020 2020 2077 6f72 6b65 725f 6d73 6720       worker_msg 
-00014bb0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00014bc0: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
-00014bd0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00014be0: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
-00014bf0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-00014c00: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-00014c10: 735f 6964 2c0a 2020 2020 2020 2020 7d0a  s_id,.        }.
-00014c20: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-00014c30: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
-00014c40: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00014c50: 5f6d 7367 735b 7773 2e61 6464 7265 7373  _msgs[ws.address
-00014c60: 5d20 3d20 5b77 6f72 6b65 725f 6d73 675d  ] = [worker_msg]
-00014c70: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00014c80: 6d6f 7665 5f61 6c6c 5f72 6570 6c69 6361  move_all_replica
-00014c90: 7328 7473 290a 0a20 2020 2020 2020 2074  s(ts)..        t
-00014ca0: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
-00014cb0: 7365 6422 0a0a 2020 2020 2020 2020 7265  sed"..        re
-00014cc0: 706f 7274 5f6d 7367 203d 207b 226f 7022  port_msg = {"op"
-00014cd0: 3a20 226c 6f73 742d 6461 7461 222c 2022  : "lost-data", "
-00014ce0: 6b65 7922 3a20 6b65 797d 0a20 2020 2020  key": key}.     
-00014cf0: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
-00014d00: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-00014d10: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-00014d20: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
-00014d30: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
-00014d40: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00014d50: 2074 732e 7275 6e5f 7370 6563 3a20 2023   ts.run_spec:  #
-00014d60: 2070 7572 6520 6461 7461 0a20 2020 2020   pure data.     
-00014d70: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00014d80: 6174 696f 6e73 5b6b 6579 5d20 3d20 2266  ations[key] = "f
-00014d90: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
-00014da0: 2020 656c 6966 2074 732e 6861 735f 6c6f    elif ts.has_lo
-00014db0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
-00014dc0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00014dd0: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
-00014de0: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
-00014df0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
-00014e00: 7768 6f5f 7761 6e74 7320 6f72 2074 732e  who_wants or ts.
-00014e10: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
-00014e20: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00014e30: 696f 6e73 5b6b 6579 5d20 3d20 2277 6169  ions[key] = "wai
-00014e40: 7469 6e67 220a 0a20 2020 2020 2020 2066  ting"..        f
-00014e50: 6f72 2064 7473 2069 6e20 7473 2e77 6169  or dts in ts.wai
-00014e60: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
-00014e70: 2020 6966 2064 7473 2e73 7461 7465 2069    if dts.state i
-00014e80: 6e20 2822 6e6f 2d77 6f72 6b65 7222 2c20  n ("no-worker", 
-00014e90: 2270 726f 6365 7373 696e 6722 293a 0a20  "processing"):. 
-00014ea0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00014eb0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
-00014ec0: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
-00014ed0: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
-00014ee0: 656c 6966 2064 7473 2e73 7461 7465 203d  elif dts.state =
-00014ef0: 3d20 2277 6169 7469 6e67 223a 0a20 2020  = "waiting":.   
-00014f00: 2020 2020 2020 2020 2020 2020 2064 7473               dts
-00014f10: 2e77 6169 7469 6e67 5f6f 6e2e 6164 6428  .waiting_on.add(
-00014f20: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
-00014f30: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00014f40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014f50: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00014f60: 5f6f 6e0a 0a20 2020 2020 2020 2072 6574  _on..        ret
-00014f70: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00014f80: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-00014f90: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
-00014fa0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-00014fb0: 6e5f 7265 6c65 6173 6564 5f65 7272 6564  n_released_erred
-00014fc0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-00014fd0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00014fe0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00014ff0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00015000: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00015010: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00015020: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00015030: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00015040: 7367 733a 204d 7367 7320 3d20 7b7d 0a0a  sgs: Msgs = {}..
-00015050: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00015060: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00015070: 2020 2020 2020 7769 7468 206c 6f67 5f65        with log_e
-00015080: 7272 6f72 7328 7064 623d 4c4f 475f 5044  rrors(pdb=LOG_PD
-00015090: 4229 3a0a 2020 2020 2020 2020 2020 2020  B):.            
-000150a0: 2020 2020 6173 7365 7274 2074 732e 6578      assert ts.ex
-000150b0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-000150c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-000150d0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-000150e0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-000150f0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00015100: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-00015110: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00015120: 6572 7420 6e6f 7420 7473 2e77 6169 7465  ert not ts.waite
-00015130: 7273 0a0a 2020 2020 2020 2020 6661 696c  rs..        fail
-00015140: 696e 675f 7473 203d 2074 732e 6578 6365  ing_ts = ts.exce
-00015150: 7074 696f 6e5f 626c 616d 650a 2020 2020  ption_blame.    
-00015160: 2020 2020 6173 7365 7274 2066 6169 6c69      assert faili
-00015170: 6e67 5f74 730a 0a20 2020 2020 2020 2066  ng_ts..        f
-00015180: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00015190: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-000151a0: 2020 2020 2064 7473 2e65 7863 6570 7469       dts.excepti
-000151b0: 6f6e 5f62 6c61 6d65 203d 2066 6169 6c69  on_blame = faili
-000151c0: 6e67 5f74 730a 2020 2020 2020 2020 2020  ng_ts.          
-000151d0: 2020 6966 206e 6f74 2064 7473 2e77 686f    if not dts.who
-000151e0: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-000151f0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00015200: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-00015210: 2022 6572 7265 6422 0a0a 2020 2020 2020   "erred"..      
-00015220: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
-00015230: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
-00015240: 223a 2022 7461 736b 2d65 7272 6564 222c  ": "task-erred",
-00015250: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
-00015260: 7922 3a20 6b65 792c 0a20 2020 2020 2020  y": key,.       
-00015270: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
-00015280: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
-00015290: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
-000152a0: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
-000152b0: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
-000152c0: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
-000152d0: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
-000152e0: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
-000152f0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00015300: 656e 745f 6d73 6773 5b63 732e 636c 6965  ent_msgs[cs.clie
-00015310: 6e74 5f6b 6579 5d20 3d20 5b72 6570 6f72  nt_key] = [repor
-00015320: 745f 6d73 675d 0a0a 2020 2020 2020 2020  t_msg]..        
-00015330: 7473 2e73 7461 7465 203d 2022 6572 7265  ts.state = "erre
-00015340: 6422 0a0a 2020 2020 2020 2020 2320 544f  d"..        # TO
-00015350: 444f 3a20 7761 6974 696e 6720 6461 7461  DO: waiting data
-00015360: 3f0a 2020 2020 2020 2020 7265 7475 726e  ?.        return
-00015370: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015380: 2c20 636c 6965 6e74 5f6d 7367 732c 207b  , client_msgs, {
-00015390: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
-000153a0: 6974 696f 6e5f 6572 7265 645f 7265 6c65  ition_erred_rele
-000153b0: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
-000153c0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-000153d0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-000153e0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-000153f0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00015400: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00015410: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00015420: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
-00015430: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
-00015440: 7b7d 0a20 2020 2020 2020 2077 6f72 6b65  {}.        worke
-00015450: 725f 6d73 6773 3a20 4d73 6773 203d 207b  r_msgs: Msgs = {
-00015460: 7d0a 0a20 2020 2020 2020 2069 6620 7365  }..        if se
-00015470: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00015480: 2020 2020 2020 2020 2077 6974 6820 6c6f           with lo
-00015490: 675f 6572 726f 7273 2870 6462 3d4c 4f47  g_errors(pdb=LOG
-000154a0: 5f50 4442 293a 0a20 2020 2020 2020 2020  _PDB):.         
-000154b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000154c0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-000154d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000154e0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-000154f0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-00015500: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015510: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-00015540: 6974 6572 730a 0a20 2020 2020 2020 2074  iters..        t
-00015550: 732e 6578 6365 7074 696f 6e20 3d20 4e6f  s.exception = No
-00015560: 6e65 0a20 2020 2020 2020 2074 732e 6578  ne.        ts.ex
-00015570: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00015580: 4e6f 6e65 0a20 2020 2020 2020 2074 732e  None.        ts.
-00015590: 7472 6163 6562 6163 6b20 3d20 4e6f 6e65  traceback = None
-000155a0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-000155b0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000155c0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-000155d0: 6966 2064 7473 2e73 7461 7465 203d 3d20  if dts.state == 
-000155e0: 2265 7272 6564 223a 0a20 2020 2020 2020  "erred":.       
-000155f0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00015600: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-00015610: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
-00015620: 2020 2020 2020 2077 5f6d 7367 203d 207b         w_msg = {
-00015630: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
-00015640: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
-00015650: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-00015660: 7322 3a20 5b6b 6579 5d2c 0a20 2020 2020  s": [key],.     
-00015670: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-00015680: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-00015690: 642c 0a20 2020 2020 2020 207d 0a20 2020  d,.        }.   
-000156a0: 2020 2020 2066 6f72 2077 735f 6164 6472       for ws_addr
-000156b0: 2069 6e20 7473 2e65 7272 6564 5f6f 6e3a   in ts.erred_on:
-000156c0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-000156d0: 6b65 725f 6d73 6773 5b77 735f 6164 6472  ker_msgs[ws_addr
-000156e0: 5d20 3d20 5b77 5f6d 7367 5d0a 2020 2020  ] = [w_msg].    
-000156f0: 2020 2020 7473 2e65 7272 6564 5f6f 6e2e      ts.erred_on.
-00015700: 636c 6561 7228 290a 0a20 2020 2020 2020  clear()..       
-00015710: 2072 6570 6f72 745f 6d73 6720 3d20 7b22   report_msg = {"
-00015720: 6f70 223a 2022 7461 736b 2d72 6574 7269  op": "task-retri
-00015730: 6564 222c 2022 6b65 7922 3a20 6b65 797d  ed", "key": key}
-00015740: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
-00015750: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
-00015760: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00015770: 656e 745f 6d73 6773 5b63 732e 636c 6965  ent_msgs[cs.clie
-00015780: 6e74 5f6b 6579 5d20 3d20 5b72 6570 6f72  nt_key] = [repor
-00015790: 745f 6d73 675d 0a0a 2020 2020 2020 2020  t_msg]..        
-000157a0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
-000157b0: 6173 6564 220a 0a20 2020 2020 2020 2072  ased"..        r
-000157c0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-000157d0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-000157e0: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
-000157f0: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
-00015800: 696f 6e5f 7761 6974 696e 675f 7265 6c65  ion_waiting_rele
-00015810: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
-00015820: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-00015830: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-00015840: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-00015850: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00015860: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00015870: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00015880: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-00015890: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-000158a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000158b0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-000158c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000158d0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-000158e0: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
-000158f0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-00015900: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-00015910: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-00015920: 696e 2064 7473 2e77 6169 7465 7273 3a0a  in dts.waiters:.
-00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015940: 6474 732e 7761 6974 6572 732e 6469 7363  dts.waiters.disc
-00015950: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
-00015960: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-00015970: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
-00015980: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-00015990: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000159a0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-000159b0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-000159c0: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
-000159d0: 2020 2020 7473 2e77 6169 7469 6e67 5f6f      ts.waiting_o
-000159e0: 6e2e 636c 6561 7228 290a 0a20 2020 2020  n.clear()..     
-000159f0: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
-00015a00: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
-00015a10: 2020 6966 2074 732e 6861 735f 6c6f 7374    if ts.has_lost
-00015a20: 5f64 6570 656e 6465 6e63 6965 733a 0a20  _dependencies:. 
-00015a30: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00015a40: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
-00015a50: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
-00015a60: 2020 2020 2020 656c 6966 206e 6f74 2074        elif not t
-00015a70: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00015a80: 6520 616e 6420 2874 732e 7768 6f5f 7761  e and (ts.who_wa
-00015a90: 6e74 7320 6f72 2074 732e 7761 6974 6572  nts or ts.waiter
-00015aa0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00015ab0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-00015ac0: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
-00015ad0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00015ae0: 2020 2020 2020 2020 2020 2074 732e 7761             ts.wa
-00015af0: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
-00015b00: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00015b10: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
-00015b20: 7d2c 207b 7d0a 0a20 2020 2064 6566 2074  }, {}..    def t
-00015b30: 7261 6e73 6974 696f 6e5f 7072 6f63 6573  ransition_proces
-00015b40: 7369 6e67 5f72 656c 6561 7365 6428 7365  sing_released(se
-00015b50: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
-00015b60: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
-00015b70: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00015b80: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00015b90: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-00015ba0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00015bb0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00015bc0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00015bd0: 3a20 4d73 6773 203d 207b 7d0a 0a20 2020  : Msgs = {}..   
-00015be0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00015bf0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00015c00: 2020 2061 7373 6572 7420 7473 2e70 726f     assert ts.pro
-00015c10: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00015c20: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015c30: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-00015c40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015c50: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00015c60: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00015c70: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
-00015c80: 2022 7072 6f63 6573 7369 6e67 220a 0a20   "processing".. 
-00015c90: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
-00015ca0: 2e5f 6578 6974 5f70 726f 6365 7373 696e  ._exit_processin
-00015cb0: 675f 636f 6d6d 6f6e 2874 7329 0a20 2020  g_common(ts).   
-00015cc0: 2020 2020 2069 6620 7773 3a0a 2020 2020       if ws:.    
-00015cd0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-00015ce0: 7367 735b 7773 2e61 6464 7265 7373 5d20  sgs[ws.address] 
-00015cf0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00015d00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00015d10: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00015d20: 2266 7265 652d 6b65 7973 222c 0a20 2020  "free-keys",.   
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
-00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d60: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-00015d70: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d90: 7d0a 2020 2020 2020 2020 2020 2020 5d0a  }.            ].
-00015da0: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
-00015db0: 726f 7061 6761 7465 5f72 656c 6561 7365  ropagate_release
-00015dc0: 6428 7473 2c20 7265 636f 6d6d 656e 6461  d(ts, recommenda
-00015dd0: 7469 6f6e 7329 0a20 2020 2020 2020 2072  tions).        r
-00015de0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00015df0: 7469 6f6e 732c 207b 7d2c 2077 6f72 6b65  tions, {}, worke
-00015e00: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
-00015e10: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
-00015e20: 7373 696e 675f 6572 7265 6428 0a20 2020  ssing_erred(.   
-00015e30: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00015e40: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
-00015e50: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00015e60: 3a20 7374 722c 0a20 2020 2020 2020 202a  : str,.        *
-00015e70: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
-00015e80: 3a20 7374 722c 0a20 2020 2020 2020 2063  : str,.        c
-00015e90: 6175 7365 3a20 7374 7220 7c20 4e6f 6e65  ause: str | None
-00015ea0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00015eb0: 2065 7863 6570 7469 6f6e 3a20 5365 7269   exception: Seri
-00015ec0: 616c 697a 6564 207c 204e 6f6e 6520 3d20  alized | None = 
-00015ed0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
-00015ee0: 6163 6562 6163 6b3a 2053 6572 6961 6c69  aceback: Seriali
-00015ef0: 7a65 6420 7c20 4e6f 6e65 203d 204e 6f6e  zed | None = Non
-00015f00: 652c 0a20 2020 2020 2020 2065 7863 6570  e,.        excep
-00015f10: 7469 6f6e 5f74 6578 743a 2073 7472 207c  tion_text: str |
-00015f20: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00015f30: 2020 2020 2020 7472 6163 6562 6163 6b5f        traceback_
-00015f40: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
-00015f50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00015f60: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-00015f70: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
-00015f80: 733a 0a20 2020 2020 2020 2022 2222 5072  s:.        """Pr
-00015f90: 6f63 6573 7365 6420 6120 7265 636f 6d6d  ocessed a recomm
-00015fa0: 656e 6465 6420 7472 616e 7369 7469 6f6e  ended transition
-00015fb0: 2070 726f 6365 7373 696e 6720 2d3e 2065   processing -> e
-00015fc0: 7272 6564 2e0a 0a20 2020 2020 2020 2050  rred...        P
-00015fd0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-00015fe0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00015ff0: 2020 2020 206b 6579 0a20 2020 2020 2020       key.       
-00016000: 2020 2020 4b65 7920 6f66 2074 6865 2074      Key of the t
-00016010: 6173 6b20 746f 2074 7261 6e73 6974 696f  ask to transitio
-00016020: 6e0a 2020 2020 2020 2020 7374 696d 756c  n.        stimul
-00016030: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-00016040: 2020 4944 206f 6620 7468 6520 7374 696d    ID of the stim
-00016050: 756c 7573 2063 6175 7369 6e67 2074 6865  ulus causing the
-00016060: 2074 7261 6e73 6974 696f 6e0a 2020 2020   transition.    
-00016070: 2020 2020 776f 726b 6572 0a20 2020 2020      worker.     
-00016080: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
-00016090: 6620 7468 6520 776f 726b 6572 2077 6865  f the worker whe
-000160a0: 7265 2074 6865 2074 6173 6b20 6572 7265  re the task erre
-000160b0: 642e 0a20 2020 2020 2020 2020 2020 204e  d..            N
-000160c0: 6f74 206e 6563 6573 7361 7269 6c79 2060  ot necessarily `
-000160d0: 6074 732e 7072 6f63 6573 7369 6e67 5f6f  `ts.processing_o
-000160e0: 6e60 602e 0a20 2020 2020 2020 2063 6175  n``..        cau
-000160f0: 7365 0a20 2020 2020 2020 2020 2020 2041  se.            A
-00016100: 6464 7265 7373 206f 6620 7468 6520 7461  ddress of the ta
-00016110: 736b 2074 6861 7420 6361 7573 6564 2074  sk that caused t
-00016120: 6869 7320 7461 736b 2074 6f20 6265 2074  his task to be t
-00016130: 7261 6e73 6974 696f 6e65 6420 746f 2065  ransitioned to e
-00016140: 7272 6564 0a20 2020 2020 2020 2065 7863  rred.        exc
-00016150: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
-00016160: 2020 2045 7863 6570 7469 6f6e 2063 6175     Exception cau
-00016170: 7365 6420 6279 2074 6865 2074 6173 6b0a  sed by the task.
-00016180: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00016190: 6b0a 2020 2020 2020 2020 2020 2020 5472  k.            Tr
-000161a0: 6163 6562 6163 6b20 6361 7573 6564 2062  aceback caused b
-000161b0: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
-000161c0: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-000161d0: 740a 2020 2020 2020 2020 2020 2020 5374  t.            St
-000161e0: 7269 6e67 2072 6570 7265 7365 6e74 6174  ring representat
-000161f0: 696f 6e20 6f66 2074 6865 2065 7863 6570  ion of the excep
-00016200: 7469 6f6e 0a20 2020 2020 2020 2074 7261  tion.        tra
-00016210: 6365 6261 636b 5f74 6578 740a 2020 2020  ceback_text.    
-00016220: 2020 2020 2020 2020 5374 7269 6e67 2072          String r
-00016230: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
-00016240: 2074 6865 2074 7261 6365 6261 636b 0a0a   the traceback..
-00016250: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-00016260: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-00016270: 2020 2020 2020 2020 5265 636f 6d6d 656e          Recommen
-00016280: 6461 7469 6f6e 732c 2063 6c69 656e 7420  dations, client 
-00016290: 6d65 7373 6167 6573 2061 6e64 2077 6f72  messages and wor
-000162a0: 6b65 7220 6d65 7373 6167 6573 2074 6f20  ker messages to 
-000162b0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-000162c0: 2222 220a 2020 2020 2020 2020 7473 203d  """.        ts =
-000162d0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000162e0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-000162f0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00016300: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
-00016310: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
-00016320: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
-00016330: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00016340: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016350: 2063 6175 7365 206f 7220 7473 2e65 7863   cause or ts.exc
-00016360: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-00016370: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00016380: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00016390: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000163a0: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-000163b0: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-000163c0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-000163d0: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
-000163e0: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
-000163f0: 2020 2020 2020 2020 2020 7773 203d 2074            ws = t
-00016400: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-00016410: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00016420: 7274 2077 730a 2020 2020 2020 2020 2020  rt ws.          
-00016430: 2020 7773 2e61 6374 6f72 732e 7265 6d6f    ws.actors.remo
-00016440: 7665 2874 7329 0a0a 2020 2020 2020 2020  ve(ts)..        
-00016450: 7365 6c66 2e5f 6578 6974 5f70 726f 6365  self._exit_proce
-00016460: 7373 696e 675f 636f 6d6d 6f6e 2874 7329  ssing_common(ts)
-00016470: 0a0a 2020 2020 2020 2020 7473 2e65 7272  ..        ts.err
-00016480: 6564 5f6f 6e2e 6164 6428 776f 726b 6572  ed_on.add(worker
-00016490: 290a 2020 2020 2020 2020 6966 2065 7863  ).        if exc
-000164a0: 6570 7469 6f6e 2069 7320 6e6f 7420 4e6f  eption is not No
-000164b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000164c0: 7473 2e65 7863 6570 7469 6f6e 203d 2065  ts.exception = e
-000164d0: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
-000164e0: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
-000164f0: 6e5f 7465 7874 203d 2065 7863 6570 7469  n_text = excepti
-00016500: 6f6e 5f74 6578 7420 2023 2074 7970 653a  on_text  # type:
-00016510: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-00016520: 6966 2074 7261 6365 6261 636b 2069 7320  if traceback is 
-00016530: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00016540: 2020 2020 2020 7473 2e74 7261 6365 6261        ts.traceba
-00016550: 636b 203d 2074 7261 6365 6261 636b 0a20  ck = traceback. 
-00016560: 2020 2020 2020 2020 2020 2074 732e 7472             ts.tr
-00016570: 6163 6562 6163 6b5f 7465 7874 203d 2074  aceback_text = t
-00016580: 7261 6365 6261 636b 5f74 6578 7420 2023  raceback_text  #
-00016590: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-000165a0: 2020 2020 2020 6966 2063 6175 7365 2069        if cause i
-000165b0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000165c0: 2020 2020 2020 2020 6661 696c 696e 675f          failing_
-000165d0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-000165e0: 6361 7573 655d 0a20 2020 2020 2020 2020  cause].         
-000165f0: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
-00016600: 626c 616d 6520 3d20 6661 696c 696e 675f  blame = failing_
-00016610: 7473 0a20 2020 2020 2020 2065 6c73 653a  ts.        else:
-00016620: 0a20 2020 2020 2020 2020 2020 2066 6169  .            fai
-00016630: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
-00016640: 6570 7469 6f6e 5f62 6c61 6d65 2020 2320  eption_blame  # 
-00016650: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
-00016660: 2020 2020 2020 7365 6c66 2e65 7272 6564        self.erred
-00016670: 5f74 6173 6b73 2e61 7070 656e 646c 6566  _tasks.appendlef
-00016680: 7428 0a20 2020 2020 2020 2020 2020 2045  t(.            E
-00016690: 7272 6564 5461 736b 280a 2020 2020 2020  rredTask(.      
-000166a0: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
-000166b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000166c0: 2020 7469 6d65 2829 2c0a 2020 2020 2020    time(),.      
-000166d0: 2020 2020 2020 2020 2020 7473 2e65 7272            ts.err
-000166e0: 6564 5f6f 6e2e 636f 7079 2829 2c0a 2020  ed_on.copy(),.  
-000166f0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00016700: 6365 7074 696f 6e5f 7465 7874 206f 7220  ception_text or 
-00016710: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-00016720: 2020 2020 7472 6163 6562 6163 6b5f 7465      traceback_te
-00016730: 7874 206f 7220 2222 2c0a 2020 2020 2020  xt or "",.      
-00016740: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00016750: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
-00016760: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00016770: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00016780: 2064 7473 2e65 7863 6570 7469 6f6e 5f62   dts.exception_b
-00016790: 6c61 6d65 203d 2066 6169 6c69 6e67 5f74  lame = failing_t
-000167a0: 730a 2020 2020 2020 2020 2020 2020 7265  s.            re
-000167b0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-000167c0: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
-000167d0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-000167e0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000167f0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00016800: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
-00016810: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-00016820: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
-00016830: 2e77 6169 7465 7273 2061 6e64 206e 6f74  .waiters and not
-00016840: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
-00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016860: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-00016870: 6474 732e 6b65 795d 203d 2022 7265 6c65  dts.key] = "rele
-00016880: 6173 6564 220a 0a20 2020 2020 2020 2074  ased"..        t
-00016890: 732e 7761 6974 6572 732e 636c 6561 7228  s.waiters.clear(
-000168a0: 2920 2023 2064 6f20 616e 7974 6869 6e67  )  # do anything
-000168b0: 2077 6974 6820 7468 6973 3f0a 0a20 2020   with this?..   
-000168c0: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
-000168d0: 2265 7272 6564 220a 0a20 2020 2020 2020  "erred"..       
-000168e0: 2072 6570 6f72 745f 6d73 6720 3d20 7b0a   report_msg = {.
-000168f0: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-00016900: 3a20 2274 6173 6b2d 6572 7265 6422 2c0a  : "task-erred",.
-00016910: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-00016920: 223a 206b 6579 2c0a 2020 2020 2020 2020  ": key,.        
-00016930: 2020 2020 2265 7863 6570 7469 6f6e 223a      "exception":
-00016940: 2066 6169 6c69 6e67 5f74 732e 6578 6365   failing_ts.exce
-00016950: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
-00016960: 2020 2022 7472 6163 6562 6163 6b22 3a20     "traceback": 
-00016970: 6661 696c 696e 675f 7473 2e74 7261 6365  failing_ts.trace
-00016980: 6261 636b 2c0a 2020 2020 2020 2020 7d0a  back,.        }.
-00016990: 2020 2020 2020 2020 666f 7220 6373 2069          for cs i
-000169a0: 6e20 7473 2e77 686f 5f77 616e 7473 3a0a  n ts.who_wants:.
-000169b0: 2020 2020 2020 2020 2020 2020 636c 6965              clie
-000169c0: 6e74 5f6d 7367 735b 6373 2e63 6c69 656e  nt_msgs[cs.clien
-000169d0: 745f 6b65 795d 203d 205b 7265 706f 7274  t_key] = [report
-000169e0: 5f6d 7367 5d0a 0a20 2020 2020 2020 2063  _msg]..        c
-000169f0: 7320 3d20 7365 6c66 2e63 6c69 656e 7473  s = self.clients
-00016a00: 5b22 6669 7265 2d61 6e64 2d66 6f72 6765  ["fire-and-forge
-00016a10: 7422 5d0a 2020 2020 2020 2020 6966 2074  t"].        if t
-00016a20: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
-00016a30: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
-00016a40: 7365 6c66 2e5f 636c 6965 6e74 5f72 656c  self._client_rel
-00016a50: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
-00016a60: 2020 2020 2020 2020 2020 2020 6373 3d63              cs=c
-00016a70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00016a80: 2020 206b 6579 733d 5b6b 6579 5d2c 0a20     keys=[key],. 
-00016a90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00016aa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3d72  ecommendations=r
-00016ab0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c0a  ecommendations,.
-00016ac0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00016ad0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00016ae0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00016af0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00016b00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00016b10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00016b20: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00016b30: 2c20 636c 6965 6e74 5f6d 7367 732c 207b  , client_msgs, {
-00016b40: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
-00016b50: 6974 696f 6e5f 6e6f 5f77 6f72 6b65 725f  ition_no_worker_
-00016b60: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00016b70: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-00016b80: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00016b90: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00016ba0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00016bb0: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
-00016bc0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00016bd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00016be0: 7274 2073 656c 662e 7461 736b 735b 6b65  rt self.tasks[ke
-00016bf0: 795d 2e73 7461 7465 203d 3d20 226e 6f2d  y].state == "no-
-00016c00: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
-00016c10: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00016c20: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-00016c30: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00016c40: 2074 732e 7761 6974 696e 675f 6f6e 0a0a   ts.waiting_on..
-00016c50: 2020 2020 2020 2020 7365 6c66 2e75 6e72          self.unr
-00016c60: 756e 6e61 626c 652e 7265 6d6f 7665 2874  unnable.remove(t
-00016c70: 7329 0a20 2020 2020 2020 2074 732e 7374  s).        ts.st
-00016c80: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
-00016c90: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-00016ca0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00016cb0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00016cc0: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
-00016cd0: 7363 6172 6428 7473 290a 0a20 2020 2020  scard(ts)..     
-00016ce0: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
-00016cf0: 6561 7228 290a 0a20 2020 2020 2020 2072  ear()..        r
-00016d00: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
-00016d10: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00016d20: 7469 6f6e 5f77 6169 7469 6e67 5f71 7565  tion_waiting_que
-00016d30: 7565 6428 7365 6c66 2c20 6b65 793a 2073  ued(self, key: s
-00016d40: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
-00016d50: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
-00016d60: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
-00016d70: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00016d80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016d90: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00016da0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00016db0: 7420 7365 6c66 2e69 646c 655f 7461 736b  t self.idle_task
-00016dc0: 5f63 6f75 6e74 2c20 2874 732c 2073 656c  _count, (ts, sel
-00016dd0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
-00016de0: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
-00016df0: 656c 662e 5f76 616c 6964 6174 655f 7265  elf._validate_re
-00016e00: 6164 7928 7473 290a 0a20 2020 2020 2020  ady(ts)..       
-00016e10: 2074 732e 7374 6174 6520 3d20 2271 7565   ts.state = "que
-00016e20: 7565 6422 0a20 2020 2020 2020 2073 656c  ued".        sel
-00016e30: 662e 7175 6575 6564 2e61 6464 2874 7329  f.queued.add(ts)
-00016e40: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00016e50: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
-00016e60: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
-00016e70: 7761 6974 696e 675f 6e6f 5f77 6f72 6b65  waiting_no_worke
-00016e80: 7228 7365 6c66 2c20 6b65 793a 2073 7472  r(self, key: str
-00016e90: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00016ea0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
-00016eb0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-00016ec0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
-00016ed0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00016ee0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00016ef0: 2020 2020 2073 656c 662e 5f76 616c 6964       self._valid
-00016f00: 6174 655f 7265 6164 7928 7473 290a 0a20  ate_ready(ts).. 
-00016f10: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-00016f20: 3d20 226e 6f2d 776f 726b 6572 220a 2020  = "no-worker".  
-00016f30: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
-00016f40: 6e61 626c 652e 6164 6428 7473 290a 0a20  nable.add(ts).. 
-00016f50: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-00016f60: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 6465  , {}, {}..    de
-00016f70: 6620 7472 616e 7369 7469 6f6e 5f71 7565  f transition_que
-00016f80: 7565 645f 7265 6c65 6173 6564 2873 656c  ued_released(sel
-00016f90: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00016fa0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00016fb0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00016fc0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00016fd0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00016fe0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00016ff0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00017000: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
-00017010: 662e 7175 6575 6564 0a20 2020 2020 2020  f.queued.       
-00017020: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017030: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00017040: 0a0a 2020 2020 2020 2020 7365 6c66 2e71  ..        self.q
-00017050: 7565 7565 642e 7265 6d6f 7665 2874 7329  ueued.remove(ts)
-00017060: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
-00017070: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-00017080: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00017090: 662e 5f70 726f 7061 6761 7465 5f72 656c  f._propagate_rel
-000170a0: 6561 7365 6428 7473 2c20 7265 636f 6d6d  eased(ts, recomm
-000170b0: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
-000170c0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-000170d0: 656e 6461 7469 6f6e 732c 207b 7d2c 207b  endations, {}, {
-000170e0: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
-000170f0: 6974 696f 6e5f 7175 6575 6564 5f70 726f  ition_queued_pro
-00017100: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
-00017110: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
-00017120: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
-00017130: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00017140: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00017150: 6579 5d0a 2020 2020 2020 2020 7265 636f  ey].        reco
-00017160: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00017170: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
-00017180: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-00017190: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
-000171a0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000171b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000171c0: 6572 7420 6e6f 7420 7473 2e61 6374 6f72  ert not ts.actor
-000171d0: 2c20 6622 4163 746f 7273 2063 616e 2774  , f"Actors can't
-000171e0: 2062 6520 7175 6575 6564 3a20 7b74 737d   be queued: {ts}
-000171f0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-00017200: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
-00017210: 7175 6575 6564 0a0a 2020 2020 2020 2020  queued..        
-00017220: 6966 2077 7320 3a3d 2073 656c 662e 6465  if ws := self.de
-00017230: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
-00017240: 6973 685f 7175 6575 696e 675f 656e 6162  ish_queuing_enab
-00017250: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-00017260: 2020 2073 656c 662e 7175 6575 6564 2e64     self.queued.d
-00017270: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
-00017280: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00017290: 6773 203d 2073 656c 662e 5f61 6464 5f74  gs = self._add_t
-000172a0: 6f5f 7072 6f63 6573 7369 6e67 2874 732c  o_processing(ts,
-000172b0: 2077 7329 0a20 2020 2020 2020 2023 2049   ws).        # I
-000172c0: 6620 6e6f 2077 6f72 6b65 722c 2074 6173  f no worker, tas
-000172d0: 6b20 6a75 7374 2073 7461 7973 2060 7175  k just stays `qu
-000172e0: 6575 6564 600a 0a20 2020 2020 2020 2072  eued`..        r
-000172f0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00017300: 7469 6f6e 732c 207b 7d2c 2077 6f72 6b65  tions, {}, worke
-00017310: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
-00017320: 5f72 656d 6f76 655f 6b65 7928 7365 6c66  _remove_key(self
-00017330: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
-00017340: 6f6e 653a 0a20 2020 2020 2020 2074 7320  one:.        ts 
-00017350: 3d20 7365 6c66 2e74 6173 6b73 2e70 6f70  = self.tasks.pop
-00017360: 286b 6579 290a 2020 2020 2020 2020 6173  (key).        as
-00017370: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
-00017380: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-00017390: 2020 2020 2073 656c 662e 756e 7275 6e6e       self.unrunn
-000173a0: 6162 6c65 2e64 6973 6361 7264 2874 7329  able.discard(ts)
-000173b0: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
-000173c0: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
-000173d0: 0a20 2020 2020 2020 2020 2020 2063 732e  .            cs.
-000173e0: 7761 6e74 735f 7768 6174 2e72 656d 6f76  wants_what.remov
-000173f0: 6528 7473 290a 2020 2020 2020 2020 7473  e(ts).        ts
-00017400: 2e77 686f 5f77 616e 7473 2e63 6c65 6172  .who_wants.clear
-00017410: 2829 0a20 2020 2020 2020 2074 732e 7072  ().        ts.pr
-00017420: 6f63 6573 7369 6e67 5f6f 6e20 3d20 4e6f  ocessing_on = No
-00017430: 6e65 0a20 2020 2020 2020 2074 732e 6578  ne.        ts.ex
-00017440: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00017450: 7473 2e65 7863 6570 7469 6f6e 203d 2074  ts.exception = t
-00017460: 732e 7472 6163 6562 6163 6b20 3d20 4e6f  s.traceback = No
-00017470: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00017480: 7461 736b 5f6d 6574 6164 6174 612e 706f  task_metadata.po
-00017490: 7028 6b65 792c 204e 6f6e 6529 0a0a 2020  p(key, None)..  
-000174a0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-000174b0: 5f6d 656d 6f72 795f 666f 7267 6f74 7465  _memory_forgotte
-000174c0: 6e28 7365 6c66 2c20 6b65 793a 2073 7472  n(self, key: str
-000174d0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-000174e0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
-000174f0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-00017500: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
-00017510: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00017520: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00017530: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
-00017540: 7461 7465 203d 3d20 226d 656d 6f72 7922  tate == "memory"
-00017550: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017560: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-00017570: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00017580: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017590: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-000175a0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000175b0: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
-000175c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000175d0: 4974 2773 206f 6b20 746f 2066 6f72 6765  It's ok to forge
-000175e0: 7420 6120 7075 7265 2064 6174 6120 7461  t a pure data ta
-000175f0: 736b 0a20 2020 2020 2020 2020 2020 2020  sk.             
-00017600: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00017610: 2020 2020 656c 6966 2074 732e 6861 735f      elif ts.has_
-00017620: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
-00017630: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00017640: 2020 2023 2049 7427 7320 6f6b 2074 6f20     # It's ok to 
-00017650: 666f 7267 6574 2061 2074 6173 6b20 7769  forget a task wi
-00017660: 7468 2066 6f72 676f 7474 656e 2064 6570  th forgotten dep
-00017670: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-00017680: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-00017690: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000176a0: 6e6f 7420 7473 2e77 686f 5f77 616e 7473  not ts.who_wants
-000176b0: 2061 6e64 206e 6f74 2074 732e 7761 6974   and not ts.wait
-000176c0: 6572 7320 616e 6420 6e6f 7420 7473 2e64  ers and not ts.d
-000176d0: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
-000176e0: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
-000176f0: 7320 6f6b 2074 6f20 666f 7267 6574 2061  s ok to forget a
-00017700: 2074 6173 6b20 7468 6174 206e 6f62 6f64   task that nobod
-00017710: 7920 6e65 6564 730a 2020 2020 2020 2020  y needs.        
-00017720: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00017730: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00017740: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00017750: 6169 7365 2041 7373 6572 7469 6f6e 4572  aise AssertionEr
-00017760: 726f 7228 2255 6e72 6561 6368 6162 6c65  ror("Unreachable
-00017770: 222c 2074 7329 2020 2320 7072 6167 6d61  ", ts)  # pragma
-00017780: 3a20 6e6f 636f 7665 720a 0a20 2020 2020  : nocover..     
-00017790: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
-000177a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000177b0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-000177c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000177d0: 2020 7773 2e61 6374 6f72 732e 6469 7363    ws.actors.disc
-000177e0: 6172 6428 7473 290a 0a20 2020 2020 2020  ard(ts)..       
-000177f0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00017800: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-00017810: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
-00017820: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
-00017830: 2020 2073 656c 662e 5f70 726f 7061 6761     self._propaga
-00017840: 7465 5f66 6f72 676f 7474 656e 2874 732c  te_forgotten(ts,
-00017850: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00017860: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
-00017870: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-00017880: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00017890: 203d 205f 7461 736b 5f74 6f5f 636c 6965   = _task_to_clie
-000178a0: 6e74 5f6d 7367 7328 7473 290a 2020 2020  nt_msgs(ts).    
-000178b0: 2020 2020 7365 6c66 2e5f 7265 6d6f 7665      self._remove
-000178c0: 5f6b 6579 286b 6579 290a 0a20 2020 2020  _key(key)..     
-000178d0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-000178e0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-000178f0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-00017900: 7367 730a 0a20 2020 2064 6566 2074 7261  sgs..    def tra
-00017910: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
-00017920: 5f66 6f72 676f 7474 656e 2873 656c 662c  _forgotten(self,
-00017930: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
-00017940: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-00017950: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-00017960: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00017970: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
-00017980: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00017990: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-000179a0: 7365 7274 2074 732e 7374 6174 6520 696e  sert ts.state in
-000179b0: 2028 2272 656c 6561 7365 6422 2c20 2265   ("released", "e
-000179c0: 7272 6564 2229 0a20 2020 2020 2020 2020  rred").         
-000179d0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-000179e0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-000179f0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017a00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00017a10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017a20: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-00017a30: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
-00017a40: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00017a50: 2074 732e 7761 6974 696e 675f 6f6e 2c20   ts.waiting_on, 
-00017a60: 2874 732c 2074 732e 7761 6974 696e 675f  (ts, ts.waiting_
-00017a70: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00017a80: 6966 206e 6f74 2074 732e 7275 6e5f 7370  if not ts.run_sp
-00017a90: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-00017aa0: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
-00017ab0: 2066 6f72 6765 7420 6120 7075 7265 2064   forget a pure d
-00017ac0: 6174 6120 7461 736b 0a20 2020 2020 2020  ata task.       
-00017ad0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-00017ae0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
-00017af0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
-00017b00: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-00017b10: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
-00017b20: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
-00017b30: 6173 6b20 7769 7468 2066 6f72 676f 7474  ask with forgott
-00017b40: 656e 2064 6570 656e 6465 6e63 6965 730a  en dependencies.
-00017b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b60: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00017b70: 2065 6c69 6620 6e6f 7420 7473 2e77 686f   elif not ts.who
-00017b80: 5f77 616e 7473 2061 6e64 206e 6f74 2074  _wants and not t
-00017b90: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
-00017ba0: 7420 7473 2e64 6570 656e 6465 6e74 733a  t ts.dependents:
-00017bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017bc0: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
-00017bd0: 7267 6574 2061 2074 6173 6b20 7468 6174  rget a task that
-00017be0: 206e 6f62 6f64 7920 6e65 6564 730a 2020   nobody needs.  
-00017bf0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00017c00: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00017c10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017c20: 2020 2020 2072 6169 7365 2041 7373 6572       raise Asser
-00017c30: 7469 6f6e 4572 726f 7228 2255 6e72 6561  tionError("Unrea
-00017c40: 6368 6162 6c65 222c 2073 7472 2874 7329  chable", str(ts)
-00017c50: 2920 2023 2070 7261 676d 613a 206e 6f63  )  # pragma: noc
-00017c60: 6f76 6572 0a0a 2020 2020 2020 2020 7265  over..        re
-00017c70: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00017c80: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-00017c90: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
-00017ca0: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
-00017cb0: 7365 6c66 2e5f 7072 6f70 6167 6174 655f  self._propagate_
-00017cc0: 666f 7267 6f74 7465 6e28 7473 2c20 7265  forgotten(ts, re
-00017cd0: 636f 6d6d 656e 6461 7469 6f6e 732c 2077  commendations, w
-00017ce0: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
-00017cf0: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-00017d00: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
-00017d10: 5f74 6173 6b5f 746f 5f63 6c69 656e 745f  _task_to_client_
-00017d20: 6d73 6773 2874 7329 0a20 2020 2020 2020  msgs(ts).       
-00017d30: 2073 656c 662e 5f72 656d 6f76 655f 6b65   self._remove_ke
-00017d40: 7928 6b65 7929 0a0a 2020 2020 2020 2020  y(key)..        
-00017d50: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
-00017d60: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00017d70: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00017d80: 0a0a 2020 2020 2320 7b0a 2020 2020 2320  ..    # {.    # 
-00017d90: 2020 2020 2873 7461 7274 2c20 6669 6e69      (start, fini
-00017da0: 7368 293a 0a20 2020 2023 2020 2020 2074  sh):.    #     t
-00017db0: 7261 6e73 6974 696f 6e5f 3c73 7461 7274  ransition_<start
-00017dc0: 3e5f 3c66 696e 6973 683e 280a 2020 2020  >_<finish>(.    
-00017dd0: 2320 2020 2020 2020 2020 7365 6c66 2c20  #         self, 
-00017de0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-00017df0: 7573 5f69 643a 2073 7472 2c20 2a2a 6b77  us_id: str, **kw
-00017e00: 6172 6773 0a20 2020 2023 2020 2020 2029  args.    #     )
-00017e10: 202d 3e20 2872 6563 6f6d 6d65 6e64 6174   -> (recommendat
-00017e20: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-00017e30: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
-00017e40: 2020 2020 2320 7d0a 2020 2020 5f54 5241      # }.    _TRA
-00017e50: 4e53 4954 494f 4e53 5f54 4142 4c45 3a20  NSITIONS_TABLE: 
-00017e60: 436c 6173 7356 6172 5b0a 2020 2020 2020  ClassVar[.      
-00017e70: 2020 4d61 7070 696e 675b 0a20 2020 2020    Mapping[.     
-00017e80: 2020 2020 2020 2074 7570 6c65 5b54 6173         tuple[Tas
-00017e90: 6b53 7461 7465 5374 6174 652c 2054 6173  kStateState, Tas
-00017ea0: 6b53 7461 7465 5374 6174 655d 2c0a 2020  kStateState],.  
-00017eb0: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00017ec0: 6c65 5b2e 2e2e 2c20 5265 6373 4d73 6773  le[..., RecsMsgs
-00017ed0: 5d2c 0a20 2020 2020 2020 205d 0a20 2020  ],.        ].   
-00017ee0: 205d 203d 207b 0a20 2020 2020 2020 2028   ] = {.        (
-00017ef0: 2272 656c 6561 7365 6422 2c20 2277 6169  "released", "wai
-00017f00: 7469 6e67 2229 3a20 7472 616e 7369 7469  ting"): transiti
-00017f10: 6f6e 5f72 656c 6561 7365 645f 7761 6974  on_released_wait
-00017f20: 696e 672c 0a20 2020 2020 2020 2028 2277  ing,.        ("w
-00017f30: 6169 7469 6e67 222c 2022 7265 6c65 6173  aiting", "releas
-00017f40: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
-00017f50: 5f77 6169 7469 6e67 5f72 656c 6561 7365  _waiting_release
-00017f60: 642c 0a20 2020 2020 2020 2028 2277 6169  d,.        ("wai
-00017f70: 7469 6e67 222c 2022 7072 6f63 6573 7369  ting", "processi
-00017f80: 6e67 2229 3a20 7472 616e 7369 7469 6f6e  ng"): transition
-00017f90: 5f77 6169 7469 6e67 5f70 726f 6365 7373  _waiting_process
-00017fa0: 696e 672c 0a20 2020 2020 2020 2028 2277  ing,.        ("w
-00017fb0: 6169 7469 6e67 222c 2022 6e6f 2d77 6f72  aiting", "no-wor
-00017fc0: 6b65 7222 293a 2074 7261 6e73 6974 696f  ker"): transitio
-00017fd0: 6e5f 7761 6974 696e 675f 6e6f 5f77 6f72  n_waiting_no_wor
-00017fe0: 6b65 722c 0a20 2020 2020 2020 2028 2277  ker,.        ("w
-00017ff0: 6169 7469 6e67 222c 2022 7175 6575 6564  aiting", "queued
-00018000: 2229 3a20 7472 616e 7369 7469 6f6e 5f77  "): transition_w
-00018010: 6169 7469 6e67 5f71 7565 7565 642c 0a20  aiting_queued,. 
-00018020: 2020 2020 2020 2028 2277 6169 7469 6e67         ("waiting
-00018030: 222c 2022 6d65 6d6f 7279 2229 3a20 7472  ", "memory"): tr
-00018040: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
-00018050: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
-00018060: 2028 2271 7565 7565 6422 2c20 2272 656c   ("queued", "rel
-00018070: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
-00018080: 696f 6e5f 7175 6575 6564 5f72 656c 6561  ion_queued_relea
-00018090: 7365 642c 0a20 2020 2020 2020 2028 2271  sed,.        ("q
-000180a0: 7565 7565 6422 2c20 2270 726f 6365 7373  ueued", "process
-000180b0: 696e 6722 293a 2074 7261 6e73 6974 696f  ing"): transitio
-000180c0: 6e5f 7175 6575 6564 5f70 726f 6365 7373  n_queued_process
-000180d0: 696e 672c 0a20 2020 2020 2020 2028 2270  ing,.        ("p
-000180e0: 726f 6365 7373 696e 6722 2c20 2272 656c  rocessing", "rel
-000180f0: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
-00018100: 696f 6e5f 7072 6f63 6573 7369 6e67 5f72  ion_processing_r
-00018110: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-00018120: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
-00018130: 226d 656d 6f72 7922 293a 2074 7261 6e73  "memory"): trans
-00018140: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
-00018150: 5f6d 656d 6f72 792c 0a20 2020 2020 2020  _memory,.       
-00018160: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
-00018170: 2265 7272 6564 2229 3a20 7472 616e 7369  "erred"): transi
-00018180: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
-00018190: 6572 7265 642c 0a20 2020 2020 2020 2028  erred,.        (
-000181a0: 226e 6f2d 776f 726b 6572 222c 2022 7265  "no-worker", "re
-000181b0: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
-000181c0: 7469 6f6e 5f6e 6f5f 776f 726b 6572 5f72  tion_no_worker_r
-000181d0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-000181e0: 2028 226e 6f2d 776f 726b 6572 222c 2022   ("no-worker", "
-000181f0: 7072 6f63 6573 7369 6e67 2229 3a20 7472  processing"): tr
-00018200: 616e 7369 7469 6f6e 5f6e 6f5f 776f 726b  ansition_no_work
-00018210: 6572 5f70 726f 6365 7373 696e 672c 0a20  er_processing,. 
-00018220: 2020 2020 2020 2028 2272 656c 6561 7365         ("release
-00018230: 6422 2c20 2266 6f72 676f 7474 656e 2229  d", "forgotten")
-00018240: 3a20 7472 616e 7369 7469 6f6e 5f72 656c  : transition_rel
-00018250: 6561 7365 645f 666f 7267 6f74 7465 6e2c  eased_forgotten,
-00018260: 0a20 2020 2020 2020 2028 226d 656d 6f72  .        ("memor
-00018270: 7922 2c20 2266 6f72 676f 7474 656e 2229  y", "forgotten")
-00018280: 3a20 7472 616e 7369 7469 6f6e 5f6d 656d  : transition_mem
-00018290: 6f72 795f 666f 7267 6f74 7465 6e2c 0a20  ory_forgotten,. 
-000182a0: 2020 2020 2020 2028 2265 7272 6564 222c         ("erred",
-000182b0: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
-000182c0: 616e 7369 7469 6f6e 5f65 7272 6564 5f72  ansition_erred_r
-000182d0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-000182e0: 2028 226d 656d 6f72 7922 2c20 2272 656c   ("memory", "rel
-000182f0: 6561 7365 6422 293a 2074 7261 6e73 6974  eased"): transit
-00018300: 696f 6e5f 6d65 6d6f 7279 5f72 656c 6561  ion_memory_relea
-00018310: 7365 642c 0a20 2020 2020 2020 2028 2272  sed,.        ("r
-00018320: 656c 6561 7365 6422 2c20 2265 7272 6564  eleased", "erred
-00018330: 2229 3a20 7472 616e 7369 7469 6f6e 5f72  "): transition_r
-00018340: 656c 6561 7365 645f 6572 7265 642c 0a20  eleased_erred,. 
-00018350: 2020 207d 0a0a 2020 2020 6465 6620 7374     }..    def st
-00018360: 6f72 7928 7365 6c66 2c20 2a6b 6579 735f  ory(self, *keys_
-00018370: 6f72 5f74 6173 6b73 5f6f 725f 7374 696d  or_tasks_or_stim
-00018380: 756c 693a 2073 7472 207c 2054 6173 6b53  uli: str | TaskS
-00018390: 7461 7465 2920 2d3e 206c 6973 745b 5472  tate) -> list[Tr
-000183a0: 616e 7369 7469 6f6e 5d3a 0a20 2020 2020  ansition]:.     
-000183b0: 2020 2022 2222 4765 7420 616c 6c20 7472     """Get all tr
-000183c0: 616e 7369 7469 6f6e 7320 7468 6174 2074  ansitions that t
-000183d0: 6f75 6368 206f 6e65 206f 6620 7468 6520  ouch one of the 
-000183e0: 696e 7075 7420 6b65 7973 206f 7220 7374  input keys or st
-000183f0: 696d 756c 7573 5f69 6427 7322 2222 0a20  imulus_id's""". 
-00018400: 2020 2020 2020 206b 6579 735f 6f72 5f73         keys_or_s
-00018410: 7469 6d75 6c69 203d 207b 0a20 2020 2020  timuli = {.     
-00018420: 2020 2020 2020 206b 6579 2e6b 6579 2069         key.key i
-00018430: 6620 6973 696e 7374 616e 6365 286b 6579  f isinstance(key
-00018440: 2c20 5461 736b 5374 6174 6529 2065 6c73  , TaskState) els
-00018450: 6520 6b65 790a 2020 2020 2020 2020 2020  e key.          
-00018460: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00018470: 735f 6f72 5f74 6173 6b73 5f6f 725f 7374  s_or_tasks_or_st
-00018480: 696d 756c 690a 2020 2020 2020 2020 7d0a  imuli.        }.
-00018490: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000184a0: 6368 6564 756c 6572 5f73 746f 7279 286b  cheduler_story(k
-000184b0: 6579 735f 6f72 5f73 7469 6d75 6c69 2c20  eys_or_stimuli, 
-000184c0: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
-000184d0: 6c6f 6729 0a0a 2020 2020 2323 2323 2323  log)..    ######
-000184e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000184f0: 2323 2323 2323 2323 0a20 2020 2023 2041  ########.    # A
-00018500: 7373 6967 6e69 6e67 2054 6173 6b73 2074  ssigning Tasks t
-00018510: 6f20 576f 726b 6572 7320 230a 2020 2020  o Workers #.    
-00018520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018530: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-00018540: 2020 2020 6465 6620 6973 5f72 6f6f 7469      def is_rooti
-00018550: 7368 2873 656c 662c 2074 733a 2054 6173  sh(self, ts: Tas
-00018560: 6b53 7461 7465 2920 2d3e 2062 6f6f 6c3a  kState) -> bool:
-00018570: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00018580: 2020 2020 2057 6865 7468 6572 2060 6074       Whether ``t
-00018590: 7360 6020 6973 2061 2072 6f6f 7420 6f72  s`` is a root or
-000185a0: 2072 6f6f 742d 6c69 6b65 2074 6173 6b2e   root-like task.
-000185b0: 0a0a 2020 2020 2020 2020 526f 6f74 2d69  ..        Root-i
-000185c0: 7368 2074 6173 6b73 2061 7265 2070 6172  sh tasks are par
-000185d0: 7420 6f66 2061 2067 726f 7570 2074 6861  t of a group tha
-000185e0: 7427 7320 6d75 6368 206c 6172 6765 7220  t's much larger 
-000185f0: 7468 616e 2074 6865 2063 6c75 7374 6572  than the cluster
-00018600: 2c0a 2020 2020 2020 2020 616e 6420 6861  ,.        and ha
-00018610: 7665 2066 6577 206f 7220 6e6f 2064 6570  ve few or no dep
-00018620: 656e 6465 6e63 6965 732e 0a20 2020 2020  endencies..     
-00018630: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00018640: 6620 7473 2e72 6573 6f75 7263 655f 7265  f ts.resource_re
-00018650: 7374 7269 6374 696f 6e73 206f 7220 7473  strictions or ts
-00018660: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
-00018670: 696f 6e73 206f 7220 7473 2e68 6f73 745f  ions or ts.host_
-00018680: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
-00018690: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000186a0: 2046 616c 7365 0a20 2020 2020 2020 2074   False.        t
-000186b0: 6720 3d20 7473 2e67 726f 7570 0a20 2020  g = ts.group.   
-000186c0: 2020 2020 2023 2054 4f44 4f20 7368 6f72       # TODO shor
-000186d0: 742d 6369 7263 7569 7420 746f 2054 7275  t-circuit to Tru
-000186e0: 6520 6966 2060 6e6f 7420 7473 2e64 6570  e if `not ts.dep
-000186f0: 656e 6465 6e63 6965 7360 3f0a 2020 2020  endencies`?.    
-00018700: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
-00018710: 2020 2020 2020 2020 206c 656e 2874 6729           len(tg)
-00018720: 203e 2073 656c 662e 746f 7461 6c5f 6e74   > self.total_nt
-00018730: 6872 6561 6473 202a 2032 0a20 2020 2020  hreads * 2.     
-00018740: 2020 2020 2020 2061 6e64 206c 656e 2874         and len(t
-00018750: 672e 6465 7065 6e64 656e 6369 6573 2920  g.dependencies) 
-00018760: 3c20 350a 2020 2020 2020 2020 2020 2020  < 5.            
-00018770: 616e 6420 7375 6d28 6d61 7028 6c65 6e2c  and sum(map(len,
-00018780: 2074 672e 6465 7065 6e64 656e 6369 6573   tg.dependencies
-00018790: 2929 203c 2035 0a20 2020 2020 2020 2029  )) < 5.        )
-000187a0: 0a0a 2020 2020 6465 6620 6368 6563 6b5f  ..    def check_
-000187b0: 6964 6c65 5f73 6174 7572 6174 6564 2873  idle_saturated(s
-000187c0: 656c 662c 2077 733a 2057 6f72 6b65 7253  elf, ws: WorkerS
-000187d0: 7461 7465 2c20 6f63 633a 2066 6c6f 6174  tate, occ: float
-000187e0: 203d 202d 312e 3029 202d 3e20 4e6f 6e65   = -1.0) -> None
-000187f0: 3a0a 2020 2020 2020 2020 2222 2255 7064  :.        """Upd
-00018800: 6174 6520 7468 6520 7374 6174 7573 206f  ate the status o
-00018810: 6620 7468 6520 6964 6c65 2061 6e64 2073  f the idle and s
-00018820: 6174 7572 6174 6564 2073 7461 7465 0a0a  aturated state..
-00018830: 2020 2020 2020 2020 5468 6520 7363 6865          The sche
-00018840: 6475 6c65 7220 6b65 6570 7320 7472 6163  duler keeps trac
-00018850: 6b20 6f66 2077 6f72 6b65 7273 2074 6861  k of workers tha
-00018860: 7420 6172 6520 2e2e 0a0a 2020 2020 2020  t are ....      
-00018870: 2020 2d20 2053 6174 7572 6174 6564 3a20    -  Saturated: 
-00018880: 6861 7665 2065 6e6f 7567 6820 776f 726b  have enough work
-00018890: 2074 6f20 7374 6179 2062 7573 790a 2020   to stay busy.  
-000188a0: 2020 2020 2020 2d20 2049 646c 653a 2064        -  Idle: d
-000188b0: 6f20 6e6f 7420 6861 7665 2065 6e6f 7567  o not have enoug
-000188c0: 6820 776f 726b 2074 6f20 7374 6179 2062  h work to stay b
-000188d0: 7573 790a 0a20 2020 2020 2020 2054 6865  usy..        The
-000188e0: 7920 6172 6520 636f 6e73 6964 6572 6564  y are considered
-000188f0: 2073 6174 7572 6174 6564 2069 6620 7468   saturated if th
-00018900: 6579 2062 6f74 6820 6861 7665 2065 6e6f  ey both have eno
-00018910: 7567 6820 7461 736b 7320 746f 206f 6363  ugh tasks to occ
-00018920: 7570 790a 2020 2020 2020 2020 616c 6c20  upy.        all 
-00018930: 6f66 2074 6865 6972 2074 6872 6561 6473  of their threads
-00018940: 2c20 616e 6420 6966 2074 6865 2065 7870  , and if the exp
-00018950: 6563 7465 6420 7275 6e74 696d 6520 6f66  ected runtime of
-00018960: 2074 686f 7365 2074 6173 6b73 2069 730a   those tasks is.
-00018970: 2020 2020 2020 2020 6c61 7267 6520 656e          large en
-00018980: 6f75 6768 2e0a 0a20 2020 2020 2020 2049  ough...        I
-00018990: 6620 6060 6469 7374 7269 6275 7465 642e  f ``distributed.
-000189a0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-000189b0: 2d73 6174 7572 6174 696f 6e60 6020 6973  -saturation`` is
-000189c0: 206e 6f74 2060 6069 6e66 6060 0a20 2020   not ``inf``.   
-000189d0: 2020 2020 2028 7363 6865 6475 6c65 722d       (scheduler-
-000189e0: 7369 6465 2071 7565 7569 6e67 2069 7320  side queuing is 
-000189f0: 656e 6162 6c65 6429 2c20 7468 6579 2061  enabled), they a
-00018a00: 7265 2063 6f6e 7369 6465 7265 6420 6964  re considered id
-00018a10: 6c65 0a20 2020 2020 2020 2069 6620 7468  le.        if th
-00018a20: 6579 2068 6176 6520 6665 7765 7220 7461  ey have fewer ta
-00018a30: 736b 7320 7072 6f63 6573 7369 6e67 2074  sks processing t
-00018a40: 6861 6e20 7468 6520 6060 776f 726b 6572  han the ``worker
-00018a50: 2d73 6174 7572 6174 696f 6e60 600a 2020  -saturation``.  
-00018a60: 2020 2020 2020 7468 7265 7368 6f6c 6420        threshold 
-00018a70: 6469 6374 6174 6573 2e0a 0a20 2020 2020  dictates...     
-00018a80: 2020 204f 7468 6572 7769 7365 2c20 7468     Otherwise, th
-00018a90: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
-00018aa0: 6420 6964 6c65 2069 6620 7468 6579 2068  d idle if they h
-00018ab0: 6176 6520 6665 7765 7220 7461 736b 7320  ave fewer tasks 
-00018ac0: 7072 6f63 6573 7369 6e67 0a20 2020 2020  processing.     
-00018ad0: 2020 2074 6861 6e20 7468 7265 6164 732c     than threads,
-00018ae0: 206f 7220 6966 2074 6865 6972 2074 6173   or if their tas
-00018af0: 6b73 2720 746f 7461 6c20 6578 7065 6374  ks' total expect
-00018b00: 6564 2072 756e 7469 6d65 2069 7320 6c65  ed runtime is le
-00018b10: 7373 2074 6861 6e20 6861 6c66 0a20 2020  ss than half.   
-00018b20: 2020 2020 2074 6865 2065 7870 6563 7465       the expecte
-00018b30: 6420 7275 6e74 696d 6520 6f66 2074 6865  d runtime of the
-00018b40: 2073 616d 6520 6e75 6d62 6572 206f 6620   same number of 
-00018b50: 6176 6572 6167 6520 7461 736b 732e 0a0a  average tasks...
-00018b60: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
-00018b70: 7573 6566 756c 2066 6f72 206c 6f61 6420  useful for load 
-00018b80: 6261 6c61 6e63 696e 6720 616e 6420 6164  balancing and ad
-00018b90: 6170 7469 7669 7479 2e0a 2020 2020 2020  aptivity..      
-00018ba0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00018bb0: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
-00018bc0: 6561 6473 203d 3d20 3020 6f72 2077 732e  eads == 0 or ws.
-00018bd0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-00018be0: 2e63 6c6f 7365 643a 0a20 2020 2020 2020  .closed:.       
-00018bf0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00018c00: 2020 2020 6966 206f 6363 203c 2030 3a0a      if occ < 0:.
-00018c10: 2020 2020 2020 2020 2020 2020 6f63 6320              occ 
-00018c20: 3d20 7773 2e6f 6363 7570 616e 6379 0a0a  = ws.occupancy..
-00018c30: 2020 2020 2020 2020 7020 3d20 6c65 6e28          p = len(
-00018c40: 7773 2e70 726f 6365 7373 696e 6729 0a0a  ws.processing)..
-00018c50: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
-00018c60: 7572 6174 6564 2e64 6973 6361 7264 2877  urated.discard(w
-00018c70: 7329 0a20 2020 2020 2020 2069 6620 7773  s).        if ws
-00018c80: 2e73 7461 7475 7320 213d 2053 7461 7475  .status != Statu
-00018c90: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-00018ca0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00018cb0: 2e70 6f70 2877 732e 6164 6472 6573 732c  .pop(ws.address,
-00018cc0: 204e 6f6e 6529 0a20 2020 2020 2020 2065   None).        e
-00018cd0: 6c69 6620 7365 6c66 2e69 735f 756e 6f63  lif self.is_unoc
-00018ce0: 6375 7069 6564 2877 732c 206f 6363 2c20  cupied(ws, occ, 
-00018cf0: 7029 3a0a 2020 2020 2020 2020 2020 2020  p):.            
-00018d00: 7365 6c66 2e69 646c 655b 7773 2e61 6464  self.idle[ws.add
-00018d10: 7265 7373 5d20 3d20 7773 0a20 2020 2020  ress] = ws.     
-00018d20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018d30: 2020 2020 2073 656c 662e 6964 6c65 2e70       self.idle.p
-00018d40: 6f70 2877 732e 6164 6472 6573 732c 204e  op(ws.address, N
-00018d50: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-00018d60: 206e 6320 3d20 7773 2e6e 7468 7265 6164   nc = ws.nthread
-00018d70: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-00018d80: 2070 203e 206e 633a 0a20 2020 2020 2020   p > nc:.       
-00018d90: 2020 2020 2020 2020 2070 656e 6469 6e67           pending
-00018da0: 203d 206f 6363 202a 2028 7020 2d20 6e63   = occ * (p - nc
-00018db0: 2920 2f20 2870 202a 206e 6329 0a20 2020  ) / (p * nc).   
-00018dc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018dd0: 302e 3420 3c20 7065 6e64 696e 6720 3e20  0.4 < pending > 
-00018de0: 312e 3920 2a20 2873 656c 662e 746f 7461  1.9 * (self.tota
-00018df0: 6c5f 6f63 6375 7061 6e63 7920 2f20 7365  l_occupancy / se
-00018e00: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
-00018e10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00018e20: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
-00018e30: 7572 6174 6564 2e61 6464 2877 7329 0a0a  urated.add(ws)..
-00018e40: 2020 2020 2020 2020 6966 206e 6f74 205f          if not _
-00018e50: 776f 726b 6572 5f66 756c 6c28 7773 2c20  worker_full(ws, 
-00018e60: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-00018e70: 5241 5449 4f4e 2920 616e 6420 7773 2e73  RATION) and ws.s
-00018e80: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-00018e90: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00018ea0: 2020 2020 2073 656c 662e 6964 6c65 5f74       self.idle_t
-00018eb0: 6173 6b5f 636f 756e 742e 6164 6428 7773  ask_count.add(ws
-00018ec0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00018ed0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018ee0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-00018ef0: 2e64 6973 6361 7264 2877 7329 0a0a 2020  .discard(ws)..  
-00018f00: 2020 6465 6620 6973 5f75 6e6f 6363 7570    def is_unoccup
-00018f10: 6965 6428 0a20 2020 2020 2020 2073 656c  ied(.        sel
-00018f20: 662c 2077 733a 2057 6f72 6b65 7253 7461  f, ws: WorkerSta
-00018f30: 7465 2c20 6f63 6375 7061 6e63 793a 2066  te, occupancy: f
-00018f40: 6c6f 6174 2c20 6e70 726f 6365 7373 696e  loat, nprocessin
-00018f50: 673a 2069 6e74 0a20 2020 2029 202d 3e20  g: int.    ) -> 
-00018f60: 626f 6f6c 3a0a 2020 2020 2020 2020 6e74  bool:.        nt
-00018f70: 6872 6561 6473 203d 2077 732e 6e74 6872  hreads = ws.nthr
-00018f80: 6561 6473 0a20 2020 2020 2020 2072 6574  eads.        ret
-00018f90: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-00018fa0: 2020 6e70 726f 6365 7373 696e 6720 3c20    nprocessing < 
-00018fb0: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-00018fc0: 2020 2020 206f 7220 6f63 6375 7061 6e63       or occupanc
-00018fd0: 7920 3c20 6e74 6872 6561 6473 202a 2028  y < nthreads * (
-00018fe0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
-00018ff0: 616e 6379 202f 2073 656c 662e 746f 7461  ancy / self.tota
-00019000: 6c5f 6e74 6872 6561 6473 2920 2f20 320a  l_nthreads) / 2.
-00019010: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00019020: 6566 2067 6574 5f63 6f6d 6d5f 636f 7374  ef get_comm_cost
-00019030: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00019040: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
-00019050: 5374 6174 6529 202d 3e20 666c 6f61 743a  State) -> float:
-00019060: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00019070: 2020 2020 2047 6574 2074 6865 2065 7374       Get the est
-00019080: 696d 6174 6564 2063 6f6d 6d75 6e69 6361  imated communica
-00019090: 7469 6f6e 2063 6f73 7420 2869 6e20 732e  tion cost (in s.
-000190a0: 2920 746f 2063 6f6d 7075 7465 2074 6865  ) to compute the
-000190b0: 2074 6173 6b0a 2020 2020 2020 2020 6f6e   task.        on
-000190c0: 2074 6865 2067 6976 656e 2077 6f72 6b65   the given worke
-000190d0: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
-000190e0: 2020 2020 2020 2069 6620 3130 202a 206c         if 10 * l
-000190f0: 656e 2874 732e 6465 7065 6e64 656e 6369  en(ts.dependenci
-00019100: 6573 2920 3c20 6c65 6e28 7773 2e68 6173  es) < len(ws.has
-00019110: 5f77 6861 7429 3a0a 2020 2020 2020 2020  _what):.        
-00019120: 2020 2020 2320 496e 2074 6865 2063 6f6d      # In the com
-00019130: 6d6f 6e20 6361 7365 2077 6865 7265 2074  mon case where t
-00019140: 6865 206e 756d 6265 7220 6f66 2064 6570  he number of dep
-00019150: 656e 6465 6e63 6965 7320 6973 0a20 2020  endencies is.   
-00019160: 2020 2020 2020 2020 2023 206d 7563 6820           # much 
-00019170: 6c65 7373 2074 6861 6e20 7468 6520 6e75  less than the nu
-00019180: 6d62 6572 206f 6620 7461 736b 7320 7468  mber of tasks th
-00019190: 6174 2077 6520 6861 7665 2c0a 2020 2020  at we have,.    
-000191a0: 2020 2020 2020 2020 2320 636f 6e73 7472          # constr
-000191b0: 7563 7420 7468 6520 7365 7420 6f66 2064  uct the set of d
-000191c0: 6570 7320 7468 6174 2072 6571 7569 7265  eps that require
-000191d0: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2069   communication i
-000191e0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
-000191f0: 4f28 6c65 6e28 6465 7065 6e64 656e 6369  O(len(dependenci
-00019200: 6573 2929 2072 6174 6865 7220 7468 616e  es)) rather than
-00019210: 204f 286c 656e 2868 6173 5f77 6861 7429   O(len(has_what)
-00019220: 2920 7469 6d65 2e0a 2020 2020 2020 2020  ) time..        
-00019230: 2020 2020 2320 4661 6374 6f72 206f 6620      # Factor of 
-00019240: 3130 2069 7320 6120 6775 6573 7320 6174  10 is a guess at
-00019250: 2074 6865 206f 7665 7268 6561 6420 6f66   the overhead of
-00019260: 2065 7870 6c69 6369 740a 2020 2020 2020   explicit.      
-00019270: 2020 2020 2020 2320 6974 6572 6174 696f        # iteratio
-00019280: 6e20 6173 206f 7070 6f73 6564 2074 6f20  n as opposed to 
-00019290: 6a75 7374 2063 616c 6c69 6e67 2073 6574  just calling set
-000192a0: 2e64 6966 6665 7265 6e63 650a 2020 2020  .difference.    
-000192b0: 2020 2020 2020 2020 6465 7073 203d 207b          deps = {
-000192c0: 6465 7020 666f 7220 6465 7020 696e 2074  dep for dep in t
-000192d0: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
-000192e0: 6620 6465 7020 6e6f 7420 696e 2077 732e  f dep not in ws.
-000192f0: 6861 735f 7768 6174 7d0a 2020 2020 2020  has_what}.      
-00019300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00019310: 2020 2020 6465 7073 203d 2074 732e 6465      deps = ts.de
-00019320: 7065 6e64 656e 6369 6573 2e64 6966 6665  pendencies.diffe
-00019330: 7265 6e63 6528 7773 2e68 6173 5f77 6861  rence(ws.has_wha
-00019340: 7429 0a20 2020 2020 2020 206e 6279 7465  t).        nbyte
-00019350: 7320 3d20 7375 6d28 6474 732e 6e62 7974  s = sum(dts.nbyt
-00019360: 6573 2066 6f72 2064 7473 2069 6e20 6465  es for dts in de
-00019370: 7073 290a 2020 2020 2020 2020 7265 7475  ps).        retu
-00019380: 726e 206e 6279 7465 7320 2f20 7365 6c66  rn nbytes / self
-00019390: 2e62 616e 6477 6964 7468 0a0a 2020 2020  .bandwidth..    
-000193a0: 6465 6620 6765 745f 7461 736b 5f64 7572  def get_task_dur
-000193b0: 6174 696f 6e28 7365 6c66 2c20 7473 3a20  ation(self, ts: 
-000193c0: 5461 736b 5374 6174 6529 202d 3e20 666c  TaskState) -> fl
-000193d0: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
-000193e0: 4765 7420 7468 6520 6573 7469 6d61 7465  Get the estimate
-000193f0: 6420 636f 6d70 7574 6174 696f 6e20 636f  d computation co
-00019400: 7374 206f 6620 7468 6520 6769 7665 6e20  st of the given 
-00019410: 7461 736b 2028 6e6f 7420 696e 636c 7564  task (not includ
-00019420: 696e 670a 2020 2020 2020 2020 616e 7920  ing.        any 
-00019430: 636f 6d6d 756e 6963 6174 696f 6e20 636f  communication co
-00019440: 7374 292e 0a0a 2020 2020 2020 2020 4966  st)...        If
-00019450: 206e 6f20 6461 7461 2068 6173 2062 6565   no data has bee
-00019460: 6e20 6f62 7365 7276 6564 2c20 7661 6c75  n observed, valu
-00019470: 6520 6f66 0a20 2020 2020 2020 2060 6469  e of.        `di
-00019480: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-00019490: 6c65 722e 6465 6661 756c 742d 7461 736b  ler.default-task
-000194a0: 2d64 7572 6174 696f 6e73 6020 6172 6520  -durations` are 
-000194b0: 7573 6564 2e20 4966 206e 6f6e 6520 6973  used. If none is
-000194c0: 2073 6574 0a20 2020 2020 2020 2066 6f72   set.        for
-000194d0: 2074 6869 7320 7461 736b 2c20 6064 6973   this task, `dis
-000194e0: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-000194f0: 6572 2e75 6e6b 6e6f 776e 2d74 6173 6b2d  er.unknown-task-
-00019500: 6475 7261 7469 6f6e 6020 6973 2075 7365  duration` is use
-00019510: 640a 2020 2020 2020 2020 696e 7374 6561  d.        instea
-00019520: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-00019530: 2020 2020 2020 2064 7572 6174 696f 6e3a         duration:
-00019540: 2066 6c6f 6174 203d 2074 732e 7072 6566   float = ts.pref
-00019550: 6978 2e64 7572 6174 696f 6e5f 6176 6572  ix.duration_aver
-00019560: 6167 650a 2020 2020 2020 2020 6966 2064  age.        if d
-00019570: 7572 6174 696f 6e20 3e3d 2030 3a0a 2020  uration >= 0:.  
-00019580: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00019590: 2064 7572 6174 696f 6e0a 0a20 2020 2020   duration..     
-000195a0: 2020 2073 203d 2073 656c 662e 756e 6b6e     s = self.unkn
-000195b0: 6f77 6e5f 6475 7261 7469 6f6e 732e 6765  own_durations.ge
-000195c0: 7428 7473 2e70 7265 6669 782e 6e61 6d65  t(ts.prefix.name
-000195d0: 290a 2020 2020 2020 2020 6966 2073 2069  ).        if s i
-000195e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000195f0: 2020 2020 7365 6c66 2e75 6e6b 6e6f 776e      self.unknown
-00019600: 5f64 7572 6174 696f 6e73 5b74 732e 7072  _durations[ts.pr
-00019610: 6566 6978 2e6e 616d 655d 203d 2073 203d  efix.name] = s =
-00019620: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-00019630: 2e61 6464 2874 7329 0a20 2020 2020 2020  .add(ts).       
-00019640: 2072 6574 7572 6e20 7365 6c66 2e55 4e4b   return self.UNK
-00019650: 4e4f 574e 5f54 4153 4b5f 4455 5241 5449  NOWN_TASK_DURATI
-00019660: 4f4e 0a0a 2020 2020 6465 6620 7661 6c69  ON..    def vali
-00019670: 645f 776f 726b 6572 7328 7365 6c66 2c20  d_workers(self, 
-00019680: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-00019690: 3e20 7365 745b 576f 726b 6572 5374 6174  > set[WorkerStat
-000196a0: 655d 207c 204e 6f6e 653a 0a20 2020 2020  e] | None:.     
-000196b0: 2020 2022 2222 5265 7475 726e 2073 6574     """Return set
-000196c0: 206f 6620 6375 7272 656e 746c 7920 7661   of currently va
-000196d0: 6c69 6420 776f 726b 6572 7320 666f 7220  lid workers for 
-000196e0: 6b65 790a 0a20 2020 2020 2020 2049 6620  key..        If 
-000196f0: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
-00019700: 7661 6c69 6420 7468 656e 2074 6869 7320  valid then this 
-00019710: 7265 7475 726e 7320 6060 4e6f 6e65 6060  returns ``None``
-00019720: 2c20 696e 2077 6869 6368 2063 6173 650a  , in which case.
-00019730: 2020 2020 2020 2020 616e 7920 2a72 756e          any *run
-00019740: 6e69 6e67 2a20 776f 726b 6572 2063 616e  ning* worker can
-00019750: 2062 6520 7573 6564 2e0a 2020 2020 2020   be used..      
-00019760: 2020 4f74 6865 7277 6973 652c 2074 6865    Otherwise, the
-00019770: 2073 7562 7365 7420 6f66 2072 756e 6e69   subset of runni
-00019780: 6e67 2077 6f72 6b65 7273 2076 616c 6964  ng workers valid
-00019790: 2066 6f72 2074 6869 7320 7461 736b 0a20   for this task. 
-000197a0: 2020 2020 2020 2069 7320 7265 7475 726e         is return
-000197b0: 6564 2e0a 2020 2020 2020 2020 5468 6973  ed..        This
-000197c0: 2063 6865 636b 7320 7472 6163 6b73 2074   checks tracks t
-000197d0: 6865 2066 6f6c 6c6f 7769 6e67 2073 7461  he following sta
-000197e0: 7465 3a0a 0a20 2020 2020 2020 202a 2020  te:..        *  
-000197f0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-00019800: 6f6e 730a 2020 2020 2020 2020 2a20 2068  ons.        *  h
-00019810: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-00019820: 0a20 2020 2020 2020 202a 2020 7265 736f  .        *  reso
-00019830: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
-00019840: 730a 2020 2020 2020 2020 2222 220a 2020  s.        """.  
-00019850: 2020 2020 2020 733a 2073 6574 5b73 7472        s: set[str
-00019860: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
-00019870: 0a20 2020 2020 2020 2069 6620 7473 2e77  .        if ts.w
-00019880: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
-00019890: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000198a0: 7320 3d20 7b61 6464 7220 666f 7220 6164  s = {addr for ad
-000198b0: 6472 2069 6e20 7473 2e77 6f72 6b65 725f  dr in ts.worker_
-000198c0: 7265 7374 7269 6374 696f 6e73 2069 6620  restrictions if 
-000198d0: 6164 6472 2069 6e20 7365 6c66 2e77 6f72  addr in self.wor
-000198e0: 6b65 7273 7d0a 0a20 2020 2020 2020 2069  kers}..        i
-000198f0: 6620 7473 2e68 6f73 745f 7265 7374 7269  f ts.host_restri
-00019900: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
-00019910: 2020 2020 2320 5265 736f 6c76 6520 7468      # Resolve th
-00019920: 6520 616c 6961 7320 6865 7265 2072 6174  e alias here rat
-00019930: 6865 7220 7468 616e 2065 6172 6c79 2c20  her than early, 
-00019940: 666f 7220 7468 6520 776f 726b 6572 0a20  for the worker. 
-00019950: 2020 2020 2020 2020 2020 2023 206d 6179             # may
-00019960: 206e 6f74 2062 6520 636f 6e6e 6563 7465   not be connecte
-00019970: 6420 7768 656e 2068 6f73 745f 7265 7374  d when host_rest
-00019980: 7269 6374 696f 6e73 2069 7320 706f 7075  rictions is popu
-00019990: 6c61 7465 640a 2020 2020 2020 2020 2020  lated.          
-000199a0: 2020 6872 203d 205b 7365 6c66 2e63 6f65    hr = [self.coe
-000199b0: 7263 655f 686f 7374 6e61 6d65 2868 2920  rce_hostname(h) 
-000199c0: 666f 7220 6820 696e 2074 732e 686f 7374  for h in ts.host
-000199d0: 5f72 6573 7472 6963 7469 6f6e 735d 0a20  _restrictions]. 
-000199e0: 2020 2020 2020 2020 2020 2023 2058 5858             # XXX
-000199f0: 206e 6565 6420 486f 7374 5374 6174 653f   need HostState?
-00019a00: 0a20 2020 2020 2020 2020 2020 2073 6c20  .            sl 
-00019a10: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00019a20: 2066 6f72 2068 2069 6e20 6872 3a0a 2020   for h in hr:.  
-00019a30: 2020 2020 2020 2020 2020 2020 2020 6468                dh
-00019a40: 203d 2073 656c 662e 686f 7374 5f69 6e66   = self.host_inf
-00019a50: 6f2e 6765 7428 6829 0a20 2020 2020 2020  o.get(h).       
-00019a60: 2020 2020 2020 2020 2069 6620 6468 2069           if dh i
-00019a70: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a90: 736c 2e61 7070 656e 6428 6468 5b22 6164  sl.append(dh["ad
-00019aa0: 6472 6573 7365 7322 5d29 0a0a 2020 2020  dresses"])..    
-00019ab0: 2020 2020 2020 2020 7373 203d 2073 6574          ss = set
-00019ac0: 2e75 6e69 6f6e 282a 736c 2920 6966 2073  .union(*sl) if s
-00019ad0: 6c20 656c 7365 2073 6574 2829 0a20 2020  l else set().   
-00019ae0: 2020 2020 2020 2020 2069 6620 7320 6973           if s is
-00019af0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00019b00: 2020 2020 2020 2073 203d 2073 730a 2020         s = ss.  
-00019b10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b30: 7320 7c3d 2073 730a 0a20 2020 2020 2020  s |= ss..       
-00019b40: 2069 6620 7473 2e72 6573 6f75 7263 655f   if ts.resource_
-00019b50: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
-00019b60: 2020 2020 2020 2020 2020 6477 203d 207b            dw = {
-00019b70: 7d0a 2020 2020 2020 2020 2020 2020 666f  }.            fo
-00019b80: 7220 7265 736f 7572 6365 2c20 7265 7175  r resource, requ
-00019b90: 6972 6564 2069 6e20 7473 2e72 6573 6f75  ired in ts.resou
-00019ba0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-00019bb0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00019bc0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
-00019bd0: 656c 662e 7265 736f 7572 6365 732e 6765  elf.resources.ge
-00019be0: 7428 7265 736f 7572 6365 290a 2020 2020  t(resource).    
-00019bf0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00019c00: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-00019c10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019c20: 656c 662e 7265 736f 7572 6365 735b 7265  elf.resources[re
-00019c30: 736f 7572 6365 5d20 3d20 6472 203d 207b  source] = dr = {
-00019c40: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-00019c50: 2020 2073 7720 3d20 7365 7428 290a 2020     sw = set().  
-00019c60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00019c70: 7220 6164 6472 2c20 7375 7070 6c69 6564  r addr, supplied
-00019c80: 2069 6e20 6472 2e69 7465 6d73 2829 3a0a   in dr.items():.
-00019c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ca0: 2020 2020 6966 2073 7570 706c 6965 6420      if supplied 
-00019cb0: 3e3d 2072 6571 7569 7265 643a 0a20 2020  >= required:.   
-00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cd0: 2020 2020 2073 772e 6164 6428 6164 6472       sw.add(addr
-00019ce0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00019cf0: 2020 2064 775b 7265 736f 7572 6365 5d20     dw[resource] 
-00019d00: 3d20 7377 0a0a 2020 2020 2020 2020 2020  = sw..          
-00019d10: 2020 7777 203d 2073 6574 2e69 6e74 6572    ww = set.inter
-00019d20: 7365 6374 696f 6e28 2a64 772e 7661 6c75  section(*dw.valu
-00019d30: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-00019d40: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
-00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d60: 7320 3d20 7777 0a20 2020 2020 2020 2020  s = ww.         
-00019d70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00019d80: 2020 2020 2020 2020 2073 2026 3d20 7777           s &= ww
-00019d90: 0a0a 2020 2020 2020 2020 6966 2073 2069  ..        if s i
-00019da0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00019db0: 2020 2020 7265 7475 726e 204e 6f6e 6520      return None 
-00019dc0: 2023 2041 6c6c 2077 6f72 6b65 7273 2061   # All workers a
-00019dd0: 7265 2076 616c 6964 0a20 2020 2020 2020  re valid.       
-00019de0: 2069 6620 6e6f 7420 733a 0a20 2020 2020   if not s:.     
-00019df0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00019e00: 7428 2920 2023 204e 6f20 776f 726b 6572  t()  # No worker
-00019e10: 7320 6172 6520 7661 6c69 640a 0a20 2020  s are valid..   
-00019e20: 2020 2020 2023 2053 6f6d 6520 776f 726b       # Some work
-00019e30: 6572 7320 6172 6520 7661 6c69 640a 2020  ers are valid.  
-00019e40: 2020 2020 2020 735f 7773 203d 207b 7365        s_ws = {se
-00019e50: 6c66 2e77 6f72 6b65 7273 5b61 6464 725d  lf.workers[addr]
-00019e60: 2066 6f72 2061 6464 7220 696e 2073 7d0a   for addr in s}.
-00019e70: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00019e80: 656c 662e 7275 6e6e 696e 6729 203c 206c  elf.running) < l
-00019e90: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-00019ea0: 3a0a 2020 2020 2020 2020 2020 2020 735f  :.            s_
-00019eb0: 7773 2026 3d20 7365 6c66 2e72 756e 6e69  ws &= self.runni
-00019ec0: 6e67 0a20 2020 2020 2020 2072 6574 7572  ng.        retur
-00019ed0: 6e20 735f 7773 0a0a 2020 2020 6465 6620  n s_ws..    def 
-00019ee0: 6163 7175 6972 655f 7265 736f 7572 6365  acquire_resource
-00019ef0: 7328 7365 6c66 2c20 7473 3a20 5461 736b  s(self, ts: Task
-00019f00: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
-00019f10: 7253 7461 7465 2920 2d3e 204e 6f6e 653a  rState) -> None:
-00019f20: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
-00019f30: 7265 7175 6972 6564 2069 6e20 7473 2e72  required in ts.r
-00019f40: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-00019f50: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-00019f60: 2020 2020 2020 2020 2020 7773 2e75 7365            ws.use
-00019f70: 645f 7265 736f 7572 6365 735b 725d 202b  d_resources[r] +
-00019f80: 3d20 7265 7175 6972 6564 0a0a 2020 2020  = required..    
-00019f90: 6465 6620 7265 6c65 6173 655f 7265 736f  def release_reso
-00019fa0: 7572 6365 7328 7365 6c66 2c20 7473 3a20  urces(self, ts: 
-00019fb0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-00019fc0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
-00019fd0: 6f6e 653a 0a20 2020 2020 2020 2066 6f72  one:.        for
-00019fe0: 2072 2c20 7265 7175 6972 6564 2069 6e20   r, required in 
-00019ff0: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
-0001a000: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
-0001a010: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-0001a020: 2e75 7365 645f 7265 736f 7572 6365 735b  .used_resources[
-0001a030: 725d 202d 3d20 7265 7175 6972 6564 0a0a  r] -= required..
-0001a040: 2020 2020 6465 6620 636f 6572 6365 5f68      def coerce_h
-0001a050: 6f73 746e 616d 6528 7365 6c66 2c20 686f  ostname(self, ho
-0001a060: 7374 3a20 4861 7368 6162 6c65 2920 2d3e  st: Hashable) ->
-0001a070: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
-0001a080: 220a 2020 2020 2020 2020 436f 6572 6365  ".        Coerce
-0001a090: 2074 6865 2068 6f73 746e 616d 6520 6f66   the hostname of
-0001a0a0: 2061 2077 6f72 6b65 722e 0a20 2020 2020   a worker..     
-0001a0b0: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
-0001a0c0: 6c69 6173 203d 2073 656c 662e 616c 6961  lias = self.alia
-0001a0d0: 7365 732e 6765 7428 686f 7374 290a 2020  ses.get(host).  
-0001a0e0: 2020 2020 2020 6966 2061 6c69 6173 2069        if alias i
-0001a0f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0001a100: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
-0001a110: 662e 776f 726b 6572 735b 616c 6961 735d  f.workers[alias]
-0001a120: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a130: 7572 6e20 7773 2e68 6f73 740a 2020 2020  urn ws.host.    
-0001a140: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a150: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0001a160: 6e73 7461 6e63 6528 686f 7374 2c20 7374  nstance(host, st
-0001a170: 7229 0a20 2020 2020 2020 2020 2020 2072  r).            r
-0001a180: 6574 7572 6e20 686f 7374 0a0a 2020 2020  eturn host..    
-0001a190: 6465 6620 776f 726b 6572 5f6f 626a 6563  def worker_objec
-0001a1a0: 7469 7665 2873 656c 662c 2074 733a 2054  tive(self, ts: T
-0001a1b0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
-0001a1c0: 726b 6572 5374 6174 6529 202d 3e20 7475  rkerState) -> tu
-0001a1d0: 706c 653a 0a20 2020 2020 2020 2022 2222  ple:.        """
-0001a1e0: 4f62 6a65 6374 6976 6520 6675 6e63 7469  Objective functi
-0001a1f0: 6f6e 2074 6f20 6465 7465 726d 696e 6520  on to determine 
-0001a200: 7768 6963 6820 776f 726b 6572 2073 686f  which worker sho
-0001a210: 756c 6420 6765 7420 7468 6520 7461 736b  uld get the task
-0001a220: 0a0a 2020 2020 2020 2020 4d69 6e69 6d69  ..        Minimi
-0001a230: 7a65 2065 7870 6563 7465 6420 7374 6172  ze expected star
-0001a240: 7420 7469 6d65 2e20 2049 6620 6120 7469  t time.  If a ti
-0001a250: 6520 7468 656e 2062 7265 616b 2077 6974  e then break wit
-0001a260: 6820 6461 7461 2073 746f 7261 6765 2e0a  h data storage..
-0001a270: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001a280: 2020 2020 636f 6d6d 5f62 7974 6573 203d      comm_bytes =
-0001a290: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
-0001a2a0: 2020 6474 732e 6765 745f 6e62 7974 6573    dts.get_nbytes
-0001a2b0: 2829 2066 6f72 2064 7473 2069 6e20 7473  () for dts in ts
-0001a2c0: 2e64 6570 656e 6465 6e63 6965 7320 6966  .dependencies if
-0001a2d0: 2077 7320 6e6f 7420 696e 2064 7473 2e77   ws not in dts.w
-0001a2e0: 686f 5f68 6173 0a20 2020 2020 2020 2029  ho_has.        )
-0001a2f0: 0a0a 2020 2020 2020 2020 7374 6163 6b5f  ..        stack_
-0001a300: 7469 6d65 203d 2077 732e 6f63 6375 7061  time = ws.occupa
-0001a310: 6e63 7920 2f20 7773 2e6e 7468 7265 6164  ncy / ws.nthread
-0001a320: 730a 2020 2020 2020 2020 7374 6172 745f  s.        start_
-0001a330: 7469 6d65 203d 2073 7461 636b 5f74 696d  time = stack_tim
-0001a340: 6520 2b20 636f 6d6d 5f62 7974 6573 202f  e + comm_bytes /
-0001a350: 2073 656c 662e 6261 6e64 7769 6474 680a   self.bandwidth.
-0001a360: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
-0001a370: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-0001a380: 2020 7265 7475 726e 2028 6c65 6e28 7773    return (len(ws
-0001a390: 2e61 6374 6f72 7329 2c20 7374 6172 745f  .actors), start_
-0001a3a0: 7469 6d65 2c20 7773 2e6e 6279 7465 7329  time, ws.nbytes)
-0001a3b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001a3c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001a3d0: 6e20 2873 7461 7274 5f74 696d 652c 2077  n (start_time, w
-0001a3e0: 732e 6e62 7974 6573 290a 0a20 2020 2064  s.nbytes)..    d
-0001a3f0: 6566 2061 6464 5f72 6570 6c69 6361 2873  ef add_replica(s
-0001a400: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-0001a410: 7465 2c20 7773 3a20 576f 726b 6572 5374  te, ws: WorkerSt
-0001a420: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-0001a430: 2020 2020 2020 2222 224e 6f74 6520 7468        """Note th
-0001a440: 6174 2061 2077 6f72 6b65 7220 686f 6c64  at a worker hold
-0001a450: 7320 6120 7265 706c 6963 6120 6f66 2061  s a replica of a
-0001a460: 2074 6173 6b20 7769 7468 2073 7461 7465   task with state
-0001a470: 3d27 6d65 6d6f 7279 2722 2222 0a20 2020  ='memory'""".   
-0001a480: 2020 2020 2077 732e 6164 645f 7265 706c       ws.add_repl
-0001a490: 6963 6128 7473 290a 2020 2020 2020 2020  ica(ts).        
-0001a4a0: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
-0001a4b0: 7329 203d 3d20 323a 0a20 2020 2020 2020  s) == 2:.       
-0001a4c0: 2020 2020 2073 656c 662e 7265 706c 6963       self.replic
-0001a4d0: 6174 6564 5f74 6173 6b73 2e61 6464 2874  ated_tasks.add(t
-0001a4e0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
-0001a4f0: 7665 5f72 6570 6c69 6361 2873 656c 662c  ve_replica(self,
-0001a500: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
-0001a510: 7773 3a20 576f 726b 6572 5374 6174 6529  ws: WorkerState)
-0001a520: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001a530: 2020 2222 224e 6f74 6520 7468 6174 2061    """Note that a
-0001a540: 2077 6f72 6b65 7220 6e6f 206c 6f6e 6765   worker no longe
-0001a550: 7220 686f 6c64 7320 6120 7265 706c 6963  r holds a replic
-0001a560: 6120 6f66 2061 2074 6173 6b22 2222 0a20  a of a task""". 
-0001a570: 2020 2020 2020 2077 732e 7265 6d6f 7665         ws.remove
-0001a580: 5f72 6570 6c69 6361 2874 7329 0a20 2020  _replica(ts).   
-0001a590: 2020 2020 2069 6620 6c65 6e28 7473 2e77       if len(ts.w
-0001a5a0: 686f 5f68 6173 2920 3d3d 2031 3a0a 2020  ho_has) == 1:.  
-0001a5b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-0001a5c0: 6570 6c69 6361 7465 645f 7461 736b 732e  eplicated_tasks.
-0001a5d0: 7265 6d6f 7665 2874 7329 0a0a 2020 2020  remove(ts)..    
-0001a5e0: 6465 6620 7265 6d6f 7665 5f61 6c6c 5f72  def remove_all_r
-0001a5f0: 6570 6c69 6361 7328 7365 6c66 2c20 7473  eplicas(self, ts
-0001a600: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-0001a610: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0001a620: 2252 656d 6f76 6520 616c 6c20 7265 706c  "Remove all repl
-0001a630: 6963 6173 206f 6620 6120 7461 736b 2066  icas of a task f
-0001a640: 726f 6d20 616c 6c20 776f 726b 6572 7322  rom all workers"
-0001a650: 2222 0a20 2020 2020 2020 206e 6279 7465  "".        nbyte
-0001a660: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
-0001a670: 7328 290a 2020 2020 2020 2020 666f 7220  s().        for 
-0001a680: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-0001a690: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
-0001a6a0: 2e6e 6279 7465 7320 2d3d 206e 6279 7465  .nbytes -= nbyte
-0001a6b0: 730a 2020 2020 2020 2020 2020 2020 6465  s.            de
-0001a6c0: 6c20 7773 2e5f 6861 735f 7768 6174 5b74  l ws._has_what[t
-0001a6d0: 735d 0a20 2020 2020 2020 2069 6620 6c65  s].        if le
-0001a6e0: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
-0001a6f0: 313a 0a20 2020 2020 2020 2020 2020 2073  1:.            s
-0001a700: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
-0001a710: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
-0001a720: 2020 2020 2020 2020 7473 2e77 686f 5f68          ts.who_h
-0001a730: 6173 2e63 6c65 6172 2829 0a0a 2020 2020  as.clear()..    
-0001a740: 6465 6620 6275 6c6b 5f73 6368 6564 756c  def bulk_schedul
-0001a750: 655f 756e 7275 6e6e 6162 6c65 5f61 6674  e_unrunnable_aft
-0001a760: 6572 5f61 6464 696e 675f 776f 726b 6572  er_adding_worker
-0001a770: 2873 656c 662c 2077 733a 2057 6f72 6b65  (self, ws: Worke
-0001a780: 7253 7461 7465 2920 2d3e 2052 6563 733a  rState) -> Recs:
-0001a790: 0a20 2020 2020 2020 2022 2222 5365 6e64  .        """Send
-0001a7a0: 2060 606e 6f2d 776f 726b 6572 6060 2074   ``no-worker`` t
-0001a7b0: 6173 6b73 2074 6f20 6060 7072 6f63 6573  asks to ``proces
-0001a7c0: 7369 6e67 6060 2074 6861 7420 7468 6973  sing`` that this
-0001a7d0: 2077 6f72 6b65 7220 6361 6e20 6861 6e64   worker can hand
-0001a7e0: 6c65 2e0a 0a20 2020 2020 2020 2052 6574  le...        Ret
-0001a7f0: 7572 6e73 2070 7269 6f72 6974 792d 6f72  urns priority-or
-0001a800: 6465 7265 6420 7265 636f 6d6d 656e 6461  dered recommenda
-0001a810: 7469 6f6e 732e 0a20 2020 2020 2020 2022  tions..        "
-0001a820: 2222 0a20 2020 2020 2020 2072 756e 6e61  "".        runna
-0001a830: 626c 653a 206c 6973 745b 5461 736b 5374  ble: list[TaskSt
-0001a840: 6174 655d 203d 205b 5d0a 2020 2020 2020  ate] = [].      
-0001a850: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
-0001a860: 2e75 6e72 756e 6e61 626c 653a 0a20 2020  .unrunnable:.   
-0001a870: 2020 2020 2020 2020 2076 616c 6964 203d           valid =
-0001a880: 2073 656c 662e 7661 6c69 645f 776f 726b   self.valid_work
-0001a890: 6572 7328 7473 290a 2020 2020 2020 2020  ers(ts).        
-0001a8a0: 2020 2020 6966 2076 616c 6964 2069 7320      if valid is 
-0001a8b0: 4e6f 6e65 206f 7220 7773 2069 6e20 7661  None or ws in va
-0001a8c0: 6c69 643a 0a20 2020 2020 2020 2020 2020  lid:.           
-0001a8d0: 2020 2020 2072 756e 6e61 626c 652e 6170       runnable.ap
-0001a8e0: 7065 6e64 2874 7329 0a0a 2020 2020 2020  pend(ts)..      
-0001a8f0: 2020 2320 5265 636f 6d6d 656e 6461 7469    # Recommendati
-0001a900: 6f6e 7320 6172 6520 7072 6f63 6573 7365  ons are processe
-0001a910: 6420 4c49 464f 2c20 6865 6e63 6520 7468  d LIFO, hence th
-0001a920: 6520 7265 7665 7273 6564 206f 7264 6572  e reversed order
-0001a930: 0a20 2020 2020 2020 2072 756e 6e61 626c  .        runnabl
-0001a940: 652e 736f 7274 286b 6579 3d6f 7065 7261  e.sort(key=opera
-0001a950: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
-0001a960: 7072 696f 7269 7479 2229 2c20 7265 7665  priority"), reve
-0001a970: 7273 653d 5472 7565 290a 2020 2020 2020  rse=True).      
-0001a980: 2020 7265 7475 726e 207b 7473 2e6b 6579    return {ts.key
-0001a990: 3a20 2270 726f 6365 7373 696e 6722 2066  : "processing" f
-0001a9a0: 6f72 2074 7320 696e 2072 756e 6e61 626c  or ts in runnabl
-0001a9b0: 657d 0a0a 2020 2020 6465 6620 5f76 616c  e}..    def _val
-0001a9c0: 6964 6174 655f 7265 6164 7928 7365 6c66  idate_ready(self
-0001a9d0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-0001a9e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001a9f0: 2020 2222 2256 616c 6964 6174 696f 6e20    """Validation 
-0001aa00: 666f 7220 7265 6164 7920 7374 6174 6573  for ready states
-0001aa10: 2028 7072 6f63 6573 7369 6e67 2c20 7175   (processing, qu
-0001aa20: 6575 6564 2c20 6e6f 2d77 6f72 6b65 7229  eued, no-worker)
-0001aa30: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
-0001aa40: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-0001aa50: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-0001aa60: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-0001aa70: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
-0001aa80: 7420 6e6f 7420 7473 2e65 7863 6570 7469  t not ts.excepti
-0001aa90: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
-0001aaa0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-0001aab0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-0001aac0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0001aad0: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
-0001aae0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
-0001aaf0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-0001ab00: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
-0001ab10: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-0001ab20: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-0001ab30: 7175 6575 6564 0a20 2020 2020 2020 2061  queued.        a
-0001ab40: 7373 6572 7420 616c 6c28 6474 732e 7768  ssert all(dts.wh
-0001ab50: 6f5f 6861 7320 666f 7220 6474 7320 696e  o_has for dts in
-0001ab60: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0001ab70: 290a 0a20 2020 2064 6566 205f 6164 645f  )..    def _add_
-0001ab80: 746f 5f70 726f 6365 7373 696e 6728 7365  to_processing(se
-0001ab90: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001aba0: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
-0001abb0: 7465 2920 2d3e 204d 7367 733a 0a20 2020  te) -> Msgs:.   
-0001abc0: 2020 2020 2022 2222 5365 7420 6120 7461       """Set a ta
-0001abd0: 736b 2061 7320 7072 6f63 6573 7369 6e67  sk as processing
-0001abe0: 206f 6e20 6120 776f 726b 6572 2061 6e64   on a worker and
-0001abf0: 2072 6574 7572 6e20 7468 6520 776f 726b   return the work
-0001ac00: 6572 206d 6573 7361 6765 7320 746f 2073  er messages to s
-0001ac10: 656e 6422 2222 0a20 2020 2020 2020 2069  end""".        i
-0001ac20: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-0001ac30: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001ac40: 662e 5f76 616c 6964 6174 655f 7265 6164  f._validate_read
-0001ac50: 7928 7473 290a 2020 2020 2020 2020 2020  y(ts).          
-0001ac60: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
-0001ac70: 656c 662e 7275 6e6e 696e 672c 2073 656c  elf.running, sel
-0001ac80: 662e 7275 6e6e 696e 670a 2020 2020 2020  f.running.      
-0001ac90: 2020 2020 2020 6173 7365 7274 2028 6f20        assert (o 
-0001aca0: 3a3d 2073 656c 662e 776f 726b 6572 732e  := self.workers.
-0001acb0: 6765 7428 7773 2e61 6464 7265 7373 2929  get(ws.address))
-0001acc0: 2069 7320 7773 2c20 2877 732c 206f 290a   is ws, (ws, o).
-0001acd0: 0a20 2020 2020 2020 2077 732e 6164 645f  .        ws.add_
-0001ace0: 746f 5f70 726f 6365 7373 696e 6728 7473  to_processing(ts
-0001acf0: 290a 2020 2020 2020 2020 7473 2e70 726f  ).        ts.pro
-0001ad00: 6365 7373 696e 675f 6f6e 203d 2077 730a  cessing_on = ws.
-0001ad10: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-0001ad20: 203d 2022 7072 6f63 6573 7369 6e67 220a   = "processing".
-0001ad30: 2020 2020 2020 2020 7365 6c66 2e61 6371          self.acq
-0001ad40: 7569 7265 5f72 6573 6f75 7263 6573 2874  uire_resources(t
-0001ad50: 732c 2077 7329 0a20 2020 2020 2020 2073  s, ws).        s
-0001ad60: 656c 662e 6368 6563 6b5f 6964 6c65 5f73  elf.check_idle_s
-0001ad70: 6174 7572 6174 6564 2877 7329 0a20 2020  aturated(ws).   
-0001ad80: 2020 2020 2073 656c 662e 6e5f 7461 736b       self.n_task
-0001ad90: 7320 2b3d 2031 0a0a 2020 2020 2020 2020  s += 1..        
-0001ada0: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
-0001adb0: 2020 2020 2020 2020 2077 732e 6163 746f           ws.acto
-0001adc0: 7273 2e61 6464 2874 7329 0a0a 2020 2020  rs.add(ts)..    
-0001add0: 2020 2020 7265 7475 726e 207b 7773 2e61      return {ws.a
-0001ade0: 6464 7265 7373 3a20 5b73 656c 662e 5f74  ddress: [self._t
-0001adf0: 6173 6b5f 746f 5f6d 7367 2874 7329 5d7d  ask_to_msg(ts)]}
-0001ae00: 0a0a 2020 2020 6465 6620 5f65 7869 745f  ..    def _exit_
-0001ae10: 7072 6f63 6573 7369 6e67 5f63 6f6d 6d6f  processing_commo
-0001ae20: 6e28 7365 6c66 2c20 7473 3a20 5461 736b  n(self, ts: Task
-0001ae30: 5374 6174 6529 202d 3e20 576f 726b 6572  State) -> Worker
-0001ae40: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
-0001ae50: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-0001ae60: 2a74 732a 2066 726f 6d20 7468 6520 7365  *ts* from the se
-0001ae70: 7420 6f66 2070 726f 6365 7373 696e 6720  t of processing 
-0001ae80: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
-0001ae90: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-0001aea0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0001aeb0: 576f 726b 6572 2073 7461 7465 206f 6620  Worker state of 
-0001aec0: 7468 6520 776f 726b 6572 2074 6861 7420  the worker that 
-0001aed0: 7072 6f63 6573 7365 6420 2a74 732a 2069  processed *ts* i
-0001aee0: 6620 7468 6520 776f 726b 6572 2069 7320  f the worker is 
-0001aef0: 6375 7272 656e 742c 0a20 2020 2020 2020  current,.       
-0001af00: 204e 6f6e 6520 6966 2074 6865 2077 6f72   None if the wor
-0001af10: 6b65 7220 6973 2073 7461 6c65 2e0a 0a20  ker is stale... 
-0001af20: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-0001af30: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-0001af40: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-0001af50: 6572 2e5f 7365 745f 6475 7261 7469 6f6e  er._set_duration
-0001af60: 5f65 7374 696d 6174 650a 2020 2020 2020  _estimate.      
-0001af70: 2020 2222 220a 2020 2020 2020 2020 7773    """.        ws
-0001af80: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
-0001af90: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-0001afa0: 7274 2077 730a 2020 2020 2020 2020 7473  rt ws.        ts
-0001afb0: 2e70 726f 6365 7373 696e 675f 6f6e 203d  .processing_on =
-0001afc0: 204e 6f6e 650a 0a20 2020 2020 2020 2077   None..        w
-0001afd0: 732e 7265 6d6f 7665 5f66 726f 6d5f 7072  s.remove_from_pr
-0001afe0: 6f63 6573 7369 6e67 2874 7329 0a20 2020  ocessing(ts).   
-0001aff0: 2020 2020 2069 6620 7365 6c66 2e77 6f72       if self.wor
-0001b000: 6b65 7273 2e67 6574 2877 732e 6164 6472  kers.get(ws.addr
-0001b010: 6573 7329 2069 7320 6e6f 7420 7773 3a20  ess) is not ws: 
-0001b020: 2023 206d 6179 2068 6176 6520 6265 656e   # may have been
-0001b030: 2072 656d 6f76 6564 0a20 2020 2020 2020   removed.       
-0001b040: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0001b050: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-0001b060: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
-0001b070: 7465 6428 7773 290a 2020 2020 2020 2020  ted(ws).        
-0001b080: 7365 6c66 2e72 656c 6561 7365 5f72 6573  self.release_res
-0001b090: 6f75 7263 6573 2874 732c 2077 7329 0a0a  ources(ts, ws)..
-0001b0a0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
-0001b0b0: 730a 0a20 2020 2064 6566 205f 6164 645f  s..    def _add_
-0001b0c0: 746f 5f6d 656d 6f72 7928 0a20 2020 2020  to_memory(.     
-0001b0d0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001b0e0: 2074 733a 2054 6173 6b53 7461 7465 2c0a   ts: TaskState,.
-0001b0f0: 2020 2020 2020 2020 7773 3a20 576f 726b          ws: Work
-0001b100: 6572 5374 6174 652c 0a20 2020 2020 2020  erState,.       
-0001b110: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b120: 3a20 5265 6373 2c0a 2020 2020 2020 2020  : Recs,.        
-0001b130: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-0001b140: 732c 0a20 2020 2020 2020 2074 7970 653a  s,.        type:
-0001b150: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
-0001b160: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
-0001b170: 7065 6e61 6d65 3a20 7374 7220 7c20 4e6f  pename: str | No
-0001b180: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
-0001b190: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0001b1a0: 2020 2222 2241 6464 2074 7320 746f 2074    """Add ts to t
-0001b1b0: 6865 2073 6574 206f 6620 696e 2d6d 656d  he set of in-mem
-0001b1c0: 6f72 7920 7461 736b 7322 2222 0a20 2020  ory tasks""".   
-0001b1d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-0001b1e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-0001b1f0: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0001b200: 2069 6e20 7773 2e68 6173 5f77 6861 740a   in ws.has_what.
-0001b210: 0a20 2020 2020 2020 2073 656c 662e 6164  .        self.ad
-0001b220: 645f 7265 706c 6963 6128 7473 2c20 7773  d_replica(ts, ws
-0001b230: 290a 0a20 2020 2020 2020 2064 6570 7320  )..        deps 
-0001b240: 3d20 6c69 7374 2874 732e 6465 7065 6e64  = list(ts.depend
-0001b250: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
-0001b260: 206c 656e 2864 6570 7329 203e 2031 3a0a   len(deps) > 1:.
-0001b270: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-0001b280: 2e73 6f72 7428 6b65 793d 6f70 6572 6174  .sort(key=operat
-0001b290: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
-0001b2a0: 7269 6f72 6974 7922 292c 2072 6576 6572  riority"), rever
-0001b2b0: 7365 3d54 7275 6529 0a0a 2020 2020 2020  se=True)..      
-0001b2c0: 2020 666f 7220 6474 7320 696e 2064 6570    for dts in dep
-0001b2d0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0001b2e0: 203d 2064 7473 2e77 6169 7469 6e67 5f6f   = dts.waiting_o
-0001b2f0: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-0001b300: 2074 7320 696e 2073 3a0a 2020 2020 2020   ts in s:.      
-0001b310: 2020 2020 2020 2020 2020 732e 6469 7363            s.disc
-0001b320: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
-0001b330: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0001b340: 3a20 2023 206e 6577 2074 6173 6b20 7265  :  # new task re
-0001b350: 6164 7920 746f 2072 756e 0a20 2020 2020  ady to run.     
-0001b360: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001b370: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
-0001b380: 7473 2e6b 6579 5d20 3d20 2270 726f 6365  ts.key] = "proce
-0001b390: 7373 696e 6722 0a0a 2020 2020 2020 2020  ssing"..        
-0001b3a0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-0001b3b0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-0001b3c0: 2020 2020 2020 2020 7320 3d20 6474 732e          s = dts.
-0001b3d0: 7761 6974 6572 730a 2020 2020 2020 2020  waiters.        
-0001b3e0: 2020 2020 732e 6469 7363 6172 6428 7473      s.discard(ts
-0001b3f0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001b400: 206e 6f74 2073 2061 6e64 206e 6f74 2064   not s and not d
-0001b410: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001b420: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001b430: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-0001b440: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-0001b450: 6564 220a 0a20 2020 2020 2020 2069 6620  ed"..        if 
-0001b460: 6e6f 7420 7473 2e77 6169 7465 7273 2061  not ts.waiters a
-0001b470: 6e64 206e 6f74 2074 732e 7768 6f5f 7761  nd not ts.who_wa
-0001b480: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001b490: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b4a0: 5b74 732e 6b65 795d 203d 2022 7265 6c65  [ts.key] = "rele
-0001b4b0: 6173 6564 220a 2020 2020 2020 2020 656c  ased".        el
-0001b4c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001b4d0: 7265 706f 7274 5f6d 7367 3a20 6469 6374  report_msg: dict
-0001b4e0: 5b73 7472 2c20 416e 795d 203d 207b 226f  [str, Any] = {"o
-0001b4f0: 7022 3a20 226b 6579 2d69 6e2d 6d65 6d6f  p": "key-in-memo
-0001b500: 7279 222c 2022 6b65 7922 3a20 7473 2e6b  ry", "key": ts.k
-0001b510: 6579 7d0a 2020 2020 2020 2020 2020 2020  ey}.            
-0001b520: 6966 2074 7970 6520 6973 206e 6f74 204e  if type is not N
-0001b530: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001b540: 2020 2020 2072 6570 6f72 745f 6d73 675b       report_msg[
-0001b550: 2274 7970 6522 5d20 3d20 7479 7065 0a20  "type"] = type. 
-0001b560: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-0001b570: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-0001b580: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001b590: 2020 2063 6c69 656e 745f 6d73 6773 5b63     client_msgs[c
-0001b5a0: 732e 636c 6965 6e74 5f6b 6579 5d20 3d20  s.client_key] = 
-0001b5b0: 5b72 6570 6f72 745f 6d73 675d 0a0a 2020  [report_msg]..  
-0001b5c0: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
-0001b5d0: 2022 6d65 6d6f 7279 220a 2020 2020 2020   "memory".      
-0001b5e0: 2020 7473 2e74 7970 6520 3d20 7479 7065    ts.type = type
-0001b5f0: 6e61 6d65 2020 2320 7479 7065 3a20 6967  name  # type: ig
-0001b600: 6e6f 7265 0a20 2020 2020 2020 2074 732e  nore.        ts.
-0001b610: 6772 6f75 702e 7479 7065 732e 6164 6428  group.types.add(
-0001b620: 7479 7065 6e61 6d65 2920 2023 2074 7970  typename)  # typ
-0001b630: 653a 2069 676e 6f72 650a 0a20 2020 2020  e: ignore..     
-0001b640: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
-0001b650: 656e 7473 5b22 6669 7265 2d61 6e64 2d66  ents["fire-and-f
-0001b660: 6f72 6765 7422 5d0a 2020 2020 2020 2020  orget"].        
-0001b670: 6966 2074 7320 696e 2063 732e 7761 6e74  if ts in cs.want
-0001b680: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
-0001b690: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
-0001b6a0: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
-0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6c0: 6373 3d63 732c 0a20 2020 2020 2020 2020  cs=cs,.         
-0001b6d0: 2020 2020 2020 206b 6579 733d 5b74 732e         keys=[ts.
-0001b6e0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
-0001b6f0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001b700: 7469 6f6e 733d 7265 636f 6d6d 656e 6461  tions=recommenda
-0001b710: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-0001b720: 2020 2029 0a0a 2020 2020 6465 6620 5f70     )..    def _p
-0001b730: 726f 7061 6761 7465 5f72 656c 6561 7365  ropagate_release
-0001b740: 6428 7365 6c66 2c20 7473 3a20 5461 736b  d(self, ts: Task
-0001b750: 5374 6174 652c 2072 6563 6f6d 6d65 6e64  State, recommend
-0001b760: 6174 696f 6e73 3a20 5265 6373 2920 2d3e  ations: Recs) ->
-0001b770: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-0001b780: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
-0001b790: 7365 6422 0a20 2020 2020 2020 206b 6579  sed".        key
-0001b7a0: 203d 2074 732e 6b65 790a 0a20 2020 2020   = ts.key..     
-0001b7b0: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
-0001b7c0: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
-0001b7d0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001b7e0: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
-0001b7f0: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
-0001b800: 2020 2020 2020 2065 6c69 6620 7473 2e77         elif ts.w
-0001b810: 6169 7465 7273 206f 7220 7473 2e77 686f  aiters or ts.who
-0001b820: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
-0001b830: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001b840: 6f6e 735b 6b65 795d 203d 2022 7761 6974  ons[key] = "wait
-0001b850: 696e 6722 0a0a 2020 2020 2020 2020 6966  ing"..        if
-0001b860: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001b870: 2e67 6574 286b 6579 2920 213d 2022 7761  .get(key) != "wa
-0001b880: 6974 696e 6722 3a0a 2020 2020 2020 2020  iting":.        
-0001b890: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-0001b8a0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-0001b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8c0: 6966 2064 7473 2e73 7461 7465 2021 3d20  if dts.state != 
-0001b8d0: 2272 656c 6561 7365 6422 3a0a 2020 2020  "released":.    
-0001b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8f0: 6474 732e 7761 6974 6572 732e 6469 7363  dts.waiters.disc
-0001b900: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
-0001b910: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001b920: 6f74 2064 7473 2e77 6169 7465 7273 2061  ot dts.waiters a
-0001b930: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
-0001b940: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-0001b950: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001b960: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-0001b970: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-0001b980: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-0001b990: 7473 2e77 6169 7465 7273 2e63 6c65 6172  ts.waiters.clear
-0001b9a0: 2829 0a0a 2020 2020 2020 2020 6966 2073  ()..        if s
-0001b9b0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-0001b9c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001b9d0: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-0001b9e0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-0001b9f0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-0001ba00: 696e 2073 656c 662e 7175 6575 6564 0a0a  in self.queued..
-0001ba10: 2020 2020 6465 6620 5f70 726f 7061 6761      def _propaga
-0001ba20: 7465 5f66 6f72 676f 7474 656e 280a 2020  te_forgotten(.  
-0001ba30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0001ba40: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
-0001ba50: 652c 0a20 2020 2020 2020 2072 6563 6f6d  e,.        recom
-0001ba60: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-0001ba70: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
-0001ba80: 5f6d 7367 733a 204d 7367 732c 0a20 2020  _msgs: Msgs,.   
-0001ba90: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-0001baa0: 3a20 7374 722c 0a20 2020 2029 202d 3e20  : str,.    ) -> 
-0001bab0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-0001bac0: 2e73 7461 7465 203d 2022 666f 7267 6f74  .state = "forgot
-0001bad0: 7465 6e22 0a20 2020 2020 2020 2066 6f72  ten".        for
-0001bae0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0001baf0: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-0001bb00: 2020 2064 7473 2e68 6173 5f6c 6f73 745f     dts.has_lost_
-0001bb10: 6465 7065 6e64 656e 6369 6573 203d 2054  dependencies = T
-0001bb20: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0001bb30: 6474 732e 6465 7065 6e64 656e 6369 6573  dts.dependencies
-0001bb40: 2e72 656d 6f76 6528 7473 290a 2020 2020  .remove(ts).    
-0001bb50: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-0001bb60: 696e 675f 6f6e 2e64 6973 6361 7264 2874  ing_on.discard(t
-0001bb70: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0001bb80: 6620 6474 732e 7374 6174 6520 6e6f 7420  f dts.state not 
-0001bb90: 696e 2028 226d 656d 6f72 7922 2c20 2265  in ("memory", "e
-0001bba0: 7272 6564 2229 3a0a 2020 2020 2020 2020  rred"):.        
-0001bbb0: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
-0001bbc0: 2063 6f6d 7075 7465 2074 6173 6b20 616e   compute task an
-0001bbd0: 796d 6f72 650a 2020 2020 2020 2020 2020  ymore.          
-0001bbe0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001bbf0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-0001bc00: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-0001bc10: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
-0001bc20: 7473 2e63 6c65 6172 2829 0a20 2020 2020  ts.clear().     
-0001bc30: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
-0001bc40: 6561 7228 290a 0a20 2020 2020 2020 2066  ear()..        f
-0001bc50: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0001bc60: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0001bc70: 2020 2020 2020 2064 7473 2e64 6570 656e         dts.depen
-0001bc80: 6465 6e74 732e 7265 6d6f 7665 2874 7329  dents.remove(ts)
-0001bc90: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-0001bca0: 2e77 6169 7465 7273 2e64 6973 6361 7264  .waiters.discard
-0001bcb0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0001bcc0: 2069 6620 6e6f 7420 6474 732e 6465 7065   if not dts.depe
-0001bcd0: 6e64 656e 7473 2061 6e64 206e 6f74 2064  ndents and not d
-0001bce0: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001bd00: 5461 736b 206e 6f74 206e 6565 6465 6420  Task not needed 
-0001bd10: 616e 796d 6f72 650a 2020 2020 2020 2020  anymore.        
-0001bd20: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
-0001bd30: 7473 2069 7320 6e6f 7420 7473 0a20 2020  ts is not ts.   
-0001bd40: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0001bd50: 6f6d 6d65 6e64 6174 696f 6e73 5b64 7473  ommendations[dts
-0001bd60: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
-0001bd70: 656e 220a 2020 2020 2020 2020 7473 2e64  en".        ts.d
-0001bd80: 6570 656e 6465 6e63 6965 732e 636c 6561  ependencies.clea
-0001bd90: 7228 290a 2020 2020 2020 2020 7473 2e77  r().        ts.w
-0001bda0: 6169 7469 6e67 5f6f 6e2e 636c 6561 7228  aiting_on.clear(
-0001bdb0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
-0001bdc0: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
-0001bdd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001bde0: 7773 2e61 6464 7265 7373 2069 6e20 7365  ws.address in se
-0001bdf0: 6c66 2e77 6f72 6b65 7273 3a20 2023 2069  lf.workers:  # i
-0001be00: 6e20 6361 7365 2077 6f72 6b65 7220 6861  n case worker ha
-0001be10: 7320 6469 6564 0a20 2020 2020 2020 2020  s died.         
-0001be20: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-0001be30: 6773 5b77 732e 6164 6472 6573 735d 203d  gs[ws.address] =
-0001be40: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001be50: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0001be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be70: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
-0001be80: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0001be90: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-0001bea0: 7322 3a20 5b74 732e 6b65 795d 2c0a 2020  s": [ts.key],.  
-0001beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bec0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-0001bed0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-0001bee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001bef0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0001bf00: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0001bf10: 2020 7365 6c66 2e72 656d 6f76 655f 616c    self.remove_al
-0001bf20: 6c5f 7265 706c 6963 6173 2874 7329 0a0a  l_replicas(ts)..
-0001bf30: 2020 2020 6465 6620 5f63 6c69 656e 745f      def _client_
-0001bf40: 7265 6c65 6173 6573 5f6b 6579 7328 0a20  releases_keys(. 
-0001bf50: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0001bf60: 2020 2020 206b 6579 733a 2043 6f6c 6c65       keys: Colle
-0001bf70: 6374 696f 6e5b 7374 725d 2c0a 2020 2020  ction[str],.    
-0001bf80: 2020 2020 6373 3a20 436c 6965 6e74 5374      cs: ClientSt
-0001bf90: 6174 652c 0a20 2020 2020 2020 2072 6563  ate,.        rec
-0001bfa0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-0001bfb0: 6373 2c0a 2020 2020 2920 2d3e 204e 6f6e  cs,.    ) -> Non
-0001bfc0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-0001bfd0: 6d6f 7665 206b 6579 7320 6672 6f6d 2063  move keys from c
-0001bfe0: 6c69 656e 7420 6465 7369 7265 6420 6c69  lient desired li
-0001bff0: 7374 2222 220a 2020 2020 2020 2020 6c6f  st""".        lo
-0001c000: 6767 6572 2e64 6562 7567 2822 436c 6965  gger.debug("Clie
-0001c010: 6e74 2025 7320 7265 6c65 6173 6573 206b  nt %s releases k
-0001c020: 6579 733a 2025 7322 2c20 6373 2e63 6c69  eys: %s", cs.cli
-0001c030: 656e 745f 6b65 792c 206b 6579 7329 0a20  ent_key, keys). 
-0001c040: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0001c050: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-0001c060: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0001c070: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-0001c080: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-0001c090: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
-0001c0a0: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
-0001c0b0: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
-0001c0c0: 2020 2020 6373 2e77 616e 7473 5f77 6861      cs.wants_wha
-0001c0d0: 742e 7265 6d6f 7665 2874 7329 0a20 2020  t.remove(ts).   
-0001c0e0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0001c0f0: 7768 6f5f 7761 6e74 732e 7265 6d6f 7665  who_wants.remove
-0001c100: 2863 7329 0a20 2020 2020 2020 2020 2020  (cs).           
-0001c110: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
-0001c120: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-0001c130: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001c140: 206e 6f74 2074 732e 6465 7065 6e64 656e   not ts.dependen
-0001c150: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0001c160: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-0001c170: 206c 6976 6520 6465 7065 6e64 656e 7473   live dependents
-0001c180: 2c20 6361 6e20 666f 7267 6574 0a20 2020  , can forget.   
-0001c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1a0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001c1b0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-0001c1c0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
-0001c1d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001c1e0: 6c69 6620 7473 2e73 7461 7465 2021 3d20  lif ts.state != 
-0001c1f0: 2265 7272 6564 2220 616e 6420 6e6f 7420  "erred" and not 
-0001c200: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
-0001c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c220: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001c230: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2272  ons[ts.key] = "r
-0001c240: 656c 6561 7365 6422 0a0a 2020 2020 6465  eleased"..    de
-0001c250: 6620 5f74 6173 6b5f 746f 5f6d 7367 2873  f _task_to_msg(s
-0001c260: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-0001c270: 7465 2c20 6475 7261 7469 6f6e 3a20 666c  te, duration: fl
-0001c280: 6f61 7420 3d20 2d31 2920 2d3e 2064 6963  oat = -1) -> dic
-0001c290: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-0001c2a0: 2020 2020 2022 2222 436f 6e76 6572 7420       """Convert 
-0001c2b0: 6120 7369 6e67 6c65 2063 6f6d 7075 7461  a single computa
-0001c2c0: 7469 6f6e 616c 2074 6173 6b20 746f 2061  tional task to a
-0001c2d0: 206d 6573 7361 6765 2222 220a 2020 2020   message""".    
-0001c2e0: 2020 2020 2320 4649 584d 453a 2054 6865      # FIXME: The
-0001c2f0: 2064 7572 6174 696f 6e20 6174 7472 6962   duration attrib
-0001c300: 7574 6520 6973 206e 6f74 2075 7365 6420  ute is not used 
-0001c310: 6f6e 2077 6f72 6b65 722e 2057 6520 636f  on worker. We co
-0001c320: 756c 6420 7361 7665 206f 7572 7365 6c76  uld save ourselv
-0001c330: 6573 2074 6865 0a20 2020 2020 2020 2023  es the.        #
-0001c340: 2020 2020 2020 2020 7469 6d65 2074 6f20          time to 
-0001c350: 636f 6d70 7574 6520 616e 6420 7375 626d  compute and subm
-0001c360: 6974 2074 6869 730a 2020 2020 2020 2020  it this.        
-0001c370: 6966 2064 7572 6174 696f 6e20 3c20 303a  if duration < 0:
-0001c380: 0a20 2020 2020 2020 2020 2020 2064 7572  .            dur
-0001c390: 6174 696f 6e20 3d20 7365 6c66 2e67 6574  ation = self.get
-0001c3a0: 5f74 6173 6b5f 6475 7261 7469 6f6e 2874  _task_duration(t
-0001c3b0: 7329 0a20 2020 2020 2020 2074 732e 7275  s).        ts.ru
-0001c3c0: 6e5f 6964 203d 206e 6578 7428 5461 736b  n_id = next(Task
-0001c3d0: 5374 6174 652e 5f72 756e 5f69 645f 6974  State._run_id_it
-0001c3e0: 6572 6174 6f72 290a 2020 2020 2020 2020  erator).        
-0001c3f0: 6173 7365 7274 2074 732e 7072 696f 7269  assert ts.priori
-0001c400: 7479 2c20 7473 0a20 2020 2020 2020 206d  ty, ts.        m
-0001c410: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
-0001c420: 795d 203d 207b 0a20 2020 2020 2020 2020  y] = {.         
-0001c430: 2020 2022 6f70 223a 2022 636f 6d70 7574     "op": "comput
-0001c440: 652d 7461 736b 222c 0a20 2020 2020 2020  e-task",.       
-0001c450: 2020 2020 2022 6b65 7922 3a20 7473 2e6b       "key": ts.k
-0001c460: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-0001c470: 2272 756e 5f69 6422 3a20 7473 2e72 756e  "run_id": ts.run
-0001c480: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0001c490: 2022 7072 696f 7269 7479 223a 2074 732e   "priority": ts.
-0001c4a0: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
-0001c4b0: 2020 2020 2020 2264 7572 6174 696f 6e22        "duration"
-0001c4c0: 3a20 6475 7261 7469 6f6e 2c0a 2020 2020  : duration,.    
-0001c4d0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-0001c4e0: 735f 6964 223a 2066 2263 6f6d 7075 7465  s_id": f"compute
-0001c4f0: 2d74 6173 6b2d 7b74 696d 6528 297d 222c  -task-{time()}",
-0001c500: 0a20 2020 2020 2020 2020 2020 2022 7768  .            "wh
-0001c510: 6f5f 6861 7322 3a20 7b0a 2020 2020 2020  o_has": {.      
-0001c520: 2020 2020 2020 2020 2020 6474 732e 6b65            dts.ke
-0001c530: 793a 205b 7773 2e61 6464 7265 7373 2066  y: [ws.address f
-0001c540: 6f72 2077 7320 696e 2064 7473 2e77 686f  or ws in dts.who
-0001c550: 5f68 6173 5d20 666f 7220 6474 7320 696e  _has] for dts in
-0001c560: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0001c570: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-0001c580: 2020 2020 2020 2020 2020 2020 226e 6279              "nby
-0001c590: 7465 7322 3a20 7b64 7473 2e6b 6579 3a20  tes": {dts.key: 
-0001c5a0: 6474 732e 6e62 7974 6573 2066 6f72 2064  dts.nbytes for d
-0001c5b0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-0001c5c0: 6e63 6965 737d 2c0a 2020 2020 2020 2020  ncies},.        
-0001c5d0: 2020 2020 2272 756e 5f73 7065 6322 3a20      "run_spec": 
-0001c5e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0001c5f0: 2020 2266 756e 6374 696f 6e22 3a20 4e6f    "function": No
-0001c600: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0001c610: 2261 7267 7322 3a20 4e6f 6e65 2c0a 2020  "args": None,.  
-0001c620: 2020 2020 2020 2020 2020 226b 7761 7267            "kwarg
-0001c630: 7322 3a20 4e6f 6e65 2c0a 2020 2020 2020  s": None,.      
-0001c640: 2020 2020 2020 2272 6573 6f75 7263 655f        "resource_
-0001c650: 7265 7374 7269 6374 696f 6e73 223a 2074  restrictions": t
-0001c660: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
-0001c670: 6963 7469 6f6e 732c 0a20 2020 2020 2020  ictions,.       
-0001c680: 2020 2020 2022 6163 746f 7222 3a20 7473       "actor": ts
-0001c690: 2e61 6374 6f72 2c0a 2020 2020 2020 2020  .actor,.        
-0001c6a0: 2020 2020 2261 6e6e 6f74 6174 696f 6e73      "annotations
-0001c6b0: 223a 2074 732e 616e 6e6f 7461 7469 6f6e  ": ts.annotation
-0001c6c0: 732c 0a20 2020 2020 2020 207d 0a20 2020  s,.        }.   
-0001c6d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-0001c6e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-0001c6f0: 2020 2061 7373 6572 7420 616c 6c28 6d73     assert all(ms
-0001c700: 675b 2277 686f 5f68 6173 225d 2e76 616c  g["who_has"].val
-0001c710: 7565 7328 2929 0a0a 2020 2020 2020 2020  ues())..        
-0001c720: 6966 2069 7369 6e73 7461 6e63 6528 7473  if isinstance(ts
-0001c730: 2e72 756e 5f73 7065 632c 2064 6963 7429  .run_spec, dict)
-0001c740: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-0001c750: 672e 7570 6461 7465 2874 732e 7275 6e5f  g.update(ts.run_
-0001c760: 7370 6563 290a 2020 2020 2020 2020 656c  spec).        el
-0001c770: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001c780: 6d73 675b 2272 756e 5f73 7065 6322 5d20  msg["run_spec"] 
-0001c790: 3d20 7473 2e72 756e 5f73 7065 630a 0a20  = ts.run_spec.. 
-0001c7a0: 2020 2020 2020 2072 6574 7572 6e20 6d73         return ms
-0001c7b0: 670a 0a0a 636c 6173 7320 5363 6865 6475  g...class Schedu
-0001c7c0: 6c65 7228 5363 6865 6475 6c65 7253 7461  ler(SchedulerSta
-0001c7d0: 7465 2c20 5365 7276 6572 4e6f 6465 293a  te, ServerNode):
-0001c7e0: 0a20 2020 2022 2222 4479 6e61 6d69 6320  .    """Dynamic 
-0001c7f0: 6469 7374 7269 6275 7465 6420 7461 736b  distributed task
-0001c800: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-0001c810: 5468 6520 7363 6865 6475 6c65 7220 7472  The scheduler tr
-0001c820: 6163 6b73 2074 6865 2063 7572 7265 6e74  acks the current
-0001c830: 2073 7461 7465 206f 6620 776f 726b 6572   state of worker
-0001c840: 732c 2064 6174 612c 2061 6e64 2063 6f6d  s, data, and com
-0001c850: 7075 7461 7469 6f6e 732e 0a20 2020 2054  putations..    T
-0001c860: 6865 2073 6368 6564 756c 6572 206c 6973  he scheduler lis
-0001c870: 7465 6e73 2066 6f72 2065 7665 6e74 7320  tens for events 
-0001c880: 616e 6420 7265 7370 6f6e 6473 2062 7920  and responds by 
-0001c890: 636f 6e74 726f 6c6c 696e 6720 776f 726b  controlling work
-0001c8a0: 6572 730a 2020 2020 6170 7072 6f70 7269  ers.    appropri
-0001c8b0: 6174 656c 792e 2020 4974 2063 6f6e 7469  ately.  It conti
-0001c8c0: 6e75 6f75 736c 7920 7472 6965 7320 746f  nuously tries to
-0001c8d0: 2075 7365 2074 6865 2077 6f72 6b65 7273   use the workers
-0001c8e0: 2074 6f20 6578 6563 7574 6520 616e 2065   to execute an e
-0001c8f0: 7665 720a 2020 2020 6772 6f77 696e 6720  ver.    growing 
-0001c900: 6461 736b 2067 7261 7068 2e0a 0a20 2020  dask graph...   
-0001c910: 2041 6c6c 2065 7665 6e74 7320 6172 6520   All events are 
-0001c920: 6861 6e64 6c65 6420 7175 6963 6b6c 792c  handled quickly,
-0001c930: 2069 6e20 6c69 6e65 6172 2074 696d 6520   in linear time 
-0001c940: 7769 7468 2072 6573 7065 6374 2074 6f20  with respect to 
-0001c950: 7468 6569 7220 696e 7075 740a 2020 2020  their input.    
-0001c960: 2877 6869 6368 2069 7320 6f66 7465 6e20  (which is often 
-0001c970: 6f66 2063 6f6e 7374 616e 7420 7369 7a65  of constant size
-0001c980: 2920 616e 6420 6765 6e65 7261 6c6c 7920  ) and generally 
-0001c990: 7769 7468 696e 2061 206d 696c 6c69 7365  within a millise
-0001c9a0: 636f 6e64 2e20 2054 6f0a 2020 2020 6163  cond.  To.    ac
-0001c9b0: 636f 6d70 6c69 7368 2074 6869 7320 7468  complish this th
-0001c9c0: 6520 7363 6865 6475 6c65 7220 7472 6163  e scheduler trac
-0001c9d0: 6b73 2061 206c 6f74 206f 6620 7374 6174  ks a lot of stat
-0001c9e0: 652e 2020 4576 6572 7920 6f70 6572 6174  e.  Every operat
-0001c9f0: 696f 6e0a 2020 2020 6d61 696e 7461 696e  ion.    maintain
-0001ca00: 7320 7468 6520 636f 6e73 6973 7465 6e63  s the consistenc
-0001ca10: 7920 6f66 2074 6869 7320 7374 6174 652e  y of this state.
-0001ca20: 0a0a 2020 2020 5468 6520 7363 6865 6475  ..    The schedu
-0001ca30: 6c65 7220 636f 6d6d 756e 6963 6174 6573  ler communicates
-0001ca40: 2077 6974 6820 7468 6520 6f75 7473 6964   with the outsid
-0001ca50: 6520 776f 726c 6420 7468 726f 7567 6820  e world through 
-0001ca60: 436f 6d6d 206f 626a 6563 7473 2e0a 2020  Comm objects..  
-0001ca70: 2020 4974 206d 6169 6e74 6169 6e73 2061    It maintains a
-0001ca80: 2063 6f6e 7369 7374 656e 7420 616e 6420   consistent and 
-0001ca90: 7661 6c69 6420 7669 6577 206f 6620 7468  valid view of th
-0001caa0: 6520 776f 726c 6420 6576 656e 2077 6865  e world even whe
-0001cab0: 6e20 6c69 7374 656e 696e 670a 2020 2020  n listening.    
-0001cac0: 746f 2073 6576 6572 616c 2063 6c69 656e  to several clien
-0001cad0: 7473 2061 7420 6f6e 6365 2e0a 0a20 2020  ts at once...   
-0001cae0: 2041 2053 6368 6564 756c 6572 2069 7320   A Scheduler is 
-0001caf0: 7479 7069 6361 6c6c 7920 7374 6172 7465  typically starte
-0001cb00: 6420 6569 7468 6572 2077 6974 6820 7468  d either with th
-0001cb10: 6520 6060 6461 736b 2073 6368 6564 756c  e ``dask schedul
-0001cb20: 6572 6060 0a20 2020 2065 7865 6375 7461  er``.    executa
-0001cb30: 626c 653a 3a0a 0a20 2020 2020 2020 2020  ble::..         
-0001cb40: 2420 6461 736b 2073 6368 6564 756c 6572  $ dask scheduler
-0001cb50: 0a20 2020 2020 2020 2020 5363 6865 6475  .         Schedu
-0001cb60: 6c65 7220 7374 6172 7465 6420 6174 2031  ler started at 1
-0001cb70: 3237 2e30 2e30 2e31 3a38 3738 360a 0a20  27.0.0.1:8786.. 
-0001cb80: 2020 204f 7220 7769 7468 696e 2061 204c     Or within a L
-0001cb90: 6f63 616c 436c 7573 7465 7220 6120 436c  ocalCluster a Cl
-0001cba0: 6965 6e74 2073 7461 7274 7320 7570 2077  ient starts up w
-0001cbb0: 6974 686f 7574 2063 6f6e 6e65 6374 696f  ithout connectio
-0001cbc0: 6e0a 2020 2020 696e 666f 726d 6174 696f  n.    informatio
-0001cbd0: 6e3a 3a0a 0a20 2020 2020 2020 203e 3e3e  n::..        >>>
-0001cbe0: 2063 203d 2043 6c69 656e 7428 2920 2023   c = Client()  #
-0001cbf0: 2064 6f63 7465 7374 3a20 2b53 4b49 500a   doctest: +SKIP.
-0001cc00: 2020 2020 2020 2020 3e3e 3e20 632e 636c          >>> c.cl
-0001cc10: 7573 7465 722e 7363 6865 6475 6c65 7220  uster.scheduler 
-0001cc20: 2023 2064 6f63 7465 7374 3a20 2b53 4b49   # doctest: +SKI
-0001cc30: 500a 2020 2020 2020 2020 5363 6865 6475  P.        Schedu
-0001cc40: 6c65 7228 2e2e 2e29 0a0a 2020 2020 5573  ler(...)..    Us
-0001cc50: 6572 7320 7479 7069 6361 6c6c 7920 646f  ers typically do
-0001cc60: 206e 6f74 2069 6e74 6572 6163 7420 7769   not interact wi
-0001cc70: 7468 2074 6865 2073 6368 6564 756c 6572  th the scheduler
-0001cc80: 2064 6972 6563 746c 7920 6275 7420 7261   directly but ra
-0001cc90: 7468 6572 2077 6974 680a 2020 2020 7468  ther with.    th
-0001cca0: 6520 636c 6965 6e74 206f 626a 6563 7420  e client object 
-0001ccb0: 6060 436c 6965 6e74 6060 2e0a 0a20 2020  ``Client``...   
-0001ccc0: 2054 6865 2060 6063 6f6e 7461 6374 5f61   The ``contact_a
-0001ccd0: 6464 7265 7373 6060 2070 6172 616d 6574  ddress`` paramet
-0001cce0: 6572 2061 6c6c 6f77 7320 746f 2061 6476  er allows to adv
-0001ccf0: 6572 7469 7365 2061 2073 7065 6369 6669  ertise a specifi
-0001cd00: 6320 6164 6472 6573 7320 746f 0a20 2020  c address to.   
-0001cd10: 2074 6865 2077 6f72 6b65 7273 2066 6f72   the workers for
-0001cd20: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2077   communication w
-0001cd30: 6974 6820 7468 6520 7363 6865 6475 6c65  ith the schedule
-0001cd40: 722c 2077 6869 6368 2069 7320 6469 6666  r, which is diff
-0001cd50: 6572 656e 7420 7468 616e 0a20 2020 2074  erent than.    t
-0001cd60: 6865 2061 6464 7265 7373 2074 6865 2073  he address the s
-0001cd70: 6368 6564 756c 6572 2062 696e 6473 2074  cheduler binds t
-0001cd80: 6f2e 2054 6869 7320 6973 2075 7365 6675  o. This is usefu
-0001cd90: 6c20 7768 656e 2074 6865 2073 6368 6564  l when the sched
-0001cda0: 756c 6572 0a20 2020 206c 6973 7465 6e73  uler.    listens
-0001cdb0: 206f 6e20 6120 7072 6976 6174 6520 6164   on a private ad
-0001cdc0: 6472 6573 732c 2077 6869 6368 2074 6865  dress, which the
-0001cdd0: 7265 666f 7265 2063 616e 6e6f 7420 6265  refore cannot be
-0001cde0: 2075 7365 6420 6279 2074 6865 2077 6f72   used by the wor
-0001cdf0: 6b65 7273 0a20 2020 2074 6f20 636f 6e74  kers.    to cont
-0001ce00: 6163 7420 6974 2e0a 0a20 2020 202a 2a53  act it...    **S
-0001ce10: 7461 7465 2a2a 0a0a 2020 2020 5468 6520  tate**..    The 
-0001ce20: 7363 6865 6475 6c65 7220 636f 6e74 6169  scheduler contai
-0001ce30: 6e73 2074 6865 2066 6f6c 6c6f 7769 6e67  ns the following
-0001ce40: 2073 7461 7465 2076 6172 6961 626c 6573   state variables
-0001ce50: 2e20 2045 6163 6820 7661 7269 6162 6c65  .  Each variable
-0001ce60: 2069 730a 2020 2020 6c69 7374 6564 2061   is.    listed a
-0001ce70: 6c6f 6e67 2077 6974 6820 7768 6174 2069  long with what i
-0001ce80: 7420 7374 6f72 6573 2061 6e64 2061 2062  t stores and a b
-0001ce90: 7269 6566 2064 6573 6372 6970 7469 6f6e  rief description
-0001cea0: 2e0a 0a20 2020 202a 202a 2a74 6173 6b73  ...    * **tasks
-0001ceb0: 3a2a 2a20 6060 7b74 6173 6b20 6b65 793a  :** ``{task key:
-0001cec0: 2054 6173 6b53 7461 7465 7d60 600a 2020   TaskState}``.  
-0001ced0: 2020 2020 2020 5461 736b 7320 6375 7272        Tasks curr
-0001cee0: 656e 746c 7920 6b6e 6f77 6e20 746f 2074  ently known to t
-0001cef0: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
-0001cf00: 202a 202a 2a75 6e72 756e 6e61 626c 653a   * **unrunnable:
-0001cf10: 2a2a 2060 607b 5461 736b 5374 6174 657d  ** ``{TaskState}
-0001cf20: 6060 0a20 2020 2020 2020 2054 6173 6b73  ``.        Tasks
-0001cf30: 2069 6e20 7468 6520 226e 6f2d 776f 726b   in the "no-work
-0001cf40: 6572 2220 7374 6174 650a 0a20 2020 202a  er" state..    *
-0001cf50: 202a 2a77 6f72 6b65 7273 3a2a 2a20 6060   **workers:** ``
-0001cf60: 7b77 6f72 6b65 7220 6b65 793a 2057 6f72  {worker key: Wor
-0001cf70: 6b65 7253 7461 7465 7d60 600a 2020 2020  kerState}``.    
-0001cf80: 2020 2020 576f 726b 6572 7320 6375 7272      Workers curr
-0001cf90: 656e 746c 7920 636f 6e6e 6563 7465 6420  ently connected 
-0001cfa0: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-0001cfb0: 0a20 2020 202a 202a 2a69 646c 653a 2a2a  .    * **idle:**
-0001cfc0: 2060 607b 576f 726b 6572 5374 6174 657d   ``{WorkerState}
-0001cfd0: 6060 3a0a 2020 2020 2020 2020 5365 7420  ``:.        Set 
-0001cfe0: 6f66 2077 6f72 6b65 7273 2074 6861 7420  of workers that 
-0001cff0: 6172 6520 6e6f 7420 6675 6c6c 7920 7574  are not fully ut
-0001d000: 696c 697a 6564 0a20 2020 202a 202a 2a73  ilized.    * **s
-0001d010: 6174 7572 6174 6564 3a2a 2a20 6060 7b57  aturated:** ``{W
-0001d020: 6f72 6b65 7253 7461 7465 7d60 603a 0a20  orkerState}``:. 
-0001d030: 2020 2020 2020 2053 6574 206f 6620 776f         Set of wo
-0001d040: 726b 6572 7320 7468 6174 2061 7265 206e  rkers that are n
-0001d050: 6f74 206f 7665 722d 7574 696c 697a 6564  ot over-utilized
-0001d060: 0a0a 2020 2020 2a20 2a2a 686f 7374 5f69  ..    * **host_i
-0001d070: 6e66 6f3a 2a2a 2060 607b 686f 7374 6e61  nfo:** ``{hostna
-0001d080: 6d65 3a20 6469 6374 7d60 603a 0a20 2020  me: dict}``:.   
-0001d090: 2020 2020 2049 6e66 6f72 6d61 7469 6f6e       Information
-0001d0a0: 2061 626f 7574 2065 6163 6820 776f 726b   about each work
-0001d0b0: 6572 2068 6f73 740a 0a20 2020 202a 202a  er host..    * *
-0001d0c0: 2a63 6c69 656e 7473 3a2a 2a20 6060 7b63  *clients:** ``{c
-0001d0d0: 6c69 656e 7420 6b65 793a 2043 6c69 656e  lient key: Clien
-0001d0e0: 7453 7461 7465 7d60 600a 2020 2020 2020  tState}``.      
-0001d0f0: 2020 436c 6965 6e74 7320 6375 7272 656e    Clients curren
-0001d100: 746c 7920 636f 6e6e 6563 7465 6420 746f  tly connected to
-0001d110: 2074 6865 2073 6368 6564 756c 6572 0a0a   the scheduler..
-0001d120: 2020 2020 2a20 2a2a 7365 7276 6963 6573      * **services
-0001d130: 3a2a 2a20 6060 7b73 7472 3a20 706f 7274  :** ``{str: port
-0001d140: 7d60 603a 0a20 2020 2020 2020 204f 7468  }``:.        Oth
-0001d150: 6572 2073 6572 7669 6365 7320 7275 6e6e  er services runn
-0001d160: 696e 6720 6f6e 2074 6869 7320 7363 6865  ing on this sche
-0001d170: 6475 6c65 722c 206c 696b 6520 426f 6b65  duler, like Boke
-0001d180: 680a 2020 2020 2a20 2a2a 6c6f 6f70 3a2a  h.    * **loop:*
-0001d190: 2a20 6060 494f 4c6f 6f70 6060 3a0a 2020  * ``IOLoop``:.  
-0001d1a0: 2020 2020 2020 5468 6520 7275 6e6e 696e        The runnin
-0001d1b0: 6720 546f 726e 6164 6f20 494f 4c6f 6f70  g Tornado IOLoop
-0001d1c0: 0a20 2020 202a 202a 2a63 6c69 656e 745f  .    * **client_
-0001d1d0: 636f 6d6d 733a 2a2a 2060 607b 636c 6965  comms:** ``{clie
-0001d1e0: 6e74 206b 6579 3a20 436f 6d6d 7d60 600a  nt key: Comm}``.
-0001d1f0: 2020 2020 2020 2020 466f 7220 6561 6368          For each
-0001d200: 2063 6c69 656e 742c 2061 2043 6f6d 6d20   client, a Comm 
-0001d210: 6f62 6a65 6374 2075 7365 6420 746f 2072  object used to r
-0001d220: 6563 6569 7665 2074 6173 6b20 7265 7175  eceive task requ
-0001d230: 6573 7473 2061 6e64 0a20 2020 2020 2020  ests and.       
-0001d240: 2072 6570 6f72 7420 7461 736b 2073 7461   report task sta
-0001d250: 7475 7320 7570 6461 7465 732e 0a20 2020  tus updates..   
-0001d260: 202a 202a 2a73 7472 6561 6d5f 636f 6d6d   * **stream_comm
-0001d270: 733a 2a2a 2060 607b 776f 726b 6572 206b  s:** ``{worker k
-0001d280: 6579 3a20 436f 6d6d 7d60 600a 2020 2020  ey: Comm}``.    
-0001d290: 2020 2020 466f 7220 6561 6368 2077 6f72      For each wor
-0001d2a0: 6b65 722c 2061 2043 6f6d 6d20 6f62 6a65  ker, a Comm obje
-0001d2b0: 6374 2066 726f 6d20 7768 6963 6820 7765  ct from which we
-0001d2c0: 2062 6f74 6820 6163 6365 7074 2073 7469   both accept sti
-0001d2d0: 6d75 6c69 2061 6e64 0a20 2020 2020 2020  muli and.       
-0001d2e0: 2072 6570 6f72 7420 7265 7375 6c74 730a   report results.
-0001d2f0: 2020 2020 2a20 2a2a 7461 736b 5f64 7572      * **task_dur
-0001d300: 6174 696f 6e3a 2a2a 2060 607b 6b65 792d  ation:** ``{key-
-0001d310: 7072 6566 6978 3a20 7469 6d65 7d60 600a  prefix: time}``.
-0001d320: 2020 2020 2020 2020 5469 6d65 2077 6520          Time we 
-0001d330: 6578 7065 6374 2063 6572 7461 696e 2066  expect certain f
-0001d340: 756e 6374 696f 6e73 2074 6f20 7461 6b65  unctions to take
-0001d350: 2c20 652e 672e 2060 607b 2773 756d 273a  , e.g. ``{'sum':
-0001d360: 2030 2e32 357d 6060 0a20 2020 2022 2222   0.25}``.    """
-0001d370: 0a0a 2020 2020 6465 6661 756c 745f 706f  ..    default_po
-0001d380: 7274 203d 2038 3738 360a 2020 2020 5f69  rt = 8786.    _i
-0001d390: 6e73 7461 6e63 6573 3a20 436c 6173 7356  nstances: ClassV
-0001d3a0: 6172 5b77 6561 6b72 6566 2e57 6561 6b53  ar[weakref.WeakS
-0001d3b0: 6574 5b53 6368 6564 756c 6572 5d5d 203d  et[Scheduler]] =
-0001d3c0: 2077 6561 6b72 6566 2e57 6561 6b53 6574   weakref.WeakSet
-0001d3d0: 2829 0a0a 2020 2020 6465 6620 5f5f 696e  ()..    def __in
-0001d3e0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
-0001d3f0: 6c66 2c0a 2020 2020 2020 2020 6c6f 6f70  lf,.        loop
-0001d400: 3d4e 6f6e 652c 0a20 2020 2020 2020 2064  =None,.        d
-0001d410: 656c 6574 655f 696e 7465 7276 616c 3d22  elete_interval="
-0001d420: 3530 306d 7322 2c0a 2020 2020 2020 2020  500ms",.        
-0001d430: 7379 6e63 6872 6f6e 697a 655f 776f 726b  synchronize_work
-0001d440: 6572 5f69 6e74 6572 7661 6c3d 2236 3073  er_interval="60s
-0001d450: 222c 0a20 2020 2020 2020 2073 6572 7669  ",.        servi
-0001d460: 6365 733d 4e6f 6e65 2c0a 2020 2020 2020  ces=None,.      
-0001d470: 2020 7365 7276 6963 655f 6b77 6172 6773    service_kwargs
-0001d480: 3d4e 6f6e 652c 0a20 2020 2020 2020 2061  =None,.        a
-0001d490: 6c6c 6f77 6564 5f66 6169 6c75 7265 733d  llowed_failures=
-0001d4a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6578  None,.        ex
-0001d4b0: 7465 6e73 696f 6e73 3d4e 6f6e 652c 0a20  tensions=None,. 
-0001d4c0: 2020 2020 2020 2076 616c 6964 6174 653d         validate=
-0001d4d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7363  None,.        sc
-0001d4e0: 6865 6475 6c65 725f 6669 6c65 3d4e 6f6e  heduler_file=Non
-0001d4f0: 652c 0a20 2020 2020 2020 2073 6563 7572  e,.        secur
-0001d500: 6974 793d 4e6f 6e65 2c0a 2020 2020 2020  ity=None,.      
-0001d510: 2020 776f 726b 6572 5f74 746c 3d4e 6f6e    worker_ttl=Non
-0001d520: 652c 0a20 2020 2020 2020 2069 646c 655f  e,.        idle_
-0001d530: 7469 6d65 6f75 743d 4e6f 6e65 2c0a 2020  timeout=None,.  
-0001d540: 2020 2020 2020 696e 7465 7266 6163 653d        interface=
-0001d550: 4e6f 6e65 2c0a 2020 2020 2020 2020 686f  None,.        ho
-0001d560: 7374 3d4e 6f6e 652c 0a20 2020 2020 2020  st=None,.       
-0001d570: 2070 6f72 743d 302c 0a20 2020 2020 2020   port=0,.       
-0001d580: 2070 726f 746f 636f 6c3d 4e6f 6e65 2c0a   protocol=None,.
-0001d590: 2020 2020 2020 2020 6461 7368 626f 6172          dashboar
-0001d5a0: 645f 6164 6472 6573 733d 4e6f 6e65 2c0a  d_address=None,.
-0001d5b0: 2020 2020 2020 2020 6461 7368 626f 6172          dashboar
-0001d5c0: 643d 4e6f 6e65 2c0a 2020 2020 2020 2020  d=None,.        
-0001d5d0: 6874 7470 5f70 7265 6669 783d 222f 222c  http_prefix="/",
-0001d5e0: 0a20 2020 2020 2020 2070 7265 6c6f 6164  .        preload
-0001d5f0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2070  =None,.        p
-0001d600: 7265 6c6f 6164 5f61 7267 763d 2829 2c0a  reload_argv=(),.
-0001d610: 2020 2020 2020 2020 706c 7567 696e 733d          plugins=
-0001d620: 2829 2c0a 2020 2020 2020 2020 636f 6e74  (),.        cont
-0001d630: 6163 745f 6164 6472 6573 733d 4e6f 6e65  act_address=None
-0001d640: 2c0a 2020 2020 2020 2020 7472 616e 7369  ,.        transi
-0001d650: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-0001d660: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-0001d670: 6a75 7079 7465 723d 4661 6c73 652c 0a20  jupyter=False,. 
-0001d680: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0001d690: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0001d6a0: 6966 206c 6f6f 7020 6973 206e 6f74 204e  if loop is not N
-0001d6b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001d6c0: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
-0001d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6e0: 2274 6865 206c 6f6f 7020 6b77 6172 6720  "the loop kwarg 
-0001d6f0: 746f 2053 6368 6564 756c 6572 2069 7320  to Scheduler is 
-0001d700: 6465 7072 6563 6174 6564 222c 0a20 2020  deprecated",.   
-0001d710: 2020 2020 2020 2020 2020 2020 2044 6570               Dep
-0001d720: 7265 6361 7469 6f6e 5761 726e 696e 672c  recationWarning,
-0001d730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d740: 2073 7461 636b 6c65 7665 6c3d 322c 0a20   stacklevel=2,. 
-0001d750: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001d760: 2020 2020 2020 7365 6c66 2e6c 6f6f 7020        self.loop 
-0001d770: 3d20 7365 6c66 2e69 6f5f 6c6f 6f70 203d  = self.io_loop =
-0001d780: 2049 4f4c 6f6f 702e 6375 7272 656e 7428   IOLoop.current(
-0001d790: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0001d7a0: 7365 7475 705f 6c6f 6767 696e 6728 6c6f  setup_logging(lo
-0001d7b0: 6767 6572 290a 0a20 2020 2020 2020 2023  gger)..        #
-0001d7c0: 2041 7474 7269 6275 7465 730a 2020 2020   Attributes.    
-0001d7d0: 2020 2020 6966 2063 6f6e 7461 6374 5f61      if contact_a
-0001d7e0: 6464 7265 7373 2069 7320 4e6f 6e65 3a0a  ddress is None:.
-0001d7f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001d800: 6163 745f 6164 6472 6573 7320 3d20 6461  act_address = da
-0001d810: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0001d820: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0001d830: 756c 6572 2e63 6f6e 7461 6374 2d61 6464  uler.contact-add
-0001d840: 7265 7373 2229 0a20 2020 2020 2020 2073  ress").        s
-0001d850: 656c 662e 636f 6e74 6163 745f 6164 6472  elf.contact_addr
-0001d860: 6573 7320 3d20 636f 6e74 6163 745f 6164  ess = contact_ad
-0001d870: 6472 6573 730a 2020 2020 2020 2020 6966  dress.        if
-0001d880: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
-0001d890: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-0001d8a0: 2020 2020 2020 2061 6c6c 6f77 6564 5f66         allowed_f
-0001d8b0: 6169 6c75 7265 7320 3d20 6461 736b 2e63  ailures = dask.c
-0001d8c0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0001d8d0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001d8e0: 2e61 6c6c 6f77 6564 2d66 6169 6c75 7265  .allowed-failure
-0001d8f0: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
-0001d900: 2e61 6c6c 6f77 6564 5f66 6169 6c75 7265  .allowed_failure
-0001d910: 7320 3d20 616c 6c6f 7765 645f 6661 696c  s = allowed_fail
-0001d920: 7572 6573 0a20 2020 2020 2020 2069 6620  ures.        if 
-0001d930: 7661 6c69 6461 7465 2069 7320 4e6f 6e65  validate is None
-0001d940: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
-0001d950: 6c69 6461 7465 203d 2064 6173 6b2e 636f  lidate = dask.co
-0001d960: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0001d970: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0001d980: 7661 6c69 6461 7465 2229 0a20 2020 2020  validate").     
-0001d990: 2020 2073 656c 662e 7072 6f63 203d 2070     self.proc = p
-0001d9a0: 7375 7469 6c2e 5072 6f63 6573 7328 290a  sutil.Process().
-0001d9b0: 2020 2020 2020 2020 7365 6c66 2e64 656c          self.del
-0001d9c0: 6574 655f 696e 7465 7276 616c 203d 2070  ete_interval = p
-0001d9d0: 6172 7365 5f74 696d 6564 656c 7461 2864  arse_timedelta(d
-0001d9e0: 656c 6574 655f 696e 7465 7276 616c 2c20  elete_interval, 
-0001d9f0: 6465 6661 756c 743d 226d 7322 290a 2020  default="ms").  
-0001da00: 2020 2020 2020 7365 6c66 2e73 796e 6368        self.synch
-0001da10: 726f 6e69 7a65 5f77 6f72 6b65 725f 696e  ronize_worker_in
-0001da20: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
-0001da30: 696d 6564 656c 7461 280a 2020 2020 2020  imedelta(.      
-0001da40: 2020 2020 2020 7379 6e63 6872 6f6e 697a        synchroniz
-0001da50: 655f 776f 726b 6572 5f69 6e74 6572 7661  e_worker_interva
-0001da60: 6c2c 2064 6566 6175 6c74 3d22 6d73 220a  l, default="ms".
-0001da70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001da80: 2020 7365 6c66 2e73 6572 7669 6365 5f73    self.service_s
-0001da90: 7065 6373 203d 2073 6572 7669 6365 7320  pecs = services 
-0001daa0: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
-0001dab0: 6c66 2e73 6572 7669 6365 5f6b 7761 7267  lf.service_kwarg
-0001dac0: 7320 3d20 7365 7276 6963 655f 6b77 6172  s = service_kwar
-0001dad0: 6773 206f 7220 7b7d 0a20 2020 2020 2020  gs or {}.       
-0001dae0: 2073 656c 662e 7365 7276 6963 6573 203d   self.services =
-0001daf0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0001db00: 2e73 6368 6564 756c 6572 5f66 696c 6520  .scheduler_file 
-0001db10: 3d20 7363 6865 6475 6c65 725f 6669 6c65  = scheduler_file
-0001db20: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-0001db30: 7474 6c20 3d20 776f 726b 6572 5f74 746c  ttl = worker_ttl
-0001db40: 206f 7220 6461 736b 2e63 6f6e 6669 672e   or dask.config.
-0001db50: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0001db60: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-0001db70: 722d 7474 6c22 290a 2020 2020 2020 2020  r-ttl").        
-0001db80: 7365 6c66 2e77 6f72 6b65 725f 7474 6c20  self.worker_ttl 
-0001db90: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-0001dba0: 6128 776f 726b 6572 5f74 746c 2920 6966  a(worker_ttl) if
-0001dbb0: 2077 6f72 6b65 725f 7474 6c20 656c 7365   worker_ttl else
-0001dbc0: 204e 6f6e 650a 2020 2020 2020 2020 6964   None.        id
-0001dbd0: 6c65 5f74 696d 656f 7574 203d 2069 646c  le_timeout = idl
-0001dbe0: 655f 7469 6d65 6f75 7420 6f72 2064 6173  e_timeout or das
-0001dbf0: 6b2e 636f 6e66 6967 2e67 6574 280a 2020  k.config.get(.  
-0001dc00: 2020 2020 2020 2020 2020 2264 6973 7472            "distr
-0001dc10: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001dc20: 2e69 646c 652d 7469 6d65 6f75 7422 0a20  .idle-timeout". 
-0001dc30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001dc40: 2069 6620 6964 6c65 5f74 696d 656f 7574   if idle_timeout
-0001dc50: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001dc60: 6c66 2e69 646c 655f 7469 6d65 6f75 7420  lf.idle_timeout 
-0001dc70: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-0001dc80: 6128 6964 6c65 5f74 696d 656f 7574 290a  a(idle_timeout).
-0001dc90: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001dca0: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-0001dcb0: 646c 655f 7469 6d65 6f75 7420 3d20 4e6f  dle_timeout = No
-0001dcc0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0001dcd0: 6964 6c65 5f73 696e 6365 203d 2074 696d  idle_since = tim
-0001dce0: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
-0001dcf0: 2e74 696d 655f 7374 6172 7465 6420 3d20  .time_started = 
-0001dd00: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
-0001dd10: 2023 2063 6f6d 7061 7469 6269 6c69 7479   # compatibility
-0001dd20: 2066 6f72 2064 6173 6b2d 6761 7465 7761   for dask-gatewa
-0001dd30: 790a 2020 2020 2020 2020 7365 6c66 2e5f  y.        self._
-0001dd40: 6c6f 636b 203d 2061 7379 6e63 696f 2e4c  lock = asyncio.L
-0001dd50: 6f63 6b28 290a 2020 2020 2020 2020 7365  ock().        se
-0001dd60: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
-0001dd70: 6b65 7273 203d 2064 6566 6175 6c74 6469  kers = defaultdi
-0001dd80: 6374 2866 6c6f 6174 290a 2020 2020 2020  ct(float).      
-0001dd90: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0001dda0: 5f74 7970 6573 203d 2064 6566 6175 6c74  _types = default
-0001ddb0: 6469 6374 2866 6c6f 6174 290a 0a20 2020  dict(float)..   
-0001ddc0: 2020 2020 2073 656c 662e 6375 6d75 6c61       self.cumula
-0001ddd0: 7469 7665 5f77 6f72 6b65 725f 6d65 7472  tive_worker_metr
-0001dde0: 6963 7320 3d20 6465 6661 756c 7464 6963  ics = defaultdic
-0001ddf0: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
-0001de00: 2020 6966 206e 6f74 2070 7265 6c6f 6164    if not preload
-0001de10: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0001de20: 656c 6f61 6420 3d20 6461 736b 2e63 6f6e  eload = dask.con
-0001de30: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0001de40: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-0001de50: 7265 6c6f 6164 2229 0a20 2020 2020 2020  reload").       
-0001de60: 2069 6620 6e6f 7420 7072 656c 6f61 645f   if not preload_
-0001de70: 6172 6776 3a0a 2020 2020 2020 2020 2020  argv:.          
-0001de80: 2020 7072 656c 6f61 645f 6172 6776 203d    preload_argv =
-0001de90: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0001dea0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
-0001deb0: 6865 6475 6c65 722e 7072 656c 6f61 642d  heduler.preload-
-0001dec0: 6172 6776 2229 0a20 2020 2020 2020 2073  argv").        s
-0001ded0: 656c 662e 7072 656c 6f61 6473 203d 2070  elf.preloads = p
-0001dee0: 7265 6c6f 6164 696e 672e 7072 6f63 6573  reloading.proces
-0001def0: 735f 7072 656c 6f61 6473 2873 656c 662c  s_preloads(self,
-0001df00: 2070 7265 6c6f 6164 2c20 7072 656c 6f61   preload, preloa
-0001df10: 645f 6172 6776 290a 0a20 2020 2020 2020  d_argv)..       
-0001df20: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-0001df30: 6563 7572 6974 792c 2064 6963 7429 3a0a  ecurity, dict):.
-0001df40: 2020 2020 2020 2020 2020 2020 7365 6375              secu
-0001df50: 7269 7479 203d 2053 6563 7572 6974 7928  rity = Security(
-0001df60: 2a2a 7365 6375 7269 7479 290a 2020 2020  **security).    
-0001df70: 2020 2020 7365 6c66 2e73 6563 7572 6974      self.securit
-0001df80: 7920 3d20 7365 6375 7269 7479 206f 7220  y = security or 
-0001df90: 5365 6375 7269 7479 2829 0a20 2020 2020  Security().     
-0001dfa0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0001dfb0: 616e 6365 2873 656c 662e 7365 6375 7269  ance(self.securi
-0001dfc0: 7479 2c20 5365 6375 7269 7479 290a 2020  ty, Security).  
-0001dfd0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0001dfe0: 6374 696f 6e5f 6172 6773 203d 2073 656c  ction_args = sel
-0001dff0: 662e 7365 6375 7269 7479 2e67 6574 5f63  f.security.get_c
-0001e000: 6f6e 6e65 6374 696f 6e5f 6172 6773 2822  onnection_args("
-0001e010: 7363 6865 6475 6c65 7222 290a 2020 2020  scheduler").    
-0001e020: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0001e030: 696f 6e5f 6172 6773 5b22 6861 6e64 7368  ion_args["handsh
-0001e040: 616b 655f 6f76 6572 7269 6465 7322 5d20  ake_overrides"] 
-0001e050: 3d20 7b20 2023 2063 6f6d 6d6f 6e20 6465  = {  # common de
-0001e060: 6e6f 6d69 6e61 746f 720a 2020 2020 2020  nominator.      
-0001e070: 2020 2020 2020 2270 6963 6b6c 652d 7072        "pickle-pr
-0001e080: 6f74 6f63 6f6c 223a 2034 0a20 2020 2020  otocol": 4.     
-0001e090: 2020 207d 0a0a 2020 2020 2020 2020 7365     }..        se
-0001e0a0: 6c66 2e5f 7374 6172 745f 6164 6472 6573  lf._start_addres
-0001e0b0: 7320 3d20 6164 6472 6573 7365 735f 6672  s = addresses_fr
-0001e0c0: 6f6d 5f75 7365 725f 6172 6773 280a 2020  om_user_args(.  
-0001e0d0: 2020 2020 2020 2020 2020 686f 7374 3d68            host=h
-0001e0e0: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-0001e0f0: 2070 6f72 743d 706f 7274 2c0a 2020 2020   port=port,.    
-0001e100: 2020 2020 2020 2020 696e 7465 7266 6163          interfac
-0001e110: 653d 696e 7465 7266 6163 652c 0a20 2020  e=interface,.   
-0001e120: 2020 2020 2020 2020 2070 726f 746f 636f           protoco
-0001e130: 6c3d 7072 6f74 6f63 6f6c 2c0a 2020 2020  l=protocol,.    
-0001e140: 2020 2020 2020 2020 7365 6375 7269 7479          security
-0001e150: 3d73 6563 7572 6974 792c 0a20 2020 2020  =security,.     
-0001e160: 2020 2020 2020 2064 6566 6175 6c74 5f70         default_p
-0001e170: 6f72 743d 7365 6c66 2e64 6566 6175 6c74  ort=self.default
-0001e180: 5f70 6f72 742c 0a20 2020 2020 2020 2029  _port,.        )
-0001e190: 0a0a 2020 2020 2020 2020 6874 7470 5f73  ..        http_s
-0001e1a0: 6572 7665 725f 6d6f 6475 6c65 7320 3d20  erver_modules = 
-0001e1b0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0001e1c0: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0001e1d0: 6564 756c 6572 2e68 7474 702e 726f 7574  eduler.http.rout
-0001e1e0: 6573 2229 0a20 2020 2020 2020 2073 686f  es").        sho
-0001e1f0: 775f 6461 7368 626f 6172 6420 3d20 6461  w_dashboard = da
-0001e200: 7368 626f 6172 6420 6f72 2028 6461 7368  shboard or (dash
-0001e210: 626f 6172 6420 6973 204e 6f6e 6520 616e  board is None an
-0001e220: 6420 6461 7368 626f 6172 645f 6164 6472  d dashboard_addr
-0001e230: 6573 7329 0a20 2020 2020 2020 2023 2069  ess).        # i
-0001e240: 6e73 7461 6c6c 2076 616e 696c 6c61 2072  nstall vanilla r
-0001e250: 6f75 7465 2069 6620 7368 6f77 5f64 6173  oute if show_das
-0001e260: 6862 6f61 7264 2062 7574 2062 6f6b 6568  hboard but bokeh
-0001e270: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
-0001e280: 640a 2020 2020 2020 2020 6966 2073 686f  d.        if sho
-0001e290: 775f 6461 7368 626f 6172 643a 0a20 2020  w_dashboard:.   
-0001e2a0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0001e2b0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-0001e2c0: 706f 7274 2064 6973 7472 6962 7574 6564  port distributed
-0001e2d0: 2e64 6173 6862 6f61 7264 2e73 6368 6564  .dashboard.sched
-0001e2e0: 756c 6572 0a20 2020 2020 2020 2020 2020  uler.           
-0001e2f0: 2065 7863 6570 7420 496d 706f 7274 4572   except ImportEr
-0001e300: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0001e310: 2020 2020 2073 686f 775f 6461 7368 626f       show_dashbo
-0001e320: 6172 6420 3d20 4661 6c73 650a 2020 2020  ard = False.    
-0001e330: 2020 2020 2020 2020 2020 2020 6874 7470              http
-0001e340: 5f73 6572 7665 725f 6d6f 6475 6c65 732e  _server_modules.
-0001e350: 6170 7065 6e64 2822 6469 7374 7269 6275  append("distribu
-0001e360: 7465 642e 6874 7470 2e73 6368 6564 756c  ted.http.schedul
-0001e370: 6572 2e6d 6973 7369 6e67 5f62 6f6b 6568  er.missing_bokeh
-0001e380: 2229 0a20 2020 2020 2020 2072 6f75 7465  ").        route
-0001e390: 7320 3d20 6765 745f 6861 6e64 6c65 7273  s = get_handlers
-0001e3a0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-0001e3b0: 7276 6572 3d73 656c 662c 206d 6f64 756c  rver=self, modul
-0001e3c0: 6573 3d68 7474 705f 7365 7276 6572 5f6d  es=http_server_m
-0001e3d0: 6f64 756c 6573 2c20 7072 6566 6978 3d68  odules, prefix=h
-0001e3e0: 7474 705f 7072 6566 6978 0a20 2020 2020  ttp_prefix.     
-0001e3f0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0001e400: 662e 7374 6172 745f 6874 7470 5f73 6572  f.start_http_ser
-0001e410: 7665 7228 726f 7574 6573 2c20 6461 7368  ver(routes, dash
-0001e420: 626f 6172 645f 6164 6472 6573 732c 2064  board_address, d
-0001e430: 6566 6175 6c74 5f70 6f72 743d 3837 3837  efault_port=8787
-0001e440: 290a 2020 2020 2020 2020 7365 6c66 2e6a  ).        self.j
-0001e450: 7570 7974 6572 203d 206a 7570 7974 6572  upyter = jupyter
-0001e460: 0a20 2020 2020 2020 2069 6620 7368 6f77  .        if show
-0001e470: 5f64 6173 6862 6f61 7264 3a0a 2020 2020  _dashboard:.    
-0001e480: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-0001e490: 7465 642e 6461 7368 626f 6172 642e 7363  ted.dashboard.sc
-0001e4a0: 6865 6475 6c65 722e 636f 6e6e 6563 7428  heduler.connect(
-0001e4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e4c0: 2073 656c 662e 6874 7470 5f61 7070 6c69   self.http_appli
-0001e4d0: 6361 7469 6f6e 2c20 7365 6c66 2e68 7474  cation, self.htt
-0001e4e0: 705f 7365 7276 6572 2c20 7365 6c66 2c20  p_server, self, 
-0001e4f0: 7072 6566 6978 3d68 7474 705f 7072 6566  prefix=http_pref
-0001e500: 6978 0a20 2020 2020 2020 2020 2020 2029  ix.            )
-0001e510: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001e520: 2e6a 7570 7974 6572 3a0a 2020 2020 2020  .jupyter:.      
-0001e530: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001e540: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-0001e550: 6a75 7079 7465 725f 7365 7276 6572 2e73  jupyter_server.s
-0001e560: 6572 7665 7261 7070 2069 6d70 6f72 7420  erverapp import 
-0001e570: 5365 7276 6572 4170 700a 2020 2020 2020  ServerApp.      
-0001e580: 2020 2020 2020 6578 6365 7074 2049 6d70        except Imp
-0001e590: 6f72 7445 7272 6f72 3a0a 2020 2020 2020  ortError:.      
-0001e5a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001e5b0: 496d 706f 7274 4572 726f 7228 0a20 2020  ImportError(.   
-0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5d0: 2022 496e 206f 7264 6572 2074 6f20 7573   "In order to us
-0001e5e0: 6520 7468 6520 4461 736b 206a 7570 7974  e the Dask jupyt
-0001e5f0: 6572 206f 7074 696f 6e20 796f 7520 220a  er option you ".
-0001e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e610: 2020 2020 226e 6565 6420 746f 2068 6176      "need to hav
-0001e620: 6520 6a75 7079 7465 726c 6162 2069 6e73  e jupyterlab ins
-0001e630: 7461 6c6c 6564 220a 2020 2020 2020 2020  talled".        
-0001e640: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001e650: 2020 2020 2020 6672 6f6d 2074 7261 6974        from trait
-0001e660: 6c65 7473 2e63 6f6e 6669 6720 696d 706f  lets.config impo
-0001e670: 7274 2043 6f6e 6669 670a 0a20 2020 2020  rt Config..     
-0001e680: 2020 2020 2020 206a 203d 2053 6572 7665         j = Serve
-0001e690: 7241 7070 2e69 6e73 7461 6e63 6528 0a20  rApp.instance(. 
-0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e6b0: 6f6e 6669 673d 436f 6e66 6967 280a 2020  onfig=Config(.  
-0001e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0001e6e0: 2020 2020 2020 2020 2020 2020 2253 6572              "Ser
-0001e6f0: 7665 7241 7070 223a 207b 0a20 2020 2020  verApp": {.     
-0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e710: 2020 2020 2020 2022 6261 7365 5f75 726c         "base_url
-0001e720: 223a 2022 6a75 7079 7465 7222 2c0a 2020  ": "jupyter",.  
-0001e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e740: 2020 2020 2020 2020 2020 2320 5345 4355            # SECU
-0001e750: 5249 5459 3a20 5765 2075 7375 616c 6c79  RITY: We usually
-0001e760: 2065 7870 6563 7420 7468 6520 6461 7368   expect the dash
-0001e770: 626f 6172 6420 746f 2062 6520 6120 7265  board to be a re
-0001e780: 6164 2d6f 6e6c 7920 7669 6577 2069 6e74  ad-only view int
-0001e790: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-0001e7a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001e7b0: 7468 6520 7363 6865 6475 6c65 7220 6163  the scheduler ac
-0001e7c0: 7469 7669 7479 2e20 486f 7765 7665 722c  tivity. However,
-0001e7d0: 2062 7920 6164 6469 6e67 2061 6e20 6f70   by adding an op
-0001e7e0: 656e 204a 7570 7974 6572 2061 7070 6c69  en Jupyter appli
-0001e7f0: 6361 7469 6f6e 0a20 2020 2020 2020 2020  cation.         
-0001e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e810: 2020 2023 2077 6520 6172 6520 616c 6c6f     # we are allo
-0001e820: 7769 6e67 2061 7262 6974 7261 7279 2072  wing arbitrary r
-0001e830: 656d 6f74 6520 636f 6465 2065 7865 6375  emote code execu
-0001e840: 7469 6f6e 206f 6e20 7468 6520 7363 6865  tion on the sche
-0001e850: 6475 6c65 7220 7669 6120 7468 650a 2020  duler via the.  
-0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e870: 2020 2020 2020 2020 2020 2320 6461 7368            # dash
-0001e880: 626f 6172 6420 7365 7276 6572 2e20 5468  board server. Th
-0001e890: 6973 206f 7074 696f 6e20 7368 6f75 6c64  is option should
-0001e8a0: 206f 6e6c 7920 6265 2075 7365 6420 7768   only be used wh
-0001e8b0: 656e 2074 6865 2064 6173 6862 6f61 7264  en the dashboard
-0001e8c0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-0001e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8e0: 2320 7072 6f74 6563 7465 6420 7669 6120  # protected via 
-0001e8f0: 6f74 6865 7220 6d65 616e 732c 206f 7220  other means, or 
-0001e900: 7768 656e 2079 6f75 2064 6f6e 2774 2063  when you don't c
-0001e910: 6172 6520 6162 6f75 7420 636c 7573 7465  are about cluste
-0001e920: 7220 7365 6375 7269 7479 2e0a 2020 2020  r security..    
-0001e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e940: 2020 2020 2020 2020 2274 6f6b 656e 223a          "token":
-0001e950: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
-0001e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e970: 2022 616c 6c6f 775f 7265 6d6f 7465 5f61   "allow_remote_a
-0001e980: 6363 6573 7322 3a20 5472 7565 2c0a 2020  ccess": True,.  
-0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0001e9b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001e9d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001e9e0: 2020 2020 2020 2020 2020 6a2e 696e 6974            j.init
-0001e9f0: 6961 6c69 7a65 280a 2020 2020 2020 2020  ialize(.        
-0001ea00: 2020 2020 2020 2020 6e65 775f 6874 7470          new_http
-0001ea10: 7365 7276 6572 3d46 616c 7365 2c0a 2020  server=False,.  
-0001ea20: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-0001ea30: 6776 3d5b 5d2c 0a20 2020 2020 2020 2020  gv=[],.         
-0001ea40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001ea50: 2073 656c 662e 5f6a 7570 7974 6572 5f73   self._jupyter_s
-0001ea60: 6572 7665 725f 6170 706c 6963 6174 696f  erver_applicatio
-0001ea70: 6e20 3d20 6a0a 2020 2020 2020 2020 2020  n = j.          
-0001ea80: 2020 7365 6c66 2e68 7474 705f 6170 706c    self.http_appl
-0001ea90: 6963 6174 696f 6e2e 6164 645f 6170 706c  ication.add_appl
-0001eaa0: 6963 6174 696f 6e28 6a2e 7765 625f 6170  ication(j.web_ap
-0001eab0: 7029 0a0a 2020 2020 2020 2020 2320 436f  p)..        # Co
-0001eac0: 6d6d 756e 6963 6174 696f 6e20 7374 6174  mmunication stat
-0001ead0: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
-0001eae0: 6c69 656e 745f 636f 6d6d 7320 3d20 7b7d  lient_comms = {}
-0001eaf0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-0001eb00: 7265 616d 5f63 6f6d 6d73 203d 207b 7d0a  ream_comms = {}.
-0001eb10: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
-0001eb20: 7374 6174 650a 2020 2020 2020 2020 7461  state.        ta
-0001eb30: 736b 7320 3d20 7b7d 0a0a 2020 2020 2020  sks = {}..      
-0001eb40: 2020 7365 6c66 2e67 656e 6572 6174 696f    self.generatio
-0001eb50: 6e20 3d20 300a 2020 2020 2020 2020 7365  n = 0.        se
-0001eb60: 6c66 2e5f 6c61 7374 5f63 6c69 656e 7420  lf._last_client 
-0001eb70: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-0001eb80: 656c 662e 5f6c 6173 745f 7469 6d65 203d  elf._last_time =
-0001eb90: 2030 0a20 2020 2020 2020 2075 6e72 756e   0.        unrun
-0001eba0: 6e61 626c 6520 3d20 7365 7428 290a 2020  nable = set().  
-0001ebb0: 2020 2020 2020 7175 6575 6564 3a20 4865        queued: He
-0001ebc0: 6170 5365 745b 5461 736b 5374 6174 655d  apSet[TaskState]
-0001ebd0: 203d 2048 6561 7053 6574 286b 6579 3d6f   = HeapSet(key=o
-0001ebe0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
-0001ebf0: 6572 2822 7072 696f 7269 7479 2229 290a  er("priority")).
-0001ec00: 0a20 2020 2020 2020 2073 656c 662e 6461  .        self.da
-0001ec10: 7461 7365 7473 203d 207b 7d0a 0a20 2020  tasets = {}..   
-0001ec20: 2020 2020 2023 2050 7265 6669 782d 6b65       # Prefix-ke
-0001ec30: 7965 6420 636f 6e74 6169 6e65 7273 0a0a  yed containers..
-0001ec40: 2020 2020 2020 2020 2320 436c 6965 6e74          # Client
-0001ec50: 2073 7461 7465 0a20 2020 2020 2020 2063   state.        c
-0001ec60: 6c69 656e 7473 203d 207b 7d0a 0a20 2020  lients = {}..   
-0001ec70: 2020 2020 2023 2057 6f72 6b65 7220 7374       # Worker st
-0001ec80: 6174 650a 2020 2020 2020 2020 776f 726b  ate.        work
-0001ec90: 6572 7320 3d20 536f 7274 6564 4469 6374  ers = SortedDict
-0001eca0: 2829 0a0a 2020 2020 2020 2020 686f 7374  ()..        host
-0001ecb0: 5f69 6e66 6f20 3d20 7b7d 0a20 2020 2020  _info = {}.     
-0001ecc0: 2020 2072 6573 6f75 7263 6573 203d 207b     resources = {
-0001ecd0: 7d0a 2020 2020 2020 2020 616c 6961 7365  }.        aliase
-0001ece0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-0001ecf0: 7365 6c66 2e5f 776f 726b 6572 5f63 6f6c  self._worker_col
-0001ed00: 6c65 6374 696f 6e73 203d 205b 0a20 2020  lections = [.   
-0001ed10: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0001ed20: 2c0a 2020 2020 2020 2020 2020 2020 686f  ,.            ho
-0001ed30: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
-0001ed40: 2020 2020 2072 6573 6f75 7263 6573 2c0a       resources,.
-0001ed50: 2020 2020 2020 2020 2020 2020 616c 6961              alia
-0001ed60: 7365 732c 0a20 2020 2020 2020 205d 0a0a  ses,.        ]..
-0001ed70: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
-0001ed80: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
-0001ed90: 7428 0a20 2020 2020 2020 2020 2020 2070  t(.            p
-0001eda0: 6172 7469 616c 280a 2020 2020 2020 2020  artial(.        
-0001edb0: 2020 2020 2020 2020 6465 7175 652c 206d          deque, m
-0001edc0: 6178 6c65 6e3d 6461 736b 2e63 6f6e 6669  axlen=dask.confi
-0001edd0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0001ede0: 6564 2e73 6368 6564 756c 6572 2e65 7665  ed.scheduler.eve
-0001edf0: 6e74 732d 6c6f 672d 6c65 6e67 7468 2229  nts-log-length")
-0001ee00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001ee10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001ee20: 2073 656c 662e 6576 656e 745f 636f 756e   self.event_coun
-0001ee30: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
-0001ee40: 2869 6e74 290a 2020 2020 2020 2020 7365  (int).        se
-0001ee50: 6c66 2e65 7665 6e74 5f73 7562 7363 7269  lf.event_subscri
-0001ee60: 6265 7220 3d20 6465 6661 756c 7464 6963  ber = defaultdic
-0001ee70: 7428 7365 7429 0a20 2020 2020 2020 2073  t(set).        s
-0001ee80: 656c 662e 776f 726b 6572 5f70 6c75 6769  elf.worker_plugi
-0001ee90: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
-0001eea0: 7365 6c66 2e6e 616e 6e79 5f70 6c75 6769  self.nanny_plugi
-0001eeb0: 6e73 203d 207b 7d0a 0a20 2020 2020 2020  ns = {}..       
-0001eec0: 2077 6f72 6b65 725f 6861 6e64 6c65 7273   worker_handlers
-0001eed0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001eee0: 2022 7461 736b 2d66 696e 6973 6865 6422   "task-finished"
-0001eef0: 3a20 7365 6c66 2e68 616e 646c 655f 7461  : self.handle_ta
-0001ef00: 736b 5f66 696e 6973 6865 642c 0a20 2020  sk_finished,.   
-0001ef10: 2020 2020 2020 2020 2022 7461 736b 2d65           "task-e
-0001ef20: 7272 6564 223a 2073 656c 662e 6861 6e64  rred": self.hand
-0001ef30: 6c65 5f74 6173 6b5f 6572 7265 642c 0a20  le_task_erred,. 
-0001ef40: 2020 2020 2020 2020 2020 2022 7265 6c65             "rele
-0001ef50: 6173 652d 776f 726b 6572 2d64 6174 6122  ase-worker-data"
-0001ef60: 3a20 7365 6c66 2e72 656c 6561 7365 5f77  : self.release_w
-0001ef70: 6f72 6b65 725f 6461 7461 2c0a 2020 2020  orker_data,.    
-0001ef80: 2020 2020 2020 2020 2261 6464 2d6b 6579          "add-key
-0001ef90: 7322 3a20 7365 6c66 2e61 6464 5f6b 6579  s": self.add_key
-0001efa0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001efb0: 6c6f 6e67 2d72 756e 6e69 6e67 223a 2073  long-running": s
-0001efc0: 656c 662e 6861 6e64 6c65 5f6c 6f6e 675f  elf.handle_long_
-0001efd0: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
-0001efe0: 2020 2020 2022 7265 7363 6865 6475 6c65       "reschedule
-0001eff0: 223a 2073 656c 662e 5f72 6573 6368 6564  ": self._resched
-0001f000: 756c 652c 0a20 2020 2020 2020 2020 2020  ule,.           
-0001f010: 2022 6b65 6570 2d61 6c69 7665 223a 206c   "keep-alive": l
-0001f020: 616d 6264 6120 2a61 7267 732c 202a 2a6b  ambda *args, **k
-0001f030: 7761 7267 733a 204e 6f6e 652c 0a20 2020  wargs: None,.   
-0001f040: 2020 2020 2020 2020 2022 6c6f 672d 6576           "log-ev
-0001f050: 656e 7422 3a20 7365 6c66 2e6c 6f67 5f77  ent": self.log_w
-0001f060: 6f72 6b65 725f 6576 656e 742c 0a20 2020  orker_event,.   
-0001f070: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
-0001f080: 2d73 7461 7475 732d 6368 616e 6765 223a  -status-change":
-0001f090: 2073 656c 662e 6861 6e64 6c65 5f77 6f72   self.handle_wor
-0001f0a0: 6b65 725f 7374 6174 7573 5f63 6861 6e67  ker_status_chang
-0001f0b0: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-0001f0c0: 7265 7175 6573 742d 7265 6672 6573 682d  request-refresh-
-0001f0d0: 7768 6f2d 6861 7322 3a20 7365 6c66 2e68  who-has": self.h
-0001f0e0: 616e 646c 655f 7265 7175 6573 745f 7265  andle_request_re
-0001f0f0: 6672 6573 685f 7768 6f5f 6861 732c 0a20  fresh_who_has,. 
-0001f100: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0001f110: 2020 636c 6965 6e74 5f68 616e 646c 6572    client_handler
-0001f120: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-0001f130: 2020 2275 7064 6174 652d 6772 6170 6822    "update-graph"
-0001f140: 3a20 7365 6c66 2e75 7064 6174 655f 6772  : self.update_gr
-0001f150: 6170 682c 0a20 2020 2020 2020 2020 2020  aph,.           
-0001f160: 2022 636c 6965 6e74 2d64 6573 6972 6573   "client-desires
-0001f170: 2d6b 6579 7322 3a20 7365 6c66 2e63 6c69  -keys": self.cli
-0001f180: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
-0001f190: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-0001f1a0: 7064 6174 652d 6461 7461 223a 2073 656c  pdate-data": sel
-0001f1b0: 662e 7570 6461 7465 5f64 6174 612c 0a20  f.update_data,. 
-0001f1c0: 2020 2020 2020 2020 2020 2022 7265 706f             "repo
-0001f1d0: 7274 2d6b 6579 223a 2073 656c 662e 7265  rt-key": self.re
-0001f1e0: 706f 7274 5f6f 6e5f 6b65 792c 0a20 2020  port_on_key,.   
-0001f1f0: 2020 2020 2020 2020 2022 636c 6965 6e74           "client
-0001f200: 2d72 656c 6561 7365 732d 6b65 7973 223a  -releases-keys":
-0001f210: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
-0001f220: 6561 7365 735f 6b65 7973 2c0a 2020 2020  eases_keys,.    
-0001f230: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
-0001f240: 6174 2d63 6c69 656e 7422 3a20 7365 6c66  at-client": self
-0001f250: 2e63 6c69 656e 745f 6865 6172 7462 6561  .client_heartbea
-0001f260: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-0001f270: 636c 6f73 652d 636c 6965 6e74 223a 2073  close-client": s
-0001f280: 656c 662e 7265 6d6f 7665 5f63 6c69 656e  elf.remove_clien
-0001f290: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-0001f2a0: 7375 6273 6372 6962 652d 746f 7069 6322  subscribe-topic"
-0001f2b0: 3a20 7365 6c66 2e73 7562 7363 7269 6265  : self.subscribe
-0001f2c0: 5f74 6f70 6963 2c0a 2020 2020 2020 2020  _topic,.        
-0001f2d0: 2020 2020 2275 6e73 7562 7363 7269 6265      "unsubscribe
-0001f2e0: 2d74 6f70 6963 223a 2073 656c 662e 756e  -topic": self.un
-0001f2f0: 7375 6273 6372 6962 655f 746f 7069 632c  subscribe_topic,
-0001f300: 0a20 2020 2020 2020 2020 2020 2022 6361  .            "ca
-0001f310: 6e63 656c 2d6b 6579 7322 3a20 7365 6c66  ncel-keys": self
-0001f320: 2e73 7469 6d75 6c75 735f 6361 6e63 656c  .stimulus_cancel
-0001f330: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-0001f340: 2020 2020 2073 656c 662e 6861 6e64 6c65       self.handle
-0001f350: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
-0001f360: 2020 2022 7265 6769 7374 6572 2d63 6c69     "register-cli
-0001f370: 656e 7422 3a20 7365 6c66 2e61 6464 5f63  ent": self.add_c
-0001f380: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-0001f390: 2020 2022 7363 6174 7465 7222 3a20 7365     "scatter": se
-0001f3a0: 6c66 2e73 6361 7474 6572 2c0a 2020 2020  lf.scatter,.    
-0001f3b0: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
-0001f3c0: 722d 776f 726b 6572 223a 2073 656c 662e  r-worker": self.
-0001f3d0: 6164 645f 776f 726b 6572 2c0a 2020 2020  add_worker,.    
-0001f3e0: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
-0001f3f0: 725f 6e61 6e6e 7922 3a20 7365 6c66 2e61  r_nanny": self.a
-0001f400: 6464 5f6e 616e 6e79 2c0a 2020 2020 2020  dd_nanny,.      
-0001f410: 2020 2020 2020 2275 6e72 6567 6973 7465        "unregiste
-0001f420: 7222 3a20 7365 6c66 2e72 656d 6f76 655f  r": self.remove_
-0001f430: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
-0001f440: 2020 2020 2267 6174 6865 7222 3a20 7365      "gather": se
-0001f450: 6c66 2e67 6174 6865 722c 0a20 2020 2020  lf.gather,.     
-0001f460: 2020 2020 2020 2022 7265 7472 7922 3a20         "retry": 
-0001f470: 7365 6c66 2e73 7469 6d75 6c75 735f 7265  self.stimulus_re
-0001f480: 7472 792c 0a20 2020 2020 2020 2020 2020  try,.           
-0001f490: 2022 6665 6564 223a 2073 656c 662e 6665   "feed": self.fe
-0001f4a0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-0001f4b0: 2274 6572 6d69 6e61 7465 223a 2073 656c  "terminate": sel
-0001f4c0: 662e 636c 6f73 652c 0a20 2020 2020 2020  f.close,.       
-0001f4d0: 2020 2020 2022 6272 6f61 6463 6173 7422       "broadcast"
-0001f4e0: 3a20 7365 6c66 2e62 726f 6164 6361 7374  : self.broadcast
-0001f4f0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
-0001f500: 726f 7879 223a 2073 656c 662e 7072 6f78  roxy": self.prox
-0001f510: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-0001f520: 6e63 6f72 6573 223a 2073 656c 662e 6765  ncores": self.ge
-0001f530: 745f 6e63 6f72 6573 2c0a 2020 2020 2020  t_ncores,.      
-0001f540: 2020 2020 2020 226e 636f 7265 735f 7275        "ncores_ru
-0001f550: 6e6e 696e 6722 3a20 7365 6c66 2e67 6574  nning": self.get
-0001f560: 5f6e 636f 7265 735f 7275 6e6e 696e 672c  _ncores_running,
-0001f570: 0a20 2020 2020 2020 2020 2020 2022 6861  .            "ha
-0001f580: 735f 7768 6174 223a 2073 656c 662e 6765  s_what": self.ge
-0001f590: 745f 6861 735f 7768 6174 2c0a 2020 2020  t_has_what,.    
-0001f5a0: 2020 2020 2020 2020 2277 686f 5f68 6173          "who_has
-0001f5b0: 223a 2073 656c 662e 6765 745f 7768 6f5f  ": self.get_who_
-0001f5c0: 6861 732c 0a20 2020 2020 2020 2020 2020  has,.           
-0001f5d0: 2022 7072 6f63 6573 7369 6e67 223a 2073   "processing": s
-0001f5e0: 656c 662e 6765 745f 7072 6f63 6573 7369  elf.get_processi
-0001f5f0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-0001f600: 2263 616c 6c5f 7374 6163 6b22 3a20 7365  "call_stack": se
-0001f610: 6c66 2e67 6574 5f63 616c 6c5f 7374 6163  lf.get_call_stac
-0001f620: 6b2c 0a20 2020 2020 2020 2020 2020 2022  k,.            "
-0001f630: 7072 6f66 696c 6522 3a20 7365 6c66 2e67  profile": self.g
-0001f640: 6574 5f70 726f 6669 6c65 2c0a 2020 2020  et_profile,.    
-0001f650: 2020 2020 2020 2020 2270 6572 666f 726d          "perform
-0001f660: 616e 6365 5f72 6570 6f72 7422 3a20 7365  ance_report": se
-0001f670: 6c66 2e70 6572 666f 726d 616e 6365 5f72  lf.performance_r
-0001f680: 6570 6f72 742c 0a20 2020 2020 2020 2020  eport,.         
-0001f690: 2020 2022 6765 745f 6c6f 6773 223a 2073     "get_logs": s
-0001f6a0: 656c 662e 6765 745f 6c6f 6773 2c0a 2020  elf.get_logs,.  
-0001f6b0: 2020 2020 2020 2020 2020 226c 6f67 7322            "logs"
-0001f6c0: 3a20 7365 6c66 2e67 6574 5f6c 6f67 732c  : self.get_logs,
-0001f6d0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
-0001f6e0: 726b 6572 5f6c 6f67 7322 3a20 7365 6c66  rker_logs": self
-0001f6f0: 2e67 6574 5f77 6f72 6b65 725f 6c6f 6773  .get_worker_logs
-0001f700: 2c0a 2020 2020 2020 2020 2020 2020 226c  ,.            "l
-0001f710: 6f67 5f65 7665 6e74 223a 2073 656c 662e  og_event": self.
-0001f720: 6c6f 675f 6576 656e 742c 0a20 2020 2020  log_event,.     
-0001f730: 2020 2020 2020 2022 6576 656e 7473 223a         "events":
-0001f740: 2073 656c 662e 6765 745f 6576 656e 7473   self.get_events
-0001f750: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-0001f760: 6279 7465 7322 3a20 7365 6c66 2e67 6574  bytes": self.get
-0001f770: 5f6e 6279 7465 732c 0a20 2020 2020 2020  _nbytes,.       
-0001f780: 2020 2020 2022 7665 7273 696f 6e73 223a       "versions":
-0001f790: 2073 656c 662e 7665 7273 696f 6e73 2c0a   self.versions,.
-0001f7a0: 2020 2020 2020 2020 2020 2020 2261 6464              "add
-0001f7b0: 5f6b 6579 7322 3a20 7365 6c66 2e61 6464  _keys": self.add
-0001f7c0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
-0001f7d0: 2020 2022 7265 6261 6c61 6e63 6522 3a20     "rebalance": 
-0001f7e0: 7365 6c66 2e72 6562 616c 616e 6365 2c0a  self.rebalance,.
-0001f7f0: 2020 2020 2020 2020 2020 2020 2272 6570              "rep
-0001f800: 6c69 6361 7465 223a 2073 656c 662e 7265  licate": self.re
-0001f810: 706c 6963 6174 652c 0a20 2020 2020 2020  plicate,.       
-0001f820: 2020 2020 2022 7275 6e5f 6675 6e63 7469       "run_functi
-0001f830: 6f6e 223a 2073 656c 662e 7275 6e5f 6675  on": self.run_fu
-0001f840: 6e63 7469 6f6e 2c0a 2020 2020 2020 2020  nction,.        
-0001f850: 2020 2020 2272 6573 7461 7274 223a 2073      "restart": s
-0001f860: 656c 662e 7265 7374 6172 742c 0a20 2020  elf.restart,.   
-0001f870: 2020 2020 2020 2020 2022 7570 6461 7465           "update
-0001f880: 5f64 6174 6122 3a20 7365 6c66 2e75 7064  _data": self.upd
-0001f890: 6174 655f 6461 7461 2c0a 2020 2020 2020  ate_data,.      
-0001f8a0: 2020 2020 2020 2273 6574 5f72 6573 6f75        "set_resou
-0001f8b0: 7263 6573 223a 2073 656c 662e 6164 645f  rces": self.add_
-0001f8c0: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
-0001f8d0: 2020 2020 2020 2022 7265 7469 7265 5f77         "retire_w
-0001f8e0: 6f72 6b65 7273 223a 2073 656c 662e 7265  orkers": self.re
-0001f8f0: 7469 7265 5f77 6f72 6b65 7273 2c0a 2020  tire_workers,.  
-0001f900: 2020 2020 2020 2020 2020 2267 6574 5f6d            "get_m
-0001f910: 6574 6164 6174 6122 3a20 7365 6c66 2e67  etadata": self.g
-0001f920: 6574 5f6d 6574 6164 6174 612c 0a20 2020  et_metadata,.   
-0001f930: 2020 2020 2020 2020 2022 7365 745f 6d65           "set_me
-0001f940: 7461 6461 7461 223a 2073 656c 662e 7365  tadata": self.se
-0001f950: 745f 6d65 7461 6461 7461 2c0a 2020 2020  t_metadata,.    
-0001f960: 2020 2020 2020 2020 2273 6574 5f72 6573          "set_res
-0001f970: 7472 6963 7469 6f6e 7322 3a20 7365 6c66  trictions": self
-0001f980: 2e73 6574 5f72 6573 7472 6963 7469 6f6e  .set_restriction
-0001f990: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001f9a0: 6865 6172 7462 6561 745f 776f 726b 6572  heartbeat_worker
-0001f9b0: 223a 2073 656c 662e 6865 6172 7462 6561  ": self.heartbea
-0001f9c0: 745f 776f 726b 6572 2c0a 2020 2020 2020  t_worker,.      
-0001f9d0: 2020 2020 2020 2267 6574 5f74 6173 6b5f        "get_task_
-0001f9e0: 7374 6174 7573 223a 2073 656c 662e 6765  status": self.ge
-0001f9f0: 745f 7461 736b 5f73 7461 7475 732c 0a20  t_task_status,. 
-0001fa00: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-0001fa10: 7461 736b 5f73 7472 6561 6d22 3a20 7365  task_stream": se
-0001fa20: 6c66 2e67 6574 5f74 6173 6b5f 7374 7265  lf.get_task_stre
-0001fa30: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
-0001fa40: 2267 6574 5f74 6173 6b5f 7072 6566 6978  "get_task_prefix
-0001fa50: 5f73 7461 7465 7322 3a20 7365 6c66 2e67  _states": self.g
-0001fa60: 6574 5f74 6173 6b5f 7072 6566 6978 5f73  et_task_prefix_s
-0001fa70: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
-0001fa80: 2020 2022 7265 6769 7374 6572 5f73 6368     "register_sch
-0001fa90: 6564 756c 6572 5f70 6c75 6769 6e22 3a20  eduler_plugin": 
-0001faa0: 7365 6c66 2e72 6567 6973 7465 725f 7363  self.register_sc
-0001fab0: 6865 6475 6c65 725f 706c 7567 696e 2c0a  heduler_plugin,.
-0001fac0: 2020 2020 2020 2020 2020 2020 2272 6567              "reg
-0001fad0: 6973 7465 725f 776f 726b 6572 5f70 6c75  ister_worker_plu
-0001fae0: 6769 6e22 3a20 7365 6c66 2e72 6567 6973  gin": self.regis
-0001faf0: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
-0001fb00: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
-0001fb10: 756e 7265 6769 7374 6572 5f77 6f72 6b65  unregister_worke
-0001fb20: 725f 706c 7567 696e 223a 2073 656c 662e  r_plugin": self.
-0001fb30: 756e 7265 6769 7374 6572 5f77 6f72 6b65  unregister_worke
-0001fb40: 725f 706c 7567 696e 2c0a 2020 2020 2020  r_plugin,.      
-0001fb50: 2020 2020 2020 2272 6567 6973 7465 725f        "register_
-0001fb60: 6e61 6e6e 795f 706c 7567 696e 223a 2073  nanny_plugin": s
-0001fb70: 656c 662e 7265 6769 7374 6572 5f6e 616e  elf.register_nan
-0001fb80: 6e79 5f70 6c75 6769 6e2c 0a20 2020 2020  ny_plugin,.     
-0001fb90: 2020 2020 2020 2022 756e 7265 6769 7374         "unregist
-0001fba0: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e22  er_nanny_plugin"
-0001fbb0: 3a20 7365 6c66 2e75 6e72 6567 6973 7465  : self.unregiste
-0001fbc0: 725f 6e61 6e6e 795f 706c 7567 696e 2c0a  r_nanny_plugin,.
-0001fbd0: 2020 2020 2020 2020 2020 2020 2261 6461              "ada
-0001fbe0: 7074 6976 655f 7461 7267 6574 223a 2073  ptive_target": s
-0001fbf0: 656c 662e 6164 6170 7469 7665 5f74 6172  elf.adaptive_tar
-0001fc00: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
-0001fc10: 2022 776f 726b 6572 735f 746f 5f63 6c6f   "workers_to_clo
-0001fc20: 7365 223a 2073 656c 662e 776f 726b 6572  se": self.worker
-0001fc30: 735f 746f 5f63 6c6f 7365 2c0a 2020 2020  s_to_close,.    
-0001fc40: 2020 2020 2020 2020 2273 7562 7363 7269          "subscri
-0001fc50: 6265 5f77 6f72 6b65 725f 7374 6174 7573  be_worker_status
-0001fc60: 223a 2073 656c 662e 7375 6273 6372 6962  ": self.subscrib
-0001fc70: 655f 776f 726b 6572 5f73 7461 7475 732c  e_worker_status,
-0001fc80: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-0001fc90: 6172 745f 7461 736b 5f6d 6574 6164 6174  art_task_metadat
-0001fca0: 6122 3a20 7365 6c66 2e73 7461 7274 5f74  a": self.start_t
-0001fcb0: 6173 6b5f 6d65 7461 6461 7461 2c0a 2020  ask_metadata,.  
-0001fcc0: 2020 2020 2020 2020 2020 2273 746f 705f            "stop_
-0001fcd0: 7461 736b 5f6d 6574 6164 6174 6122 3a20  task_metadata": 
-0001fce0: 7365 6c66 2e73 746f 705f 7461 736b 5f6d  self.stop_task_m
-0001fcf0: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-0001fd00: 2020 2020 2022 6765 745f 636c 7573 7465       "get_cluste
-0001fd10: 725f 7374 6174 6522 3a20 7365 6c66 2e67  r_state": self.g
-0001fd20: 6574 5f63 6c75 7374 6572 5f73 7461 7465  et_cluster_state
-0001fd30: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
-0001fd40: 756d 705f 636c 7573 7465 725f 7374 6174  ump_cluster_stat
-0001fd50: 655f 746f 5f75 726c 223a 2073 656c 662e  e_to_url": self.
-0001fd60: 6475 6d70 5f63 6c75 7374 6572 5f73 7461  dump_cluster_sta
-0001fd70: 7465 5f74 6f5f 7572 6c2c 0a20 2020 2020  te_to_url,.     
-0001fd80: 2020 2020 2020 2022 6265 6e63 686d 6172         "benchmar
-0001fd90: 6b5f 6861 7264 7761 7265 223a 2073 656c  k_hardware": sel
-0001fda0: 662e 6265 6e63 686d 6172 6b5f 6861 7264  f.benchmark_hard
-0001fdb0: 7761 7265 2c0a 2020 2020 2020 2020 2020  ware,.          
-0001fdc0: 2020 2267 6574 5f73 746f 7279 223a 2073    "get_story": s
-0001fdd0: 656c 662e 6765 745f 7374 6f72 792c 0a20  elf.get_story,. 
-0001fde0: 2020 2020 2020 2020 2020 2022 6368 6563             "chec
-0001fdf0: 6b5f 6964 6c65 223a 2073 656c 662e 6368  k_idle": self.ch
-0001fe00: 6563 6b5f 6964 6c65 2c0a 2020 2020 2020  eck_idle,.      
-0001fe10: 2020 7d0a 0a20 2020 2020 2020 2063 6f6e    }..        con
-0001fe20: 6e65 6374 696f 6e5f 6c69 6d69 7420 3d20  nection_limit = 
-0001fe30: 6765 745f 6669 6c65 6e6f 5f6c 696d 6974  get_fileno_limit
-0001fe40: 2829 202f 2032 0a0a 2020 2020 2020 2020  () / 2..        
-0001fe50: 5363 6865 6475 6c65 7253 7461 7465 2e5f  SchedulerState._
-0001fe60: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
-0001fe70: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001fe80: 2020 2020 2020 2061 6c69 6173 6573 3d61         aliases=a
-0001fe90: 6c69 6173 6573 2c0a 2020 2020 2020 2020  liases,.        
-0001fea0: 2020 2020 636c 6965 6e74 733d 636c 6965      clients=clie
-0001feb0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
-0001fec0: 2077 6f72 6b65 7273 3d77 6f72 6b65 7273   workers=workers
-0001fed0: 2c0a 2020 2020 2020 2020 2020 2020 686f  ,.            ho
-0001fee0: 7374 5f69 6e66 6f3d 686f 7374 5f69 6e66  st_info=host_inf
-0001fef0: 6f2c 0a20 2020 2020 2020 2020 2020 2072  o,.            r
-0001ff00: 6573 6f75 7263 6573 3d72 6573 6f75 7263  esources=resourc
-0001ff10: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0001ff20: 7461 736b 733d 7461 736b 732c 0a20 2020  tasks=tasks,.   
-0001ff30: 2020 2020 2020 2020 2075 6e72 756e 6e61           unrunna
-0001ff40: 626c 653d 756e 7275 6e6e 6162 6c65 2c0a  ble=unrunnable,.
-0001ff50: 2020 2020 2020 2020 2020 2020 7175 6575              queu
-0001ff60: 6564 3d71 7565 7565 642c 0a20 2020 2020  ed=queued,.     
-0001ff70: 2020 2020 2020 2076 616c 6964 6174 653d         validate=
-0001ff80: 7661 6c69 6461 7465 2c0a 2020 2020 2020  validate,.      
-0001ff90: 2020 2020 2020 706c 7567 696e 733d 706c        plugins=pl
-0001ffa0: 7567 696e 732c 0a20 2020 2020 2020 2020  ugins,.         
-0001ffb0: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
-0001ffc0: 756e 7465 725f 6d61 783d 7472 616e 7369  unter_max=transi
-0001ffd0: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-0001ffe0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001fff0: 2020 2020 5365 7276 6572 4e6f 6465 2e5f      ServerNode._
-00020000: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
-00020010: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00020020: 2020 2020 2020 2068 616e 646c 6572 733d         handlers=
-00020030: 7365 6c66 2e68 616e 646c 6572 732c 0a20  self.handlers,. 
-00020040: 2020 2020 2020 2020 2020 2073 7472 6561             strea
-00020050: 6d5f 6861 6e64 6c65 7273 3d6d 6572 6765  m_handlers=merge
-00020060: 2877 6f72 6b65 725f 6861 6e64 6c65 7273  (worker_handlers
-00020070: 2c20 636c 6965 6e74 5f68 616e 646c 6572  , client_handler
-00020080: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00020090: 636f 6e6e 6563 7469 6f6e 5f6c 696d 6974  connection_limit
-000200a0: 3d63 6f6e 6e65 6374 696f 6e5f 6c69 6d69  =connection_limi
-000200b0: 742c 0a20 2020 2020 2020 2020 2020 2064  t,.            d
-000200c0: 6573 6572 6961 6c69 7a65 3d46 616c 7365  eserialize=False
-000200d0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
-000200e0: 6e6e 6563 7469 6f6e 5f61 7267 733d 7365  nnection_args=se
-000200f0: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
-00020100: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
-00020110: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-00020120: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-00020130: 7365 6c66 2e77 6f72 6b65 725f 7474 6c3a  self.worker_ttl:
-00020140: 0a20 2020 2020 2020 2020 2020 2070 6320  .            pc 
-00020150: 3d20 5065 7269 6f64 6963 4361 6c6c 6261  = PeriodicCallba
-00020160: 636b 2873 656c 662e 6368 6563 6b5f 776f  ck(self.check_wo
-00020170: 726b 6572 5f74 746c 2c20 7365 6c66 2e77  rker_ttl, self.w
-00020180: 6f72 6b65 725f 7474 6c20 2a20 3130 3030  orker_ttl * 1000
-00020190: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000201a0: 6c66 2e70 6572 696f 6469 635f 6361 6c6c  lf.periodic_call
-000201b0: 6261 636b 735b 2277 6f72 6b65 722d 7474  backs["worker-tt
-000201c0: 6c22 5d20 3d20 7063 0a0a 2020 2020 2020  l"] = pc..      
-000201d0: 2020 7063 203d 2050 6572 696f 6469 6343    pc = PeriodicC
-000201e0: 616c 6c62 6163 6b28 7365 6c66 2e63 6865  allback(self.che
-000201f0: 636b 5f69 646c 652c 2028 7365 6c66 2e69  ck_idle, (self.i
-00020200: 646c 655f 7469 6d65 6f75 7420 6f72 2031  dle_timeout or 1
-00020210: 2920 2a20 3130 3030 202f 2034 290a 2020  ) * 1000 / 4).  
-00020220: 2020 2020 2020 7365 6c66 2e70 6572 696f        self.perio
-00020230: 6469 635f 6361 6c6c 6261 636b 735b 2269  dic_callbacks["i
-00020240: 646c 652d 7469 6d65 6f75 7422 5d20 3d20  dle-timeout"] = 
-00020250: 7063 0a0a 2020 2020 2020 2020 6966 2065  pc..        if e
-00020260: 7874 656e 7369 6f6e 7320 6973 204e 6f6e  xtensions is Non
-00020270: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
-00020280: 7874 656e 7369 6f6e 7320 3d20 4445 4641  xtensions = DEFA
-00020290: 554c 545f 4558 5445 4e53 494f 4e53 2e63  ULT_EXTENSIONS.c
-000202a0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-000202b0: 2020 6966 206e 6f74 2064 6173 6b2e 636f    if not dask.co
-000202c0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-000202d0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-000202e0: 776f 726b 2d73 7465 616c 696e 6722 293a  work-stealing"):
-000202f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020300: 2069 6620 2273 7465 616c 696e 6722 2069   if "stealing" i
-00020310: 6e20 6578 7465 6e73 696f 6e73 3a0a 2020  n extensions:.  
-00020320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020330: 2020 6465 6c20 6578 7465 6e73 696f 6e73    del extensions
-00020340: 5b22 7374 6561 6c69 6e67 225d 0a0a 2020  ["stealing"]..  
-00020350: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
-00020360: 6578 7465 6e73 696f 6e20 696e 2065 7874  extension in ext
-00020370: 656e 7369 6f6e 732e 6974 656d 7328 293a  ensions.items():
-00020380: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00020390: 662e 6578 7465 6e73 696f 6e73 5b6e 616d  f.extensions[nam
-000203a0: 655d 203d 2065 7874 656e 7369 6f6e 2873  e] = extension(s
-000203b0: 656c 6629 0a0a 2020 2020 2020 2020 7365  elf)..        se
-000203c0: 7470 726f 6374 6974 6c65 2822 6461 736b  tproctitle("dask
-000203d0: 2073 6368 6564 756c 6572 205b 6e6f 7420   scheduler [not 
-000203e0: 7374 6172 7465 645d 2229 0a20 2020 2020  started]").     
-000203f0: 2020 2053 6368 6564 756c 6572 2e5f 696e     Scheduler._in
-00020400: 7374 616e 6365 732e 6164 6428 7365 6c66  stances.add(self
-00020410: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-00020420: 7063 2e61 6c6c 6f77 5f6f 6666 6c6f 6164  pc.allow_offload
-00020430: 203d 2046 616c 7365 0a0a 2020 2020 2323   = False..    ##
-00020440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020450: 0a20 2020 2023 2041 646d 696e 6973 7472  .    # Administr
-00020460: 6174 696f 6e20 230a 2020 2020 2323 2323  ation #.    ####
-00020470: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-00020480: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-00020490: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000204a0: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
-000204b0: 2020 2020 2066 223c 5363 6865 6475 6c65       f"<Schedule
-000204c0: 7220 7b73 656c 662e 6164 6472 6573 735f  r {self.address_
-000204d0: 7361 6665 2172 7d2c 2022 0a20 2020 2020  safe!r}, ".     
-000204e0: 2020 2020 2020 2066 2277 6f72 6b65 7273         f"workers
-000204f0: 3a20 7b6c 656e 2873 656c 662e 776f 726b  : {len(self.work
-00020500: 6572 7329 7d2c 2022 0a20 2020 2020 2020  ers)}, ".       
-00020510: 2020 2020 2066 2263 6f72 6573 3a20 7b73       f"cores: {s
-00020520: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-00020530: 6473 7d2c 2022 0a20 2020 2020 2020 2020  ds}, ".         
-00020540: 2020 2066 2274 6173 6b73 3a20 7b6c 656e     f"tasks: {len
-00020550: 2873 656c 662e 7461 736b 7329 7d3e 220a  (self.tasks)}>".
-00020560: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00020570: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
-00020580: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00020590: 7475 726e 2067 6574 5f74 656d 706c 6174  turn get_templat
-000205a0: 6528 2273 6368 6564 756c 6572 2e68 746d  e("scheduler.htm
-000205b0: 6c2e 6a32 2229 2e72 656e 6465 7228 0a20  l.j2").render(. 
-000205c0: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-000205d0: 7373 3d73 656c 662e 6164 6472 6573 732c  ss=self.address,
-000205e0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-000205f0: 6b65 7273 3d73 656c 662e 776f 726b 6572  kers=self.worker
-00020600: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
-00020610: 6872 6561 6473 3d73 656c 662e 746f 7461  hreads=self.tota
-00020620: 6c5f 6e74 6872 6561 6473 2c0a 2020 2020  l_nthreads,.    
-00020630: 2020 2020 2020 2020 7461 736b 733d 7365          tasks=se
-00020640: 6c66 2e74 6173 6b73 2c0a 2020 2020 2020  lf.tasks,.      
-00020650: 2020 290a 0a20 2020 2064 6566 2069 6465    )..    def ide
-00020660: 6e74 6974 7928 7365 6c66 293a 0a20 2020  ntity(self):.   
-00020670: 2020 2020 2022 2222 4261 7369 6320 696e       """Basic in
-00020680: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
-00020690: 6f75 7273 656c 7665 7320 616e 6420 6f75  ourselves and ou
-000206a0: 7220 636c 7573 7465 7222 2222 0a20 2020  r cluster""".   
-000206b0: 2020 2020 2064 203d 207b 0a20 2020 2020       d = {.     
-000206c0: 2020 2020 2020 2022 7479 7065 223a 2074         "type": t
-000206d0: 7970 6528 7365 6c66 292e 5f5f 6e61 6d65  ype(self).__name
-000206e0: 5f5f 2c0a 2020 2020 2020 2020 2020 2020  __,.            
-000206f0: 2269 6422 3a20 7374 7228 7365 6c66 2e69  "id": str(self.i
-00020700: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-00020710: 2261 6464 7265 7373 223a 2073 656c 662e  "address": self.
-00020720: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-00020730: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
-00020740: 207b 6b65 793a 2076 2e70 6f72 7420 666f   {key: v.port fo
-00020750: 7220 286b 6579 2c20 7629 2069 6e20 7365  r (key, v) in se
-00020760: 6c66 2e73 6572 7669 6365 732e 6974 656d  lf.services.item
-00020770: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
-00020780: 2020 2273 7461 7274 6564 223a 2073 656c    "started": sel
-00020790: 662e 7469 6d65 5f73 7461 7274 6564 2c0a  f.time_started,.
-000207a0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-000207b0: 6b65 7273 223a 207b 0a20 2020 2020 2020  kers": {.       
-000207c0: 2020 2020 2020 2020 2077 6f72 6b65 722e           worker.
-000207d0: 6164 6472 6573 733a 2077 6f72 6b65 722e  address: worker.
-000207e0: 6964 656e 7469 7479 2829 2066 6f72 2077  identity() for w
-000207f0: 6f72 6b65 7220 696e 2073 656c 662e 776f  orker in self.wo
-00020800: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-00020810: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00020820: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00020830: 7265 7475 726e 2064 0a0a 2020 2020 6465  return d..    de
-00020840: 6620 5f74 6f5f 6469 6374 2873 656c 662c  f _to_dict(self,
-00020850: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
-00020860: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
-00020870: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
-00020880: 2020 2022 2222 4469 6374 696f 6e61 7279     """Dictionary
-00020890: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-000208a0: 666f 7220 6465 6275 6767 696e 6720 7075  for debugging pu
-000208b0: 7270 6f73 6573 2e0a 2020 2020 2020 2020  rposes..        
-000208c0: 4e6f 7420 7479 7065 2073 7461 626c 6520  Not type stable 
-000208d0: 616e 6420 6e6f 7420 696e 7465 6e64 6564  and not intended
-000208e0: 2066 6f72 2072 6f75 6e64 7472 6970 732e   for roundtrips.
-000208f0: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
-00020900: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-00020910: 2d2d 2d0a 2020 2020 2020 2020 5365 7276  ---.        Serv
-00020920: 6572 2e69 6465 6e74 6974 790a 2020 2020  er.identity.    
-00020930: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
-00020940: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
-00020950: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-00020960: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
-00020970: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
-00020980: 2020 2222 220a 2020 2020 2020 2020 696e    """.        in
-00020990: 666f 203d 2073 7570 6572 2829 2e5f 746f  fo = super()._to
-000209a0: 5f64 6963 7428 6578 636c 7564 653d 6578  _dict(exclude=ex
-000209b0: 636c 7564 6529 0a20 2020 2020 2020 2065  clude).        e
-000209c0: 7874 7261 203d 207b 0a20 2020 2020 2020  xtra = {.       
-000209d0: 2020 2020 2022 7472 616e 7369 7469 6f6e       "transition
-000209e0: 5f6c 6f67 223a 2073 656c 662e 7472 616e  _log": self.tran
-000209f0: 7369 7469 6f6e 5f6c 6f67 2c0a 2020 2020  sition_log,.    
-00020a00: 2020 2020 2020 2020 2274 7261 6e73 6974          "transit
-00020a10: 696f 6e5f 636f 756e 7465 7222 3a20 7365  ion_counter": se
-00020a20: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
-00020a30: 756e 7465 722c 0a20 2020 2020 2020 2020  unter,.         
-00020a40: 2020 2022 7461 736b 7322 3a20 7365 6c66     "tasks": self
-00020a50: 2e74 6173 6b73 2c0a 2020 2020 2020 2020  .tasks,.        
-00020a60: 2020 2020 2274 6173 6b5f 6772 6f75 7073      "task_groups
-00020a70: 223a 2073 656c 662e 7461 736b 5f67 726f  ": self.task_gro
-00020a80: 7570 732c 0a20 2020 2020 2020 2020 2020  ups,.           
-00020a90: 2023 204f 7665 7277 7269 7465 2064 6963   # Overwrite dic
-00020aa0: 7420 6f66 2057 6f72 6b65 7253 7461 7465  t of WorkerState
-00020ab0: 2e69 6465 6e74 6974 7920 6672 6f6d 2069  .identity from i
-00020ac0: 6e66 6f0a 2020 2020 2020 2020 2020 2020  nfo.            
-00020ad0: 2277 6f72 6b65 7273 223a 2073 656c 662e  "workers": self.
-00020ae0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-00020af0: 2020 2020 2022 636c 6965 6e74 7322 3a20       "clients": 
-00020b00: 7365 6c66 2e63 6c69 656e 7473 2c0a 2020  self.clients,.  
-00020b10: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00020b20: 7922 3a20 7365 6c66 2e6d 656d 6f72 792c  y": self.memory,
-00020b30: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
-00020b40: 656e 7473 223a 2073 656c 662e 6576 656e  ents": self.even
-00020b50: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
-00020b60: 2265 7874 656e 7369 6f6e 7322 3a20 7365  "extensions": se
-00020b70: 6c66 2e65 7874 656e 7369 6f6e 732c 0a20  lf.extensions,. 
-00020b80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00020b90: 2065 7874 7261 203d 207b 6b3a 2076 2066   extra = {k: v f
-00020ba0: 6f72 206b 2c20 7620 696e 2065 7874 7261  or k, v in extra
-00020bb0: 2e69 7465 6d73 2829 2069 6620 6b20 6e6f  .items() if k no
-00020bc0: 7420 696e 2065 7863 6c75 6465 7d0a 2020  t in exclude}.  
-00020bd0: 2020 2020 2020 696e 666f 2e75 7064 6174        info.updat
-00020be0: 6528 7265 6375 7273 6976 655f 746f 5f64  e(recursive_to_d
-00020bf0: 6963 7428 6578 7472 612c 2065 7863 6c75  ict(extra, exclu
-00020c00: 6465 3d65 7863 6c75 6465 2929 0a20 2020  de=exclude)).   
-00020c10: 2020 2020 2072 6574 7572 6e20 696e 666f       return info
-00020c20: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00020c30: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
-00020c40: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-00020c50: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-00020c60: 3a20 2243 6f6c 6c65 6374 696f 6e5b 7374  : "Collection[st
-00020c70: 725d 222c 0a20 2020 2029 202d 3e20 6469  r]",.    ) -> di
-00020c80: 6374 3a0a 2020 2020 2020 2020 2250 726f  ct:.        "Pro
-00020c90: 6475 6365 2074 6865 2073 7461 7465 2064  duce the state d
-00020ca0: 6963 7420 7573 6564 2069 6e20 6120 636c  ict used in a cl
-00020cb0: 7573 7465 7220 7374 6174 6520 6475 6d70  uster state dump
-00020cc0: 220a 2020 2020 2020 2020 2320 4b69 636b  ".        # Kick
-00020cd0: 206f 6666 2073 7461 7465 2d64 756d 7069   off state-dumpi
-00020ce0: 6e67 206f 6e20 776f 726b 6572 7320 6265  ng on workers be
-00020cf0: 666f 7265 2077 6520 626c 6f63 6b20 7468  fore we block th
-00020d00: 6520 6576 656e 7420 6c6f 6f70 2069 6e20  e event loop in 
-00020d10: 6073 656c 662e 5f74 6f5f 6469 6374 602e  `self._to_dict`.
-00020d20: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-00020d30: 5f66 7574 7572 6520 3d20 6173 796e 6369  _future = asynci
-00020d40: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00020d50: 2020 2020 2020 7365 6c66 2e62 726f 6164        self.broad
-00020d60: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
-00020d70: 2020 2020 2020 6d73 673d 7b22 6f70 223a        msg={"op":
-00020d80: 2022 6475 6d70 5f73 7461 7465 222c 2022   "dump_state", "
-00020d90: 6578 636c 7564 6522 3a20 6578 636c 7564  exclude": exclud
-00020da0: 657d 2c0a 2020 2020 2020 2020 2020 2020  e},.            
-00020db0: 2020 2020 6f6e 5f65 7272 6f72 3d22 7265      on_error="re
-00020dc0: 7475 726e 222c 0a20 2020 2020 2020 2020  turn",.         
-00020dd0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00020de0: 2020 7365 6c66 2e62 726f 6164 6361 7374    self.broadcast
-00020df0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00020e00: 2020 6d73 673d 7b22 6f70 223a 2022 7665    msg={"op": "ve
-00020e10: 7273 696f 6e73 227d 2c0a 2020 2020 2020  rsions"},.      
-00020e20: 2020 2020 2020 2020 2020 6f6e 5f65 7272            on_err
-00020e30: 6f72 3d22 6967 6e6f 7265 222c 0a20 2020  or="ignore",.   
-00020e40: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00020e50: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
-00020e60: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00020e70: 6368 6564 756c 6572 5f73 7461 7465 203d  cheduler_state =
-00020e80: 2073 656c 662e 5f74 6f5f 6469 6374 2865   self._to_dict(e
-00020e90: 7863 6c75 6465 3d65 7863 6c75 6465 290a  xclude=exclude).
-00020ea0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-00020eb0: 6b65 725f 7374 6174 6573 2c20 776f 726b  ker_states, work
-00020ec0: 6572 5f76 6572 7369 6f6e 7320 3d20 6177  er_versions = aw
-00020ed0: 6169 7420 776f 726b 6572 735f 6675 7475  ait workers_futu
-00020ee0: 7265 0a20 2020 2020 2020 2066 696e 616c  re.        final
-00020ef0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-00020f00: 2320 456e 7375 7265 2074 6865 2074 6173  # Ensure the tas
-00020f10: 6b73 2061 7265 6e27 7420 6c65 6674 2072  ks aren't left r
-00020f20: 756e 6e69 6e67 2069 6620 616e 7974 6869  unning if anythi
-00020f30: 6e67 2066 6169 6c73 2e0a 2020 2020 2020  ng fails..      
-00020f40: 2020 2020 2020 2320 536f 6d65 6461 7920        # Someday 
-00020f50: 2870 7933 2e31 3129 2c20 7573 6520 6120  (py3.11), use a 
-00020f60: 7472 696f 2d73 7479 6c65 2054 6173 6b47  trio-style TaskG
-00020f70: 726f 7570 2066 6f72 2074 6869 732e 0a20  roup for this.. 
-00020f80: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00020f90: 7273 5f66 7574 7572 652e 6361 6e63 656c  rs_future.cancel
-00020fa0: 2829 0a0a 2020 2020 2020 2020 2320 436f  ()..        # Co
-00020fb0: 6e76 6572 7420 616e 7920 5250 4320 6572  nvert any RPC er
-00020fc0: 726f 7273 2074 6f20 7374 7269 6e67 730a  rors to strings.
-00020fd0: 2020 2020 2020 2020 776f 726b 6572 5f73          worker_s
-00020fe0: 7461 7465 7320 3d20 7b0a 2020 2020 2020  tates = {.      
-00020ff0: 2020 2020 2020 6b3a 2072 6570 7228 7629        k: repr(v)
-00021000: 2069 6620 6973 696e 7374 616e 6365 2876   if isinstance(v
-00021010: 2c20 4578 6365 7074 696f 6e29 2065 6c73  , Exception) els
-00021020: 6520 760a 2020 2020 2020 2020 2020 2020  e v.            
-00021030: 666f 7220 6b2c 2076 2069 6e20 776f 726b  for k, v in work
-00021040: 6572 5f73 7461 7465 732e 6974 656d 7328  er_states.items(
-00021050: 290a 2020 2020 2020 2020 7d0a 0a20 2020  ).        }..   
-00021060: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-00021070: 2020 2020 2020 2020 2020 2273 6368 6564            "sched
-00021080: 756c 6572 223a 2073 6368 6564 756c 6572  uler": scheduler
-00021090: 5f73 7461 7465 2c0a 2020 2020 2020 2020  _state,.        
-000210a0: 2020 2020 2277 6f72 6b65 7273 223a 2077      "workers": w
-000210b0: 6f72 6b65 725f 7374 6174 6573 2c0a 2020  orker_states,.  
-000210c0: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
-000210d0: 6f6e 7322 3a20 7b22 7363 6865 6475 6c65  ons": {"schedule
-000210e0: 7222 3a20 7365 6c66 2e76 6572 7369 6f6e  r": self.version
-000210f0: 7328 292c 2022 776f 726b 6572 7322 3a20  s(), "workers": 
-00021100: 776f 726b 6572 5f76 6572 7369 6f6e 737d  worker_versions}
-00021110: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-00021120: 2061 7379 6e63 2064 6566 2064 756d 705f   async def dump_
-00021130: 636c 7573 7465 725f 7374 6174 655f 746f  cluster_state_to
-00021140: 5f75 726c 280a 2020 2020 2020 2020 7365  _url(.        se
-00021150: 6c66 2c0a 2020 2020 2020 2020 7572 6c3a  lf,.        url:
-00021160: 2073 7472 2c0a 2020 2020 2020 2020 6578   str,.        ex
-00021170: 636c 7564 653a 2022 436f 6c6c 6563 7469  clude: "Collecti
-00021180: 6f6e 5b73 7472 5d22 2c0a 2020 2020 2020  on[str]",.      
-00021190: 2020 666f 726d 6174 3a20 4c69 7465 7261    format: Litera
-000211a0: 6c5b 226d 7367 7061 636b 222c 2022 7961  l["msgpack", "ya
-000211b0: 6d6c 225d 2c0a 2020 2020 2020 2020 2a2a  ml"],.        **
-000211c0: 7374 6f72 6167 655f 6f70 7469 6f6e 733a  storage_options:
-000211d0: 2064 6963 745b 7374 722c 2041 6e79 5d2c   dict[str, Any],
-000211e0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-000211f0: 2020 2020 2020 2020 2257 7269 7465 2061          "Write a
-00021200: 2063 6c75 7374 6572 2073 7461 7465 2064   cluster state d
-00021210: 756d 7020 746f 2061 6e20 6673 7370 6563  ump to an fsspec
-00021220: 2d63 6f6d 7061 7469 626c 6520 5552 4c2e  -compatible URL.
-00021230: 220a 2020 2020 2020 2020 6177 6169 7420  ".        await 
-00021240: 636c 7573 7465 725f 6475 6d70 2e77 7269  cluster_dump.wri
-00021250: 7465 5f73 7461 7465 280a 2020 2020 2020  te_state(.      
-00021260: 2020 2020 2020 7061 7274 6961 6c28 7365        partial(se
-00021270: 6c66 2e67 6574 5f63 6c75 7374 6572 5f73  lf.get_cluster_s
-00021280: 7461 7465 2c20 6578 636c 7564 6529 2c20  tate, exclude), 
-00021290: 7572 6c2c 2066 6f72 6d61 742c 202a 2a73  url, format, **s
-000212a0: 746f 7261 6765 5f6f 7074 696f 6e73 0a20  torage_options. 
-000212b0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000212c0: 6620 6765 745f 776f 726b 6572 5f73 6572  f get_worker_ser
-000212d0: 7669 6365 5f61 6464 7228 0a20 2020 2020  vice_addr(.     
-000212e0: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
-000212f0: 2073 7472 2c20 7365 7276 6963 655f 6e61   str, service_na
-00021300: 6d65 3a20 7374 722c 2070 726f 746f 636f  me: str, protoco
-00021310: 6c3a 2062 6f6f 6c20 3d20 4661 6c73 650a  l: bool = False.
-00021320: 2020 2020 2920 2d3e 2074 7570 6c65 5b73      ) -> tuple[s
-00021330: 7472 2c20 696e 745d 207c 2073 7472 207c  tr, int] | str |
-00021340: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00021350: 2222 0a20 2020 2020 2020 2047 6574 2074  "".        Get t
-00021360: 6865 2028 686f 7374 2c20 706f 7274 2920  he (host, port) 
-00021370: 6164 6472 6573 7320 6f66 2074 6865 206e  address of the n
-00021380: 616d 6564 2073 6572 7669 6365 206f 6e20  amed service on 
-00021390: 7468 6520 2a77 6f72 6b65 722a 2e0a 2020  the *worker*..  
-000213a0: 2020 2020 2020 5265 7475 726e 7320 4e6f        Returns No
-000213b0: 6e65 2069 6620 7468 6520 7365 7276 6963  ne if the servic
-000213c0: 6520 646f 6573 6e27 7420 6578 6973 742e  e doesn't exist.
-000213d0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-000213e0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-000213f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00021400: 776f 726b 6572 203a 2061 6464 7265 7373  worker : address
-00021410: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
-00021420: 5f6e 616d 6520 3a20 7374 720a 2020 2020  _name : str.    
-00021430: 2020 2020 2020 2020 436f 6d6d 6f6e 2073          Common s
-00021440: 6572 7669 6365 7320 696e 636c 7564 6520  ervices include 
-00021450: 2762 6f6b 6568 2720 616e 6420 276e 616e  'bokeh' and 'nan
-00021460: 6e79 270a 2020 2020 2020 2020 7072 6f74  ny'.        prot
-00021470: 6f63 6f6c 203a 2062 6f6f 6c65 616e 0a20  ocol : boolean. 
-00021480: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
-00021490: 6572 206f 7220 6e6f 7420 746f 2069 6e63  er or not to inc
-000214a0: 6c75 6465 2061 2066 756c 6c20 6164 6472  lude a full addr
-000214b0: 6573 7320 7769 7468 2070 726f 746f 636f  ess with protoco
-000214c0: 6c20 2854 7275 6529 0a20 2020 2020 2020  l (True).       
-000214d0: 2020 2020 206f 7220 6a75 7374 2061 2028       or just a (
-000214e0: 686f 7374 2c20 706f 7274 2920 7061 6972  host, port) pair
-000214f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00021500: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
-00021510: 6f72 6b65 7273 5b77 6f72 6b65 725d 0a20  orkers[worker]. 
-00021520: 2020 2020 2020 2070 6f72 7420 3d20 7773         port = ws
-00021530: 2e73 6572 7669 6365 732e 6765 7428 7365  .services.get(se
-00021540: 7276 6963 655f 6e61 6d65 290a 2020 2020  rvice_name).    
-00021550: 2020 2020 6966 2070 6f72 7420 6973 204e      if port is N
-00021560: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00021570: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00021580: 2020 2020 2065 6c69 6620 7072 6f74 6f63       elif protoc
-00021590: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-000215a0: 7265 7475 726e 2022 2528 7072 6f74 6f63  return "%(protoc
-000215b0: 6f6c 2973 3a2f 2f25 2868 6f73 7429 733a  ol)s://%(host)s:
-000215c0: 2528 706f 7274 2964 2220 2520 7b0a 2020  %(port)d" % {.  
-000215d0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-000215e0: 726f 746f 636f 6c22 3a20 7773 2e61 6464  rotocol": ws.add
-000215f0: 7265 7373 2e73 706c 6974 2822 3a2f 2f22  ress.split("://"
-00021600: 295b 305d 2c0a 2020 2020 2020 2020 2020  )[0],.          
-00021610: 2020 2020 2020 2268 6f73 7422 3a20 7773        "host": ws
-00021620: 2e68 6f73 742c 0a20 2020 2020 2020 2020  .host,.         
-00021630: 2020 2020 2020 2022 706f 7274 223a 2070         "port": p
-00021640: 6f72 742c 0a20 2020 2020 2020 2020 2020  ort,.           
-00021650: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
-00021660: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00021670: 7572 6e20 7773 2e68 6f73 742c 2070 6f72  urn ws.host, por
-00021680: 740a 0a20 2020 2061 7379 6e63 2064 6566  t..    async def
-00021690: 2073 7461 7274 5f75 6e73 6166 6528 7365   start_unsafe(se
-000216a0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-000216b0: 436c 6561 7220 6f75 7420 6f6c 6420 7374  Clear out old st
-000216c0: 6174 6520 616e 6420 7265 7374 6172 7420  ate and restart 
-000216d0: 616c 6c20 7275 6e6e 696e 6720 636f 726f  all running coro
-000216e0: 7574 696e 6573 2222 220a 2020 2020 2020  utines""".      
-000216f0: 2020 6177 6169 7420 7375 7065 7228 292e    await super().
-00021700: 7374 6172 745f 756e 7361 6665 2829 0a0a  start_unsafe()..
-00021710: 2020 2020 2020 2020 656e 6162 6c65 5f67          enable_g
-00021720: 635f 6469 6167 6e6f 7369 7328 290a 0a20  c_diagnosis().. 
-00021730: 2020 2020 2020 2073 656c 662e 5f63 6c65         self._cle
-00021740: 6172 5f74 6173 6b5f 7374 6174 6528 290a  ar_task_state().
-00021750: 0a20 2020 2020 2020 2066 6f72 2061 6464  .        for add
-00021760: 7220 696e 2073 656c 662e 5f73 7461 7274  r in self._start
-00021770: 5f61 6464 7265 7373 3a0a 2020 2020 2020  _address:.      
-00021780: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
-00021790: 2e6c 6973 7465 6e28 0a20 2020 2020 2020  .listen(.       
-000217a0: 2020 2020 2020 2020 2061 6464 722c 0a20           addr,. 
-000217b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000217c0: 6c6c 6f77 5f6f 6666 6c6f 6164 3d46 616c  llow_offload=Fal
-000217d0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-000217e0: 2020 2020 6861 6e64 7368 616b 655f 6f76      handshake_ov
-000217f0: 6572 7269 6465 733d 7b22 7069 636b 6c65  errides={"pickle
-00021800: 2d70 726f 746f 636f 6c22 3a20 342c 2022  -protocol": 4, "
-00021810: 636f 6d70 7265 7373 696f 6e22 3a20 4e6f  compression": No
-00021820: 6e65 7d2c 0a20 2020 2020 2020 2020 2020  ne},.           
-00021830: 2020 2020 202a 2a73 656c 662e 7365 6375       **self.secu
-00021840: 7269 7479 2e67 6574 5f6c 6973 7465 6e5f  rity.get_listen_
-00021850: 6172 6773 2822 7363 6865 6475 6c65 7222  args("scheduler"
-00021860: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-00021870: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00021880: 662e 6970 203d 2067 6574 5f61 6464 7265  f.ip = get_addre
-00021890: 7373 5f68 6f73 7428 7365 6c66 2e6c 6973  ss_host(self.lis
-000218a0: 7465 6e5f 6164 6472 6573 7329 0a20 2020  ten_address).   
-000218b0: 2020 2020 2020 2020 206c 6973 7465 6e5f           listen_
-000218c0: 6970 203d 2073 656c 662e 6970 0a0a 2020  ip = self.ip..  
-000218d0: 2020 2020 2020 2020 2020 6966 206c 6973            if lis
-000218e0: 7465 6e5f 6970 203d 3d20 2230 2e30 2e30  ten_ip == "0.0.0
-000218f0: 2e30 223a 0a20 2020 2020 2020 2020 2020  .0":.           
-00021900: 2020 2020 206c 6973 7465 6e5f 6970 203d       listen_ip =
-00021910: 2022 220a 0a20 2020 2020 2020 2069 6620   ""..        if 
-00021920: 7365 6c66 2e61 6464 7265 7373 2e73 7461  self.address.sta
-00021930: 7274 7377 6974 6828 2269 6e70 726f 633a  rtswith("inproc:
-00021940: 2f2f 2229 3a0a 2020 2020 2020 2020 2020  //"):.          
-00021950: 2020 6c69 7374 656e 5f69 7020 3d20 226c    listen_ip = "l
-00021960: 6f63 616c 686f 7374 220a 0a20 2020 2020  ocalhost"..     
-00021970: 2020 2023 2053 6572 7669 6365 7320 6c69     # Services li
-00021980: 7374 656e 206f 6e20 616c 6c20 6164 6472  sten on all addr
-00021990: 6573 7365 730a 2020 2020 2020 2020 7365  esses.        se
-000219a0: 6c66 2e73 7461 7274 5f73 6572 7669 6365  lf.start_service
-000219b0: 7328 6c69 7374 656e 5f69 7029 0a0a 2020  s(listen_ip)..  
-000219c0: 2020 2020 2020 666f 7220 6c69 7374 656e        for listen
-000219d0: 6572 2069 6e20 7365 6c66 2e6c 6973 7465  er in self.liste
-000219e0: 6e65 7273 3a0a 2020 2020 2020 2020 2020  ners:.          
-000219f0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2220    logger.info(" 
-00021a00: 2053 6368 6564 756c 6572 2061 743a 2025   Scheduler at: %
-00021a10: 3235 7322 2c20 6c69 7374 656e 6572 2e63  25s", listener.c
-00021a20: 6f6e 7461 6374 5f61 6464 7265 7373 290a  ontact_address).
-00021a30: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-00021a40: 2c20 7365 7276 6572 2069 6e20 7365 6c66  , server in self
-00021a50: 2e73 6572 7669 6365 732e 6974 656d 7328  .services.items(
-00021a60: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00021a70: 6620 6e61 6d65 203d 3d20 2264 6173 6862  f name == "dashb
-00021a80: 6f61 7264 223a 0a20 2020 2020 2020 2020  oard":.         
-00021a90: 2020 2020 2020 2061 6464 7220 3d20 6765         addr = ge
-00021aa0: 745f 6164 6472 6573 735f 686f 7374 286c  t_address_host(l
-00021ab0: 6973 7465 6e65 722e 636f 6e74 6163 745f  istener.contact_
-00021ac0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-00021ad0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00021ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021af0: 2020 6c69 6e6b 203d 2066 6f72 6d61 745f    link = format_
-00021b00: 6461 7368 626f 6172 645f 6c69 6e6b 2861  dashboard_link(a
-00021b10: 6464 722c 2073 6572 7665 722e 706f 7274  ddr, server.port
-00021b20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00021b30: 2020 2320 666f 726d 6174 7469 6e67 2064    # formatting d
-00021b40: 6173 6862 6f61 7264 206c 696e 6b20 6361  ashboard link ca
-00021b50: 6e20 6661 696c 2069 6620 6469 7374 7269  n fail if distri
-00021b60: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
-00021b70: 6c69 6e6b 0a20 2020 2020 2020 2020 2020  link.           
-00021b80: 2020 2020 2023 2072 6566 6572 7320 746f       # refers to
-00021b90: 206e 6f6e 2d65 7869 7374 616e 7420 656e   non-existant en
-00021ba0: 7620 7661 7273 2e0a 2020 2020 2020 2020  v vars..        
-00021bb0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00021bc0: 6579 4572 726f 7220 6173 2065 3a0a 2020  eyError as e:.  
-00021bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021be0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-00021bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00021c00: 2020 2020 2020 2020 2020 6622 4661 696c            f"Fail
-00021c10: 6564 2074 6f20 666f 726d 6174 2064 6173  ed to format das
-00021c20: 6862 6f61 7264 206c 696e 6b2c 2075 6e6b  hboard link, unk
-00021c30: 6e6f 776e 2076 616c 7565 3a20 7b65 7d22  nown value: {e}"
-00021c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021c50: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00021c60: 2020 2020 2020 2020 2020 206c 696e 6b20             link 
-00021c70: 3d20 6622 3a7b 7365 7276 6572 2e70 6f72  = f":{server.por
-00021c80: 747d 220a 2020 2020 2020 2020 2020 2020  t}".            
-00021c90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00021ca0: 2020 2020 2020 6c69 6e6b 203d 2066 227b        link = f"{
-00021cb0: 6c69 7374 656e 5f69 707d 3a7b 7365 7276  listen_ip}:{serv
-00021cc0: 6572 2e70 6f72 747d 220a 2020 2020 2020  er.port}".      
-00021cd0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00021ce0: 6f28 2225 3131 7320 6174 3a20 2025 3235  o("%11s at:  %25
-00021cf0: 7322 2c20 6e61 6d65 2c20 6c69 6e6b 290a  s", name, link).
-00021d00: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00021d10: 2e73 6368 6564 756c 6572 5f66 696c 653a  .scheduler_file:
-00021d20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00021d30: 6820 6f70 656e 2873 656c 662e 7363 6865  h open(self.sche
-00021d40: 6475 6c65 725f 6669 6c65 2c20 2277 2229  duler_file, "w")
-00021d50: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-00021d60: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
-00021d70: 2873 656c 662e 6964 656e 7469 7479 2829  (self.identity()
-00021d80: 2c20 662c 2069 6e64 656e 743d 3229 0a0a  , f, indent=2)..
-00021d90: 2020 2020 2020 2020 2020 2020 666e 203d              fn =
-00021da0: 2073 656c 662e 7363 6865 6475 6c65 725f   self.scheduler_
-00021db0: 6669 6c65 2020 2320 7265 6d6f 7665 2066  file  # remove f
-00021dc0: 696c 6520 7768 656e 2077 6520 636c 6f73  ile when we clos
-00021dd0: 6520 7468 6520 7072 6f63 6573 730a 0a20  e the process.. 
-00021de0: 2020 2020 2020 2020 2020 2064 6566 2064             def d
-00021df0: 656c 5f73 6368 6564 756c 6572 5f66 696c  el_scheduler_fil
-00021e00: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-00021e10: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
-00021e20: 6578 6973 7473 2866 6e29 3a0a 2020 2020  exists(fn):.    
-00021e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e40: 6f73 2e72 656d 6f76 6528 666e 290a 0a20  os.remove(fn).. 
-00021e50: 2020 2020 2020 2020 2020 2077 6561 6b72             weakr
-00021e60: 6566 2e66 696e 616c 697a 6528 7365 6c66  ef.finalize(self
-00021e70: 2c20 6465 6c5f 7363 6865 6475 6c65 725f  , del_scheduler_
-00021e80: 6669 6c65 290a 0a20 2020 2020 2020 2066  file)..        f
-00021e90: 6f72 2070 7265 6c6f 6164 2069 6e20 7365  or preload in se
-00021ea0: 6c66 2e70 7265 6c6f 6164 733a 0a20 2020  lf.preloads:.   
-00021eb0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00021ec0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-00021ed0: 6169 7420 7072 656c 6f61 642e 7374 6172  ait preload.star
-00021ee0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-00021ef0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00021f00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021f10: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-00021f20: 6f6e 2822 4661 696c 6564 2074 6f20 7374  on("Failed to st
-00021f30: 6172 7420 7072 656c 6f61 6422 290a 0a20  art preload").. 
-00021f40: 2020 2020 2020 2069 6620 7365 6c66 2e6a         if self.j
-00021f50: 7570 7974 6572 3a0a 2020 2020 2020 2020  upyter:.        
-00021f60: 2020 2020 2320 416c 6c6f 7720 696e 7365      # Allow inse
-00021f70: 6375 7265 2063 6f6d 6d75 6e69 6361 7469  cure communicati
-00021f80: 6f6e 7320 6672 6f6d 206c 6f63 616c 2075  ons from local u
-00021f90: 7365 7273 0a20 2020 2020 2020 2020 2020  sers.           
-00021fa0: 2069 6620 7365 6c66 2e61 6464 7265 7373   if self.address
-00021fb0: 2e73 7461 7274 7377 6974 6828 2274 6c73  .startswith("tls
-00021fc0: 3a2f 2f22 293a 0a20 2020 2020 2020 2020  ://"):.         
-00021fd0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00021fe0: 662e 6c69 7374 656e 2822 7463 703a 2f2f  f.listen("tcp://
-00021ff0: 6c6f 6361 6c68 6f73 743a 3022 290a 2020  localhost:0").  
-00022000: 2020 2020 2020 2020 2020 6f73 2e65 6e76            os.env
-00022010: 6972 6f6e 5b22 4441 534b 5f53 4348 4544  iron["DASK_SCHED
-00022020: 554c 4552 5f41 4444 5245 5353 225d 203d  ULER_ADDRESS"] =
-00022030: 2073 656c 662e 6c69 7374 656e 6572 735b   self.listeners[
-00022040: 2d31 5d2e 636f 6e74 6163 745f 6164 6472  -1].contact_addr
-00022050: 6573 730a 0a20 2020 2020 2020 2061 7761  ess..        awa
-00022060: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
-00022070: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
-00022080: 5b70 6c75 6769 6e2e 7374 6172 7428 7365  [plugin.start(se
-00022090: 6c66 2920 666f 7220 706c 7567 696e 2069  lf) for plugin i
-000220a0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-000220b0: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
-000220c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000220d0: 2020 7365 6c66 2e73 7461 7274 5f70 6572    self.start_per
-000220e0: 696f 6469 635f 6361 6c6c 6261 636b 7328  iodic_callbacks(
-000220f0: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
-00022100: 6f63 7469 746c 6528 6622 6461 736b 2073  octitle(f"dask s
-00022110: 6368 6564 756c 6572 205b 7b73 656c 662e  cheduler [{self.
-00022120: 6164 6472 6573 737d 5d22 290a 2020 2020  address}]").    
-00022130: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-00022140: 0a20 2020 2061 7379 6e63 2064 6566 2063  .    async def c
-00022150: 6c6f 7365 2873 656c 662c 2066 6173 743d  lose(self, fast=
-00022160: 4e6f 6e65 2c20 636c 6f73 655f 776f 726b  None, close_work
-00022170: 6572 733d 4e6f 6e65 293a 0a20 2020 2020  ers=None):.     
-00022180: 2020 2022 2222 5365 6e64 2063 6c65 616e     """Send clean
-00022190: 7570 2073 6967 6e61 6c20 746f 2061 6c6c  up signal to all
-000221a0: 2063 6f72 6f75 7469 6e65 7320 7468 656e   coroutines then
-000221b0: 2077 6169 7420 756e 7469 6c20 6669 6e69   wait until fini
-000221c0: 7368 6564 0a0a 2020 2020 2020 2020 5365  shed..        Se
-000221d0: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
-000221e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-000221f0: 5363 6865 6475 6c65 722e 636c 6561 6e75  Scheduler.cleanu
-00022200: 700a 2020 2020 2020 2020 2222 220a 2020  p.        """.  
-00022210: 2020 2020 2020 6966 2066 6173 7420 6973        if fast is
-00022220: 206e 6f74 204e 6f6e 6520 6f72 2063 6c6f   not None or clo
-00022230: 7365 5f77 6f72 6b65 7273 2069 7320 6e6f  se_workers is no
-00022240: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00022250: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-00022260: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00022270: 2020 2022 5468 6520 2766 6173 7427 2061     "The 'fast' a
-00022280: 6e64 2027 636c 6f73 655f 776f 726b 6572  nd 'close_worker
-00022290: 7327 2070 6172 616d 6574 6572 7320 696e  s' parameters in
-000222a0: 2053 6368 6564 756c 6572 2e63 6c6f 7365   Scheduler.close
-000222b0: 2068 6176 6520 6e6f 2065 6666 6563 7420   have no effect 
-000222c0: 616e 6420 7769 6c6c 2062 6520 7265 6d6f  and will be remo
-000222d0: 7665 6420 696e 2061 2066 7574 7572 6520  ved in a future 
-000222e0: 7665 7273 696f 6e20 6f66 2064 6973 7472  version of distr
-000222f0: 6962 7574 6564 2e22 2c0a 2020 2020 2020  ibuted.",.      
-00022300: 2020 2020 2020 2020 2020 4675 7475 7265            Future
-00022310: 5761 726e 696e 672c 0a20 2020 2020 2020  Warning,.       
-00022320: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00022330: 6620 7365 6c66 2e73 7461 7475 7320 696e  f self.status in
-00022340: 2028 5374 6174 7573 2e63 6c6f 7369 6e67   (Status.closing
-00022350: 2c20 5374 6174 7573 2e63 6c6f 7365 6429  , Status.closed)
-00022360: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
-00022370: 6169 7420 7365 6c66 2e66 696e 6973 6865  ait self.finishe
-00022380: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
-00022390: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-000223a0: 6173 796e 6320 6465 6620 6c6f 675f 6572  async def log_er
-000223b0: 726f 7273 2866 756e 6329 3a0a 2020 2020  rors(func):.    
-000223c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000223d0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-000223e0: 6974 2066 756e 6328 290a 2020 2020 2020  it func().      
-000223f0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00022400: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-00022410: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00022420: 7863 6570 7469 6f6e 2822 506c 7567 696e  xception("Plugin
-00022430: 2063 616c 6c20 6661 696c 6564 2064 7572   call failed dur
-00022440: 696e 6720 7363 6865 6475 6c65 722e 636c  ing scheduler.cl
-00022450: 6f73 6522 290a 0a20 2020 2020 2020 2061  ose")..        a
-00022460: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00022470: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00022480: 202a 5b6c 6f67 5f65 7272 6f72 7328 706c   *[log_errors(pl
-00022490: 7567 696e 2e62 6566 6f72 655f 636c 6f73  ugin.before_clos
-000224a0: 6529 2066 6f72 2070 6c75 6769 6e20 696e  e) for plugin in
-000224b0: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
-000224c0: 6e73 2e76 616c 7565 7328 2929 5d0a 2020  ns.values())].  
-000224d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000224e0: 2073 656c 662e 7374 6174 7573 203d 2053   self.status = S
-000224f0: 7461 7475 732e 636c 6f73 696e 670a 0a20  tatus.closing.. 
-00022500: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00022510: 666f 2822 5363 6865 6475 6c65 7220 636c  fo("Scheduler cl
-00022520: 6f73 696e 672e 2e2e 2229 0a20 2020 2020  osing...").     
-00022530: 2020 2073 6574 7072 6f63 7469 746c 6528     setproctitle(
-00022540: 2264 6173 6b20 7363 6865 6475 6c65 7220  "dask scheduler 
-00022550: 5b63 6c6f 7369 6e67 5d22 290a 0a20 2020  [closing]")..   
-00022560: 2020 2020 2066 6f72 2070 7265 6c6f 6164       for preload
-00022570: 2069 6e20 7365 6c66 2e70 7265 6c6f 6164   in self.preload
-00022580: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00022590: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000225a0: 2020 2020 6177 6169 7420 7072 656c 6f61      await preloa
-000225b0: 642e 7465 6172 646f 776e 2829 0a20 2020  d.teardown().   
-000225c0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-000225d0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-000225e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000225f0: 722e 6578 6365 7074 696f 6e28 2246 6169  r.exception("Fai
-00022600: 6c65 6420 746f 2074 6561 7220 646f 776e  led to tear down
-00022610: 2070 7265 6c6f 6164 2229 0a0a 2020 2020   preload")..    
-00022620: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-00022630: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00022640: 2020 2020 2020 2a5b 6c6f 675f 6572 726f        *[log_erro
-00022650: 7273 2870 6c75 6769 6e2e 636c 6f73 6529  rs(plugin.close)
-00022660: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-00022670: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-00022680: 2e76 616c 7565 7328 2929 5d0a 2020 2020  .values())].    
-00022690: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-000226a0: 6f72 2070 6320 696e 2073 656c 662e 7065  or pc in self.pe
-000226b0: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
-000226c0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-000226d0: 2020 2020 2020 2070 632e 7374 6f70 2829         pc.stop()
-000226e0: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
-000226f0: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
-00022700: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
-00022710: 2020 7365 6c66 2e73 746f 705f 7365 7276    self.stop_serv
-00022720: 6963 6573 2829 0a0a 2020 2020 2020 2020  ices()..        
-00022730: 666f 7220 6578 7420 696e 2073 656c 662e  for ext in self.
-00022740: 6578 7465 6e73 696f 6e73 2e76 616c 7565  extensions.value
-00022750: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00022760: 2077 6974 6820 7375 7070 7265 7373 2841   with suppress(A
-00022770: 7474 7269 6275 7465 4572 726f 7229 3a0a  ttributeError):.
-00022780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022790: 6578 742e 7465 6172 646f 776e 2829 0a20  ext.teardown(). 
-000227a0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-000227b0: 666f 2822 5363 6865 6475 6c65 7220 636c  fo("Scheduler cl
-000227c0: 6f73 696e 6720 616c 6c20 636f 6d6d 7322  osing all comms"
-000227d0: 290a 0a20 2020 2020 2020 2066 7574 7572  )..        futur
-000227e0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-000227f0: 666f 7220 5f2c 2063 6f6d 6d20 696e 206c  for _, comm in l
-00022800: 6973 7428 7365 6c66 2e73 7472 6561 6d5f  ist(self.stream_
-00022810: 636f 6d6d 732e 6974 656d 7328 2929 3a0a  comms.items()):.
-00022820: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
-00022830: 584d 4520 7573 6520 6073 656c 662e 7265  XME use `self.re
-00022840: 6d6f 7665 5f77 6f72 6b65 7228 2960 2069  move_worker()` i
-00022850: 6e73 7465 6164 2061 6674 6572 2068 7474  nstead after htt
-00022860: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00022870: 6461 736b 2f64 6973 7472 6962 7574 6564  dask/distributed
-00022880: 2f69 7373 7565 732f 3633 3930 0a20 2020  /issues/6390.   
-00022890: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-000228a0: 636f 6d6d 2e63 6c6f 7365 6428 293a 0a20  comm.closed():. 
-000228b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000228c0: 2054 6869 7320 636c 6f73 6573 2074 6865   This closes the
-000228d0: 2057 6f72 6b65 7220 616e 6420 656e 7375   Worker and ensu
-000228e0: 7265 7320 7468 6174 2069 6620 6120 4e61  res that if a Na
-000228f0: 6e6e 7920 6973 2061 726f 756e 642c 0a20  nny is around,. 
-00022900: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00022910: 2069 7420 6973 2063 6c6f 7365 6420 6173   it is closed as
-00022920: 2077 656c 6c0a 2020 2020 2020 2020 2020   well.          
-00022930: 2020 2020 2020 636f 6d6d 2e73 656e 6428        comm.send(
-00022940: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
-00022950: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
-00022960: 756c 6572 2d63 6c6f 7365 227d 290a 2020  uler-close"}).  
-00022970: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00022980: 6d6d 2e73 656e 6428 7b22 6f70 223a 2022  mm.send({"op": "
-00022990: 636c 6f73 652d 7374 7265 616d 227d 290a  close-stream"}).
-000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229b0: 2320 5e20 544f 444f 2072 656d 6f76 653f  # ^ TODO remove?
-000229c0: 2060 576f 726b 6572 2e63 6c6f 7365 6020   `Worker.close` 
-000229d0: 7769 6c6c 2063 6c6f 7365 2074 6865 2073  will close the s
-000229e0: 7472 6561 6d20 616e 7977 6179 2e0a 2020  tream anyway..  
-000229f0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
-00022a00: 7570 7072 6573 7328 4174 7472 6962 7574  uppress(Attribut
-00022a10: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00022a20: 2020 2020 2020 2020 2066 7574 7572 6573           futures
-00022a30: 2e61 7070 656e 6428 636f 6d6d 2e63 6c6f  .append(comm.clo
-00022a40: 7365 2829 290a 0a20 2020 2020 2020 2061  se())..        a
-00022a50: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00022a60: 6865 7228 2a66 7574 7572 6573 290a 0a20  her(*futures).. 
-00022a70: 2020 2020 2020 2069 6620 7365 6c66 2e6a         if self.j
-00022a80: 7570 7974 6572 3a0a 2020 2020 2020 2020  upyter:.        
-00022a90: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
-00022aa0: 6a75 7079 7465 725f 7365 7276 6572 5f61  jupyter_server_a
-00022ab0: 7070 6c69 6361 7469 6f6e 2e5f 636c 6561  pplication._clea
-00022ac0: 6e75 7028 290a 0a20 2020 2020 2020 2066  nup()..        f
-00022ad0: 6f72 2063 6f6d 6d20 696e 2073 656c 662e  or comm in self.
-00022ae0: 636c 6965 6e74 5f63 6f6d 6d73 2e76 616c  client_comms.val
-00022af0: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-00022b00: 2020 2063 6f6d 6d2e 6162 6f72 7428 290a     comm.abort().
-00022b10: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
-00022b20: 656c 662e 7270 632e 636c 6f73 6528 290a  elf.rpc.close().
-00022b30: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-00022b40: 6174 7573 203d 2053 7461 7475 732e 636c  atus = Status.cl
-00022b50: 6f73 6564 0a20 2020 2020 2020 2073 656c  osed.        sel
-00022b60: 662e 7374 6f70 2829 0a20 2020 2020 2020  f.stop().       
-00022b70: 2061 7761 6974 2073 7570 6572 2829 2e63   await super().c
-00022b80: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
-00022b90: 7365 7470 726f 6374 6974 6c65 2822 6461  setproctitle("da
-00022ba0: 736b 2073 6368 6564 756c 6572 205b 636c  sk scheduler [cl
-00022bb0: 6f73 6564 5d22 290a 2020 2020 2020 2020  osed]").        
-00022bc0: 6469 7361 626c 655f 6763 5f64 6961 676e  disable_gc_diagn
-00022bd0: 6f73 6973 2829 0a0a 2020 2020 2323 2323  osis()..    ####
-00022be0: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
-00022bf0: 696d 756c 6920 230a 2020 2020 2323 2323  imuli #.    ####
-00022c00: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
-00022c10: 2068 6561 7274 6265 6174 5f77 6f72 6b65   heartbeat_worke
-00022c20: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-00022c30: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00022c40: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
-00022c50: 2c0a 2020 2020 2020 2020 7265 736f 6c76  ,.        resolv
-00022c60: 655f 6164 6472 6573 733a 2062 6f6f 6c20  e_address: bool 
-00022c70: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00022c80: 6e6f 773a 2066 6c6f 6174 207c 204e 6f6e  now: float | Non
-00022c90: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00022ca0: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
-00022cb0: 745b 7374 722c 2066 6c6f 6174 5d20 7c20  t[str, float] | 
-00022cc0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00022cd0: 2020 2020 2068 6f73 745f 696e 666f 3a20       host_info: 
-00022ce0: 6469 6374 207c 204e 6f6e 6520 3d20 4e6f  dict | None = No
-00022cf0: 6e65 2c0a 2020 2020 2020 2020 6d65 7472  ne,.        metr
-00022d00: 6963 733a 2064 6963 742c 0a20 2020 2020  ics: dict,.     
-00022d10: 2020 2065 7865 6375 7469 6e67 3a20 6469     executing: di
-00022d20: 6374 5b73 7472 2c20 666c 6f61 745d 207c  ct[str, float] |
-00022d30: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00022d40: 2020 2020 2020 6578 7465 6e73 696f 6e73        extensions
-00022d50: 3a20 6469 6374 207c 204e 6f6e 6520 3d20  : dict | None = 
-00022d60: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
-00022d70: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-00022d80: 2020 2020 2020 2061 6464 7265 7373 203d         address =
-00022d90: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
-00022da0: 7265 7373 2861 6464 7265 7373 2c20 7265  ress(address, re
-00022db0: 736f 6c76 655f 6164 6472 6573 7329 0a20  solve_address). 
-00022dc0: 2020 2020 2020 2061 6464 7265 7373 203d         address =
-00022dd0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
-00022de0: 7373 2861 6464 7265 7373 290a 2020 2020  ss(address).    
-00022df0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
-00022e00: 726b 6572 732e 6765 7428 6164 6472 6573  rkers.get(addres
-00022e10: 7329 0a20 2020 2020 2020 2069 6620 7773  s).        if ws
-00022e20: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00022e30: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00022e40: 6e69 6e67 2866 2252 6563 6569 7665 6420  ning(f"Received 
-00022e50: 6865 6172 7462 6561 7420 6672 6f6d 2075  heartbeat from u
-00022e60: 6e72 6567 6973 7465 7265 6420 776f 726b  nregistered work
-00022e70: 6572 207b 6164 6472 6573 7321 727d 2e22  er {address!r}."
-00022e80: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00022e90: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
-00022ea0: 226d 6973 7369 6e67 227d 0a0a 2020 2020  "missing"}..    
-00022eb0: 2020 2020 686f 7374 203d 2067 6574 5f61      host = get_a
-00022ec0: 6464 7265 7373 5f68 6f73 7428 6164 6472  ddress_host(addr
-00022ed0: 6573 7329 0a20 2020 2020 2020 206c 6f63  ess).        loc
-00022ee0: 616c 5f6e 6f77 203d 2074 696d 6528 290a  al_now = time().
-00022ef0: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
-00022f00: 6f20 3d20 686f 7374 5f69 6e66 6f20 6f72  o = host_info or
-00022f10: 207b 7d0a 0a20 2020 2020 2020 2064 683a   {}..        dh:
-00022f20: 2064 6963 7420 3d20 7365 6c66 2e68 6f73   dict = self.hos
-00022f30: 745f 696e 666f 2e73 6574 6465 6661 756c  t_info.setdefaul
-00022f40: 7428 686f 7374 2c20 7b7d 290a 2020 2020  t(host, {}).    
-00022f50: 2020 2020 6468 5b22 6c61 7374 2d73 6565      dh["last-see
-00022f60: 6e22 5d20 3d20 6c6f 6361 6c5f 6e6f 770a  n"] = local_now.
-00022f70: 0a20 2020 2020 2020 2066 7261 6320 3d20  .        frac = 
-00022f80: 3120 2f20 6c65 6e28 7365 6c66 2e77 6f72  1 / len(self.wor
-00022f90: 6b65 7273 290a 2020 2020 2020 2020 7365  kers).        se
-00022fa0: 6c66 2e62 616e 6477 6964 7468 203d 2028  lf.bandwidth = (
-00022fb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00022fc0: 662e 6261 6e64 7769 6474 6820 2a20 2831  f.bandwidth * (1
-00022fd0: 202d 2066 7261 6329 202b 206d 6574 7269   - frac) + metri
-00022fe0: 6373 5b22 6261 6e64 7769 6474 6822 5d5b  cs["bandwidth"][
-00022ff0: 2274 6f74 616c 225d 202a 2066 7261 630a  "total"] * frac.
-00023000: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00023010: 2020 666f 7220 6f74 6865 722c 2028 6277    for other, (bw
-00023020: 2c20 636f 756e 7429 2069 6e20 6d65 7472  , count) in metr
-00023030: 6963 735b 2262 616e 6477 6964 7468 225d  ics["bandwidth"]
-00023040: 5b22 776f 726b 6572 7322 5d2e 6974 656d  ["workers"].item
-00023050: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00023060: 2069 6620 2861 6464 7265 7373 2c20 6f74   if (address, ot
-00023070: 6865 7229 206e 6f74 2069 6e20 7365 6c66  her) not in self
-00023080: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
-00023090: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-000230a0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-000230b0: 7468 5f77 6f72 6b65 7273 5b61 6464 7265  th_workers[addre
-000230c0: 7373 2c20 6f74 6865 725d 203d 2062 7720  ss, other] = bw 
-000230d0: 2f20 636f 756e 740a 2020 2020 2020 2020  / count.        
-000230e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000230f0: 2020 2020 2020 2020 2020 616c 7068 6120            alpha 
-00023100: 3d20 2831 202d 2066 7261 6329 202a 2a20  = (1 - frac) ** 
-00023110: 636f 756e 740a 2020 2020 2020 2020 2020  count.          
-00023120: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-00023130: 6964 7468 5f77 6f72 6b65 7273 5b61 6464  idth_workers[add
-00023140: 7265 7373 2c20 6f74 6865 725d 203d 2073  ress, other] = s
-00023150: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-00023160: 726b 6572 735b 0a20 2020 2020 2020 2020  rkers[.         
-00023170: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00023180: 7373 2c20 6f74 6865 720a 2020 2020 2020  ss, other.      
-00023190: 2020 2020 2020 2020 2020 5d20 2a20 616c            ] * al
-000231a0: 7068 6120 2b20 6277 202a 2028 3120 2d20  pha + bw * (1 - 
-000231b0: 616c 7068 6129 0a20 2020 2020 2020 2066  alpha).        f
-000231c0: 6f72 2074 7970 2c20 2862 772c 2063 6f75  or typ, (bw, cou
-000231d0: 6e74 2920 696e 206d 6574 7269 6373 5b22  nt) in metrics["
-000231e0: 6261 6e64 7769 6474 6822 5d5b 2274 7970  bandwidth"]["typ
-000231f0: 6573 225d 2e69 7465 6d73 2829 3a0a 2020  es"].items():.  
-00023200: 2020 2020 2020 2020 2020 6966 2074 7970            if typ
-00023210: 206e 6f74 2069 6e20 7365 6c66 2e62 616e   not in self.ban
-00023220: 6477 6964 7468 5f74 7970 6573 3a0a 2020  dwidth_types:.  
-00023230: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00023240: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
-00023250: 6573 5b74 7970 5d20 3d20 6277 202f 2063  es[typ] = bw / c
-00023260: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-00023270: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00023280: 2020 2020 2020 2061 6c70 6861 203d 2028         alpha = (
-00023290: 3120 2d20 6672 6163 2920 2a2a 2063 6f75  1 - frac) ** cou
-000232a0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-000232b0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-000232c0: 685f 7479 7065 735b 7479 705d 203d 2073  h_types[typ] = s
-000232d0: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
-000232e0: 7065 735b 7479 705d 202a 2061 6c70 6861  pes[typ] * alpha
-000232f0: 202b 2062 7720 2a20 280a 2020 2020 2020   + bw * (.      
-00023300: 2020 2020 2020 2020 2020 2020 2020 3120                1 
-00023310: 2d20 616c 7068 610a 2020 2020 2020 2020  - alpha.        
-00023320: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00023330: 2020 2077 732e 6c61 7374 5f73 6565 6e20     ws.last_seen 
-00023340: 3d20 6c6f 6361 6c5f 6e6f 770a 2020 2020  = local_now.    
-00023350: 2020 2020 6966 2065 7865 6375 7469 6e67      if executing
-00023360: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00023370: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-00023380: 3a20 7468 6520 6578 6563 7574 696e 6720  : the executing 
-00023390: 6469 6374 2069 7320 756e 7573 6564 0a20  dict is unused. 
-000233a0: 2020 2020 2020 2020 2020 2077 732e 6578             ws.ex
-000233b0: 6563 7574 696e 6720 3d20 7b7d 0a20 2020  ecuting = {}.   
-000233c0: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-000233d0: 2c20 6475 7261 7469 6f6e 2069 6e20 6578  , duration in ex
-000233e0: 6563 7574 696e 672e 6974 656d 7328 293a  ecuting.items():
-000233f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023400: 2069 6620 6b65 7920 696e 2073 656c 662e   if key in self.
-00023410: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
-00023420: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00023430: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00023440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023450: 2020 2020 7773 2e65 7865 6375 7469 6e67      ws.executing
-00023460: 5b74 735d 203d 2064 7572 6174 696f 6e0a  [ts] = duration.
-00023470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023480: 2020 2020 7473 2e70 7265 6669 782e 6164      ts.prefix.ad
-00023490: 645f 6578 6563 5f74 696d 6528 6475 7261  d_exec_time(dura
-000234a0: 7469 6f6e 290a 0a20 2020 2020 2020 2066  tion)..        f
-000234b0: 6f72 206e 616d 652c 2076 616c 7565 2069  or name, value i
-000234c0: 6e20 6d65 7472 6963 735b 2264 6967 6573  n metrics["diges
-000234d0: 7473 5f74 6f74 616c 5f73 696e 6365 5f68  ts_total_since_h
-000234e0: 6561 7274 6265 6174 225d 2e69 7465 6d73  eartbeat"].items
-000234f0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00023500: 7365 6c66 2e63 756d 756c 6174 6976 655f  self.cumulative_
-00023510: 776f 726b 6572 5f6d 6574 7269 6373 5b6e  worker_metrics[n
-00023520: 616d 655d 202b 3d20 7661 6c75 650a 0a20  ame] += value.. 
-00023530: 2020 2020 2020 2077 732e 6d65 7472 6963         ws.metric
-00023540: 7320 3d20 6d65 7472 6963 730a 0a20 2020  s = metrics..   
-00023550: 2020 2020 2023 2043 616c 6375 6c61 7465       # Calculate
-00023560: 2052 5353 202d 2064 6173 6b20 6b65 7973   RSS - dask keys
-00023570: 2c20 7365 7061 7261 7469 6e67 2022 6f6c  , separating "ol
-00023580: 6422 2061 6e64 2022 6e65 7722 2075 7361  d" and "new" usa
-00023590: 6765 0a20 2020 2020 2020 2023 2053 6565  ge.        # See
-000235a0: 204d 656d 6f72 7953 7461 7465 2066 6f72   MemoryState for
-000235b0: 2064 6574 6169 6c73 0a20 2020 2020 2020   details.       
-000235c0: 206d 6178 5f6d 656d 6f72 795f 756e 6d61   max_memory_unma
-000235d0: 6e61 6765 645f 6f6c 645f 6869 7374 5f61  naged_old_hist_a
-000235e0: 6765 203d 206c 6f63 616c 5f6e 6f77 202d  ge = local_now -
-000235f0: 2073 656c 662e 4d45 4d4f 5259 5f52 4543   self.MEMORY_REC
-00023600: 454e 545f 544f 5f4f 4c44 5f54 494d 450a  ENT_TO_OLD_TIME.
-00023610: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
-00023620: 6e6d 616e 6167 6564 5f6f 6c64 203d 2077  nmanaged_old = w
-00023630: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
-00023640: 6765 645f 6f6c 640a 2020 2020 2020 2020  ged_old.        
-00023650: 7768 696c 6520 7773 2e5f 6d65 6d6f 7279  while ws._memory
-00023660: 5f75 6e6d 616e 6167 6564 5f68 6973 746f  _unmanaged_histo
-00023670: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00023680: 7469 6d65 7374 616d 702c 2073 697a 6520  timestamp, size 
-00023690: 3d20 7773 2e5f 6d65 6d6f 7279 5f75 6e6d  = ws._memory_unm
-000236a0: 616e 6167 6564 5f68 6973 746f 7279 5b30  anaged_history[0
-000236b0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-000236c0: 2074 696d 6573 7461 6d70 203e 3d20 6d61   timestamp >= ma
-000236d0: 785f 6d65 6d6f 7279 5f75 6e6d 616e 6167  x_memory_unmanag
-000236e0: 6564 5f6f 6c64 5f68 6973 745f 6167 653a  ed_old_hist_age:
-000236f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023700: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-00023710: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
-00023720: 6d61 6e61 6765 645f 6869 7374 6f72 792e  managed_history.
-00023730: 706f 706c 6566 7428 290a 2020 2020 2020  popleft().      
-00023740: 2020 2020 2020 6966 2073 697a 6520 3d3d        if size ==
-00023750: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
-00023760: 645f 6f6c 643a 0a20 2020 2020 2020 2020  d_old:.         
-00023770: 2020 2020 2020 206d 656d 6f72 795f 756e         memory_un
-00023780: 6d61 6e61 6765 645f 6f6c 6420 3d20 3020  managed_old = 0 
-00023790: 2023 2072 6563 616c 6375 6c61 7465 206d   # recalculate m
-000237a0: 696e 2829 0a0a 2020 2020 2020 2020 2320  in()..        # 
-000237b0: 7773 2e5f 6e62 7974 6573 2069 7320 7570  ws._nbytes is up
-000237c0: 6461 7465 6420 6174 2061 2064 6966 6665  dated at a diffe
-000237d0: 7265 6e74 2074 696d 6520 616e 6420 7369  rent time and si
-000237e0: 7a65 6f66 2829 206d 6179 206e 6f74 2062  zeof() may not b
-000237f0: 6520 6163 6375 7261 7465 2c0a 2020 2020  e accurate,.    
-00023800: 2020 2020 2320 736f 2073 697a 6520 6d61      # so size ma
-00023810: 7920 6265 2028 7465 6d70 6f72 6172 696c  y be (temporaril
-00023820: 7929 206e 6567 6174 6976 653b 2066 6c6f  y) negative; flo
-00023830: 6f72 2069 7420 746f 207a 6572 6f2e 0a20  or it to zero.. 
-00023840: 2020 2020 2020 2073 697a 6520 3d20 6d61         size = ma
-00023850: 7828 0a20 2020 2020 2020 2020 2020 2030  x(.            0
-00023860: 2c20 6d65 7472 6963 735b 226d 656d 6f72  , metrics["memor
-00023870: 7922 5d20 2d20 7773 2e6e 6279 7465 7320  y"] - ws.nbytes 
-00023880: 2b20 6d65 7472 6963 735b 2273 7069 6c6c  + metrics["spill
-00023890: 6564 5f62 7974 6573 225d 5b22 6d65 6d6f  ed_bytes"]["memo
-000238a0: 7279 225d 0a20 2020 2020 2020 2029 0a0a  ry"].        )..
-000238b0: 2020 2020 2020 2020 7773 2e5f 6d65 6d6f          ws._memo
-000238c0: 7279 5f75 6e6d 616e 6167 6564 5f68 6973  ry_unmanaged_his
-000238d0: 746f 7279 2e61 7070 656e 6428 286c 6f63  tory.append((loc
-000238e0: 616c 5f6e 6f77 2c20 7369 7a65 2929 0a20  al_now, size)). 
-000238f0: 2020 2020 2020 2069 6620 6e6f 7420 6d65         if not me
-00023900: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00023910: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
-00023920: 2320 5468 6520 776f 726b 6572 2068 6173  # The worker has
-00023930: 206a 7573 7420 6265 656e 2073 7461 7274   just been start
-00023940: 6564 206f 7220 7468 6520 7072 6576 696f  ed or the previo
-00023950: 7573 206d 696e 696d 756d 2068 6173 2062  us minimum has b
-00023960: 6565 6e20 6578 7075 6e67 6564 0a20 2020  een expunged.   
-00023970: 2020 2020 2020 2020 2023 2062 6563 6175           # becau
-00023980: 7365 2074 6f6f 206f 6c64 2e0a 2020 2020  se too old..    
-00023990: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
-000239a0: 7468 6973 2061 6c67 6f72 6974 686d 2069  this algorithm i
-000239b0: 7320 6361 7070 6564 2074 6f20 3230 3020  s capped to 200 
-000239c0: 2a20 4d45 4d4f 5259 5f52 4543 454e 545f  * MEMORY_RECENT_
-000239d0: 544f 5f4f 4c44 5f54 494d 4520 656c 656d  TO_OLD_TIME elem
-000239e0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-000239f0: 2023 2063 6c75 7374 6572 2d77 6964 6520   # cluster-wide 
-00023a00: 6279 2068 6561 7274 6265 6174 5f69 6e74  by heartbeat_int
-00023a10: 6572 7661 6c28 292c 2072 6567 6172 646c  erval(), regardl
-00023a20: 6573 7320 6f66 2074 6865 206e 756d 6265  ess of the numbe
-00023a30: 7220 6f66 2077 6f72 6b65 7273 0a20 2020  r of workers.   
-00023a40: 2020 2020 2020 2020 2077 732e 5f6d 656d           ws._mem
-00023a50: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
-00023a60: 6420 3d20 6d69 6e28 6d61 7028 7365 636f  d = min(map(seco
-00023a70: 6e64 2c20 7773 2e5f 6d65 6d6f 7279 5f75  nd, ws._memory_u
-00023a80: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
-00023a90: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-00023aa0: 7369 7a65 203c 206d 656d 6f72 795f 756e  size < memory_un
-00023ab0: 6d61 6e61 6765 645f 6f6c 643a 0a20 2020  managed_old:.   
-00023ac0: 2020 2020 2020 2020 2077 732e 5f6d 656d           ws._mem
-00023ad0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
-00023ae0: 6420 3d20 7369 7a65 0a0a 2020 2020 2020  d = size..      
-00023af0: 2020 6966 2068 6f73 745f 696e 666f 3a0a    if host_info:.
-00023b00: 2020 2020 2020 2020 2020 2020 6468 203d              dh =
-00023b10: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
-00023b20: 7365 7464 6566 6175 6c74 2868 6f73 742c  setdefault(host,
-00023b30: 207b 7d29 0a20 2020 2020 2020 2020 2020   {}).           
-00023b40: 2064 682e 7570 6461 7465 2868 6f73 745f   dh.update(host_
-00023b50: 696e 666f 290a 0a20 2020 2020 2020 2069  info)..        i
-00023b60: 6620 6e6f 773a 0a20 2020 2020 2020 2020  f now:.         
-00023b70: 2020 2077 732e 7469 6d65 5f64 656c 6179     ws.time_delay
-00023b80: 203d 206c 6f63 616c 5f6e 6f77 202d 206e   = local_now - n
-00023b90: 6f77 0a0a 2020 2020 2020 2020 6966 2072  ow..        if r
-00023ba0: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
-00023bb0: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
-00023bc0: 6573 6f75 7263 6573 2877 6f72 6b65 723d  esources(worker=
-00023bd0: 6164 6472 6573 732c 2072 6573 6f75 7263  address, resourc
-00023be0: 6573 3d72 6573 6f75 7263 6573 290a 0a20  es=resources).. 
-00023bf0: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
-00023c00: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00023c10: 2020 666f 7220 6e61 6d65 2c20 6461 7461    for name, data
-00023c20: 2069 6e20 6578 7465 6e73 696f 6e73 2e69   in extensions.i
-00023c30: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00023c40: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
-00023c50: 656e 7369 6f6e 735b 6e61 6d65 5d2e 6865  ensions[name].he
-00023c60: 6172 7462 6561 7428 7773 2c20 6461 7461  artbeat(ws, data
-00023c70: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00023c80: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-00023c90: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
-00023ca0: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
-00023cb0: 6522 3a20 6c6f 6361 6c5f 6e6f 772c 0a20  e": local_now,. 
-00023cc0: 2020 2020 2020 2020 2020 2022 6865 6172             "hear
-00023cd0: 7462 6561 742d 696e 7465 7276 616c 223a  tbeat-interval":
-00023ce0: 2068 6561 7274 6265 6174 5f69 6e74 6572   heartbeat_inter
-00023cf0: 7661 6c28 6c65 6e28 7365 6c66 2e77 6f72  val(len(self.wor
-00023d00: 6b65 7273 2929 2c0a 2020 2020 2020 2020  kers)),.        
-00023d10: 7d0a 0a20 2020 2040 6c6f 675f 6572 726f  }..    @log_erro
-00023d20: 7273 0a20 2020 2061 7379 6e63 2064 6566  rs.    async def
-00023d30: 2061 6464 5f77 6f72 6b65 7228 0a20 2020   add_worker(.   
-00023d40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00023d50: 2020 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20     comm: Comm,. 
-00023d60: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00023d70: 2020 6164 6472 6573 733a 2073 7472 2c0a    address: str,.
-00023d80: 2020 2020 2020 2020 7374 6174 7573 3a20          status: 
-00023d90: 7374 722c 0a20 2020 2020 2020 2073 6572  str,.        ser
-00023da0: 7665 725f 6964 3a20 7374 722c 0a20 2020  ver_id: str,.   
-00023db0: 2020 2020 206e 7468 7265 6164 733a 2069       nthreads: i
-00023dc0: 6e74 2c0a 2020 2020 2020 2020 6e61 6d65  nt,.        name
-00023dd0: 3a20 7374 722c 0a20 2020 2020 2020 2072  : str,.        r
-00023de0: 6573 6f6c 7665 5f61 6464 7265 7373 3a20  esolve_address: 
-00023df0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00023e00: 2020 2020 206e 6f77 3a20 666c 6f61 742c       now: float,
-00023e10: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-00023e20: 6573 3a20 6469 6374 5b73 7472 2c20 666c  es: dict[str, fl
-00023e30: 6f61 745d 2c0a 2020 2020 2020 2020 2320  oat],.        # 
-00023e40: 4649 584d 453a 2054 6869 7320 6973 206e  FIXME: This is n
-00023e50: 6576 6572 2073 7562 6d69 7474 6564 2062  ever submitted b
-00023e60: 7920 7468 6520 776f 726b 6572 0a20 2020  y the worker.   
-00023e70: 2020 2020 2068 6f73 745f 696e 666f 3a20       host_info: 
-00023e80: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00023e90: 2020 2020 206d 656d 6f72 795f 6c69 6d69       memory_limi
-00023ea0: 743a 2069 6e74 207c 204e 6f6e 652c 0a20  t: int | None,. 
-00023eb0: 2020 2020 2020 206d 6574 7269 6373 3a20         metrics: 
-00023ec0: 6469 6374 5b73 7472 2c20 416e 795d 2c0a  dict[str, Any],.
-00023ed0: 2020 2020 2020 2020 7069 643a 2069 6e74          pid: int
-00023ee0: 203d 2030 2c0a 2020 2020 2020 2020 7365   = 0,.        se
-00023ef0: 7276 6963 6573 3a20 6469 6374 5b73 7472  rvices: dict[str
-00023f00: 2c20 696e 745d 2c0a 2020 2020 2020 2020  , int],.        
-00023f10: 6c6f 6361 6c5f 6469 7265 6374 6f72 793a  local_directory:
-00023f20: 2073 7472 2c0a 2020 2020 2020 2020 7665   str,.        ve
-00023f30: 7273 696f 6e73 3a20 6469 6374 5b73 7472  rsions: dict[str
-00023f40: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00023f50: 6e61 6e6e 793a 2073 7472 2c0a 2020 2020  nanny: str,.    
-00023f60: 2020 2020 6578 7472 613a 2064 6963 742c      extra: dict,
-00023f70: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00023f80: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
-00023f90: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00023fa0: 2020 2222 2241 6464 2061 206e 6577 2077    """Add a new w
-00023fb0: 6f72 6b65 7220 746f 2074 6865 2063 6c75  orker to the clu
-00023fc0: 7374 6572 2222 220a 2020 2020 2020 2020  ster""".        
-00023fd0: 6164 6472 6573 7320 3d20 7365 6c66 2e63  address = self.c
-00023fe0: 6f65 7263 655f 6164 6472 6573 7328 6164  oerce_address(ad
-00023ff0: 6472 6573 732c 2072 6573 6f6c 7665 5f61  dress, resolve_a
-00024000: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
-00024010: 6164 6472 6573 7320 3d20 6e6f 726d 616c  address = normal
-00024020: 697a 655f 6164 6472 6573 7328 6164 6472  ize_address(addr
-00024030: 6573 7329 0a20 2020 2020 2020 2068 6f73  ess).        hos
-00024040: 7420 3d20 6765 745f 6164 6472 6573 735f  t = get_address_
-00024050: 686f 7374 2861 6464 7265 7373 290a 0a20  host(address).. 
-00024060: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
-00024070: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-00024080: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00024090: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000240a0: 2257 6f72 6b65 7220 616c 7265 6164 7920  "Worker already 
-000240b0: 6578 6973 7473 2025 7322 2025 2061 6464  exists %s" % add
-000240c0: 7265 7373 290a 0a20 2020 2020 2020 2069  ress)..        i
-000240d0: 6620 6e61 6d65 2069 6e20 7365 6c66 2e61  f name in self.a
-000240e0: 6c69 6173 6573 3a0a 2020 2020 2020 2020  liases:.        
-000240f0: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-00024100: 6e67 2822 576f 726b 6572 2074 7269 6564  ng("Worker tried
-00024110: 2074 6f20 636f 6e6e 6563 7420 7769 7468   to connect with
-00024120: 2061 2064 7570 6c69 6361 7465 206e 616d   a duplicate nam
-00024130: 653a 2025 7322 2c20 6e61 6d65 290a 2020  e: %s", name).  
-00024140: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-00024150: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00024160: 2020 2273 7461 7475 7322 3a20 2265 7272    "status": "err
-00024170: 6f72 222c 0a20 2020 2020 2020 2020 2020  or",.           
-00024180: 2020 2020 2022 6d65 7373 6167 6522 3a20       "message": 
-00024190: 226e 616d 6520 7461 6b65 6e2c 2025 7322  "name taken, %s"
-000241a0: 2025 206e 616d 652c 0a20 2020 2020 2020   % name,.       
-000241b0: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
-000241c0: 2074 696d 6528 292c 0a20 2020 2020 2020   time(),.       
-000241d0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000241e0: 2020 2061 7761 6974 2063 6f6d 6d2e 7772     await comm.wr
-000241f0: 6974 6528 6d73 6729 0a20 2020 2020 2020  ite(msg).       
-00024200: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00024210: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00024220: 656e 7428 6164 6472 6573 732c 207b 2261  ent(address, {"a
-00024230: 6374 696f 6e22 3a20 2261 6464 2d77 6f72  ction": "add-wor
-00024240: 6b65 7222 7d29 0a20 2020 2020 2020 2073  ker"}).        s
-00024250: 656c 662e 6c6f 675f 6576 656e 7428 2261  elf.log_event("a
-00024260: 6c6c 222c 207b 2261 6374 696f 6e22 3a20  ll", {"action": 
-00024270: 2261 6464 2d77 6f72 6b65 7222 2c20 2277  "add-worker", "w
-00024280: 6f72 6b65 7222 3a20 6164 6472 6573 737d  orker": address}
-00024290: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000242a0: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
-000242b0: 203d 2077 7320 3d20 576f 726b 6572 5374   = ws = WorkerSt
-000242c0: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-000242d0: 2061 6464 7265 7373 3d61 6464 7265 7373   address=address
-000242e0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-000242f0: 6174 7573 3d53 7461 7475 732e 6c6f 6f6b  atus=Status.look
-00024300: 7570 5b73 7461 7475 735d 2c20 2023 2074  up[status],  # t
-00024310: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00024320: 2020 2020 2020 2020 7069 643d 7069 642c          pid=pid,
-00024330: 0a20 2020 2020 2020 2020 2020 206e 7468  .            nth
-00024340: 7265 6164 733d 6e74 6872 6561 6473 2c0a  reads=nthreads,.
-00024350: 2020 2020 2020 2020 2020 2020 6d65 6d6f              memo
-00024360: 7279 5f6c 696d 6974 3d6d 656d 6f72 795f  ry_limit=memory_
-00024370: 6c69 6d69 7420 6f72 2030 2c0a 2020 2020  limit or 0,.    
-00024380: 2020 2020 2020 2020 6e61 6d65 3d6e 616d          name=nam
-00024390: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
-000243a0: 6f63 616c 5f64 6972 6563 746f 7279 3d6c  ocal_directory=l
-000243b0: 6f63 616c 5f64 6972 6563 746f 7279 2c0a  ocal_directory,.
-000243c0: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-000243d0: 6963 6573 3d73 6572 7669 6365 732c 0a20  ices=services,. 
-000243e0: 2020 2020 2020 2020 2020 2076 6572 7369             versi
-000243f0: 6f6e 733d 7665 7273 696f 6e73 2c0a 2020  ons=versions,.  
-00024400: 2020 2020 2020 2020 2020 6e61 6e6e 793d            nanny=
-00024410: 6e61 6e6e 792c 0a20 2020 2020 2020 2020  nanny,.         
-00024420: 2020 2065 7874 7261 3d65 7874 7261 2c0a     extra=extra,.
-00024430: 2020 2020 2020 2020 2020 2020 7365 7276              serv
-00024440: 6572 5f69 643d 7365 7276 6572 5f69 642c  er_id=server_id,
-00024450: 0a20 2020 2020 2020 2020 2020 2073 6368  .            sch
-00024460: 6564 756c 6572 3d73 656c 662c 0a20 2020  eduler=self,.   
-00024470: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00024480: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00024490: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-000244a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000244b0: 7275 6e6e 696e 672e 6164 6428 7773 290a  running.add(ws).
-000244c0: 0a20 2020 2020 2020 2064 6820 3d20 7365  .        dh = se
-000244d0: 6c66 2e68 6f73 745f 696e 666f 2e67 6574  lf.host_info.get
-000244e0: 2868 6f73 7429 0a20 2020 2020 2020 2069  (host).        i
-000244f0: 6620 6468 2069 7320 4e6f 6e65 3a0a 2020  f dh is None:.  
-00024500: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00024510: 6f73 745f 696e 666f 5b68 6f73 745d 203d  ost_info[host] =
-00024520: 2064 6820 3d20 7b7d 0a0a 2020 2020 2020   dh = {}..      
-00024530: 2020 6468 5f61 6464 7265 7373 6573 203d    dh_addresses =
-00024540: 2064 682e 6765 7428 2261 6464 7265 7373   dh.get("address
-00024550: 6573 2229 0a20 2020 2020 2020 2069 6620  es").        if 
-00024560: 6468 5f61 6464 7265 7373 6573 2069 7320  dh_addresses is 
-00024570: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00024580: 2020 6468 5b22 6164 6472 6573 7365 7322    dh["addresses"
-00024590: 5d20 3d20 6468 5f61 6464 7265 7373 6573  ] = dh_addresses
-000245a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-000245b0: 2020 2020 2064 685b 226e 7468 7265 6164       dh["nthread
-000245c0: 7322 5d20 3d20 300a 0a20 2020 2020 2020  s"] = 0..       
-000245d0: 2064 685f 6164 6472 6573 7365 732e 6164   dh_addresses.ad
-000245e0: 6428 6164 6472 6573 7329 0a20 2020 2020  d(address).     
-000245f0: 2020 2064 685b 226e 7468 7265 6164 7322     dh["nthreads"
-00024600: 5d20 2b3d 206e 7468 7265 6164 730a 0a20  ] += nthreads.. 
-00024610: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00024620: 6c5f 6e74 6872 6561 6473 202b 3d20 6e74  l_nthreads += nt
-00024630: 6872 6561 6473 0a20 2020 2020 2020 2073  hreads.        s
-00024640: 656c 662e 616c 6961 7365 735b 6e61 6d65  elf.aliases[name
-00024650: 5d20 3d20 6164 6472 6573 730a 0a20 2020  ] = address..   
-00024660: 2020 2020 2073 656c 662e 6865 6172 7462       self.heartb
-00024670: 6561 745f 776f 726b 6572 280a 2020 2020  eat_worker(.    
-00024680: 2020 2020 2020 2020 6164 6472 6573 733d          address=
-00024690: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-000246a0: 2020 2020 2072 6573 6f6c 7665 5f61 6464       resolve_add
-000246b0: 7265 7373 3d72 6573 6f6c 7665 5f61 6464  ress=resolve_add
-000246c0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-000246d0: 2020 6e6f 773d 6e6f 772c 0a20 2020 2020    now=now,.     
-000246e0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-000246f0: 3d72 6573 6f75 7263 6573 2c0a 2020 2020  =resources,.    
-00024700: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
-00024710: 6f3d 686f 7374 5f69 6e66 6f2c 0a20 2020  o=host_info,.   
-00024720: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
-00024730: 3d6d 6574 7269 6373 2c0a 2020 2020 2020  =metrics,.      
-00024740: 2020 290a 0a20 2020 2020 2020 2023 2044    )..        # D
-00024750: 6f20 6e6f 7420 6e65 6564 2074 6f20 6164  o not need to ad
-00024760: 6a75 7374 2073 656c 662e 746f 7461 6c5f  just self.total_
-00024770: 6f63 6375 7061 6e63 7920 6173 2073 656c  occupancy as sel
-00024780: 662e 6f63 6375 7061 6e63 795b 7773 5d20  f.occupancy[ws] 
-00024790: 6361 6e6e 6f74 0a20 2020 2020 2020 2023  cannot.        #
-000247a0: 2065 7869 7374 2062 6566 6f72 6520 7468   exist before th
-000247b0: 6973 2e0a 2020 2020 2020 2020 7365 6c66  is..        self
-000247c0: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
-000247d0: 7261 7465 6428 7773 290a 0a20 2020 2020  rated(ws)..     
-000247e0: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
-000247f0: 6f6d 6d73 5b61 6464 7265 7373 5d20 3d20  omms[address] = 
-00024800: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
-00024810: 7276 616c 3d22 356d 7322 2c20 6c6f 6f70  rval="5ms", loop
-00024820: 3d73 656c 662e 6c6f 6f70 290a 0a20 2020  =self.loop)..   
-00024830: 2020 2020 2061 7761 6974 6162 6c65 7320       awaitables 
-00024840: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00024850: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-00024860: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-00024870: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-00024880: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00024890: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-000248a0: 3d20 706c 7567 696e 2e61 6464 5f77 6f72  = plugin.add_wor
-000248b0: 6b65 7228 7363 6865 6475 6c65 723d 7365  ker(scheduler=se
-000248c0: 6c66 2c20 776f 726b 6572 3d61 6464 7265  lf, worker=addre
-000248d0: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
-000248e0: 2020 2020 6966 2072 6573 756c 7420 6973      if result is
-000248f0: 206e 6f74 204e 6f6e 6520 616e 6420 696e   not None and in
-00024900: 7370 6563 742e 6973 6177 6169 7461 626c  spect.isawaitabl
-00024910: 6528 7265 7375 6c74 293a 0a20 2020 2020  e(result):.     
-00024920: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00024930: 7761 6974 6162 6c65 732e 6170 7065 6e64  waitables.append
-00024940: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-00024950: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00024960: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-00024970: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00024980: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
-00024990: 0a20 2020 2020 2020 2070 6c75 6769 6e5f  .        plugin_
-000249a0: 6d73 6773 203d 2061 7761 6974 2061 7379  msgs = await asy
-000249b0: 6e63 696f 2e67 6174 6865 7228 2a61 7761  ncio.gather(*awa
-000249c0: 6974 6162 6c65 732c 2072 6574 7572 6e5f  itables, return_
-000249d0: 6578 6365 7074 696f 6e73 3d54 7275 6529  exceptions=True)
-000249e0: 0a20 2020 2020 2020 2070 6c75 6769 6e73  .        plugins
-000249f0: 5f65 7863 6570 7469 6f6e 7320 3d20 5b6d  _exceptions = [m
-00024a00: 7367 2066 6f72 206d 7367 2069 6e20 706c  sg for msg in pl
-00024a10: 7567 696e 5f6d 7367 7320 6966 2069 7369  ugin_msgs if isi
-00024a20: 6e73 7461 6e63 6528 6d73 672c 2045 7863  nstance(msg, Exc
-00024a30: 6570 7469 6f6e 295d 0a20 2020 2020 2020  eption)].       
-00024a40: 2066 6f72 2065 7863 2069 6e20 706c 7567   for exc in plug
-00024a50: 696e 735f 6578 6365 7074 696f 6e73 3a0a  ins_exceptions:.
-00024a60: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00024a70: 6572 2e65 7863 6570 7469 6f6e 2865 7863  er.exception(exc
-00024a80: 2c20 6578 635f 696e 666f 3d65 7863 290a  , exc_info=exc).
-00024a90: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
-00024aa0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-00024ab0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00024ac0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-00024ad0: 7469 6f6e 7328 0a20 2020 2020 2020 2020  tions(.         
-00024ae0: 2020 2020 2020 2073 656c 662e 6275 6c6b         self.bulk
-00024af0: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
-00024b00: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
-00024b10: 675f 776f 726b 6572 2877 7329 2c20 7374  g_worker(ws), st
-00024b20: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
-00024b30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024b40: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
-00024b50: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
-00024b60: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
-00024b70: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-00024b80: 6964 290a 0a20 2020 2020 2020 206c 6f67  id)..        log
-00024b90: 6765 722e 696e 666f 2822 5265 6769 7374  ger.info("Regist
-00024ba0: 6572 2077 6f72 6b65 7220 2573 222c 2077  er worker %s", w
-00024bb0: 7329 0a0a 2020 2020 2020 2020 6d73 6720  s)..        msg 
-00024bc0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00024bd0: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
-00024be0: 2020 2020 2020 2020 2020 2020 2274 696d              "tim
-00024bf0: 6522 3a20 7469 6d65 2829 2c0a 2020 2020  e": time(),.    
-00024c00: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
-00024c10: 6174 2d69 6e74 6572 7661 6c22 3a20 6865  at-interval": he
-00024c20: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
-00024c30: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
-00024c40: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
-00024c50: 2022 776f 726b 6572 2d70 6c75 6769 6e73   "worker-plugins
-00024c60: 223a 2073 656c 662e 776f 726b 6572 5f70  ": self.worker_p
-00024c70: 6c75 6769 6e73 2c0a 2020 2020 2020 2020  lugins,.        
-00024c80: 7d0a 0a20 2020 2020 2020 2076 6572 7369  }..        versi
-00024c90: 6f6e 5f77 6172 6e69 6e67 203d 2076 6572  on_warning = ver
-00024ca0: 7369 6f6e 5f6d 6f64 756c 652e 6572 726f  sion_module.erro
-00024cb0: 725f 6d65 7373 6167 6528 0a20 2020 2020  r_message(.     
-00024cc0: 2020 2020 2020 2076 6572 7369 6f6e 5f6d         version_m
-00024cd0: 6f64 756c 652e 6765 745f 7665 7273 696f  odule.get_versio
-00024ce0: 6e73 2829 2c0a 2020 2020 2020 2020 2020  ns(),.          
-00024cf0: 2020 7b77 3a20 7773 2e76 6572 7369 6f6e    {w: ws.version
-00024d00: 7320 666f 7220 772c 2077 7320 696e 2073  s for w, ws in s
-00024d10: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
-00024d20: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
-00024d30: 2020 7665 7273 696f 6e73 2c0a 2020 2020    versions,.    
-00024d40: 2020 2020 2020 2020 736f 7572 6365 5f6e          source_n
-00024d50: 616d 653d 7374 7228 7773 2e73 6572 7665  ame=str(ws.serve
-00024d60: 725f 6964 292c 0a20 2020 2020 2020 2029  r_id),.        )
-00024d70: 0a20 2020 2020 2020 206d 7367 2e75 7064  .        msg.upd
-00024d80: 6174 6528 7665 7273 696f 6e5f 7761 726e  ate(version_warn
-00024d90: 696e 6729 0a0a 2020 2020 2020 2020 6177  ing)..        aw
-00024da0: 6169 7420 636f 6d6d 2e77 7269 7465 286d  ait comm.write(m
-00024db0: 7367 290a 2020 2020 2020 2020 2320 5468  sg).        # Th
-00024dc0: 6973 2077 696c 6c20 6b65 6570 2072 756e  is will keep run
-00024dd0: 6e69 6e67 2075 6e74 696c 2074 6865 2077  ning until the w
-00024de0: 6f72 6b65 7220 6973 2072 656d 6f76 6564  orker is removed
-00024df0: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
-00024e00: 656c 662e 6861 6e64 6c65 5f77 6f72 6b65  elf.handle_worke
-00024e10: 7228 636f 6d6d 2c20 6164 6472 6573 7329  r(comm, address)
-00024e20: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00024e30: 6164 645f 6e61 6e6e 7928 7365 6c66 2920  add_nanny(self) 
-00024e40: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
-00024e50: 5d3a 0a20 2020 2020 2020 206d 7367 203d  ]:.        msg =
-00024e60: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00024e70: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-00024e80: 2020 2020 2020 2020 2020 2022 6e61 6e6e             "nann
-00024e90: 792d 706c 7567 696e 7322 3a20 7365 6c66  y-plugins": self
-00024ea0: 2e6e 616e 6e79 5f70 6c75 6769 6e73 2c0a  .nanny_plugins,.
-00024eb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00024ec0: 2020 7265 7475 726e 206d 7367 0a0a 2020    return msg..  
-00024ed0: 2020 6465 6620 7570 6461 7465 5f67 7261    def update_gra
-00024ee0: 7068 280a 2020 2020 2020 2020 7365 6c66  ph(.        self
-00024ef0: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00024f00: 3a20 7374 722c 0a20 2020 2020 2020 2067  : str,.        g
-00024f10: 7261 7068 5f68 6561 6465 723a 2064 6963  raph_header: dic
-00024f20: 742c 0a20 2020 2020 2020 2067 7261 7068  t,.        graph
-00024f30: 5f66 7261 6d65 733a 206c 6973 745b 6279  _frames: list[by
-00024f40: 7465 735d 2c0a 2020 2020 2020 2020 6b65  tes],.        ke
-00024f50: 7973 3a20 6c69 7374 5b73 7472 5d2c 0a20  ys: list[str],. 
-00024f60: 2020 2020 2020 2069 6e74 6572 6e61 6c5f         internal_
-00024f70: 7072 696f 7269 7479 3a20 6469 6374 5b73  priority: dict[s
-00024f80: 7472 2c20 696e 745d 207c 204e 6f6e 652c  tr, int] | None,
-00024f90: 0a20 2020 2020 2020 2073 7562 6d69 7474  .        submitt
-00024fa0: 696e 675f 7461 736b 3a20 7374 7220 7c20  ing_task: str | 
-00024fb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7573  None,.        us
-00024fc0: 6572 5f70 7269 6f72 6974 793a 2069 6e74  er_priority: int
-00024fd0: 207c 2064 6963 745b 7374 722c 2069 6e74   | dict[str, int
-00024fe0: 5d20 3d20 302c 0a20 2020 2020 2020 2061  ] = 0,.        a
-00024ff0: 6374 6f72 733a 2062 6f6f 6c20 7c20 6c69  ctors: bool | li
-00025000: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
-00025010: 204e 6f6e 652c 0a20 2020 2020 2020 2066   None,.        f
-00025020: 6966 6f5f 7469 6d65 6f75 743a 2066 6c6f  ifo_timeout: flo
-00025030: 6174 203d 2030 2e30 2c0a 2020 2020 2020  at = 0.0,.      
-00025040: 2020 636f 6465 3a20 7475 706c 655b 7374    code: tuple[st
-00025050: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
-00025060: 2c0a 2020 2020 2020 2020 616e 6e6f 7461  ,.        annota
-00025070: 7469 6f6e 733a 2064 6963 7420 7c20 4e6f  tions: dict | No
-00025080: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00025090: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
-000250a0: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-000250b0: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-000250c0: 3a0a 2020 2020 2020 2020 7374 6172 7420  :.        start 
-000250d0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
-000250e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000250f0: 2020 2320 544f 444f 3a20 6465 7365 7269    # TODO: deseri
-00025100: 616c 697a 6174 696f 6e20 2b20 6d61 7465  alization + mate
-00025110: 7269 616c 697a 6174 696f 6e20 7368 6f75  rialization shou
-00025120: 6c64 2062 6520 6f66 666c 6f61 6465 6420  ld be offloaded 
-00025130: 746f 2061 0a20 2020 2020 2020 2020 2020  to a.           
-00025140: 2023 2074 6872 6561 6420 7369 6e63 6520   # thread since 
-00025150: 7468 6973 2069 7320 6e6f 6e2d 7472 6976  this is non-triv
-00025160: 6961 6c20 636f 6d70 7574 6520 7469 6d65  ial compute time
-00025170: 2074 6861 7420 626c 6f63 6b73 2074 6865   that blocks the
-00025180: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-00025190: 7665 6e74 206c 6f6f 702e 2054 6869 7320  vent loop. This 
-000251a0: 6c69 6b65 6c79 2072 6571 7569 7265 7320  likely requires 
-000251b0: 7573 2074 6f20 7573 6520 6120 6c6f 636b  us to use a lock
-000251c0: 2073 696e 6365 2077 6520 6e65 6564 2074   since we need t
-000251d0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
-000251e0: 6775 6172 616e 7465 6520 6f72 6465 7269  guarantee orderi
-000251f0: 6e67 206f 6620 7570 6461 7465 5f67 7261  ng of update_gra
-00025200: 7068 2063 616c 6c73 2028 6173 206c 6f6e  ph calls (as lon
-00025210: 6720 6173 2074 6865 7265 2069 7320 6a75  g as there is ju
-00025220: 7374 0a20 2020 2020 2020 2020 2020 2023  st.            #
-00025230: 2061 2073 696e 676c 6520 6f66 666c 6f61   a single offloa
-00025240: 6420 7468 7265 6164 2c20 7468 6973 2069  d thread, this i
-00025250: 7320 6e6f 7420 6120 7072 6f62 6c65 6d29  s not a problem)
-00025260: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-00025270: 6d20 6469 7374 7269 6275 7465 642e 7072  m distributed.pr
-00025280: 6f74 6f63 6f6c 2069 6d70 6f72 7420 6465  otocol import de
-00025290: 7365 7269 616c 697a 650a 0a20 2020 2020  serialize..     
-000252a0: 2020 2020 2020 2067 7261 7068 203d 2064         graph = d
-000252b0: 6573 6572 6961 6c69 7a65 2867 7261 7068  eserialize(graph
-000252c0: 5f68 6561 6465 722c 2067 7261 7068 5f66  _header, graph_f
-000252d0: 7261 6d65 7329 2e64 6174 610a 2020 2020  rames).data.    
-000252e0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000252f0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00025300: 2020 2020 2020 206d 7367 203d 2022 2222         msg = """
-00025310: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00025320: 2020 4572 726f 7220 6475 7269 6e67 2064    Error during d
-00025330: 6573 6572 6961 6c69 7a61 7469 6f6e 206f  eserialization o
-00025340: 6620 7468 6520 7461 736b 2067 7261 7068  f the task graph
-00025350: 2e20 5468 6973 2066 7265 7175 656e 746c  . This frequentl
-00025360: 7920 6f63 6375 7273 2069 6620 7468 6520  y occurs if the 
-00025370: 5363 6865 6475 6c65 7220 616e 6420 436c  Scheduler and Cl
-00025380: 6965 6e74 2068 6176 6520 6469 6666 6572  ient have differ
-00025390: 656e 7420 656e 7669 726f 6e6d 656e 7473  ent environments
-000253a0: 2e20 466f 7220 6d6f 7265 2069 6e66 6f72  . For more infor
-000253b0: 6d61 7469 6f6e 2c20 7365 6520 6874 7470  mation, see http
-000253c0: 733a 2f2f 646f 6373 2e64 6173 6b2e 6f72  s://docs.dask.or
-000253d0: 672f 656e 2f73 7461 626c 652f 6465 706c  g/en/stable/depl
-000253e0: 6f79 6d65 6e74 2d63 6f6e 7369 6465 7261  oyment-considera
-000253f0: 7469 6f6e 732e 6874 6d6c 2363 6f6e 7369  tions.html#consi
-00025400: 7374 656e 742d 736f 6674 7761 7265 2d65  stent-software-e
-00025410: 6e76 6972 6f6e 6d65 6e74 730a 2020 2020  nvironments.    
-00025420: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00025430: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00025440: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00025450: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-00025460: 7465 7874 7772 6170 2e64 6564 656e 7428  textwrap.dedent(
-00025470: 6d73 6729 2920 6672 6f6d 2065 0a20 2020  msg)) from e.   
-00025480: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00025490: 5275 6e74 696d 6545 7272 6f72 2061 7320  RuntimeError as 
-000254a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000254b0: 2020 2065 7272 203d 2065 7272 6f72 5f6d     err = error_m
-000254c0: 6573 7361 6765 2865 290a 2020 2020 2020  essage(e).      
-000254d0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-000254e0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-000254f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00025500: 656c 662e 7265 706f 7274 280a 2020 2020  elf.report(.    
-00025510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025520: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00025530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025540: 2020 226f 7022 3a20 2274 6173 6b2d 6572    "op": "task-er
-00025550: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
-00025560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025570: 2020 226b 6579 223a 206b 6579 2c0a 2020    "key": key,.  
-00025580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025590: 2020 2020 2020 2020 2020 2265 7863 6570            "excep
-000255a0: 7469 6f6e 223a 2065 7272 5b22 6578 6365  tion": err["exce
-000255b0: 7074 696f 6e22 5d2c 0a20 2020 2020 2020  ption"],.       
-000255c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000255d0: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
-000255e0: 3a20 6572 725b 2274 7261 6365 6261 636b  : err["traceback
-000255f0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00025600: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00025610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025620: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00025630: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00025640: 616e 6e6f 7461 7469 6f6e 7320 3d20 616e  annotations = an
-00025650: 6e6f 7461 7469 6f6e 7320 6f72 207b 7d0a  notations or {}.
-00025660: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00025670: 7461 6e63 6528 616e 6e6f 7461 7469 6f6e  tance(annotation
-00025680: 732c 2054 6f50 6963 6b6c 6529 3a20 2023  s, ToPickle):  #
-00025690: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-000256a0: 2020 2020 2020 2020 2020 2320 4649 584d            # FIXM
-000256b0: 453a 2077 6861 7420 7468 6520 6865 636b  E: what the heck
-000256c0: 3f0a 2020 2020 2020 2020 2020 2020 616e  ?.            an
-000256d0: 6e6f 7461 7469 6f6e 7320 3d20 616e 6e6f  notations = anno
-000256e0: 7461 7469 6f6e 732e 6461 7461 2020 2320  tations.data  # 
-000256f0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00025700: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00025710: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
-00025720: 7220 6622 7570 6461 7465 2d67 7261 7068  r f"update-graph
-00025730: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-00025740: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00025750: 2064 736b 2c0a 2020 2020 2020 2020 2020   dsk,.          
-00025760: 2020 6465 7065 6e64 656e 6369 6573 2c0a    dependencies,.
-00025770: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
-00025780: 725f 616e 6e6f 7461 7469 6f6e 732c 0a20  r_annotations,. 
-00025790: 2020 2020 2020 2020 2020 2070 7265 5f73             pre_s
-000257a0: 7472 696e 6769 6669 6564 5f6b 6579 732c  tringified_keys,
-000257b0: 0a20 2020 2020 2020 2029 203d 2073 656c  .        ) = sel
-000257c0: 662e 6d61 7465 7269 616c 697a 655f 6772  f.materialize_gr
-000257d0: 6170 6828 6772 6170 6829 0a0a 2020 2020  aph(graph)..    
-000257e0: 2020 2020 7265 7175 6573 7465 645f 6b65      requested_ke
-000257f0: 7973 203d 2073 6574 286b 6579 7329 0a20  ys = set(keys). 
-00025800: 2020 2020 2020 2064 656c 206b 6579 730a         del keys.
-00025810: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-00025820: 736b 2920 3e20 313a 0a20 2020 2020 2020  sk) > 1:.       
-00025830: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00025840: 656e 7428 0a20 2020 2020 2020 2020 2020  ent(.           
-00025850: 2020 2020 205b 2261 6c6c 222c 2063 6c69       ["all", cli
-00025860: 656e 745d 2c20 7b22 6163 7469 6f6e 223a  ent], {"action":
-00025870: 2022 7570 6461 7465 5f67 7261 7068 222c   "update_graph",
-00025880: 2022 636f 756e 7422 3a20 6c65 6e28 6473   "count": len(ds
-00025890: 6b29 7d0a 2020 2020 2020 2020 2020 2020  k)}.            
-000258a0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-000258b0: 706f 705f 6b6e 6f77 6e5f 7461 736b 7328  pop_known_tasks(
-000258c0: 6473 6b2c 2064 6570 656e 6465 6e63 6965  dsk, dependencie
-000258d0: 7329 0a0a 2020 2020 2020 2020 6966 206c  s)..        if l
-000258e0: 6f73 745f 6b65 7973 203a 3d20 7365 6c66  ost_keys := self
-000258f0: 2e5f 706f 705f 6c6f 7374 5f74 6173 6b73  ._pop_lost_tasks
-00025900: 2864 736b 2c20 6465 7065 6e64 656e 6369  (dsk, dependenci
-00025910: 6573 2c20 7265 7175 6573 7465 645f 6b65  es, requested_ke
-00025920: 7973 293a 0a20 2020 2020 2020 2020 2020  ys):.           
-00025930: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
-00025940: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
-00025950: 6579 7322 2c20 226b 6579 7322 3a20 6c6f  eys", "keys": lo
-00025960: 7374 5f6b 6579 737d 2c20 636c 6965 6e74  st_keys}, client
-00025970: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
-00025980: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-00025990: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
-000259a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000259b0: 6b65 7973 3d6c 6f73 745f 6b65 7973 2c20  keys=lost_keys, 
-000259c0: 636c 6965 6e74 3d63 6c69 656e 742c 2073  client=client, s
-000259d0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-000259e0: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
-000259f0: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
-00025a00: 206e 6f74 2073 656c 662e 6973 5f69 646c   not self.is_idl
-00025a10: 6520 616e 6420 7365 6c66 2e63 6f6d 7075  e and self.compu
-00025a20: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
-00025a30: 2020 2020 2023 2053 7469 6c6c 2077 6f72       # Still wor
-00025a40: 6b69 6e67 206f 6e20 736f 6d65 7468 696e  king on somethin
-00025a50: 672e 2041 7373 6967 6e20 6e65 7720 7461  g. Assign new ta
-00025a60: 736b 7320 746f 2073 616d 6520 636f 6d70  sks to same comp
-00025a70: 7574 6174 696f 6e0a 2020 2020 2020 2020  utation.        
-00025a80: 2020 2020 636f 6d70 7574 6174 696f 6e20      computation 
-00025a90: 3d20 7365 6c66 2e63 6f6d 7075 7461 7469  = self.computati
-00025aa0: 6f6e 735b 2d31 5d0a 2020 2020 2020 2020  ons[-1].        
-00025ab0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00025ac0: 2020 636f 6d70 7574 6174 696f 6e20 3d20    computation = 
-00025ad0: 436f 6d70 7574 6174 696f 6e28 290a 2020  Computation().  
-00025ae0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00025af0: 6f6d 7075 7461 7469 6f6e 732e 6170 7065  omputations.appe
-00025b00: 6e64 2863 6f6d 7075 7461 7469 6f6e 290a  nd(computation).
-00025b10: 0a20 2020 2020 2020 2069 6620 636f 6465  .        if code
-00025b20: 3a20 2023 2061 6464 206e 6577 2063 6f64  :  # add new cod
-00025b30: 6520 626c 6f63 6b73 0a20 2020 2020 2020  e blocks.       
-00025b40: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
-00025b50: 2e63 6f64 652e 6164 6428 636f 6465 290a  .code.add(code).
-00025b60: 2020 2020 2020 2020 6966 2061 6e6e 6f74          if annot
-00025b70: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
-00025b80: 2020 2020 636f 6d70 7574 6174 696f 6e2e      computation.
-00025b90: 616e 6e6f 7461 7469 6f6e 732e 7570 6461  annotations.upda
-00025ba0: 7465 2861 6e6e 6f74 6174 696f 6e73 290a  te(annotations).
-00025bb0: 0a20 2020 2020 2020 2072 756e 6e61 626c  .        runnabl
-00025bc0: 652c 2074 6f75 6368 6564 5f74 6173 6b73  e, touched_tasks
-00025bd0: 2c20 6e65 775f 7461 736b 7320 3d20 7365  , new_tasks = se
-00025be0: 6c66 2e5f 6765 6e65 7261 7465 5f74 6173  lf._generate_tas
-00025bf0: 6b73 7461 7465 7328 0a20 2020 2020 2020  kstates(.       
-00025c00: 2020 2020 206b 6579 733d 7265 7175 6573       keys=reques
-00025c10: 7465 645f 6b65 7973 2c0a 2020 2020 2020  ted_keys,.      
-00025c20: 2020 2020 2020 6473 6b3d 6473 6b2c 0a20        dsk=dsk,. 
-00025c30: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00025c40: 6465 6e63 6965 733d 6465 7065 6e64 656e  dencies=dependen
-00025c50: 6369 6573 2c0a 2020 2020 2020 2020 2020  cies,.          
-00025c60: 2020 636f 6d70 7574 6174 696f 6e3d 636f    computation=co
-00025c70: 6d70 7574 6174 696f 6e2c 0a20 2020 2020  mputation,.     
-00025c80: 2020 2029 0a20 2020 2020 2020 2023 2046     ).        # F
-00025c90: 4958 4d45 3a20 5468 6573 6520 2272 6573  IXME: These "res
-00025ca0: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
-00025cb0: 7322 2061 7265 2061 2062 6967 2064 7570  s" are a big dup
-00025cc0: 6c69 6361 7469 6f6e 2061 6e64 2061 7265  lication and are
-00025cd0: 206f 6e6c 790a 2020 2020 2020 2020 2320   only.        # 
-00025ce0: 7265 7175 6972 6564 2074 6f20 7361 7469  required to sati
-00025cf0: 7366 7920 7468 6520 6375 7272 656e 7420  sfy the current 
-00025d00: 706c 7567 696e 2041 5049 2e20 5468 6973  plugin API. This
-00025d10: 2073 686f 756c 6420 6265 0a20 2020 2020   should be.     
-00025d20: 2020 2023 2072 6563 6f6e 7369 6465 7265     # reconsidere
-00025d30: 642e 0a20 2020 2020 2020 2072 6573 6f6c  d..        resol
-00025d40: 7665 645f 616e 6e6f 7461 7469 6f6e 7320  ved_annotations 
-00025d50: 3d20 7365 6c66 2e5f 7061 7273 655f 616e  = self._parse_an
-00025d60: 645f 6170 706c 795f 616e 6e6f 7461 7469  d_apply_annotati
-00025d70: 6f6e 7328 0a20 2020 2020 2020 2020 2020  ons(.           
-00025d80: 2074 6173 6b73 3d6e 6577 5f74 6173 6b73   tasks=new_tasks
-00025d90: 2c0a 2020 2020 2020 2020 2020 2020 616e  ,.            an
-00025da0: 6e6f 7461 7469 6f6e 733d 616e 6e6f 7461  notations=annota
-00025db0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-00025dc0: 2020 206c 6179 6572 5f61 6e6e 6f74 6174     layer_annotat
-00025dd0: 696f 6e73 3d6c 6179 6572 5f61 6e6e 6f74  ions=layer_annot
-00025de0: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
-00025df0: 2020 2020 7072 655f 7374 7269 6e67 6966      pre_stringif
-00025e00: 6965 645f 6b65 7973 3d70 7265 5f73 7472  ied_keys=pre_str
-00025e10: 696e 6769 6669 6564 5f6b 6579 732c 0a20  ingified_keys,. 
-00025e20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00025e30: 2020 7365 6c66 2e5f 7365 745f 7072 696f    self._set_prio
-00025e40: 7269 7469 6573 280a 2020 2020 2020 2020  rities(.        
-00025e50: 2020 2020 696e 7465 726e 616c 5f70 7269      internal_pri
-00025e60: 6f72 6974 793d 696e 7465 726e 616c 5f70  ority=internal_p
-00025e70: 7269 6f72 6974 792c 0a20 2020 2020 2020  riority,.       
-00025e80: 2020 2020 2073 7562 6d69 7474 696e 675f       submitting_
-00025e90: 7461 736b 3d73 7562 6d69 7474 696e 675f  task=submitting_
-00025ea0: 7461 736b 2c0a 2020 2020 2020 2020 2020  task,.          
-00025eb0: 2020 7573 6572 5f70 7269 6f72 6974 793d    user_priority=
-00025ec0: 7573 6572 5f70 7269 6f72 6974 792c 0a20  user_priority,. 
-00025ed0: 2020 2020 2020 2020 2020 2066 6966 6f5f             fifo_
-00025ee0: 7469 6d65 6f75 743d 6669 666f 5f74 696d  timeout=fifo_tim
-00025ef0: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
-00025f00: 2020 7374 6172 743d 7374 6172 742c 0a20    start=start,. 
-00025f10: 2020 2020 2020 2020 2020 2064 736b 3d64             dsk=d
-00025f20: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00025f30: 7461 736b 733d 7275 6e6e 6162 6c65 2c0a  tasks=runnable,.
-00025f40: 2020 2020 2020 2020 2020 2020 6465 7065              depe
-00025f50: 6e64 656e 6369 6573 3d64 6570 656e 6465  ndencies=depende
-00025f60: 6e63 6965 732c 0a20 2020 2020 2020 2029  ncies,.        )
-00025f70: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-00025f80: 6c69 656e 745f 6465 7369 7265 735f 6b65  lient_desires_ke
-00025f90: 7973 286b 6579 733d 7265 7175 6573 7465  ys(keys=requeste
-00025fa0: 645f 6b65 7973 2c20 636c 6965 6e74 3d63  d_keys, client=c
-00025fb0: 6c69 656e 7429 0a0a 2020 2020 2020 2020  lient)..        
-00025fc0: 2320 4164 6420 6163 746f 7273 0a20 2020  # Add actors.   
-00025fd0: 2020 2020 2069 6620 6163 746f 7273 2069       if actors i
-00025fe0: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
-00025ff0: 2020 2020 6163 746f 7273 203d 206c 6973      actors = lis
-00026000: 7428 7265 7175 6573 7465 645f 6b65 7973  t(requested_keys
-00026010: 290a 2020 2020 2020 2020 666f 7220 6163  ).        for ac
-00026020: 746f 7220 696e 2061 6374 6f72 7320 6f72  tor in actors or
-00026030: 205b 5d3a 0a20 2020 2020 2020 2020 2020   []:.           
-00026040: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00026050: 5b61 6374 6f72 5d0a 2020 2020 2020 2020  [actor].        
-00026060: 2020 2020 7473 2e61 6374 6f72 203d 2054      ts.actor = T
-00026070: 7275 650a 0a20 2020 2020 2020 2023 2043  rue..        # C
-00026080: 6f6d 7075 7465 2072 6563 6f6d 6d65 6e64  ompute recommend
-00026090: 6174 696f 6e73 0a20 2020 2020 2020 2072  ations.        r
-000260a0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-000260b0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
-000260c0: 2020 7072 696f 7269 7479 203d 2064 6963    priority = dic
-000260d0: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-000260e0: 7473 2069 6e20 736f 7274 6564 280a 2020  ts in sorted(.  
-000260f0: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
-00026100: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-00026110: 6b65 793d 6f70 6572 6174 6f72 2e61 7474  key=operator.att
-00026120: 7267 6574 7465 7228 2270 7269 6f72 6974  rgetter("priorit
-00026130: 7922 292c 0a20 2020 2020 2020 2020 2020  y"),.           
-00026140: 2072 6576 6572 7365 3d54 7275 652c 0a20   reverse=True,. 
-00026150: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00026160: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00026170: 7072 696f 7269 7479 2020 2320 6d79 7079  priority  # mypy
-00026180: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00026190: 6f72 6974 795b 7473 2e6b 6579 5d20 3d20  ority[ts.key] = 
-000261a0: 7473 2e70 7269 6f72 6974 790a 2020 2020  ts.priority.    
-000261b0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000261c0: 732e 7275 6e5f 7370 6563 0a20 2020 2020  s.run_spec.     
-000261d0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-000261e0: 7465 203d 3d20 2272 656c 6561 7365 6422  te == "released"
-000261f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026200: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00026210: 735b 7473 2e6b 6579 5d20 3d20 2277 6169  s[ts.key] = "wai
-00026220: 7469 6e67 220a 0a20 2020 2020 2020 2066  ting"..        f
-00026230: 6f72 2074 7320 696e 2072 756e 6e61 626c  or ts in runnabl
-00026240: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00026250: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00026260: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00026270: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-00026280: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00026290: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000262a0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-000262b0: 696f 6e5f 626c 616d 6520 3d20 6474 732e  ion_blame = dts.
-000262c0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-000262d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000262e0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000262f0: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2265  ons[ts.key] = "e
-00026300: 7272 6564 220a 2020 2020 2020 2020 2020  rred".          
-00026310: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00026320: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
-00026330: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-00026340: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-00026350: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00026360: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00026370: 2020 2020 2070 6c75 6769 6e2e 7570 6461       plugin.upda
-00026380: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
-00026390: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000263a0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-000263b0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
-000263c0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-000263d0: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-000263e0: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
-000263f0: 696e 2074 6f75 6368 6564 5f74 6173 6b73  in touched_tasks
-00026400: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00026410: 2020 2020 2020 206b 6579 733d 7265 7175         keys=requ
-00026420: 6573 7465 645f 6b65 7973 2c0a 2020 2020  ested_keys,.    
-00026430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026440: 6465 7065 6e64 656e 6369 6573 3d64 6570  dependencies=dep
-00026450: 656e 6465 6e63 6965 732c 0a20 2020 2020  endencies,.     
-00026460: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00026470: 6e6e 6f74 6174 696f 6e73 3d72 6573 6f6c  nnotations=resol
-00026480: 7665 645f 616e 6e6f 7461 7469 6f6e 732c  ved_annotations,
-00026490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000264a0: 2020 2020 2070 7269 6f72 6974 793d 7072       priority=pr
-000264b0: 696f 7269 7479 2c0a 2020 2020 2020 2020  iority,.        
-000264c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000264d0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-000264e0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-000264f0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00026500: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
-00026510: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
-00026520: 7261 6e73 6974 696f 6e73 2872 6563 6f6d  ransitions(recom
-00026530: 6d65 6e64 6174 696f 6e73 2c20 7374 696d  mendations, stim
-00026540: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-00026550: 2020 666f 7220 7473 2069 6e20 746f 7563    for ts in touc
-00026560: 6865 645f 7461 736b 733a 0a20 2020 2020  hed_tasks:.     
-00026570: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-00026580: 7465 2069 6e20 2822 6d65 6d6f 7279 222c  te in ("memory",
-00026590: 2022 6572 7265 6422 293a 0a20 2020 2020   "erred"):.     
-000265a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000265b0: 7265 706f 7274 5f6f 6e5f 6b65 7928 7473  report_on_key(ts
-000265c0: 3d74 732c 2063 6c69 656e 743d 636c 6965  =ts, client=clie
-000265d0: 6e74 290a 0a20 2020 2020 2020 2065 6e64  nt)..        end
-000265e0: 203d 2074 696d 6528 290a 2020 2020 2020   = time().      
-000265f0: 2020 7365 6c66 2e64 6967 6573 745f 6d65    self.digest_me
-00026600: 7472 6963 2822 7570 6461 7465 2d67 7261  tric("update-gra
-00026610: 7068 2d64 7572 6174 696f 6e22 2c20 656e  ph-duration", en
-00026620: 6420 2d20 7374 6172 7429 0a0a 2020 2020  d - start)..    
-00026630: 6465 6620 5f67 656e 6572 6174 655f 7461  def _generate_ta
-00026640: 736b 7374 6174 6573 280a 2020 2020 2020  skstates(.      
-00026650: 2020 7365 6c66 2c20 6b65 7973 3a20 7365    self, keys: se
-00026660: 745b 7374 725d 2c20 6473 6b3a 2064 6963  t[str], dsk: dic
-00026670: 742c 2064 6570 656e 6465 6e63 6965 733a  t, dependencies:
-00026680: 2064 6963 742c 2063 6f6d 7075 7461 7469   dict, computati
-00026690: 6f6e 3a20 436f 6d70 7574 6174 696f 6e0a  on: Computation.
-000266a0: 2020 2020 2920 2d3e 2074 7570 6c65 3a0a      ) -> tuple:.
-000266b0: 2020 2020 2020 2020 2320 4765 7420 6f72          # Get or
-000266c0: 2063 7265 6174 6520 7461 736b 2073 7461   create task sta
-000266d0: 7465 730a 2020 2020 2020 2020 7275 6e6e  tes.        runn
-000266e0: 6162 6c65 203d 205b 5d0a 2020 2020 2020  able = [].      
-000266f0: 2020 6e65 775f 7461 736b 7320 3d20 5b5d    new_tasks = []
-00026700: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
-00026710: 206c 6973 7428 6b65 7973 290a 2020 2020   list(keys).    
-00026720: 2020 2020 7461 736b 7320 3d20 5b5d 0a20      tasks = []. 
-00026730: 2020 2020 2020 2074 6f75 6368 6564 5f6b         touched_k
-00026740: 6579 7320 3d20 7365 7428 290a 2020 2020  eys = set().    
-00026750: 2020 2020 746f 7563 6865 645f 7461 736b      touched_task
-00026760: 7320 3d20 5b5d 0a20 2020 2020 2020 2077  s = [].        w
-00026770: 6869 6c65 2073 7461 636b 3a0a 2020 2020  hile stack:.    
-00026780: 2020 2020 2020 2020 6b20 3d20 7374 6163          k = stac
-00026790: 6b2e 706f 7028 290a 2020 2020 2020 2020  k.pop().        
-000267a0: 2020 2020 6966 206b 2069 6e20 746f 7563      if k in touc
-000267b0: 6865 645f 6b65 7973 3a0a 2020 2020 2020  hed_keys:.      
-000267c0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000267d0: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
-000267e0: 2058 5858 2048 6176 6520 6120 6d65 7468   XXX Have a meth
-000267f0: 6f64 2067 6574 5f74 6173 6b5f 7374 6174  od get_task_stat
-00026800: 6528 7365 6c66 2c20 6b29 203f 0a20 2020  e(self, k) ?.   
-00026810: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-00026820: 6c66 2e74 6173 6b73 2e67 6574 286b 290a  lf.tasks.get(k).
-00026830: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00026840: 732e 6170 7065 6e64 2874 7329 0a20 2020  s.append(ts).   
-00026850: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-00026860: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00026870: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00026880: 662e 6e65 775f 7461 736b 286b 2c20 6473  f.new_task(k, ds
-00026890: 6b2e 6765 7428 6b29 2c20 2272 656c 6561  k.get(k), "relea
-000268a0: 7365 6422 2c20 636f 6d70 7574 6174 696f  sed", computatio
-000268b0: 6e3d 636f 6d70 7574 6174 696f 6e29 0a20  n=computation). 
-000268c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000268d0: 6577 5f74 6173 6b73 2e61 7070 656e 6428  ew_tasks.append(
-000268e0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-000268f0: 656c 6966 206e 6f74 2074 732e 7275 6e5f  elif not ts.run_
-00026900: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
-00026910: 2020 2020 2020 7473 2e72 756e 5f73 7065        ts.run_spe
-00026920: 6320 3d20 6473 6b2e 6765 7428 6b29 0a0a  c = dsk.get(k)..
-00026930: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00026940: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
-00026950: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
-00026960: 6162 6c65 2e61 7070 656e 6428 7473 290a  able.append(ts).
-00026970: 2020 2020 2020 2020 2020 2020 746f 7563              touc
-00026980: 6865 645f 6b65 7973 2e61 6464 286b 290a  hed_keys.add(k).
-00026990: 2020 2020 2020 2020 2020 2020 746f 7563              touc
-000269a0: 6865 645f 7461 736b 732e 6170 7065 6e64  hed_tasks.append
-000269b0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-000269c0: 2073 7461 636b 2e65 7874 656e 6428 6465   stack.extend(de
-000269d0: 7065 6e64 656e 6369 6573 2e67 6574 286b  pendencies.get(k
-000269e0: 2c20 2829 2929 0a0a 2020 2020 2020 2020  , ()))..        
-000269f0: 2320 4164 6420 6465 7065 6e64 656e 6369  # Add dependenci
-00026a00: 6573 0a20 2020 2020 2020 2066 6f72 206b  es.        for k
-00026a10: 6579 2c20 6465 7073 2069 6e20 6465 7065  ey, deps in depe
-00026a20: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
-00026a30: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-00026a40: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-00026a50: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
-00026a60: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
-00026a70: 206f 7220 7473 2e64 6570 656e 6465 6e63   or ts.dependenc
-00026a80: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00026a90: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00026aa0: 2020 2020 2020 2020 2020 666f 7220 6465            for de
-00026ab0: 7020 696e 2064 6570 733a 0a20 2020 2020  p in deps:.     
-00026ac0: 2020 2020 2020 2020 2020 2064 7473 203d             dts =
-00026ad0: 2073 656c 662e 7461 736b 735b 6465 705d   self.tasks[dep]
-00026ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026af0: 2074 732e 6164 645f 6465 7065 6e64 656e   ts.add_dependen
-00026b00: 6379 2864 7473 290a 0a20 2020 2020 2020  cy(dts)..       
-00026b10: 2069 6620 6c65 6e28 746f 7563 6865 645f   if len(touched_
-00026b20: 7461 736b 7329 203c 206c 656e 286b 6579  tasks) < len(key
-00026b30: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00026b40: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
-00026b50: 2020 2020 2020 2020 2020 2020 2022 5375               "Su
-00026b60: 626d 6974 7465 6420 6772 6170 6820 7769  bmitted graph wi
-00026b70: 7468 206c 656e 6774 6820 2573 2062 7574  th length %s but
-00026b80: 2072 6571 7565 7374 6564 2067 7261 7068   requested graph
-00026b90: 206f 6e6c 7920 696e 636c 7564 6573 2025   only includes %
-00026ba0: 7320 6b65 7973 222c 0a20 2020 2020 2020  s keys",.       
-00026bb0: 2020 2020 2020 2020 206c 656e 2874 6f75           len(tou
-00026bc0: 6368 6564 5f74 6173 6b73 292c 0a20 2020  ched_tasks),.   
-00026bd0: 2020 2020 2020 2020 2020 2020 206c 656e               len
-00026be0: 286b 6579 7329 2c0a 2020 2020 2020 2020  (keys),.        
-00026bf0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00026c00: 7475 726e 2072 756e 6e61 626c 652c 2074  turn runnable, t
-00026c10: 6f75 6368 6564 5f74 6173 6b73 2c20 6e65  ouched_tasks, ne
-00026c20: 775f 7461 736b 730a 0a20 2020 2064 6566  w_tasks..    def
-00026c30: 205f 7061 7273 655f 616e 645f 6170 706c   _parse_and_appl
-00026c40: 795f 616e 6e6f 7461 7469 6f6e 7328 0a20  y_annotations(. 
-00026c50: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00026c60: 2020 2020 2074 6173 6b73 3a20 4974 6572       tasks: Iter
-00026c70: 6162 6c65 5b54 6173 6b53 7461 7465 5d2c  able[TaskState],
-00026c80: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
-00026c90: 696f 6e73 3a20 6469 6374 2c0a 2020 2020  ions: dict,.    
-00026ca0: 2020 2020 6c61 7965 725f 616e 6e6f 7461      layer_annota
-00026cb0: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
-00026cc0: 2064 6963 745d 2c0a 2020 2020 2020 2020   dict],.        
-00026cd0: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
-00026ce0: 6b65 7973 3a20 6469 6374 5b48 6173 6861  keys: dict[Hasha
-00026cf0: 626c 652c 2073 7472 5d2c 0a20 2020 2029  ble, str],.    )
-00026d00: 202d 3e20 6469 6374 5b73 7472 2c20 6469   -> dict[str, di
-00026d10: 6374 5b73 7472 2c20 416e 795d 5d3a 0a20  ct[str, Any]]:. 
-00026d20: 2020 2020 2020 2022 2222 4170 706c 7920         """Apply 
-00026d30: 7468 6520 7072 6f76 6964 6564 2061 6e6e  the provided ann
-00026d40: 6f74 6174 696f 6e73 2074 6f20 7468 6520  otations to the 
-00026d50: 7072 6f76 6964 6564 2060 5461 736b 5374  provided `TaskSt
-00026d60: 6174 6560 206f 626a 6563 7473 2e0a 0a20  ate` objects... 
-00026d70: 2020 2020 2020 2054 6865 2072 6177 2061         The raw a
-00026d80: 6e6e 6f74 6174 696f 6e73 2077 696c 6c20  nnotations will 
-00026d90: 6265 2073 746f 7265 6420 696e 2074 6865  be stored in the
-00026da0: 2060 616e 6e6f 7461 7469 6f6e 7360 2061   `annotations` a
-00026db0: 7474 7269 6275 7465 2e0a 0a20 2020 2020  ttribute...     
-00026dc0: 2020 204c 6179 6572 202f 206b 6579 2073     Layer / key s
-00026dd0: 7065 6369 6669 6320 616e 6e6f 7461 7469  pecific annotati
-00026de0: 6f6e 7320 7769 6c6c 2074 616b 6520 7072  ons will take pr
-00026df0: 6563 6564 656e 6365 206f 7665 7220 676c  ecedence over gl
-00026e00: 6f62 616c 202f 2067 656e 6572 6963 2061  obal / generic a
-00026e10: 6e6e 6f74 6174 696f 6e73 2e0a 0a20 2020  nnotations...   
-00026e20: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-00026e30: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00026e40: 2d2d 0a20 2020 2020 2020 2074 6173 6b73  --.        tasks
-00026e50: 203a 2049 7465 7261 626c 655b 5461 736b   : Iterable[Task
-00026e60: 5374 6174 655d 0a20 2020 2020 2020 2020  State].         
-00026e70: 2020 205f 6465 7363 7269 7074 696f 6e5f     _description_
-00026e80: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
-00026e90: 696f 6e73 203a 2064 6963 740a 2020 2020  ions : dict.    
-00026ea0: 2020 2020 2020 2020 5f64 6573 6372 6970          _descrip
-00026eb0: 7469 6f6e 5f0a 2020 2020 2020 2020 6c61  tion_.        la
-00026ec0: 7965 725f 616e 6e6f 7461 7469 6f6e 7320  yer_annotations 
-00026ed0: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
-00026ee0: 5d0a 2020 2020 2020 2020 2020 2020 5f64  ].            _d
-00026ef0: 6573 6372 6970 7469 6f6e 5f0a 0a20 2020  escription_..   
-00026f00: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-00026f10: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-00026f20: 2020 2020 2072 6573 6f6c 7665 645f 616e       resolved_an
-00026f30: 6e6f 7461 7469 6f6e 733a 2064 6963 740a  notations: dict.
-00026f40: 2020 2020 2020 2020 2020 2020 4120 6d61              A ma
-00026f50: 7070 696e 6720 6f66 2061 6c6c 2072 6573  pping of all res
-00026f60: 6f6c 7665 6420 616e 6e6f 7461 7469 6f6e  olved annotation
-00026f70: 7320 696e 2074 6865 2066 6f72 6d61 743a  s in the format:
-00026f80: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-00026f90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00026fa0: 2020 2020 2020 2020 2022 616e 6e6f 7461           "annota
-00026fb0: 7469 6f6e 223a 207b 0a20 2020 2020 2020  tion": {.       
-00026fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026fd0: 2022 6b65 7922 3a20 7661 6c75 652c 0a20   "key": value,. 
-00026fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ff0: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
-00027000: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00027010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00027020: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
-00027030: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00027040: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00027050: 7265 736f 6c76 6564 5f61 6e6e 6f74 6174  resolved_annotat
-00027060: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
-00027070: 6469 6374 5b73 7472 2c20 416e 795d 5d20  dict[str, Any]] 
-00027080: 3d20 6465 6661 756c 7464 6963 7428 6469  = defaultdict(di
-00027090: 6374 290a 2020 2020 2020 2020 666f 7220  ct).        for 
-000270a0: 7473 2069 6e20 7461 736b 733a 0a20 2020  ts in tasks:.   
-000270b0: 2020 2020 2020 2020 206b 6579 203d 2074           key = t
-000270c0: 732e 6b65 790a 2020 2020 2020 2020 2020  s.key.          
-000270d0: 2020 2320 5468 6973 2063 6f75 6c64 2062    # This could b
-000270e0: 6520 6120 7479 7065 6420 6469 6374 0a20  e a typed dict. 
-000270f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00027100: 7420 616e 6e6f 7461 7469 6f6e 7320 616e  t annotations an
-00027110: 6420 6b65 7920 6e6f 7420 696e 206c 6179  d key not in lay
-00027120: 6572 5f61 6e6e 6f74 6174 696f 6e73 3a0a  er_annotations:.
-00027130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027140: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00027150: 2020 2020 206f 7574 203d 2061 6e6e 6f74       out = annot
-00027160: 6174 696f 6e73 2e63 6f70 7928 290a 2020  ations.copy().  
-00027170: 2020 2020 2020 2020 2020 6f75 742e 7570            out.up
-00027180: 6461 7465 286c 6179 6572 5f61 6e6e 6f74  date(layer_annot
-00027190: 6174 696f 6e73 2e67 6574 286b 6579 2c20  ations.get(key, 
-000271a0: 7b7d 2929 0a20 2020 2020 2020 2020 2020  {})).           
-000271b0: 2066 6f72 2061 6e6e 6f74 2c20 7661 6c75   for annot, valu
-000271c0: 6520 696e 206f 7574 2e69 7465 6d73 2829  e in out.items()
-000271d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000271e0: 2020 2320 506f 7020 7468 6520 6b65 7920    # Pop the key 
-000271f0: 7369 6e63 6520 6e61 6d65 7320 646f 6e27  since names don'
-00027200: 7420 616c 7761 7973 206d 6174 6368 2061  t always match a
-00027210: 7474 7269 6275 7465 730a 2020 2020 2020  ttributes.      
-00027220: 2020 2020 2020 2020 2020 6966 2063 616c            if cal
-00027230: 6c61 626c 6528 7661 6c75 6529 3a0a 2020  lable(value):.  
-00027240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027250: 2020 7661 6c75 6520 3d20 7661 6c75 6528    value = value(
-00027260: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
-00027270: 6b65 7973 5b6b 6579 5d29 0a20 2020 2020  keys[key]).     
-00027280: 2020 2020 2020 2020 2020 206f 7574 5b61             out[a
-00027290: 6e6e 6f74 5d20 3d20 7661 6c75 650a 2020  nnot] = value.  
-000272a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000272b0: 736f 6c76 6564 5f61 6e6e 6f74 6174 696f  solved_annotatio
-000272c0: 6e73 5b61 6e6e 6f74 5d5b 6b65 795d 203d  ns[annot][key] =
-000272d0: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
-000272e0: 2020 2020 2020 2020 6966 2061 6e6e 6f74          if annot
-000272f0: 2069 6e20 2822 7265 7374 7269 6374 696f   in ("restrictio
-00027300: 6e73 222c 2022 776f 726b 6572 7322 293a  ns", "workers"):
-00027310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027320: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-00027330: 7374 616e 6365 2876 616c 7565 2c20 286c  stance(value, (l
-00027340: 6973 742c 2074 7570 6c65 2c20 7365 7429  ist, tuple, set)
-00027350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00027360: 2020 2020 2020 2020 2020 2076 616c 7565             value
-00027370: 203d 205b 7661 6c75 655d 0a20 2020 2020   = [value].     
-00027380: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00027390: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-000273a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-000273b0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-000273c0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-000273d0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-000273e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000273f0: 2077 2069 6e20 7661 6c75 653a 0a20 2020   w in value:.   
-00027400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027410: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00027420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027430: 2020 2020 2020 7720 3d20 7365 6c66 2e63        w = self.c
-00027440: 6f65 7263 655f 6164 6472 6573 7328 7729  oerce_address(w)
-00027450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027460: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00027470: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
-00027480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027490: 2020 2020 2020 2020 2320 4e6f 7420 6120          # Not a 
-000274a0: 7661 6c69 6420 6164 6472 6573 732c 2062  valid address, b
-000274b0: 7574 2070 6572 6861 7073 2069 7427 7320  ut perhaps it's 
-000274c0: 6120 686f 7374 6e61 6d65 0a20 2020 2020  a hostname.     
-000274d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000274e0: 2020 2020 2020 2068 6f73 745f 7265 7374         host_rest
-000274f0: 7269 6374 696f 6e73 2e61 6464 2877 290a  rictions.add(w).
-00027500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027510: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00027520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027530: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00027540: 5f72 6573 7472 6963 7469 6f6e 732e 6164  _restrictions.ad
-00027550: 6428 7729 0a20 2020 2020 2020 2020 2020  d(w).           
-00027560: 2020 2020 2020 2020 2069 6620 686f 7374           if host
-00027570: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
-00027580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027590: 2020 2020 2020 2074 732e 686f 7374 5f72         ts.host_r
-000275a0: 6573 7472 6963 7469 6f6e 7320 3d20 686f  estrictions = ho
-000275b0: 7374 5f72 6573 7472 6963 7469 6f6e 730a  st_restrictions.
-000275c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000275d0: 2020 2020 6966 2077 6f72 6b65 725f 7265      if worker_re
-000275e0: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
-000275f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027600: 2020 2020 7473 2e77 6f72 6b65 725f 7265      ts.worker_re
-00027610: 7374 7269 6374 696f 6e73 203d 2077 6f72  strictions = wor
-00027620: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00027630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027640: 2065 6c69 6620 616e 6e6f 7420 696e 2028   elif annot in (
-00027650: 226c 6f6f 7365 5f72 6573 7472 6963 7469  "loose_restricti
-00027660: 6f6e 7322 2c20 2261 6c6c 6f77 5f6f 7468  ons", "allow_oth
-00027670: 6572 5f77 6f72 6b65 7273 2229 3a0a 2020  er_workers"):.  
-00027680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027690: 2020 7473 2e6c 6f6f 7365 5f72 6573 7472    ts.loose_restr
-000276a0: 6963 7469 6f6e 7320 3d20 7661 6c75 650a  ictions = value.
-000276b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276c0: 656c 6966 2061 6e6e 6f74 203d 3d20 2272  elif annot == "r
-000276d0: 6573 6f75 7263 6573 223a 0a20 2020 2020  esources":.     
-000276e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000276f0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-00027700: 2876 616c 7565 2c20 6469 6374 290a 2020  (value, dict).  
-00027710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027720: 2020 7473 2e72 6573 6f75 7263 655f 7265    ts.resource_re
-00027730: 7374 7269 6374 696f 6e73 203d 2076 616c  strictions = val
-00027740: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00027750: 2020 2065 6c69 6620 616e 6e6f 7420 3d3d     elif annot ==
-00027760: 2022 7072 696f 7269 7479 223a 0a20 2020   "priority":.   
-00027770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027780: 2023 2053 6565 2053 6368 6564 756c 6572   # See Scheduler
-00027790: 2e5f 7365 745f 7072 696f 7269 7469 6573  ._set_priorities
-000277a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000277b0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-000277c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000277d0: 6966 2061 6e6e 6f74 203d 3d20 2272 6574  if annot == "ret
-000277e0: 7269 6573 223a 0a20 2020 2020 2020 2020  ries":.         
-000277f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00027800: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
-00027810: 7565 2c20 696e 7429 0a20 2020 2020 2020  ue, int).       
-00027820: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00027830: 7265 7472 6965 7320 3d20 7661 6c75 650a  retries = value.
-00027840: 2020 2020 2020 2020 2020 2020 7473 2e61              ts.a
-00027850: 6e6e 6f74 6174 696f 6e73 203d 206f 7574  nnotations = out
-00027860: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00027870: 6469 6374 2872 6573 6f6c 7665 645f 616e  dict(resolved_an
-00027880: 6e6f 7461 7469 6f6e 7329 0a0a 2020 2020  notations)..    
-00027890: 6465 6620 5f73 6574 5f70 7269 6f72 6974  def _set_priorit
-000278a0: 6965 7328 0a20 2020 2020 2020 2073 656c  ies(.        sel
-000278b0: 662c 0a20 2020 2020 2020 2069 6e74 6572  f,.        inter
-000278c0: 6e61 6c5f 7072 696f 7269 7479 3a20 6469  nal_priority: di
-000278d0: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
-000278e0: 6f6e 652c 0a20 2020 2020 2020 2073 7562  one,.        sub
-000278f0: 6d69 7474 696e 675f 7461 736b 3a20 7374  mitting_task: st
-00027900: 7220 7c20 4e6f 6e65 2c0a 2020 2020 2020  r | None,.      
-00027910: 2020 7573 6572 5f70 7269 6f72 6974 793a    user_priority:
-00027920: 2069 6e74 207c 2064 6963 745b 7374 722c   int | dict[str,
-00027930: 2069 6e74 5d2c 0a20 2020 2020 2020 2066   int],.        f
-00027940: 6966 6f5f 7469 6d65 6f75 743a 2069 6e74  ifo_timeout: int
-00027950: 207c 2066 6c6f 6174 207c 2073 7472 2c0a   | float | str,.
-00027960: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
-00027970: 6c6f 6174 2c0a 2020 2020 2020 2020 6473  loat,.        ds
-00027980: 6b3a 2064 6963 742c 0a20 2020 2020 2020  k: dict,.       
-00027990: 2074 6173 6b73 3a20 6c69 7374 5b54 6173   tasks: list[Tas
-000279a0: 6b53 7461 7465 5d2c 0a20 2020 2020 2020  kState],.       
-000279b0: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
-000279c0: 6963 742c 0a20 2020 2029 202d 3e20 4e6f  ict,.    ) -> No
-000279d0: 6e65 3a0a 2020 2020 2020 2020 6669 666f  ne:.        fifo
-000279e0: 5f74 696d 656f 7574 203d 2070 6172 7365  _timeout = parse
-000279f0: 5f74 696d 6564 656c 7461 2866 6966 6f5f  _timedelta(fifo_
-00027a00: 7469 6d65 6f75 7429 0a20 2020 2020 2020  timeout).       
-00027a10: 2069 6620 7375 626d 6974 7469 6e67 5f74   if submitting_t
-00027a20: 6173 6b3a 2020 2320 7375 622d 7461 736b  ask:  # sub-task
-00027a30: 7320 6765 7420 6265 7474 6572 2070 7269  s get better pri
-00027a40: 6f72 6974 7920 7468 616e 2070 6172 656e  ority than paren
-00027a50: 7420 7461 736b 730a 2020 2020 2020 2020  t tasks.        
-00027a60: 2020 2020 7374 7320 3d20 7365 6c66 2e74      sts = self.t
-00027a70: 6173 6b73 2e67 6574 2873 7562 6d69 7474  asks.get(submitt
-00027a80: 696e 675f 7461 736b 290a 2020 2020 2020  ing_task).      
-00027a90: 2020 2020 2020 6966 2073 7473 2069 7320        if sts is 
-00027aa0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00027ab0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00027ac0: 2073 7473 2e70 7269 6f72 6974 790a 2020   sts.priority.  
-00027ad0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-00027ae0: 6e65 7261 7469 6f6e 203d 2073 7473 2e70  neration = sts.p
-00027af0: 7269 6f72 6974 795b 305d 202d 2030 2e30  riority[0] - 0.0
-00027b00: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
-00027b10: 7365 3a20 2023 2073 7570 6572 2d74 6173  se:  # super-tas
-00027b20: 6b20 616c 7265 6164 7920 636c 6561 6e65  k already cleane
-00027b30: 6420 7570 0a20 2020 2020 2020 2020 2020  d up.           
-00027b40: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
-00027b50: 3d20 7365 6c66 2e67 656e 6572 6174 696f  = self.generatio
-00027b60: 6e0a 2020 2020 2020 2020 656c 6966 2073  n.        elif s
-00027b70: 656c 662e 5f6c 6173 745f 7469 6d65 202b  elf._last_time +
-00027b80: 2066 6966 6f5f 7469 6d65 6f75 7420 3c20   fifo_timeout < 
-00027b90: 7374 6172 743a 0a20 2020 2020 2020 2020  start:.         
-00027ba0: 2020 2073 656c 662e 6765 6e65 7261 7469     self.generati
-00027bb0: 6f6e 202b 3d20 3120 2023 206f 6c64 6572  on += 1  # older
-00027bc0: 2067 7261 7068 2067 656e 6572 6174 696f   graph generatio
-00027bd0: 6e73 2074 616b 6520 7072 6563 6564 656e  ns take preceden
-00027be0: 6365 0a20 2020 2020 2020 2020 2020 2067  ce.            g
-00027bf0: 656e 6572 6174 696f 6e20 3d20 7365 6c66  eneration = self
-00027c00: 2e67 656e 6572 6174 696f 6e0a 2020 2020  .generation.    
-00027c10: 2020 2020 2020 2020 7365 6c66 2e5f 6c61          self._la
-00027c20: 7374 5f74 696d 6520 3d20 7374 6172 740a  st_time = start.
-00027c30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00027c40: 2020 2020 2020 2020 2020 6765 6e65 7261            genera
-00027c50: 7469 6f6e 203d 2073 656c 662e 6765 6e65  tion = self.gene
-00027c60: 7261 7469 6f6e 0a0a 2020 2020 2020 2020  ration..        
-00027c70: 6966 2069 6e74 6572 6e61 6c5f 7072 696f  if internal_prio
-00027c80: 7269 7479 2069 7320 4e6f 6e65 3a0a 2020  rity is None:.  
-00027c90: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
-00027ca0: 7669 6e67 2061 6c6c 206e 6f6e 2d6c 6f63  ving all non-loc
-00027cb0: 616c 206b 6579 7320 6265 666f 7265 2063  al keys before c
-00027cc0: 616c 6c69 6e67 206f 7264 6572 2829 0a20  alling order(). 
-00027cd0: 2020 2020 2020 2020 2020 2064 736b 5f6b             dsk_k
-00027ce0: 6579 7320 3d20 7365 7428 6473 6b29 2020  eys = set(dsk)  
-00027cf0: 2320 696e 7465 7273 6563 7469 6f6e 2829  # intersection()
-00027d00: 206f 6620 7365 7473 2069 7320 6d75 6368   of sets is much
-00027d10: 2066 6173 7465 7220 7468 616e 2064 6963   faster than dic
-00027d20: 745f 6b65 7973 0a20 2020 2020 2020 2020  t_keys.         
-00027d30: 2020 2073 7472 6970 7065 645f 6465 7073     stripped_deps
-00027d40: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00027d50: 2020 2020 206b 3a20 762e 696e 7465 7273       k: v.inters
-00027d60: 6563 7469 6f6e 2864 736b 5f6b 6579 7329  ection(dsk_keys)
-00027d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027d80: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
-00027d90: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
-00027da0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00027db0: 2020 6966 206b 2069 6e20 6473 6b5f 6b65    if k in dsk_ke
-00027dc0: 7973 0a20 2020 2020 2020 2020 2020 207d  ys.            }
-00027dd0: 0a20 2020 2020 2020 2020 2020 2069 6e74  .            int
-00027de0: 6572 6e61 6c5f 7072 696f 7269 7479 203d  ernal_priority =
-00027df0: 2064 6173 6b2e 6f72 6465 722e 6f72 6465   dask.order.orde
-00027e00: 7228 6473 6b2c 2064 6570 656e 6465 6e63  r(dsk, dependenc
-00027e10: 6965 733d 7374 7269 7070 6564 5f64 6570  ies=stripped_dep
-00027e20: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
-00027e30: 7473 2069 6e20 7461 736b 733a 0a20 2020  ts in tasks:.   
-00027e40: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
-00027e50: 2055 6e64 6572 2077 6869 6368 2063 6972   Under which cir
-00027e60: 6375 6d73 7461 6e63 6573 2077 6f75 6c64  cumstances would
-00027e70: 2061 2074 6173 6b20 6e6f 7420 6861 7665   a task not have
-00027e80: 2061 0a20 2020 2020 2020 2020 2020 2023   a.            #
-00027e90: 2070 7269 6f72 6974 6979 2061 7373 6967   prioritiy assig
-00027ea0: 6e65 6420 6279 206e 6f77 3f20 4172 6520  ned by now? Are 
-00027eb0: 7468 6573 6520 7363 6174 7465 7265 6420  these scattered 
-00027ec0: 7461 736b 730a 2020 2020 2020 2020 2020  tasks.          
-00027ed0: 2020 2320 6578 636c 7573 6976 656c 7920    # exclusively 
-00027ee0: 6f72 2073 6f6d 6574 6869 6e67 2065 6c73  or something els
-00027ef0: 653f 0a20 2020 2020 2020 2020 2020 2074  e?.            t
-00027f00: 6173 6b5f 7573 6572 5f70 7269 6f20 3d20  ask_user_prio = 
-00027f10: 7573 6572 5f70 7269 6f72 6974 790a 2020  user_priority.  
-00027f20: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00027f30: 6e73 7461 6e63 6528 7573 6572 5f70 7269  nstance(user_pri
-00027f40: 6f72 6974 792c 2064 6963 7429 3a0a 2020  ority, dict):.  
-00027f50: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00027f60: 736b 5f75 7365 725f 7072 696f 203d 2075  sk_user_prio = u
-00027f70: 7365 725f 7072 696f 7269 7479 2e67 6574  ser_priority.get
-00027f80: 2874 732e 6b65 792c 2030 290a 2020 2020  (ts.key, 0).    
-00027f90: 2020 2020 2020 2020 616e 6e6f 7461 7465          annotate
-00027fa0: 645f 7072 696f 203d 2074 732e 616e 6e6f  d_prio = ts.anno
-00027fb0: 7461 7469 6f6e 732e 6765 7428 2270 7269  tations.get("pri
-00027fc0: 6f72 6974 7922 2c20 7b7d 290a 2020 2020  ority", {}).    
-00027fd0: 2020 2020 2020 2020 6966 206e 6f74 2061          if not a
-00027fe0: 6e6e 6f74 6174 6564 5f70 7269 6f3a 0a20  nnotated_prio:. 
-00027ff0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00028000: 6e6e 6f74 6174 6564 5f70 7269 6f20 3d20  nnotated_prio = 
-00028010: 7461 736b 5f75 7365 725f 7072 696f 0a0a  task_user_prio..
-00028020: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00028030: 6f74 2074 732e 7072 696f 7269 7479 2061  ot ts.priority a
-00028040: 6e64 2074 732e 6b65 7920 696e 2069 6e74  nd ts.key in int
-00028050: 6572 6e61 6c5f 7072 696f 7269 7479 3a0a  ernal_priority:.
+00010880: 2020 2063 6c69 656e 745f 6d73 6773 2e73     client_msgs.s
+00010890: 6574 6465 6661 756c 7428 632c 205b 5d29  etdefault(c, [])
+000108a0: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
+000108b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000108c0: 2020 666f 7220 772c 206e 6577 5f6d 7367    for w, new_msg
+000108d0: 7320 696e 2062 5f77 6d73 6773 2e69 7465  s in b_wmsgs.ite
+000108e0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+000108f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00010900: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
+00010910: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
+00010920: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
+00010930: 2020 2020 2020 2020 2020 7374 6172 7420            start 
+00010940: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+00010950: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00010960: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010970: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00010980: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00010990: 2020 2020 2020 2066 2249 6d70 6f73 7369         f"Impossi
+000109a0: 626c 6520 7472 616e 7369 7469 6f6e 2066  ble transition f
+000109b0: 726f 6d20 7b73 7461 7274 7d20 746f 207b  rom {start} to {
+000109c0: 6669 6e69 7368 7d20 666f 7220 7b6b 6579  finish} for {key
+000109d0: 2172 7d3a 2022 0a20 2020 2020 2020 2020  !r}: ".         
+000109e0: 2020 2020 2020 2020 2020 2066 227b 7374             f"{st
+000109f0: 696d 756c 7573 5f69 643d 7d2c 207b 6b77  imulus_id=}, {kw
+00010a00: 6172 6773 3d7d 2c20 7374 6f72 793d 7b73  args=}, story={s
+00010a10: 656c 662e 7374 6f72 7928 7473 297d 220a  elf.story(ts)}".
+00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a30: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00010a40: 6620 6e6f 7420 7374 696d 756c 7573 5f69  f not stimulus_i
+00010a50: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00010a60: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+00010a70: 2053 5449 4d55 4c55 535f 4944 5f55 4e53   STIMULUS_ID_UNS
+00010a80: 4554 0a0a 2020 2020 2020 2020 2020 2020  ET..            
+00010a90: 6163 7475 616c 5f66 696e 6973 6820 3d20  actual_finish = 
+00010aa0: 7473 2e5f 7374 6174 650a 2020 2020 2020  ts._state.      
+00010ab0: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00010ac0: 6974 696f 6e5f 6c6f 672e 6170 7065 6e64  ition_log.append
+00010ad0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00010ae0: 2020 5472 616e 7369 7469 6f6e 280a 2020    Transition(.  
+00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b00: 2020 6b65 792c 2073 7461 7274 2c20 6163    key, start, ac
+00010b10: 7475 616c 5f66 696e 6973 682c 2072 6563  tual_finish, rec
+00010b20: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
+00010b30: 696d 756c 7573 5f69 642c 2074 696d 6528  imulus_id, time(
+00010b40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010b50: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00010b60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00010b70: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00010b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b90: 6966 2073 7469 6d75 6c75 735f 6964 203d  if stimulus_id =
+00010ba0: 3d20 5354 494d 554c 5553 5f49 445f 554e  = STIMULUS_ID_UN
+00010bb0: 5345 543a 0a20 2020 2020 2020 2020 2020  SET:.           
+00010bc0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00010bd0: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
+00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bf0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+00010c00: 6420 6e6f 7420 7365 7420 6475 7269 6e67  d not set during
+00010c10: 2053 6368 6564 756c 6572 2074 7261 6e73   Scheduler trans
+00010c20: 6974 696f 6e22 0a20 2020 2020 2020 2020  ition".         
+00010c30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00010c40: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00010c50: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+00010c60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00010c70: 5472 616e 7369 7469 6f6e 6564 2025 7220  Transitioned %r 
+00010c80: 2573 2d3e 2573 2028 6163 7475 616c 3a20  %s->%s (actual: 
+00010c90: 2573 292e 2020 436f 6e73 6571 7565 6e63  %s).  Consequenc
+00010ca0: 653a 2025 7322 2c0a 2020 2020 2020 2020  e: %s",.        
+00010cb0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+00010cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010cd0: 2020 2020 2073 7461 7274 2c0a 2020 2020       start,.    
+00010ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cf0: 6669 6e69 7368 2c0a 2020 2020 2020 2020  finish,.        
+00010d00: 2020 2020 2020 2020 2020 2020 6163 7475              actu
+00010d10: 616c 5f66 696e 6973 682c 0a20 2020 2020  al_finish,.     
+00010d20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00010d30: 6963 7428 7265 636f 6d6d 656e 6461 7469  ict(recommendati
+00010d40: 6f6e 7329 2c0a 2020 2020 2020 2020 2020  ons),.          
+00010d50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00010d60: 2020 2020 6966 2073 656c 662e 706c 7567      if self.plug
+00010d70: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
+00010d80: 2020 2020 2023 2054 656d 706f 7261 7269       # Temporari
+00010d90: 6c79 2070 7574 2062 6163 6b20 666f 7267  ly put back forg
+00010da0: 6f74 7465 6e20 6b65 7920 666f 7220 706c  otten key for pl
+00010db0: 7567 696e 2074 6f20 7265 7472 6965 7665  ugin to retrieve
+00010dc0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+00010dd0: 2020 2020 6966 2074 732e 5f73 7461 7465      if ts._state
+00010de0: 203d 3d20 2266 6f72 676f 7474 656e 223a   == "forgotten":
+00010df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e00: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
+00010e10: 7473 203d 2064 6570 656e 6465 6e74 730a  ts = dependents.
+00010e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e30: 2020 2020 7473 2e64 6570 656e 6465 6e63      ts.dependenc
+00010e40: 6965 7320 3d20 6465 7065 6e64 656e 6369  ies = dependenci
+00010e50: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00010e60: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+00010e70: 735b 7473 2e6b 6579 5d20 3d20 7473 0a20  s[ts.key] = ts. 
+00010e80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010e90: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
+00010ea0: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
+00010eb0: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
+00010ec0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00010ed0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00010ee0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+00010ef0: 6e2e 7472 616e 7369 7469 6f6e 286b 6579  n.transition(key
+00010f00: 2c20 7374 6172 742c 2061 6374 7561 6c5f  , start, actual_
+00010f10: 6669 6e69 7368 2c20 2a2a 6b77 6172 6773  finish, **kwargs
+00010f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010f30: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00010f40: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00010f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f60: 6c6f 6767 6572 2e69 6e66 6f28 2250 6c75  logger.info("Plu
+00010f70: 6769 6e20 6661 696c 6564 2077 6974 6820  gin failed with 
+00010f80: 6578 6365 7074 696f 6e22 2c20 6578 635f  exception", exc_
+00010f90: 696e 666f 3d54 7275 6529 0a20 2020 2020  info=True).     
+00010fa0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00010fb0: 2e73 7461 7465 203d 3d20 2266 6f72 676f  .state == "forgo
+00010fc0: 7474 656e 223a 0a20 2020 2020 2020 2020  tten":.         
+00010fd0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+00010fe0: 656c 662e 7461 736b 735b 7473 2e6b 6579  elf.tasks[ts.key
+00010ff0: 5d0a 0a20 2020 2020 2020 2020 2020 2074  ]..            t
+00011000: 6720 3d20 7473 2e67 726f 7570 0a20 2020  g = ts.group.   
+00011010: 2020 2020 2020 2020 2069 6620 7473 2e73           if ts.s
+00011020: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
+00011030: 656e 2220 616e 6420 7467 2e6e 616d 6520  en" and tg.name 
+00011040: 696e 2073 656c 662e 7461 736b 5f67 726f  in self.task_gro
+00011050: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
+00011060: 2020 2020 2023 2052 656d 6f76 6520 5461       # Remove Ta
+00011070: 736b 4772 6f75 7020 6966 2061 6c6c 2074  skGroup if all t
+00011080: 6173 6b73 2061 7265 2069 6e20 7468 6520  asks are in the 
+00011090: 666f 7267 6f74 7465 6e20 7374 6174 650a  forgotten state.
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 6966 2061 6c6c 2876 203d 3d20 3020 6f72  if all(v == 0 or
+000110c0: 206b 203d 3d20 2266 6f72 676f 7474 656e   k == "forgotten
+000110d0: 2220 666f 7220 6b2c 2076 2069 6e20 7467  " for k, v in tg
+000110e0: 2e73 7461 7465 732e 6974 656d 7328 2929  .states.items())
+000110f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011100: 2020 2020 2020 7473 2e70 7265 6669 782e        ts.prefix.
+00011110: 6772 6f75 7073 2e72 656d 6f76 6528 7467  groups.remove(tg
+00011120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011130: 2020 2020 2020 6465 6c20 7365 6c66 2e74        del self.t
+00011140: 6173 6b5f 6772 6f75 7073 5b74 672e 6e61  ask_groups[tg.na
+00011150: 6d65 5d0a 0a20 2020 2020 2020 2020 2020  me]..           
+00011160: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+00011170: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00011180: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00011190: 730a 2020 2020 2020 2020 6578 6365 7074  s.        except
+000111a0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+000111b0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+000111c0: 7863 6570 7469 6f6e 2822 4572 726f 7220  xception("Error 
+000111d0: 7472 616e 7369 7469 6f6e 696e 6720 2572  transitioning %r
+000111e0: 2066 726f 6d20 2572 2074 6f20 2572 222c   from %r to %r",
+000111f0: 206b 6579 2c20 7374 6172 742c 2066 696e   key, start, fin
+00011200: 6973 6829 0a20 2020 2020 2020 2020 2020  ish).           
+00011210: 2069 6620 4c4f 475f 5044 423a 0a20 2020   if LOG_PDB:.   
+00011220: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
+00011230: 6f72 7420 7064 620a 0a20 2020 2020 2020  ort pdb..       
+00011240: 2020 2020 2020 2020 2070 6462 2e73 6574           pdb.set
+00011250: 5f74 7261 6365 2829 0a20 2020 2020 2020  _trace().       
+00011260: 2020 2020 2072 6169 7365 0a0a 2020 2020       raise..    
+00011270: 6465 6620 5f74 7261 6e73 6974 696f 6e73  def _transitions
+00011280: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00011290: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+000112a0: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
+000112b0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+000112c0: 6773 3a20 4d73 6773 2c0a 2020 2020 2020  gs: Msgs,.      
+000112d0: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
+000112e0: 7367 732c 0a20 2020 2020 2020 2073 7469  sgs,.        sti
+000112f0: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
+00011300: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00011310: 2020 2020 2020 2222 2250 726f 6365 7373        """Process
+00011320: 2074 7261 6e73 6974 696f 6e73 2075 6e74   transitions unt
+00011330: 696c 206e 6f6e 6520 6172 6520 6c65 6674  il none are left
+00011340: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
+00011350: 6e63 6c75 6465 7320 6665 6564 6261 636b  ncludes feedback
+00011360: 2066 726f 6d20 7072 6576 696f 7573 2074   from previous t
+00011370: 7261 6e73 6974 696f 6e73 2061 6e64 2063  ransitions and c
+00011380: 6f6e 7469 6e75 6573 2075 6e74 696c 2077  ontinues until w
+00011390: 650a 2020 2020 2020 2020 7265 6163 6820  e.        reach 
+000113a0: 6120 7374 6561 6479 2073 7461 7465 0a20  a steady state. 
+000113b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000113c0: 2020 206b 6579 733a 2073 6574 5b73 7472     keys: set[str
+000113d0: 5d20 3d20 7365 7428 290a 2020 2020 2020  ] = set().      
+000113e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+000113f0: 7320 3d20 7265 636f 6d6d 656e 6461 7469  s = recommendati
+00011400: 6f6e 732e 636f 7079 2829 0a0a 2020 2020  ons.copy()..    
+00011410: 2020 2020 7768 696c 6520 7265 636f 6d6d      while recomm
+00011420: 656e 6461 7469 6f6e 733a 0a20 2020 2020  endations:.     
+00011430: 2020 2020 2020 206b 6579 2c20 6669 6e69         key, fini
+00011440: 7368 203d 2072 6563 6f6d 6d65 6e64 6174  sh = recommendat
+00011450: 696f 6e73 2e70 6f70 6974 656d 2829 0a20  ions.popitem(). 
+00011460: 2020 2020 2020 2020 2020 206b 6579 732e             keys.
+00011470: 6164 6428 6b65 7929 0a0a 2020 2020 2020  add(key)..      
+00011480: 2020 2020 2020 6e65 775f 7265 6373 2c20        new_recs, 
+00011490: 6e65 775f 636d 7367 732c 206e 6577 5f77  new_cmsgs, new_w
+000114a0: 6d73 6773 203d 2073 656c 662e 5f74 7261  msgs = self._tra
+000114b0: 6e73 6974 696f 6e28 6b65 792c 2066 696e  nsition(key, fin
+000114c0: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
+000114d0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+000114e0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2e75  ecommendations.u
+000114f0: 7064 6174 6528 6e65 775f 7265 6373 290a  pdate(new_recs).
+00011500: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00011510: 632c 206e 6577 5f6d 7367 7320 696e 206e  c, new_msgs in n
+00011520: 6577 5f63 6d73 6773 2e69 7465 6d73 2829  ew_cmsgs.items()
+00011530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011540: 2020 636c 6965 6e74 5f6d 7367 732e 7365    client_msgs.se
+00011550: 7464 6566 6175 6c74 2863 2c20 5b5d 292e  tdefault(c, []).
+00011560: 6578 7465 6e64 286e 6577 5f6d 7367 7329  extend(new_msgs)
+00011570: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00011580: 2077 2c20 6e65 775f 6d73 6773 2069 6e20   w, new_msgs in 
+00011590: 6e65 775f 776d 7367 732e 6974 656d 7328  new_wmsgs.items(
+000115a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000115b0: 2020 2077 6f72 6b65 725f 6d73 6773 2e73     worker_msgs.s
+000115c0: 6574 6465 6661 756c 7428 772c 205b 5d29  etdefault(w, [])
+000115d0: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
+000115e0: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+000115f0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00011600: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+00011610: 2064 6f77 6e63 6173 7420 616e 7469 7061   downcast antipa
+00011620: 7474 6572 6e0a 2020 2020 2020 2020 2020  ttern.          
+00011630: 2020 7363 6865 6475 6c65 7220 3d20 6361    scheduler = ca
+00011640: 7374 2853 6368 6564 756c 6572 2c20 7365  st(Scheduler, se
+00011650: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
+00011660: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
+00011670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011680: 2073 6368 6564 756c 6572 2e76 616c 6964   scheduler.valid
+00011690: 6174 655f 6b65 7928 6b65 7929 0a0a 2020  ate_key(key)..  
+000116a0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+000116b0: 5f72 656c 6561 7365 645f 7761 6974 696e  _released_waitin
+000116c0: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
+000116d0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+000116e0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+000116f0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00011700: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00011710: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00011720: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00011730: 2020 2020 2061 7373 6572 7420 7473 2e72       assert ts.r
+00011740: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
+00011750: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00011760: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00011770: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00011780: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00011790: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000117a0: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+000117b0: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+000117c0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+000117d0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+000117e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000117f0: 7373 6572 7420 6474 732e 7374 6174 6520  ssert dts.state 
+00011800: 6e6f 7420 696e 207b 2266 6f72 676f 7474  not in {"forgott
+00011810: 656e 222c 2022 6572 7265 6422 7d0a 0a20  en", "erred"}.. 
+00011820: 2020 2020 2020 2069 6620 7473 2e68 6173         if ts.has
+00011830: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+00011840: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00011850: 7265 7475 726e 207b 6b65 793a 2022 666f  return {key: "fo
+00011860: 7267 6f74 7465 6e22 7d2c 207b 7d2c 207b  rgotten"}, {}, {
+00011870: 7d0a 0a20 2020 2020 2020 2074 732e 7374  }..        ts.st
+00011880: 6174 6520 3d20 2277 6169 7469 6e67 220a  ate = "waiting".
+00011890: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+000118a0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+000118b0: 207b 7d0a 0a20 2020 2020 2020 2066 6f72   {}..        for
+000118c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+000118d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000118e0: 2020 2020 2069 6620 6e6f 7420 6474 732e       if not dts.
+000118f0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
+00011900: 2020 2020 2020 2020 2074 732e 7761 6974           ts.wait
+00011910: 696e 675f 6f6e 2e61 6464 2864 7473 290a  ing_on.add(dts).
+00011920: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00011930: 7473 2e73 7461 7465 203d 3d20 2272 656c  ts.state == "rel
+00011940: 6561 7365 6422 3a0a 2020 2020 2020 2020  eased":.        
+00011950: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00011960: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
+00011970: 203d 2022 7761 6974 696e 6722 0a20 2020   = "waiting".   
+00011980: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00011990: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000119a0: 7473 2e77 6169 7465 7273 2e61 6464 2874  ts.waiters.add(t
+000119b0: 7329 0a0a 2020 2020 2020 2020 7473 2e77  s)..        ts.w
+000119c0: 6169 7465 7273 203d 207b 6474 7320 666f  aiters = {dts fo
+000119d0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+000119e0: 6e64 656e 7473 2069 6620 6474 732e 7374  ndents if dts.st
+000119f0: 6174 6520 3d3d 2022 7761 6974 696e 6722  ate == "waiting"
+00011a00: 7d0a 0a20 2020 2020 2020 2069 6620 6e6f  }..        if no
+00011a10: 7420 7473 2e77 6169 7469 6e67 5f6f 6e3a  t ts.waiting_on:
+00011a20: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+00011a30: 4f54 453a 2077 6169 7469 6e67 2d3e 7072  OTE: waiting->pr
+00011a40: 6f63 6573 7369 6e67 2077 696c 6c20 7365  ocessing will se
+00011a50: 6e64 2074 6173 6b73 2074 6f20 7175 6575  nd tasks to queu
+00011a60: 6564 206f 7220 6e6f 2d77 6f72 6b65 7220  ed or no-worker 
+00011a70: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+00011a80: 206e 6563 6573 7361 7279 0a20 2020 2020   necessary.     
+00011a90: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00011aa0: 6174 696f 6e73 5b6b 6579 5d20 3d20 2270  ations[key] = "p
+00011ab0: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
+00011ac0: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
+00011ad0: 6d65 6e64 6174 696f 6e73 2c20 7b7d 2c20  mendations, {}, 
+00011ae0: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
+00011af0: 7369 7469 6f6e 5f6e 6f5f 776f 726b 6572  sition_no_worker
+00011b00: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
+00011b10: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+00011b20: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+00011b30: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00011b40: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00011b50: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+00011b60: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
+00011b70: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+00011b80: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00011b90: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00011ba0: 7365 7274 206e 6f74 2074 732e 6163 746f  sert not ts.acto
+00011bb0: 722c 2066 2241 6374 6f72 7320 6361 6e27  r, f"Actors can'
+00011bc0: 7420 6265 2069 6e20 606e 6f2d 776f 726b  t be in `no-work
+00011bd0: 6572 603a 207b 7473 7d22 0a20 2020 2020  er`: {ts}".     
+00011be0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00011bf0: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
+00011c00: 626c 650a 0a20 2020 2020 2020 2069 6620  ble..        if 
+00011c10: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
+00011c20: 655f 776f 726b 6572 5f6e 6f6e 5f72 6f6f  e_worker_non_roo
+00011c30: 7469 7368 2874 7329 3a0a 2020 2020 2020  tish(ts):.      
+00011c40: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
+00011c50: 6e61 626c 652e 6469 7363 6172 6428 7473  nable.discard(ts
+00011c60: 290a 2020 2020 2020 2020 2020 2020 776f  ).            wo
+00011c70: 726b 6572 5f6d 7367 7320 3d20 7365 6c66  rker_msgs = self
+00011c80: 2e5f 6164 645f 746f 5f70 726f 6365 7373  ._add_to_process
+00011c90: 696e 6728 7473 2c20 7773 290a 2020 2020  ing(ts, ws).    
+00011ca0: 2020 2020 2320 4966 206e 6f20 776f 726b      # If no work
+00011cb0: 6572 2c20 7461 736b 206a 7573 7420 7374  er, task just st
+00011cc0: 6179 7320 696e 2060 6e6f 2d77 6f72 6b65  ays in `no-worke
+00011cd0: 7260 0a0a 2020 2020 2020 2020 7265 7475  r`..        retu
+00011ce0: 726e 207b 7d2c 207b 7d2c 2077 6f72 6b65  rn {}, {}, worke
+00011cf0: 725f 6d73 6773 0a0a 2020 2020 6465 6620  r_msgs..    def 
+00011d00: 6465 6369 6465 5f77 6f72 6b65 725f 726f  decide_worker_ro
+00011d10: 6f74 6973 685f 7175 6575 696e 675f 6469  otish_queuing_di
+00011d20: 7361 626c 6564 280a 2020 2020 2020 2020  sabled(.        
+00011d30: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00011d40: 6174 650a 2020 2020 2920 2d3e 2057 6f72  ate.    ) -> Wor
+00011d50: 6b65 7253 7461 7465 207c 204e 6f6e 653a  kerState | None:
+00011d60: 0a20 2020 2020 2020 2022 2222 5069 636b  .        """Pick
+00011d70: 2061 2077 6f72 6b65 7220 666f 7220 6120   a worker for a 
+00011d80: 7275 6e6e 6162 6c65 2072 6f6f 742d 6973  runnable root-is
+00011d90: 6820 7461 736b 2c20 7769 7468 6f75 7420  h task, without 
+00011da0: 7175 6575 696e 672e 0a0a 2020 2020 2020  queuing...      
+00011db0: 2020 5468 6973 2061 7474 656d 7074 7320    This attempts 
+00011dc0: 746f 2073 6368 6564 756c 6520 7369 626c  to schedule sibl
+00011dd0: 696e 6720 7461 736b 7320 6f6e 2074 6865  ing tasks on the
+00011de0: 2073 616d 6520 776f 726b 6572 2c20 7265   same worker, re
+00011df0: 6475 6369 6e67 2066 7574 7572 6520 6461  ducing future da
+00011e00: 7461 0a20 2020 2020 2020 2074 7261 6e73  ta.        trans
+00011e10: 6665 722e 2049 7420 646f 6573 206e 6f74  fer. It does not
+00011e20: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
+00011e30: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
+00011e40: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
+00011e50: 6579 276c 6c20 656e 640a 2020 2020 2020  ey'll end.      
+00011e60: 2020 7570 206f 6e20 6576 6572 7920 776f    up on every wo
+00011e70: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
+00011e80: 2020 2020 2020 4974 2061 7373 756d 6573        It assumes
+00011e90: 2069 7427 7320 6265 696e 6720 6361 6c6c   it's being call
+00011ea0: 6564 206f 6e20 6120 6261 7463 6820 6f66  ed on a batch of
+00011eb0: 2074 6173 6b73 2069 6e20 7072 696f 7269   tasks in priori
+00011ec0: 7479 206f 7264 6572 2c20 616e 640a 2020  ty order, and.  
+00011ed0: 2020 2020 2020 6d61 696e 7461 696e 7320        maintains 
+00011ee0: 7374 6174 6520 696e 2060 5363 6865 6475  state in `Schedu
+00011ef0: 6c65 7253 7461 7465 2e6c 6173 745f 726f  lerState.last_ro
+00011f00: 6f74 5f77 6f72 6b65 7260 2061 6e64 0a20  ot_worker` and. 
+00011f10: 2020 2020 2020 2060 5363 6865 6475 6c65         `Schedule
+00011f20: 7253 7461 7465 2e6c 6173 745f 726f 6f74  rState.last_root
+00011f30: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+00011f40: 6674 6020 746f 2061 6368 6965 7665 2074  ft` to achieve t
+00011f50: 6869 732e 0a0a 2020 2020 2020 2020 5468  his...        Th
+00011f60: 6973 2077 696c 6c20 7365 6e64 2065 7665  is will send eve
+00011f70: 7279 2072 756e 6e61 626c 6520 7461 736b  ry runnable task
+00011f80: 2074 6f20 6120 776f 726b 6572 2c20 6f66   to a worker, of
+00011f90: 7465 6e20 6361 7573 696e 6720 726f 6f74  ten causing root
+00011fa0: 2074 6173 6b0a 2020 2020 2020 2020 6f76   task.        ov
+00011fb0: 6572 7072 6f64 7563 7469 6f6e 2e0a 0a20  erproduction... 
+00011fc0: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+00011fd0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+00011fe0: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
+00011ff0: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
+00012000: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
+00012010: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
+00012020: 6865 2074 6173 6b20 746f 2e20 4966 2074  he task to. If t
+00012030: 6865 7265 2061 7265 206e 6f20 776f 726b  here are no work
+00012040: 6572 7320 696e 2074 6865 2063 6c75 7374  ers in the clust
+00012050: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00012060: 7265 7475 726e 7320 4e6f 6e65 2c20 696e  returns None, in
+00012070: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+00012080: 7461 736b 2073 686f 756c 6420 6265 2074  task should be t
+00012090: 7261 6e73 6974 696f 6e65 6420 746f 0a20  ransitioned to. 
+000120a0: 2020 2020 2020 2020 2020 2060 606e 6f2d             ``no-
+000120b0: 776f 726b 6572 6060 2e0a 2020 2020 2020  worker``..      
+000120c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000120d0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+000120e0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+000120f0: 6520 726f 6f74 2d69 7368 2d6e 6573 7320  e root-ish-ness 
+00012100: 6e6f 7465 2062 656c 6f77 2069 6e20 6064  note below in `d
+00012110: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00012120: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
+00012130: 626c 6564 600a 2020 2020 2020 2020 2020  bled`.          
+00012140: 2020 6173 7365 7274 206d 6174 682e 6973    assert math.is
+00012150: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
+00012160: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
+00012170: 2020 2020 2070 6f6f 6c20 3d20 7365 6c66       pool = self
+00012180: 2e69 646c 652e 7661 6c75 6573 2829 2069  .idle.values() i
+00012190: 6620 7365 6c66 2e69 646c 6520 656c 7365  f self.idle else
+000121a0: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
+000121b0: 2020 2020 2020 6966 206e 6f74 2070 6f6f        if not poo
+000121c0: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
+000121d0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+000121e0: 2020 2020 7467 203d 2074 732e 6772 6f75      tg = ts.grou
+000121f0: 700a 2020 2020 2020 2020 6c77 7320 3d20  p.        lws = 
+00012200: 7467 2e6c 6173 745f 776f 726b 6572 0a20  tg.last_worker. 
+00012210: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00012220: 2020 2020 2020 2020 6c77 730a 2020 2020          lws.    
+00012230: 2020 2020 2020 2020 616e 6420 7467 2e6c          and tg.l
+00012240: 6173 745f 776f 726b 6572 5f74 6173 6b73  ast_worker_tasks
+00012250: 5f6c 6566 740a 2020 2020 2020 2020 2020  _left.          
+00012260: 2020 616e 6420 6c77 732e 7374 6174 7573    and lws.status
+00012270: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00012280: 6e67 0a20 2020 2020 2020 2020 2020 2061  ng.            a
+00012290: 6e64 2073 656c 662e 776f 726b 6572 732e  nd self.workers.
+000122a0: 6765 7428 6c77 732e 6164 6472 6573 7329  get(lws.address)
+000122b0: 2069 7320 6c77 730a 2020 2020 2020 2020   is lws.        
+000122c0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+000122d0: 7320 3d20 6c77 730a 2020 2020 2020 2020  s = lws.        
+000122e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000122f0: 2020 2320 4c61 7374 2d75 7365 6420 776f    # Last-used wo
+00012300: 726b 6572 2069 7320 6675 6c6c 2c20 756e  rker is full, un
+00012310: 6b6e 6f77 6e2c 2072 6574 6972 696e 672c  known, retiring,
+00012320: 206f 7220 7061 7573 6564 3b0a 2020 2020   or paused;.    
+00012330: 2020 2020 2020 2020 2320 7069 636b 2061          # pick a
+00012340: 206e 6577 2077 6f72 6b65 7220 666f 7220   new worker for 
+00012350: 7468 6520 6e65 7874 2066 6577 2074 6173  the next few tas
+00012360: 6b73 0a20 2020 2020 2020 2020 2020 2077  ks.            w
+00012370: 7320 3d20 6d69 6e28 706f 6f6c 2c20 6b65  s = min(pool, ke
+00012380: 793d 7061 7274 6961 6c28 7365 6c66 2e77  y=partial(self.w
+00012390: 6f72 6b65 725f 6f62 6a65 6374 6976 652c  orker_objective,
+000123a0: 2074 7329 290a 2020 2020 2020 2020 2020   ts)).          
+000123b0: 2020 7467 2e6c 6173 745f 776f 726b 6572    tg.last_worker
+000123c0: 5f74 6173 6b73 5f6c 6566 7420 3d20 6d61  _tasks_left = ma
+000123d0: 7468 2e66 6c6f 6f72 280a 2020 2020 2020  th.floor(.      
+000123e0: 2020 2020 2020 2020 2020 286c 656e 2874            (len(t
+000123f0: 6729 202f 2073 656c 662e 746f 7461 6c5f  g) / self.total_
+00012400: 6e74 6872 6561 6473 2920 2a20 7773 2e6e  nthreads) * ws.n
+00012410: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
+00012420: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00012430: 2052 6563 6f72 6420 606c 6173 745f 776f   Record `last_wo
+00012440: 726b 6572 602c 206f 7220 636c 6561 7220  rker`, or clear 
+00012450: 6974 206f 6e20 7468 6520 6669 6e61 6c20  it on the final 
+00012460: 7461 736b 0a20 2020 2020 2020 2074 672e  task.        tg.
+00012470: 6c61 7374 5f77 6f72 6b65 7220 3d20 280a  last_worker = (.
+00012480: 2020 2020 2020 2020 2020 2020 7773 2069              ws i
+00012490: 6620 7467 2e73 7461 7465 735b 2272 656c  f tg.states["rel
+000124a0: 6561 7365 6422 5d20 2b20 7467 2e73 7461  eased"] + tg.sta
+000124b0: 7465 735b 2277 6169 7469 6e67 225d 203e  tes["waiting"] >
+000124c0: 2031 2065 6c73 6520 4e6f 6e65 0a20 2020   1 else None.   
+000124d0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+000124e0: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
+000124f0: 736b 735f 6c65 6674 202d 3d20 310a 0a20  sks_left -= 1.. 
+00012500: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00012510: 616c 6964 6174 6520 616e 6420 7773 2069  alidate and ws i
+00012520: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00012530: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00012540: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+00012550: 7773 2e61 6464 7265 7373 2920 6973 2077  ws.address) is w
+00012560: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00012570: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
+00012580: 7275 6e6e 696e 672c 2028 7773 2c20 7365  running, (ws, se
+00012590: 6c66 2e72 756e 6e69 6e67 290a 0a20 2020  lf.running)..   
+000125a0: 2020 2020 2072 6574 7572 6e20 7773 0a0a       return ws..
+000125b0: 2020 2020 6465 6620 6465 6369 6465 5f77      def decide_w
+000125c0: 6f72 6b65 725f 726f 6f74 6973 685f 7175  orker_rootish_qu
+000125d0: 6575 696e 675f 656e 6162 6c65 6428 7365  euing_enabled(se
+000125e0: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
+000125f0: 7465 207c 204e 6f6e 653a 0a20 2020 2020  te | None:.     
+00012600: 2020 2022 2222 5069 636b 2061 2077 6f72     """Pick a wor
+00012610: 6b65 7220 666f 7220 6120 7275 6e6e 6162  ker for a runnab
+00012620: 6c65 2072 6f6f 742d 6973 6820 7461 736b  le root-ish task
+00012630: 2c20 6966 206e 6f74 2061 6c6c 2061 7265  , if not all are
+00012640: 2062 7573 792e 0a0a 2020 2020 2020 2020   busy...        
+00012650: 5069 636b 7320 7468 6520 6c65 6173 742d  Picks the least-
+00012660: 6275 7379 2077 6f72 6b65 7220 6f75 7420  busy worker out 
+00012670: 6f66 2074 6865 2060 6069 646c 6560 6020  of the ``idle`` 
+00012680: 776f 726b 6572 7320 2869 646c 6520 776f  workers (idle wo
+00012690: 726b 6572 7320 6861 7665 2066 6577 6572  rkers have fewer
+000126a0: 0a20 2020 2020 2020 2074 6173 6b73 2072  .        tasks r
+000126b0: 756e 6e69 6e67 2074 6861 6e20 7468 7265  unning than thre
+000126c0: 6164 732c 2061 7320 7365 7420 6279 2060  ads, as set by `
+000126d0: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
+000126e0: 6564 756c 6572 2e77 6f72 6b65 722d 7361  eduler.worker-sa
+000126f0: 7475 7261 7469 6f6e 6060 292e 0a20 2020  turation``)..   
+00012700: 2020 2020 2049 7420 646f 6573 206e 6f74       It does not
+00012710: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
+00012720: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
+00012730: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
+00012740: 6579 276c 6c20 656e 6420 7570 206f 6e20  ey'll end up on 
+00012750: 6576 6572 790a 2020 2020 2020 2020 776f  every.        wo
+00012760: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
+00012770: 2020 2020 2020 4966 2061 6c6c 2077 6f72        If all wor
+00012780: 6b65 7273 2061 7265 2066 756c 6c2c 2072  kers are full, r
+00012790: 6574 7572 6e73 204e 6f6e 652c 206d 6561  eturns None, mea
+000127a0: 6e69 6e67 2074 6865 2074 6173 6b20 7368  ning the task sh
+000127b0: 6f75 6c64 2074 7261 6e73 6974 696f 6e20  ould transition 
+000127c0: 746f 0a20 2020 2020 2020 2060 6071 7565  to.        ``que
+000127d0: 7565 6460 602e 2054 6865 2073 6368 6564  ued``. The sched
+000127e0: 756c 6572 2077 696c 6c20 7761 6974 2074  uler will wait t
+000127f0: 6f20 7365 6e64 2069 7420 746f 2061 2077  o send it to a w
+00012800: 6f72 6b65 7220 756e 7469 6c20 6120 7468  orker until a th
+00012810: 7265 6164 206f 7065 6e73 0a20 2020 2020  read opens.     
+00012820: 2020 2075 702e 2054 6869 7320 656e 7375     up. This ensu
+00012830: 7265 7320 7468 6174 2064 6f77 6e73 7472  res that downstr
+00012840: 6561 6d20 7461 736b 7320 616c 7761 7973  eam tasks always
+00012850: 2072 756e 2062 6566 6f72 6520 6e65 7720   run before new 
+00012860: 726f 6f74 2074 6173 6b73 2061 7265 0a20  root tasks are. 
+00012870: 2020 2020 2020 2073 7461 7274 6564 2e0a         started..
+00012880: 0a20 2020 2020 2020 2054 6869 7320 646f  .        This do
+00012890: 6573 206e 6f74 2074 7279 2074 6f20 7363  es not try to sc
+000128a0: 6865 6475 6c65 2073 6962 6c69 6e67 2074  hedule sibling t
+000128b0: 6173 6b73 206f 6e20 7468 6520 7361 6d65  asks on the same
+000128c0: 2077 6f72 6b65 723b 2069 6e20 6661 6374   worker; in fact
+000128d0: 2c20 6974 0a20 2020 2020 2020 2075 7375  , it.        usu
+000128e0: 616c 6c79 2064 6f65 7320 7468 6520 6f70  ally does the op
+000128f0: 706f 7369 7465 2e20 4576 656e 2074 686f  posite. Even tho
+00012900: 7567 6820 7468 6973 2069 6e63 7265 6173  ugh this increas
+00012910: 6573 2073 7562 7365 7175 656e 7420 6461  es subsequent da
+00012920: 7461 2074 7261 6e73 6665 722c 0a20 2020  ta transfer,.   
+00012930: 2020 2020 2069 7420 7479 7069 6361 6c6c       it typicall
+00012940: 7920 7265 6475 6365 7320 6f76 6572 616c  y reduces overal
+00012950: 6c20 6d65 6d6f 7279 2075 7365 2062 7920  l memory use by 
+00012960: 656c 696d 696e 6174 696e 6720 726f 6f74  eliminating root
+00012970: 2074 6173 6b20 6f76 6572 7072 6f64 7563   task overproduc
+00012980: 7469 6f6e 2e0a 0a20 2020 2020 2020 2052  tion...        R
+00012990: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+000129a0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
+000129b0: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
+000129c0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000129d0: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
+000129e0: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
+000129f0: 746f 2e20 4966 2074 6865 7265 2061 7265  to. If there are
+00012a00: 206e 6f20 6964 6c65 2077 6f72 6b65 7273   no idle workers
+00012a10: 2c20 7265 7475 726e 730a 2020 2020 2020  , returns.      
+00012a20: 2020 2020 2020 4e6f 6e65 2c20 696e 2077        None, in w
+00012a30: 6869 6368 2063 6173 6520 7468 6520 7461  hich case the ta
+00012a40: 736b 2073 686f 756c 6420 6265 2074 7261  sk should be tra
+00012a50: 6e73 6974 696f 6e65 6420 746f 2060 6071  nsitioned to ``q
+00012a60: 7565 7565 6460 602e 0a0a 2020 2020 2020  ueued``...      
+00012a70: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00012a80: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00012a90: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00012aa0: 2064 6f6e 2774 2060 6173 7365 7274 2073   don't `assert s
+00012ab0: 656c 662e 6973 5f72 6f6f 7469 7368 2874  elf.is_rootish(t
+00012ac0: 7329 6020 6865 7265 2c20 6265 6361 7573  s)` here, becaus
+00012ad0: 6520 7468 6174 2063 6865 636b 2069 730a  e that check is.
+00012ae0: 2020 2020 2020 2020 2020 2020 2320 6465              # de
+00012af0: 7065 6e64 656e 7420 6f6e 2063 6c75 7374  pendent on clust
+00012b00: 6572 2073 697a 652e 2049 7427 7320 706f  er size. It's po
+00012b10: 7373 6962 6c65 2061 2074 6173 6b20 6c6f  ssible a task lo
+00012b20: 6f6b 6564 2072 6f6f 742d 6973 6820 7768  oked root-ish wh
+00012b30: 656e 2069 740a 2020 2020 2020 2020 2020  en it.          
+00012b40: 2020 2320 7761 7320 7175 6575 6564 2c20    # was queued, 
+00012b50: 6275 7420 7468 6520 636c 7573 7465 7220  but the cluster 
+00012b60: 6861 7320 7369 6e63 6520 7363 616c 6564  has since scaled
+00012b70: 2075 7020 616e 6420 6974 206e 6f20 6c6f   up and it no lo
+00012b80: 6e67 6572 2064 6f65 7320 7768 656e 0a20  nger does when. 
+00012b90: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
+00012ba0: 696e 6720 6f75 7420 6f66 2074 6865 2071  ing out of the q
+00012bb0: 7565 7565 2e20 4966 2060 6973 5f72 6f6f  ueue. If `is_roo
+00012bc0: 7469 7368 6020 6368 616e 6765 7320 746f  tish` changes to
+00012bd0: 2061 2073 7461 7469 6320 6465 6669 6e69   a static defini
+00012be0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00012bf0: 2020 2320 7468 656e 2061 6464 2074 6861    # then add tha
+00012c00: 7420 6173 7365 7274 696f 6e20 6865 7265  t assertion here
+00012c10: 2028 616e 6420 6163 7475 616c 6c79 2070   (and actually p
+00012c20: 6173 7320 696e 2074 6865 2074 6173 6b29  ass in the task)
+00012c30: 2e0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00012c40: 7365 7274 206e 6f74 206d 6174 682e 6973  sert not math.is
+00012c50: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
+00012c60: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
+00012c70: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00012c80: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+00012c90: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00012ca0: 416c 6c20 776f 726b 6572 7320 6275 7379  All workers busy
+00012cb0: 3f20 5461 736b 2067 6574 732f 7374 6179  ? Task gets/stay
+00012cc0: 7320 7175 6575 6564 2e0a 2020 2020 2020  s queued..      
+00012cd0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00012ce0: 650a 0a20 2020 2020 2020 2023 204a 7573  e..        # Jus
+00012cf0: 7420 7069 636b 2074 6865 206c 6561 7374  t pick the least
+00012d00: 2062 7573 7920 776f 726b 6572 2e0a 2020   busy worker..  
+00012d10: 2020 2020 2020 2320 4e4f 5445 3a20 7468        # NOTE: th
+00012d20: 6973 2077 696c 6c20 6c65 6164 2074 6f20  is will lead to 
+00012d30: 776f 7273 742d 6361 7365 2073 6368 6564  worst-case sched
+00012d40: 756c 696e 6720 7769 7468 2072 6567 6172  uling with regar
+00012d50: 6473 2074 6f20 636f 2d61 7373 6967 6e6d  ds to co-assignm
+00012d60: 656e 742e 0a20 2020 2020 2020 2077 7320  ent..        ws 
+00012d70: 3d20 6d69 6e28 0a20 2020 2020 2020 2020  = min(.         
+00012d80: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+00012d90: 6b5f 636f 756e 742c 0a20 2020 2020 2020  k_count,.       
+00012da0: 2020 2020 206b 6579 3d6c 616d 6264 6120       key=lambda 
+00012db0: 7773 3a20 6c65 6e28 7773 2e70 726f 6365  ws: len(ws.proce
+00012dc0: 7373 696e 6729 202f 2077 732e 6e74 6872  ssing) / ws.nthr
+00012dd0: 6561 6473 2c0a 2020 2020 2020 2020 290a  eads,.        ).
+00012de0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00012df0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00012e00: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00012e10: 205f 776f 726b 6572 5f66 756c 6c28 7773   _worker_full(ws
+00012e20: 2c20 7365 6c66 2e57 4f52 4b45 525f 5341  , self.WORKER_SA
+00012e30: 5455 5241 5449 4f4e 292c 2028 0a20 2020  TURATION), (.   
+00012e40: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
+00012e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012e60: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
+00012e70: 696c 6162 6c65 2877 732c 2073 656c 662e  ilable(ws, self.
+00012e80: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00012e90: 4e29 2c0a 2020 2020 2020 2020 2020 2020  N),.            
+00012ea0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00012eb0: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
+00012ec0: 7275 6e6e 696e 672c 2028 7773 2c20 7365  running, (ws, se
+00012ed0: 6c66 2e72 756e 6e69 6e67 290a 0a20 2020  lf.running)..   
+00012ee0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00012ef0: 6964 6174 6520 616e 6420 7773 2069 7320  idate and ws is 
+00012f00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00012f10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00012f20: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
+00012f30: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
+00012f40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00012f50: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
+00012f60: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
+00012f70: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
+00012f80: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
+00012f90: 2020 6465 6620 6465 6369 6465 5f77 6f72    def decide_wor
+00012fa0: 6b65 725f 6e6f 6e5f 726f 6f74 6973 6828  ker_non_rootish(
+00012fb0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00012fc0: 6174 6529 202d 3e20 576f 726b 6572 5374  ate) -> WorkerSt
+00012fd0: 6174 6520 7c20 4e6f 6e65 3a0a 2020 2020  ate | None:.    
+00012fe0: 2020 2020 2222 2250 6963 6b20 6120 776f      """Pick a wo
+00012ff0: 726b 6572 2066 6f72 2061 2072 756e 6e61  rker for a runna
+00013000: 626c 6520 6e6f 6e2d 726f 6f74 2074 6173  ble non-root tas
+00013010: 6b2c 2063 6f6e 7369 6465 7269 6e67 2064  k, considering d
+00013020: 6570 656e 6465 6e63 6965 7320 616e 640a  ependencies and.
+00013030: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
+00013040: 696f 6e73 2e0a 0a20 2020 2020 2020 204f  ions...        O
+00013050: 7574 206f 6620 656c 6967 6962 6c65 2077  ut of eligible w
+00013060: 6f72 6b65 7273 2068 6f6c 6469 6e67 2064  orkers holding d
+00013070: 6570 656e 6465 6e63 6965 7320 6f66 2060  ependencies of `
+00013080: 6074 7360 602c 2073 656c 6563 7473 2074  `ts``, selects t
+00013090: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
+000130a0: 2020 7768 6572 652c 2063 6f6e 7369 6465    where, conside
+000130b0: 7269 6e67 2077 6f72 6b65 7220 6261 636b  ring worker back
+000130c0: 6c6f 6e67 2061 6e64 2064 6174 612d 7472  long and data-tr
+000130d0: 616e 7366 6572 2063 6f73 7473 2c20 7468  ansfer costs, th
+000130e0: 6520 7461 736b 2069 730a 2020 2020 2020  e task is.      
+000130f0: 2020 6573 7469 6d61 7465 6420 746f 2073    estimated to s
+00013100: 7461 7274 2072 756e 6e69 6e67 2074 6865  tart running the
+00013110: 2073 6f6f 6e65 7374 2e0a 0a20 2020 2020   soonest...     
+00013120: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00013130: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00013140: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
+00013150: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
+00013160: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
+00013170: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
+00013180: 6173 6b20 746f 2e20 4966 206e 6f20 776f  ask to. If no wo
+00013190: 726b 6572 7320 7361 7469 7366 7920 7468  rkers satisfy th
+000131a0: 6520 7265 7374 7269 6374 696f 6e73 206f  e restrictions o
+000131b0: 660a 2020 2020 2020 2020 2020 2020 6060  f.            ``
+000131c0: 7473 6060 206f 7220 7468 6572 6520 6172  ts`` or there ar
+000131d0: 6520 6e6f 2072 756e 6e69 6e67 2077 6f72  e no running wor
+000131e0: 6b65 7273 2c20 7265 7475 726e 7320 4e6f  kers, returns No
+000131f0: 6e65 2c20 696e 2077 6869 6368 2063 6173  ne, in which cas
+00013200: 6520 7468 6520 7461 736b 0a20 2020 2020  e the task.     
+00013210: 2020 2020 2020 2073 686f 756c 6420 6265         should be
+00013220: 2074 7261 6e73 6974 696f 6e65 6420 746f   transitioned to
+00013230: 2060 606e 6f2d 776f 726b 6572 6060 2e0a   ``no-worker``..
+00013240: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013250: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00013260: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00013270: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00013280: 0a0a 2020 2020 2020 2020 7661 6c69 645f  ..        valid_
+00013290: 776f 726b 6572 7320 3d20 7365 6c66 2e76  workers = self.v
+000132a0: 616c 6964 5f77 6f72 6b65 7273 2874 7329  alid_workers(ts)
+000132b0: 0a20 2020 2020 2020 2069 6620 7661 6c69  .        if vali
+000132c0: 645f 776f 726b 6572 7320 6973 204e 6f6e  d_workers is Non
+000132d0: 6520 616e 6420 6c65 6e28 7365 6c66 2e72  e and len(self.r
+000132e0: 756e 6e69 6e67 2920 3c20 6c65 6e28 7365  unning) < len(se
+000132f0: 6c66 2e77 6f72 6b65 7273 293a 0a20 2020  lf.workers):.   
+00013300: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00013310: 7365 6c66 2e72 756e 6e69 6e67 3a0a 2020  self.running:.  
+00013320: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00013330: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+00013340: 2020 2020 2020 2023 2049 6620 7468 6572         # If ther
+00013350: 6520 7765 7265 206e 6f20 7265 7374 7269  e were no restri
+00013360: 6374 696f 6e73 2c20 6076 616c 6964 5f77  ctions, `valid_w
+00013370: 6f72 6b65 7273 2829 6020 6469 646e 2774  orkers()` didn't
+00013380: 2073 7562 7365 7420 6279 0a20 2020 2020   subset by.     
+00013390: 2020 2020 2020 2023 2060 7275 6e6e 696e         # `runnin
+000133a0: 6760 2e0a 2020 2020 2020 2020 2020 2020  g`..            
+000133b0: 7661 6c69 645f 776f 726b 6572 7320 3d20  valid_workers = 
+000133c0: 7365 6c66 2e72 756e 6e69 6e67 0a0a 2020  self.running..  
+000133d0: 2020 2020 2020 6966 2074 732e 6465 7065        if ts.depe
+000133e0: 6e64 656e 6369 6573 206f 7220 7661 6c69  ndencies or vali
+000133f0: 645f 776f 726b 6572 7320 6973 206e 6f74  d_workers is not
+00013400: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00013410: 2020 2077 7320 3d20 6465 6369 6465 5f77     ws = decide_w
+00013420: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
+00013430: 2020 2020 2020 2074 732c 0a20 2020 2020         ts,.     
+00013440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00013450: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
+00013460: 2020 2020 2020 2020 2076 616c 6964 5f77           valid_w
+00013470: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+00013480: 2020 2020 2020 2020 7061 7274 6961 6c28          partial(
+00013490: 7365 6c66 2e77 6f72 6b65 725f 6f62 6a65  self.worker_obje
+000134a0: 6374 6976 652c 2074 7329 2c0a 2020 2020  ctive, ts),.    
+000134b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000134c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000134d0: 2020 2020 2320 544f 444f 2069 6620 6069      # TODO if `i
+000134e0: 735f 726f 6f74 6973 6860 2077 6f75 6c64  s_rootish` would
+000134f0: 2061 6c77 6179 7320 7265 7475 726e 2054   always return T
+00013500: 7275 6520 666f 7220 7461 736b 7320 7769  rue for tasks wi
+00013510: 7468 6f75 740a 2020 2020 2020 2020 2020  thout.          
+00013520: 2020 2320 6465 7065 6e64 656e 6369 6573    # dependencies
+00013530: 2c20 7765 2063 6f75 6c64 2072 656d 6f76  , we could remov
+00013540: 6520 616c 6c20 7468 6973 206c 6f67 6963  e all this logic
+00013550: 2e20 5468 6520 726f 6f74 6973 6820 6173  . The rootish as
+00013560: 7369 676e 6d65 6e74 206c 6f67 6963 0a20  signment logic. 
+00013570: 2020 2020 2020 2020 2020 2023 2077 6f75             # wou
+00013580: 6c64 2062 6568 6176 6520 6d6f 7265 206f  ld behave more o
+00013590: 7220 6c65 7373 2074 6865 2073 616d 6520  r less the same 
+000135a0: 6173 2074 6869 732c 206d 6179 6265 2077  as this, maybe w
+000135b0: 6974 686f 7574 2067 7561 7261 6e74 6565  ithout guarantee
+000135c0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+000135d0: 726f 756e 642d 726f 6269 6e20 7468 6f75  round-robin thou
+000135e0: 6768 3f20 5468 6973 2070 6174 6820 6973  gh? This path is
+000135f0: 206f 6e6c 7920 7265 6163 6861 626c 6520   only reachable 
+00013600: 7768 656e 2060 7473 6020 646f 6573 6e27  when `ts` doesn'
+00013610: 7420 6861 7665 0a20 2020 2020 2020 2020  t have.         
+00013620: 2020 2023 2064 6570 656e 6465 6e63 6965     # dependencie
+00013630: 732c 2062 7574 2069 7473 2067 726f 7570  s, but its group
+00013640: 2069 7320 616c 736f 2073 6d61 6c6c 6572   is also smaller
+00013650: 2074 6861 6e20 7468 6520 636c 7573 7465   than the cluste
+00013660: 722e 0a0a 2020 2020 2020 2020 2020 2020  r...            
+00013670: 2320 4661 7374 7061 7468 2077 6865 6e20  # Fastpath when 
+00013680: 7468 6572 6520 6172 6520 6e6f 2072 656c  there are no rel
+00013690: 6174 6564 2074 6173 6b73 206f 7220 7265  ated tasks or re
+000136a0: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
+000136b0: 2020 2020 2020 2077 6f72 6b65 725f 706f         worker_po
+000136c0: 6f6c 203d 2073 656c 662e 6964 6c65 206f  ol = self.idle o
+000136d0: 7220 7365 6c66 2e77 6f72 6b65 7273 0a20  r self.workers. 
+000136e0: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
+000136f0: 4d45 2069 646c 6520 616e 6420 776f 726b  ME idle and work
+00013700: 6572 7320 6172 6520 536f 7274 6564 4469  ers are SortedDi
+00013710: 6374 2773 2064 6563 6c61 7265 6420 6173  ct's declared as
+00013720: 2064 6963 7473 0a20 2020 2020 2020 2020   dicts.         
+00013730: 2020 2023 2020 2020 2020 2062 6563 6175     #       becau
+00013740: 7365 2073 6f72 7465 6463 6f6e 7461 696e  se sortedcontain
+00013750: 6572 7320 6973 206e 6f74 2061 6e6e 6f74  ers is not annot
+00013760: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
+00013770: 2077 705f 7661 6c73 203d 2063 6173 7428   wp_vals = cast(
+00013780: 2253 6571 7565 6e63 655b 576f 726b 6572  "Sequence[Worker
+00013790: 5374 6174 655d 222c 2077 6f72 6b65 725f  State]", worker_
+000137a0: 706f 6f6c 2e76 616c 7565 7328 2929 0a20  pool.values()). 
+000137b0: 2020 2020 2020 2020 2020 206e 5f77 6f72             n_wor
+000137c0: 6b65 7273 203d 206c 656e 2877 705f 7661  kers = len(wp_va
+000137d0: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
+000137e0: 6966 206e 5f77 6f72 6b65 7273 203c 2032  if n_workers < 2
+000137f0: 303a 2020 2320 736d 6172 7420 6275 7420  0:  # smart but 
+00013800: 6c69 6e65 6172 2069 6e20 736d 616c 6c20  linear in small 
+00013810: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
+00013820: 2020 2020 2077 7320 3d20 6d69 6e28 7770       ws = min(wp
+00013830: 5f76 616c 732c 206b 6579 3d6f 7065 7261  _vals, key=opera
+00013840: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
+00013850: 6f63 6375 7061 6e63 7922 2929 0a20 2020  occupancy")).   
+00013860: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00013870: 6572 7420 7773 0a20 2020 2020 2020 2020  ert ws.         
+00013880: 2020 2020 2020 2069 6620 7773 2e6f 6363         if ws.occ
+00013890: 7570 616e 6379 203d 3d20 303a 0a20 2020  upancy == 0:.   
+000138a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138b0: 2023 2073 7065 6369 616c 2063 6173 6520   # special case 
+000138c0: 746f 2075 7365 2072 6f75 6e64 2d72 6f62  to use round-rob
+000138d0: 696e 3b20 6c69 6e65 6172 2073 6561 7263  in; linear searc
+000138e0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+000138f0: 2020 2020 2020 2320 666f 7220 6e65 7874        # for next
+00013900: 2077 6f72 6b65 7220 7769 7468 207a 6572   worker with zer
+00013910: 6f20 6f63 6375 7061 6e63 7920 286f 7220  o occupancy (or 
+00013920: 6a75 7374 0a20 2020 2020 2020 2020 2020  just.           
+00013930: 2020 2020 2020 2020 2023 206c 616e 6420           # land 
+00013940: 6261 636b 2077 6865 7265 2077 6520 7374  back where we st
+00013950: 6172 7465 6429 2e0a 2020 2020 2020 2020  arted)..        
+00013960: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00013970: 7420 3d20 7365 6c66 2e6e 5f74 6173 6b73  t = self.n_tasks
+00013980: 2025 206e 5f77 6f72 6b65 7273 0a20 2020   % n_workers.   
+00013990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139a0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+000139b0: 6e5f 776f 726b 6572 7329 3a0a 2020 2020  n_workers):.    
+000139c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139d0: 2020 2020 7770 5f69 203d 2077 705f 7661      wp_i = wp_va
+000139e0: 6c73 5b28 6920 2b20 7374 6172 7429 2025  ls[(i + start) %
+000139f0: 206e 5f77 6f72 6b65 7273 5d0a 2020 2020   n_workers].    
+00013a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a10: 2020 2020 6966 2077 705f 692e 6f63 6375      if wp_i.occu
+00013a20: 7061 6e63 7920 3d3d 2030 3a0a 2020 2020  pancy == 0:.    
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a40: 2020 2020 2020 2020 7773 203d 2077 705f          ws = wp_
+00013a50: 690a 2020 2020 2020 2020 2020 2020 2020  i.              
+00013a60: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00013a70: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
+00013a80: 656c 7365 3a20 2023 2064 756d 6220 6275  else:  # dumb bu
+00013a90: 7420 6661 7374 2069 6e20 6c61 7267 6520  t fast in large 
+00013aa0: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
+00013ab0: 2020 2020 2077 7320 3d20 7770 5f76 616c       ws = wp_val
+00013ac0: 735b 7365 6c66 2e6e 5f74 6173 6b73 2025  s[self.n_tasks %
+00013ad0: 206e 5f77 6f72 6b65 7273 5d0a 0a20 2020   n_workers]..   
+00013ae0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00013af0: 6964 6174 6520 616e 6420 7773 2069 7320  idate and ws is 
+00013b00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00013b10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00013b20: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
+00013b30: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
+00013b40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00013b50: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
+00013b60: 6e6e 696e 672c 2028 7773 2c20 7365 6c66  nning, (ws, self
+00013b70: 2e72 756e 6e69 6e67 290a 0a20 2020 2020  .running)..     
+00013b80: 2020 2072 6574 7572 6e20 7773 0a0a 2020     return ws..  
+00013b90: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00013ba0: 5f77 6169 7469 6e67 5f70 726f 6365 7373  _waiting_process
+00013bb0: 696e 6728 7365 6c66 2c20 6b65 793a 2073  ing(self, key: s
+00013bc0: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
+00013bd0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00013be0: 733a 0a20 2020 2020 2020 2022 2222 506f  s:.        """Po
+00013bf0: 7373 6962 6c79 2073 6368 6564 756c 6520  ssibly schedule 
+00013c00: 6120 7265 6164 7920 7461 736b 2e20 5468  a ready task. Th
+00013c10: 6973 2069 7320 7468 6520 7072 696d 6172  is is the primar
+00013c20: 7920 6469 7370 6174 6368 2066 6f72 2072  y dispatch for r
+00013c30: 6561 6479 2074 6173 6b73 2e0a 0a20 2020  eady tasks...   
+00013c40: 2020 2020 2049 6620 7468 6572 6527 7320       If there's 
+00013c50: 6e6f 2061 7070 726f 7072 6961 7465 2077  no appropriate w
+00013c60: 6f72 6b65 7220 666f 7220 7468 6520 7461  orker for the ta
+00013c70: 736b 2028 6275 7420 7468 6520 7461 736b  sk (but the task
+00013c80: 2069 7320 6f74 6865 7277 6973 650a 2020   is otherwise.  
+00013c90: 2020 2020 2020 7275 6e6e 6162 6c65 292c        runnable),
+00013ca0: 2069 7420 7769 6c6c 2062 6520 7265 636f   it will be reco
+00013cb0: 6d6d 656e 6465 6420 746f 2060 606e 6f2d  mmended to ``no-
+00013cc0: 776f 726b 6572 6060 206f 7220 6060 7175  worker`` or ``qu
+00013cd0: 6575 6564 6060 2e0a 2020 2020 2020 2020  eued``..        
+00013ce0: 2222 220a 2020 2020 2020 2020 7473 203d  """.        ts =
+00013cf0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00013d00: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00013d10: 662e 6973 5f72 6f6f 7469 7368 2874 7329  f.is_rootish(ts)
+00013d20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00013d30: 4e4f 5445 3a20 6861 7669 6e67 2074 776f  NOTE: having two
+00013d40: 2072 6f6f 742d 6973 6820 6d65 7468 6f64   root-ish method
+00013d50: 7320 6973 2074 656d 706f 7261 7279 2e20  s is temporary. 
+00013d60: 5768 656e 2074 6865 2066 6561 7475 7265  When the feature
+00013d70: 2066 6c61 6720 6973 0a20 2020 2020 2020   flag is.       
+00013d80: 2020 2020 2023 2072 656d 6f76 6564 2c20       # removed, 
+00013d90: 7468 6572 6520 7368 6f75 6c64 206f 6e6c  there should onl
+00013da0: 7920 6265 206f 6e65 2c20 7768 6963 6820  y be one, which 
+00013db0: 636f 6d62 696e 6573 2063 6f2d 6173 7369  combines co-assi
+00013dc0: 676e 6d65 6e74 2061 6e64 0a20 2020 2020  gnment and.     
+00013dd0: 2020 2020 2020 2023 2071 7565 7569 6e67         # queuing
+00013de0: 2e20 4576 656e 7475 616c 6c79 2c20 7370  . Eventually, sp
+00013df0: 6563 6961 6c2d 6361 7369 6e67 2072 6f6f  ecial-casing roo
+00013e00: 7420 7461 736b 7320 6d69 6768 7420 6265  t tasks might be
+00013e10: 2072 656d 6f76 6564 2065 6e74 6972 656c   removed entirel
+00013e20: 792c 0a20 2020 2020 2020 2020 2020 2023  y,.            #
+00013e30: 2077 6974 6820 6265 7474 6572 2068 6575   with better heu
+00013e40: 7269 7374 6963 732e 0a20 2020 2020 2020  ristics..       
+00013e50: 2020 2020 2069 6620 6d61 7468 2e69 7369       if math.isi
+00013e60: 6e66 2873 656c 662e 574f 524b 4552 5f53  nf(self.WORKER_S
+00013e70: 4154 5552 4154 494f 4e29 3a0a 2020 2020  ATURATION):.    
+00013e80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00013e90: 6f74 2028 7773 203a 3d20 7365 6c66 2e64  ot (ws := self.d
+00013ea0: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00013eb0: 7469 7368 5f71 7565 7569 6e67 5f64 6973  tish_queuing_dis
+00013ec0: 6162 6c65 6428 7473 2929 3a0a 2020 2020  abled(ts)):.    
+00013ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ee0: 7265 7475 726e 207b 7473 2e6b 6579 3a20  return {ts.key: 
+00013ef0: 226e 6f2d 776f 726b 6572 227d 2c20 7b7d  "no-worker"}, {}
+00013f00: 2c20 7b7d 0a20 2020 2020 2020 2020 2020  , {}.           
+00013f10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013f20: 2020 2020 2020 2069 6620 6e6f 7420 2877         if not (w
+00013f30: 7320 3a3d 2073 656c 662e 6465 6369 6465  s := self.decide
+00013f40: 5f77 6f72 6b65 725f 726f 6f74 6973 685f  _worker_rootish_
+00013f50: 7175 6575 696e 675f 656e 6162 6c65 6428  queuing_enabled(
+00013f60: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00013f70: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00013f80: 7473 2e6b 6579 3a20 2271 7565 7565 6422  ts.key: "queued"
+00013f90: 7d2c 207b 7d2c 207b 7d0a 2020 2020 2020  }, {}, {}.      
+00013fa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013fb0: 2020 2020 6966 206e 6f74 2028 7773 203a      if not (ws :
+00013fc0: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
+00013fd0: 726b 6572 5f6e 6f6e 5f72 6f6f 7469 7368  rker_non_rootish
+00013fe0: 2874 7329 293a 0a20 2020 2020 2020 2020  (ts)):.         
+00013ff0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
+00014000: 732e 6b65 793a 2022 6e6f 2d77 6f72 6b65  s.key: "no-worke
+00014010: 7222 7d2c 207b 7d2c 207b 7d0a 0a20 2020  r"}, {}, {}..   
+00014020: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00014030: 203d 2073 656c 662e 5f61 6464 5f74 6f5f   = self._add_to_
+00014040: 7072 6f63 6573 7369 6e67 2874 732c 2077  processing(ts, w
+00014050: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00014060: 6e20 7b7d 2c20 7b7d 2c20 776f 726b 6572  n {}, {}, worker
+00014070: 5f6d 7367 730a 0a20 2020 2064 6566 2074  _msgs..    def t
+00014080: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
+00014090: 675f 6d65 6d6f 7279 280a 2020 2020 2020  g_memory(.      
+000140a0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000140b0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
+000140c0: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
+000140d0: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
+000140e0: 2020 2020 2020 206e 6279 7465 733a 2069         nbytes: i
+000140f0: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+00014100: 2c0a 2020 2020 2020 2020 7479 7065 3a20  ,.        type: 
+00014110: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
+00014120: 6f6e 652c 0a20 2020 2020 2020 2074 7970  one,.        typ
+00014130: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
+00014140: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00014150: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
+00014160: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+00014170: 2041 6e79 2c0a 2020 2020 2920 2d3e 2052   Any,.    ) -> R
+00014180: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+00014190: 2022 2222 5468 6973 2074 7261 6e73 6974   """This transit
+000141a0: 696f 6e20 6578 636c 7573 6976 656c 7920  ion exclusively 
+000141b0: 6861 7070 656e 7320 696e 2061 2072 6163  happens in a rac
+000141c0: 6520 636f 6e64 6974 696f 6e20 7768 6572  e condition wher
+000141d0: 6520 7468 6520 7363 6865 6475 6c65 720a  e the scheduler.
+000141e0: 2020 2020 2020 2020 6265 6c69 6576 6573          believes
+000141f0: 2074 6861 7420 7468 6520 6f6e 6c79 2063   that the only c
+00014200: 6f70 7920 6f66 2061 2064 6570 656e 6465  opy of a depende
+00014210: 6e63 7920 7461 736b 2068 6173 206a 7573  ncy task has jus
+00014220: 7420 6265 656e 206c 6f73 742c 2073 6f20  t been lost, so 
+00014230: 6974 0a20 2020 2020 2020 2074 7261 6e73  it.        trans
+00014240: 6974 696f 6e73 2061 6c6c 2064 6570 656e  itions all depen
+00014250: 6465 6e74 7320 6261 636b 2074 6f20 7761  dents back to wa
+00014260: 6974 696e 672c 2062 7574 2061 6374 7561  iting, but actua
+00014270: 6c6c 7920 6120 7265 706c 6963 6120 6861  lly a replica ha
+00014280: 7320 616c 7265 6164 790a 2020 2020 2020  s already.      
+00014290: 2020 6265 656e 2061 6371 7569 7265 6420    been acquired 
+000142a0: 6279 2061 2077 6f72 6b65 7220 636f 6d70  by a worker comp
+000142b0: 7574 696e 6720 7468 6520 6465 7065 6e64  uting the depend
+000142c0: 656e 6379 202d 2074 6865 2073 6368 6564  ency - the sched
+000142d0: 756c 6572 206a 7573 7420 646f 6573 6e27  uler just doesn'
+000142e0: 740a 2020 2020 2020 2020 6b6e 6f77 2079  t.        know y
+000142f0: 6574 202d 2061 6e64 2074 6865 2065 7865  et - and the exe
+00014300: 6375 7469 6f6e 2066 696e 6973 6865 7320  cution finishes 
+00014310: 6265 666f 7265 2074 6865 2063 616e 6365  before the cance
+00014320: 6c6c 6174 696f 6e20 6d65 7373 6167 6520  llation message 
+00014330: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
+00014340: 2073 6368 6564 756c 6572 2068 6173 2061   scheduler has a
+00014350: 2063 6861 6e63 6520 746f 2072 6561 6368   chance to reach
+00014360: 2074 6865 2077 6f72 6b65 722e 2053 686f   the worker. Sho
+00014370: 7274 6c79 2c20 7468 6520 6361 6e63 656c  rtly, the cancel
+00014380: 6c61 7469 6f6e 2072 6571 7565 7374 0a20  lation request. 
+00014390: 2020 2020 2020 2077 696c 6c20 7265 6163         will reac
+000143a0: 6820 7468 6520 776f 726b 6572 2c20 7468  h the worker, th
+000143b0: 7573 2064 656c 6574 696e 6720 7468 6520  us deleting the 
+000143c0: 6461 7461 2066 726f 6d20 6d65 6d6f 7279  data from memory
+000143d0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000143e0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+000143f0: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00014400: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00014410: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00014420: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00014430: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00014440: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00014450: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+00014460: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014470: 7420 7473 2e73 7461 7465 203d 3d20 2277  t ts.state == "w
+00014480: 6169 7469 6e67 220a 0a20 2020 2020 2020  aiting"..       
+00014490: 2072 6574 7572 6e20 7b7d 2c20 7b7d 2c20   return {}, {}, 
+000144a0: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
+000144b0: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
+000144c0: 675f 6d65 6d6f 7279 280a 2020 2020 2020  g_memory(.      
+000144d0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000144e0: 6b65 793a 2073 7472 2c0a 2020 2020 2020  key: str,.      
+000144f0: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
+00014500: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
+00014510: 2020 2020 2020 206e 6279 7465 733a 2069         nbytes: i
+00014520: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+00014530: 2c0a 2020 2020 2020 2020 7479 7065 3a20  ,.        type: 
+00014540: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
+00014550: 6f6e 652c 0a20 2020 2020 2020 2074 7970  one,.        typ
+00014560: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
+00014570: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00014580: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
+00014590: 2020 2020 2020 2073 7461 7274 7374 6f70         startstop
+000145a0: 733a 206c 6973 745b 6469 6374 5d20 7c20  s: list[dict] | 
+000145b0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+000145c0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+000145d0: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
+000145e0: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+000145f0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00014600: 6579 5d0a 0a20 2020 2020 2020 2061 7373  ey]..        ass
+00014610: 6572 7420 776f 726b 6572 0a20 2020 2020  ert worker.     
+00014620: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00014630: 616e 6365 2877 6f72 6b65 722c 2073 7472  ance(worker, str
+00014640: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00014650: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00014660: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00014670: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00014680: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
+00014690: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
+000146a0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+000146b0: 6173 7365 7274 2077 7373 0a20 2020 2020  assert wss.     
+000146c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000146d0: 2069 6e20 7773 732e 7072 6f63 6573 7369   in wss.processi
+000146e0: 6e67 0a20 2020 2020 2020 2020 2020 2064  ng.            d
+000146f0: 656c 2077 7373 0a20 2020 2020 2020 2020  el wss.         
+00014700: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00014710: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+00014720: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00014730: 6f74 2074 732e 7768 6f5f 6861 732c 2028  ot ts.who_has, (
+00014740: 7473 2c20 7473 2e77 686f 5f68 6173 290a  ts, ts.who_has).
+00014750: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00014760: 7274 206e 6f74 2074 732e 6578 6365 7074  rt not ts.except
+00014770: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
+00014780: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00014790: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
+000147a0: 7369 6e67 220a 0a20 2020 2020 2020 2077  sing"..        w
+000147b0: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+000147c0: 2e67 6574 2877 6f72 6b65 7229 0a20 2020  .get(worker).   
+000147d0: 2020 2020 2069 6620 7773 2069 7320 4e6f       if ws is No
+000147e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000147f0: 7265 7475 726e 207b 6b65 793a 2022 7265  return {key: "re
+00014800: 6c65 6173 6564 227d 2c20 7b7d 2c20 7b7d  leased"}, {}, {}
+00014810: 0a0a 2020 2020 2020 2020 6966 2077 7320  ..        if ws 
+00014820: 213d 2074 732e 7072 6f63 6573 7369 6e67  != ts.processing
+00014830: 5f6f 6e3a 2020 2320 7072 6167 6d61 3a20  _on:  # pragma: 
+00014840: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
+00014850: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+00014860: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00014870: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00014880: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
+00014890: 2020 2020 2020 2020 2020 2020 6622 5461              f"Ta
+000148a0: 736b 207b 7473 2e6b 6579 2172 7d20 7472  sk {ts.key!r} tr
+000148b0: 616e 7369 7469 6f6e 6564 2066 726f 6d20  ansitioned from 
+000148c0: 7072 6f63 6573 7369 6e67 2074 6f20 6d65  processing to me
+000148d0: 6d6f 7279 206f 6e20 776f 726b 6572 2022  mory on worker "
+000148e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000148f0: 2066 227b 7773 7d2c 2077 6869 6c65 2069   f"{ws}, while i
+00014900: 7420 7761 7320 6578 7065 6374 6564 2066  t was expected f
+00014910: 726f 6d20 7b74 732e 7072 6f63 6573 7369  rom {ts.processi
+00014920: 6e67 5f6f 6e7d 2e20 5468 6973 2073 686f  ng_on}. This sho
+00014930: 756c 6420 220a 2020 2020 2020 2020 2020  uld ".          
+00014940: 2020 2020 2020 6622 6265 2069 6d70 6f73        f"be impos
+00014950: 7369 626c 652e 207b 7374 696d 756c 7573  sible. {stimulus
+00014960: 5f69 643d 7d2c 2073 746f 7279 3d7b 7365  _id=}, story={se
+00014970: 6c66 2e73 746f 7279 2874 7329 7d22 0a20  lf.story(ts)}". 
+00014980: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00014990: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+000149a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000149b0: 2323 230a 2020 2020 2020 2020 2320 5570  ###.        # Up
+000149c0: 6461 7465 2054 696d 696e 6720 496e 666f  date Timing Info
+000149d0: 726d 6174 696f 6e20 230a 2020 2020 2020  rmation #.      
+000149e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+000149f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00014a00: 2020 2020 2020 2020 6966 2073 7461 7274          if start
+00014a10: 7374 6f70 733a 0a20 2020 2020 2020 2020  stops:.         
+00014a20: 2020 2066 6f72 2073 7461 7274 7374 6f70     for startstop
+00014a30: 2069 6e20 7374 6172 7473 746f 7073 3a0a   in startstops:.
+00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a50: 7473 2e67 726f 7570 2e61 6464 5f64 7572  ts.group.add_dur
+00014a60: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
+00014a70: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
+00014a80: 7374 6172 7473 746f 705b 2273 746f 7022  startstop["stop"
+00014a90: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00014aa0: 2020 2020 2020 2073 7461 7274 3d73 7461         start=sta
+00014ab0: 7274 7374 6f70 5b22 7374 6172 7422 5d2c  rtstop["start"],
+00014ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ad0: 2020 2020 2061 6374 696f 6e3d 7374 6172       action=star
+00014ae0: 7473 746f 705b 2261 6374 696f 6e22 5d2c  tstop["action"],
+00014af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014b00: 2029 0a0a 2020 2020 2020 2020 7320 3d20   )..        s = 
+00014b10: 7365 6c66 2e75 6e6b 6e6f 776e 5f64 7572  self.unknown_dur
+00014b20: 6174 696f 6e73 2e70 6f70 2874 732e 7072  ations.pop(ts.pr
+00014b30: 6566 6978 2e6e 616d 652c 2073 6574 2829  efix.name, set()
+00014b40: 290a 2020 2020 2020 2020 7374 6561 6c20  ).        steal 
+00014b50: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
+00014b60: 732e 6765 7428 2273 7465 616c 696e 6722  s.get("stealing"
+00014b70: 290a 2020 2020 2020 2020 6966 2073 7465  ).        if ste
+00014b80: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
+00014b90: 666f 7220 7474 7320 696e 2073 3a0a 2020  for tts in s:.  
+00014ba0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00014bb0: 2074 7473 2e70 726f 6365 7373 696e 675f   tts.processing_
+00014bc0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00014bd0: 2020 2020 2020 2020 7374 6561 6c2e 7265          steal.re
+00014be0: 6361 6c63 756c 6174 655f 636f 7374 2874  calculate_cost(t
+00014bf0: 7473 290a 0a20 2020 2020 2020 2023 2323  ts)..        ###
+00014c00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014c10: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
+00014c20: 2020 2320 5570 6461 7465 2053 7461 7465    # Update State
+00014c30: 2049 6e66 6f72 6d61 7469 6f6e 2023 0a20   Information #. 
+00014c40: 2020 2020 2020 2023 2323 2323 2323 2323         #########
+00014c50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014c60: 2323 230a 2020 2020 2020 2020 6966 206e  ###.        if n
+00014c70: 6279 7465 7320 6973 206e 6f74 204e 6f6e  bytes is not Non
+00014c80: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00014c90: 732e 7365 745f 6e62 7974 6573 286e 6279  s.set_nbytes(nby
+00014ca0: 7465 7329 0a0a 2020 2020 2020 2020 7365  tes)..        se
+00014cb0: 6c66 2e5f 6578 6974 5f70 726f 6365 7373  lf._exit_process
+00014cc0: 696e 675f 636f 6d6d 6f6e 2874 7329 0a0a  ing_common(ts)..
+00014cd0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00014ce0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+00014cf0: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
+00014d00: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
+00014d10: 7d0a 2020 2020 2020 2020 7365 6c66 2e5f  }.        self._
+00014d20: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
+00014d30: 2020 2020 2020 2020 2020 2074 732c 2077             ts, w
+00014d40: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
+00014d50: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
+00014d60: 2074 7970 653d 7479 7065 2c20 7479 7065   type=type, type
+00014d70: 6e61 6d65 3d74 7970 656e 616d 650a 2020  name=typename.  
+00014d80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00014d90: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00014da0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00014db0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+00014dc0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00014dd0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00014de0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00014df0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00014e00: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00014e10: 2063 6c69 656e 745f 6d73 6773 2c20 7b7d   client_msgs, {}
+00014e20: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00014e30: 7469 6f6e 5f6d 656d 6f72 795f 7265 6c65  tion_memory_rele
+00014e40: 6173 6564 280a 2020 2020 2020 2020 7365  ased(.        se
+00014e50: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
+00014e60: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
+00014e70: 2a2c 2073 6166 653a 2062 6f6f 6c20 3d20  *, safe: bool = 
+00014e80: 4661 6c73 650a 2020 2020 2920 2d3e 2052  False.    ) -> R
+00014e90: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+00014ea0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00014eb0: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
+00014ec0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00014ed0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00014ee0: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+00014ef0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+00014f00: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00014f10: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00014f20: 2020 2020 2020 2020 2020 6966 2073 6166            if saf
+00014f30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00014f40: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00014f50: 2e77 6169 7465 7273 0a0a 2020 2020 2020  .waiters..      
+00014f60: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
+00014f70: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+00014f80: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
+00014f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014fa0: 2077 732e 6163 746f 7273 2e64 6973 6361   ws.actors.disca
+00014fb0: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
+00014fc0: 2020 2069 6620 7473 2e77 686f 5f77 616e     if ts.who_wan
+00014fd0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00014fe0: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
+00014ff0: 5f62 6c61 6d65 203d 2074 730a 2020 2020  _blame = ts.    
+00015000: 2020 2020 2020 2020 2020 2020 7473 2e65              ts.e
+00015010: 7863 6570 7469 6f6e 203d 2053 6572 6961  xception = Seria
+00015020: 6c69 7a65 6428 0a20 2020 2020 2020 2020  lized(.         
+00015030: 2020 2020 2020 2020 2020 202a 7365 7269             *seri
+00015040: 616c 697a 6528 5661 6c75 6545 7272 6f72  alize(ValueError
+00015050: 2822 576f 726b 6572 2068 6f6c 6469 6e67  ("Worker holding
+00015060: 2041 6374 6f72 2077 6173 206c 6f73 7422   Actor was lost"
+00015070: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00015080: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00015090: 2020 2020 2072 6574 7572 6e20 7b74 732e       return {ts.
+000150a0: 6b65 793a 2022 6572 7265 6422 7d2c 207b  key: "erred"}, {
+000150b0: 7d2c 207b 7d20 2023 2064 6f6e 2774 2074  }, {}  # don't t
+000150c0: 7279 2074 6f20 7265 6372 6561 7465 0a0a  ry to recreate..
+000150d0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+000150e0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+000150f0: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
+00015100: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
+00015110: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
+00015120: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
+00015130: 0a0a 2020 2020 2020 2020 2320 5858 5820  ..        # XXX 
+00015140: 6661 6374 6f72 2074 6869 7320 6f75 743f  factor this out?
+00015150: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00015160: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+00015170: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
+00015180: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
+00015190: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
+000151a0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+000151b0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+000151c0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+000151d0: 2020 7d0a 2020 2020 2020 2020 666f 7220    }.        for 
+000151e0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+000151f0: 3a0a 2020 2020 2020 2020 2020 2020 776f  :.            wo
+00015200: 726b 6572 5f6d 7367 735b 7773 2e61 6464  rker_msgs[ws.add
+00015210: 7265 7373 5d20 3d20 5b77 6f72 6b65 725f  ress] = [worker_
+00015220: 6d73 675d 0a20 2020 2020 2020 2073 656c  msg].        sel
+00015230: 662e 7265 6d6f 7665 5f61 6c6c 5f72 6570  f.remove_all_rep
+00015240: 6c69 6361 7328 7473 290a 0a20 2020 2020  licas(ts)..     
+00015250: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
+00015260: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
+00015270: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
+00015280: 226f 7022 3a20 226c 6f73 742d 6461 7461  "op": "lost-data
+00015290: 222c 2022 6b65 7922 3a20 6b65 797d 0a20  ", "key": key}. 
+000152a0: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
+000152b0: 2074 732e 7768 6f5f 7761 6e74 733a 0a20   ts.who_wants:. 
+000152c0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+000152d0: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
+000152e0: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
+000152f0: 6d73 675d 0a0a 2020 2020 2020 2020 6966  msg]..        if
+00015300: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
+00015310: 3a20 2023 2070 7572 6520 6461 7461 0a20  :  # pure data. 
+00015320: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00015330: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
+00015340: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
+00015350: 2020 2020 2020 656c 6966 2074 732e 6861        elif ts.ha
+00015360: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
+00015370: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00015380: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00015390: 5b6b 6579 5d20 3d20 2266 6f72 676f 7474  [key] = "forgott
+000153a0: 656e 220a 2020 2020 2020 2020 656c 6966  en".        elif
+000153b0: 2074 732e 7768 6f5f 7761 6e74 7320 6f72   ts.who_wants or
+000153c0: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
+000153d0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+000153e0: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
+000153f0: 2277 6169 7469 6e67 220a 0a20 2020 2020  "waiting"..     
+00015400: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00015410: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
+00015420: 2020 2020 2020 6966 2064 7473 2e73 7461        if dts.sta
+00015430: 7465 2069 6e20 2822 6e6f 2d77 6f72 6b65  te in ("no-worke
+00015440: 7222 2c20 2270 726f 6365 7373 696e 6722  r", "processing"
+00015450: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00015460: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00015470: 6e73 5b64 7473 2e6b 6579 5d20 3d20 2277  ns[dts.key] = "w
+00015480: 6169 7469 6e67 220a 2020 2020 2020 2020  aiting".        
+00015490: 2020 2020 656c 6966 2064 7473 2e73 7461      elif dts.sta
+000154a0: 7465 203d 3d20 2277 6169 7469 6e67 223a  te == "waiting":
+000154b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154c0: 2064 7473 2e77 6169 7469 6e67 5f6f 6e2e   dts.waiting_on.
+000154d0: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
+000154e0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+000154f0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00015500: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00015510: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
+00015520: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+00015530: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00015540: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00015550: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
+00015560: 6974 696f 6e5f 7265 6c65 6173 6564 5f65  ition_released_e
+00015570: 7272 6564 2873 656c 662c 206b 6579 3a20  rred(self, key: 
+00015580: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+00015590: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+000155a0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+000155b0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000155c0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+000155d0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+000155e0: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
+000155f0: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
+00015600: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
+00015610: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00015620: 2020 2020 2020 2020 2020 7769 7468 206c            with l
+00015630: 6f67 5f65 7272 6f72 7328 7064 623d 4c4f  og_errors(pdb=LO
+00015640: 475f 5044 4229 3a0a 2020 2020 2020 2020  G_PDB):.        
+00015650: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00015660: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00015670: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00015680: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00015690: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+000156a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000156b0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
+000156c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000156d0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+000156e0: 6169 7465 7273 0a0a 2020 2020 2020 2020  aiters..        
+000156f0: 6661 696c 696e 675f 7473 203d 2074 732e  failing_ts = ts.
+00015700: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
+00015710: 2020 2020 2020 2020 6173 7365 7274 2066          assert f
+00015720: 6169 6c69 6e67 5f74 730a 0a20 2020 2020  ailing_ts..     
+00015730: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00015740: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+00015750: 2020 2020 2020 2020 2064 7473 2e65 7863           dts.exc
+00015760: 6570 7469 6f6e 5f62 6c61 6d65 203d 2066  eption_blame = f
+00015770: 6169 6c69 6e67 5f74 730a 2020 2020 2020  ailing_ts.      
+00015780: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
+00015790: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+000157a0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+000157b0: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+000157c0: 795d 203d 2022 6572 7265 6422 0a0a 2020  y] = "erred"..  
+000157d0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+000157e0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+000157f0: 2022 6f70 223a 2022 7461 736b 2d65 7272   "op": "task-err
+00015800: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00015810: 2022 6b65 7922 3a20 6b65 792c 0a20 2020   "key": key,.   
+00015820: 2020 2020 2020 2020 2022 6578 6365 7074           "except
+00015830: 696f 6e22 3a20 6661 696c 696e 675f 7473  ion": failing_ts
+00015840: 2e65 7863 6570 7469 6f6e 2c0a 2020 2020  .exception,.    
+00015850: 2020 2020 2020 2020 2274 7261 6365 6261          "traceba
+00015860: 636b 223a 2066 6169 6c69 6e67 5f74 732e  ck": failing_ts.
+00015870: 7472 6163 6562 6163 6b2c 0a20 2020 2020  traceback,.     
+00015880: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
+00015890: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
+000158a0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+000158b0: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
+000158c0: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
+000158d0: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
+000158e0: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
+000158f0: 6572 7265 6422 0a0a 2020 2020 2020 2020  erred"..        
+00015900: 2320 544f 444f 3a20 7761 6974 696e 6720  # TODO: waiting 
+00015910: 6461 7461 3f0a 2020 2020 2020 2020 7265  data?.        re
+00015920: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+00015930: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00015940: 732c 207b 7d0a 0a20 2020 2064 6566 2074  s, {}..    def t
+00015950: 7261 6e73 6974 696f 6e5f 6572 7265 645f  ransition_erred_
+00015960: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
+00015970: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00015980: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00015990: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+000159a0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+000159b0: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+000159c0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+000159d0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+000159e0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+000159f0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00015a00: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00015a10: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
+00015a20: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00015a30: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+00015a40: 6820 6c6f 675f 6572 726f 7273 2870 6462  h log_errors(pdb
+00015a50: 3d4c 4f47 5f50 4442 293a 0a20 2020 2020  =LOG_PDB):.     
+00015a60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00015a70: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
+00015a80: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
+00015a90: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00015aa0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+00015ab0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00015ac0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+00015ad0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+00015ae0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00015af0: 732e 7761 6974 6572 730a 0a20 2020 2020  s.waiters..     
+00015b00: 2020 2074 732e 6578 6365 7074 696f 6e20     ts.exception 
+00015b10: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
+00015b20: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00015b30: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+00015b40: 2074 732e 7472 6163 6562 6163 6b20 3d20   ts.traceback = 
+00015b50: 4e6f 6e65 0a0a 2020 2020 2020 2020 666f  None..        fo
+00015b60: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00015b70: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
+00015b80: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
+00015b90: 203d 3d20 2265 7272 6564 223a 0a20 2020   == "erred":.   
+00015ba0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+00015bb0: 6f6d 6d65 6e64 6174 696f 6e73 5b64 7473  ommendations[dts
+00015bc0: 2e6b 6579 5d20 3d20 2277 6169 7469 6e67  .key] = "waiting
+00015bd0: 220a 0a20 2020 2020 2020 2077 5f6d 7367  "..        w_msg
+00015be0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00015bf0: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
+00015c00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00015c10: 226b 6579 7322 3a20 5b6b 6579 5d2c 0a20  "keys": [key],. 
+00015c20: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+00015c30: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+00015c40: 7573 5f69 642c 0a20 2020 2020 2020 207d  us_id,.        }
+00015c50: 0a20 2020 2020 2020 2066 6f72 2077 735f  .        for ws_
+00015c60: 6164 6472 2069 6e20 7473 2e65 7272 6564  addr in ts.erred
+00015c70: 5f6f 6e3a 0a20 2020 2020 2020 2020 2020  _on:.           
+00015c80: 2077 6f72 6b65 725f 6d73 6773 5b77 735f   worker_msgs[ws_
+00015c90: 6164 6472 5d20 3d20 5b77 5f6d 7367 5d0a  addr] = [w_msg].
+00015ca0: 2020 2020 2020 2020 7473 2e65 7272 6564          ts.erred
+00015cb0: 5f6f 6e2e 636c 6561 7228 290a 0a20 2020  _on.clear()..   
+00015cc0: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
+00015cd0: 3d20 7b22 6f70 223a 2022 7461 736b 2d72  = {"op": "task-r
+00015ce0: 6574 7269 6564 222c 2022 6b65 7922 3a20  etried", "key": 
+00015cf0: 6b65 797d 0a20 2020 2020 2020 2066 6f72  key}.        for
+00015d00: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
+00015d10: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00015d20: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
+00015d30: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
+00015d40: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
+00015d50: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
+00015d60: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
+00015d70: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+00015d80: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00015d90: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00015da0: 7367 730a 0a20 2020 2064 6566 2074 7261  sgs..    def tra
+00015db0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
+00015dc0: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
+00015dd0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00015de0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00015df0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00015e00: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00015e10: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+00015e20: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00015e30: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
+00015e40: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00015e50: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00015e60: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00015e70: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00015e80: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+00015e90: 726f 6365 7373 696e 675f 6f6e 0a0a 2020  rocessing_on..  
+00015ea0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00015eb0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00015ec0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00015ed0: 2074 7320 696e 2064 7473 2e77 6169 7465   ts in dts.waite
+00015ee0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00015ef0: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
+00015f00: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+00015f10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00015f20: 6f74 2064 7473 2e77 6169 7465 7273 2061  ot dts.waiters a
+00015f30: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
+00015f40: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+00015f50: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00015f60: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+00015f70: 795d 203d 2022 7265 6c65 6173 6564 220a  y] = "released".
+00015f80: 2020 2020 2020 2020 7473 2e77 6169 7469          ts.waiti
+00015f90: 6e67 5f6f 6e2e 636c 6561 7228 290a 0a20  ng_on.clear().. 
+00015fa0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+00015fb0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
+00015fc0: 2020 2020 2020 6966 2074 732e 6861 735f        if ts.has_
+00015fd0: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
+00015fe0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00015ff0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+00016000: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
+00016010: 220a 2020 2020 2020 2020 656c 6966 206e  ".        elif n
+00016020: 6f74 2074 732e 6578 6365 7074 696f 6e5f  ot ts.exception_
+00016030: 626c 616d 6520 616e 6420 2874 732e 7768  blame and (ts.wh
+00016040: 6f5f 7761 6e74 7320 6f72 2074 732e 7761  o_wants or ts.wa
+00016050: 6974 6572 7329 3a0a 2020 2020 2020 2020  iters):.        
+00016060: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00016070: 6f6e 735b 6b65 795d 203d 2022 7761 6974  ons[key] = "wait
+00016080: 696e 6722 0a20 2020 2020 2020 2065 6c73  ing".        els
+00016090: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+000160a0: 732e 7761 6974 6572 732e 636c 6561 7228  s.waiters.clear(
+000160b0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+000160c0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+000160d0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
+000160e0: 6566 2074 7261 6e73 6974 696f 6e5f 7072  ef transition_pr
+000160f0: 6f63 6573 7369 6e67 5f72 656c 6561 7365  ocessing_release
+00016100: 6428 7365 6c66 2c20 6b65 793a 2073 7472  d(self, key: str
+00016110: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00016120: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00016130: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00016140: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+00016150: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00016160: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00016170: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
+00016180: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+00016190: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000161a0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+000161b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000161c0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+000161d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000161e0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+000161f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00016200: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+00016210: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+00016220: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+00016230: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
+00016240: 220a 0a20 2020 2020 2020 2077 7320 3d20  "..        ws = 
+00016250: 7365 6c66 2e5f 6578 6974 5f70 726f 6365  self._exit_proce
+00016260: 7373 696e 675f 636f 6d6d 6f6e 2874 7329  ssing_common(ts)
+00016270: 0a20 2020 2020 2020 2069 6620 7773 3a0a  .        if ws:.
+00016280: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00016290: 6572 5f6d 7367 735b 7773 2e61 6464 7265  er_msgs[ws.addre
+000162a0: 7373 5d20 3d20 5b0a 2020 2020 2020 2020  ss] = [.        
+000162b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000162c0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+000162d0: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
+000162e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000162f0: 2020 2020 2022 6b65 7973 223a 205b 6b65       "keys": [ke
+00016300: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
+00016310: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+00016320: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+00016330: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00016340: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00016350: 2020 5d0a 0a20 2020 2020 2020 2073 656c    ]..        sel
+00016360: 662e 5f70 726f 7061 6761 7465 5f72 656c  f._propagate_rel
+00016370: 6561 7365 6428 7473 2c20 7265 636f 6d6d  eased(ts, recomm
+00016380: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
+00016390: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+000163a0: 656e 6461 7469 6f6e 732c 207b 7d2c 2077  endations, {}, w
+000163b0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
+000163c0: 6465 6620 7472 616e 7369 7469 6f6e 5f70  def transition_p
+000163d0: 726f 6365 7373 696e 675f 6572 7265 6428  rocessing_erred(
+000163e0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000163f0: 2020 2020 2020 206b 6579 3a20 7374 722c         key: str,
+00016400: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00016410: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
+00016420: 2020 202a 2c0a 2020 2020 2020 2020 776f     *,.        wo
+00016430: 726b 6572 3a20 7374 722c 0a20 2020 2020  rker: str,.     
+00016440: 2020 2063 6175 7365 3a20 7374 7220 7c20     cause: str | 
+00016450: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00016460: 2020 2020 2065 7863 6570 7469 6f6e 3a20       exception: 
+00016470: 5365 7269 616c 697a 6564 207c 204e 6f6e  Serialized | Non
+00016480: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00016490: 2020 7472 6163 6562 6163 6b3a 2053 6572    traceback: Ser
+000164a0: 6961 6c69 7a65 6420 7c20 4e6f 6e65 203d  ialized | None =
+000164b0: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+000164c0: 7863 6570 7469 6f6e 5f74 6578 743a 2073  xception_text: s
+000164d0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+000164e0: 2c0a 2020 2020 2020 2020 7472 6163 6562  ,.        traceb
+000164f0: 6163 6b5f 7465 7874 3a20 7374 7220 7c20  ack_text: str | 
+00016500: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00016510: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+00016520: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
+00016530: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
+00016540: 2222 5072 6f63 6573 7365 6420 6120 7265  ""Processed a re
+00016550: 636f 6d6d 656e 6465 6420 7472 616e 7369  commended transi
+00016560: 7469 6f6e 2070 726f 6365 7373 696e 6720  tion processing 
+00016570: 2d3e 2065 7272 6564 2e0a 0a20 2020 2020  -> erred...     
+00016580: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00016590: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
+000165a0: 0a20 2020 2020 2020 206b 6579 0a20 2020  .        key.   
+000165b0: 2020 2020 2020 2020 4b65 7920 6f66 2074          Key of t
+000165c0: 6865 2074 6173 6b20 746f 2074 7261 6e73  he task to trans
+000165d0: 6974 696f 6e0a 2020 2020 2020 2020 7374  ition.        st
+000165e0: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
+000165f0: 2020 2020 2020 4944 206f 6620 7468 6520        ID of the 
+00016600: 7374 696d 756c 7573 2063 6175 7369 6e67  stimulus causing
+00016610: 2074 6865 2074 7261 6e73 6974 696f 6e0a   the transition.
+00016620: 2020 2020 2020 2020 776f 726b 6572 0a20          worker. 
+00016630: 2020 2020 2020 2020 2020 2041 6464 7265             Addre
+00016640: 7373 206f 6620 7468 6520 776f 726b 6572  ss of the worker
+00016650: 2077 6865 7265 2074 6865 2074 6173 6b20   where the task 
+00016660: 6572 7265 642e 0a20 2020 2020 2020 2020  erred..         
+00016670: 2020 204e 6f74 206e 6563 6573 7361 7269     Not necessari
+00016680: 6c79 2060 6074 732e 7072 6f63 6573 7369  ly ``ts.processi
+00016690: 6e67 5f6f 6e60 602e 0a20 2020 2020 2020  ng_on``..       
+000166a0: 2063 6175 7365 0a20 2020 2020 2020 2020   cause.         
+000166b0: 2020 2041 6464 7265 7373 206f 6620 7468     Address of th
+000166c0: 6520 7461 736b 2074 6861 7420 6361 7573  e task that caus
+000166d0: 6564 2074 6869 7320 7461 736b 2074 6f20  ed this task to 
+000166e0: 6265 2074 7261 6e73 6974 696f 6e65 6420  be transitioned 
+000166f0: 746f 2065 7272 6564 0a20 2020 2020 2020  to erred.       
+00016700: 2065 7863 6570 7469 6f6e 0a20 2020 2020   exception.     
+00016710: 2020 2020 2020 2045 7863 6570 7469 6f6e         Exception
+00016720: 2063 6175 7365 6420 6279 2074 6865 2074   caused by the t
+00016730: 6173 6b0a 2020 2020 2020 2020 7472 6163  ask.        trac
+00016740: 6562 6163 6b0a 2020 2020 2020 2020 2020  eback.          
+00016750: 2020 5472 6163 6562 6163 6b20 6361 7573    Traceback caus
+00016760: 6564 2062 7920 7468 6520 7461 736b 0a20  ed by the task. 
+00016770: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00016780: 5f74 6578 740a 2020 2020 2020 2020 2020  _text.          
+00016790: 2020 5374 7269 6e67 2072 6570 7265 7365    String represe
+000167a0: 6e74 6174 696f 6e20 6f66 2074 6865 2065  ntation of the e
+000167b0: 7863 6570 7469 6f6e 0a20 2020 2020 2020  xception.       
+000167c0: 2074 7261 6365 6261 636b 5f74 6578 740a   traceback_text.
+000167d0: 2020 2020 2020 2020 2020 2020 5374 7269              Stri
+000167e0: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
+000167f0: 6e20 6f66 2074 6865 2074 7261 6365 6261  n of the traceba
+00016800: 636b 0a0a 2020 2020 2020 2020 5265 7475  ck..        Retu
+00016810: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
+00016820: 2d2d 2d0a 2020 2020 2020 2020 5265 636f  ---.        Reco
+00016830: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00016840: 656e 7420 6d65 7373 6167 6573 2061 6e64  ent messages and
+00016850: 2077 6f72 6b65 7220 6d65 7373 6167 6573   worker messages
+00016860: 2074 6f20 7072 6f63 6573 730a 2020 2020   to process.    
+00016870: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00016880: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00016890: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+000168a0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+000168b0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+000168c0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+000168d0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+000168e0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+000168f0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00016900: 7365 7274 2063 6175 7365 206f 7220 7473  sert cause or ts
+00016910: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00016920: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00016930: 6572 7420 7473 2e70 726f 6365 7373 696e  ert ts.processin
+00016940: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00016950: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00016960: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00016970: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00016980: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
+00016990: 2020 2020 2069 6620 7473 2e61 6374 6f72       if ts.actor
+000169a0: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+000169b0: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
+000169c0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+000169d0: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
+000169e0: 2020 2020 2020 7773 2e61 6374 6f72 732e        ws.actors.
+000169f0: 7265 6d6f 7665 2874 7329 0a0a 2020 2020  remove(ts)..    
+00016a00: 2020 2020 7365 6c66 2e5f 6578 6974 5f70      self._exit_p
+00016a10: 726f 6365 7373 696e 675f 636f 6d6d 6f6e  rocessing_common
+00016a20: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
+00016a30: 2e65 7272 6564 5f6f 6e2e 6164 6428 776f  .erred_on.add(wo
+00016a40: 726b 6572 290a 2020 2020 2020 2020 6966  rker).        if
+00016a50: 2065 7863 6570 7469 6f6e 2069 7320 6e6f   exception is no
+00016a60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00016a70: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
+00016a80: 203d 2065 7863 6570 7469 6f6e 0a20 2020   = exception.   
+00016a90: 2020 2020 2020 2020 2074 732e 6578 6365           ts.exce
+00016aa0: 7074 696f 6e5f 7465 7874 203d 2065 7863  ption_text = exc
+00016ab0: 6570 7469 6f6e 5f74 6578 7420 2023 2074  eption_text  # t
+00016ac0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00016ad0: 2020 2020 6966 2074 7261 6365 6261 636b      if traceback
+00016ae0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00016af0: 2020 2020 2020 2020 2020 7473 2e74 7261            ts.tra
+00016b00: 6365 6261 636b 203d 2074 7261 6365 6261  ceback = traceba
+00016b10: 636b 0a20 2020 2020 2020 2020 2020 2074  ck.            t
+00016b20: 732e 7472 6163 6562 6163 6b5f 7465 7874  s.traceback_text
+00016b30: 203d 2074 7261 6365 6261 636b 5f74 6578   = traceback_tex
+00016b40: 7420 2023 2074 7970 653a 2069 676e 6f72  t  # type: ignor
+00016b50: 650a 2020 2020 2020 2020 6966 2063 6175  e.        if cau
+00016b60: 7365 2069 7320 6e6f 7420 4e6f 6e65 3a0a  se is not None:.
+00016b70: 2020 2020 2020 2020 2020 2020 6661 696c              fail
+00016b80: 696e 675f 7473 203d 2073 656c 662e 7461  ing_ts = self.ta
+00016b90: 736b 735b 6361 7573 655d 0a20 2020 2020  sks[cause].     
+00016ba0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
+00016bb0: 696f 6e5f 626c 616d 6520 3d20 6661 696c  ion_blame = fail
+00016bc0: 696e 675f 7473 0a20 2020 2020 2020 2065  ing_ts.        e
+00016bd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00016be0: 2066 6169 6c69 6e67 5f74 7320 3d20 7473   failing_ts = ts
+00016bf0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00016c00: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00016c10: 0a0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
+00016c20: 7272 6564 5f74 6173 6b73 2e61 7070 656e  rred_tasks.appen
+00016c30: 646c 6566 7428 0a20 2020 2020 2020 2020  dleft(.         
+00016c40: 2020 2045 7272 6564 5461 736b 280a 2020     ErredTask(.  
+00016c50: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00016c60: 2e6b 6579 2c0a 2020 2020 2020 2020 2020  .key,.          
+00016c70: 2020 2020 2020 7469 6d65 2829 2c0a 2020        time(),.  
+00016c80: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00016c90: 2e65 7272 6564 5f6f 6e2e 636f 7079 2829  .erred_on.copy()
+00016ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016cb0: 2020 6578 6365 7074 696f 6e5f 7465 7874    exception_text
+00016cc0: 206f 7220 2222 2c0a 2020 2020 2020 2020   or "",.        
+00016cd0: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
+00016ce0: 6b5f 7465 7874 206f 7220 2222 2c0a 2020  k_text or "",.  
+00016cf0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016d00: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
+00016d10: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+00016d20: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
+00016d30: 2020 2020 2064 7473 2e65 7863 6570 7469       dts.excepti
+00016d40: 6f6e 5f62 6c61 6d65 203d 2066 6169 6c69  on_blame = faili
+00016d50: 6e67 5f74 730a 2020 2020 2020 2020 2020  ng_ts.          
+00016d60: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00016d70: 735b 6474 732e 6b65 795d 203d 2022 6572  s[dts.key] = "er
+00016d80: 7265 6422 0a0a 2020 2020 2020 2020 666f  red"..        fo
+00016d90: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00016da0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+00016db0: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
+00016dc0: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
+00016dd0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00016de0: 2064 7473 2e77 6169 7465 7273 2061 6e64   dts.waiters and
+00016df0: 206e 6f74 2064 7473 2e77 686f 5f77 616e   not dts.who_wan
+00016e00: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00016e10: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00016e20: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+00016e30: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
+00016e40: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
+00016e50: 6561 7228 2920 2023 2064 6f20 616e 7974  ear()  # do anyt
+00016e60: 6869 6e67 2077 6974 6820 7468 6973 3f0a  hing with this?.
+00016e70: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
+00016e80: 6520 3d20 2265 7272 6564 220a 0a20 2020  e = "erred"..   
+00016e90: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
+00016ea0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00016eb0: 226f 7022 3a20 2274 6173 6b2d 6572 7265  "op": "task-erre
+00016ec0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00016ed0: 226b 6579 223a 206b 6579 2c0a 2020 2020  "key": key,.    
+00016ee0: 2020 2020 2020 2020 2265 7863 6570 7469          "excepti
+00016ef0: 6f6e 223a 2066 6169 6c69 6e67 5f74 732e  on": failing_ts.
+00016f00: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
+00016f10: 2020 2020 2020 2022 7472 6163 6562 6163         "tracebac
+00016f20: 6b22 3a20 6661 696c 696e 675f 7473 2e74  k": failing_ts.t
+00016f30: 7261 6365 6261 636b 2c0a 2020 2020 2020  raceback,.      
+00016f40: 2020 7d0a 2020 2020 2020 2020 666f 7220    }.        for 
+00016f50: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+00016f60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00016f70: 636c 6965 6e74 5f6d 7367 735b 6373 2e63  client_msgs[cs.c
+00016f80: 6c69 656e 745f 6b65 795d 203d 205b 7265  lient_key] = [re
+00016f90: 706f 7274 5f6d 7367 5d0a 0a20 2020 2020  port_msg]..     
+00016fa0: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
+00016fb0: 656e 7473 5b22 6669 7265 2d61 6e64 2d66  ents["fire-and-f
+00016fc0: 6f72 6765 7422 5d0a 2020 2020 2020 2020  orget"].        
+00016fd0: 6966 2074 7320 696e 2063 732e 7761 6e74  if ts in cs.want
+00016fe0: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
+00016ff0: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+00017000: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
+00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017020: 6373 3d63 732c 0a20 2020 2020 2020 2020  cs=cs,.         
+00017030: 2020 2020 2020 206b 6579 733d 5b6b 6579         keys=[key
+00017040: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00017050: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00017060: 6e73 3d72 6563 6f6d 6d65 6e64 6174 696f  ns=recommendatio
+00017070: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00017080: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00017090: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+000170a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000170b0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+000170c0: 675f 6f6e 0a0a 2020 2020 2020 2020 7265  g_on..        re
+000170d0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+000170e0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+000170f0: 732c 207b 7d0a 0a20 2020 2064 6566 2074  s, {}..    def t
+00017100: 7261 6e73 6974 696f 6e5f 6e6f 5f77 6f72  ransition_no_wor
+00017110: 6b65 725f 7265 6c65 6173 6564 2873 656c  ker_released(sel
+00017120: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00017130: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00017140: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
+00017150: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00017160: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
+00017170: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00017180: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00017190: 6173 7365 7274 2073 656c 662e 7461 736b  assert self.task
+000171a0: 735b 6b65 795d 2e73 7461 7465 203d 3d20  s[key].state == 
+000171b0: 226e 6f2d 776f 726b 6572 220a 2020 2020  "no-worker".    
+000171c0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000171d0: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+000171e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000171f0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+00017200: 6f6e 0a0a 2020 2020 2020 2020 7365 6c66  on..        self
+00017210: 2e75 6e72 756e 6e61 626c 652e 7265 6d6f  .unrunnable.remo
+00017220: 7665 2874 7329 0a20 2020 2020 2020 2074  ve(ts).        t
+00017230: 732e 7374 6174 6520 3d20 2272 656c 6561  s.state = "relea
+00017240: 7365 6422 0a0a 2020 2020 2020 2020 666f  sed"..        fo
+00017250: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00017260: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+00017270: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
+00017280: 732e 6469 7363 6172 6428 7473 290a 0a20  s.discard(ts).. 
+00017290: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
+000172a0: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
+000172b0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
+000172c0: 2c20 7b7d 0a0a 2020 2020 6465 6620 7472  , {}..    def tr
+000172d0: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
+000172e0: 5f71 7565 7565 6428 7365 6c66 2c20 6b65  _queued(self, ke
+000172f0: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
+00017300: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00017310: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00017320: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00017330: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
+00017340: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00017350: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00017360: 7420 6e6f 7420 7365 6c66 2e69 646c 655f  t not self.idle_
+00017370: 7461 736b 5f63 6f75 6e74 2c20 2874 732c  task_count, (ts,
+00017380: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
+00017390: 636f 756e 7429 0a20 2020 2020 2020 2020  count).         
+000173a0: 2020 2073 656c 662e 5f76 616c 6964 6174     self._validat
+000173b0: 655f 7265 6164 7928 7473 290a 0a20 2020  e_ready(ts)..   
+000173c0: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
+000173d0: 2271 7565 7565 6422 0a20 2020 2020 2020  "queued".       
+000173e0: 2073 656c 662e 7175 6575 6564 2e61 6464   self.queued.add
+000173f0: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
+00017400: 7475 726e 207b 7d2c 207b 7d2c 207b 7d0a  turn {}, {}, {}.
+00017410: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
+00017420: 696f 6e5f 7761 6974 696e 675f 6e6f 5f77  ion_waiting_no_w
+00017430: 6f72 6b65 7228 7365 6c66 2c20 6b65 793a  orker(self, key:
+00017440: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00017450: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00017460: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00017470: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00017480: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00017490: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+000174a0: 2020 2020 2020 2020 2073 656c 662e 5f76           self._v
+000174b0: 616c 6964 6174 655f 7265 6164 7928 7473  alidate_ready(ts
+000174c0: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
+000174d0: 6174 6520 3d20 226e 6f2d 776f 726b 6572  ate = "no-worker
+000174e0: 220a 2020 2020 2020 2020 7365 6c66 2e75  ".        self.u
+000174f0: 6e72 756e 6e61 626c 652e 6164 6428 7473  nrunnable.add(ts
+00017500: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00017510: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
+00017520: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+00017530: 5f71 7565 7565 645f 7265 6c65 6173 6564  _queued_released
+00017540: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00017550: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00017560: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00017570: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00017580: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+00017590: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+000175a0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000175b0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+000175c0: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
+000175d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000175e0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+000175f0: 675f 6f6e 0a0a 2020 2020 2020 2020 7365  g_on..        se
+00017600: 6c66 2e71 7565 7565 642e 7265 6d6f 7665  lf.queued.remove
+00017610: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
+00017620: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+00017630: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
+00017640: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
+00017650: 5f72 656c 6561 7365 6428 7473 2c20 7265  _released(ts, re
+00017660: 636f 6d6d 656e 6461 7469 6f6e 7329 0a20  commendations). 
+00017670: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00017680: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
+00017690: 7d2c 207b 7d0a 0a20 2020 2064 6566 2074  }, {}..    def t
+000176a0: 7261 6e73 6974 696f 6e5f 7175 6575 6564  ransition_queued
+000176b0: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
+000176c0: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+000176d0: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+000176e0: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+000176f0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00017700: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+00017710: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+00017720: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
+00017730: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
+00017740: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
+00017750: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00017760: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00017770: 2061 7373 6572 7420 6e6f 7420 7473 2e61   assert not ts.a
+00017780: 6374 6f72 2c20 6622 4163 746f 7273 2063  ctor, f"Actors c
+00017790: 616e 2774 2062 6520 7175 6575 6564 3a20  an't be queued: 
+000177a0: 7b74 737d 220a 2020 2020 2020 2020 2020  {ts}".          
+000177b0: 2020 6173 7365 7274 2074 7320 696e 2073    assert ts in s
+000177c0: 656c 662e 7175 6575 6564 0a0a 2020 2020  elf.queued..    
+000177d0: 2020 2020 6966 2077 7320 3a3d 2073 656c      if ws := sel
+000177e0: 662e 6465 6369 6465 5f77 6f72 6b65 725f  f.decide_worker_
+000177f0: 726f 6f74 6973 685f 7175 6575 696e 675f  rootish_queuing_
+00017800: 656e 6162 6c65 6428 293a 0a20 2020 2020  enabled():.     
+00017810: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+00017820: 6564 2e64 6973 6361 7264 2874 7329 0a20  ed.discard(ts). 
+00017830: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00017840: 725f 6d73 6773 203d 2073 656c 662e 5f61  r_msgs = self._a
+00017850: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
+00017860: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
+00017870: 2023 2049 6620 6e6f 2077 6f72 6b65 722c   # If no worker,
+00017880: 2074 6173 6b20 6a75 7374 2073 7461 7973   task just stays
+00017890: 2060 7175 6575 6564 600a 0a20 2020 2020   `queued`..     
+000178a0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+000178b0: 656e 6461 7469 6f6e 732c 207b 7d2c 2077  endations, {}, w
+000178c0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
+000178d0: 6465 6620 5f72 656d 6f76 655f 6b65 7928  def _remove_key(
+000178e0: 7365 6c66 2c20 6b65 793a 2073 7472 2920  self, key: str) 
+000178f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00017900: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00017910: 2e70 6f70 286b 6579 290a 2020 2020 2020  .pop(key).      
+00017920: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+00017930: 6520 3d3d 2022 666f 7267 6f74 7465 6e22  e == "forgotten"
+00017940: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+00017950: 7275 6e6e 6162 6c65 2e64 6973 6361 7264  runnable.discard
+00017960: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
+00017970: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
+00017980: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00017990: 2063 732e 7761 6e74 735f 7768 6174 2e72   cs.wants_what.r
+000179a0: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
+000179b0: 2020 7473 2e77 686f 5f77 616e 7473 2e63    ts.who_wants.c
+000179c0: 6c65 6172 2829 0a20 2020 2020 2020 2074  lear().        t
+000179d0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e20  s.processing_on 
+000179e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
+000179f0: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00017a00: 6520 3d20 7473 2e65 7863 6570 7469 6f6e  e = ts.exception
+00017a10: 203d 2074 732e 7472 6163 6562 6163 6b20   = ts.traceback 
+00017a20: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+00017a30: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
+00017a40: 612e 706f 7028 6b65 792c 204e 6f6e 6529  a.pop(key, None)
+00017a50: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00017a60: 7469 6f6e 5f6d 656d 6f72 795f 666f 7267  tion_memory_forg
+00017a70: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
+00017a80: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00017a90: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00017aa0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00017ab0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00017ac0: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00017ad0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00017ae0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00017af0: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
+00017b00: 6f72 7922 0a20 2020 2020 2020 2020 2020  ory".           
+00017b10: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+00017b20: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+00017b30: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00017b40: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
+00017b50: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+00017b60: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
+00017b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017b80: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
+00017b90: 6f72 6765 7420 6120 7075 7265 2064 6174  orget a pure dat
+00017ba0: 6120 7461 736b 0a20 2020 2020 2020 2020  a task.         
+00017bb0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00017bc0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
+00017bd0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
+00017be0: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+00017bf0: 2020 2020 2020 2023 2049 7427 7320 6f6b         # It's ok
+00017c00: 2074 6f20 666f 7267 6574 2061 2074 6173   to forget a tas
+00017c10: 6b20 7769 7468 2066 6f72 676f 7474 656e  k with forgotten
+00017c20: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
+00017c30: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00017c40: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+00017c50: 6c69 6620 6e6f 7420 7473 2e77 686f 5f77  lif not ts.who_w
+00017c60: 616e 7473 2061 6e64 206e 6f74 2074 732e  ants and not ts.
+00017c70: 7761 6974 6572 7320 616e 6420 6e6f 7420  waiters and not 
+00017c80: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
+00017c90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017ca0: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
+00017cb0: 6574 2061 2074 6173 6b20 7468 6174 206e  et a task that n
+00017cc0: 6f62 6f64 7920 6e65 6564 730a 2020 2020  obody needs.    
+00017cd0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00017ce0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00017cf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00017d00: 2020 2072 6169 7365 2041 7373 6572 7469     raise Asserti
+00017d10: 6f6e 4572 726f 7228 2255 6e72 6561 6368  onError("Unreach
+00017d20: 6162 6c65 222c 2074 7329 2020 2320 7072  able", ts)  # pr
+00017d30: 6167 6d61 3a20 6e6f 636f 7665 720a 0a20  agma: nocover.. 
+00017d40: 2020 2020 2020 2069 6620 7473 2e61 6374         if ts.act
+00017d50: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00017d60: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+00017d70: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+00017d80: 2020 2020 2020 7773 2e61 6374 6f72 732e        ws.actors.
+00017d90: 6469 7363 6172 6428 7473 290a 0a20 2020  discard(ts)..   
+00017da0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00017db0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00017dc0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00017dd0: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
+00017de0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+00017df0: 7061 6761 7465 5f66 6f72 676f 7474 656e  pagate_forgotten
+00017e00: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
+00017e10: 696f 6e73 2c20 776f 726b 6572 5f6d 7367  ions, worker_msg
+00017e20: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
+00017e30: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+00017e40: 6d73 6773 203d 205f 7461 736b 5f74 6f5f  msgs = _task_to_
+00017e50: 636c 6965 6e74 5f6d 7367 7328 7473 290a  client_msgs(ts).
+00017e60: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+00017e70: 6d6f 7665 5f6b 6579 286b 6579 290a 0a20  move_key(key).. 
+00017e80: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00017e90: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+00017ea0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+00017eb0: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
+00017ec0: 2074 7261 6e73 6974 696f 6e5f 7265 6c65   transition_rele
+00017ed0: 6173 6564 5f66 6f72 676f 7474 656e 2873  ased_forgotten(s
+00017ee0: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
+00017ef0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
+00017f00: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00017f10: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00017f20: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00017f30: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00017f40: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00017f50: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+00017f60: 6520 696e 2028 2272 656c 6561 7365 6422  e in ("released"
+00017f70: 2c20 2265 7272 6564 2229 0a20 2020 2020  , "erred").     
+00017f80: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00017f90: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+00017fa0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00017fb0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
+00017fc0: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00017fd0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
+00017fe0: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
+00017ff0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00018000: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+00018010: 6f6e 2c20 2874 732c 2074 732e 7761 6974  on, (ts, ts.wait
+00018020: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
+00018030: 2020 2020 6966 206e 6f74 2074 732e 7275      if not ts.ru
+00018040: 6e5f 7370 6563 3a0a 2020 2020 2020 2020  n_spec:.        
+00018050: 2020 2020 2020 2020 2320 4974 2773 206f          # It's o
+00018060: 6b20 746f 2066 6f72 6765 7420 6120 7075  k to forget a pu
+00018070: 7265 2064 6174 6120 7461 736b 0a20 2020  re data task.   
+00018080: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00018090: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
+000180a0: 6966 2074 732e 6861 735f 6c6f 7374 5f64  if ts.has_lost_d
+000180b0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+000180c0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+000180d0: 7427 7320 6f6b 2074 6f20 666f 7267 6574  t's ok to forget
+000180e0: 2061 2074 6173 6b20 7769 7468 2066 6f72   a task with for
+000180f0: 676f 7474 656e 2064 6570 656e 6465 6e63  gotten dependenc
+00018100: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+00018110: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00018120: 2020 2020 2065 6c69 6620 6e6f 7420 7473       elif not ts
+00018130: 2e77 686f 5f77 616e 7473 2061 6e64 206e  .who_wants and n
+00018140: 6f74 2074 732e 7761 6974 6572 7320 616e  ot ts.waiters an
+00018150: 6420 6e6f 7420 7473 2e64 6570 656e 6465  d not ts.depende
+00018160: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00018170: 2020 2020 2023 2049 7427 7320 6f6b 2074       # It's ok t
+00018180: 6f20 666f 7267 6574 2061 2074 6173 6b20  o forget a task 
+00018190: 7468 6174 206e 6f62 6f64 7920 6e65 6564  that nobody need
+000181a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000181b0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+000181c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000181d0: 2020 2020 2020 2020 2072 6169 7365 2041           raise A
+000181e0: 7373 6572 7469 6f6e 4572 726f 7228 2255  ssertionError("U
+000181f0: 6e72 6561 6368 6162 6c65 222c 2073 7472  nreachable", str
+00018200: 2874 7329 2920 2023 2070 7261 676d 613a  (ts))  # pragma:
+00018210: 206e 6f63 6f76 6572 0a0a 2020 2020 2020   nocover..      
+00018220: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00018230: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+00018240: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00018250: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
+00018260: 2020 2020 7365 6c66 2e5f 7072 6f70 6167      self._propag
+00018270: 6174 655f 666f 7267 6f74 7465 6e28 7473  ate_forgotten(ts
+00018280: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
+00018290: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
+000182a0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+000182b0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+000182c0: 7320 3d20 5f74 6173 6b5f 746f 5f63 6c69  s = _task_to_cli
+000182d0: 656e 745f 6d73 6773 2874 7329 0a20 2020  ent_msgs(ts).   
+000182e0: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
+000182f0: 655f 6b65 7928 6b65 7929 0a0a 2020 2020  e_key(key)..    
+00018300: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
+00018310: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
+00018320: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
+00018330: 6d73 6773 0a0a 2020 2020 2320 7b0a 2020  msgs..    # {.  
+00018340: 2020 2320 2020 2020 2873 7461 7274 2c20    #     (start, 
+00018350: 6669 6e69 7368 293a 0a20 2020 2023 2020  finish):.    #  
+00018360: 2020 2074 7261 6e73 6974 696f 6e5f 3c73     transition_<s
+00018370: 7461 7274 3e5f 3c66 696e 6973 683e 280a  tart>_<finish>(.
+00018380: 2020 2020 2320 2020 2020 2020 2020 7365      #         se
+00018390: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
+000183a0: 696d 756c 7573 5f69 643a 2073 7472 2c20  imulus_id: str, 
+000183b0: 2a2a 6b77 6172 6773 0a20 2020 2023 2020  **kwargs.    #  
+000183c0: 2020 2029 202d 3e20 2872 6563 6f6d 6d65     ) -> (recomme
+000183d0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+000183e0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+000183f0: 6773 290a 2020 2020 2320 7d0a 2020 2020  gs).    # }.    
+00018400: 5f54 5241 4e53 4954 494f 4e53 5f54 4142  _TRANSITIONS_TAB
+00018410: 4c45 3a20 436c 6173 7356 6172 5b0a 2020  LE: ClassVar[.  
+00018420: 2020 2020 2020 4d61 7070 696e 675b 0a20        Mapping[. 
+00018430: 2020 2020 2020 2020 2020 2074 7570 6c65             tuple
+00018440: 5b54 6173 6b53 7461 7465 5374 6174 652c  [TaskStateState,
+00018450: 2054 6173 6b53 7461 7465 5374 6174 655d   TaskStateState]
+00018460: 2c0a 2020 2020 2020 2020 2020 2020 4361  ,.            Ca
+00018470: 6c6c 6162 6c65 5b2e 2e2e 2c20 5265 6373  llable[..., Recs
+00018480: 4d73 6773 5d2c 0a20 2020 2020 2020 205d  Msgs],.        ]
+00018490: 0a20 2020 205d 203d 207b 0a20 2020 2020  .    ] = {.     
+000184a0: 2020 2028 2272 656c 6561 7365 6422 2c20     ("released", 
+000184b0: 2277 6169 7469 6e67 2229 3a20 7472 616e  "waiting"): tran
+000184c0: 7369 7469 6f6e 5f72 656c 6561 7365 645f  sition_released_
+000184d0: 7761 6974 696e 672c 0a20 2020 2020 2020  waiting,.       
+000184e0: 2028 2277 6169 7469 6e67 222c 2022 7265   ("waiting", "re
+000184f0: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
+00018500: 7469 6f6e 5f77 6169 7469 6e67 5f72 656c  tion_waiting_rel
+00018510: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
+00018520: 2277 6169 7469 6e67 222c 2022 7072 6f63  "waiting", "proc
+00018530: 6573 7369 6e67 2229 3a20 7472 616e 7369  essing"): transi
+00018540: 7469 6f6e 5f77 6169 7469 6e67 5f70 726f  tion_waiting_pro
+00018550: 6365 7373 696e 672c 0a20 2020 2020 2020  cessing,.       
+00018560: 2028 2277 6169 7469 6e67 222c 2022 6e6f   ("waiting", "no
+00018570: 2d77 6f72 6b65 7222 293a 2074 7261 6e73  -worker"): trans
+00018580: 6974 696f 6e5f 7761 6974 696e 675f 6e6f  ition_waiting_no
+00018590: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
+000185a0: 2028 2277 6169 7469 6e67 222c 2022 7175   ("waiting", "qu
+000185b0: 6575 6564 2229 3a20 7472 616e 7369 7469  eued"): transiti
+000185c0: 6f6e 5f77 6169 7469 6e67 5f71 7565 7565  on_waiting_queue
+000185d0: 642c 0a20 2020 2020 2020 2028 2277 6169  d,.        ("wai
+000185e0: 7469 6e67 222c 2022 6d65 6d6f 7279 2229  ting", "memory")
+000185f0: 3a20 7472 616e 7369 7469 6f6e 5f77 6169  : transition_wai
+00018600: 7469 6e67 5f6d 656d 6f72 792c 0a20 2020  ting_memory,.   
+00018610: 2020 2020 2028 2271 7565 7565 6422 2c20       ("queued", 
+00018620: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
+00018630: 6e73 6974 696f 6e5f 7175 6575 6564 5f72  nsition_queued_r
+00018640: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
+00018650: 2028 2271 7565 7565 6422 2c20 2270 726f   ("queued", "pro
+00018660: 6365 7373 696e 6722 293a 2074 7261 6e73  cessing"): trans
+00018670: 6974 696f 6e5f 7175 6575 6564 5f70 726f  ition_queued_pro
+00018680: 6365 7373 696e 672c 0a20 2020 2020 2020  cessing,.       
+00018690: 2028 2270 726f 6365 7373 696e 6722 2c20   ("processing", 
+000186a0: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
+000186b0: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
+000186c0: 6e67 5f72 656c 6561 7365 642c 0a20 2020  ng_released,.   
+000186d0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
+000186e0: 6722 2c20 226d 656d 6f72 7922 293a 2074  g", "memory"): t
+000186f0: 7261 6e73 6974 696f 6e5f 7072 6f63 6573  ransition_proces
+00018700: 7369 6e67 5f6d 656d 6f72 792c 0a20 2020  sing_memory,.   
+00018710: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
+00018720: 6722 2c20 2265 7272 6564 2229 3a20 7472  g", "erred"): tr
+00018730: 616e 7369 7469 6f6e 5f70 726f 6365 7373  ansition_process
+00018740: 696e 675f 6572 7265 642c 0a20 2020 2020  ing_erred,.     
+00018750: 2020 2028 226e 6f2d 776f 726b 6572 222c     ("no-worker",
+00018760: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
+00018770: 616e 7369 7469 6f6e 5f6e 6f5f 776f 726b  ansition_no_work
+00018780: 6572 5f72 656c 6561 7365 642c 0a20 2020  er_released,.   
+00018790: 2020 2020 2028 226e 6f2d 776f 726b 6572       ("no-worker
+000187a0: 222c 2022 7072 6f63 6573 7369 6e67 2229  ", "processing")
+000187b0: 3a20 7472 616e 7369 7469 6f6e 5f6e 6f5f  : transition_no_
+000187c0: 776f 726b 6572 5f70 726f 6365 7373 696e  worker_processin
+000187d0: 672c 0a20 2020 2020 2020 2028 2272 656c  g,.        ("rel
+000187e0: 6561 7365 6422 2c20 2266 6f72 676f 7474  eased", "forgott
+000187f0: 656e 2229 3a20 7472 616e 7369 7469 6f6e  en"): transition
+00018800: 5f72 656c 6561 7365 645f 666f 7267 6f74  _released_forgot
+00018810: 7465 6e2c 0a20 2020 2020 2020 2028 226d  ten,.        ("m
+00018820: 656d 6f72 7922 2c20 2266 6f72 676f 7474  emory", "forgott
+00018830: 656e 2229 3a20 7472 616e 7369 7469 6f6e  en"): transition
+00018840: 5f6d 656d 6f72 795f 666f 7267 6f74 7465  _memory_forgotte
+00018850: 6e2c 0a20 2020 2020 2020 2028 2265 7272  n,.        ("err
+00018860: 6564 222c 2022 7265 6c65 6173 6564 2229  ed", "released")
+00018870: 3a20 7472 616e 7369 7469 6f6e 5f65 7272  : transition_err
+00018880: 6564 5f72 656c 6561 7365 642c 0a20 2020  ed_released,.   
+00018890: 2020 2020 2028 226d 656d 6f72 7922 2c20       ("memory", 
+000188a0: 2272 656c 6561 7365 6422 293a 2074 7261  "released"): tra
+000188b0: 6e73 6974 696f 6e5f 6d65 6d6f 7279 5f72  nsition_memory_r
+000188c0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
+000188d0: 2028 2272 656c 6561 7365 6422 2c20 2265   ("released", "e
+000188e0: 7272 6564 2229 3a20 7472 616e 7369 7469  rred"): transiti
+000188f0: 6f6e 5f72 656c 6561 7365 645f 6572 7265  on_released_erre
+00018900: 642c 0a20 2020 207d 0a0a 2020 2020 6465  d,.    }..    de
+00018910: 6620 7374 6f72 7928 7365 6c66 2c20 2a6b  f story(self, *k
+00018920: 6579 735f 6f72 5f74 6173 6b73 5f6f 725f  eys_or_tasks_or_
+00018930: 7374 696d 756c 693a 2073 7472 207c 2054  stimuli: str | T
+00018940: 6173 6b53 7461 7465 2920 2d3e 206c 6973  askState) -> lis
+00018950: 745b 5472 616e 7369 7469 6f6e 5d3a 0a20  t[Transition]:. 
+00018960: 2020 2020 2020 2022 2222 4765 7420 616c         """Get al
+00018970: 6c20 7472 616e 7369 7469 6f6e 7320 7468  l transitions th
+00018980: 6174 2074 6f75 6368 206f 6e65 206f 6620  at touch one of 
+00018990: 7468 6520 696e 7075 7420 6b65 7973 206f  the input keys o
+000189a0: 7220 7374 696d 756c 7573 5f69 6427 7322  r stimulus_id's"
+000189b0: 2222 0a20 2020 2020 2020 206b 6579 735f  "".        keys_
+000189c0: 6f72 5f73 7469 6d75 6c69 203d 207b 0a20  or_stimuli = {. 
+000189d0: 2020 2020 2020 2020 2020 206b 6579 2e6b             key.k
+000189e0: 6579 2069 6620 6973 696e 7374 616e 6365  ey if isinstance
+000189f0: 286b 6579 2c20 5461 736b 5374 6174 6529  (key, TaskState)
+00018a00: 2065 6c73 6520 6b65 790a 2020 2020 2020   else key.      
+00018a10: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00018a20: 206b 6579 735f 6f72 5f74 6173 6b73 5f6f   keys_or_tasks_o
+00018a30: 725f 7374 696d 756c 690a 2020 2020 2020  r_stimuli.      
+00018a40: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
+00018a50: 726e 2073 6368 6564 756c 6572 5f73 746f  rn scheduler_sto
+00018a60: 7279 286b 6579 735f 6f72 5f73 7469 6d75  ry(keys_or_stimu
+00018a70: 6c69 2c20 7365 6c66 2e74 7261 6e73 6974  li, self.transit
+00018a80: 696f 6e5f 6c6f 6729 0a0a 2020 2020 2323  ion_log)..    ##
+00018a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018aa0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00018ab0: 2023 2041 7373 6967 6e69 6e67 2054 6173   # Assigning Tas
+00018ac0: 6b73 2074 6f20 576f 726b 6572 7320 230a  ks to Workers #.
+00018ad0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00018ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018af0: 2323 0a0a 2020 2020 6465 6620 6973 5f72  ##..    def is_r
+00018b00: 6f6f 7469 7368 2873 656c 662c 2074 733a  ootish(self, ts:
+00018b10: 2054 6173 6b53 7461 7465 2920 2d3e 2062   TaskState) -> b
+00018b20: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+00018b30: 0a20 2020 2020 2020 2057 6865 7468 6572  .        Whether
+00018b40: 2060 6074 7360 6020 6973 2061 2072 6f6f   ``ts`` is a roo
+00018b50: 7420 6f72 2072 6f6f 742d 6c69 6b65 2074  t or root-like t
+00018b60: 6173 6b2e 0a0a 2020 2020 2020 2020 526f  ask...        Ro
+00018b70: 6f74 2d69 7368 2074 6173 6b73 2061 7265  ot-ish tasks are
+00018b80: 2070 6172 7420 6f66 2061 2067 726f 7570   part of a group
+00018b90: 2074 6861 7427 7320 6d75 6368 206c 6172   that's much lar
+00018ba0: 6765 7220 7468 616e 2074 6865 2063 6c75  ger than the clu
+00018bb0: 7374 6572 2c0a 2020 2020 2020 2020 616e  ster,.        an
+00018bc0: 6420 6861 7665 2066 6577 206f 7220 6e6f  d have few or no
+00018bd0: 2064 6570 656e 6465 6e63 6965 732e 0a20   dependencies.. 
+00018be0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00018bf0: 2020 2069 6620 7473 2e72 6573 6f75 7263     if ts.resourc
+00018c00: 655f 7265 7374 7269 6374 696f 6e73 206f  e_restrictions o
+00018c10: 7220 7473 2e77 6f72 6b65 725f 7265 7374  r ts.worker_rest
+00018c20: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
+00018c30: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+00018c40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00018c50: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+00018c60: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
+00018c70: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
+00018c80: 7368 6f72 742d 6369 7263 7569 7420 746f  short-circuit to
+00018c90: 2054 7275 6520 6966 2060 6e6f 7420 7473   True if `not ts
+00018ca0: 2e64 6570 656e 6465 6e63 6965 7360 3f0a  .dependencies`?.
+00018cb0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00018cc0: 0a20 2020 2020 2020 2020 2020 206c 656e  .            len
+00018cd0: 2874 6729 203e 2073 656c 662e 746f 7461  (tg) > self.tota
+00018ce0: 6c5f 6e74 6872 6561 6473 202a 2032 0a20  l_nthreads * 2. 
+00018cf0: 2020 2020 2020 2020 2020 2061 6e64 206c             and l
+00018d00: 656e 2874 672e 6465 7065 6e64 656e 6369  en(tg.dependenci
+00018d10: 6573 2920 3c20 350a 2020 2020 2020 2020  es) < 5.        
+00018d20: 2020 2020 616e 6420 7375 6d28 6d61 7028      and sum(map(
+00018d30: 6c65 6e2c 2074 672e 6465 7065 6e64 656e  len, tg.dependen
+00018d40: 6369 6573 2929 203c 2035 0a20 2020 2020  cies)) < 5.     
+00018d50: 2020 2029 0a0a 2020 2020 6465 6620 6368     )..    def ch
+00018d60: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
+00018d70: 6564 2873 656c 662c 2077 733a 2057 6f72  ed(self, ws: Wor
+00018d80: 6b65 7253 7461 7465 2c20 6f63 633a 2066  kerState, occ: f
+00018d90: 6c6f 6174 203d 202d 312e 3029 202d 3e20  loat = -1.0) -> 
+00018da0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00018db0: 2255 7064 6174 6520 7468 6520 7374 6174  "Update the stat
+00018dc0: 7573 206f 6620 7468 6520 6964 6c65 2061  us of the idle a
+00018dd0: 6e64 2073 6174 7572 6174 6564 2073 7461  nd saturated sta
+00018de0: 7465 0a0a 2020 2020 2020 2020 5468 6520  te..        The 
+00018df0: 7363 6865 6475 6c65 7220 6b65 6570 7320  scheduler keeps 
+00018e00: 7472 6163 6b20 6f66 2077 6f72 6b65 7273  track of workers
+00018e10: 2074 6861 7420 6172 6520 2e2e 0a0a 2020   that are ....  
+00018e20: 2020 2020 2020 2d20 2053 6174 7572 6174        -  Saturat
+00018e30: 6564 3a20 6861 7665 2065 6e6f 7567 6820  ed: have enough 
+00018e40: 776f 726b 2074 6f20 7374 6179 2062 7573  work to stay bus
+00018e50: 790a 2020 2020 2020 2020 2d20 2049 646c  y.        -  Idl
+00018e60: 653a 2064 6f20 6e6f 7420 6861 7665 2065  e: do not have e
+00018e70: 6e6f 7567 6820 776f 726b 2074 6f20 7374  nough work to st
+00018e80: 6179 2062 7573 790a 0a20 2020 2020 2020  ay busy..       
+00018e90: 2054 6865 7920 6172 6520 636f 6e73 6964   They are consid
+00018ea0: 6572 6564 2073 6174 7572 6174 6564 2069  ered saturated i
+00018eb0: 6620 7468 6579 2062 6f74 6820 6861 7665  f they both have
+00018ec0: 2065 6e6f 7567 6820 7461 736b 7320 746f   enough tasks to
+00018ed0: 206f 6363 7570 790a 2020 2020 2020 2020   occupy.        
+00018ee0: 616c 6c20 6f66 2074 6865 6972 2074 6872  all of their thr
+00018ef0: 6561 6473 2c20 616e 6420 6966 2074 6865  eads, and if the
+00018f00: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
+00018f10: 6520 6f66 2074 686f 7365 2074 6173 6b73  e of those tasks
+00018f20: 2069 730a 2020 2020 2020 2020 6c61 7267   is.        larg
+00018f30: 6520 656e 6f75 6768 2e0a 0a20 2020 2020  e enough...     
+00018f40: 2020 2049 6620 6060 6469 7374 7269 6275     If ``distribu
+00018f50: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
+00018f60: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
+00018f70: 6020 6973 206e 6f74 2060 6069 6e66 6060  ` is not ``inf``
+00018f80: 0a20 2020 2020 2020 2028 7363 6865 6475  .        (schedu
+00018f90: 6c65 722d 7369 6465 2071 7565 7569 6e67  ler-side queuing
+00018fa0: 2069 7320 656e 6162 6c65 6429 2c20 7468   is enabled), th
+00018fb0: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
+00018fc0: 6420 6964 6c65 0a20 2020 2020 2020 2069  d idle.        i
+00018fd0: 6620 7468 6579 2068 6176 6520 6665 7765  f they have fewe
+00018fe0: 7220 7461 736b 7320 7072 6f63 6573 7369  r tasks processi
+00018ff0: 6e67 2074 6861 6e20 7468 6520 6060 776f  ng than the ``wo
+00019000: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
+00019010: 600a 2020 2020 2020 2020 7468 7265 7368  `.        thresh
+00019020: 6f6c 6420 6469 6374 6174 6573 2e0a 0a20  old dictates... 
+00019030: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
+00019040: 2c20 7468 6579 2061 7265 2063 6f6e 7369  , they are consi
+00019050: 6465 7265 6420 6964 6c65 2069 6620 7468  dered idle if th
+00019060: 6579 2068 6176 6520 6665 7765 7220 7461  ey have fewer ta
+00019070: 736b 7320 7072 6f63 6573 7369 6e67 0a20  sks processing. 
+00019080: 2020 2020 2020 2074 6861 6e20 7468 7265         than thre
+00019090: 6164 732c 206f 7220 6966 2074 6865 6972  ads, or if their
+000190a0: 2074 6173 6b73 2720 746f 7461 6c20 6578   tasks' total ex
+000190b0: 7065 6374 6564 2072 756e 7469 6d65 2069  pected runtime i
+000190c0: 7320 6c65 7373 2074 6861 6e20 6861 6c66  s less than half
+000190d0: 0a20 2020 2020 2020 2074 6865 2065 7870  .        the exp
+000190e0: 6563 7465 6420 7275 6e74 696d 6520 6f66  ected runtime of
+000190f0: 2074 6865 2073 616d 6520 6e75 6d62 6572   the same number
+00019100: 206f 6620 6176 6572 6167 6520 7461 736b   of average task
+00019110: 732e 0a0a 2020 2020 2020 2020 5468 6973  s...        This
+00019120: 2069 7320 7573 6566 756c 2066 6f72 206c   is useful for l
+00019130: 6f61 6420 6261 6c61 6e63 696e 6720 616e  oad balancing an
+00019140: 6420 6164 6170 7469 7669 7479 2e0a 2020  d adaptivity..  
+00019150: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00019160: 2020 6966 2073 656c 662e 746f 7461 6c5f    if self.total_
+00019170: 6e74 6872 6561 6473 203d 3d20 3020 6f72  nthreads == 0 or
+00019180: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
+00019190: 6174 7573 2e63 6c6f 7365 643a 0a20 2020  atus.closed:.   
+000191a0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000191b0: 2020 2020 2020 2020 6966 206f 6363 203c          if occ <
+000191c0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000191d0: 6f63 6320 3d20 7773 2e6f 6363 7570 616e  occ = ws.occupan
+000191e0: 6379 0a0a 2020 2020 2020 2020 7020 3d20  cy..        p = 
+000191f0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
+00019200: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
+00019210: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
+00019220: 7264 2877 7329 0a20 2020 2020 2020 2069  rd(ws).        i
+00019230: 6620 7773 2e73 7461 7475 7320 213d 2053  f ws.status != S
+00019240: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00019250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019260: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
+00019270: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
+00019280: 2020 2065 6c69 6620 7365 6c66 2e69 735f     elif self.is_
+00019290: 756e 6f63 6375 7069 6564 2877 732c 206f  unoccupied(ws, o
+000192a0: 6363 2c20 7029 3a0a 2020 2020 2020 2020  cc, p):.        
+000192b0: 2020 2020 7365 6c66 2e69 646c 655b 7773      self.idle[ws
+000192c0: 2e61 6464 7265 7373 5d20 3d20 7773 0a20  .address] = ws. 
+000192d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000192e0: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
+000192f0: 6c65 2e70 6f70 2877 732e 6164 6472 6573  le.pop(ws.addres
+00019300: 732c 204e 6f6e 6529 0a20 2020 2020 2020  s, None).       
+00019310: 2020 2020 206e 6320 3d20 7773 2e6e 7468       nc = ws.nth
+00019320: 7265 6164 730a 2020 2020 2020 2020 2020  reads.          
+00019330: 2020 6966 2070 203e 206e 633a 0a20 2020    if p > nc:.   
+00019340: 2020 2020 2020 2020 2020 2020 2070 656e               pen
+00019350: 6469 6e67 203d 206f 6363 202a 2028 7020  ding = occ * (p 
+00019360: 2d20 6e63 2920 2f20 2870 202a 206e 6329  - nc) / (p * nc)
+00019370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019380: 2069 6620 302e 3420 3c20 7065 6e64 696e   if 0.4 < pendin
+00019390: 6720 3e20 312e 3920 2a20 2873 656c 662e  g > 1.9 * (self.
+000193a0: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
+000193b0: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
+000193c0: 7265 6164 7329 3a0a 2020 2020 2020 2020  reads):.        
+000193d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000193e0: 2e73 6174 7572 6174 6564 2e61 6464 2877  .saturated.add(w
+000193f0: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
+00019400: 6f74 205f 776f 726b 6572 5f66 756c 6c28  ot _worker_full(
+00019410: 7773 2c20 7365 6c66 2e57 4f52 4b45 525f  ws, self.WORKER_
+00019420: 5341 5455 5241 5449 4f4e 2920 616e 6420  SATURATION) and 
+00019430: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+00019440: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+00019450: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
+00019460: 6c65 5f74 6173 6b5f 636f 756e 742e 6164  le_task_count.ad
+00019470: 6428 7773 290a 2020 2020 2020 2020 656c  d(ws).        el
+00019480: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019490: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
+000194a0: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
+000194b0: 0a0a 2020 2020 6465 6620 6973 5f75 6e6f  ..    def is_uno
+000194c0: 6363 7570 6965 6428 0a20 2020 2020 2020  ccupied(.       
+000194d0: 2073 656c 662c 2077 733a 2057 6f72 6b65   self, ws: Worke
+000194e0: 7253 7461 7465 2c20 6f63 6375 7061 6e63  rState, occupanc
+000194f0: 793a 2066 6c6f 6174 2c20 6e70 726f 6365  y: float, nproce
+00019500: 7373 696e 673a 2069 6e74 0a20 2020 2029  ssing: int.    )
+00019510: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00019520: 2020 6e74 6872 6561 6473 203d 2077 732e    nthreads = ws.
+00019530: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+00019540: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
+00019550: 2020 2020 2020 6e70 726f 6365 7373 696e        nprocessin
+00019560: 6720 3c20 6e74 6872 6561 6473 0a20 2020  g < nthreads.   
+00019570: 2020 2020 2020 2020 206f 7220 6f63 6375           or occu
+00019580: 7061 6e63 7920 3c20 6e74 6872 6561 6473  pancy < nthreads
+00019590: 202a 2028 7365 6c66 2e74 6f74 616c 5f6f   * (self.total_o
+000195a0: 6363 7570 616e 6379 202f 2073 656c 662e  ccupancy / self.
+000195b0: 746f 7461 6c5f 6e74 6872 6561 6473 2920  total_nthreads) 
+000195c0: 2f20 320a 2020 2020 2020 2020 290a 0a20  / 2.        ).. 
+000195d0: 2020 2064 6566 2067 6574 5f63 6f6d 6d5f     def get_comm_
+000195e0: 636f 7374 2873 656c 662c 2074 733a 2054  cost(self, ts: T
+000195f0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
+00019600: 726b 6572 5374 6174 6529 202d 3e20 666c  rkerState) -> fl
+00019610: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
+00019620: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
+00019630: 2065 7374 696d 6174 6564 2063 6f6d 6d75   estimated commu
+00019640: 6e69 6361 7469 6f6e 2063 6f73 7420 2869  nication cost (i
+00019650: 6e20 732e 2920 746f 2063 6f6d 7075 7465  n s.) to compute
+00019660: 2074 6865 2074 6173 6b0a 2020 2020 2020   the task.      
+00019670: 2020 6f6e 2074 6865 2067 6976 656e 2077    on the given w
+00019680: 6f72 6b65 722e 0a20 2020 2020 2020 2022  orker..        "
+00019690: 2222 0a20 2020 2020 2020 2069 6620 3130  "".        if 10
+000196a0: 202a 206c 656e 2874 732e 6465 7065 6e64   * len(ts.depend
+000196b0: 656e 6369 6573 2920 3c20 6c65 6e28 7773  encies) < len(ws
+000196c0: 2e68 6173 5f77 6861 7429 3a0a 2020 2020  .has_what):.    
+000196d0: 2020 2020 2020 2020 2320 496e 2074 6865          # In the
+000196e0: 2063 6f6d 6d6f 6e20 6361 7365 2077 6865   common case whe
+000196f0: 7265 2074 6865 206e 756d 6265 7220 6f66  re the number of
+00019700: 2064 6570 656e 6465 6e63 6965 7320 6973   dependencies is
+00019710: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+00019720: 7563 6820 6c65 7373 2074 6861 6e20 7468  uch less than th
+00019730: 6520 6e75 6d62 6572 206f 6620 7461 736b  e number of task
+00019740: 7320 7468 6174 2077 6520 6861 7665 2c0a  s that we have,.
+00019750: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+00019760: 6e73 7472 7563 7420 7468 6520 7365 7420  nstruct the set 
+00019770: 6f66 2064 6570 7320 7468 6174 2072 6571  of deps that req
+00019780: 7569 7265 2063 6f6d 6d75 6e69 6361 7469  uire communicati
+00019790: 6f6e 2069 6e0a 2020 2020 2020 2020 2020  on in.          
+000197a0: 2020 2320 4f28 6c65 6e28 6465 7065 6e64    # O(len(depend
+000197b0: 656e 6369 6573 2929 2072 6174 6865 7220  encies)) rather 
+000197c0: 7468 616e 204f 286c 656e 2868 6173 5f77  than O(len(has_w
+000197d0: 6861 7429 2920 7469 6d65 2e0a 2020 2020  hat)) time..    
+000197e0: 2020 2020 2020 2020 2320 4661 6374 6f72          # Factor
+000197f0: 206f 6620 3130 2069 7320 6120 6775 6573   of 10 is a gues
+00019800: 7320 6174 2074 6865 206f 7665 7268 6561  s at the overhea
+00019810: 6420 6f66 2065 7870 6c69 6369 740a 2020  d of explicit.  
+00019820: 2020 2020 2020 2020 2020 2320 6974 6572            # iter
+00019830: 6174 696f 6e20 6173 206f 7070 6f73 6564  ation as opposed
+00019840: 2074 6f20 6a75 7374 2063 616c 6c69 6e67   to just calling
+00019850: 2073 6574 2e64 6966 6665 7265 6e63 650a   set.difference.
+00019860: 2020 2020 2020 2020 2020 2020 6465 7073              deps
+00019870: 203d 207b 6465 7020 666f 7220 6465 7020   = {dep for dep 
+00019880: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+00019890: 6573 2069 6620 6465 7020 6e6f 7420 696e  es if dep not in
+000198a0: 2077 732e 6861 735f 7768 6174 7d0a 2020   ws.has_what}.  
+000198b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000198c0: 2020 2020 2020 2020 6465 7073 203d 2074          deps = t
+000198d0: 732e 6465 7065 6e64 656e 6369 6573 2e64  s.dependencies.d
+000198e0: 6966 6665 7265 6e63 6528 7773 2e68 6173  ifference(ws.has
+000198f0: 5f77 6861 7429 0a20 2020 2020 2020 206e  _what).        n
+00019900: 6279 7465 7320 3d20 7375 6d28 6474 732e  bytes = sum(dts.
+00019910: 6e62 7974 6573 2066 6f72 2064 7473 2069  nbytes for dts i
+00019920: 6e20 6465 7073 290a 2020 2020 2020 2020  n deps).        
+00019930: 7265 7475 726e 206e 6279 7465 7320 2f20  return nbytes / 
+00019940: 7365 6c66 2e62 616e 6477 6964 7468 0a0a  self.bandwidth..
+00019950: 2020 2020 6465 6620 6765 745f 7461 736b      def get_task
+00019960: 5f64 7572 6174 696f 6e28 7365 6c66 2c20  _duration(self, 
+00019970: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+00019980: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+00019990: 2022 2222 4765 7420 7468 6520 6573 7469   """Get the esti
+000199a0: 6d61 7465 6420 636f 6d70 7574 6174 696f  mated computatio
+000199b0: 6e20 636f 7374 206f 6620 7468 6520 6769  n cost of the gi
+000199c0: 7665 6e20 7461 736b 2028 6e6f 7420 696e  ven task (not in
+000199d0: 636c 7564 696e 670a 2020 2020 2020 2020  cluding.        
+000199e0: 616e 7920 636f 6d6d 756e 6963 6174 696f  any communicatio
+000199f0: 6e20 636f 7374 292e 0a0a 2020 2020 2020  n cost)...      
+00019a00: 2020 4966 206e 6f20 6461 7461 2068 6173    If no data has
+00019a10: 2062 6565 6e20 6f62 7365 7276 6564 2c20   been observed, 
+00019a20: 7661 6c75 6520 6f66 0a20 2020 2020 2020  value of.       
+00019a30: 2060 6469 7374 7269 6275 7465 642e 7363   `distributed.sc
+00019a40: 6865 6475 6c65 722e 6465 6661 756c 742d  heduler.default-
+00019a50: 7461 736b 2d64 7572 6174 696f 6e73 6020  task-durations` 
+00019a60: 6172 6520 7573 6564 2e20 4966 206e 6f6e  are used. If non
+00019a70: 6520 6973 2073 6574 0a20 2020 2020 2020  e is set.       
+00019a80: 2066 6f72 2074 6869 7320 7461 736b 2c20   for this task, 
+00019a90: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
+00019aa0: 6564 756c 6572 2e75 6e6b 6e6f 776e 2d74  eduler.unknown-t
+00019ab0: 6173 6b2d 6475 7261 7469 6f6e 6020 6973  ask-duration` is
+00019ac0: 2075 7365 640a 2020 2020 2020 2020 696e   used.        in
+00019ad0: 7374 6561 642e 0a20 2020 2020 2020 2022  stead..        "
+00019ae0: 2222 0a20 2020 2020 2020 2064 7572 6174  "".        durat
+00019af0: 696f 6e3a 2066 6c6f 6174 203d 2074 732e  ion: float = ts.
+00019b00: 7072 6566 6978 2e64 7572 6174 696f 6e5f  prefix.duration_
+00019b10: 6176 6572 6167 650a 2020 2020 2020 2020  average.        
+00019b20: 6966 2064 7572 6174 696f 6e20 3e3d 2030  if duration >= 0
+00019b30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00019b40: 7475 726e 2064 7572 6174 696f 6e0a 0a20  turn duration.. 
+00019b50: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
+00019b60: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
+00019b70: 732e 6765 7428 7473 2e70 7265 6669 782e  s.get(ts.prefix.
+00019b80: 6e61 6d65 290a 2020 2020 2020 2020 6966  name).        if
+00019b90: 2073 2069 7320 4e6f 6e65 3a0a 2020 2020   s is None:.    
+00019ba0: 2020 2020 2020 2020 7365 6c66 2e75 6e6b          self.unk
+00019bb0: 6e6f 776e 5f64 7572 6174 696f 6e73 5b74  nown_durations[t
+00019bc0: 732e 7072 6566 6978 2e6e 616d 655d 203d  s.prefix.name] =
+00019bd0: 2073 203d 2073 6574 2829 0a20 2020 2020   s = set().     
+00019be0: 2020 2073 2e61 6464 2874 7329 0a20 2020     s.add(ts).   
+00019bf0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00019c00: 2e55 4e4b 4e4f 574e 5f54 4153 4b5f 4455  .UNKNOWN_TASK_DU
+00019c10: 5241 5449 4f4e 0a0a 2020 2020 6465 6620  RATION..    def 
+00019c20: 7661 6c69 645f 776f 726b 6572 7328 7365  valid_workers(se
+00019c30: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+00019c40: 6529 202d 3e20 7365 745b 576f 726b 6572  e) -> set[Worker
+00019c50: 5374 6174 655d 207c 204e 6f6e 653a 0a20  State] | None:. 
+00019c60: 2020 2020 2020 2022 2222 5265 7475 726e         """Return
+00019c70: 2073 6574 206f 6620 6375 7272 656e 746c   set of currentl
+00019c80: 7920 7661 6c69 6420 776f 726b 6572 7320  y valid workers 
+00019c90: 666f 7220 6b65 790a 0a20 2020 2020 2020  for key..       
+00019ca0: 2049 6620 616c 6c20 776f 726b 6572 7320   If all workers 
+00019cb0: 6172 6520 7661 6c69 6420 7468 656e 2074  are valid then t
+00019cc0: 6869 7320 7265 7475 726e 7320 6060 4e6f  his returns ``No
+00019cd0: 6e65 6060 2c20 696e 2077 6869 6368 2063  ne``, in which c
+00019ce0: 6173 650a 2020 2020 2020 2020 616e 7920  ase.        any 
+00019cf0: 2a72 756e 6e69 6e67 2a20 776f 726b 6572  *running* worker
+00019d00: 2063 616e 2062 6520 7573 6564 2e0a 2020   can be used..  
+00019d10: 2020 2020 2020 4f74 6865 7277 6973 652c        Otherwise,
+00019d20: 2074 6865 2073 7562 7365 7420 6f66 2072   the subset of r
+00019d30: 756e 6e69 6e67 2077 6f72 6b65 7273 2076  unning workers v
+00019d40: 616c 6964 2066 6f72 2074 6869 7320 7461  alid for this ta
+00019d50: 736b 0a20 2020 2020 2020 2069 7320 7265  sk.        is re
+00019d60: 7475 726e 6564 2e0a 2020 2020 2020 2020  turned..        
+00019d70: 5468 6973 2063 6865 636b 7320 7472 6163  This checks trac
+00019d80: 6b73 2074 6865 2066 6f6c 6c6f 7769 6e67  ks the following
+00019d90: 2073 7461 7465 3a0a 0a20 2020 2020 2020   state:..       
+00019da0: 202a 2020 776f 726b 6572 5f72 6573 7472   *  worker_restr
+00019db0: 6963 7469 6f6e 730a 2020 2020 2020 2020  ictions.        
+00019dc0: 2a20 2068 6f73 745f 7265 7374 7269 6374  *  host_restrict
+00019dd0: 696f 6e73 0a20 2020 2020 2020 202a 2020  ions.        *  
+00019de0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+00019df0: 7469 6f6e 730a 2020 2020 2020 2020 2222  tions.        ""
+00019e00: 220a 2020 2020 2020 2020 733a 2073 6574  ".        s: set
+00019e10: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
+00019e20: 6f6e 650a 0a20 2020 2020 2020 2069 6620  one..        if 
+00019e30: 7473 2e77 6f72 6b65 725f 7265 7374 7269  ts.worker_restri
+00019e40: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+00019e50: 2020 2020 7320 3d20 7b61 6464 7220 666f      s = {addr fo
+00019e60: 7220 6164 6472 2069 6e20 7473 2e77 6f72  r addr in ts.wor
+00019e70: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+00019e80: 2069 6620 6164 6472 2069 6e20 7365 6c66   if addr in self
+00019e90: 2e77 6f72 6b65 7273 7d0a 0a20 2020 2020  .workers}..     
+00019ea0: 2020 2069 6620 7473 2e68 6f73 745f 7265     if ts.host_re
+00019eb0: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
+00019ec0: 2020 2020 2020 2020 2320 5265 736f 6c76          # Resolv
+00019ed0: 6520 7468 6520 616c 6961 7320 6865 7265  e the alias here
+00019ee0: 2072 6174 6865 7220 7468 616e 2065 6172   rather than ear
+00019ef0: 6c79 2c20 666f 7220 7468 6520 776f 726b  ly, for the work
+00019f00: 6572 0a20 2020 2020 2020 2020 2020 2023  er.            #
+00019f10: 206d 6179 206e 6f74 2062 6520 636f 6e6e   may not be conn
+00019f20: 6563 7465 6420 7768 656e 2068 6f73 745f  ected when host_
+00019f30: 7265 7374 7269 6374 696f 6e73 2069 7320  restrictions is 
+00019f40: 706f 7075 6c61 7465 640a 2020 2020 2020  populated.      
+00019f50: 2020 2020 2020 6872 203d 205b 7365 6c66        hr = [self
+00019f60: 2e63 6f65 7263 655f 686f 7374 6e61 6d65  .coerce_hostname
+00019f70: 2868 2920 666f 7220 6820 696e 2074 732e  (h) for h in ts.
+00019f80: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+00019f90: 735d 0a20 2020 2020 2020 2020 2020 2023  s].            #
+00019fa0: 2058 5858 206e 6565 6420 486f 7374 5374   XXX need HostSt
+00019fb0: 6174 653f 0a20 2020 2020 2020 2020 2020  ate?.           
+00019fc0: 2073 6c20 3d20 5b5d 0a20 2020 2020 2020   sl = [].       
+00019fd0: 2020 2020 2066 6f72 2068 2069 6e20 6872       for h in hr
+00019fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019ff0: 2020 6468 203d 2073 656c 662e 686f 7374    dh = self.host
+0001a000: 5f69 6e66 6f2e 6765 7428 6829 0a20 2020  _info.get(h).   
+0001a010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001a020: 6468 2069 7320 6e6f 7420 4e6f 6e65 3a0a  dh is not None:.
+0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a040: 2020 2020 736c 2e61 7070 656e 6428 6468      sl.append(dh
+0001a050: 5b22 6164 6472 6573 7365 7322 5d29 0a0a  ["addresses"])..
+0001a060: 2020 2020 2020 2020 2020 2020 7373 203d              ss =
+0001a070: 2073 6574 2e75 6e69 6f6e 282a 736c 2920   set.union(*sl) 
+0001a080: 6966 2073 6c20 656c 7365 2073 6574 2829  if sl else set()
+0001a090: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001a0a0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0001a0b0: 2020 2020 2020 2020 2020 2073 203d 2073             s = s
+0001a0c0: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
+0001a0d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001a0e0: 2020 2020 7320 7c3d 2073 730a 0a20 2020      s |= ss..   
+0001a0f0: 2020 2020 2069 6620 7473 2e72 6573 6f75       if ts.resou
+0001a100: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+0001a110: 3a0a 2020 2020 2020 2020 2020 2020 6477  :.            dw
+0001a120: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+0001a130: 2020 666f 7220 7265 736f 7572 6365 2c20    for resource, 
+0001a140: 7265 7175 6972 6564 2069 6e20 7473 2e72  required in ts.r
+0001a150: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+0001a160: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
+0001a170: 2020 2020 2020 2020 2020 2020 2020 6472                dr
+0001a180: 203d 2073 656c 662e 7265 736f 7572 6365   = self.resource
+0001a190: 732e 6765 7428 7265 736f 7572 6365 290a  s.get(resource).
+0001a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1b0: 6966 2064 7220 6973 204e 6f6e 653a 0a20  if dr is None:. 
+0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1d0: 2020 2073 656c 662e 7265 736f 7572 6365     self.resource
+0001a1e0: 735b 7265 736f 7572 6365 5d20 3d20 6472  s[resource] = dr
+0001a1f0: 203d 207b 7d0a 0a20 2020 2020 2020 2020   = {}..         
+0001a200: 2020 2020 2020 2073 7720 3d20 7365 7428         sw = set(
+0001a210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a220: 2020 666f 7220 6164 6472 2c20 7375 7070    for addr, supp
+0001a230: 6c69 6564 2069 6e20 6472 2e69 7465 6d73  lied in dr.items
+0001a240: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001a250: 2020 2020 2020 2020 6966 2073 7570 706c          if suppl
+0001a260: 6965 6420 3e3d 2072 6571 7569 7265 643a  ied >= required:
+0001a270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a280: 2020 2020 2020 2020 2073 772e 6164 6428           sw.add(
+0001a290: 6164 6472 290a 0a20 2020 2020 2020 2020  addr)..         
+0001a2a0: 2020 2020 2020 2064 775b 7265 736f 7572         dw[resour
+0001a2b0: 6365 5d20 3d20 7377 0a0a 2020 2020 2020  ce] = sw..      
+0001a2c0: 2020 2020 2020 7777 203d 2073 6574 2e69        ww = set.i
+0001a2d0: 6e74 6572 7365 6374 696f 6e28 2a64 772e  ntersection(*dw.
+0001a2e0: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
+0001a2f0: 2020 2020 2020 6966 2073 2069 7320 4e6f        if s is No
+0001a300: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0001a310: 2020 2020 7320 3d20 7777 0a20 2020 2020      s = ww.     
+0001a320: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001a330: 2020 2020 2020 2020 2020 2020 2073 2026               s &
+0001a340: 3d20 7777 0a0a 2020 2020 2020 2020 6966  = ww..        if
+0001a350: 2073 2069 7320 4e6f 6e65 3a0a 2020 2020   s is None:.    
+0001a360: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0001a370: 6f6e 6520 2023 2041 6c6c 2077 6f72 6b65  one  # All worke
+0001a380: 7273 2061 7265 2076 616c 6964 0a20 2020  rs are valid.   
+0001a390: 2020 2020 2069 6620 6e6f 7420 733a 0a20       if not s:. 
+0001a3a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a3b0: 6e20 7365 7428 2920 2023 204e 6f20 776f  n set()  # No wo
+0001a3c0: 726b 6572 7320 6172 6520 7661 6c69 640a  rkers are valid.
+0001a3d0: 0a20 2020 2020 2020 2023 2053 6f6d 6520  .        # Some 
+0001a3e0: 776f 726b 6572 7320 6172 6520 7661 6c69  workers are vali
+0001a3f0: 640a 2020 2020 2020 2020 735f 7773 203d  d.        s_ws =
+0001a400: 207b 7365 6c66 2e77 6f72 6b65 7273 5b61   {self.workers[a
+0001a410: 6464 725d 2066 6f72 2061 6464 7220 696e  ddr] for addr in
+0001a420: 2073 7d0a 2020 2020 2020 2020 6966 206c   s}.        if l
+0001a430: 656e 2873 656c 662e 7275 6e6e 696e 6729  en(self.running)
+0001a440: 203c 206c 656e 2873 656c 662e 776f 726b   < len(self.work
+0001a450: 6572 7329 3a0a 2020 2020 2020 2020 2020  ers):.          
+0001a460: 2020 735f 7773 2026 3d20 7365 6c66 2e72    s_ws &= self.r
+0001a470: 756e 6e69 6e67 0a20 2020 2020 2020 2072  unning.        r
+0001a480: 6574 7572 6e20 735f 7773 0a0a 2020 2020  eturn s_ws..    
+0001a490: 6465 6620 6163 7175 6972 655f 7265 736f  def acquire_reso
+0001a4a0: 7572 6365 7328 7365 6c66 2c20 7473 3a20  urces(self, ts: 
+0001a4b0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+0001a4c0: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
+0001a4d0: 6f6e 653a 0a20 2020 2020 2020 2066 6f72  one:.        for
+0001a4e0: 2072 2c20 7265 7175 6972 6564 2069 6e20   r, required in 
+0001a4f0: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
+0001a500: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
+0001a510: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+0001a520: 2e75 7365 645f 7265 736f 7572 6365 735b  .used_resources[
+0001a530: 725d 202b 3d20 7265 7175 6972 6564 0a0a  r] += required..
+0001a540: 2020 2020 6465 6620 7265 6c65 6173 655f      def release_
+0001a550: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
+0001a560: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
+0001a570: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+0001a580: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001a590: 2066 6f72 2072 2c20 7265 7175 6972 6564   for r, required
+0001a5a0: 2069 6e20 7473 2e72 6573 6f75 7263 655f   in ts.resource_
+0001a5b0: 7265 7374 7269 6374 696f 6e73 2e69 7465  restrictions.ite
+0001a5c0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0001a5d0: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
+0001a5e0: 6365 735b 725d 202d 3d20 7265 7175 6972  ces[r] -= requir
+0001a5f0: 6564 0a0a 2020 2020 6465 6620 636f 6572  ed..    def coer
+0001a600: 6365 5f68 6f73 746e 616d 6528 7365 6c66  ce_hostname(self
+0001a610: 2c20 686f 7374 3a20 4861 7368 6162 6c65  , host: Hashable
+0001a620: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+0001a630: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
+0001a640: 6572 6365 2074 6865 2068 6f73 746e 616d  erce the hostnam
+0001a650: 6520 6f66 2061 2077 6f72 6b65 722e 0a20  e of a worker.. 
+0001a660: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001a670: 2020 2061 6c69 6173 203d 2073 656c 662e     alias = self.
+0001a680: 616c 6961 7365 732e 6765 7428 686f 7374  aliases.get(host
+0001a690: 290a 2020 2020 2020 2020 6966 2061 6c69  ).        if ali
+0001a6a0: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
+0001a6b0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+0001a6c0: 2073 656c 662e 776f 726b 6572 735b 616c   self.workers[al
+0001a6d0: 6961 735d 0a20 2020 2020 2020 2020 2020  ias].           
+0001a6e0: 2072 6574 7572 6e20 7773 2e68 6f73 740a   return ws.host.
+0001a6f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001a700: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001a710: 2069 7369 6e73 7461 6e63 6528 686f 7374   isinstance(host
+0001a720: 2c20 7374 7229 0a20 2020 2020 2020 2020  , str).         
+0001a730: 2020 2072 6574 7572 6e20 686f 7374 0a0a     return host..
+0001a740: 2020 2020 6465 6620 776f 726b 6572 5f6f      def worker_o
+0001a750: 626a 6563 7469 7665 2873 656c 662c 2074  bjective(self, t
+0001a760: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
+0001a770: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
+0001a780: 3e20 7475 706c 653a 0a20 2020 2020 2020  > tuple:.       
+0001a790: 2022 2222 4f62 6a65 6374 6976 6520 6675   """Objective fu
+0001a7a0: 6e63 7469 6f6e 2074 6f20 6465 7465 726d  nction to determ
+0001a7b0: 696e 6520 7768 6963 6820 776f 726b 6572  ine which worker
+0001a7c0: 2073 686f 756c 6420 6765 7420 7468 6520   should get the 
+0001a7d0: 7461 736b 0a0a 2020 2020 2020 2020 4d69  task..        Mi
+0001a7e0: 6e69 6d69 7a65 2065 7870 6563 7465 6420  nimize expected 
+0001a7f0: 7374 6172 7420 7469 6d65 2e20 2049 6620  start time.  If 
+0001a800: 6120 7469 6520 7468 656e 2062 7265 616b  a tie then break
+0001a810: 2077 6974 6820 6461 7461 2073 746f 7261   with data stora
+0001a820: 6765 2e0a 2020 2020 2020 2020 2222 220a  ge..        """.
+0001a830: 2020 2020 2020 2020 636f 6d6d 5f62 7974          comm_byt
+0001a840: 6573 203d 2073 756d 280a 2020 2020 2020  es = sum(.      
+0001a850: 2020 2020 2020 6474 732e 6765 745f 6e62        dts.get_nb
+0001a860: 7974 6573 2829 2066 6f72 2064 7473 2069  ytes() for dts i
+0001a870: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0001a880: 7320 6966 2077 7320 6e6f 7420 696e 2064  s if ws not in d
+0001a890: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0001a8a0: 2020 2029 0a0a 2020 2020 2020 2020 7374     )..        st
+0001a8b0: 6163 6b5f 7469 6d65 203d 2077 732e 6f63  ack_time = ws.oc
+0001a8c0: 6375 7061 6e63 7920 2f20 7773 2e6e 7468  cupancy / ws.nth
+0001a8d0: 7265 6164 730a 2020 2020 2020 2020 7374  reads.        st
+0001a8e0: 6172 745f 7469 6d65 203d 2073 7461 636b  art_time = stack
+0001a8f0: 5f74 696d 6520 2b20 636f 6d6d 5f62 7974  _time + comm_byt
+0001a900: 6573 202f 2073 656c 662e 6261 6e64 7769  es / self.bandwi
+0001a910: 6474 680a 0a20 2020 2020 2020 2069 6620  dth..        if 
+0001a920: 7473 2e61 6374 6f72 3a0a 2020 2020 2020  ts.actor:.      
+0001a930: 2020 2020 2020 7265 7475 726e 2028 6c65        return (le
+0001a940: 6e28 7773 2e61 6374 6f72 7329 2c20 7374  n(ws.actors), st
+0001a950: 6172 745f 7469 6d65 2c20 7773 2e6e 6279  art_time, ws.nby
+0001a960: 7465 7329 0a20 2020 2020 2020 2065 6c73  tes).        els
+0001a970: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001a980: 6574 7572 6e20 2873 7461 7274 5f74 696d  eturn (start_tim
+0001a990: 652c 2077 732e 6e62 7974 6573 290a 0a20  e, ws.nbytes).. 
+0001a9a0: 2020 2064 6566 2061 6464 5f72 6570 6c69     def add_repli
+0001a9b0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
+0001a9c0: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
+0001a9d0: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
+0001a9e0: 3a0a 2020 2020 2020 2020 2222 224e 6f74  :.        """Not
+0001a9f0: 6520 7468 6174 2061 2077 6f72 6b65 7220  e that a worker 
+0001aa00: 686f 6c64 7320 6120 7265 706c 6963 6120  holds a replica 
+0001aa10: 6f66 2061 2074 6173 6b20 7769 7468 2073  of a task with s
+0001aa20: 7461 7465 3d27 6d65 6d6f 7279 2722 2222  tate='memory'"""
+0001aa30: 0a20 2020 2020 2020 2077 732e 6164 645f  .        ws.add_
+0001aa40: 7265 706c 6963 6128 7473 290a 2020 2020  replica(ts).    
+0001aa50: 2020 2020 6966 206c 656e 2874 732e 7768      if len(ts.wh
+0001aa60: 6f5f 6861 7329 203d 3d20 323a 0a20 2020  o_has) == 2:.   
+0001aa70: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+0001aa80: 706c 6963 6174 6564 5f74 6173 6b73 2e61  plicated_tasks.a
+0001aa90: 6464 2874 7329 0a0a 2020 2020 6465 6620  dd(ts)..    def 
+0001aaa0: 7265 6d6f 7665 5f72 6570 6c69 6361 2873  remove_replica(s
+0001aab0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001aac0: 7465 2c20 7773 3a20 576f 726b 6572 5374  te, ws: WorkerSt
+0001aad0: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+0001aae0: 2020 2020 2020 2222 224e 6f74 6520 7468        """Note th
+0001aaf0: 6174 2061 2077 6f72 6b65 7220 6e6f 206c  at a worker no l
+0001ab00: 6f6e 6765 7220 686f 6c64 7320 6120 7265  onger holds a re
+0001ab10: 706c 6963 6120 6f66 2061 2074 6173 6b22  plica of a task"
+0001ab20: 2222 0a20 2020 2020 2020 2077 732e 7265  "".        ws.re
+0001ab30: 6d6f 7665 5f72 6570 6c69 6361 2874 7329  move_replica(ts)
+0001ab40: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0001ab50: 7473 2e77 686f 5f68 6173 2920 3d3d 2031  ts.who_has) == 1
+0001ab60: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001ab70: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0001ab80: 736b 732e 7265 6d6f 7665 2874 7329 0a0a  sks.remove(ts)..
+0001ab90: 2020 2020 6465 6620 7265 6d6f 7665 5f61      def remove_a
+0001aba0: 6c6c 5f72 6570 6c69 6361 7328 7365 6c66  ll_replicas(self
+0001abb0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+0001abc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001abd0: 2020 2222 2252 656d 6f76 6520 616c 6c20    """Remove all 
+0001abe0: 7265 706c 6963 6173 206f 6620 6120 7461  replicas of a ta
+0001abf0: 736b 2066 726f 6d20 616c 6c20 776f 726b  sk from all work
+0001ac00: 6572 7322 2222 0a20 2020 2020 2020 206e  ers""".        n
+0001ac10: 6279 7465 7320 3d20 7473 2e67 6574 5f6e  bytes = ts.get_n
+0001ac20: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
+0001ac30: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+0001ac40: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0001ac50: 2020 7773 2e6e 6279 7465 7320 2d3d 206e    ws.nbytes -= n
+0001ac60: 6279 7465 730a 2020 2020 2020 2020 2020  bytes.          
+0001ac70: 2020 6465 6c20 7773 2e5f 6861 735f 7768    del ws._has_wh
+0001ac80: 6174 5b74 735d 0a20 2020 2020 2020 2069  at[ts].        i
+0001ac90: 6620 6c65 6e28 7473 2e77 686f 5f68 6173  f len(ts.who_has
+0001aca0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+0001acb0: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
+0001acc0: 6564 5f74 6173 6b73 2e72 656d 6f76 6528  ed_tasks.remove(
+0001acd0: 7473 290a 2020 2020 2020 2020 7473 2e77  ts).        ts.w
+0001ace0: 686f 5f68 6173 2e63 6c65 6172 2829 0a0a  ho_has.clear()..
+0001acf0: 2020 2020 6465 6620 6275 6c6b 5f73 6368      def bulk_sch
+0001ad00: 6564 756c 655f 756e 7275 6e6e 6162 6c65  edule_unrunnable
+0001ad10: 5f61 6674 6572 5f61 6464 696e 675f 776f  _after_adding_wo
+0001ad20: 726b 6572 2873 656c 662c 2077 733a 2057  rker(self, ws: W
+0001ad30: 6f72 6b65 7253 7461 7465 2920 2d3e 2052  orkerState) -> R
+0001ad40: 6563 733a 0a20 2020 2020 2020 2022 2222  ecs:.        """
+0001ad50: 5365 6e64 2060 606e 6f2d 776f 726b 6572  Send ``no-worker
+0001ad60: 6060 2074 6173 6b73 2074 6f20 6060 7072  `` tasks to ``pr
+0001ad70: 6f63 6573 7369 6e67 6060 2074 6861 7420  ocessing`` that 
+0001ad80: 7468 6973 2077 6f72 6b65 7220 6361 6e20  this worker can 
+0001ad90: 6861 6e64 6c65 2e0a 0a20 2020 2020 2020  handle...       
+0001ada0: 2052 6574 7572 6e73 2070 7269 6f72 6974   Returns priorit
+0001adb0: 792d 6f72 6465 7265 6420 7265 636f 6d6d  y-ordered recomm
+0001adc0: 656e 6461 7469 6f6e 732e 0a20 2020 2020  endations..     
+0001add0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0001ade0: 756e 6e61 626c 653a 206c 6973 745b 5461  unnable: list[Ta
+0001adf0: 736b 5374 6174 655d 203d 205b 5d0a 2020  skState] = [].  
+0001ae00: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0001ae10: 7365 6c66 2e75 6e72 756e 6e61 626c 653a  self.unrunnable:
+0001ae20: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+0001ae30: 6964 203d 2073 656c 662e 7661 6c69 645f  id = self.valid_
+0001ae40: 776f 726b 6572 7328 7473 290a 2020 2020  workers(ts).    
+0001ae50: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
+0001ae60: 2069 7320 4e6f 6e65 206f 7220 7773 2069   is None or ws i
+0001ae70: 6e20 7661 6c69 643a 0a20 2020 2020 2020  n valid:.       
+0001ae80: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+0001ae90: 652e 6170 7065 6e64 2874 7329 0a0a 2020  e.append(ts)..  
+0001aea0: 2020 2020 2020 2320 5265 636f 6d6d 656e        # Recommen
+0001aeb0: 6461 7469 6f6e 7320 6172 6520 7072 6f63  dations are proc
+0001aec0: 6573 7365 6420 4c49 464f 2c20 6865 6e63  essed LIFO, henc
+0001aed0: 6520 7468 6520 7265 7665 7273 6564 206f  e the reversed o
+0001aee0: 7264 6572 0a20 2020 2020 2020 2072 756e  rder.        run
+0001aef0: 6e61 626c 652e 736f 7274 286b 6579 3d6f  nable.sort(key=o
+0001af00: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+0001af10: 6572 2822 7072 696f 7269 7479 2229 2c20  er("priority"), 
+0001af20: 7265 7665 7273 653d 5472 7565 290a 2020  reverse=True).  
+0001af30: 2020 2020 2020 7265 7475 726e 207b 7473        return {ts
+0001af40: 2e6b 6579 3a20 2270 726f 6365 7373 696e  .key: "processin
+0001af50: 6722 2066 6f72 2074 7320 696e 2072 756e  g" for ts in run
+0001af60: 6e61 626c 657d 0a0a 2020 2020 6465 6620  nable}..    def 
+0001af70: 5f76 616c 6964 6174 655f 7265 6164 7928  _validate_ready(
+0001af80: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+0001af90: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+0001afa0: 2020 2020 2020 2222 2256 616c 6964 6174        """Validat
+0001afb0: 696f 6e20 666f 7220 7265 6164 7920 7374  ion for ready st
+0001afc0: 6174 6573 2028 7072 6f63 6573 7369 6e67  ates (processing
+0001afd0: 2c20 7175 6575 6564 2c20 6e6f 2d77 6f72  , queued, no-wor
+0001afe0: 6b65 7229 2222 220a 2020 2020 2020 2020  ker)""".        
+0001aff0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+0001b000: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+0001b010: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+0001b020: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
+0001b030: 7373 6572 7420 6e6f 7420 7473 2e65 7863  ssert not ts.exc
+0001b040: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+0001b050: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0001b060: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+0001b070: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001b080: 6e6f 7420 7473 2e68 6173 5f6c 6f73 745f  not ts.has_lost_
+0001b090: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+0001b0a0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0001b0b0: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
+0001b0c0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
+0001b0d0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0001b0e0: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+0001b0f0: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
+0001b100: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
+0001b110: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0001b120: 6369 6573 290a 0a20 2020 2064 6566 205f  cies)..    def _
+0001b130: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
+0001b140: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
+0001b150: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
+0001b160: 7253 7461 7465 2920 2d3e 204d 7367 733a  rState) -> Msgs:
+0001b170: 0a20 2020 2020 2020 2022 2222 5365 7420  .        """Set 
+0001b180: 6120 7461 736b 2061 7320 7072 6f63 6573  a task as proces
+0001b190: 7369 6e67 206f 6e20 6120 776f 726b 6572  sing on a worker
+0001b1a0: 2061 6e64 2072 6574 7572 6e20 7468 6520   and return the 
+0001b1b0: 776f 726b 6572 206d 6573 7361 6765 7320  worker messages 
+0001b1c0: 746f 2073 656e 6422 2222 0a20 2020 2020  to send""".     
+0001b1d0: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+0001b1e0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+0001b1f0: 2073 656c 662e 5f76 616c 6964 6174 655f   self._validate_
+0001b200: 7265 6164 7928 7473 290a 2020 2020 2020  ready(ts).      
+0001b210: 2020 2020 2020 6173 7365 7274 2077 7320        assert ws 
+0001b220: 696e 2073 656c 662e 7275 6e6e 696e 672c  in self.running,
+0001b230: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
+0001b240: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001b250: 2028 6f20 3a3d 2073 656c 662e 776f 726b   (o := self.work
+0001b260: 6572 732e 6765 7428 7773 2e61 6464 7265  ers.get(ws.addre
+0001b270: 7373 2929 2069 7320 7773 2c20 2877 732c  ss)) is ws, (ws,
+0001b280: 206f 290a 0a20 2020 2020 2020 2077 732e   o)..        ws.
+0001b290: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
+0001b2a0: 6728 7473 290a 2020 2020 2020 2020 7473  g(ts).        ts
+0001b2b0: 2e70 726f 6365 7373 696e 675f 6f6e 203d  .processing_on =
+0001b2c0: 2077 730a 2020 2020 2020 2020 7473 2e73   ws.        ts.s
+0001b2d0: 7461 7465 203d 2022 7072 6f63 6573 7369  tate = "processi
+0001b2e0: 6e67 220a 2020 2020 2020 2020 7365 6c66  ng".        self
+0001b2f0: 2e61 6371 7569 7265 5f72 6573 6f75 7263  .acquire_resourc
+0001b300: 6573 2874 732c 2077 7329 0a20 2020 2020  es(ts, ws).     
+0001b310: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
+0001b320: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
+0001b330: 0a20 2020 2020 2020 2073 656c 662e 6e5f  .        self.n_
+0001b340: 7461 736b 7320 2b3d 2031 0a0a 2020 2020  tasks += 1..    
+0001b350: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
+0001b360: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+0001b370: 6163 746f 7273 2e61 6464 2874 7329 0a0a  actors.add(ts)..
+0001b380: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0001b390: 7773 2e61 6464 7265 7373 3a20 5b73 656c  ws.address: [sel
+0001b3a0: 662e 5f74 6173 6b5f 746f 5f6d 7367 2874  f._task_to_msg(t
+0001b3b0: 7329 5d7d 0a0a 2020 2020 6465 6620 5f65  s)]}..    def _e
+0001b3c0: 7869 745f 7072 6f63 6573 7369 6e67 5f63  xit_processing_c
+0001b3d0: 6f6d 6d6f 6e28 7365 6c66 2c20 7473 3a20  ommon(self, ts: 
+0001b3e0: 5461 736b 5374 6174 6529 202d 3e20 576f  TaskState) -> Wo
+0001b3f0: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+0001b400: 3a0a 2020 2020 2020 2020 2222 2252 656d  :.        """Rem
+0001b410: 6f76 6520 2a74 732a 2066 726f 6d20 7468  ove *ts* from th
+0001b420: 6520 7365 7420 6f66 2070 726f 6365 7373  e set of process
+0001b430: 696e 6720 7461 736b 732e 0a0a 2020 2020  ing tasks...    
+0001b440: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0001b450: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0001b460: 2020 2020 576f 726b 6572 2073 7461 7465      Worker state
+0001b470: 206f 6620 7468 6520 776f 726b 6572 2074   of the worker t
+0001b480: 6861 7420 7072 6f63 6573 7365 6420 2a74  hat processed *t
+0001b490: 732a 2069 6620 7468 6520 776f 726b 6572  s* if the worker
+0001b4a0: 2069 7320 6375 7272 656e 742c 0a20 2020   is current,.   
+0001b4b0: 2020 2020 204e 6f6e 6520 6966 2074 6865       None if the
+0001b4c0: 2077 6f72 6b65 7220 6973 2073 7461 6c65   worker is stale
+0001b4d0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+0001b4e0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0001b4f0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+0001b500: 6564 756c 6572 2e5f 7365 745f 6475 7261  eduler._set_dura
+0001b510: 7469 6f6e 5f65 7374 696d 6174 650a 2020  tion_estimate.  
+0001b520: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001b530: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
+0001b540: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0001b550: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
+0001b560: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
+0001b570: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
+0001b580: 2020 2077 732e 7265 6d6f 7665 5f66 726f     ws.remove_fro
+0001b590: 6d5f 7072 6f63 6573 7369 6e67 2874 7329  m_processing(ts)
+0001b5a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001b5b0: 2e77 6f72 6b65 7273 2e67 6574 2877 732e  .workers.get(ws.
+0001b5c0: 6164 6472 6573 7329 2069 7320 6e6f 7420  address) is not 
+0001b5d0: 7773 3a20 2023 206d 6179 2068 6176 6520  ws:  # may have 
+0001b5e0: 6265 656e 2072 656d 6f76 6564 0a20 2020  been removed.   
+0001b5f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b600: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
+0001b610: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
+0001b620: 7475 7261 7465 6428 7773 290a 2020 2020  turated(ws).    
+0001b630: 2020 2020 7365 6c66 2e72 656c 6561 7365      self.release
+0001b640: 5f72 6573 6f75 7263 6573 2874 732c 2077  _resources(ts, w
+0001b650: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
+0001b660: 726e 2077 730a 0a20 2020 2064 6566 205f  rn ws..    def _
+0001b670: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
+0001b680: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001b690: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0001b6a0: 7465 2c0a 2020 2020 2020 2020 7773 3a20  te,.        ws: 
+0001b6b0: 576f 726b 6572 5374 6174 652c 0a20 2020  WorkerState,.   
+0001b6c0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001b6d0: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
+0001b6e0: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+0001b6f0: 204d 7367 732c 0a20 2020 2020 2020 2074   Msgs,.        t
+0001b700: 7970 653a 2062 7974 6573 207c 204e 6f6e  ype: bytes | Non
+0001b710: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0001b720: 2020 7479 7065 6e61 6d65 3a20 7374 7220    typename: str 
+0001b730: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0001b740: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+0001b750: 2020 2020 2020 2222 2241 6464 2074 7320        """Add ts 
+0001b760: 746f 2074 6865 2073 6574 206f 6620 696e  to the set of in
+0001b770: 2d6d 656d 6f72 7920 7461 736b 7322 2222  -memory tasks"""
+0001b780: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001b790: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+0001b7a0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0001b7b0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
+0001b7c0: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
+0001b7d0: 662e 6164 645f 7265 706c 6963 6128 7473  f.add_replica(ts
+0001b7e0: 2c20 7773 290a 0a20 2020 2020 2020 2064  , ws)..        d
+0001b7f0: 6570 7320 3d20 6c69 7374 2874 732e 6465  eps = list(ts.de
+0001b800: 7065 6e64 656e 7473 290a 2020 2020 2020  pendents).      
+0001b810: 2020 6966 206c 656e 2864 6570 7329 203e    if len(deps) >
+0001b820: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0001b830: 6465 7073 2e73 6f72 7428 6b65 793d 6f70  deps.sort(key=op
+0001b840: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
+0001b850: 7228 2270 7269 6f72 6974 7922 292c 2072  r("priority"), r
+0001b860: 6576 6572 7365 3d54 7275 6529 0a0a 2020  everse=True)..  
+0001b870: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+0001b880: 2064 6570 733a 0a20 2020 2020 2020 2020   deps:.         
+0001b890: 2020 2073 203d 2064 7473 2e77 6169 7469     s = dts.waiti
+0001b8a0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+0001b8b0: 2020 6966 2074 7320 696e 2073 3a0a 2020    if ts in s:.  
+0001b8c0: 2020 2020 2020 2020 2020 2020 2020 732e                s.
+0001b8d0: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+0001b8e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001b8f0: 6f74 2073 3a20 2023 206e 6577 2074 6173  ot s:  # new tas
+0001b900: 6b20 7265 6164 7920 746f 2072 756e 0a20  k ready to run. 
+0001b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b920: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0001b930: 6e73 5b64 7473 2e6b 6579 5d20 3d20 2270  ns[dts.key] = "p
+0001b940: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
+0001b950: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+0001b960: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+0001b970: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+0001b980: 6474 732e 7761 6974 6572 730a 2020 2020  dts.waiters.    
+0001b990: 2020 2020 2020 2020 732e 6469 7363 6172          s.discar
+0001b9a0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+0001b9b0: 2020 6966 206e 6f74 2073 2061 6e64 206e    if not s and n
+0001b9c0: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
+0001b9d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b9e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001b9f0: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
+0001ba00: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
+0001ba10: 2069 6620 6e6f 7420 7473 2e77 6169 7465   if not ts.waite
+0001ba20: 7273 2061 6e64 206e 6f74 2074 732e 7768  rs and not ts.wh
+0001ba30: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+0001ba40: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001ba50: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
+0001ba60: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
+0001ba70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ba80: 2020 2020 7265 706f 7274 5f6d 7367 3a20      report_msg: 
+0001ba90: 6469 6374 5b73 7472 2c20 416e 795d 203d  dict[str, Any] =
+0001baa0: 207b 226f 7022 3a20 226b 6579 2d69 6e2d   {"op": "key-in-
+0001bab0: 6d65 6d6f 7279 222c 2022 6b65 7922 3a20  memory", "key": 
+0001bac0: 7473 2e6b 6579 7d0a 2020 2020 2020 2020  ts.key}.        
+0001bad0: 2020 2020 6966 2074 7970 6520 6973 206e      if type is n
+0001bae0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001baf0: 2020 2020 2020 2020 2072 6570 6f72 745f           report_
+0001bb00: 6d73 675b 2274 7970 6522 5d20 3d20 7479  msg["type"] = ty
+0001bb10: 7065 0a20 2020 2020 2020 2020 2020 2066  pe.            f
+0001bb20: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
+0001bb30: 7761 6e74 733a 0a20 2020 2020 2020 2020  wants:.         
+0001bb40: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+0001bb50: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
+0001bb60: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
+0001bb70: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
+0001bb80: 7465 203d 2022 6d65 6d6f 7279 220a 2020  te = "memory".  
+0001bb90: 2020 2020 2020 7473 2e74 7970 6520 3d20        ts.type = 
+0001bba0: 7479 7065 6e61 6d65 2020 2320 7479 7065  typename  # type
+0001bbb0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+0001bbc0: 2074 732e 6772 6f75 702e 7479 7065 732e   ts.group.types.
+0001bbd0: 6164 6428 7479 7065 6e61 6d65 2920 2023  add(typename)  #
+0001bbe0: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
+0001bbf0: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
+0001bc00: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
+0001bc10: 6e64 2d66 6f72 6765 7422 5d0a 2020 2020  nd-forget"].    
+0001bc20: 2020 2020 6966 2074 7320 696e 2063 732e      if ts in cs.
+0001bc30: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
+0001bc40: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+0001bc50: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
+0001bc60: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
+0001bc70: 2020 2020 6373 3d63 732c 0a20 2020 2020      cs=cs,.     
+0001bc80: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
+0001bc90: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
+0001bca0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+0001bcb0: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
+0001bcc0: 656e 6461 7469 6f6e 732c 0a20 2020 2020  endations,.     
+0001bcd0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0001bce0: 6620 5f70 726f 7061 6761 7465 5f72 656c  f _propagate_rel
+0001bcf0: 6561 7365 6428 7365 6c66 2c20 7473 3a20  eased(self, ts: 
+0001bd00: 5461 736b 5374 6174 652c 2072 6563 6f6d  TaskState, recom
+0001bd10: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0001bd20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001bd30: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
+0001bd40: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
+0001bd50: 206b 6579 203d 2074 732e 6b65 790a 0a20   key = ts.key.. 
+0001bd60: 2020 2020 2020 2069 6620 7473 2e68 6173         if ts.has
+0001bd70: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+0001bd80: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001bd90: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+0001bda0: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
+0001bdb0: 6e22 0a20 2020 2020 2020 2065 6c69 6620  n".        elif 
+0001bdc0: 7473 2e77 6169 7465 7273 206f 7220 7473  ts.waiters or ts
+0001bdd0: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+0001bde0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001bdf0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+0001be00: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
+0001be10: 2020 6966 2072 6563 6f6d 6d65 6e64 6174    if recommendat
+0001be20: 696f 6e73 2e67 6574 286b 6579 2920 213d  ions.get(key) !=
+0001be30: 2022 7761 6974 696e 6722 3a0a 2020 2020   "waiting":.    
+0001be40: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0001be50: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0001be60: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001be70: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
+0001be80: 2021 3d20 2272 656c 6561 7365 6422 3a0a   != "released":.
+0001be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bea0: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
+0001beb0: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+0001bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bed0: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
+0001bee0: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
+0001bef0: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+0001bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf10: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001bf20: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
+0001bf30: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
+0001bf40: 2020 2020 7473 2e77 6169 7465 7273 2e63      ts.waiters.c
+0001bf50: 6c65 6172 2829 0a0a 2020 2020 2020 2020  lear()..        
+0001bf60: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+0001bf70: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0001bf80: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+0001bf90: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+0001bfa0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0001bfb0: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
+0001bfc0: 6564 0a0a 2020 2020 6465 6620 5f70 726f  ed..    def _pro
+0001bfd0: 7061 6761 7465 5f66 6f72 676f 7474 656e  pagate_forgotten
+0001bfe0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0001bff0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0001c000: 5374 6174 652c 0a20 2020 2020 2020 2072  State,.        r
+0001c010: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+0001c020: 5265 6373 2c0a 2020 2020 2020 2020 776f  Recs,.        wo
+0001c030: 726b 6572 5f6d 7367 733a 204d 7367 732c  rker_msgs: Msgs,
+0001c040: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+0001c050: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
+0001c060: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001c070: 2020 7473 2e73 7461 7465 203d 2022 666f    ts.state = "fo
+0001c080: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
+0001c090: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0001c0a0: 6570 656e 6465 6e74 733a 0a20 2020 2020  ependents:.     
+0001c0b0: 2020 2020 2020 2064 7473 2e68 6173 5f6c         dts.has_l
+0001c0c0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+0001c0d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0001c0e0: 2020 2020 6474 732e 6465 7065 6e64 656e      dts.dependen
+0001c0f0: 6369 6573 2e72 656d 6f76 6528 7473 290a  cies.remove(ts).
+0001c100: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+0001c110: 7761 6974 696e 675f 6f6e 2e64 6973 6361  waiting_on.disca
+0001c120: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
+0001c130: 2020 2069 6620 6474 732e 7374 6174 6520     if dts.state 
+0001c140: 6e6f 7420 696e 2028 226d 656d 6f72 7922  not in ("memory"
+0001c150: 2c20 2265 7272 6564 2229 3a0a 2020 2020  , "erred"):.    
+0001c160: 2020 2020 2020 2020 2020 2020 2320 4361              # Ca
+0001c170: 6e6e 6f74 2063 6f6d 7075 7465 2074 6173  nnot compute tas
+0001c180: 6b20 616e 796d 6f72 650a 2020 2020 2020  k anymore.      
+0001c190: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+0001c1a0: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+0001c1b0: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
+0001c1c0: 0a20 2020 2020 2020 2074 732e 6465 7065  .        ts.depe
+0001c1d0: 6e64 656e 7473 2e63 6c65 6172 2829 0a20  ndents.clear(). 
+0001c1e0: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
+0001c1f0: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
+0001c200: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+0001c210: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+0001c220: 2020 2020 2020 2020 2020 2064 7473 2e64             dts.d
+0001c230: 6570 656e 6465 6e74 732e 7265 6d6f 7665  ependents.remove
+0001c240: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0001c250: 2064 7473 2e77 6169 7465 7273 2e64 6973   dts.waiters.dis
+0001c260: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+0001c270: 2020 2020 2069 6620 6e6f 7420 6474 732e       if not dts.
+0001c280: 6465 7065 6e64 656e 7473 2061 6e64 206e  dependents and n
+0001c290: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
+0001c2a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c2b0: 2020 2320 5461 736b 206e 6f74 206e 6565    # Task not nee
+0001c2c0: 6465 6420 616e 796d 6f72 650a 2020 2020  ded anymore.    
+0001c2d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001c2e0: 7274 2064 7473 2069 7320 6e6f 7420 7473  rt dts is not ts
+0001c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c300: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001c310: 5b64 7473 2e6b 6579 5d20 3d20 2266 6f72  [dts.key] = "for
+0001c320: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+0001c330: 7473 2e64 6570 656e 6465 6e63 6965 732e  ts.dependencies.
+0001c340: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
+0001c350: 7473 2e77 6169 7469 6e67 5f6f 6e2e 636c  ts.waiting_on.cl
+0001c360: 6561 7228 290a 0a20 2020 2020 2020 2066  ear()..        f
+0001c370: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
+0001c380: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+0001c390: 2069 6620 7773 2e61 6464 7265 7373 2069   if ws.address i
+0001c3a0: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a20  n self.workers: 
+0001c3b0: 2023 2069 6e20 6361 7365 2077 6f72 6b65   # in case worke
+0001c3c0: 7220 6861 7320 6469 6564 0a20 2020 2020  r has died.     
+0001c3d0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0001c3e0: 725f 6d73 6773 5b77 732e 6164 6472 6573  r_msgs[ws.addres
+0001c3f0: 735d 203d 205b 0a20 2020 2020 2020 2020  s] = [.         
+0001c400: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c420: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
+0001c430: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+0001c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c450: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
+0001c460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c470: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+0001c480: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+0001c490: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+0001c4a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0001c4b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0001c4c0: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+0001c4d0: 655f 616c 6c5f 7265 706c 6963 6173 2874  e_all_replicas(t
+0001c4e0: 7329 0a0a 2020 2020 6465 6620 5f63 6c69  s)..    def _cli
+0001c4f0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
+0001c500: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+0001c510: 0a20 2020 2020 2020 206b 6579 733a 2043  .        keys: C
+0001c520: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c0a  ollection[str],.
+0001c530: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
+0001c540: 6e74 5374 6174 652c 0a20 2020 2020 2020  ntState,.       
+0001c550: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001c560: 3a20 5265 6373 2c0a 2020 2020 2920 2d3e  : Recs,.    ) ->
+0001c570: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+0001c580: 2222 5265 6d6f 7665 206b 6579 7320 6672  ""Remove keys fr
+0001c590: 6f6d 2063 6c69 656e 7420 6465 7369 7265  om client desire
+0001c5a0: 6420 6c69 7374 2222 220a 2020 2020 2020  d list""".      
+0001c5b0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+0001c5c0: 436c 6965 6e74 2025 7320 7265 6c65 6173  Client %s releas
+0001c5d0: 6573 206b 6579 733a 2025 7322 2c20 6373  es keys: %s", cs
+0001c5e0: 2e63 6c69 656e 745f 6b65 792c 206b 6579  .client_key, key
+0001c5f0: 7329 0a20 2020 2020 2020 2066 6f72 206b  s).        for k
+0001c600: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
+0001c610: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+0001c620: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+0001c630: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c640: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
+0001c650: 6e64 2074 7320 696e 2063 732e 7761 6e74  nd ts in cs.want
+0001c660: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
+0001c670: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
+0001c680: 5f77 6861 742e 7265 6d6f 7665 2874 7329  _what.remove(ts)
+0001c690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c6a0: 2074 732e 7768 6f5f 7761 6e74 732e 7265   ts.who_wants.re
+0001c6b0: 6d6f 7665 2863 7329 0a20 2020 2020 2020  move(cs).       
+0001c6c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001c6d0: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
+0001c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6f0: 2020 6966 206e 6f74 2074 732e 6465 7065    if not ts.depe
+0001c700: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
+0001c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c720: 2320 4e6f 206c 6976 6520 6465 7065 6e64  # No live depend
+0001c730: 656e 7473 2c20 6361 6e20 666f 7267 6574  ents, can forget
+0001c740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c750: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0001c760: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
+0001c770: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
+0001c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c790: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
+0001c7a0: 2021 3d20 2265 7272 6564 2220 616e 6420   != "erred" and 
+0001c7b0: 6e6f 7420 7473 2e77 6169 7465 7273 3a0a  not ts.waiters:.
+0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c7d0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001c7e0: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0001c7f0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
+0001c800: 2020 6465 6620 5f74 6173 6b5f 746f 5f6d    def _task_to_m
+0001c810: 7367 2873 656c 662c 2074 733a 2054 6173  sg(self, ts: Tas
+0001c820: 6b53 7461 7465 2c20 6475 7261 7469 6f6e  kState, duration
+0001c830: 3a20 666c 6f61 7420 3d20 2d31 2920 2d3e  : float = -1) ->
+0001c840: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
+0001c850: 0a20 2020 2020 2020 2022 2222 436f 6e76  .        """Conv
+0001c860: 6572 7420 6120 7369 6e67 6c65 2063 6f6d  ert a single com
+0001c870: 7075 7461 7469 6f6e 616c 2074 6173 6b20  putational task 
+0001c880: 746f 2061 206d 6573 7361 6765 2222 220a  to a message""".
+0001c890: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+0001c8a0: 2054 6865 2064 7572 6174 696f 6e20 6174   The duration at
+0001c8b0: 7472 6962 7574 6520 6973 206e 6f74 2075  tribute is not u
+0001c8c0: 7365 6420 6f6e 2077 6f72 6b65 722e 2057  sed on worker. W
+0001c8d0: 6520 636f 756c 6420 7361 7665 206f 7572  e could save our
+0001c8e0: 7365 6c76 6573 2074 6865 0a20 2020 2020  selves the.     
+0001c8f0: 2020 2023 2020 2020 2020 2020 7469 6d65     #        time
+0001c900: 2074 6f20 636f 6d70 7574 6520 616e 6420   to compute and 
+0001c910: 7375 626d 6974 2074 6869 730a 2020 2020  submit this.    
+0001c920: 2020 2020 6966 2064 7572 6174 696f 6e20      if duration 
+0001c930: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+0001c940: 2064 7572 6174 696f 6e20 3d20 7365 6c66   duration = self
+0001c950: 2e67 6574 5f74 6173 6b5f 6475 7261 7469  .get_task_durati
+0001c960: 6f6e 2874 7329 0a20 2020 2020 2020 2074  on(ts).        t
+0001c970: 732e 7275 6e5f 6964 203d 206e 6578 7428  s.run_id = next(
+0001c980: 5461 736b 5374 6174 652e 5f72 756e 5f69  TaskState._run_i
+0001c990: 645f 6974 6572 6174 6f72 290a 2020 2020  d_iterator).    
+0001c9a0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+0001c9b0: 696f 7269 7479 2c20 7473 0a20 2020 2020  iority, ts.     
+0001c9c0: 2020 206d 7367 3a20 6469 6374 5b73 7472     msg: dict[str
+0001c9d0: 2c20 416e 795d 203d 207b 0a20 2020 2020  , Any] = {.     
+0001c9e0: 2020 2020 2020 2022 6f70 223a 2022 636f         "op": "co
+0001c9f0: 6d70 7574 652d 7461 736b 222c 0a20 2020  mpute-task",.   
+0001ca00: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
+0001ca10: 7473 2e6b 6579 2c0a 2020 2020 2020 2020  ts.key,.        
+0001ca20: 2020 2020 2272 756e 5f69 6422 3a20 7473      "run_id": ts
+0001ca30: 2e72 756e 5f69 642c 0a20 2020 2020 2020  .run_id,.       
+0001ca40: 2020 2020 2022 7072 696f 7269 7479 223a       "priority":
+0001ca50: 2074 732e 7072 696f 7269 7479 2c0a 2020   ts.priority,.  
+0001ca60: 2020 2020 2020 2020 2020 2264 7572 6174            "durat
+0001ca70: 696f 6e22 3a20 6475 7261 7469 6f6e 2c0a  ion": duration,.
+0001ca80: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0001ca90: 6d75 6c75 735f 6964 223a 2066 2263 6f6d  mulus_id": f"com
+0001caa0: 7075 7465 2d74 6173 6b2d 7b74 696d 6528  pute-task-{time(
+0001cab0: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
+0001cac0: 2022 7768 6f5f 6861 7322 3a20 7b0a 2020   "who_has": {.  
+0001cad0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+0001cae0: 732e 6b65 793a 205b 7773 2e61 6464 7265  s.key: [ws.addre
+0001caf0: 7373 2066 6f72 2077 7320 696e 2064 7473  ss for ws in dts
+0001cb00: 2e77 686f 5f68 6173 5d20 666f 7220 6474  .who_has] for dt
+0001cb10: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0001cb20: 6369 6573 0a20 2020 2020 2020 2020 2020  cies.           
+0001cb30: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+0001cb40: 226e 6279 7465 7322 3a20 7b64 7473 2e6b  "nbytes": {dts.k
+0001cb50: 6579 3a20 6474 732e 6e62 7974 6573 2066  ey: dts.nbytes f
+0001cb60: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0001cb70: 656e 6465 6e63 6965 737d 2c0a 2020 2020  endencies},.    
+0001cb80: 2020 2020 2020 2020 2272 756e 5f73 7065          "run_spe
+0001cb90: 6322 3a20 4e6f 6e65 2c0a 2020 2020 2020  c": None,.      
+0001cba0: 2020 2020 2020 2266 756e 6374 696f 6e22        "function"
+0001cbb0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001cbc0: 2020 2020 2261 7267 7322 3a20 4e6f 6e65      "args": None
+0001cbd0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
+0001cbe0: 7761 7267 7322 3a20 4e6f 6e65 2c0a 2020  wargs": None,.  
+0001cbf0: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
+0001cc00: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+0001cc10: 223a 2074 732e 7265 736f 7572 6365 5f72  ": ts.resource_r
+0001cc20: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
+0001cc30: 2020 2020 2020 2020 2022 6163 746f 7222           "actor"
+0001cc40: 3a20 7473 2e61 6374 6f72 2c0a 2020 2020  : ts.actor,.    
+0001cc50: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
+0001cc60: 696f 6e73 223a 2074 732e 616e 6e6f 7461  ions": ts.annota
+0001cc70: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0001cc80: 2020 2022 7370 616e 5f69 6422 3a20 7473     "span_id": ts
+0001cc90: 2e67 726f 7570 2e73 7061 6e5f 6964 2c0a  .group.span_id,.
+0001cca0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0001ccb0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+0001ccc0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+0001ccd0: 6173 7365 7274 2061 6c6c 286d 7367 5b22  assert all(msg["
+0001cce0: 7768 6f5f 6861 7322 5d2e 7661 6c75 6573  who_has"].values
+0001ccf0: 2829 290a 0a20 2020 2020 2020 2069 6620  ())..        if 
+0001cd00: 6973 696e 7374 616e 6365 2874 732e 7275  isinstance(ts.ru
+0001cd10: 6e5f 7370 6563 2c20 6469 6374 293a 0a20  n_spec, dict):. 
+0001cd20: 2020 2020 2020 2020 2020 206d 7367 2e75             msg.u
+0001cd30: 7064 6174 6528 7473 2e72 756e 5f73 7065  pdate(ts.run_spe
+0001cd40: 6329 0a20 2020 2020 2020 2065 6c73 653a  c).        else:
+0001cd50: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0001cd60: 5b22 7275 6e5f 7370 6563 225d 203d 2074  ["run_spec"] = t
+0001cd70: 732e 7275 6e5f 7370 6563 0a0a 2020 2020  s.run_spec..    
+0001cd80: 2020 2020 7265 7475 726e 206d 7367 0a0a      return msg..
+0001cd90: 0a63 6c61 7373 2053 6368 6564 756c 6572  .class Scheduler
+0001cda0: 2853 6368 6564 756c 6572 5374 6174 652c  (SchedulerState,
+0001cdb0: 2053 6572 7665 724e 6f64 6529 3a0a 2020   ServerNode):.  
+0001cdc0: 2020 2222 2244 796e 616d 6963 2064 6973    """Dynamic dis
+0001cdd0: 7472 6962 7574 6564 2074 6173 6b20 7363  tributed task sc
+0001cde0: 6865 6475 6c65 720a 0a20 2020 2054 6865  heduler..    The
+0001cdf0: 2073 6368 6564 756c 6572 2074 7261 636b   scheduler track
+0001ce00: 7320 7468 6520 6375 7272 656e 7420 7374  s the current st
+0001ce10: 6174 6520 6f66 2077 6f72 6b65 7273 2c20  ate of workers, 
+0001ce20: 6461 7461 2c20 616e 6420 636f 6d70 7574  data, and comput
+0001ce30: 6174 696f 6e73 2e0a 2020 2020 5468 6520  ations..    The 
+0001ce40: 7363 6865 6475 6c65 7220 6c69 7374 656e  scheduler listen
+0001ce50: 7320 666f 7220 6576 656e 7473 2061 6e64  s for events and
+0001ce60: 2072 6573 706f 6e64 7320 6279 2063 6f6e   responds by con
+0001ce70: 7472 6f6c 6c69 6e67 2077 6f72 6b65 7273  trolling workers
+0001ce80: 0a20 2020 2061 7070 726f 7072 6961 7465  .    appropriate
+0001ce90: 6c79 2e20 2049 7420 636f 6e74 696e 756f  ly.  It continuo
+0001cea0: 7573 6c79 2074 7269 6573 2074 6f20 7573  usly tries to us
+0001ceb0: 6520 7468 6520 776f 726b 6572 7320 746f  e the workers to
+0001cec0: 2065 7865 6375 7465 2061 6e20 6576 6572   execute an ever
+0001ced0: 0a20 2020 2067 726f 7769 6e67 2064 6173  .    growing das
+0001cee0: 6b20 6772 6170 682e 0a0a 2020 2020 416c  k graph...    Al
+0001cef0: 6c20 6576 656e 7473 2061 7265 2068 616e  l events are han
+0001cf00: 646c 6564 2071 7569 636b 6c79 2c20 696e  dled quickly, in
+0001cf10: 206c 696e 6561 7220 7469 6d65 2077 6974   linear time wit
+0001cf20: 6820 7265 7370 6563 7420 746f 2074 6865  h respect to the
+0001cf30: 6972 2069 6e70 7574 0a20 2020 2028 7768  ir input.    (wh
+0001cf40: 6963 6820 6973 206f 6674 656e 206f 6620  ich is often of 
+0001cf50: 636f 6e73 7461 6e74 2073 697a 6529 2061  constant size) a
+0001cf60: 6e64 2067 656e 6572 616c 6c79 2077 6974  nd generally wit
+0001cf70: 6869 6e20 6120 6d69 6c6c 6973 6563 6f6e  hin a millisecon
+0001cf80: 642e 2020 546f 0a20 2020 2061 6363 6f6d  d.  To.    accom
+0001cf90: 706c 6973 6820 7468 6973 2074 6865 2073  plish this the s
+0001cfa0: 6368 6564 756c 6572 2074 7261 636b 7320  cheduler tracks 
+0001cfb0: 6120 6c6f 7420 6f66 2073 7461 7465 2e20  a lot of state. 
+0001cfc0: 2045 7665 7279 206f 7065 7261 7469 6f6e   Every operation
+0001cfd0: 0a20 2020 206d 6169 6e74 6169 6e73 2074  .    maintains t
+0001cfe0: 6865 2063 6f6e 7369 7374 656e 6379 206f  he consistency o
+0001cff0: 6620 7468 6973 2073 7461 7465 2e0a 0a20  f this state... 
+0001d000: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
+0001d010: 2063 6f6d 6d75 6e69 6361 7465 7320 7769   communicates wi
+0001d020: 7468 2074 6865 206f 7574 7369 6465 2077  th the outside w
+0001d030: 6f72 6c64 2074 6872 6f75 6768 2043 6f6d  orld through Com
+0001d040: 6d20 6f62 6a65 6374 732e 0a20 2020 2049  m objects..    I
+0001d050: 7420 6d61 696e 7461 696e 7320 6120 636f  t maintains a co
+0001d060: 6e73 6973 7465 6e74 2061 6e64 2076 616c  nsistent and val
+0001d070: 6964 2076 6965 7720 6f66 2074 6865 2077  id view of the w
+0001d080: 6f72 6c64 2065 7665 6e20 7768 656e 206c  orld even when l
+0001d090: 6973 7465 6e69 6e67 0a20 2020 2074 6f20  istening.    to 
+0001d0a0: 7365 7665 7261 6c20 636c 6965 6e74 7320  several clients 
+0001d0b0: 6174 206f 6e63 652e 0a0a 2020 2020 4120  at once...    A 
+0001d0c0: 5363 6865 6475 6c65 7220 6973 2074 7970  Scheduler is typ
+0001d0d0: 6963 616c 6c79 2073 7461 7274 6564 2065  ically started e
+0001d0e0: 6974 6865 7220 7769 7468 2074 6865 2060  ither with the `
+0001d0f0: 6064 6173 6b20 7363 6865 6475 6c65 7260  `dask scheduler`
+0001d100: 600a 2020 2020 6578 6563 7574 6162 6c65  `.    executable
+0001d110: 3a3a 0a0a 2020 2020 2020 2020 2024 2064  ::..         $ d
+0001d120: 6173 6b20 7363 6865 6475 6c65 720a 2020  ask scheduler.  
+0001d130: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+0001d140: 2073 7461 7274 6564 2061 7420 3132 372e   started at 127.
+0001d150: 302e 302e 313a 3837 3836 0a0a 2020 2020  0.0.1:8786..    
+0001d160: 4f72 2077 6974 6869 6e20 6120 4c6f 6361  Or within a Loca
+0001d170: 6c43 6c75 7374 6572 2061 2043 6c69 656e  lCluster a Clien
+0001d180: 7420 7374 6172 7473 2075 7020 7769 7468  t starts up with
+0001d190: 6f75 7420 636f 6e6e 6563 7469 6f6e 0a20  out connection. 
+0001d1a0: 2020 2069 6e66 6f72 6d61 7469 6f6e 3a3a     information::
+0001d1b0: 0a0a 2020 2020 2020 2020 3e3e 3e20 6320  ..        >>> c 
+0001d1c0: 3d20 436c 6965 6e74 2829 2020 2320 646f  = Client()  # do
+0001d1d0: 6374 6573 743a 202b 534b 4950 0a20 2020  ctest: +SKIP.   
+0001d1e0: 2020 2020 203e 3e3e 2063 2e63 6c75 7374       >>> c.clust
+0001d1f0: 6572 2e73 6368 6564 756c 6572 2020 2320  er.scheduler  # 
+0001d200: 646f 6374 6573 743a 202b 534b 4950 0a20  doctest: +SKIP. 
+0001d210: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+0001d220: 282e 2e2e 290a 0a20 2020 2055 7365 7273  (...)..    Users
+0001d230: 2074 7970 6963 616c 6c79 2064 6f20 6e6f   typically do no
+0001d240: 7420 696e 7465 7261 6374 2077 6974 6820  t interact with 
+0001d250: 7468 6520 7363 6865 6475 6c65 7220 6469  the scheduler di
+0001d260: 7265 6374 6c79 2062 7574 2072 6174 6865  rectly but rathe
+0001d270: 7220 7769 7468 0a20 2020 2074 6865 2063  r with.    the c
+0001d280: 6c69 656e 7420 6f62 6a65 6374 2060 6043  lient object ``C
+0001d290: 6c69 656e 7460 602e 0a0a 2020 2020 5468  lient``...    Th
+0001d2a0: 6520 6060 636f 6e74 6163 745f 6164 6472  e ``contact_addr
+0001d2b0: 6573 7360 6020 7061 7261 6d65 7465 7220  ess`` parameter 
+0001d2c0: 616c 6c6f 7773 2074 6f20 6164 7665 7274  allows to advert
+0001d2d0: 6973 6520 6120 7370 6563 6966 6963 2061  ise a specific a
+0001d2e0: 6464 7265 7373 2074 6f0a 2020 2020 7468  ddress to.    th
+0001d2f0: 6520 776f 726b 6572 7320 666f 7220 636f  e workers for co
+0001d300: 6d6d 756e 6963 6174 696f 6e20 7769 7468  mmunication with
+0001d310: 2074 6865 2073 6368 6564 756c 6572 2c20   the scheduler, 
+0001d320: 7768 6963 6820 6973 2064 6966 6665 7265  which is differe
+0001d330: 6e74 2074 6861 6e0a 2020 2020 7468 6520  nt than.    the 
+0001d340: 6164 6472 6573 7320 7468 6520 7363 6865  address the sche
+0001d350: 6475 6c65 7220 6269 6e64 7320 746f 2e20  duler binds to. 
+0001d360: 5468 6973 2069 7320 7573 6566 756c 2077  This is useful w
+0001d370: 6865 6e20 7468 6520 7363 6865 6475 6c65  hen the schedule
+0001d380: 720a 2020 2020 6c69 7374 656e 7320 6f6e  r.    listens on
+0001d390: 2061 2070 7269 7661 7465 2061 6464 7265   a private addre
+0001d3a0: 7373 2c20 7768 6963 6820 7468 6572 6566  ss, which theref
+0001d3b0: 6f72 6520 6361 6e6e 6f74 2062 6520 7573  ore cannot be us
+0001d3c0: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
+0001d3d0: 730a 2020 2020 746f 2063 6f6e 7461 6374  s.    to contact
+0001d3e0: 2069 742e 0a0a 2020 2020 2a2a 5374 6174   it...    **Stat
+0001d3f0: 652a 2a0a 0a20 2020 2054 6865 2073 6368  e**..    The sch
+0001d400: 6564 756c 6572 2063 6f6e 7461 696e 7320  eduler contains 
+0001d410: 7468 6520 666f 6c6c 6f77 696e 6720 7374  the following st
+0001d420: 6174 6520 7661 7269 6162 6c65 732e 2020  ate variables.  
+0001d430: 4561 6368 2076 6172 6961 626c 6520 6973  Each variable is
+0001d440: 0a20 2020 206c 6973 7465 6420 616c 6f6e  .    listed alon
+0001d450: 6720 7769 7468 2077 6861 7420 6974 2073  g with what it s
+0001d460: 746f 7265 7320 616e 6420 6120 6272 6965  tores and a brie
+0001d470: 6620 6465 7363 7269 7074 696f 6e2e 0a0a  f description...
+0001d480: 2020 2020 2a20 2a2a 7461 736b 733a 2a2a      * **tasks:**
+0001d490: 2060 607b 7461 736b 206b 6579 3a20 5461   ``{task key: Ta
+0001d4a0: 736b 5374 6174 657d 6060 0a20 2020 2020  skState}``.     
+0001d4b0: 2020 2054 6173 6b73 2063 7572 7265 6e74     Tasks current
+0001d4c0: 6c79 206b 6e6f 776e 2074 6f20 7468 6520  ly known to the 
+0001d4d0: 7363 6865 6475 6c65 720a 2020 2020 2a20  scheduler.    * 
+0001d4e0: 2a2a 756e 7275 6e6e 6162 6c65 3a2a 2a20  **unrunnable:** 
+0001d4f0: 6060 7b54 6173 6b53 7461 7465 7d60 600a  ``{TaskState}``.
+0001d500: 2020 2020 2020 2020 5461 736b 7320 696e          Tasks in
+0001d510: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
+0001d520: 2073 7461 7465 0a0a 2020 2020 2a20 2a2a   state..    * **
+0001d530: 776f 726b 6572 733a 2a2a 2060 607b 776f  workers:** ``{wo
+0001d540: 726b 6572 206b 6579 3a20 576f 726b 6572  rker key: Worker
+0001d550: 5374 6174 657d 6060 0a20 2020 2020 2020  State}``.       
+0001d560: 2057 6f72 6b65 7273 2063 7572 7265 6e74   Workers current
+0001d570: 6c79 2063 6f6e 6e65 6374 6564 2074 6f20  ly connected to 
+0001d580: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
+0001d590: 2020 2a20 2a2a 6964 6c65 3a2a 2a20 6060    * **idle:** ``
+0001d5a0: 7b57 6f72 6b65 7253 7461 7465 7d60 603a  {WorkerState}``:
+0001d5b0: 0a20 2020 2020 2020 2053 6574 206f 6620  .        Set of 
+0001d5c0: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
+0001d5d0: 206e 6f74 2066 756c 6c79 2075 7469 6c69   not fully utili
+0001d5e0: 7a65 640a 2020 2020 2a20 2a2a 7361 7475  zed.    * **satu
+0001d5f0: 7261 7465 643a 2a2a 2060 607b 576f 726b  rated:** ``{Work
+0001d600: 6572 5374 6174 657d 6060 3a0a 2020 2020  erState}``:.    
+0001d610: 2020 2020 5365 7420 6f66 2077 6f72 6b65      Set of worke
+0001d620: 7273 2074 6861 7420 6172 6520 6e6f 7420  rs that are not 
+0001d630: 6f76 6572 2d75 7469 6c69 7a65 640a 0a20  over-utilized.. 
+0001d640: 2020 202a 202a 2a68 6f73 745f 696e 666f     * **host_info
+0001d650: 3a2a 2a20 6060 7b68 6f73 746e 616d 653a  :** ``{hostname:
+0001d660: 2064 6963 747d 6060 3a0a 2020 2020 2020   dict}``:.      
+0001d670: 2020 496e 666f 726d 6174 696f 6e20 6162    Information ab
+0001d680: 6f75 7420 6561 6368 2077 6f72 6b65 7220  out each worker 
+0001d690: 686f 7374 0a0a 2020 2020 2a20 2a2a 636c  host..    * **cl
+0001d6a0: 6965 6e74 733a 2a2a 2060 607b 636c 6965  ients:** ``{clie
+0001d6b0: 6e74 206b 6579 3a20 436c 6965 6e74 5374  nt key: ClientSt
+0001d6c0: 6174 657d 6060 0a20 2020 2020 2020 2043  ate}``.        C
+0001d6d0: 6c69 656e 7473 2063 7572 7265 6e74 6c79  lients currently
+0001d6e0: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
+0001d6f0: 6520 7363 6865 6475 6c65 720a 0a20 2020  e scheduler..   
+0001d700: 202a 202a 2a73 6572 7669 6365 733a 2a2a   * **services:**
+0001d710: 2060 607b 7374 723a 2070 6f72 747d 6060   ``{str: port}``
+0001d720: 3a0a 2020 2020 2020 2020 4f74 6865 7220  :.        Other 
+0001d730: 7365 7276 6963 6573 2072 756e 6e69 6e67  services running
+0001d740: 206f 6e20 7468 6973 2073 6368 6564 756c   on this schedul
+0001d750: 6572 2c20 6c69 6b65 2042 6f6b 6568 0a20  er, like Bokeh. 
+0001d760: 2020 202a 202a 2a6c 6f6f 703a 2a2a 2060     * **loop:** `
+0001d770: 6049 4f4c 6f6f 7060 603a 0a20 2020 2020  `IOLoop``:.     
+0001d780: 2020 2054 6865 2072 756e 6e69 6e67 2054     The running T
+0001d790: 6f72 6e61 646f 2049 4f4c 6f6f 700a 2020  ornado IOLoop.  
+0001d7a0: 2020 2a20 2a2a 636c 6965 6e74 5f63 6f6d    * **client_com
+0001d7b0: 6d73 3a2a 2a20 6060 7b63 6c69 656e 7420  ms:** ``{client 
+0001d7c0: 6b65 793a 2043 6f6d 6d7d 6060 0a20 2020  key: Comm}``.   
+0001d7d0: 2020 2020 2046 6f72 2065 6163 6820 636c       For each cl
+0001d7e0: 6965 6e74 2c20 6120 436f 6d6d 206f 626a  ient, a Comm obj
+0001d7f0: 6563 7420 7573 6564 2074 6f20 7265 6365  ect used to rece
+0001d800: 6976 6520 7461 736b 2072 6571 7565 7374  ive task request
+0001d810: 7320 616e 640a 2020 2020 2020 2020 7265  s and.        re
+0001d820: 706f 7274 2074 6173 6b20 7374 6174 7573  port task status
+0001d830: 2075 7064 6174 6573 2e0a 2020 2020 2a20   updates..    * 
+0001d840: 2a2a 7374 7265 616d 5f63 6f6d 6d73 3a2a  **stream_comms:*
+0001d850: 2a20 6060 7b77 6f72 6b65 7220 6b65 793a  * ``{worker key:
+0001d860: 2043 6f6d 6d7d 6060 0a20 2020 2020 2020   Comm}``.       
+0001d870: 2046 6f72 2065 6163 6820 776f 726b 6572   For each worker
+0001d880: 2c20 6120 436f 6d6d 206f 626a 6563 7420  , a Comm object 
+0001d890: 6672 6f6d 2077 6869 6368 2077 6520 626f  from which we bo
+0001d8a0: 7468 2061 6363 6570 7420 7374 696d 756c  th accept stimul
+0001d8b0: 6920 616e 640a 2020 2020 2020 2020 7265  i and.        re
+0001d8c0: 706f 7274 2072 6573 756c 7473 0a20 2020  port results.   
+0001d8d0: 202a 202a 2a74 6173 6b5f 6475 7261 7469   * **task_durati
+0001d8e0: 6f6e 3a2a 2a20 6060 7b6b 6579 2d70 7265  on:** ``{key-pre
+0001d8f0: 6669 783a 2074 696d 657d 6060 0a20 2020  fix: time}``.   
+0001d900: 2020 2020 2054 696d 6520 7765 2065 7870       Time we exp
+0001d910: 6563 7420 6365 7274 6169 6e20 6675 6e63  ect certain func
+0001d920: 7469 6f6e 7320 746f 2074 616b 652c 2065  tions to take, e
+0001d930: 2e67 2e20 6060 7b27 7375 6d27 3a20 302e  .g. ``{'sum': 0.
+0001d940: 3235 7d60 600a 2020 2020 2222 220a 0a20  25}``.    """.. 
+0001d950: 2020 2064 6566 6175 6c74 5f70 6f72 7420     default_port 
+0001d960: 3d20 3837 3836 0a20 2020 205f 696e 7374  = 8786.    _inst
+0001d970: 616e 6365 733a 2043 6c61 7373 5661 725b  ances: ClassVar[
+0001d980: 7765 616b 7265 662e 5765 616b 5365 745b  weakref.WeakSet[
+0001d990: 5363 6865 6475 6c65 725d 5d20 3d20 7765  Scheduler]] = we
+0001d9a0: 616b 7265 662e 5765 616b 5365 7428 290a  akref.WeakSet().
+0001d9b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0001d9c0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+0001d9d0: 0a20 2020 2020 2020 206c 6f6f 703d 4e6f  .        loop=No
+0001d9e0: 6e65 2c0a 2020 2020 2020 2020 6465 6c65  ne,.        dele
+0001d9f0: 7465 5f69 6e74 6572 7661 6c3d 2235 3030  te_interval="500
+0001da00: 6d73 222c 0a20 2020 2020 2020 2073 796e  ms",.        syn
+0001da10: 6368 726f 6e69 7a65 5f77 6f72 6b65 725f  chronize_worker_
+0001da20: 696e 7465 7276 616c 3d22 3630 7322 2c0a  interval="60s",.
+0001da30: 2020 2020 2020 2020 7365 7276 6963 6573          services
+0001da40: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
+0001da50: 6572 7669 6365 5f6b 7761 7267 733d 4e6f  ervice_kwargs=No
+0001da60: 6e65 2c0a 2020 2020 2020 2020 616c 6c6f  ne,.        allo
+0001da70: 7765 645f 6661 696c 7572 6573 3d4e 6f6e  wed_failures=Non
+0001da80: 652c 0a20 2020 2020 2020 2065 7874 656e  e,.        exten
+0001da90: 7369 6f6e 733d 4e6f 6e65 2c0a 2020 2020  sions=None,.    
+0001daa0: 2020 2020 7661 6c69 6461 7465 3d4e 6f6e      validate=Non
+0001dab0: 652c 0a20 2020 2020 2020 2073 6368 6564  e,.        sched
+0001dac0: 756c 6572 5f66 696c 653d 4e6f 6e65 2c0a  uler_file=None,.
+0001dad0: 2020 2020 2020 2020 7365 6375 7269 7479          security
+0001dae0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
+0001daf0: 6f72 6b65 725f 7474 6c3d 4e6f 6e65 2c0a  orker_ttl=None,.
+0001db00: 2020 2020 2020 2020 6964 6c65 5f74 696d          idle_tim
+0001db10: 656f 7574 3d4e 6f6e 652c 0a20 2020 2020  eout=None,.     
+0001db20: 2020 2069 6e74 6572 6661 6365 3d4e 6f6e     interface=Non
+0001db30: 652c 0a20 2020 2020 2020 2068 6f73 743d  e,.        host=
+0001db40: 4e6f 6e65 2c0a 2020 2020 2020 2020 706f  None,.        po
+0001db50: 7274 3d30 2c0a 2020 2020 2020 2020 7072  rt=0,.        pr
+0001db60: 6f74 6f63 6f6c 3d4e 6f6e 652c 0a20 2020  otocol=None,.   
+0001db70: 2020 2020 2064 6173 6862 6f61 7264 5f61       dashboard_a
+0001db80: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
+0001db90: 2020 2020 2064 6173 6862 6f61 7264 3d4e       dashboard=N
+0001dba0: 6f6e 652c 0a20 2020 2020 2020 2068 7474  one,.        htt
+0001dbb0: 705f 7072 6566 6978 3d22 2f22 2c0a 2020  p_prefix="/",.  
+0001dbc0: 2020 2020 2020 7072 656c 6f61 643d 4e6f        preload=No
+0001dbd0: 6e65 2c0a 2020 2020 2020 2020 7072 656c  ne,.        prel
+0001dbe0: 6f61 645f 6172 6776 3d28 292c 0a20 2020  oad_argv=(),.   
+0001dbf0: 2020 2020 2070 6c75 6769 6e73 3d28 292c       plugins=(),
+0001dc00: 0a20 2020 2020 2020 2063 6f6e 7461 6374  .        contact
+0001dc10: 5f61 6464 7265 7373 3d4e 6f6e 652c 0a20  _address=None,. 
+0001dc20: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
+0001dc30: 6e5f 636f 756e 7465 725f 6d61 783d 4661  n_counter_max=Fa
+0001dc40: 6c73 652c 0a20 2020 2020 2020 206a 7570  lse,.        jup
+0001dc50: 7974 6572 3d46 616c 7365 2c0a 2020 2020  yter=False,.    
+0001dc60: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0001dc70: 2020 293a 0a20 2020 2020 2020 2069 6620    ):.        if 
+0001dc80: 6c6f 6f70 2069 7320 6e6f 7420 4e6f 6e65  loop is not None
+0001dc90: 3a0a 2020 2020 2020 2020 2020 2020 7761  :.            wa
+0001dca0: 726e 696e 6773 2e77 6172 6e28 0a20 2020  rnings.warn(.   
+0001dcb0: 2020 2020 2020 2020 2020 2020 2022 7468               "th
+0001dcc0: 6520 6c6f 6f70 206b 7761 7267 2074 6f20  e loop kwarg to 
+0001dcd0: 5363 6865 6475 6c65 7220 6973 2064 6570  Scheduler is dep
+0001dce0: 7265 6361 7465 6422 2c0a 2020 2020 2020  recated",.      
+0001dcf0: 2020 2020 2020 2020 2020 4465 7072 6563            Deprec
+0001dd00: 6174 696f 6e57 6172 6e69 6e67 2c0a 2020  ationWarning,.  
+0001dd10: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001dd20: 6163 6b6c 6576 656c 3d32 2c0a 2020 2020  acklevel=2,.    
+0001dd30: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001dd40: 2020 2073 656c 662e 6c6f 6f70 203d 2073     self.loop = s
+0001dd50: 656c 662e 696f 5f6c 6f6f 7020 3d20 494f  elf.io_loop = IO
+0001dd60: 4c6f 6f70 2e63 7572 7265 6e74 2829 0a20  Loop.current(). 
+0001dd70: 2020 2020 2020 2073 656c 662e 5f73 6574         self._set
+0001dd80: 7570 5f6c 6f67 6769 6e67 286c 6f67 6765  up_logging(logge
+0001dd90: 7229 0a0a 2020 2020 2020 2020 2320 4174  r)..        # At
+0001dda0: 7472 6962 7574 6573 0a20 2020 2020 2020  tributes.       
+0001ddb0: 2069 6620 636f 6e74 6163 745f 6164 6472   if contact_addr
+0001ddc0: 6573 7320 6973 204e 6f6e 653a 0a20 2020  ess is None:.   
+0001ddd0: 2020 2020 2020 2020 2063 6f6e 7461 6374           contact
+0001dde0: 5f61 6464 7265 7373 203d 2064 6173 6b2e  _address = dask.
+0001ddf0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001de00: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001de10: 722e 636f 6e74 6163 742d 6164 6472 6573  r.contact-addres
+0001de20: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
+0001de30: 2e63 6f6e 7461 6374 5f61 6464 7265 7373  .contact_address
+0001de40: 203d 2063 6f6e 7461 6374 5f61 6464 7265   = contact_addre
+0001de50: 7373 0a20 2020 2020 2020 2069 6620 616c  ss.        if al
+0001de60: 6c6f 7765 645f 6661 696c 7572 6573 2069  lowed_failures i
+0001de70: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001de80: 2020 2020 616c 6c6f 7765 645f 6661 696c      allowed_fail
+0001de90: 7572 6573 203d 2064 6173 6b2e 636f 6e66  ures = dask.conf
+0001dea0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0001deb0: 7465 642e 7363 6865 6475 6c65 722e 616c  ted.scheduler.al
+0001dec0: 6c6f 7765 642d 6661 696c 7572 6573 2229  lowed-failures")
+0001ded0: 0a20 2020 2020 2020 2073 656c 662e 616c  .        self.al
+0001dee0: 6c6f 7765 645f 6661 696c 7572 6573 203d  lowed_failures =
+0001def0: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
+0001df00: 730a 2020 2020 2020 2020 6966 2076 616c  s.        if val
+0001df10: 6964 6174 6520 6973 204e 6f6e 653a 0a20  idate is None:. 
+0001df20: 2020 2020 2020 2020 2020 2076 616c 6964             valid
+0001df30: 6174 6520 3d20 6461 736b 2e63 6f6e 6669  ate = dask.confi
+0001df40: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+0001df50: 6564 2e73 6368 6564 756c 6572 2e76 616c  ed.scheduler.val
+0001df60: 6964 6174 6522 290a 2020 2020 2020 2020  idate").        
+0001df70: 7365 6c66 2e70 726f 6320 3d20 7073 7574  self.proc = psut
+0001df80: 696c 2e50 726f 6365 7373 2829 0a20 2020  il.Process().   
+0001df90: 2020 2020 2073 656c 662e 6465 6c65 7465       self.delete
+0001dfa0: 5f69 6e74 6572 7661 6c20 3d20 7061 7273  _interval = pars
+0001dfb0: 655f 7469 6d65 6465 6c74 6128 6465 6c65  e_timedelta(dele
+0001dfc0: 7465 5f69 6e74 6572 7661 6c2c 2064 6566  te_interval, def
+0001dfd0: 6175 6c74 3d22 6d73 2229 0a20 2020 2020  ault="ms").     
+0001dfe0: 2020 2073 656c 662e 7379 6e63 6872 6f6e     self.synchron
+0001dff0: 697a 655f 776f 726b 6572 5f69 6e74 6572  ize_worker_inter
+0001e000: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
+0001e010: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
+0001e020: 2020 2073 796e 6368 726f 6e69 7a65 5f77     synchronize_w
+0001e030: 6f72 6b65 725f 696e 7465 7276 616c 2c20  orker_interval, 
+0001e040: 6465 6661 756c 743d 226d 7322 0a20 2020  default="ms".   
+0001e050: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0001e060: 656c 662e 7365 7276 6963 655f 7370 6563  elf.service_spec
+0001e070: 7320 3d20 7365 7276 6963 6573 206f 7220  s = services or 
+0001e080: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0001e090: 7365 7276 6963 655f 6b77 6172 6773 203d  service_kwargs =
+0001e0a0: 2073 6572 7669 6365 5f6b 7761 7267 7320   service_kwargs 
+0001e0b0: 6f72 207b 7d0a 2020 2020 2020 2020 7365  or {}.        se
+0001e0c0: 6c66 2e73 6572 7669 6365 7320 3d20 7b7d  lf.services = {}
+0001e0d0: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+0001e0e0: 6865 6475 6c65 725f 6669 6c65 203d 2073  heduler_file = s
+0001e0f0: 6368 6564 756c 6572 5f66 696c 650a 2020  cheduler_file.  
+0001e100: 2020 2020 2020 776f 726b 6572 5f74 746c        worker_ttl
+0001e110: 203d 2077 6f72 6b65 725f 7474 6c20 6f72   = worker_ttl or
+0001e120: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0001e130: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001e140: 6865 6475 6c65 722e 776f 726b 6572 2d74  heduler.worker-t
+0001e150: 746c 2229 0a20 2020 2020 2020 2073 656c  tl").        sel
+0001e160: 662e 776f 726b 6572 5f74 746c 203d 2070  f.worker_ttl = p
+0001e170: 6172 7365 5f74 696d 6564 656c 7461 2877  arse_timedelta(w
+0001e180: 6f72 6b65 725f 7474 6c29 2069 6620 776f  orker_ttl) if wo
+0001e190: 726b 6572 5f74 746c 2065 6c73 6520 4e6f  rker_ttl else No
+0001e1a0: 6e65 0a20 2020 2020 2020 2069 646c 655f  ne.        idle_
+0001e1b0: 7469 6d65 6f75 7420 3d20 6964 6c65 5f74  timeout = idle_t
+0001e1c0: 696d 656f 7574 206f 7220 6461 736b 2e63  imeout or dask.c
+0001e1d0: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
+0001e1e0: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
+0001e1f0: 7465 642e 7363 6865 6475 6c65 722e 6964  ted.scheduler.id
+0001e200: 6c65 2d74 696d 656f 7574 220a 2020 2020  le-timeout".    
+0001e210: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+0001e220: 2069 646c 655f 7469 6d65 6f75 743a 0a20   idle_timeout:. 
+0001e230: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001e240: 6964 6c65 5f74 696d 656f 7574 203d 2070  idle_timeout = p
+0001e250: 6172 7365 5f74 696d 6564 656c 7461 2869  arse_timedelta(i
+0001e260: 646c 655f 7469 6d65 6f75 7429 0a20 2020  dle_timeout).   
+0001e270: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001e280: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0001e290: 5f74 696d 656f 7574 203d 204e 6f6e 650a  _timeout = None.
+0001e2a0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+0001e2b0: 655f 7369 6e63 6520 3d20 7469 6d65 2829  e_since = time()
+0001e2c0: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
+0001e2d0: 6d65 5f73 7461 7274 6564 203d 2073 656c  me_started = sel
+0001e2e0: 662e 6964 6c65 5f73 696e 6365 2020 2320  f.idle_since  # 
+0001e2f0: 636f 6d70 6174 6962 696c 6974 7920 666f  compatibility fo
+0001e300: 7220 6461 736b 2d67 6174 6577 6179 0a20  r dask-gateway. 
+0001e310: 2020 2020 2020 2073 656c 662e 5f6c 6f63         self._loc
+0001e320: 6b20 3d20 6173 796e 6369 6f2e 4c6f 636b  k = asyncio.Lock
+0001e330: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0001e340: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+0001e350: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
+0001e360: 666c 6f61 7429 0a20 2020 2020 2020 2073  float).        s
+0001e370: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
+0001e380: 7065 7320 3d20 6465 6661 756c 7464 6963  pes = defaultdic
+0001e390: 7428 666c 6f61 7429 0a0a 2020 2020 2020  t(float)..      
+0001e3a0: 2020 7365 6c66 2e63 756d 756c 6174 6976    self.cumulativ
+0001e3b0: 655f 776f 726b 6572 5f6d 6574 7269 6373  e_worker_metrics
+0001e3c0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+0001e3d0: 6c6f 6174 290a 0a20 2020 2020 2020 2069  loat)..        i
+0001e3e0: 6620 6e6f 7420 7072 656c 6f61 643a 0a20  f not preload:. 
+0001e3f0: 2020 2020 2020 2020 2020 2070 7265 6c6f             prelo
+0001e400: 6164 203d 2064 6173 6b2e 636f 6e66 6967  ad = dask.config
+0001e410: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001e420: 642e 7363 6865 6475 6c65 722e 7072 656c  d.scheduler.prel
+0001e430: 6f61 6422 290a 2020 2020 2020 2020 6966  oad").        if
+0001e440: 206e 6f74 2070 7265 6c6f 6164 5f61 7267   not preload_arg
+0001e450: 763a 0a20 2020 2020 2020 2020 2020 2070  v:.            p
+0001e460: 7265 6c6f 6164 5f61 7267 7620 3d20 6461  reload_argv = da
+0001e470: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0001e480: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001e490: 756c 6572 2e70 7265 6c6f 6164 2d61 7267  uler.preload-arg
+0001e4a0: 7622 290a 2020 2020 2020 2020 7365 6c66  v").        self
+0001e4b0: 2e70 7265 6c6f 6164 7320 3d20 7072 656c  .preloads = prel
+0001e4c0: 6f61 6469 6e67 2e70 726f 6365 7373 5f70  oading.process_p
+0001e4d0: 7265 6c6f 6164 7328 7365 6c66 2c20 7072  reloads(self, pr
+0001e4e0: 656c 6f61 642c 2070 7265 6c6f 6164 5f61  eload, preload_a
+0001e4f0: 7267 7629 0a0a 2020 2020 2020 2020 6966  rgv)..        if
+0001e500: 2069 7369 6e73 7461 6e63 6528 7365 6375   isinstance(secu
+0001e510: 7269 7479 2c20 6469 6374 293a 0a20 2020  rity, dict):.   
+0001e520: 2020 2020 2020 2020 2073 6563 7572 6974           securit
+0001e530: 7920 3d20 5365 6375 7269 7479 282a 2a73  y = Security(**s
+0001e540: 6563 7572 6974 7929 0a20 2020 2020 2020  ecurity).       
+0001e550: 2073 656c 662e 7365 6375 7269 7479 203d   self.security =
+0001e560: 2073 6563 7572 6974 7920 6f72 2053 6563   security or Sec
+0001e570: 7572 6974 7928 290a 2020 2020 2020 2020  urity().        
+0001e580: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0001e590: 6528 7365 6c66 2e73 6563 7572 6974 792c  e(self.security,
+0001e5a0: 2053 6563 7572 6974 7929 0a20 2020 2020   Security).     
+0001e5b0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0001e5c0: 6f6e 5f61 7267 7320 3d20 7365 6c66 2e73  on_args = self.s
+0001e5d0: 6563 7572 6974 792e 6765 745f 636f 6e6e  ecurity.get_conn
+0001e5e0: 6563 7469 6f6e 5f61 7267 7328 2273 6368  ection_args("sch
+0001e5f0: 6564 756c 6572 2229 0a20 2020 2020 2020  eduler").       
+0001e600: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001e610: 5f61 7267 735b 2268 616e 6473 6861 6b65  _args["handshake
+0001e620: 5f6f 7665 7272 6964 6573 225d 203d 207b  _overrides"] = {
+0001e630: 2020 2320 636f 6d6d 6f6e 2064 656e 6f6d    # common denom
+0001e640: 696e 6174 6f72 0a20 2020 2020 2020 2020  inator.         
+0001e650: 2020 2022 7069 636b 6c65 2d70 726f 746f     "pickle-proto
+0001e660: 636f 6c22 3a20 340a 2020 2020 2020 2020  col": 4.        
+0001e670: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
+0001e680: 5f73 7461 7274 5f61 6464 7265 7373 203d  _start_address =
+0001e690: 2061 6464 7265 7373 6573 5f66 726f 6d5f   addresses_from_
+0001e6a0: 7573 6572 5f61 7267 7328 0a20 2020 2020  user_args(.     
+0001e6b0: 2020 2020 2020 2068 6f73 743d 686f 7374         host=host
+0001e6c0: 2c0a 2020 2020 2020 2020 2020 2020 706f  ,.            po
+0001e6d0: 7274 3d70 6f72 742c 0a20 2020 2020 2020  rt=port,.       
+0001e6e0: 2020 2020 2069 6e74 6572 6661 6365 3d69       interface=i
+0001e6f0: 6e74 6572 6661 6365 2c0a 2020 2020 2020  nterface,.      
+0001e700: 2020 2020 2020 7072 6f74 6f63 6f6c 3d70        protocol=p
+0001e710: 726f 746f 636f 6c2c 0a20 2020 2020 2020  rotocol,.       
+0001e720: 2020 2020 2073 6563 7572 6974 793d 7365       security=se
+0001e730: 6375 7269 7479 2c0a 2020 2020 2020 2020  curity,.        
+0001e740: 2020 2020 6465 6661 756c 745f 706f 7274      default_port
+0001e750: 3d73 656c 662e 6465 6661 756c 745f 706f  =self.default_po
+0001e760: 7274 2c0a 2020 2020 2020 2020 290a 0a20  rt,.        ).. 
+0001e770: 2020 2020 2020 2068 7474 705f 7365 7276         http_serv
+0001e780: 6572 5f6d 6f64 756c 6573 203d 2064 6173  er_modules = das
+0001e790: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+0001e7a0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0001e7b0: 6c65 722e 6874 7470 2e72 6f75 7465 7322  ler.http.routes"
+0001e7c0: 290a 2020 2020 2020 2020 7368 6f77 5f64  ).        show_d
+0001e7d0: 6173 6862 6f61 7264 203d 2064 6173 6862  ashboard = dashb
+0001e7e0: 6f61 7264 206f 7220 2864 6173 6862 6f61  oard or (dashboa
+0001e7f0: 7264 2069 7320 4e6f 6e65 2061 6e64 2064  rd is None and d
+0001e800: 6173 6862 6f61 7264 5f61 6464 7265 7373  ashboard_address
+0001e810: 290a 2020 2020 2020 2020 2320 696e 7374  ).        # inst
+0001e820: 616c 6c20 7661 6e69 6c6c 6120 726f 7574  all vanilla rout
+0001e830: 6520 6966 2073 686f 775f 6461 7368 626f  e if show_dashbo
+0001e840: 6172 6420 6275 7420 626f 6b65 6820 6973  ard but bokeh is
+0001e850: 206e 6f74 2069 6e73 7461 6c6c 6564 0a20   not installed. 
+0001e860: 2020 2020 2020 2069 6620 7368 6f77 5f64         if show_d
+0001e870: 6173 6862 6f61 7264 3a0a 2020 2020 2020  ashboard:.      
+0001e880: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001e890: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
+0001e8a0: 7420 6469 7374 7269 6275 7465 642e 6461  t distributed.da
+0001e8b0: 7368 626f 6172 642e 7363 6865 6475 6c65  shboard.schedule
+0001e8c0: 720a 2020 2020 2020 2020 2020 2020 6578  r.            ex
+0001e8d0: 6365 7074 2049 6d70 6f72 7445 7272 6f72  cept ImportError
+0001e8e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e8f0: 2020 7368 6f77 5f64 6173 6862 6f61 7264    show_dashboard
+0001e900: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0001e910: 2020 2020 2020 2020 2068 7474 705f 7365           http_se
+0001e920: 7276 6572 5f6d 6f64 756c 6573 2e61 7070  rver_modules.app
+0001e930: 656e 6428 2264 6973 7472 6962 7574 6564  end("distributed
+0001e940: 2e68 7474 702e 7363 6865 6475 6c65 722e  .http.scheduler.
+0001e950: 6d69 7373 696e 675f 626f 6b65 6822 290a  missing_bokeh").
+0001e960: 2020 2020 2020 2020 726f 7574 6573 203d          routes =
+0001e970: 2067 6574 5f68 616e 646c 6572 7328 0a20   get_handlers(. 
+0001e980: 2020 2020 2020 2020 2020 2073 6572 7665             serve
+0001e990: 723d 7365 6c66 2c20 6d6f 6475 6c65 733d  r=self, modules=
+0001e9a0: 6874 7470 5f73 6572 7665 725f 6d6f 6475  http_server_modu
+0001e9b0: 6c65 732c 2070 7265 6669 783d 6874 7470  les, prefix=http
+0001e9c0: 5f70 7265 6669 780a 2020 2020 2020 2020  _prefix.        
+0001e9d0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+0001e9e0: 7461 7274 5f68 7474 705f 7365 7276 6572  tart_http_server
+0001e9f0: 2872 6f75 7465 732c 2064 6173 6862 6f61  (routes, dashboa
+0001ea00: 7264 5f61 6464 7265 7373 2c20 6465 6661  rd_address, defa
+0001ea10: 756c 745f 706f 7274 3d38 3738 3729 0a20  ult_port=8787). 
+0001ea20: 2020 2020 2020 2073 656c 662e 6a75 7079         self.jupy
+0001ea30: 7465 7220 3d20 6a75 7079 7465 720a 2020  ter = jupyter.  
+0001ea40: 2020 2020 2020 6966 2073 686f 775f 6461        if show_da
+0001ea50: 7368 626f 6172 643a 0a20 2020 2020 2020  shboard:.       
+0001ea60: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
+0001ea70: 2e64 6173 6862 6f61 7264 2e73 6368 6564  .dashboard.sched
+0001ea80: 756c 6572 2e63 6f6e 6e65 6374 280a 2020  uler.connect(.  
+0001ea90: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001eaa0: 6c66 2e68 7474 705f 6170 706c 6963 6174  lf.http_applicat
+0001eab0: 696f 6e2c 2073 656c 662e 6874 7470 5f73  ion, self.http_s
+0001eac0: 6572 7665 722c 2073 656c 662c 2070 7265  erver, self, pre
+0001ead0: 6669 783d 6874 7470 5f70 7265 6669 780a  fix=http_prefix.
+0001eae0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001eaf0: 2020 2020 2020 6966 2073 656c 662e 6a75        if self.ju
+0001eb00: 7079 7465 723a 0a20 2020 2020 2020 2020  pyter:.         
+0001eb10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001eb20: 2020 2020 2020 2020 6672 6f6d 206a 7570          from jup
+0001eb30: 7974 6572 5f73 6572 7665 722e 7365 7276  yter_server.serv
+0001eb40: 6572 6170 7020 696d 706f 7274 2053 6572  erapp import Ser
+0001eb50: 7665 7241 7070 0a20 2020 2020 2020 2020  verApp.         
+0001eb60: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
+0001eb70: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0001eb80: 2020 2020 2020 2072 6169 7365 2049 6d70         raise Imp
+0001eb90: 6f72 7445 7272 6f72 280a 2020 2020 2020  ortError(.      
+0001eba0: 2020 2020 2020 2020 2020 2020 2020 2249                "I
+0001ebb0: 6e20 6f72 6465 7220 746f 2075 7365 2074  n order to use t
+0001ebc0: 6865 2044 6173 6b20 6a75 7079 7465 7220  he Dask jupyter 
+0001ebd0: 6f70 7469 6f6e 2079 6f75 2022 0a20 2020  option you ".   
+0001ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ebf0: 2022 6e65 6564 2074 6f20 6861 7665 206a   "need to have j
+0001ec00: 7570 7974 6572 6c61 6220 696e 7374 616c  upyterlab instal
+0001ec10: 6c65 6422 0a20 2020 2020 2020 2020 2020  led".           
+0001ec20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001ec30: 2020 2066 726f 6d20 7472 6169 746c 6574     from traitlet
+0001ec40: 732e 636f 6e66 6967 2069 6d70 6f72 7420  s.config import 
+0001ec50: 436f 6e66 6967 0a0a 2020 2020 2020 2020  Config..        
+0001ec60: 2020 2020 6a20 3d20 5365 7276 6572 4170      j = ServerAp
+0001ec70: 702e 696e 7374 616e 6365 280a 2020 2020  p.instance(.    
+0001ec80: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+0001ec90: 6967 3d43 6f6e 6669 6728 0a20 2020 2020  ig=Config(.     
+0001eca0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0001ecb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ecc0: 2020 2020 2020 2020 2022 5365 7276 6572           "Server
+0001ecd0: 4170 7022 3a20 7b0a 2020 2020 2020 2020  App": {.        
+0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ecf0: 2020 2020 2262 6173 655f 7572 6c22 3a20      "base_url": 
+0001ed00: 226a 7570 7974 6572 222c 0a20 2020 2020  "jupyter",.     
+0001ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed20: 2020 2020 2020 2023 2053 4543 5552 4954         # SECURIT
+0001ed30: 593a 2057 6520 7573 7561 6c6c 7920 6578  Y: We usually ex
+0001ed40: 7065 6374 2074 6865 2064 6173 6862 6f61  pect the dashboa
+0001ed50: 7264 2074 6f20 6265 2061 2072 6561 642d  rd to be a read-
+0001ed60: 6f6e 6c79 2076 6965 7720 696e 746f 0a20  only view into. 
+0001ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed80: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+0001ed90: 2073 6368 6564 756c 6572 2061 6374 6976   scheduler activ
+0001eda0: 6974 792e 2048 6f77 6576 6572 2c20 6279  ity. However, by
+0001edb0: 2061 6464 696e 6720 616e 206f 7065 6e20   adding an open 
+0001edc0: 4a75 7079 7465 7220 6170 706c 6963 6174  Jupyter applicat
+0001edd0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edf0: 2320 7765 2061 7265 2061 6c6c 6f77 696e  # we are allowin
+0001ee00: 6720 6172 6269 7472 6172 7920 7265 6d6f  g arbitrary remo
+0001ee10: 7465 2063 6f64 6520 6578 6563 7574 696f  te code executio
+0001ee20: 6e20 6f6e 2074 6865 2073 6368 6564 756c  n on the schedul
+0001ee30: 6572 2076 6961 2074 6865 0a20 2020 2020  er via the.     
+0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee50: 2020 2020 2020 2023 2064 6173 6862 6f61         # dashboa
+0001ee60: 7264 2073 6572 7665 722e 2054 6869 7320  rd server. This 
+0001ee70: 6f70 7469 6f6e 2073 686f 756c 6420 6f6e  option should on
+0001ee80: 6c79 2062 6520 7573 6564 2077 6865 6e20  ly be used when 
+0001ee90: 7468 6520 6461 7368 626f 6172 6420 6973  the dashboard is
+0001eea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eeb0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0001eec0: 726f 7465 6374 6564 2076 6961 206f 7468  rotected via oth
+0001eed0: 6572 206d 6561 6e73 2c20 6f72 2077 6865  er means, or whe
+0001eee0: 6e20 796f 7520 646f 6e27 7420 6361 7265  n you don't care
+0001eef0: 2061 626f 7574 2063 6c75 7374 6572 2073   about cluster s
+0001ef00: 6563 7572 6974 792e 0a20 2020 2020 2020  ecurity..       
+0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef20: 2020 2020 2022 746f 6b65 6e22 3a20 2222       "token": ""
+0001ef30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ef40: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+0001ef50: 6c6c 6f77 5f72 656d 6f74 655f 6163 6365  llow_remote_acce
+0001ef60: 7373 223a 2054 7275 652c 0a20 2020 2020  ss": True,.     
+0001ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef80: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0001ef90: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0001efa0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001efb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001efc0: 2020 2020 2020 206a 2e69 6e69 7469 616c         j.initial
+0001efd0: 697a 6528 0a20 2020 2020 2020 2020 2020  ize(.           
+0001efe0: 2020 2020 206e 6577 5f68 7474 7073 6572       new_httpser
+0001eff0: 7665 723d 4661 6c73 652c 0a20 2020 2020  ver=False,.     
+0001f000: 2020 2020 2020 2020 2020 2061 7267 763d             argv=
+0001f010: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+0001f020: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001f030: 6c66 2e5f 6a75 7079 7465 725f 7365 7276  lf._jupyter_serv
+0001f040: 6572 5f61 7070 6c69 6361 7469 6f6e 203d  er_application =
+0001f050: 206a 0a20 2020 2020 2020 2020 2020 2073   j.            s
+0001f060: 656c 662e 6874 7470 5f61 7070 6c69 6361  elf.http_applica
+0001f070: 7469 6f6e 2e61 6464 5f61 7070 6c69 6361  tion.add_applica
+0001f080: 7469 6f6e 286a 2e77 6562 5f61 7070 290a  tion(j.web_app).
+0001f090: 0a20 2020 2020 2020 2023 2043 6f6d 6d75  .        # Commu
+0001f0a0: 6e69 6361 7469 6f6e 2073 7461 7465 0a20  nication state. 
+0001f0b0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+0001f0c0: 6e74 5f63 6f6d 6d73 203d 207b 7d0a 2020  nt_comms = {}.  
+0001f0d0: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
+0001f0e0: 6d5f 636f 6d6d 7320 3d20 7b7d 0a0a 2020  m_comms = {}..  
+0001f0f0: 2020 2020 2020 2320 5461 736b 2073 7461        # Task sta
+0001f100: 7465 0a20 2020 2020 2020 2074 6173 6b73  te.        tasks
+0001f110: 203d 207b 7d0a 0a20 2020 2020 2020 2073   = {}..        s
+0001f120: 656c 662e 6765 6e65 7261 7469 6f6e 203d  elf.generation =
+0001f130: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+0001f140: 5f6c 6173 745f 636c 6965 6e74 203d 204e  _last_client = N
+0001f150: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0001f160: 2e5f 6c61 7374 5f74 696d 6520 3d20 300a  ._last_time = 0.
+0001f170: 2020 2020 2020 2020 756e 7275 6e6e 6162          unrunnab
+0001f180: 6c65 203d 2073 6574 2829 0a20 2020 2020  le = set().     
+0001f190: 2020 2071 7565 7565 643a 2048 6561 7053     queued: HeapS
+0001f1a0: 6574 5b54 6173 6b53 7461 7465 5d20 3d20  et[TaskState] = 
+0001f1b0: 4865 6170 5365 7428 6b65 793d 6f70 6572  HeapSet(key=oper
+0001f1c0: 6174 6f72 2e61 7474 7267 6574 7465 7228  ator.attrgetter(
+0001f1d0: 2270 7269 6f72 6974 7922 2929 0a0a 2020  "priority"))..  
+0001f1e0: 2020 2020 2020 7365 6c66 2e64 6174 6173        self.datas
+0001f1f0: 6574 7320 3d20 7b7d 0a0a 2020 2020 2020  ets = {}..      
+0001f200: 2020 2320 5072 6566 6978 2d6b 6579 6564    # Prefix-keyed
+0001f210: 2063 6f6e 7461 696e 6572 730a 0a20 2020   containers..   
+0001f220: 2020 2020 2023 2043 6c69 656e 7420 7374       # Client st
+0001f230: 6174 650a 2020 2020 2020 2020 636c 6965  ate.        clie
+0001f240: 6e74 7320 3d20 7b7d 0a0a 2020 2020 2020  nts = {}..      
+0001f250: 2020 2320 576f 726b 6572 2073 7461 7465    # Worker state
+0001f260: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+0001f270: 203d 2053 6f72 7465 6444 6963 7428 290a   = SortedDict().
+0001f280: 0a20 2020 2020 2020 2068 6f73 745f 696e  .        host_in
+0001f290: 666f 203d 207b 7d0a 2020 2020 2020 2020  fo = {}.        
+0001f2a0: 7265 736f 7572 6365 7320 3d20 7b7d 0a20  resources = {}. 
+0001f2b0: 2020 2020 2020 2061 6c69 6173 6573 203d         aliases =
+0001f2c0: 207b 7d0a 0a20 2020 2020 2020 2073 656c   {}..        sel
+0001f2d0: 662e 5f77 6f72 6b65 725f 636f 6c6c 6563  f._worker_collec
+0001f2e0: 7469 6f6e 7320 3d20 5b0a 2020 2020 2020  tions = [.      
+0001f2f0: 2020 2020 2020 776f 726b 6572 732c 0a20        workers,. 
+0001f300: 2020 2020 2020 2020 2020 2068 6f73 745f             host_
+0001f310: 696e 666f 2c0a 2020 2020 2020 2020 2020  info,.          
+0001f320: 2020 7265 736f 7572 6365 732c 0a20 2020    resources,.   
+0001f330: 2020 2020 2020 2020 2061 6c69 6173 6573           aliases
+0001f340: 2c0a 2020 2020 2020 2020 5d0a 0a20 2020  ,.        ]..   
+0001f350: 2020 2020 2073 656c 662e 6576 656e 7473       self.events
+0001f360: 203d 2064 6566 6175 6c74 6469 6374 280a   = defaultdict(.
+0001f370: 2020 2020 2020 2020 2020 2020 7061 7274              part
+0001f380: 6961 6c28 0a20 2020 2020 2020 2020 2020  ial(.           
+0001f390: 2020 2020 2064 6571 7565 2c20 6d61 786c       deque, maxl
+0001f3a0: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
+0001f3b0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0001f3c0: 7363 6865 6475 6c65 722e 6576 656e 7473  scheduler.events
+0001f3d0: 2d6c 6f67 2d6c 656e 6774 6822 290a 2020  -log-length").  
+0001f3e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001f3f0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0001f400: 6c66 2e65 7665 6e74 5f63 6f75 6e74 7320  lf.event_counts 
+0001f410: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+0001f420: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
+0001f430: 6576 656e 745f 7375 6273 6372 6962 6572  event_subscriber
+0001f440: 203d 2064 6566 6175 6c74 6469 6374 2873   = defaultdict(s
+0001f450: 6574 290a 2020 2020 2020 2020 7365 6c66  et).        self
+0001f460: 2e77 6f72 6b65 725f 706c 7567 696e 7320  .worker_plugins 
+0001f470: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+0001f480: 662e 6e61 6e6e 795f 706c 7567 696e 7320  f.nanny_plugins 
+0001f490: 3d20 7b7d 0a0a 2020 2020 2020 2020 776f  = {}..        wo
+0001f4a0: 726b 6572 5f68 616e 646c 6572 7320 3d20  rker_handlers = 
+0001f4b0: 7b0a 2020 2020 2020 2020 2020 2020 2274  {.            "t
+0001f4c0: 6173 6b2d 6669 6e69 7368 6564 223a 2073  ask-finished": s
+0001f4d0: 656c 662e 6861 6e64 6c65 5f74 6173 6b5f  elf.handle_task_
+0001f4e0: 6669 6e69 7368 6564 2c0a 2020 2020 2020  finished,.      
+0001f4f0: 2020 2020 2020 2274 6173 6b2d 6572 7265        "task-erre
+0001f500: 6422 3a20 7365 6c66 2e68 616e 646c 655f  d": self.handle_
+0001f510: 7461 736b 5f65 7272 6564 2c0a 2020 2020  task_erred,.    
+0001f520: 2020 2020 2020 2020 2272 656c 6561 7365          "release
+0001f530: 2d77 6f72 6b65 722d 6461 7461 223a 2073  -worker-data": s
+0001f540: 656c 662e 7265 6c65 6173 655f 776f 726b  elf.release_work
+0001f550: 6572 5f64 6174 612c 0a20 2020 2020 2020  er_data,.       
+0001f560: 2020 2020 2022 6164 642d 6b65 7973 223a       "add-keys":
+0001f570: 2073 656c 662e 6164 645f 6b65 7973 2c0a   self.add_keys,.
+0001f580: 2020 2020 2020 2020 2020 2020 226c 6f6e              "lon
+0001f590: 672d 7275 6e6e 696e 6722 3a20 7365 6c66  g-running": self
+0001f5a0: 2e68 616e 646c 655f 6c6f 6e67 5f72 756e  .handle_long_run
+0001f5b0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+0001f5c0: 2020 2272 6573 6368 6564 756c 6522 3a20    "reschedule": 
+0001f5d0: 7365 6c66 2e5f 7265 7363 6865 6475 6c65  self._reschedule
+0001f5e0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
+0001f5f0: 6565 702d 616c 6976 6522 3a20 6c61 6d62  eep-alive": lamb
+0001f600: 6461 202a 6172 6773 2c20 2a2a 6b77 6172  da *args, **kwar
+0001f610: 6773 3a20 4e6f 6e65 2c0a 2020 2020 2020  gs: None,.      
+0001f620: 2020 2020 2020 226c 6f67 2d65 7665 6e74        "log-event
+0001f630: 223a 2073 656c 662e 6c6f 675f 776f 726b  ": self.log_work
+0001f640: 6572 5f65 7665 6e74 2c0a 2020 2020 2020  er_event,.      
+0001f650: 2020 2020 2020 2277 6f72 6b65 722d 7374        "worker-st
+0001f660: 6174 7573 2d63 6861 6e67 6522 3a20 7365  atus-change": se
+0001f670: 6c66 2e68 616e 646c 655f 776f 726b 6572  lf.handle_worker
+0001f680: 5f73 7461 7475 735f 6368 616e 6765 2c0a  _status_change,.
+0001f690: 2020 2020 2020 2020 2020 2020 2272 6571              "req
+0001f6a0: 7565 7374 2d72 6566 7265 7368 2d77 686f  uest-refresh-who
+0001f6b0: 2d68 6173 223a 2073 656c 662e 6861 6e64  -has": self.hand
+0001f6c0: 6c65 5f72 6571 7565 7374 5f72 6566 7265  le_request_refre
+0001f6d0: 7368 5f77 686f 5f68 6173 2c0a 2020 2020  sh_who_has,.    
+0001f6e0: 2020 2020 7d0a 0a20 2020 2020 2020 2063      }..        c
+0001f6f0: 6c69 656e 745f 6861 6e64 6c65 7273 203d  lient_handlers =
+0001f700: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0001f710: 7570 6461 7465 2d67 7261 7068 223a 2073  update-graph": s
+0001f720: 656c 662e 7570 6461 7465 5f67 7261 7068  elf.update_graph
+0001f730: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+0001f740: 6c69 656e 742d 6465 7369 7265 732d 6b65  lient-desires-ke
+0001f750: 7973 223a 2073 656c 662e 636c 6965 6e74  ys": self.client
+0001f760: 5f64 6573 6972 6573 5f6b 6579 732c 0a20  _desires_keys,. 
+0001f770: 2020 2020 2020 2020 2020 2022 7570 6461             "upda
+0001f780: 7465 2d64 6174 6122 3a20 7365 6c66 2e75  te-data": self.u
+0001f790: 7064 6174 655f 6461 7461 2c0a 2020 2020  pdate_data,.    
+0001f7a0: 2020 2020 2020 2020 2272 6570 6f72 742d          "report-
+0001f7b0: 6b65 7922 3a20 7365 6c66 2e72 6570 6f72  key": self.repor
+0001f7c0: 745f 6f6e 5f6b 6579 2c0a 2020 2020 2020  t_on_key,.      
+0001f7d0: 2020 2020 2020 2263 6c69 656e 742d 7265        "client-re
+0001f7e0: 6c65 6173 6573 2d6b 6579 7322 3a20 7365  leases-keys": se
+0001f7f0: 6c66 2e63 6c69 656e 745f 7265 6c65 6173  lf.client_releas
+0001f800: 6573 5f6b 6579 732c 0a20 2020 2020 2020  es_keys,.       
+0001f810: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
+0001f820: 636c 6965 6e74 223a 2073 656c 662e 636c  client": self.cl
+0001f830: 6965 6e74 5f68 6561 7274 6265 6174 2c0a  ient_heartbeat,.
+0001f840: 2020 2020 2020 2020 2020 2020 2263 6c6f              "clo
+0001f850: 7365 2d63 6c69 656e 7422 3a20 7365 6c66  se-client": self
+0001f860: 2e72 656d 6f76 655f 636c 6965 6e74 2c0a  .remove_client,.
+0001f870: 2020 2020 2020 2020 2020 2020 2273 7562              "sub
+0001f880: 7363 7269 6265 2d74 6f70 6963 223a 2073  scribe-topic": s
+0001f890: 656c 662e 7375 6273 6372 6962 655f 746f  elf.subscribe_to
+0001f8a0: 7069 632c 0a20 2020 2020 2020 2020 2020  pic,.           
+0001f8b0: 2022 756e 7375 6273 6372 6962 652d 746f   "unsubscribe-to
+0001f8c0: 7069 6322 3a20 7365 6c66 2e75 6e73 7562  pic": self.unsub
+0001f8d0: 7363 7269 6265 5f74 6f70 6963 2c0a 2020  scribe_topic,.  
+0001f8e0: 2020 2020 2020 2020 2020 2263 616e 6365            "cance
+0001f8f0: 6c2d 6b65 7973 223a 2073 656c 662e 7374  l-keys": self.st
+0001f900: 696d 756c 7573 5f63 616e 6365 6c2c 0a20  imulus_cancel,. 
+0001f910: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0001f920: 2020 7365 6c66 2e68 616e 646c 6572 7320    self.handlers 
+0001f930: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001f940: 2272 6567 6973 7465 722d 636c 6965 6e74  "register-client
+0001f950: 223a 2073 656c 662e 6164 645f 636c 6965  ": self.add_clie
+0001f960: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0001f970: 2273 6361 7474 6572 223a 2073 656c 662e  "scatter": self.
+0001f980: 7363 6174 7465 722c 0a20 2020 2020 2020  scatter,.       
+0001f990: 2020 2020 2022 7265 6769 7374 6572 2d77       "register-w
+0001f9a0: 6f72 6b65 7222 3a20 7365 6c66 2e61 6464  orker": self.add
+0001f9b0: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
+0001f9c0: 2020 2020 2022 7265 6769 7374 6572 5f6e       "register_n
+0001f9d0: 616e 6e79 223a 2073 656c 662e 6164 645f  anny": self.add_
+0001f9e0: 6e61 6e6e 792c 0a20 2020 2020 2020 2020  nanny,.         
+0001f9f0: 2020 2022 756e 7265 6769 7374 6572 223a     "unregister":
+0001fa00: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
+0001fa10: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+0001fa20: 2022 6761 7468 6572 223a 2073 656c 662e   "gather": self.
+0001fa30: 6761 7468 6572 2c0a 2020 2020 2020 2020  gather,.        
+0001fa40: 2020 2020 2272 6574 7279 223a 2073 656c      "retry": sel
+0001fa50: 662e 7374 696d 756c 7573 5f72 6574 7279  f.stimulus_retry
+0001fa60: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
+0001fa70: 6565 6422 3a20 7365 6c66 2e66 6565 642c  eed": self.feed,
+0001fa80: 0a20 2020 2020 2020 2020 2020 2022 7465  .            "te
+0001fa90: 726d 696e 6174 6522 3a20 7365 6c66 2e63  rminate": self.c
+0001faa0: 6c6f 7365 2c0a 2020 2020 2020 2020 2020  lose,.          
+0001fab0: 2020 2262 726f 6164 6361 7374 223a 2073    "broadcast": s
+0001fac0: 656c 662e 6272 6f61 6463 6173 742c 0a20  elf.broadcast,. 
+0001fad0: 2020 2020 2020 2020 2020 2022 7072 6f78             "prox
+0001fae0: 7922 3a20 7365 6c66 2e70 726f 7879 2c0a  y": self.proxy,.
+0001faf0: 2020 2020 2020 2020 2020 2020 226e 636f              "nco
+0001fb00: 7265 7322 3a20 7365 6c66 2e67 6574 5f6e  res": self.get_n
+0001fb10: 636f 7265 732c 0a20 2020 2020 2020 2020  cores,.         
+0001fb20: 2020 2022 6e63 6f72 6573 5f72 756e 6e69     "ncores_runni
+0001fb30: 6e67 223a 2073 656c 662e 6765 745f 6e63  ng": self.get_nc
+0001fb40: 6f72 6573 5f72 756e 6e69 6e67 2c0a 2020  ores_running,.  
+0001fb50: 2020 2020 2020 2020 2020 2268 6173 5f77            "has_w
+0001fb60: 6861 7422 3a20 7365 6c66 2e67 6574 5f68  hat": self.get_h
+0001fb70: 6173 5f77 6861 742c 0a20 2020 2020 2020  as_what,.       
+0001fb80: 2020 2020 2022 7768 6f5f 6861 7322 3a20       "who_has": 
+0001fb90: 7365 6c66 2e67 6574 5f77 686f 5f68 6173  self.get_who_has
+0001fba0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0001fbb0: 726f 6365 7373 696e 6722 3a20 7365 6c66  rocessing": self
+0001fbc0: 2e67 6574 5f70 726f 6365 7373 696e 672c  .get_processing,
+0001fbd0: 0a20 2020 2020 2020 2020 2020 2022 6361  .            "ca
+0001fbe0: 6c6c 5f73 7461 636b 223a 2073 656c 662e  ll_stack": self.
+0001fbf0: 6765 745f 6361 6c6c 5f73 7461 636b 2c0a  get_call_stack,.
+0001fc00: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
+0001fc10: 6669 6c65 223a 2073 656c 662e 6765 745f  file": self.get_
+0001fc20: 7072 6f66 696c 652c 0a20 2020 2020 2020  profile,.       
+0001fc30: 2020 2020 2022 7065 7266 6f72 6d61 6e63       "performanc
+0001fc40: 655f 7265 706f 7274 223a 2073 656c 662e  e_report": self.
+0001fc50: 7065 7266 6f72 6d61 6e63 655f 7265 706f  performance_repo
+0001fc60: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
+0001fc70: 2267 6574 5f6c 6f67 7322 3a20 7365 6c66  "get_logs": self
+0001fc80: 2e67 6574 5f6c 6f67 732c 0a20 2020 2020  .get_logs,.     
+0001fc90: 2020 2020 2020 2022 6c6f 6773 223a 2073         "logs": s
+0001fca0: 656c 662e 6765 745f 6c6f 6773 2c0a 2020  elf.get_logs,.  
+0001fcb0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+0001fcc0: 725f 6c6f 6773 223a 2073 656c 662e 6765  r_logs": self.ge
+0001fcd0: 745f 776f 726b 6572 5f6c 6f67 732c 0a20  t_worker_logs,. 
+0001fce0: 2020 2020 2020 2020 2020 2022 6c6f 675f             "log_
+0001fcf0: 6576 656e 7422 3a20 7365 6c66 2e6c 6f67  event": self.log
+0001fd00: 5f65 7665 6e74 2c0a 2020 2020 2020 2020  _event,.        
+0001fd10: 2020 2020 2265 7665 6e74 7322 3a20 7365      "events": se
+0001fd20: 6c66 2e67 6574 5f65 7665 6e74 732c 0a20  lf.get_events,. 
+0001fd30: 2020 2020 2020 2020 2020 2022 6e62 7974             "nbyt
+0001fd40: 6573 223a 2073 656c 662e 6765 745f 6e62  es": self.get_nb
+0001fd50: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
+0001fd60: 2020 2276 6572 7369 6f6e 7322 3a20 7365    "versions": se
+0001fd70: 6c66 2e76 6572 7369 6f6e 732c 0a20 2020  lf.versions,.   
+0001fd80: 2020 2020 2020 2020 2022 6164 645f 6b65           "add_ke
+0001fd90: 7973 223a 2073 656c 662e 6164 645f 6b65  ys": self.add_ke
+0001fda0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+0001fdb0: 2272 6562 616c 616e 6365 223a 2073 656c  "rebalance": sel
+0001fdc0: 662e 7265 6261 6c61 6e63 652c 0a20 2020  f.rebalance,.   
+0001fdd0: 2020 2020 2020 2020 2022 7265 706c 6963           "replic
+0001fde0: 6174 6522 3a20 7365 6c66 2e72 6570 6c69  ate": self.repli
+0001fdf0: 6361 7465 2c0a 2020 2020 2020 2020 2020  cate,.          
+0001fe00: 2020 2272 756e 5f66 756e 6374 696f 6e22    "run_function"
+0001fe10: 3a20 7365 6c66 2e72 756e 5f66 756e 6374  : self.run_funct
+0001fe20: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+0001fe30: 2022 7265 7374 6172 7422 3a20 7365 6c66   "restart": self
+0001fe40: 2e72 6573 7461 7274 2c0a 2020 2020 2020  .restart,.      
+0001fe50: 2020 2020 2020 2275 7064 6174 655f 6461        "update_da
+0001fe60: 7461 223a 2073 656c 662e 7570 6461 7465  ta": self.update
+0001fe70: 5f64 6174 612c 0a20 2020 2020 2020 2020  _data,.         
+0001fe80: 2020 2022 7365 745f 7265 736f 7572 6365     "set_resource
+0001fe90: 7322 3a20 7365 6c66 2e61 6464 5f72 6573  s": self.add_res
+0001fea0: 6f75 7263 6573 2c0a 2020 2020 2020 2020  ources,.        
+0001feb0: 2020 2020 2272 6574 6972 655f 776f 726b      "retire_work
+0001fec0: 6572 7322 3a20 7365 6c66 2e72 6574 6972  ers": self.retir
+0001fed0: 655f 776f 726b 6572 732c 0a20 2020 2020  e_workers,.     
+0001fee0: 2020 2020 2020 2022 6765 745f 6d65 7461         "get_meta
+0001fef0: 6461 7461 223a 2073 656c 662e 6765 745f  data": self.get_
+0001ff00: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
+0001ff10: 2020 2020 2020 2273 6574 5f6d 6574 6164        "set_metad
+0001ff20: 6174 6122 3a20 7365 6c66 2e73 6574 5f6d  ata": self.set_m
+0001ff30: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
+0001ff40: 2020 2020 2022 7365 745f 7265 7374 7269       "set_restri
+0001ff50: 6374 696f 6e73 223a 2073 656c 662e 7365  ctions": self.se
+0001ff60: 745f 7265 7374 7269 6374 696f 6e73 2c0a  t_restrictions,.
+0001ff70: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
+0001ff80: 7274 6265 6174 5f77 6f72 6b65 7222 3a20  rtbeat_worker": 
+0001ff90: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
+0001ffa0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+0001ffb0: 2020 2022 6765 745f 7461 736b 5f73 7461     "get_task_sta
+0001ffc0: 7475 7322 3a20 7365 6c66 2e67 6574 5f74  tus": self.get_t
+0001ffd0: 6173 6b5f 7374 6174 7573 2c0a 2020 2020  ask_status,.    
+0001ffe0: 2020 2020 2020 2020 2267 6574 5f74 6173          "get_tas
+0001fff0: 6b5f 7374 7265 616d 223a 2073 656c 662e  k_stream": self.
+00020000: 6765 745f 7461 736b 5f73 7472 6561 6d2c  get_task_stream,
+00020010: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
+00020020: 745f 7461 736b 5f70 7265 6669 785f 7374  t_task_prefix_st
+00020030: 6174 6573 223a 2073 656c 662e 6765 745f  ates": self.get_
+00020040: 7461 736b 5f70 7265 6669 785f 7374 6174  task_prefix_stat
+00020050: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00020060: 2272 6567 6973 7465 725f 7363 6865 6475  "register_schedu
+00020070: 6c65 725f 706c 7567 696e 223a 2073 656c  ler_plugin": sel
+00020080: 662e 7265 6769 7374 6572 5f73 6368 6564  f.register_sched
+00020090: 756c 6572 5f70 6c75 6769 6e2c 0a20 2020  uler_plugin,.   
+000200a0: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
+000200b0: 6572 5f77 6f72 6b65 725f 706c 7567 696e  er_worker_plugin
+000200c0: 223a 2073 656c 662e 7265 6769 7374 6572  ": self.register
+000200d0: 5f77 6f72 6b65 725f 706c 7567 696e 2c0a  _worker_plugin,.
+000200e0: 2020 2020 2020 2020 2020 2020 2275 6e72              "unr
+000200f0: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
+00020100: 6c75 6769 6e22 3a20 7365 6c66 2e75 6e72  lugin": self.unr
+00020110: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
+00020120: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
+00020130: 2020 2022 7265 6769 7374 6572 5f6e 616e     "register_nan
+00020140: 6e79 5f70 6c75 6769 6e22 3a20 7365 6c66  ny_plugin": self
+00020150: 2e72 6567 6973 7465 725f 6e61 6e6e 795f  .register_nanny_
+00020160: 706c 7567 696e 2c0a 2020 2020 2020 2020  plugin,.        
+00020170: 2020 2020 2275 6e72 6567 6973 7465 725f      "unregister_
+00020180: 6e61 6e6e 795f 706c 7567 696e 223a 2073  nanny_plugin": s
+00020190: 656c 662e 756e 7265 6769 7374 6572 5f6e  elf.unregister_n
+000201a0: 616e 6e79 5f70 6c75 6769 6e2c 0a20 2020  anny_plugin,.   
+000201b0: 2020 2020 2020 2020 2022 6164 6170 7469           "adapti
+000201c0: 7665 5f74 6172 6765 7422 3a20 7365 6c66  ve_target": self
+000201d0: 2e61 6461 7074 6976 655f 7461 7267 6574  .adaptive_target
+000201e0: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+000201f0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6522  orkers_to_close"
+00020200: 3a20 7365 6c66 2e77 6f72 6b65 7273 5f74  : self.workers_t
+00020210: 6f5f 636c 6f73 652c 0a20 2020 2020 2020  o_close,.       
+00020220: 2020 2020 2022 7375 6273 6372 6962 655f       "subscribe_
+00020230: 776f 726b 6572 5f73 7461 7475 7322 3a20  worker_status": 
+00020240: 7365 6c66 2e73 7562 7363 7269 6265 5f77  self.subscribe_w
+00020250: 6f72 6b65 725f 7374 6174 7573 2c0a 2020  orker_status,.  
+00020260: 2020 2020 2020 2020 2020 2273 7461 7274            "start
+00020270: 5f74 6173 6b5f 6d65 7461 6461 7461 223a  _task_metadata":
+00020280: 2073 656c 662e 7374 6172 745f 7461 736b   self.start_task
+00020290: 5f6d 6574 6164 6174 612c 0a20 2020 2020  _metadata,.     
+000202a0: 2020 2020 2020 2022 7374 6f70 5f74 6173         "stop_tas
+000202b0: 6b5f 6d65 7461 6461 7461 223a 2073 656c  k_metadata": sel
+000202c0: 662e 7374 6f70 5f74 6173 6b5f 6d65 7461  f.stop_task_meta
+000202d0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+000202e0: 2020 2267 6574 5f63 6c75 7374 6572 5f73    "get_cluster_s
+000202f0: 7461 7465 223a 2073 656c 662e 6765 745f  tate": self.get_
+00020300: 636c 7573 7465 725f 7374 6174 652c 0a20  cluster_state,. 
+00020310: 2020 2020 2020 2020 2020 2022 6475 6d70             "dump
+00020320: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
+00020330: 6f5f 7572 6c22 3a20 7365 6c66 2e64 756d  o_url": self.dum
+00020340: 705f 636c 7573 7465 725f 7374 6174 655f  p_cluster_state_
+00020350: 746f 5f75 726c 2c0a 2020 2020 2020 2020  to_url,.        
+00020360: 2020 2020 2262 656e 6368 6d61 726b 5f68      "benchmark_h
+00020370: 6172 6477 6172 6522 3a20 7365 6c66 2e62  ardware": self.b
+00020380: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
+00020390: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+000203a0: 6765 745f 7374 6f72 7922 3a20 7365 6c66  get_story": self
+000203b0: 2e67 6574 5f73 746f 7279 2c0a 2020 2020  .get_story,.    
+000203c0: 2020 2020 2020 2020 2263 6865 636b 5f69          "check_i
+000203d0: 646c 6522 3a20 7365 6c66 2e63 6865 636b  dle": self.check
+000203e0: 5f69 646c 652c 0a20 2020 2020 2020 207d  _idle,.        }
+000203f0: 0a0a 2020 2020 2020 2020 636f 6e6e 6563  ..        connec
+00020400: 7469 6f6e 5f6c 696d 6974 203d 2067 6574  tion_limit = get
+00020410: 5f66 696c 656e 6f5f 6c69 6d69 7428 2920  _fileno_limit() 
+00020420: 2f20 320a 0a20 2020 2020 2020 2053 6368  / 2..        Sch
+00020430: 6564 756c 6572 5374 6174 652e 5f5f 696e  edulerState.__in
+00020440: 6974 5f5f 280a 2020 2020 2020 2020 2020  it__(.          
+00020450: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00020460: 2020 2020 616c 6961 7365 733d 616c 6961      aliases=alia
+00020470: 7365 732c 0a20 2020 2020 2020 2020 2020  ses,.           
+00020480: 2063 6c69 656e 7473 3d63 6c69 656e 7473   clients=clients
+00020490: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
+000204a0: 726b 6572 733d 776f 726b 6572 732c 0a20  rkers=workers,. 
+000204b0: 2020 2020 2020 2020 2020 2068 6f73 745f             host_
+000204c0: 696e 666f 3d68 6f73 745f 696e 666f 2c0a  info=host_info,.
+000204d0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+000204e0: 7572 6365 733d 7265 736f 7572 6365 732c  urces=resources,
+000204f0: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+00020500: 6b73 3d74 6173 6b73 2c0a 2020 2020 2020  ks=tasks,.      
+00020510: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
+00020520: 3d75 6e72 756e 6e61 626c 652c 0a20 2020  =unrunnable,.   
+00020530: 2020 2020 2020 2020 2071 7565 7565 643d           queued=
+00020540: 7175 6575 6564 2c0a 2020 2020 2020 2020  queued,.        
+00020550: 2020 2020 7661 6c69 6461 7465 3d76 616c      validate=val
+00020560: 6964 6174 652c 0a20 2020 2020 2020 2020  idate,.         
+00020570: 2020 2070 6c75 6769 6e73 3d70 6c75 6769     plugins=plugi
+00020580: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00020590: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+000205a0: 6572 5f6d 6178 3d74 7261 6e73 6974 696f  er_max=transitio
+000205b0: 6e5f 636f 756e 7465 725f 6d61 782c 0a20  n_counter_max,. 
+000205c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000205d0: 2053 6572 7665 724e 6f64 652e 5f5f 696e   ServerNode.__in
+000205e0: 6974 5f5f 280a 2020 2020 2020 2020 2020  it__(.          
+000205f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00020600: 2020 2020 6861 6e64 6c65 7273 3d73 656c      handlers=sel
+00020610: 662e 6861 6e64 6c65 7273 2c0a 2020 2020  f.handlers,.    
+00020620: 2020 2020 2020 2020 7374 7265 616d 5f68          stream_h
+00020630: 616e 646c 6572 733d 6d65 7267 6528 776f  andlers=merge(wo
+00020640: 726b 6572 5f68 616e 646c 6572 732c 2063  rker_handlers, c
+00020650: 6c69 656e 745f 6861 6e64 6c65 7273 292c  lient_handlers),
+00020660: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00020670: 6e65 6374 696f 6e5f 6c69 6d69 743d 636f  nection_limit=co
+00020680: 6e6e 6563 7469 6f6e 5f6c 696d 6974 2c0a  nnection_limit,.
+00020690: 2020 2020 2020 2020 2020 2020 6465 7365              dese
+000206a0: 7269 616c 697a 653d 4661 6c73 652c 0a20  rialize=False,. 
+000206b0: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
+000206c0: 6374 696f 6e5f 6172 6773 3d73 656c 662e  ction_args=self.
+000206d0: 636f 6e6e 6563 7469 6f6e 5f61 7267 732c  connection_args,
+000206e0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+000206f0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+00020700: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00020710: 662e 776f 726b 6572 5f74 746c 3a0a 2020  f.worker_ttl:.  
+00020720: 2020 2020 2020 2020 2020 7063 203d 2050            pc = P
+00020730: 6572 696f 6469 6343 616c 6c62 6163 6b28  eriodicCallback(
+00020740: 7365 6c66 2e63 6865 636b 5f77 6f72 6b65  self.check_worke
+00020750: 725f 7474 6c2c 2073 656c 662e 776f 726b  r_ttl, self.work
+00020760: 6572 5f74 746c 202a 2031 3030 3029 0a20  er_ttl * 1000). 
+00020770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020780: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
+00020790: 6b73 5b22 776f 726b 6572 2d74 746c 225d  ks["worker-ttl"]
+000207a0: 203d 2070 630a 0a20 2020 2020 2020 2070   = pc..        p
+000207b0: 6320 3d20 5065 7269 6f64 6963 4361 6c6c  c = PeriodicCall
+000207c0: 6261 636b 2873 656c 662e 6368 6563 6b5f  back(self.check_
+000207d0: 6964 6c65 2c20 2873 656c 662e 6964 6c65  idle, (self.idle
+000207e0: 5f74 696d 656f 7574 206f 7220 3129 202a  _timeout or 1) *
+000207f0: 2031 3030 3020 2f20 3429 0a20 2020 2020   1000 / 4).     
+00020800: 2020 2073 656c 662e 7065 7269 6f64 6963     self.periodic
+00020810: 5f63 616c 6c62 6163 6b73 5b22 6964 6c65  _callbacks["idle
+00020820: 2d74 696d 656f 7574 225d 203d 2070 630a  -timeout"] = pc.
+00020830: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
+00020840: 6e73 696f 6e73 2069 7320 4e6f 6e65 3a0a  nsions is None:.
+00020850: 2020 2020 2020 2020 2020 2020 6578 7465              exte
+00020860: 6e73 696f 6e73 203d 2044 4546 4155 4c54  nsions = DEFAULT
+00020870: 5f45 5854 454e 5349 4f4e 532e 636f 7079  _EXTENSIONS.copy
+00020880: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+00020890: 6620 6e6f 7420 6461 736b 2e63 6f6e 6669  f not dask.confi
+000208a0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+000208b0: 6564 2e73 6368 6564 756c 6572 2e77 6f72  ed.scheduler.wor
+000208c0: 6b2d 7374 6561 6c69 6e67 2229 3a0a 2020  k-stealing"):.  
+000208d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000208e0: 2022 7374 6561 6c69 6e67 2220 696e 2065   "stealing" in e
+000208f0: 7874 656e 7369 6f6e 733a 0a20 2020 2020  xtensions:.     
+00020900: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00020910: 656c 2065 7874 656e 7369 6f6e 735b 2273  el extensions["s
+00020920: 7465 616c 696e 6722 5d0a 0a20 2020 2020  tealing"]..     
+00020930: 2020 2066 6f72 206e 616d 652c 2065 7874     for name, ext
+00020940: 656e 7369 6f6e 2069 6e20 6578 7465 6e73  ension in extens
+00020950: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
+00020960: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00020970: 7874 656e 7369 6f6e 735b 6e61 6d65 5d20  xtensions[name] 
+00020980: 3d20 6578 7465 6e73 696f 6e28 7365 6c66  = extension(self
+00020990: 290a 0a20 2020 2020 2020 2073 6574 7072  )..        setpr
+000209a0: 6f63 7469 746c 6528 2264 6173 6b20 7363  octitle("dask sc
+000209b0: 6865 6475 6c65 7220 5b6e 6f74 2073 7461  heduler [not sta
+000209c0: 7274 6564 5d22 290a 2020 2020 2020 2020  rted]").        
+000209d0: 5363 6865 6475 6c65 722e 5f69 6e73 7461  Scheduler._insta
+000209e0: 6e63 6573 2e61 6464 2873 656c 6629 0a20  nces.add(self). 
+000209f0: 2020 2020 2020 2073 656c 662e 7270 632e         self.rpc.
+00020a00: 616c 6c6f 775f 6f66 666c 6f61 6420 3d20  allow_offload = 
+00020a10: 4661 6c73 650a 0a20 2020 2023 2323 2323  False..    #####
+00020a20: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+00020a30: 2020 2320 4164 6d69 6e69 7374 7261 7469    # Administrati
+00020a40: 6f6e 2023 0a20 2020 2023 2323 2323 2323  on #.    #######
+00020a50: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+00020a60: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
+00020a70: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00020a80: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+00020a90: 2020 6622 3c53 6368 6564 756c 6572 207b    f"<Scheduler {
+00020aa0: 7365 6c66 2e61 6464 7265 7373 5f73 6166  self.address_saf
+00020ab0: 6521 727d 2c20 220a 2020 2020 2020 2020  e!r}, ".        
+00020ac0: 2020 2020 6622 776f 726b 6572 733a 207b      f"workers: {
+00020ad0: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
+00020ae0: 297d 2c20 220a 2020 2020 2020 2020 2020  )}, ".          
+00020af0: 2020 6622 636f 7265 733a 207b 7365 6c66    f"cores: {self
+00020b00: 2e74 6f74 616c 5f6e 7468 7265 6164 737d  .total_nthreads}
+00020b10: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+00020b20: 6622 7461 736b 733a 207b 6c65 6e28 7365  f"tasks: {len(se
+00020b30: 6c66 2e74 6173 6b73 297d 3e22 0a20 2020  lf.tasks)}>".   
+00020b40: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00020b50: 5f72 6570 725f 6874 6d6c 5f28 7365 6c66  _repr_html_(self
+00020b60: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00020b70: 6e20 6765 745f 7465 6d70 6c61 7465 2822  n get_template("
+00020b80: 7363 6865 6475 6c65 722e 6874 6d6c 2e6a  scheduler.html.j
+00020b90: 3222 292e 7265 6e64 6572 280a 2020 2020  2").render(.    
+00020ba0: 2020 2020 2020 2020 6164 6472 6573 733d          address=
+00020bb0: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
+00020bc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00020bd0: 733d 7365 6c66 2e77 6f72 6b65 7273 2c0a  s=self.workers,.
+00020be0: 2020 2020 2020 2020 2020 2020 7468 7265              thre
+00020bf0: 6164 733d 7365 6c66 2e74 6f74 616c 5f6e  ads=self.total_n
+00020c00: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
+00020c10: 2020 2020 2074 6173 6b73 3d73 656c 662e       tasks=self.
+00020c20: 7461 736b 732c 0a20 2020 2020 2020 2029  tasks,.        )
+00020c30: 0a0a 2020 2020 6465 6620 6964 656e 7469  ..    def identi
+00020c40: 7479 2873 656c 6629 3a0a 2020 2020 2020  ty(self):.      
+00020c50: 2020 2222 2242 6173 6963 2069 6e66 6f72    """Basic infor
+00020c60: 6d61 7469 6f6e 2061 626f 7574 206f 7572  mation about our
+00020c70: 7365 6c76 6573 2061 6e64 206f 7572 2063  selves and our c
+00020c80: 6c75 7374 6572 2222 220a 2020 2020 2020  luster""".      
+00020c90: 2020 6420 3d20 7b0a 2020 2020 2020 2020    d = {.        
+00020ca0: 2020 2020 2274 7970 6522 3a20 7479 7065      "type": type
+00020cb0: 2873 656c 6629 2e5f 5f6e 616d 655f 5f2c  (self).__name__,
+00020cc0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
+00020cd0: 223a 2073 7472 2873 656c 662e 6964 292c  ": str(self.id),
+00020ce0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
+00020cf0: 6472 6573 7322 3a20 7365 6c66 2e61 6464  dress": self.add
+00020d00: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+00020d10: 2020 2273 6572 7669 6365 7322 3a20 7b6b    "services": {k
+00020d20: 6579 3a20 762e 706f 7274 2066 6f72 2028  ey: v.port for (
+00020d30: 6b65 792c 2076 2920 696e 2073 656c 662e  key, v) in self.
+00020d40: 7365 7276 6963 6573 2e69 7465 6d73 2829  services.items()
+00020d50: 7d2c 0a20 2020 2020 2020 2020 2020 2022  },.            "
+00020d60: 7374 6172 7465 6422 3a20 7365 6c66 2e74  started": self.t
+00020d70: 696d 655f 7374 6172 7465 642c 0a20 2020  ime_started,.   
+00020d80: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
+00020d90: 7322 3a20 7b0a 2020 2020 2020 2020 2020  s": {.          
+00020da0: 2020 2020 2020 776f 726b 6572 2e61 6464        worker.add
+00020db0: 7265 7373 3a20 776f 726b 6572 2e69 6465  ress: worker.ide
+00020dc0: 6e74 6974 7928 2920 666f 7220 776f 726b  ntity() for work
+00020dd0: 6572 2069 6e20 7365 6c66 2e77 6f72 6b65  er in self.worke
+00020de0: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+00020df0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00020e00: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
+00020e10: 7572 6e20 640a 0a20 2020 2064 6566 205f  urn d..    def _
+00020e20: 746f 5f64 6963 7428 7365 6c66 2c20 2a2c  to_dict(self, *,
+00020e30: 2065 7863 6c75 6465 3a20 436f 6e74 6169   exclude: Contai
+00020e40: 6e65 725b 7374 725d 203d 2028 2929 202d  ner[str] = ()) -
+00020e50: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
+00020e60: 2222 2244 6963 7469 6f6e 6172 7920 7265  """Dictionary re
+00020e70: 7072 6573 656e 7461 7469 6f6e 2066 6f72  presentation for
+00020e80: 2064 6562 7567 6769 6e67 2070 7572 706f   debugging purpo
+00020e90: 7365 732e 0a20 2020 2020 2020 204e 6f74  ses..        Not
+00020ea0: 2074 7970 6520 7374 6162 6c65 2061 6e64   type stable and
+00020eb0: 206e 6f74 2069 6e74 656e 6465 6420 666f   not intended fo
+00020ec0: 7220 726f 756e 6474 7269 7073 2e0a 0a20  r roundtrips... 
+00020ed0: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
+00020ee0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00020ef0: 0a20 2020 2020 2020 2053 6572 7665 722e  .        Server.
+00020f00: 6964 656e 7469 7479 0a20 2020 2020 2020  identity.       
+00020f10: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
+00020f20: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
+00020f30: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
+00020f40: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
+00020f50: 6f5f 6469 6374 0a20 2020 2020 2020 2022  o_dict.        "
+00020f60: 2222 0a20 2020 2020 2020 2069 6e66 6f20  "".        info 
+00020f70: 3d20 7375 7065 7228 292e 5f74 6f5f 6469  = super()._to_di
+00020f80: 6374 2865 7863 6c75 6465 3d65 7863 6c75  ct(exclude=exclu
+00020f90: 6465 290a 2020 2020 2020 2020 6578 7472  de).        extr
+00020fa0: 6120 3d20 7b0a 2020 2020 2020 2020 2020  a = {.          
+00020fb0: 2020 2274 7261 6e73 6974 696f 6e5f 6c6f    "transition_lo
+00020fc0: 6722 3a20 7365 6c66 2e74 7261 6e73 6974  g": self.transit
+00020fd0: 696f 6e5f 6c6f 672c 0a20 2020 2020 2020  ion_log,.       
+00020fe0: 2020 2020 2022 7472 616e 7369 7469 6f6e       "transition
+00020ff0: 5f63 6f75 6e74 6572 223a 2073 656c 662e  _counter": self.
+00021000: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+00021010: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00021020: 2274 6173 6b73 223a 2073 656c 662e 7461  "tasks": self.ta
+00021030: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
+00021040: 2022 7461 736b 5f67 726f 7570 7322 3a20   "task_groups": 
+00021050: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
+00021060: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00021070: 4f76 6572 7772 6974 6520 6469 6374 206f  Overwrite dict o
+00021080: 6620 576f 726b 6572 5374 6174 652e 6964  f WorkerState.id
+00021090: 656e 7469 7479 2066 726f 6d20 696e 666f  entity from info
+000210a0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
+000210b0: 726b 6572 7322 3a20 7365 6c66 2e77 6f72  rkers": self.wor
+000210c0: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+000210d0: 2020 2263 6c69 656e 7473 223a 2073 656c    "clients": sel
+000210e0: 662e 636c 6965 6e74 732c 0a20 2020 2020  f.clients,.     
+000210f0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+00021100: 2073 656c 662e 6d65 6d6f 7279 2c0a 2020   self.memory,.  
+00021110: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
+00021120: 7322 3a20 7365 6c66 2e65 7665 6e74 732c  s": self.events,
+00021130: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
+00021140: 7465 6e73 696f 6e73 223a 2073 656c 662e  tensions": self.
+00021150: 6578 7465 6e73 696f 6e73 2c0a 2020 2020  extensions,.    
+00021160: 2020 2020 7d0a 2020 2020 2020 2020 6578      }.        ex
+00021170: 7472 6120 3d20 7b6b 3a20 7620 666f 7220  tra = {k: v for 
+00021180: 6b2c 2076 2069 6e20 6578 7472 612e 6974  k, v in extra.it
+00021190: 656d 7328 2920 6966 206b 206e 6f74 2069  ems() if k not i
+000211a0: 6e20 6578 636c 7564 657d 0a20 2020 2020  n exclude}.     
+000211b0: 2020 2069 6e66 6f2e 7570 6461 7465 2872     info.update(r
+000211c0: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
+000211d0: 2865 7874 7261 2c20 6578 636c 7564 653d  (extra, exclude=
+000211e0: 6578 636c 7564 6529 290a 2020 2020 2020  exclude)).      
+000211f0: 2020 7265 7475 726e 2069 6e66 6f0a 0a20    return info.. 
+00021200: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+00021210: 5f63 6c75 7374 6572 5f73 7461 7465 280a  _cluster_state(.
+00021220: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00021230: 2020 2020 2020 6578 636c 7564 653a 2022        exclude: "
+00021240: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d22  Collection[str]"
+00021250: 2c0a 2020 2020 2920 2d3e 2064 6963 743a  ,.    ) -> dict:
+00021260: 0a20 2020 2020 2020 2022 5072 6f64 7563  .        "Produc
+00021270: 6520 7468 6520 7374 6174 6520 6469 6374  e the state dict
+00021280: 2075 7365 6420 696e 2061 2063 6c75 7374   used in a clust
+00021290: 6572 2073 7461 7465 2064 756d 7022 0a20  er state dump". 
+000212a0: 2020 2020 2020 2023 204b 6963 6b20 6f66         # Kick of
+000212b0: 6620 7374 6174 652d 6475 6d70 696e 6720  f state-dumping 
+000212c0: 6f6e 2077 6f72 6b65 7273 2062 6566 6f72  on workers befor
+000212d0: 6520 7765 2062 6c6f 636b 2074 6865 2065  e we block the e
+000212e0: 7665 6e74 206c 6f6f 7020 696e 2060 7365  vent loop in `se
+000212f0: 6c66 2e5f 746f 5f64 6963 7460 2e0a 2020  lf._to_dict`..  
+00021300: 2020 2020 2020 776f 726b 6572 735f 6675        workers_fu
+00021310: 7475 7265 203d 2061 7379 6e63 696f 2e67  ture = asyncio.g
+00021320: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00021330: 2020 2073 656c 662e 6272 6f61 6463 6173     self.broadcas
+00021340: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00021350: 2020 206d 7367 3d7b 226f 7022 3a20 2264     msg={"op": "d
+00021360: 756d 705f 7374 6174 6522 2c20 2265 7863  ump_state", "exc
+00021370: 6c75 6465 223a 2065 7863 6c75 6465 7d2c  lude": exclude},
+00021380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021390: 206f 6e5f 6572 726f 723d 2272 6574 7572   on_error="retur
+000213a0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+000213b0: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+000213c0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
+000213d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000213e0: 7367 3d7b 226f 7022 3a20 2276 6572 7369  sg={"op": "versi
+000213f0: 6f6e 7322 7d2c 0a20 2020 2020 2020 2020  ons"},.         
+00021400: 2020 2020 2020 206f 6e5f 6572 726f 723d         on_error=
+00021410: 2269 676e 6f72 6522 2c0a 2020 2020 2020  "ignore",.      
+00021420: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+00021430: 2029 0a20 2020 2020 2020 2074 7279 3a0a   ).        try:.
+00021440: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+00021450: 6475 6c65 725f 7374 6174 6520 3d20 7365  duler_state = se
+00021460: 6c66 2e5f 746f 5f64 6963 7428 6578 636c  lf._to_dict(excl
+00021470: 7564 653d 6578 636c 7564 6529 0a0a 2020  ude=exclude)..  
+00021480: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00021490: 5f73 7461 7465 732c 2077 6f72 6b65 725f  _states, worker_
+000214a0: 7665 7273 696f 6e73 203d 2061 7761 6974  versions = await
+000214b0: 2077 6f72 6b65 7273 5f66 7574 7572 650a   workers_future.
+000214c0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+000214d0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+000214e0: 6e73 7572 6520 7468 6520 7461 736b 7320  nsure the tasks 
+000214f0: 6172 656e 2774 206c 6566 7420 7275 6e6e  aren't left runn
+00021500: 696e 6720 6966 2061 6e79 7468 696e 6720  ing if anything 
+00021510: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
+00021520: 2020 2023 2053 6f6d 6564 6179 2028 7079     # Someday (py
+00021530: 332e 3131 292c 2075 7365 2061 2074 7269  3.11), use a tri
+00021540: 6f2d 7374 796c 6520 5461 736b 4772 6f75  o-style TaskGrou
+00021550: 7020 666f 7220 7468 6973 2e0a 2020 2020  p for this..    
+00021560: 2020 2020 2020 2020 776f 726b 6572 735f          workers_
+00021570: 6675 7475 7265 2e63 616e 6365 6c28 290a  future.cancel().
+00021580: 0a20 2020 2020 2020 2023 2043 6f6e 7665  .        # Conve
+00021590: 7274 2061 6e79 2052 5043 2065 7272 6f72  rt any RPC error
+000215a0: 7320 746f 2073 7472 696e 6773 0a20 2020  s to strings.   
+000215b0: 2020 2020 2077 6f72 6b65 725f 7374 6174       worker_stat
+000215c0: 6573 203d 207b 0a20 2020 2020 2020 2020  es = {.         
+000215d0: 2020 206b 3a20 7265 7072 2876 2920 6966     k: repr(v) if
+000215e0: 2069 7369 6e73 7461 6e63 6528 762c 2045   isinstance(v, E
+000215f0: 7863 6570 7469 6f6e 2920 656c 7365 2076  xception) else v
+00021600: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00021610: 206b 2c20 7620 696e 2077 6f72 6b65 725f   k, v in worker_
+00021620: 7374 6174 6573 2e69 7465 6d73 2829 0a20  states.items(). 
+00021630: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00021640: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
+00021650: 2020 2020 2020 2022 7363 6865 6475 6c65         "schedule
+00021660: 7222 3a20 7363 6865 6475 6c65 725f 7374  r": scheduler_st
+00021670: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+00021680: 2022 776f 726b 6572 7322 3a20 776f 726b   "workers": work
+00021690: 6572 5f73 7461 7465 732c 0a20 2020 2020  er_states,.     
+000216a0: 2020 2020 2020 2022 7665 7273 696f 6e73         "versions
+000216b0: 223a 207b 2273 6368 6564 756c 6572 223a  ": {"scheduler":
+000216c0: 2073 656c 662e 7665 7273 696f 6e73 2829   self.versions()
+000216d0: 2c20 2277 6f72 6b65 7273 223a 2077 6f72  , "workers": wor
+000216e0: 6b65 725f 7665 7273 696f 6e73 7d2c 0a20  ker_versions},. 
+000216f0: 2020 2020 2020 207d 0a0a 2020 2020 6173         }..    as
+00021700: 796e 6320 6465 6620 6475 6d70 5f63 6c75  ync def dump_clu
+00021710: 7374 6572 5f73 7461 7465 5f74 6f5f 7572  ster_state_to_ur
+00021720: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
+00021730: 0a20 2020 2020 2020 2075 726c 3a20 7374  .        url: st
+00021740: 722c 0a20 2020 2020 2020 2065 7863 6c75  r,.        exclu
+00021750: 6465 3a20 2243 6f6c 6c65 6374 696f 6e5b  de: "Collection[
+00021760: 7374 725d 222c 0a20 2020 2020 2020 2066  str]",.        f
+00021770: 6f72 6d61 743a 204c 6974 6572 616c 5b22  ormat: Literal["
+00021780: 6d73 6770 6163 6b22 2c20 2279 616d 6c22  msgpack", "yaml"
+00021790: 5d2c 0a20 2020 2020 2020 202a 2a73 746f  ],.        **sto
+000217a0: 7261 6765 5f6f 7074 696f 6e73 3a20 6469  rage_options: di
+000217b0: 6374 5b73 7472 2c20 416e 795d 2c0a 2020  ct[str, Any],.  
+000217c0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+000217d0: 2020 2020 2022 5772 6974 6520 6120 636c       "Write a cl
+000217e0: 7573 7465 7220 7374 6174 6520 6475 6d70  uster state dump
+000217f0: 2074 6f20 616e 2066 7373 7065 632d 636f   to an fsspec-co
+00021800: 6d70 6174 6962 6c65 2055 524c 2e22 0a20  mpatible URL.". 
+00021810: 2020 2020 2020 2061 7761 6974 2063 6c75         await clu
+00021820: 7374 6572 5f64 756d 702e 7772 6974 655f  ster_dump.write_
+00021830: 7374 6174 6528 0a20 2020 2020 2020 2020  state(.         
+00021840: 2020 2070 6172 7469 616c 2873 656c 662e     partial(self.
+00021850: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
+00021860: 652c 2065 7863 6c75 6465 292c 2075 726c  e, exclude), url
+00021870: 2c20 666f 726d 6174 2c20 2a2a 7374 6f72  , format, **stor
+00021880: 6167 655f 6f70 7469 6f6e 730a 2020 2020  age_options.    
+00021890: 2020 2020 290a 0a20 2020 2064 6566 2067      )..    def g
+000218a0: 6574 5f77 6f72 6b65 725f 7365 7276 6963  et_worker_servic
+000218b0: 655f 6164 6472 280a 2020 2020 2020 2020  e_addr(.        
+000218c0: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
+000218d0: 722c 2073 6572 7669 6365 5f6e 616d 653a  r, service_name:
+000218e0: 2073 7472 2c20 7072 6f74 6f63 6f6c 3a20   str, protocol: 
+000218f0: 626f 6f6c 203d 2046 616c 7365 0a20 2020  bool = False.   
+00021900: 2029 202d 3e20 7475 706c 655b 7374 722c   ) -> tuple[str,
+00021910: 2069 6e74 5d20 7c20 7374 7220 7c20 4e6f   int] | str | No
+00021920: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+00021930: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+00021940: 2868 6f73 742c 2070 6f72 7429 2061 6464  (host, port) add
+00021950: 7265 7373 206f 6620 7468 6520 6e61 6d65  ress of the name
+00021960: 6420 7365 7276 6963 6520 6f6e 2074 6865  d service on the
+00021970: 202a 776f 726b 6572 2a2e 0a20 2020 2020   *worker*..     
+00021980: 2020 2052 6574 7572 6e73 204e 6f6e 6520     Returns None 
+00021990: 6966 2074 6865 2073 6572 7669 6365 2064  if the service d
+000219a0: 6f65 736e 2774 2065 7869 7374 2e0a 0a20  oesn't exist... 
+000219b0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+000219c0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+000219d0: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
+000219e0: 6b65 7220 3a20 6164 6472 6573 730a 2020  ker : address.  
+000219f0: 2020 2020 2020 7365 7276 6963 655f 6e61        service_na
+00021a00: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
+00021a10: 2020 2020 2043 6f6d 6d6f 6e20 7365 7276       Common serv
+00021a20: 6963 6573 2069 6e63 6c75 6465 2027 626f  ices include 'bo
+00021a30: 6b65 6827 2061 6e64 2027 6e61 6e6e 7927  keh' and 'nanny'
+00021a40: 0a20 2020 2020 2020 2070 726f 746f 636f  .        protoco
+00021a50: 6c20 3a20 626f 6f6c 6561 6e0a 2020 2020  l : boolean.    
+00021a60: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00021a70: 6f72 206e 6f74 2074 6f20 696e 636c 7564  or not to includ
+00021a80: 6520 6120 6675 6c6c 2061 6464 7265 7373  e a full address
+00021a90: 2077 6974 6820 7072 6f74 6f63 6f6c 2028   with protocol (
+00021aa0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00021ab0: 2020 6f72 206a 7573 7420 6120 2868 6f73    or just a (hos
+00021ac0: 742c 2070 6f72 7429 2070 6169 720a 2020  t, port) pair.  
+00021ad0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00021ae0: 2020 7773 203d 2073 656c 662e 776f 726b    ws = self.work
+00021af0: 6572 735b 776f 726b 6572 5d0a 2020 2020  ers[worker].    
+00021b00: 2020 2020 706f 7274 203d 2077 732e 7365      port = ws.se
+00021b10: 7276 6963 6573 2e67 6574 2873 6572 7669  rvices.get(servi
+00021b20: 6365 5f6e 616d 6529 0a20 2020 2020 2020  ce_name).       
+00021b30: 2069 6620 706f 7274 2069 7320 4e6f 6e65   if port is None
+00021b40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00021b50: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
+00021b60: 2020 656c 6966 2070 726f 746f 636f 6c3a    elif protocol:
+00021b70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00021b80: 7572 6e20 2225 2870 726f 746f 636f 6c29  urn "%(protocol)
+00021b90: 733a 2f2f 2528 686f 7374 2973 3a25 2870  s://%(host)s:%(p
+00021ba0: 6f72 7429 6422 2025 207b 0a20 2020 2020  ort)d" % {.     
+00021bb0: 2020 2020 2020 2020 2020 2022 7072 6f74             "prot
+00021bc0: 6f63 6f6c 223a 2077 732e 6164 6472 6573  ocol": ws.addres
+00021bd0: 732e 7370 6c69 7428 223a 2f2f 2229 5b30  s.split("://")[0
+00021be0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00021bf0: 2020 2022 686f 7374 223a 2077 732e 686f     "host": ws.ho
+00021c00: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00021c10: 2020 2020 2270 6f72 7422 3a20 706f 7274      "port": port
+00021c20: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00021c30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00021c40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021c50: 2077 732e 686f 7374 2c20 706f 7274 0a0a   ws.host, port..
+00021c60: 2020 2020 6173 796e 6320 6465 6620 7374      async def st
+00021c70: 6172 745f 756e 7361 6665 2873 656c 6629  art_unsafe(self)
+00021c80: 3a0a 2020 2020 2020 2020 2222 2243 6c65  :.        """Cle
+00021c90: 6172 206f 7574 206f 6c64 2073 7461 7465  ar out old state
+00021ca0: 2061 6e64 2072 6573 7461 7274 2061 6c6c   and restart all
+00021cb0: 2072 756e 6e69 6e67 2063 6f72 6f75 7469   running corouti
+00021cc0: 6e65 7322 2222 0a20 2020 2020 2020 2061  nes""".        a
+00021cd0: 7761 6974 2073 7570 6572 2829 2e73 7461  wait super().sta
+00021ce0: 7274 5f75 6e73 6166 6528 290a 0a20 2020  rt_unsafe()..   
+00021cf0: 2020 2020 2065 6e61 626c 655f 6763 5f64       enable_gc_d
+00021d00: 6961 676e 6f73 6973 2829 0a0a 2020 2020  iagnosis()..    
+00021d10: 2020 2020 7365 6c66 2e5f 636c 6561 725f      self._clear_
+00021d20: 7461 736b 5f73 7461 7465 2829 0a0a 2020  task_state()..  
+00021d30: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
+00021d40: 6e20 7365 6c66 2e5f 7374 6172 745f 6164  n self._start_ad
+00021d50: 6472 6573 733a 0a20 2020 2020 2020 2020  dress:.         
+00021d60: 2020 2061 7761 6974 2073 656c 662e 6c69     await self.li
+00021d70: 7374 656e 280a 2020 2020 2020 2020 2020  sten(.          
+00021d80: 2020 2020 2020 6164 6472 2c0a 2020 2020        addr,.    
+00021d90: 2020 2020 2020 2020 2020 2020 616c 6c6f              allo
+00021da0: 775f 6f66 666c 6f61 643d 4661 6c73 652c  w_offload=False,
+00021db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021dc0: 2068 616e 6473 6861 6b65 5f6f 7665 7272   handshake_overr
+00021dd0: 6964 6573 3d7b 2270 6963 6b6c 652d 7072  ides={"pickle-pr
+00021de0: 6f74 6f63 6f6c 223a 2034 2c20 2263 6f6d  otocol": 4, "com
+00021df0: 7072 6573 7369 6f6e 223a 204e 6f6e 657d  pression": None}
+00021e00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021e10: 2020 2a2a 7365 6c66 2e73 6563 7572 6974    **self.securit
+00021e20: 792e 6765 745f 6c69 7374 656e 5f61 7267  y.get_listen_arg
+00021e30: 7328 2273 6368 6564 756c 6572 2229 2c0a  s("scheduler"),.
+00021e40: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00021e50: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00021e60: 7020 3d20 6765 745f 6164 6472 6573 735f  p = get_address_
+00021e70: 686f 7374 2873 656c 662e 6c69 7374 656e  host(self.listen
+00021e80: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
+00021e90: 2020 2020 2020 6c69 7374 656e 5f69 7020        listen_ip 
+00021ea0: 3d20 7365 6c66 2e69 700a 0a20 2020 2020  = self.ip..     
+00021eb0: 2020 2020 2020 2069 6620 6c69 7374 656e         if listen
+00021ec0: 5f69 7020 3d3d 2022 302e 302e 302e 3022  _ip == "0.0.0.0"
+00021ed0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021ee0: 2020 6c69 7374 656e 5f69 7020 3d20 2222    listen_ip = ""
+00021ef0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00021f00: 662e 6164 6472 6573 732e 7374 6172 7473  f.address.starts
+00021f10: 7769 7468 2822 696e 7072 6f63 3a2f 2f22  with("inproc://"
+00021f20: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+00021f30: 6973 7465 6e5f 6970 203d 2022 6c6f 6361  isten_ip = "loca
+00021f40: 6c68 6f73 7422 0a0a 2020 2020 2020 2020  lhost"..        
+00021f50: 2320 5365 7276 6963 6573 206c 6973 7465  # Services liste
+00021f60: 6e20 6f6e 2061 6c6c 2061 6464 7265 7373  n on all address
+00021f70: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
+00021f80: 7374 6172 745f 7365 7276 6963 6573 286c  start_services(l
+00021f90: 6973 7465 6e5f 6970 290a 0a20 2020 2020  isten_ip)..     
+00021fa0: 2020 2066 6f72 206c 6973 7465 6e65 7220     for listener 
+00021fb0: 696e 2073 656c 662e 6c69 7374 656e 6572  in self.listener
+00021fc0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+00021fd0: 6f67 6765 722e 696e 666f 2822 2020 5363  ogger.info("  Sc
+00021fe0: 6865 6475 6c65 7220 6174 3a20 2532 3573  heduler at: %25s
+00021ff0: 222c 206c 6973 7465 6e65 722e 636f 6e74  ", listener.cont
+00022000: 6163 745f 6164 6472 6573 7329 0a20 2020  act_address).   
+00022010: 2020 2020 2066 6f72 206e 616d 652c 2073       for name, s
+00022020: 6572 7665 7220 696e 2073 656c 662e 7365  erver in self.se
+00022030: 7276 6963 6573 2e69 7465 6d73 2829 3a0a  rvices.items():.
+00022040: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00022050: 616d 6520 3d3d 2022 6461 7368 626f 6172  ame == "dashboar
+00022060: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+00022070: 2020 2020 6164 6472 203d 2067 6574 5f61      addr = get_a
+00022080: 6464 7265 7373 5f68 6f73 7428 6c69 7374  ddress_host(list
+00022090: 656e 6572 2e63 6f6e 7461 6374 5f61 6464  ener.contact_add
+000220a0: 7265 7373 290a 2020 2020 2020 2020 2020  ress).          
+000220b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000220c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000220d0: 696e 6b20 3d20 666f 726d 6174 5f64 6173  ink = format_das
+000220e0: 6862 6f61 7264 5f6c 696e 6b28 6164 6472  hboard_link(addr
+000220f0: 2c20 7365 7276 6572 2e70 6f72 7429 0a20  , server.port). 
+00022100: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00022110: 2066 6f72 6d61 7474 696e 6720 6461 7368   formatting dash
+00022120: 626f 6172 6420 6c69 6e6b 2063 616e 2066  board link can f
+00022130: 6169 6c20 6966 2064 6973 7472 6962 7574  ail if distribut
+00022140: 6564 2e64 6173 6862 6f61 7264 2e6c 696e  ed.dashboard.lin
+00022150: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+00022160: 2020 2320 7265 6665 7273 2074 6f20 6e6f    # refers to no
+00022170: 6e2d 6578 6973 7461 6e74 2065 6e76 2076  n-existant env v
+00022180: 6172 732e 0a20 2020 2020 2020 2020 2020  ars..           
+00022190: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+000221a0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+000221b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000221c0: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+000221d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221e0: 2020 2020 2020 2066 2246 6169 6c65 6420         f"Failed 
+000221f0: 746f 2066 6f72 6d61 7420 6461 7368 626f  to format dashbo
+00022200: 6172 6420 6c69 6e6b 2c20 756e 6b6e 6f77  ard link, unknow
+00022210: 6e20 7661 6c75 653a 207b 657d 220a 2020  n value: {e}".  
+00022220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022230: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00022240: 2020 2020 2020 2020 6c69 6e6b 203d 2066          link = f
+00022250: 223a 7b73 6572 7665 722e 706f 7274 7d22  ":{server.port}"
+00022260: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00022270: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00022280: 2020 206c 696e 6b20 3d20 6622 7b6c 6973     link = f"{lis
+00022290: 7465 6e5f 6970 7d3a 7b73 6572 7665 722e  ten_ip}:{server.
+000222a0: 706f 7274 7d22 0a20 2020 2020 2020 2020  port}".         
+000222b0: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+000222c0: 2531 3173 2061 743a 2020 2532 3573 222c  %11s at:  %25s",
+000222d0: 206e 616d 652c 206c 696e 6b29 0a0a 2020   name, link)..  
+000222e0: 2020 2020 2020 6966 2073 656c 662e 7363        if self.sc
+000222f0: 6865 6475 6c65 725f 6669 6c65 3a0a 2020  heduler_file:.  
+00022300: 2020 2020 2020 2020 2020 7769 7468 206f            with o
+00022310: 7065 6e28 7365 6c66 2e73 6368 6564 756c  pen(self.schedul
+00022320: 6572 5f66 696c 652c 2022 7722 2920 6173  er_file, "w") as
+00022330: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00022340: 2020 2020 6a73 6f6e 2e64 756d 7028 7365      json.dump(se
+00022350: 6c66 2e69 6465 6e74 6974 7928 292c 2066  lf.identity(), f
+00022360: 2c20 696e 6465 6e74 3d32 290a 0a20 2020  , indent=2)..   
+00022370: 2020 2020 2020 2020 2066 6e20 3d20 7365           fn = se
+00022380: 6c66 2e73 6368 6564 756c 6572 5f66 696c  lf.scheduler_fil
+00022390: 6520 2023 2072 656d 6f76 6520 6669 6c65  e  # remove file
+000223a0: 2077 6865 6e20 7765 2063 6c6f 7365 2074   when we close t
+000223b0: 6865 2070 726f 6365 7373 0a0a 2020 2020  he process..    
+000223c0: 2020 2020 2020 2020 6465 6620 6465 6c5f          def del_
+000223d0: 7363 6865 6475 6c65 725f 6669 6c65 2829  scheduler_file()
+000223e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000223f0: 2020 6966 206f 732e 7061 7468 2e65 7869    if os.path.exi
+00022400: 7374 7328 666e 293a 0a20 2020 2020 2020  sts(fn):.       
+00022410: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00022420: 7265 6d6f 7665 2866 6e29 0a0a 2020 2020  remove(fn)..    
+00022430: 2020 2020 2020 2020 7765 616b 7265 662e          weakref.
+00022440: 6669 6e61 6c69 7a65 2873 656c 662c 2064  finalize(self, d
+00022450: 656c 5f73 6368 6564 756c 6572 5f66 696c  el_scheduler_fil
+00022460: 6529 0a0a 2020 2020 2020 2020 666f 7220  e)..        for 
+00022470: 7072 656c 6f61 6420 696e 2073 656c 662e  preload in self.
+00022480: 7072 656c 6f61 6473 3a0a 2020 2020 2020  preloads:.      
+00022490: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000224a0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+000224b0: 2070 7265 6c6f 6164 2e73 7461 7274 2829   preload.start()
+000224c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+000224d0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+000224e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000224f0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+00022500: 2246 6169 6c65 6420 746f 2073 7461 7274  "Failed to start
+00022510: 2070 7265 6c6f 6164 2229 0a0a 2020 2020   preload")..    
+00022520: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
+00022530: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+00022540: 2023 2041 6c6c 6f77 2069 6e73 6563 7572   # Allow insecur
+00022550: 6520 636f 6d6d 756e 6963 6174 696f 6e73  e communications
+00022560: 2066 726f 6d20 6c6f 6361 6c20 7573 6572   from local user
+00022570: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+00022580: 2073 656c 662e 6164 6472 6573 732e 7374   self.address.st
+00022590: 6172 7473 7769 7468 2822 746c 733a 2f2f  artswith("tls://
+000225a0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+000225b0: 2020 2020 6177 6169 7420 7365 6c66 2e6c      await self.l
+000225c0: 6973 7465 6e28 2274 6370 3a2f 2f6c 6f63  isten("tcp://loc
+000225d0: 616c 686f 7374 3a30 2229 0a20 2020 2020  alhost:0").     
+000225e0: 2020 2020 2020 206f 732e 656e 7669 726f         os.enviro
+000225f0: 6e5b 2244 4153 4b5f 5343 4845 4455 4c45  n["DASK_SCHEDULE
+00022600: 525f 4144 4452 4553 5322 5d20 3d20 7365  R_ADDRESS"] = se
+00022610: 6c66 2e6c 6973 7465 6e65 7273 5b2d 315d  lf.listeners[-1]
+00022620: 2e63 6f6e 7461 6374 5f61 6464 7265 7373  .contact_address
+00022630: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
+00022640: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00022650: 2020 2020 2020 2020 2020 2020 2a5b 706c              *[pl
+00022660: 7567 696e 2e73 7461 7274 2873 656c 6629  ugin.start(self)
+00022670: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00022680: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00022690: 2e76 616c 7565 7328 2929 5d0a 2020 2020  .values())].    
+000226a0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+000226b0: 656c 662e 7374 6172 745f 7065 7269 6f64  elf.start_period
+000226c0: 6963 5f63 616c 6c62 6163 6b73 2829 0a0a  ic_callbacks()..
+000226d0: 2020 2020 2020 2020 7365 7470 726f 6374          setproct
+000226e0: 6974 6c65 2866 2264 6173 6b20 7363 6865  itle(f"dask sche
+000226f0: 6475 6c65 7220 5b7b 7365 6c66 2e61 6464  duler [{self.add
+00022700: 7265 7373 7d5d 2229 0a20 2020 2020 2020  ress}]").       
+00022710: 2072 6574 7572 6e20 7365 6c66 0a0a 2020   return self..  
+00022720: 2020 6173 796e 6320 6465 6620 636c 6f73    async def clos
+00022730: 6528 7365 6c66 2c20 6661 7374 3d4e 6f6e  e(self, fast=Non
+00022740: 652c 2063 6c6f 7365 5f77 6f72 6b65 7273  e, close_workers
+00022750: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+00022760: 2222 2253 656e 6420 636c 6561 6e75 7020  """Send cleanup 
+00022770: 7369 676e 616c 2074 6f20 616c 6c20 636f  signal to all co
+00022780: 726f 7574 696e 6573 2074 6865 6e20 7761  routines then wa
+00022790: 6974 2075 6e74 696c 2066 696e 6973 6865  it until finishe
+000227a0: 640a 0a20 2020 2020 2020 2053 6565 2041  d..        See A
+000227b0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+000227c0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+000227d0: 6564 756c 6572 2e63 6c65 616e 7570 0a20  eduler.cleanup. 
+000227e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000227f0: 2020 2069 6620 6661 7374 2069 7320 6e6f     if fast is no
+00022800: 7420 4e6f 6e65 206f 7220 636c 6f73 655f  t None or close_
+00022810: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
+00022820: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00022830: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
+00022840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022850: 2254 6865 2027 6661 7374 2720 616e 6420  "The 'fast' and 
+00022860: 2763 6c6f 7365 5f77 6f72 6b65 7273 2720  'close_workers' 
+00022870: 7061 7261 6d65 7465 7273 2069 6e20 5363  parameters in Sc
+00022880: 6865 6475 6c65 722e 636c 6f73 6520 6861  heduler.close ha
+00022890: 7665 206e 6f20 6566 6665 6374 2061 6e64  ve no effect and
+000228a0: 2077 696c 6c20 6265 2072 656d 6f76 6564   will be removed
+000228b0: 2069 6e20 6120 6675 7475 7265 2076 6572   in a future ver
+000228c0: 7369 6f6e 206f 6620 6469 7374 7269 6275  sion of distribu
+000228d0: 7465 642e 222c 0a20 2020 2020 2020 2020  ted.",.         
+000228e0: 2020 2020 2020 2046 7574 7572 6557 6172         FutureWar
+000228f0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+00022900: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
+00022910: 656c 662e 7374 6174 7573 2069 6e20 2853  elf.status in (S
+00022920: 7461 7475 732e 636c 6f73 696e 672c 2053  tatus.closing, S
+00022930: 7461 7475 732e 636c 6f73 6564 293a 0a20  tatus.closed):. 
+00022940: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00022950: 2073 656c 662e 6669 6e69 7368 6564 2829   self.finished()
+00022960: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00022970: 7572 6e0a 0a20 2020 2020 2020 2061 7379  urn..        asy
+00022980: 6e63 2064 6566 206c 6f67 5f65 7272 6f72  nc def log_error
+00022990: 7328 6675 6e63 293a 0a20 2020 2020 2020  s(func):.       
+000229a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000229b0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+000229c0: 6675 6e63 2829 0a20 2020 2020 2020 2020  func().         
+000229d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000229e0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+000229f0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00022a00: 7074 696f 6e28 2250 6c75 6769 6e20 6361  ption("Plugin ca
+00022a10: 6c6c 2066 6169 6c65 6420 6475 7269 6e67  ll failed during
+00022a20: 2073 6368 6564 756c 6572 2e63 6c6f 7365   scheduler.close
+00022a30: 2229 0a0a 2020 2020 2020 2020 6177 6169  ")..        awai
+00022a40: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+00022a50: 280a 2020 2020 2020 2020 2020 2020 2a5b  (.            *[
+00022a60: 6c6f 675f 6572 726f 7273 2870 6c75 6769  log_errors(plugi
+00022a70: 6e2e 6265 666f 7265 5f63 6c6f 7365 2920  n.before_close) 
+00022a80: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+00022a90: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+00022aa0: 7661 6c75 6573 2829 295d 0a20 2020 2020  values())].     
+00022ab0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00022ac0: 6c66 2e73 7461 7475 7320 3d20 5374 6174  lf.status = Stat
+00022ad0: 7573 2e63 6c6f 7369 6e67 0a0a 2020 2020  us.closing..    
+00022ae0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00022af0: 2253 6368 6564 756c 6572 2063 6c6f 7369  "Scheduler closi
+00022b00: 6e67 2e2e 2e22 290a 2020 2020 2020 2020  ng...").        
+00022b10: 7365 7470 726f 6374 6974 6c65 2822 6461  setproctitle("da
+00022b20: 736b 2073 6368 6564 756c 6572 205b 636c  sk scheduler [cl
+00022b30: 6f73 696e 675d 2229 0a0a 2020 2020 2020  osing]")..      
+00022b40: 2020 666f 7220 7072 656c 6f61 6420 696e    for preload in
+00022b50: 2073 656c 662e 7072 656c 6f61 6473 3a0a   self.preloads:.
+00022b60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00022b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b80: 2061 7761 6974 2070 7265 6c6f 6164 2e74   await preload.t
+00022b90: 6561 7264 6f77 6e28 290a 2020 2020 2020  eardown().      
+00022ba0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00022bb0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00022bc0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+00022bd0: 7863 6570 7469 6f6e 2822 4661 696c 6564  xception("Failed
+00022be0: 2074 6f20 7465 6172 2064 6f77 6e20 7072   to tear down pr
+00022bf0: 656c 6f61 6422 290a 0a20 2020 2020 2020  eload")..       
+00022c00: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00022c10: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00022c20: 2020 202a 5b6c 6f67 5f65 7272 6f72 7328     *[log_errors(
+00022c30: 706c 7567 696e 2e63 6c6f 7365 2920 666f  plugin.close) fo
+00022c40: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+00022c50: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+00022c60: 6c75 6573 2829 295d 0a20 2020 2020 2020  lues())].       
+00022c70: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
+00022c80: 7063 2069 6e20 7365 6c66 2e70 6572 696f  pc in self.perio
+00022c90: 6469 635f 6361 6c6c 6261 636b 732e 7661  dic_callbacks.va
+00022ca0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00022cb0: 2020 2020 7063 2e73 746f 7028 290a 2020      pc.stop().  
+00022cc0: 2020 2020 2020 7365 6c66 2e70 6572 696f        self.perio
+00022cd0: 6469 635f 6361 6c6c 6261 636b 732e 636c  dic_callbacks.cl
+00022ce0: 6561 7228 290a 0a20 2020 2020 2020 2073  ear()..        s
+00022cf0: 656c 662e 7374 6f70 5f73 6572 7669 6365  elf.stop_service
+00022d00: 7328 290a 0a20 2020 2020 2020 2066 6f72  s()..        for
+00022d10: 2065 7874 2069 6e20 7365 6c66 2e65 7874   ext in self.ext
+00022d20: 656e 7369 6f6e 732e 7661 6c75 6573 2829  ensions.values()
+00022d30: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00022d40: 7468 2073 7570 7072 6573 7328 4174 7472  th suppress(Attr
+00022d50: 6962 7574 6545 7272 6f72 293a 0a20 2020  ibuteError):.   
+00022d60: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00022d70: 2e74 6561 7264 6f77 6e28 290a 2020 2020  .teardown().    
+00022d80: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00022d90: 2253 6368 6564 756c 6572 2063 6c6f 7369  "Scheduler closi
+00022da0: 6e67 2061 6c6c 2063 6f6d 6d73 2229 0a0a  ng all comms")..
+00022db0: 2020 2020 2020 2020 6675 7475 7265 7320          futures 
+00022dc0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+00022dd0: 205f 2c20 636f 6d6d 2069 6e20 6c69 7374   _, comm in list
+00022de0: 2873 656c 662e 7374 7265 616d 5f63 6f6d  (self.stream_com
+00022df0: 6d73 2e69 7465 6d73 2829 293a 0a20 2020  ms.items()):.   
+00022e00: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+00022e10: 2075 7365 2060 7365 6c66 2e72 656d 6f76   use `self.remov
+00022e20: 655f 776f 726b 6572 2829 6020 696e 7374  e_worker()` inst
+00022e30: 6561 6420 6166 7465 7220 6874 7470 733a  ead after https:
+00022e40: 2f2f 6769 7468 7562 2e63 6f6d 2f64 6173  //github.com/das
+00022e50: 6b2f 6469 7374 7269 6275 7465 642f 6973  k/distributed/is
+00022e60: 7375 6573 2f36 3339 300a 2020 2020 2020  sues/6390.      
+00022e70: 2020 2020 2020 6966 206e 6f74 2063 6f6d        if not com
+00022e80: 6d2e 636c 6f73 6564 2829 3a0a 2020 2020  m.closed():.    
+00022e90: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00022ea0: 6973 2063 6c6f 7365 7320 7468 6520 576f  is closes the Wo
+00022eb0: 726b 6572 2061 6e64 2065 6e73 7572 6573  rker and ensures
+00022ec0: 2074 6861 7420 6966 2061 204e 616e 6e79   that if a Nanny
+00022ed0: 2069 7320 6172 6f75 6e64 2c0a 2020 2020   is around,.    
+00022ee0: 2020 2020 2020 2020 2020 2020 2320 6974              # it
+00022ef0: 2069 7320 636c 6f73 6564 2061 7320 7765   is closed as we
+00022f00: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+00022f10: 2020 2063 6f6d 6d2e 7365 6e64 287b 226f     comm.send({"o
+00022f20: 7022 3a20 2263 6c6f 7365 222c 2022 7265  p": "close", "re
+00022f30: 6173 6f6e 223a 2022 7363 6865 6475 6c65  ason": "schedule
+00022f40: 722d 636c 6f73 6522 7d29 0a20 2020 2020  r-close"}).     
+00022f50: 2020 2020 2020 2020 2020 2063 6f6d 6d2e             comm.
+00022f60: 7365 6e64 287b 226f 7022 3a20 2263 6c6f  send({"op": "clo
+00022f70: 7365 2d73 7472 6561 6d22 7d29 0a20 2020  se-stream"}).   
+00022f80: 2020 2020 2020 2020 2020 2020 2023 205e               # ^
+00022f90: 2054 4f44 4f20 7265 6d6f 7665 3f20 6057   TODO remove? `W
+00022fa0: 6f72 6b65 722e 636c 6f73 6560 2077 696c  orker.close` wil
+00022fb0: 6c20 636c 6f73 6520 7468 6520 7374 7265  l close the stre
+00022fc0: 616d 2061 6e79 7761 792e 0a20 2020 2020  am anyway..     
+00022fd0: 2020 2020 2020 2077 6974 6820 7375 7070         with supp
+00022fe0: 7265 7373 2841 7474 7269 6275 7465 4572  ress(AttributeEr
+00022ff0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00023000: 2020 2020 2020 6675 7475 7265 732e 6170        futures.ap
+00023010: 7065 6e64 2863 6f6d 6d2e 636c 6f73 6528  pend(comm.close(
+00023020: 2929 0a0a 2020 2020 2020 2020 6177 6169  ))..        awai
+00023030: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+00023040: 282a 6675 7475 7265 7329 0a0a 2020 2020  (*futures)..    
+00023050: 2020 2020 6966 2073 656c 662e 6a75 7079      if self.jupy
+00023060: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+00023070: 2061 7761 6974 2073 656c 662e 5f6a 7570   await self._jup
+00023080: 7974 6572 5f73 6572 7665 725f 6170 706c  yter_server_appl
+00023090: 6963 6174 696f 6e2e 5f63 6c65 616e 7570  ication._cleanup
+000230a0: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
+000230b0: 636f 6d6d 2069 6e20 7365 6c66 2e63 6c69  comm in self.cli
+000230c0: 656e 745f 636f 6d6d 732e 7661 6c75 6573  ent_comms.values
+000230d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000230e0: 636f 6d6d 2e61 626f 7274 2829 0a0a 2020  comm.abort()..  
+000230f0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00023100: 2e72 7063 2e63 6c6f 7365 2829 0a0a 2020  .rpc.close()..  
+00023110: 2020 2020 2020 7365 6c66 2e73 7461 7475        self.statu
+00023120: 7320 3d20 5374 6174 7573 2e63 6c6f 7365  s = Status.close
+00023130: 640a 2020 2020 2020 2020 7365 6c66 2e73  d.        self.s
+00023140: 746f 7028 290a 2020 2020 2020 2020 6177  top().        aw
+00023150: 6169 7420 7375 7065 7228 292e 636c 6f73  ait super().clos
+00023160: 6528 290a 0a20 2020 2020 2020 2073 6574  e()..        set
+00023170: 7072 6f63 7469 746c 6528 2264 6173 6b20  proctitle("dask 
+00023180: 7363 6865 6475 6c65 7220 5b63 6c6f 7365  scheduler [close
+00023190: 645d 2229 0a20 2020 2020 2020 2064 6973  d]").        dis
+000231a0: 6162 6c65 5f67 635f 6469 6167 6e6f 7369  able_gc_diagnosi
+000231b0: 7328 290a 0a20 2020 2023 2323 2323 2323  s()..    #######
+000231c0: 2323 2323 0a20 2020 2023 2053 7469 6d75  ####.    # Stimu
+000231d0: 6c69 2023 0a20 2020 2023 2323 2323 2323  li #.    #######
+000231e0: 2323 2323 0a0a 2020 2020 6465 6620 6865  ####..    def he
+000231f0: 6172 7462 6561 745f 776f 726b 6572 280a  artbeat_worker(.
+00023200: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00023210: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00023220: 2061 6464 7265 7373 3a20 7374 722c 0a20   address: str,. 
+00023230: 2020 2020 2020 2072 6573 6f6c 7665 5f61         resolve_a
+00023240: 6464 7265 7373 3a20 626f 6f6c 203d 2054  ddress: bool = T
+00023250: 7275 652c 0a20 2020 2020 2020 206e 6f77  rue,.        now
+00023260: 3a20 666c 6f61 7420 7c20 4e6f 6e65 203d  : float | None =
+00023270: 204e 6f6e 652c 0a20 2020 2020 2020 2072   None,.        r
+00023280: 6573 6f75 7263 6573 3a20 6469 6374 5b73  esources: dict[s
+00023290: 7472 2c20 666c 6f61 745d 207c 204e 6f6e  tr, float] | Non
+000232a0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000232b0: 2020 686f 7374 5f69 6e66 6f3a 2064 6963    host_info: dic
+000232c0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+000232d0: 0a20 2020 2020 2020 206d 6574 7269 6373  .        metrics
+000232e0: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
+000232f0: 6578 6563 7574 696e 673a 2064 6963 745b  executing: dict[
+00023300: 7374 722c 2066 6c6f 6174 5d20 7c20 4e6f  str, float] | No
+00023310: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00023320: 2020 2065 7874 656e 7369 6f6e 733a 2064     extensions: d
+00023330: 6963 7420 7c20 4e6f 6e65 203d 204e 6f6e  ict | None = Non
+00023340: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
+00023350: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00023360: 2020 2020 6164 6472 6573 7320 3d20 7365      address = se
+00023370: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
+00023380: 7328 6164 6472 6573 732c 2072 6573 6f6c  s(address, resol
+00023390: 7665 5f61 6464 7265 7373 290a 2020 2020  ve_address).    
+000233a0: 2020 2020 6164 6472 6573 7320 3d20 6e6f      address = no
+000233b0: 726d 616c 697a 655f 6164 6472 6573 7328  rmalize_address(
+000233c0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+000233d0: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
+000233e0: 7273 2e67 6574 2861 6464 7265 7373 290a  rs.get(address).
+000233f0: 2020 2020 2020 2020 6966 2077 7320 6973          if ws is
+00023400: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00023410: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00023420: 6728 6622 5265 6365 6976 6564 2068 6561  g(f"Received hea
+00023430: 7274 6265 6174 2066 726f 6d20 756e 7265  rtbeat from unre
+00023440: 6769 7374 6572 6564 2077 6f72 6b65 7220  gistered worker 
+00023450: 7b61 6464 7265 7373 2172 7d2e 2229 0a20  {address!r}."). 
+00023460: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00023470: 6e20 7b22 7374 6174 7573 223a 2022 6d69  n {"status": "mi
+00023480: 7373 696e 6722 7d0a 0a20 2020 2020 2020  ssing"}..       
+00023490: 2068 6f73 7420 3d20 6765 745f 6164 6472   host = get_addr
+000234a0: 6573 735f 686f 7374 2861 6464 7265 7373  ess_host(address
+000234b0: 290a 2020 2020 2020 2020 6c6f 6361 6c5f  ).        local_
+000234c0: 6e6f 7720 3d20 7469 6d65 2829 0a20 2020  now = time().   
+000234d0: 2020 2020 2068 6f73 745f 696e 666f 203d       host_info =
+000234e0: 2068 6f73 745f 696e 666f 206f 7220 7b7d   host_info or {}
+000234f0: 0a0a 2020 2020 2020 2020 6468 3a20 6469  ..        dh: di
+00023500: 6374 203d 2073 656c 662e 686f 7374 5f69  ct = self.host_i
+00023510: 6e66 6f2e 7365 7464 6566 6175 6c74 2868  nfo.setdefault(h
+00023520: 6f73 742c 207b 7d29 0a20 2020 2020 2020  ost, {}).       
+00023530: 2064 685b 226c 6173 742d 7365 656e 225d   dh["last-seen"]
+00023540: 203d 206c 6f63 616c 5f6e 6f77 0a0a 2020   = local_now..  
+00023550: 2020 2020 2020 6672 6163 203d 2031 202f        frac = 1 /
+00023560: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+00023570: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00023580: 6261 6e64 7769 6474 6820 3d20 280a 2020  bandwidth = (.  
+00023590: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+000235a0: 616e 6477 6964 7468 202a 2028 3120 2d20  andwidth * (1 - 
+000235b0: 6672 6163 2920 2b20 6d65 7472 6963 735b  frac) + metrics[
+000235c0: 2262 616e 6477 6964 7468 225d 5b22 746f  "bandwidth"]["to
+000235d0: 7461 6c22 5d20 2a20 6672 6163 0a20 2020  tal"] * frac.   
+000235e0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+000235f0: 6f72 206f 7468 6572 2c20 2862 772c 2063  or other, (bw, c
+00023600: 6f75 6e74 2920 696e 206d 6574 7269 6373  ount) in metrics
+00023610: 5b22 6261 6e64 7769 6474 6822 5d5b 2277  ["bandwidth"]["w
+00023620: 6f72 6b65 7273 225d 2e69 7465 6d73 2829  orkers"].items()
+00023630: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00023640: 2028 6164 6472 6573 732c 206f 7468 6572   (address, other
+00023650: 2920 6e6f 7420 696e 2073 656c 662e 6261  ) not in self.ba
+00023660: 6e64 7769 6474 685f 776f 726b 6572 733a  ndwidth_workers:
+00023670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023680: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
+00023690: 776f 726b 6572 735b 6164 6472 6573 732c  workers[address,
+000236a0: 206f 7468 6572 5d20 3d20 6277 202f 2063   other] = bw / c
+000236b0: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
+000236c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000236d0: 2020 2020 2020 2061 6c70 6861 203d 2028         alpha = (
+000236e0: 3120 2d20 6672 6163 2920 2a2a 2063 6f75  1 - frac) ** cou
+000236f0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00023700: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+00023710: 685f 776f 726b 6572 735b 6164 6472 6573  h_workers[addres
+00023720: 732c 206f 7468 6572 5d20 3d20 7365 6c66  s, other] = self
+00023730: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
+00023740: 7273 5b0a 2020 2020 2020 2020 2020 2020  rs[.            
+00023750: 2020 2020 2020 2020 6164 6472 6573 732c          address,
+00023760: 206f 7468 6572 0a20 2020 2020 2020 2020   other.         
+00023770: 2020 2020 2020 205d 202a 2061 6c70 6861         ] * alpha
+00023780: 202b 2062 7720 2a20 2831 202d 2061 6c70   + bw * (1 - alp
+00023790: 6861 290a 2020 2020 2020 2020 666f 7220  ha).        for 
+000237a0: 7479 702c 2028 6277 2c20 636f 756e 7429  typ, (bw, count)
+000237b0: 2069 6e20 6d65 7472 6963 735b 2262 616e   in metrics["ban
+000237c0: 6477 6964 7468 225d 5b22 7479 7065 7322  dwidth"]["types"
+000237d0: 5d2e 6974 656d 7328 293a 0a20 2020 2020  ].items():.     
+000237e0: 2020 2020 2020 2069 6620 7479 7020 6e6f         if typ no
+000237f0: 7420 696e 2073 656c 662e 6261 6e64 7769  t in self.bandwi
+00023800: 6474 685f 7479 7065 733a 0a20 2020 2020  dth_types:.     
+00023810: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023820: 6261 6e64 7769 6474 685f 7479 7065 735b  bandwidth_types[
+00023830: 7479 705d 203d 2062 7720 2f20 636f 756e  typ] = bw / coun
+00023840: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00023850: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00023860: 2020 2020 616c 7068 6120 3d20 2831 202d      alpha = (1 -
+00023870: 2066 7261 6329 202a 2a20 636f 756e 740a   frac) ** count.
+00023880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023890: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
+000238a0: 7970 6573 5b74 7970 5d20 3d20 7365 6c66  ypes[typ] = self
+000238b0: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
+000238c0: 5b74 7970 5d20 2a20 616c 7068 6120 2b20  [typ] * alpha + 
+000238d0: 6277 202a 2028 0a20 2020 2020 2020 2020  bw * (.         
+000238e0: 2020 2020 2020 2020 2020 2031 202d 2061             1 - a
+000238f0: 6c70 6861 0a20 2020 2020 2020 2020 2020  lpha.           
+00023900: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00023910: 7773 2e6c 6173 745f 7365 656e 203d 206c  ws.last_seen = l
+00023920: 6f63 616c 5f6e 6f77 0a20 2020 2020 2020  ocal_now.       
+00023930: 2069 6620 6578 6563 7574 696e 6720 6973   if executing is
+00023940: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00023950: 2020 2020 2020 2023 204e 4f54 453a 2074         # NOTE: t
+00023960: 6865 2065 7865 6375 7469 6e67 2064 6963  he executing dic
+00023970: 7420 6973 2075 6e75 7365 640a 2020 2020  t is unused.    
+00023980: 2020 2020 2020 2020 7773 2e65 7865 6375          ws.execu
+00023990: 7469 6e67 203d 207b 7d0a 2020 2020 2020  ting = {}.      
+000239a0: 2020 2020 2020 666f 7220 6b65 792c 2064        for key, d
+000239b0: 7572 6174 696f 6e20 696e 2065 7865 6375  uration in execu
+000239c0: 7469 6e67 2e69 7465 6d73 2829 3a0a 2020  ting.items():.  
+000239d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000239e0: 206b 6579 2069 6e20 7365 6c66 2e74 6173   key in self.tas
+000239f0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+00023a00: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00023a10: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+00023a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a30: 2077 732e 6578 6563 7574 696e 675b 7473   ws.executing[ts
+00023a40: 5d20 3d20 6475 7261 7469 6f6e 0a20 2020  ] = duration.   
+00023a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a60: 2074 732e 7072 6566 6978 2e61 6464 5f65   ts.prefix.add_e
+00023a70: 7865 635f 7469 6d65 2864 7572 6174 696f  xec_time(duratio
+00023a80: 6e29 0a0a 2020 2020 2020 2020 666f 7220  n)..        for 
+00023a90: 6e61 6d65 2c20 7661 6c75 6520 696e 206d  name, value in m
+00023aa0: 6574 7269 6373 5b22 6469 6765 7374 735f  etrics["digests_
+00023ab0: 746f 7461 6c5f 7369 6e63 655f 6865 6172  total_since_hear
+00023ac0: 7462 6561 7422 5d2e 6974 656d 7328 293a  tbeat"].items():
+00023ad0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00023ae0: 662e 6375 6d75 6c61 7469 7665 5f77 6f72  f.cumulative_wor
+00023af0: 6b65 725f 6d65 7472 6963 735b 6e61 6d65  ker_metrics[name
+00023b00: 5d20 2b3d 2076 616c 7565 0a0a 2020 2020  ] += value..    
+00023b10: 2020 2020 7773 2e6d 6574 7269 6373 203d      ws.metrics =
+00023b20: 206d 6574 7269 6373 0a0a 2020 2020 2020   metrics..      
+00023b30: 2020 2320 4361 6c63 756c 6174 6520 5253    # Calculate RS
+00023b40: 5320 2d20 6461 736b 206b 6579 732c 2073  S - dask keys, s
+00023b50: 6570 6172 6174 696e 6720 226f 6c64 2220  eparating "old" 
+00023b60: 616e 6420 226e 6577 2220 7573 6167 650a  and "new" usage.
+00023b70: 2020 2020 2020 2020 2320 5365 6520 4d65          # See Me
+00023b80: 6d6f 7279 5374 6174 6520 666f 7220 6465  moryState for de
+00023b90: 7461 696c 730a 2020 2020 2020 2020 6d61  tails.        ma
+00023ba0: 785f 6d65 6d6f 7279 5f75 6e6d 616e 6167  x_memory_unmanag
+00023bb0: 6564 5f6f 6c64 5f68 6973 745f 6167 6520  ed_old_hist_age 
+00023bc0: 3d20 6c6f 6361 6c5f 6e6f 7720 2d20 7365  = local_now - se
+00023bd0: 6c66 2e4d 454d 4f52 595f 5245 4345 4e54  lf.MEMORY_RECENT
+00023be0: 5f54 4f5f 4f4c 445f 5449 4d45 0a20 2020  _TO_OLD_TIME.   
+00023bf0: 2020 2020 206d 656d 6f72 795f 756e 6d61       memory_unma
+00023c00: 6e61 6765 645f 6f6c 6420 3d20 7773 2e5f  naged_old = ws._
+00023c10: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+00023c20: 5f6f 6c64 0a20 2020 2020 2020 2077 6869  _old.        whi
+00023c30: 6c65 2077 732e 5f6d 656d 6f72 795f 756e  le ws._memory_un
+00023c40: 6d61 6e61 6765 645f 6869 7374 6f72 793a  managed_history:
+00023c50: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+00023c60: 6573 7461 6d70 2c20 7369 7a65 203d 2077  estamp, size = w
+00023c70: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
+00023c80: 6765 645f 6869 7374 6f72 795b 305d 0a20  ged_history[0]. 
+00023c90: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
+00023ca0: 6d65 7374 616d 7020 3e3d 206d 6178 5f6d  mestamp >= max_m
+00023cb0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00023cc0: 6f6c 645f 6869 7374 5f61 6765 3a0a 2020  old_hist_age:.  
+00023cd0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00023ce0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
+00023cf0: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
+00023d00: 6167 6564 5f68 6973 746f 7279 2e70 6f70  aged_history.pop
+00023d10: 6c65 6674 2829 0a20 2020 2020 2020 2020  left().         
+00023d20: 2020 2069 6620 7369 7a65 203d 3d20 6d65     if size == me
+00023d30: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00023d40: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
+00023d50: 2020 2020 6d65 6d6f 7279 5f75 6e6d 616e      memory_unman
+00023d60: 6167 6564 5f6f 6c64 203d 2030 2020 2320  aged_old = 0  # 
+00023d70: 7265 6361 6c63 756c 6174 6520 6d69 6e28  recalculate min(
+00023d80: 290a 0a20 2020 2020 2020 2023 2077 732e  )..        # ws.
+00023d90: 5f6e 6279 7465 7320 6973 2075 7064 6174  _nbytes is updat
+00023da0: 6564 2061 7420 6120 6469 6666 6572 656e  ed at a differen
+00023db0: 7420 7469 6d65 2061 6e64 2073 697a 656f  t time and sizeo
+00023dc0: 6628 2920 6d61 7920 6e6f 7420 6265 2061  f() may not be a
+00023dd0: 6363 7572 6174 652c 0a20 2020 2020 2020  ccurate,.       
+00023de0: 2023 2073 6f20 7369 7a65 206d 6179 2062   # so size may b
+00023df0: 6520 2874 656d 706f 7261 7269 6c79 2920  e (temporarily) 
+00023e00: 6e65 6761 7469 7665 3b20 666c 6f6f 7220  negative; floor 
+00023e10: 6974 2074 6f20 7a65 726f 2e0a 2020 2020  it to zero..    
+00023e20: 2020 2020 7369 7a65 203d 206d 6178 280a      size = max(.
+00023e30: 2020 2020 2020 2020 2020 2020 302c 206d              0, m
+00023e40: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
+00023e50: 202d 2077 732e 6e62 7974 6573 202b 206d   - ws.nbytes + m
+00023e60: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
+00023e70: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
+00023e80: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
+00023e90: 2020 2020 2077 732e 5f6d 656d 6f72 795f       ws._memory_
+00023ea0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+00023eb0: 792e 6170 7065 6e64 2828 6c6f 6361 6c5f  y.append((local_
+00023ec0: 6e6f 772c 2073 697a 6529 290a 2020 2020  now, size)).    
+00023ed0: 2020 2020 6966 206e 6f74 206d 656d 6f72      if not memor
+00023ee0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
+00023ef0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00023f00: 6865 2077 6f72 6b65 7220 6861 7320 6a75  he worker has ju
+00023f10: 7374 2062 6565 6e20 7374 6172 7465 6420  st been started 
+00023f20: 6f72 2074 6865 2070 7265 7669 6f75 7320  or the previous 
+00023f30: 6d69 6e69 6d75 6d20 6861 7320 6265 656e  minimum has been
+00023f40: 2065 7870 756e 6765 640a 2020 2020 2020   expunged.      
+00023f50: 2020 2020 2020 2320 6265 6361 7573 6520        # because 
+00023f60: 746f 6f20 6f6c 642e 0a20 2020 2020 2020  too old..       
+00023f70: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
+00023f80: 7320 616c 676f 7269 7468 6d20 6973 2063  s algorithm is c
+00023f90: 6170 7065 6420 746f 2032 3030 202a 204d  apped to 200 * M
+00023fa0: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
+00023fb0: 4f4c 445f 5449 4d45 2065 6c65 6d65 6e74  OLD_TIME element
+00023fc0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00023fd0: 636c 7573 7465 722d 7769 6465 2062 7920  cluster-wide by 
+00023fe0: 6865 6172 7462 6561 745f 696e 7465 7276  heartbeat_interv
+00023ff0: 616c 2829 2c20 7265 6761 7264 6c65 7373  al(), regardless
+00024000: 206f 6620 7468 6520 6e75 6d62 6572 206f   of the number o
+00024010: 6620 776f 726b 6572 730a 2020 2020 2020  f workers.      
+00024020: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
+00024030: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
+00024040: 206d 696e 286d 6170 2873 6563 6f6e 642c   min(map(second,
+00024050: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
+00024060: 6e61 6765 645f 6869 7374 6f72 7929 290a  naged_history)).
+00024070: 2020 2020 2020 2020 656c 6966 2073 697a          elif siz
+00024080: 6520 3c20 6d65 6d6f 7279 5f75 6e6d 616e  e < memory_unman
+00024090: 6167 6564 5f6f 6c64 3a0a 2020 2020 2020  aged_old:.      
+000240a0: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
+000240b0: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
+000240c0: 2073 697a 650a 0a20 2020 2020 2020 2069   size..        i
+000240d0: 6620 686f 7374 5f69 6e66 6f3a 0a20 2020  f host_info:.   
+000240e0: 2020 2020 2020 2020 2064 6820 3d20 7365           dh = se
+000240f0: 6c66 2e68 6f73 745f 696e 666f 2e73 6574  lf.host_info.set
+00024100: 6465 6661 756c 7428 686f 7374 2c20 7b7d  default(host, {}
+00024110: 290a 2020 2020 2020 2020 2020 2020 6468  ).            dh
+00024120: 2e75 7064 6174 6528 686f 7374 5f69 6e66  .update(host_inf
+00024130: 6f29 0a0a 2020 2020 2020 2020 6966 206e  o)..        if n
+00024140: 6f77 3a0a 2020 2020 2020 2020 2020 2020  ow:.            
+00024150: 7773 2e74 696d 655f 6465 6c61 7920 3d20  ws.time_delay = 
+00024160: 6c6f 6361 6c5f 6e6f 7720 2d20 6e6f 770a  local_now - now.
+00024170: 0a20 2020 2020 2020 2069 6620 7265 736f  .        if reso
+00024180: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
+00024190: 2020 2073 656c 662e 6164 645f 7265 736f     self.add_reso
+000241a0: 7572 6365 7328 776f 726b 6572 3d61 6464  urces(worker=add
+000241b0: 7265 7373 2c20 7265 736f 7572 6365 733d  ress, resources=
+000241c0: 7265 736f 7572 6365 7329 0a0a 2020 2020  resources)..    
+000241d0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
+000241e0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+000241f0: 6f72 206e 616d 652c 2064 6174 6120 696e  or name, data in
+00024200: 2065 7874 656e 7369 6f6e 732e 6974 656d   extensions.item
+00024210: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00024220: 2020 2020 2073 656c 662e 6578 7465 6e73       self.extens
+00024230: 696f 6e73 5b6e 616d 655d 2e68 6561 7274  ions[name].heart
+00024240: 6265 6174 2877 732c 2064 6174 6129 0a0a  beat(ws, data)..
+00024250: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00024260: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00024270: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
+00024280: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
+00024290: 206c 6f63 616c 5f6e 6f77 2c0a 2020 2020   local_now,.    
+000242a0: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
+000242b0: 6174 2d69 6e74 6572 7661 6c22 3a20 6865  at-interval": he
+000242c0: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+000242d0: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
+000242e0: 7329 292c 0a20 2020 2020 2020 207d 0a0a  s)),.        }..
+000242f0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00024300: 2020 2020 6173 796e 6320 6465 6620 6164      async def ad
+00024310: 645f 776f 726b 6572 280a 2020 2020 2020  d_worker(.      
+00024320: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00024330: 636f 6d6d 3a20 436f 6d6d 2c0a 2020 2020  comm: Comm,.    
+00024340: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
+00024350: 6464 7265 7373 3a20 7374 722c 0a20 2020  ddress: str,.   
+00024360: 2020 2020 2073 7461 7475 733a 2073 7472       status: str
+00024370: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
+00024380: 5f69 643a 2073 7472 2c0a 2020 2020 2020  _id: str,.      
+00024390: 2020 6e74 6872 6561 6473 3a20 696e 742c    nthreads: int,
+000243a0: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
+000243b0: 7472 2c0a 2020 2020 2020 2020 7265 736f  tr,.        reso
+000243c0: 6c76 655f 6164 6472 6573 733a 2062 6f6f  lve_address: boo
+000243d0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+000243e0: 2020 6e6f 773a 2066 6c6f 6174 2c0a 2020    now: float,.  
+000243f0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
+00024400: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
+00024410: 5d2c 0a20 2020 2020 2020 2023 2046 4958  ],.        # FIX
+00024420: 4d45 3a20 5468 6973 2069 7320 6e65 7665  ME: This is neve
+00024430: 7220 7375 626d 6974 7465 6420 6279 2074  r submitted by t
+00024440: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
+00024450: 2020 686f 7374 5f69 6e66 6f3a 204e 6f6e    host_info: Non
+00024460: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00024470: 2020 6d65 6d6f 7279 5f6c 696d 6974 3a20    memory_limit: 
+00024480: 696e 7420 7c20 4e6f 6e65 2c0a 2020 2020  int | None,.    
+00024490: 2020 2020 6d65 7472 6963 733a 2064 6963      metrics: dic
+000244a0: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
+000244b0: 2020 2020 2070 6964 3a20 696e 7420 3d20       pid: int = 
+000244c0: 302c 0a20 2020 2020 2020 2073 6572 7669  0,.        servi
+000244d0: 6365 733a 2064 6963 745b 7374 722c 2069  ces: dict[str, i
+000244e0: 6e74 5d2c 0a20 2020 2020 2020 206c 6f63  nt],.        loc
+000244f0: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
+00024500: 722c 0a20 2020 2020 2020 2076 6572 7369  r,.        versi
+00024510: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
+00024520: 6e79 5d2c 0a20 2020 2020 2020 206e 616e  ny],.        nan
+00024530: 6e79 3a20 7374 722c 0a20 2020 2020 2020  ny: str,.       
+00024540: 2065 7874 7261 3a20 6469 6374 2c0a 2020   extra: dict,.  
+00024550: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00024560: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
+00024570: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00024580: 2222 4164 6420 6120 6e65 7720 776f 726b  ""Add a new work
+00024590: 6572 2074 6f20 7468 6520 636c 7573 7465  er to the cluste
+000245a0: 7222 2222 0a20 2020 2020 2020 2061 6464  r""".        add
+000245b0: 7265 7373 203d 2073 656c 662e 636f 6572  ress = self.coer
+000245c0: 6365 5f61 6464 7265 7373 2861 6464 7265  ce_address(addre
+000245d0: 7373 2c20 7265 736f 6c76 655f 6164 6472  ss, resolve_addr
+000245e0: 6573 7329 0a20 2020 2020 2020 2061 6464  ess).        add
+000245f0: 7265 7373 203d 206e 6f72 6d61 6c69 7a65  ress = normalize
+00024600: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
+00024610: 290a 2020 2020 2020 2020 686f 7374 203d  ).        host =
+00024620: 2067 6574 5f61 6464 7265 7373 5f68 6f73   get_address_hos
+00024630: 7428 6164 6472 6573 7329 0a0a 2020 2020  t(address)..    
+00024640: 2020 2020 6966 2061 6464 7265 7373 2069      if address i
+00024650: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a0a  n self.workers:.
+00024660: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00024670: 6520 5661 6c75 6545 7272 6f72 2822 576f  e ValueError("Wo
+00024680: 726b 6572 2061 6c72 6561 6479 2065 7869  rker already exi
+00024690: 7374 7320 2573 2220 2520 6164 6472 6573  sts %s" % addres
+000246a0: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
+000246b0: 616d 6520 696e 2073 656c 662e 616c 6961  ame in self.alia
+000246c0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+000246d0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+000246e0: 2257 6f72 6b65 7220 7472 6965 6420 746f  "Worker tried to
+000246f0: 2063 6f6e 6e65 6374 2077 6974 6820 6120   connect with a 
+00024700: 6475 706c 6963 6174 6520 6e61 6d65 3a20  duplicate name: 
+00024710: 2573 222c 206e 616d 6529 0a20 2020 2020  %s", name).     
+00024720: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
+00024730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00024740: 7374 6174 7573 223a 2022 6572 726f 7222  status": "error"
+00024750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024760: 2020 226d 6573 7361 6765 223a 2022 6e61    "message": "na
+00024770: 6d65 2074 616b 656e 2c20 2573 2220 2520  me taken, %s" % 
+00024780: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00024790: 2020 2020 2020 2274 696d 6522 3a20 7469        "time": ti
+000247a0: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
+000247b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000247c0: 6177 6169 7420 636f 6d6d 2e77 7269 7465  await comm.write
+000247d0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
+000247e0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+000247f0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00024800: 2861 6464 7265 7373 2c20 7b22 6163 7469  (address, {"acti
+00024810: 6f6e 223a 2022 6164 642d 776f 726b 6572  on": "add-worker
+00024820: 227d 290a 2020 2020 2020 2020 7365 6c66  "}).        self
+00024830: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
+00024840: 2c20 7b22 6163 7469 6f6e 223a 2022 6164  , {"action": "ad
+00024850: 642d 776f 726b 6572 222c 2022 776f 726b  d-worker", "work
+00024860: 6572 223a 2061 6464 7265 7373 7d29 0a0a  er": address})..
+00024870: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00024880: 6b65 7273 5b61 6464 7265 7373 5d20 3d20  kers[address] = 
+00024890: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
+000248a0: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
+000248b0: 6472 6573 733d 6164 6472 6573 732c 0a20  dress=address,. 
+000248c0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+000248d0: 733d 5374 6174 7573 2e6c 6f6f 6b75 705b  s=Status.lookup[
+000248e0: 7374 6174 7573 5d2c 2020 2320 7479 7065  status],  # type
+000248f0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00024900: 2020 2020 2070 6964 3d70 6964 2c0a 2020       pid=pid,.  
+00024910: 2020 2020 2020 2020 2020 6e74 6872 6561            nthrea
+00024920: 6473 3d6e 7468 7265 6164 732c 0a20 2020  ds=nthreads,.   
+00024930: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+00024940: 6c69 6d69 743d 6d65 6d6f 7279 5f6c 696d  limit=memory_lim
+00024950: 6974 206f 7220 302c 0a20 2020 2020 2020  it or 0,.       
+00024960: 2020 2020 206e 616d 653d 6e61 6d65 2c0a       name=name,.
+00024970: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+00024980: 6c5f 6469 7265 6374 6f72 793d 6c6f 6361  l_directory=loca
+00024990: 6c5f 6469 7265 6374 6f72 792c 0a20 2020  l_directory,.   
+000249a0: 2020 2020 2020 2020 2073 6572 7669 6365           service
+000249b0: 733d 7365 7276 6963 6573 2c0a 2020 2020  s=services,.    
+000249c0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000249d0: 3d76 6572 7369 6f6e 732c 0a20 2020 2020  =versions,.     
+000249e0: 2020 2020 2020 206e 616e 6e79 3d6e 616e         nanny=nan
+000249f0: 6e79 2c0a 2020 2020 2020 2020 2020 2020  ny,.            
+00024a00: 6578 7472 613d 6578 7472 612c 0a20 2020  extra=extra,.   
+00024a10: 2020 2020 2020 2020 2073 6572 7665 725f           server_
+00024a20: 6964 3d73 6572 7665 725f 6964 2c0a 2020  id=server_id,.  
+00024a30: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+00024a40: 6c65 723d 7365 6c66 2c0a 2020 2020 2020  ler=self,.      
+00024a50: 2020 290a 2020 2020 2020 2020 6966 2077    ).        if w
+00024a60: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+00024a70: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+00024a80: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+00024a90: 6e69 6e67 2e61 6464 2877 7329 0a0a 2020  ning.add(ws)..  
+00024aa0: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
+00024ab0: 686f 7374 5f69 6e66 6f2e 6765 7428 686f  host_info.get(ho
+00024ac0: 7374 290a 2020 2020 2020 2020 6966 2064  st).        if d
+00024ad0: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
+00024ae0: 2020 2020 2020 2073 656c 662e 686f 7374         self.host
+00024af0: 5f69 6e66 6f5b 686f 7374 5d20 3d20 6468  _info[host] = dh
+00024b00: 203d 207b 7d0a 0a20 2020 2020 2020 2064   = {}..        d
+00024b10: 685f 6164 6472 6573 7365 7320 3d20 6468  h_addresses = dh
+00024b20: 2e67 6574 2822 6164 6472 6573 7365 7322  .get("addresses"
+00024b30: 290a 2020 2020 2020 2020 6966 2064 685f  ).        if dh_
+00024b40: 6164 6472 6573 7365 7320 6973 204e 6f6e  addresses is Non
+00024b50: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00024b60: 685b 2261 6464 7265 7373 6573 225d 203d  h["addresses"] =
+00024b70: 2064 685f 6164 6472 6573 7365 7320 3d20   dh_addresses = 
+00024b80: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+00024b90: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
+00024ba0: 203d 2030 0a0a 2020 2020 2020 2020 6468   = 0..        dh
+00024bb0: 5f61 6464 7265 7373 6573 2e61 6464 2861  _addresses.add(a
+00024bc0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00024bd0: 6468 5b22 6e74 6872 6561 6473 225d 202b  dh["nthreads"] +
+00024be0: 3d20 6e74 6872 6561 6473 0a0a 2020 2020  = nthreads..    
+00024bf0: 2020 2020 7365 6c66 2e74 6f74 616c 5f6e      self.total_n
+00024c00: 7468 7265 6164 7320 2b3d 206e 7468 7265  threads += nthre
+00024c10: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
+00024c20: 2e61 6c69 6173 6573 5b6e 616d 655d 203d  .aliases[name] =
+00024c30: 2061 6464 7265 7373 0a0a 2020 2020 2020   address..      
+00024c40: 2020 7365 6c66 2e68 6561 7274 6265 6174    self.heartbeat
+00024c50: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+00024c60: 2020 2020 2061 6464 7265 7373 3d61 6464       address=add
+00024c70: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+00024c80: 2020 7265 736f 6c76 655f 6164 6472 6573    resolve_addres
+00024c90: 733d 7265 736f 6c76 655f 6164 6472 6573  s=resolve_addres
+00024ca0: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
+00024cb0: 6f77 3d6e 6f77 2c0a 2020 2020 2020 2020  ow=now,.        
+00024cc0: 2020 2020 7265 736f 7572 6365 733d 7265      resources=re
+00024cd0: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
+00024ce0: 2020 2020 2068 6f73 745f 696e 666f 3d68       host_info=h
+00024cf0: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
+00024d00: 2020 2020 2020 6d65 7472 6963 733d 6d65        metrics=me
+00024d10: 7472 6963 732c 0a20 2020 2020 2020 2029  trics,.        )
+00024d20: 0a0a 2020 2020 2020 2020 2320 446f 206e  ..        # Do n
+00024d30: 6f74 206e 6565 6420 746f 2061 646a 7573  ot need to adjus
+00024d40: 7420 7365 6c66 2e74 6f74 616c 5f6f 6363  t self.total_occ
+00024d50: 7570 616e 6379 2061 7320 7365 6c66 2e6f  upancy as self.o
+00024d60: 6363 7570 616e 6379 5b77 735d 2063 616e  ccupancy[ws] can
+00024d70: 6e6f 740a 2020 2020 2020 2020 2320 6578  not.        # ex
+00024d80: 6973 7420 6265 666f 7265 2074 6869 732e  ist before this.
+00024d90: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+00024da0: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
+00024db0: 6564 2877 7329 0a0a 2020 2020 2020 2020  ed(ws)..        
+00024dc0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+00024dd0: 735b 6164 6472 6573 735d 203d 2042 6174  s[address] = Bat
+00024de0: 6368 6564 5365 6e64 2869 6e74 6572 7661  chedSend(interva
+00024df0: 6c3d 2235 6d73 222c 206c 6f6f 703d 7365  l="5ms", loop=se
+00024e00: 6c66 2e6c 6f6f 7029 0a0a 2020 2020 2020  lf.loop)..      
+00024e10: 2020 6177 6169 7461 626c 6573 203d 205b    awaitables = [
+00024e20: 5d0a 2020 2020 2020 2020 666f 7220 706c  ].        for pl
+00024e30: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
+00024e40: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
+00024e50: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+00024e60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00024e70: 2020 2020 2020 7265 7375 6c74 203d 2070        result = p
+00024e80: 6c75 6769 6e2e 6164 645f 776f 726b 6572  lugin.add_worker
+00024e90: 2873 6368 6564 756c 6572 3d73 656c 662c  (scheduler=self,
+00024ea0: 2077 6f72 6b65 723d 6164 6472 6573 7329   worker=address)
+00024eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024ec0: 2069 6620 7265 7375 6c74 2069 7320 6e6f   if result is no
+00024ed0: 7420 4e6f 6e65 2061 6e64 2069 6e73 7065  t None and inspe
+00024ee0: 6374 2e69 7361 7761 6974 6162 6c65 2872  ct.isawaitable(r
+00024ef0: 6573 756c 7429 3a0a 2020 2020 2020 2020  esult):.        
+00024f00: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00024f10: 7461 626c 6573 2e61 7070 656e 6428 7265  tables.append(re
+00024f20: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00024f30: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00024f40: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00024f50: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00024f60: 6578 6365 7074 696f 6e28 6529 0a0a 2020  exception(e)..  
+00024f70: 2020 2020 2020 706c 7567 696e 5f6d 7367        plugin_msg
+00024f80: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00024f90: 6f2e 6761 7468 6572 282a 6177 6169 7461  o.gather(*awaita
+00024fa0: 626c 6573 2c20 7265 7475 726e 5f65 7863  bles, return_exc
+00024fb0: 6570 7469 6f6e 733d 5472 7565 290a 2020  eptions=True).  
+00024fc0: 2020 2020 2020 706c 7567 696e 735f 6578        plugins_ex
+00024fd0: 6365 7074 696f 6e73 203d 205b 6d73 6720  ceptions = [msg 
+00024fe0: 666f 7220 6d73 6720 696e 2070 6c75 6769  for msg in plugi
+00024ff0: 6e5f 6d73 6773 2069 6620 6973 696e 7374  n_msgs if isinst
+00025000: 616e 6365 286d 7367 2c20 4578 6365 7074  ance(msg, Except
+00025010: 696f 6e29 5d0a 2020 2020 2020 2020 666f  ion)].        fo
+00025020: 7220 6578 6320 696e 2070 6c75 6769 6e73  r exc in plugins
+00025030: 5f65 7863 6570 7469 6f6e 733a 0a20 2020  _exceptions:.   
+00025040: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00025050: 6578 6365 7074 696f 6e28 6578 632c 2065  exception(exc, e
+00025060: 7863 5f69 6e66 6f3d 6578 6329 0a0a 2020  xc_info=exc)..  
+00025070: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
+00025080: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+00025090: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+000250a0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+000250b0: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
+000250c0: 2020 2020 7365 6c66 2e62 756c 6b5f 7363      self.bulk_sc
+000250d0: 6865 6475 6c65 5f75 6e72 756e 6e61 626c  hedule_unrunnabl
+000250e0: 655f 6166 7465 725f 6164 6469 6e67 5f77  e_after_adding_w
+000250f0: 6f72 6b65 7228 7773 292c 2073 7469 6d75  orker(ws), stimu
+00025100: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
+00025110: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00025120: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
+00025130: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
+00025140: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
+00025150: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00025160: 0a0a 2020 2020 2020 2020 6c6f 6767 6572  ..        logger
+00025170: 2e69 6e66 6f28 2252 6567 6973 7465 7220  .info("Register 
+00025180: 776f 726b 6572 2025 7322 2c20 7773 290a  worker %s", ws).
+00025190: 0a20 2020 2020 2020 206d 7367 203d 207b  .        msg = {
+000251a0: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+000251b0: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
+000251c0: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
+000251d0: 2074 696d 6528 292c 0a20 2020 2020 2020   time(),.       
+000251e0: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
+000251f0: 696e 7465 7276 616c 223a 2068 6561 7274  interval": heart
+00025200: 6265 6174 5f69 6e74 6572 7661 6c28 6c65  beat_interval(le
+00025210: 6e28 7365 6c66 2e77 6f72 6b65 7273 2929  n(self.workers))
+00025220: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+00025230: 6f72 6b65 722d 706c 7567 696e 7322 3a20  orker-plugins": 
+00025240: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
+00025250: 696e 732c 0a20 2020 2020 2020 207d 0a0a  ins,.        }..
+00025260: 2020 2020 2020 2020 7665 7273 696f 6e5f          version_
+00025270: 7761 726e 696e 6720 3d20 7665 7273 696f  warning = versio
+00025280: 6e5f 6d6f 6475 6c65 2e65 7272 6f72 5f6d  n_module.error_m
+00025290: 6573 7361 6765 280a 2020 2020 2020 2020  essage(.        
+000252a0: 2020 2020 7665 7273 696f 6e5f 6d6f 6475      version_modu
+000252b0: 6c65 2e67 6574 5f76 6572 7369 6f6e 7328  le.get_versions(
+000252c0: 292c 0a20 2020 2020 2020 2020 2020 207b  ),.            {
+000252d0: 773a 2077 732e 7665 7273 696f 6e73 2066  w: ws.versions f
+000252e0: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
+000252f0: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
+00025300: 7d2c 0a20 2020 2020 2020 2020 2020 2076  },.            v
+00025310: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
+00025320: 2020 2020 2073 6f75 7263 655f 6e61 6d65       source_name
+00025330: 3d73 7472 2877 732e 7365 7276 6572 5f69  =str(ws.server_i
+00025340: 6429 2c0a 2020 2020 2020 2020 290a 2020  d),.        ).  
+00025350: 2020 2020 2020 6d73 672e 7570 6461 7465        msg.update
+00025360: 2876 6572 7369 6f6e 5f77 6172 6e69 6e67  (version_warning
+00025370: 290a 0a20 2020 2020 2020 2061 7761 6974  )..        await
+00025380: 2063 6f6d 6d2e 7772 6974 6528 6d73 6729   comm.write(msg)
+00025390: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+000253a0: 7769 6c6c 206b 6565 7020 7275 6e6e 696e  will keep runnin
+000253b0: 6720 756e 7469 6c20 7468 6520 776f 726b  g until the work
+000253c0: 6572 2069 7320 7265 6d6f 7665 640a 2020  er is removed.  
+000253d0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+000253e0: 2e68 616e 646c 655f 776f 726b 6572 2863  .handle_worker(c
+000253f0: 6f6d 6d2c 2061 6464 7265 7373 290a 0a20  omm, address).. 
+00025400: 2020 2061 7379 6e63 2064 6566 2061 6464     async def add
+00025410: 5f6e 616e 6e79 2873 656c 6629 202d 3e20  _nanny(self) -> 
+00025420: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00025430: 2020 2020 2020 2020 6d73 6720 3d20 7b0a          msg = {.
+00025440: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00025450: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
+00025460: 2020 2020 2020 2020 226e 616e 6e79 2d70          "nanny-p
+00025470: 6c75 6769 6e73 223a 2073 656c 662e 6e61  lugins": self.na
+00025480: 6e6e 795f 706c 7567 696e 732c 0a20 2020  nny_plugins,.   
+00025490: 2020 2020 207d 0a20 2020 2020 2020 2072       }.        r
+000254a0: 6574 7572 6e20 6d73 670a 0a20 2020 2064  eturn msg..    d
+000254b0: 6566 2075 7064 6174 655f 6772 6170 6828  ef update_graph(
+000254c0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000254d0: 2020 2020 2020 2063 6c69 656e 743a 2073         client: s
+000254e0: 7472 2c0a 2020 2020 2020 2020 6772 6170  tr,.        grap
+000254f0: 685f 6865 6164 6572 3a20 6469 6374 2c0a  h_header: dict,.
+00025500: 2020 2020 2020 2020 6772 6170 685f 6672          graph_fr
+00025510: 616d 6573 3a20 6c69 7374 5b62 7974 6573  ames: list[bytes
+00025520: 5d2c 0a20 2020 2020 2020 206b 6579 733a  ],.        keys:
+00025530: 206c 6973 745b 7374 725d 2c0a 2020 2020   list[str],.    
+00025540: 2020 2020 696e 7465 726e 616c 5f70 7269      internal_pri
+00025550: 6f72 6974 793a 2064 6963 745b 7374 722c  ority: dict[str,
+00025560: 2069 6e74 5d20 7c20 4e6f 6e65 2c0a 2020   int] | None,.  
+00025570: 2020 2020 2020 7375 626d 6974 7469 6e67        submitting
+00025580: 5f74 6173 6b3a 2073 7472 207c 204e 6f6e  _task: str | Non
+00025590: 652c 0a20 2020 2020 2020 2075 7365 725f  e,.        user_
+000255a0: 7072 696f 7269 7479 3a20 696e 7420 7c20  priority: int | 
+000255b0: 6469 6374 5b73 7472 2c20 696e 745d 203d  dict[str, int] =
+000255c0: 2030 2c0a 2020 2020 2020 2020 6163 746f   0,.        acto
+000255d0: 7273 3a20 626f 6f6c 207c 206c 6973 745b  rs: bool | list[
+000255e0: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+000255f0: 6e65 2c0a 2020 2020 2020 2020 6669 666f  ne,.        fifo
+00025600: 5f74 696d 656f 7574 3a20 666c 6f61 7420  _timeout: float 
+00025610: 3d20 302e 302c 0a20 2020 2020 2020 2063  = 0.0,.        c
+00025620: 6f64 653a 2074 7570 6c65 5b73 7472 5d20  ode: tuple[str] 
+00025630: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00025640: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
+00025650: 6e73 3a20 6469 6374 207c 204e 6f6e 6520  ns: dict | None 
+00025660: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00025670: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00025680: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00025690: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+000256a0: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+000256b0: 696d 6528 290a 2020 2020 2020 2020 7472  ime().        tr
+000256c0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+000256d0: 2054 4f44 4f3a 2064 6573 6572 6961 6c69   TODO: deseriali
+000256e0: 7a61 7469 6f6e 202b 206d 6174 6572 6961  zation + materia
+000256f0: 6c69 7a61 7469 6f6e 2073 686f 756c 6420  lization should 
+00025700: 6265 206f 6666 6c6f 6164 6564 2074 6f20  be offloaded to 
+00025710: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
+00025720: 7468 7265 6164 2073 696e 6365 2074 6869  thread since thi
+00025730: 7320 6973 206e 6f6e 2d74 7269 7669 616c  s is non-trivial
+00025740: 2063 6f6d 7075 7465 2074 696d 6520 7468   compute time th
+00025750: 6174 2062 6c6f 636b 7320 7468 650a 2020  at blocks the.  
+00025760: 2020 2020 2020 2020 2020 2320 6576 656e            # even
+00025770: 7420 6c6f 6f70 2e20 5468 6973 206c 696b  t loop. This lik
+00025780: 656c 7920 7265 7175 6972 6573 2075 7320  ely requires us 
+00025790: 746f 2075 7365 2061 206c 6f63 6b20 7369  to use a lock si
+000257a0: 6e63 6520 7765 206e 6565 6420 746f 0a20  nce we need to. 
+000257b0: 2020 2020 2020 2020 2020 2023 2067 7561             # gua
+000257c0: 7261 6e74 6565 206f 7264 6572 696e 6720  rantee ordering 
+000257d0: 6f66 2075 7064 6174 655f 6772 6170 6820  of update_graph 
+000257e0: 6361 6c6c 7320 2861 7320 6c6f 6e67 2061  calls (as long a
+000257f0: 7320 7468 6572 6520 6973 206a 7573 740a  s there is just.
+00025800: 2020 2020 2020 2020 2020 2020 2320 6120              # a 
+00025810: 7369 6e67 6c65 206f 6666 6c6f 6164 2074  single offload t
+00025820: 6872 6561 642c 2074 6869 7320 6973 206e  hread, this is n
+00025830: 6f74 2061 2070 726f 626c 656d 290a 2020  ot a problem).  
+00025840: 2020 2020 2020 2020 2020 6672 6f6d 2064            from d
+00025850: 6973 7472 6962 7574 6564 2e70 726f 746f  istributed.proto
+00025860: 636f 6c20 696d 706f 7274 2064 6573 6572  col import deser
+00025870: 6961 6c69 7a65 0a0a 2020 2020 2020 2020  ialize..        
+00025880: 2020 2020 6772 6170 6820 3d20 6465 7365      graph = dese
+00025890: 7269 616c 697a 6528 6772 6170 685f 6865  rialize(graph_he
+000258a0: 6164 6572 2c20 6772 6170 685f 6672 616d  ader, graph_fram
+000258b0: 6573 292e 6461 7461 0a20 2020 2020 2020  es).data.       
+000258c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000258d0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+000258e0: 2020 2020 6d73 6720 3d20 2222 225c 0a20      msg = """\. 
+000258f0: 2020 2020 2020 2020 2020 2020 2020 2045                 E
+00025900: 7272 6f72 2064 7572 696e 6720 6465 7365  rror during dese
+00025910: 7269 616c 697a 6174 696f 6e20 6f66 2074  rialization of t
+00025920: 6865 2074 6173 6b20 6772 6170 682e 2054  he task graph. T
+00025930: 6869 7320 6672 6571 7565 6e74 6c79 206f  his frequently o
+00025940: 6363 7572 7320 6966 2074 6865 2053 6368  ccurs if the Sch
+00025950: 6564 756c 6572 2061 6e64 2043 6c69 656e  eduler and Clien
+00025960: 7420 6861 7665 2064 6966 6665 7265 6e74  t have different
+00025970: 2065 6e76 6972 6f6e 6d65 6e74 732e 2046   environments. F
+00025980: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
+00025990: 696f 6e2c 2073 6565 2068 7474 7073 3a2f  ion, see https:/
+000259a0: 2f64 6f63 732e 6461 736b 2e6f 7267 2f65  /docs.dask.org/e
+000259b0: 6e2f 7374 6162 6c65 2f64 6570 6c6f 796d  n/stable/deploym
+000259c0: 656e 742d 636f 6e73 6964 6572 6174 696f  ent-consideratio
+000259d0: 6e73 2e68 746d 6c23 636f 6e73 6973 7465  ns.html#consiste
+000259e0: 6e74 2d73 6f66 7477 6172 652d 656e 7669  nt-software-envi
+000259f0: 726f 6e6d 656e 7473 0a20 2020 2020 2020  ronments.       
+00025a00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00025a10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00025a20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00025a30: 5275 6e74 696d 6545 7272 6f72 2874 6578  RuntimeError(tex
+00025a40: 7477 7261 702e 6465 6465 6e74 286d 7367  twrap.dedent(msg
+00025a50: 2929 2066 726f 6d20 650a 2020 2020 2020  )) from e.      
+00025a60: 2020 2020 2020 6578 6365 7074 2052 756e        except Run
+00025a70: 7469 6d65 4572 726f 7220 6173 2065 3a0a  timeError as e:.
+00025a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a90: 6572 7220 3d20 6572 726f 725f 6d65 7373  err = error_mess
+00025aa0: 6167 6528 6529 0a20 2020 2020 2020 2020  age(e).         
+00025ab0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00025ac0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00025ad0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00025ae0: 2e72 6570 6f72 7428 0a20 2020 2020 2020  .report(.       
+00025af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00025b10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00025b20: 6f70 223a 2022 7461 736b 2d65 7272 6564  op": "task-erred
+00025b30: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00025b40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00025b50: 6b65 7922 3a20 6b65 792c 0a20 2020 2020  key": key,.     
+00025b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b70: 2020 2020 2020 2022 6578 6365 7074 696f         "exceptio
+00025b80: 6e22 3a20 6572 725b 2265 7863 6570 7469  n": err["excepti
+00025b90: 6f6e 225d 2c0a 2020 2020 2020 2020 2020  on"],.          
+00025ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025bb0: 2020 2274 7261 6365 6261 636b 223a 2065    "traceback": e
+00025bc0: 7272 5b22 7472 6163 6562 6163 6b22 5d2c  rr["traceback"],
+00025bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025be0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00025bf0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00025c00: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00025c10: 7475 726e 0a20 2020 2020 2020 2061 6e6e  turn.        ann
+00025c20: 6f74 6174 696f 6e73 203d 2061 6e6e 6f74  otations = annot
+00025c30: 6174 696f 6e73 206f 7220 7b7d 0a20 2020  ations or {}.   
+00025c40: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00025c50: 6365 2861 6e6e 6f74 6174 696f 6e73 2c20  ce(annotations, 
+00025c60: 546f 5069 636b 6c65 293a 2020 2320 7479  ToPickle):  # ty
+00025c70: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00025c80: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
+00025c90: 7768 6174 2074 6865 2068 6563 6b3f 0a20  what the heck?. 
+00025ca0: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
+00025cb0: 6174 696f 6e73 203d 2061 6e6e 6f74 6174  ations = annotat
+00025cc0: 696f 6e73 2e64 6174 6120 2023 2074 7970  ions.data  # typ
+00025cd0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+00025ce0: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
+00025cf0: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
+00025d00: 2275 7064 6174 652d 6772 6170 682d 7b74  "update-graph-{t
+00025d10: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
+00025d20: 280a 2020 2020 2020 2020 2020 2020 6473  (.            ds
+00025d30: 6b2c 0a20 2020 2020 2020 2020 2020 2064  k,.            d
+00025d40: 6570 656e 6465 6e63 6965 732c 0a20 2020  ependencies,.   
+00025d50: 2020 2020 2020 2020 206c 6179 6572 5f61           layer_a
+00025d60: 6e6e 6f74 6174 696f 6e73 2c0a 2020 2020  nnotations,.    
+00025d70: 2020 2020 2020 2020 7072 655f 7374 7269          pre_stri
+00025d80: 6e67 6966 6965 645f 6b65 7973 2c0a 2020  ngified_keys,.  
+00025d90: 2020 2020 2020 2920 3d20 7365 6c66 2e6d        ) = self.m
+00025da0: 6174 6572 6961 6c69 7a65 5f67 7261 7068  aterialize_graph
+00025db0: 2867 7261 7068 290a 0a20 2020 2020 2020  (graph)..       
+00025dc0: 2072 6571 7565 7374 6564 5f6b 6579 7320   requested_keys 
+00025dd0: 3d20 7365 7428 6b65 7973 290a 2020 2020  = set(keys).    
+00025de0: 2020 2020 6465 6c20 6b65 7973 0a20 2020      del keys.   
+00025df0: 2020 2020 2069 6620 6c65 6e28 6473 6b29       if len(dsk)
+00025e00: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00025e10: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00025e20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025e30: 2020 5b22 616c 6c22 2c20 636c 6965 6e74    ["all", client
+00025e40: 5d2c 207b 2261 6374 696f 6e22 3a20 2275  ], {"action": "u
+00025e50: 7064 6174 655f 6772 6170 6822 2c20 2263  pdate_graph", "c
+00025e60: 6f75 6e74 223a 206c 656e 2864 736b 297d  ount": len(dsk)}
+00025e70: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00025e80: 2020 2020 2020 2073 656c 662e 5f70 6f70         self._pop
+00025e90: 5f6b 6e6f 776e 5f74 6173 6b73 2864 736b  _known_tasks(dsk
+00025ea0: 2c20 6465 7065 6e64 656e 6369 6573 290a  , dependencies).
+00025eb0: 0a20 2020 2020 2020 2069 6620 6c6f 7374  .        if lost
+00025ec0: 5f6b 6579 7320 3a3d 2073 656c 662e 5f70  _keys := self._p
+00025ed0: 6f70 5f6c 6f73 745f 7461 736b 7328 6473  op_lost_tasks(ds
+00025ee0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
+00025ef0: 2072 6571 7565 7374 6564 5f6b 6579 7329   requested_keys)
+00025f00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00025f10: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
+00025f20: 2022 6361 6e63 656c 6c65 642d 6b65 7973   "cancelled-keys
+00025f30: 222c 2022 6b65 7973 223a 206c 6f73 745f  ", "keys": lost_
+00025f40: 6b65 7973 7d2c 2063 6c69 656e 743d 636c  keys}, client=cl
+00025f50: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
+00025f60: 2020 7365 6c66 2e63 6c69 656e 745f 7265    self.client_re
+00025f70: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
+00025f80: 2020 2020 2020 2020 2020 2020 206b 6579               key
+00025f90: 733d 6c6f 7374 5f6b 6579 732c 2063 6c69  s=lost_keys, cli
+00025fa0: 656e 743d 636c 6965 6e74 2c20 7374 696d  ent=client, stim
+00025fb0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00025fc0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00025fd0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00025fe0: 7420 7365 6c66 2e69 735f 6964 6c65 2061  t self.is_idle a
+00025ff0: 6e64 2073 656c 662e 636f 6d70 7574 6174  nd self.computat
+00026000: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00026010: 2020 2320 5374 696c 6c20 776f 726b 696e    # Still workin
+00026020: 6720 6f6e 2073 6f6d 6574 6869 6e67 2e20  g on something. 
+00026030: 4173 7369 676e 206e 6577 2074 6173 6b73  Assign new tasks
+00026040: 2074 6f20 7361 6d65 2063 6f6d 7075 7461   to same computa
+00026050: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00026060: 2063 6f6d 7075 7461 7469 6f6e 203d 2073   computation = s
+00026070: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
+00026080: 5b2d 315d 0a20 2020 2020 2020 2065 6c73  [-1].        els
+00026090: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+000260a0: 6f6d 7075 7461 7469 6f6e 203d 2043 6f6d  omputation = Com
+000260b0: 7075 7461 7469 6f6e 2829 0a20 2020 2020  putation().     
+000260c0: 2020 2020 2020 2073 656c 662e 636f 6d70         self.comp
+000260d0: 7574 6174 696f 6e73 2e61 7070 656e 6428  utations.append(
+000260e0: 636f 6d70 7574 6174 696f 6e29 0a0a 2020  computation)..  
+000260f0: 2020 2020 2020 6966 2063 6f64 653a 2020        if code:  
+00026100: 2320 6164 6420 6e65 7720 636f 6465 2062  # add new code b
+00026110: 6c6f 636b 730a 2020 2020 2020 2020 2020  locks.          
+00026120: 2020 636f 6d70 7574 6174 696f 6e2e 636f    computation.co
+00026130: 6465 2e61 6464 2863 6f64 6529 0a20 2020  de.add(code).   
+00026140: 2020 2020 2069 6620 616e 6e6f 7461 7469       if annotati
+00026150: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00026160: 2063 6f6d 7075 7461 7469 6f6e 2e61 6e6e   computation.ann
+00026170: 6f74 6174 696f 6e73 2e75 7064 6174 6528  otations.update(
+00026180: 616e 6e6f 7461 7469 6f6e 7329 0a0a 2020  annotations)..  
+00026190: 2020 2020 2020 7275 6e6e 6162 6c65 2c20        runnable, 
+000261a0: 746f 7563 6865 645f 7461 736b 732c 206e  touched_tasks, n
+000261b0: 6577 5f74 6173 6b73 203d 2073 656c 662e  ew_tasks = self.
+000261c0: 5f67 656e 6572 6174 655f 7461 736b 7374  _generate_taskst
+000261d0: 6174 6573 280a 2020 2020 2020 2020 2020  ates(.          
+000261e0: 2020 6b65 7973 3d72 6571 7565 7374 6564    keys=requested
+000261f0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+00026200: 2020 2064 736b 3d64 736b 2c0a 2020 2020     dsk=dsk,.    
+00026210: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+00026220: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
+00026230: 732c 0a20 2020 2020 2020 2020 2020 2063  s,.            c
+00026240: 6f6d 7075 7461 7469 6f6e 3d63 6f6d 7075  omputation=compu
+00026250: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
+00026260: 290a 2020 2020 2020 2020 2320 4649 584d  ).        # FIXM
+00026270: 453a 2054 6865 7365 2022 7265 736f 6c76  E: These "resolv
+00026280: 6564 5f61 6e6e 6f74 6174 696f 6e73 2220  ed_annotations" 
+00026290: 6172 6520 6120 6269 6720 6475 706c 6963  are a big duplic
+000262a0: 6174 696f 6e20 616e 6420 6172 6520 6f6e  ation and are on
+000262b0: 6c79 0a20 2020 2020 2020 2023 2072 6571  ly.        # req
+000262c0: 7569 7265 6420 746f 2073 6174 6973 6679  uired to satisfy
+000262d0: 2074 6865 2063 7572 7265 6e74 2070 6c75   the current plu
+000262e0: 6769 6e20 4150 492e 2054 6869 7320 7368  gin API. This sh
+000262f0: 6f75 6c64 2062 650a 2020 2020 2020 2020  ould be.        
+00026300: 2320 7265 636f 6e73 6964 6572 6564 2e0a  # reconsidered..
+00026310: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
+00026320: 5f61 6e6e 6f74 6174 696f 6e73 203d 2073  _annotations = s
+00026330: 656c 662e 5f70 6172 7365 5f61 6e64 5f61  elf._parse_and_a
+00026340: 7070 6c79 5f61 6e6e 6f74 6174 696f 6e73  pply_annotations
+00026350: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
+00026360: 736b 733d 6e65 775f 7461 736b 732c 0a20  sks=new_tasks,. 
+00026370: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
+00026380: 6174 696f 6e73 3d61 6e6e 6f74 6174 696f  ations=annotatio
+00026390: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+000263a0: 6c61 7965 725f 616e 6e6f 7461 7469 6f6e  layer_annotation
+000263b0: 733d 6c61 7965 725f 616e 6e6f 7461 7469  s=layer_annotati
+000263c0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+000263d0: 2070 7265 5f73 7472 696e 6769 6669 6564   pre_stringified
+000263e0: 5f6b 6579 733d 7072 655f 7374 7269 6e67  _keys=pre_string
+000263f0: 6966 6965 645f 6b65 7973 2c0a 2020 2020  ified_keys,.    
+00026400: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00026410: 656c 662e 5f73 6574 5f70 7269 6f72 6974  elf._set_priorit
+00026420: 6965 7328 0a20 2020 2020 2020 2020 2020  ies(.           
+00026430: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00026440: 7479 3d69 6e74 6572 6e61 6c5f 7072 696f  ty=internal_prio
+00026450: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
+00026460: 2020 7375 626d 6974 7469 6e67 5f74 6173    submitting_tas
+00026470: 6b3d 7375 626d 6974 7469 6e67 5f74 6173  k=submitting_tas
+00026480: 6b2c 0a20 2020 2020 2020 2020 2020 2075  k,.            u
+00026490: 7365 725f 7072 696f 7269 7479 3d75 7365  ser_priority=use
+000264a0: 725f 7072 696f 7269 7479 2c0a 2020 2020  r_priority,.    
+000264b0: 2020 2020 2020 2020 6669 666f 5f74 696d          fifo_tim
+000264c0: 656f 7574 3d66 6966 6f5f 7469 6d65 6f75  eout=fifo_timeou
+000264d0: 742c 0a20 2020 2020 2020 2020 2020 2073  t,.            s
+000264e0: 7461 7274 3d73 7461 7274 2c0a 2020 2020  tart=start,.    
+000264f0: 2020 2020 2020 2020 6473 6b3d 6473 6b2c          dsk=dsk,
+00026500: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+00026510: 6b73 3d72 756e 6e61 626c 652c 0a20 2020  ks=runnable,.   
+00026520: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00026530: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
+00026540: 6573 2c0a 2020 2020 2020 2020 290a 0a20  es,.        ).. 
+00026550: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00026560: 6e74 5f64 6573 6972 6573 5f6b 6579 7328  nt_desires_keys(
+00026570: 6b65 7973 3d72 6571 7565 7374 6564 5f6b  keys=requested_k
+00026580: 6579 732c 2063 6c69 656e 743d 636c 6965  eys, client=clie
+00026590: 6e74 290a 0a20 2020 2020 2020 2023 2041  nt)..        # A
+000265a0: 6464 2061 6374 6f72 730a 2020 2020 2020  dd actors.      
+000265b0: 2020 6966 2061 6374 6f72 7320 6973 2054    if actors is T
+000265c0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+000265d0: 2061 6374 6f72 7320 3d20 6c69 7374 2872   actors = list(r
+000265e0: 6571 7565 7374 6564 5f6b 6579 7329 0a20  equested_keys). 
+000265f0: 2020 2020 2020 2066 6f72 2061 6374 6f72         for actor
+00026600: 2069 6e20 6163 746f 7273 206f 7220 5b5d   in actors or []
+00026610: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+00026620: 203d 2073 656c 662e 7461 736b 735b 6163   = self.tasks[ac
+00026630: 746f 725d 0a20 2020 2020 2020 2020 2020  tor].           
+00026640: 2074 732e 6163 746f 7220 3d20 5472 7565   ts.actor = True
+00026650: 0a0a 2020 2020 2020 2020 2320 436f 6d70  ..        # Comp
+00026660: 7574 6520 7265 636f 6d6d 656e 6461 7469  ute recommendati
+00026670: 6f6e 730a 2020 2020 2020 2020 7265 636f  ons.        reco
+00026680: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00026690: 7320 3d20 7b7d 0a20 2020 2020 2020 2070  s = {}.        p
+000266a0: 7269 6f72 6974 7920 3d20 6469 6374 2829  riority = dict()
+000266b0: 0a20 2020 2020 2020 2066 6f72 2074 7320  .        for ts 
+000266c0: 696e 2073 6f72 7465 6428 0a20 2020 2020  in sorted(.     
+000266d0: 2020 2020 2020 2072 756e 6e61 626c 652c         runnable,
+000266e0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+000266f0: 3d6f 7065 7261 746f 722e 6174 7472 6765  =operator.attrge
+00026700: 7474 6572 2822 7072 696f 7269 7479 2229  tter("priority")
+00026710: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00026720: 7665 7273 653d 5472 7565 2c0a 2020 2020  verse=True,.    
+00026730: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00026740: 2020 2061 7373 6572 7420 7473 2e70 7269     assert ts.pri
+00026750: 6f72 6974 7920 2023 206d 7970 790a 2020  ority  # mypy.  
+00026760: 2020 2020 2020 2020 2020 7072 696f 7269            priori
+00026770: 7479 5b74 732e 6b65 795d 203d 2074 732e  ty[ts.key] = ts.
+00026780: 7072 696f 7269 7479 0a20 2020 2020 2020  priority.       
+00026790: 2020 2020 2061 7373 6572 7420 7473 2e72       assert ts.r
+000267a0: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
+000267b0: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
+000267c0: 3d3d 2022 7265 6c65 6173 6564 223a 0a20  == "released":. 
+000267d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000267e0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b74  ecommendations[t
+000267f0: 732e 6b65 795d 203d 2022 7761 6974 696e  s.key] = "waitin
+00026800: 6722 0a0a 2020 2020 2020 2020 666f 7220  g"..        for 
+00026810: 7473 2069 6e20 7275 6e6e 6162 6c65 3a0a  ts in runnable:.
+00026820: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00026830: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+00026840: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
+00026850: 2020 2020 2020 2020 6966 2064 7473 2e65          if dts.e
+00026860: 7863 6570 7469 6f6e 5f62 6c61 6d65 3a0a  xception_blame:.
+00026870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026880: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
+00026890: 5f62 6c61 6d65 203d 2064 7473 2e65 7863  _blame = dts.exc
+000268a0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+000268b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000268c0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000268d0: 5b74 732e 6b65 795d 203d 2022 6572 7265  [ts.key] = "erre
+000268e0: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+000268f0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00026900: 2020 2020 2020 7370 616e 735f 6578 743a        spans_ext:
+00026910: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
+00026920: 7874 656e 7369 6f6e 207c 204e 6f6e 6520  xtension | None 
+00026930: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
+00026940: 732e 6765 7428 2273 7061 6e73 2229 0a20  s.get("spans"). 
+00026950: 2020 2020 2020 2069 6620 7370 616e 735f         if spans_
+00026960: 6578 743a 0a20 2020 2020 2020 2020 2020  ext:.           
+00026970: 2023 206e 6577 5f74 6173 6b73 2064 6f65   # new_tasks doe
+00026980: 7320 6e6f 7420 6e65 6365 7373 6172 696c  s not necessaril
+00026990: 7920 636f 6e74 6169 6e20 616c 6c20 7275  y contain all ru
+000269a0: 6e6e 6162 6c65 2074 6173 6b73 3b0a 2020  nnable tasks;.  
+000269b0: 2020 2020 2020 2020 2020 2320 5f67 656e            # _gen
+000269c0: 6572 6174 655f 7461 736b 7374 6174 6573  erate_taskstates
+000269d0: 2069 7320 6e6f 7420 7468 6520 6f6e 6c79   is not the only
+000269e0: 2074 6869 6e67 2074 6861 7420 6361 6c6c   thing that call
+000269f0: 7320 6e65 775f 7461 736b 2829 2e20 410a  s new_task(). A.
+00026a00: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
+00026a10: 736b 5374 6174 6520 6d61 7920 6861 7665  skState may have
+00026a20: 2061 6c73 6f20 6265 656e 2063 7265 6174   also been creat
+00026a30: 6564 2062 7920 636c 6965 6e74 5f64 6573  ed by client_des
+00026a40: 6972 6573 5f6b 6579 7320 6f72 2073 6361  ires_keys or sca
+00026a50: 7474 6572 2c0a 2020 2020 2020 2020 2020  tter,.          
+00026a60: 2020 2320 616e 6420 6f6e 6c79 206c 6174    # and only lat
+00026a70: 6572 2067 6169 6e65 6420 6120 7275 6e5f  er gained a run_
+00026a80: 7370 6563 2e0a 2020 2020 2020 2020 2020  spec..          
+00026a90: 2020 7370 616e 735f 6578 742e 6f62 7365    spans_ext.obse
+00026aa0: 7276 655f 7461 736b 7328 7275 6e6e 6162  rve_tasks(runnab
+00026ab0: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+00026ac0: 2320 5461 736b 4772 6f75 702e 7370 616e  # TaskGroup.span
+00026ad0: 5f69 6420 636f 756c 6420 6265 2063 6f6d  _id could be com
+00026ae0: 706c 6574 656c 7920 6469 6666 6572 656e  pletely differen
+00026af0: 7420 6672 6f6d 2074 6865 206f 6e65 2069  t from the one i
+00026b00: 6e20 7468 650a 2020 2020 2020 2020 2020  n the.          
+00026b10: 2020 2320 6f72 6967 696e 616c 2061 6e6e    # original ann
+00026b20: 6f74 6174 696f 6e73 2c20 736f 2069 7420  otations, so it 
+00026b30: 6861 7320 6265 656e 2064 726f 7070 6564  has been dropped
+00026b40: 2e20 4472 6f70 2069 7420 6865 7265 2061  . Drop it here a
+00026b50: 7320 7765 6c6c 2069 6e0a 2020 2020 2020  s well in.      
+00026b60: 2020 2020 2020 2320 6f72 6465 7220 6e6f        # order no
+00026b70: 7420 746f 2063 6f6e 6675 7365 2053 6368  t to confuse Sch
+00026b80: 6564 756c 6572 506c 7567 696e 2061 7574  edulerPlugin aut
+00026b90: 686f 7273 2e0a 2020 2020 2020 2020 2020  hors..          
+00026ba0: 2020 7265 736f 6c76 6564 5f61 6e6e 6f74    resolved_annot
+00026bb0: 6174 696f 6e73 2e70 6f70 2822 7370 616e  ations.pop("span
+00026bc0: 222c 204e 6f6e 6529 0a0a 2020 2020 2020  ", None)..      
+00026bd0: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
+00026be0: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00026bf0: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+00026c00: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00026c10: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+00026c20: 7567 696e 2e75 7064 6174 655f 6772 6170  ugin.update_grap
+00026c30: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+00026c40: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00026c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c60: 2063 6c69 656e 743d 636c 6965 6e74 2c0a   client=client,.
+00026c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c80: 2020 2020 7461 736b 733d 5b74 732e 6b65      tasks=[ts.ke
+00026c90: 7920 666f 7220 7473 2069 6e20 746f 7563  y for ts in touc
+00026ca0: 6865 645f 7461 736b 735d 2c0a 2020 2020  hed_tasks],.    
+00026cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026cc0: 6b65 7973 3d72 6571 7565 7374 6564 5f6b  keys=requested_k
+00026cd0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+00026ce0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00026cf0: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
+00026d00: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00026d10: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+00026d20: 6f6e 733d 7265 736f 6c76 6564 5f61 6e6e  ons=resolved_ann
+00026d30: 6f74 6174 696f 6e73 2c0a 2020 2020 2020  otations,.      
+00026d40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00026d50: 696f 7269 7479 3d70 7269 6f72 6974 792c  iority=priority,
+00026d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026d70: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+00026d80: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00026d90: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00026da0: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+00026db0: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
+00026dc0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+00026dd0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+00026de0: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
+00026df0: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
+00026e00: 7320 696e 2074 6f75 6368 6564 5f74 6173  s in touched_tas
+00026e10: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+00026e20: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+00026e30: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
+00026e40: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00026e50: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
+00026e60: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
+00026e70: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+00026e80: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
+00026e90: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00026ea0: 6469 6765 7374 5f6d 6574 7269 6328 2275  digest_metric("u
+00026eb0: 7064 6174 652d 6772 6170 682d 6475 7261  pdate-graph-dura
+00026ec0: 7469 6f6e 222c 2065 6e64 202d 2073 7461  tion", end - sta
+00026ed0: 7274 290a 0a20 2020 2064 6566 205f 6765  rt)..    def _ge
+00026ee0: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
+00026ef0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00026f00: 206b 6579 733a 2073 6574 5b73 7472 5d2c   keys: set[str],
+00026f10: 2064 736b 3a20 6469 6374 2c20 6465 7065   dsk: dict, depe
+00026f20: 6e64 656e 6369 6573 3a20 6469 6374 2c20  ndencies: dict, 
+00026f30: 636f 6d70 7574 6174 696f 6e3a 2043 6f6d  computation: Com
+00026f40: 7075 7461 7469 6f6e 0a20 2020 2029 202d  putation.    ) -
+00026f50: 3e20 7475 706c 653a 0a20 2020 2020 2020  > tuple:.       
+00026f60: 2023 2047 6574 206f 7220 6372 6561 7465   # Get or create
+00026f70: 2074 6173 6b20 7374 6174 6573 0a20 2020   task states.   
+00026f80: 2020 2020 2072 756e 6e61 626c 6520 3d20       runnable = 
+00026f90: 5b5d 0a20 2020 2020 2020 206e 6577 5f74  [].        new_t
+00026fa0: 6173 6b73 203d 205b 5d0a 2020 2020 2020  asks = [].      
+00026fb0: 2020 7374 6163 6b20 3d20 6c69 7374 286b    stack = list(k
+00026fc0: 6579 7329 0a20 2020 2020 2020 2074 6f75  eys).        tou
+00026fd0: 6368 6564 5f6b 6579 7320 3d20 7365 7428  ched_keys = set(
+00026fe0: 290a 2020 2020 2020 2020 746f 7563 6865  ).        touche
+00026ff0: 645f 7461 736b 7320 3d20 5b5d 0a20 2020  d_tasks = [].   
+00027000: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
+00027010: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
+00027020: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
+00027030: 2020 2020 2020 2020 2020 6966 206b 2069            if k i
+00027040: 6e20 746f 7563 6865 645f 6b65 7973 3a0a  n touched_keys:.
+00027050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027060: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00027070: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00027080: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
+00027090: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+000270a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000270b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+000270c0: 2e6e 6577 5f74 6173 6b28 6b2c 2064 736b  .new_task(k, dsk
+000270d0: 2e67 6574 286b 292c 2022 7265 6c65 6173  .get(k), "releas
+000270e0: 6564 222c 2063 6f6d 7075 7461 7469 6f6e  ed", computation
+000270f0: 3d63 6f6d 7075 7461 7469 6f6e 290a 2020  =computation).  
+00027100: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00027110: 775f 7461 736b 732e 6170 7065 6e64 2874  w_tasks.append(t
+00027120: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
+00027130: 6c69 6620 6e6f 7420 7473 2e72 756e 5f73  lif not ts.run_s
+00027140: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
+00027150: 2020 2020 2074 732e 7275 6e5f 7370 6563       ts.run_spec
+00027160: 203d 2064 736b 2e67 6574 286b 290a 0a20   = dsk.get(k).. 
+00027170: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00027180: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
+00027190: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
+000271a0: 626c 652e 6170 7065 6e64 2874 7329 0a20  ble.append(ts). 
+000271b0: 2020 2020 2020 2020 2020 2074 6f75 6368             touch
+000271c0: 6564 5f6b 6579 732e 6164 6428 6b29 0a20  ed_keys.add(k). 
+000271d0: 2020 2020 2020 2020 2020 2074 6f75 6368             touch
+000271e0: 6564 5f74 6173 6b73 2e61 7070 656e 6428  ed_tasks.append(
+000271f0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+00027200: 7374 6163 6b2e 6578 7465 6e64 2864 6570  stack.extend(dep
+00027210: 656e 6465 6e63 6965 732e 6765 7428 6b2c  endencies.get(k,
+00027220: 2028 2929 290a 0a20 2020 2020 2020 2023   ()))..        #
+00027230: 2041 6464 2064 6570 656e 6465 6e63 6965   Add dependencie
+00027240: 730a 2020 2020 2020 2020 666f 7220 6b65  s.        for ke
+00027250: 792c 2064 6570 7320 696e 2064 6570 656e  y, deps in depen
+00027260: 6465 6e63 6965 732e 6974 656d 7328 293a  dencies.items():
+00027270: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+00027280: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+00027290: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
+000272a0: 2020 6966 2074 7320 6973 204e 6f6e 6520    if ts is None 
+000272b0: 6f72 2074 732e 6465 7065 6e64 656e 6369  or ts.dependenci
+000272c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000272d0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+000272e0: 2020 2020 2020 2020 2066 6f72 2064 6570           for dep
+000272f0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
+00027300: 2020 2020 2020 2020 2020 6474 7320 3d20            dts = 
+00027310: 7365 6c66 2e74 6173 6b73 5b64 6570 5d0a  self.tasks[dep].
+00027320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027330: 7473 2e61 6464 5f64 6570 656e 6465 6e63  ts.add_dependenc
+00027340: 7928 6474 7329 0a0a 2020 2020 2020 2020  y(dts)..        
+00027350: 6966 206c 656e 2874 6f75 6368 6564 5f74  if len(touched_t
+00027360: 6173 6b73 2920 3c20 6c65 6e28 6b65 7973  asks) < len(keys
+00027370: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+00027380: 6f67 6765 722e 696e 666f 280a 2020 2020  ogger.info(.    
+00027390: 2020 2020 2020 2020 2020 2020 2253 7562              "Sub
+000273a0: 6d69 7474 6564 2067 7261 7068 2077 6974  mitted graph wit
+000273b0: 6820 6c65 6e67 7468 2025 7320 6275 7420  h length %s but 
+000273c0: 7265 7175 6573 7465 6420 6772 6170 6820  requested graph 
+000273d0: 6f6e 6c79 2069 6e63 6c75 6465 7320 2573  only includes %s
+000273e0: 206b 6579 7322 2c0a 2020 2020 2020 2020   keys",.        
+000273f0: 2020 2020 2020 2020 6c65 6e28 746f 7563          len(touc
+00027400: 6865 645f 7461 736b 7329 2c0a 2020 2020  hed_tasks),.    
+00027410: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+00027420: 6b65 7973 292c 0a20 2020 2020 2020 2020  keys),.         
+00027430: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+00027440: 7572 6e20 7275 6e6e 6162 6c65 2c20 746f  urn runnable, to
+00027450: 7563 6865 645f 7461 736b 732c 206e 6577  uched_tasks, new
+00027460: 5f74 6173 6b73 0a0a 2020 2020 6465 6620  _tasks..    def 
+00027470: 5f70 6172 7365 5f61 6e64 5f61 7070 6c79  _parse_and_apply
+00027480: 5f61 6e6e 6f74 6174 696f 6e73 280a 2020  _annotations(.  
+00027490: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000274a0: 2020 2020 7461 736b 733a 2049 7465 7261      tasks: Itera
+000274b0: 626c 655b 5461 736b 5374 6174 655d 2c0a  ble[TaskState],.
+000274c0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+000274d0: 6f6e 733a 2064 6963 742c 0a20 2020 2020  ons: dict,.     
+000274e0: 2020 206c 6179 6572 5f61 6e6e 6f74 6174     layer_annotat
+000274f0: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
+00027500: 6469 6374 5d2c 0a20 2020 2020 2020 2070  dict],.        p
+00027510: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
+00027520: 6579 733a 2064 6963 745b 4861 7368 6162  eys: dict[Hashab
+00027530: 6c65 2c20 7374 725d 2c0a 2020 2020 2920  le, str],.    ) 
+00027540: 2d3e 2064 6963 745b 7374 722c 2064 6963  -> dict[str, dic
+00027550: 745b 7374 722c 2041 6e79 5d5d 3a0a 2020  t[str, Any]]:.  
+00027560: 2020 2020 2020 2222 2241 7070 6c79 2074        """Apply t
+00027570: 6865 2070 726f 7669 6465 6420 616e 6e6f  he provided anno
+00027580: 7461 7469 6f6e 7320 746f 2074 6865 2070  tations to the p
+00027590: 726f 7669 6465 6420 6054 6173 6b53 7461  rovided `TaskSta
+000275a0: 7465 6020 6f62 6a65 6374 732e 0a0a 2020  te` objects...  
+000275b0: 2020 2020 2020 5468 6520 7261 7720 616e        The raw an
+000275c0: 6e6f 7461 7469 6f6e 7320 7769 6c6c 2062  notations will b
+000275d0: 6520 7374 6f72 6564 2069 6e20 7468 6520  e stored in the 
+000275e0: 6061 6e6e 6f74 6174 696f 6e73 6020 6174  `annotations` at
+000275f0: 7472 6962 7574 652e 0a0a 2020 2020 2020  tribute...      
+00027600: 2020 4c61 7965 7220 2f20 6b65 7920 7370    Layer / key sp
+00027610: 6563 6966 6963 2061 6e6e 6f74 6174 696f  ecific annotatio
+00027620: 6e73 2077 696c 6c20 7461 6b65 2070 7265  ns will take pre
+00027630: 6365 6465 6e63 6520 6f76 6572 2067 6c6f  cedence over glo
+00027640: 6261 6c20 2f20 6765 6e65 7269 6320 616e  bal / generic an
+00027650: 6e6f 7461 7469 6f6e 732e 0a0a 2020 2020  notations...    
+00027660: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00027670: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00027680: 2d0a 2020 2020 2020 2020 7461 736b 7320  -.        tasks 
+00027690: 3a20 4974 6572 6162 6c65 5b54 6173 6b53  : Iterable[TaskS
+000276a0: 7461 7465 5d0a 2020 2020 2020 2020 2020  tate].          
+000276b0: 2020 5f64 6573 6372 6970 7469 6f6e 5f0a    _description_.
+000276c0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+000276d0: 6f6e 7320 3a20 6469 6374 0a20 2020 2020  ons : dict.     
+000276e0: 2020 2020 2020 205f 6465 7363 7269 7074         _descript
+000276f0: 696f 6e5f 0a20 2020 2020 2020 206c 6179  ion_.        lay
+00027700: 6572 5f61 6e6e 6f74 6174 696f 6e73 203a  er_annotations :
+00027710: 2064 6963 745b 7374 722c 2064 6963 745d   dict[str, dict]
+00027720: 0a20 2020 2020 2020 2020 2020 205f 6465  .            _de
+00027730: 7363 7269 7074 696f 6e5f 0a0a 2020 2020  scription_..    
+00027740: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00027750: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00027760: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
+00027770: 6f74 6174 696f 6e73 3a20 6469 6374 0a20  otations: dict. 
+00027780: 2020 2020 2020 2020 2020 2041 206d 6170             A map
+00027790: 7069 6e67 206f 6620 616c 6c20 7265 736f  ping of all reso
+000277a0: 6c76 6564 2061 6e6e 6f74 6174 696f 6e73  lved annotations
+000277b0: 2069 6e20 7468 6520 666f 726d 6174 3a3a   in the format::
+000277c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000277d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000277e0: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
+000277f0: 696f 6e22 3a20 7b0a 2020 2020 2020 2020  ion": {.        
+00027800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027810: 226b 6579 223a 2076 616c 7565 2c0a 2020  "key": value,.  
+00027820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027830: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
+00027840: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+00027850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027860: 2020 2020 202e 2e2e 0a20 2020 2020 2020       ....       
+00027870: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00027880: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00027890: 6573 6f6c 7665 645f 616e 6e6f 7461 7469  esolved_annotati
+000278a0: 6f6e 733a 2064 6566 6175 6c74 6469 6374  ons: defaultdict
+000278b0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
+000278c0: 416e 795d 5d20 3d20 6465 6661 756c 7464  Any]] = defaultd
+000278d0: 6963 7428 6469 6374 290a 2020 2020 2020  ict(dict).      
+000278e0: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
+000278f0: 733a 0a20 2020 2020 2020 2020 2020 206b  s:.            k
+00027900: 6579 203d 2074 732e 6b65 790a 2020 2020  ey = ts.key.    
+00027910: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
+00027920: 6f75 6c64 2062 6520 6120 7479 7065 6420  ould be a typed 
+00027930: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
+00027940: 2069 6620 6e6f 7420 616e 6e6f 7461 7469   if not annotati
+00027950: 6f6e 7320 616e 6420 6b65 7920 6e6f 7420  ons and key not 
+00027960: 696e 206c 6179 6572 5f61 6e6e 6f74 6174  in layer_annotat
+00027970: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00027980: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00027990: 2020 2020 2020 2020 2020 206f 7574 203d             out =
+000279a0: 2061 6e6e 6f74 6174 696f 6e73 2e63 6f70   annotations.cop
+000279b0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+000279c0: 6f75 742e 7570 6461 7465 286c 6179 6572  out.update(layer
+000279d0: 5f61 6e6e 6f74 6174 696f 6e73 2e67 6574  _annotations.get
+000279e0: 286b 6579 2c20 7b7d 2929 0a20 2020 2020  (key, {})).     
+000279f0: 2020 2020 2020 2066 6f72 2061 6e6e 6f74         for annot
+00027a00: 2c20 7661 6c75 6520 696e 206f 7574 2e69  , value in out.i
+00027a10: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00027a20: 2020 2020 2020 2020 2320 506f 7020 7468          # Pop th
+00027a30: 6520 6b65 7920 7369 6e63 6520 6e61 6d65  e key since name
+00027a40: 7320 646f 6e27 7420 616c 7761 7973 206d  s don't always m
+00027a50: 6174 6368 2061 7474 7269 6275 7465 730a  atch attributes.
+00027a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a70: 6966 2063 616c 6c61 626c 6528 7661 6c75  if callable(valu
+00027a80: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00027a90: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+00027aa0: 7661 6c75 6528 7072 655f 7374 7269 6e67  value(pre_string
+00027ab0: 6966 6965 645f 6b65 7973 5b6b 6579 5d29  ified_keys[key])
+00027ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027ad0: 206f 7574 5b61 6e6e 6f74 5d20 3d20 7661   out[annot] = va
+00027ae0: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00027af0: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
+00027b00: 6f74 6174 696f 6e73 5b61 6e6e 6f74 5d5b  otations[annot][
+00027b10: 6b65 795d 203d 2076 616c 7565 0a0a 2020  key] = value..  
+00027b20: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00027b30: 2061 6e6e 6f74 2069 6e20 2822 7265 7374   annot in ("rest
+00027b40: 7269 6374 696f 6e73 222c 2022 776f 726b  rictions", "work
+00027b50: 6572 7322 293a 0a20 2020 2020 2020 2020  ers"):.         
+00027b60: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00027b70: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
+00027b80: 7565 2c20 286c 6973 742c 2074 7570 6c65  ue, (list, tuple
+00027b90: 2c20 7365 7429 293a 0a20 2020 2020 2020  , set)):.       
+00027ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027bb0: 2076 616c 7565 203d 205b 7661 6c75 655d   value = [value]
+00027bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027bd0: 2020 2020 2068 6f73 745f 7265 7374 7269       host_restri
+00027be0: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
+00027bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c00: 2020 2077 6f72 6b65 725f 7265 7374 7269     worker_restri
+00027c10: 6374 696f 6e73 203d 2073 6574 2829 0a20  ctions = set(). 
+00027c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c30: 2020 2066 6f72 2077 2069 6e20 7661 6c75     for w in valu
+00027c40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00027c50: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00027c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c70: 2020 2020 2020 2020 2020 2020 7720 3d20              w = 
+00027c80: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
+00027c90: 6573 7328 7729 0a20 2020 2020 2020 2020  ess(w).         
+00027ca0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00027cb0: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+00027cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027cd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00027ce0: 4e6f 7420 6120 7661 6c69 6420 6164 6472  Not a valid addr
+00027cf0: 6573 732c 2062 7574 2070 6572 6861 7073  ess, but perhaps
+00027d00: 2069 7427 7320 6120 686f 7374 6e61 6d65   it's a hostname
+00027d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027d20: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
+00027d30: 745f 7265 7374 7269 6374 696f 6e73 2e61  t_restrictions.a
+00027d40: 6464 2877 290a 2020 2020 2020 2020 2020  dd(w).          
+00027d50: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00027d60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00027d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d80: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+00027d90: 6f6e 732e 6164 6428 7729 0a20 2020 2020  ons.add(w).     
+00027da0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00027db0: 6620 686f 7374 5f72 6573 7472 6963 7469  f host_restricti
+00027dc0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00027dd0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+00027de0: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+00027df0: 7320 3d20 686f 7374 5f72 6573 7472 6963  s = host_restric
+00027e00: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+00027e10: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
+00027e20: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+00027e30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027e40: 2020 2020 2020 2020 2020 7473 2e77 6f72            ts.wor
+00027e50: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+00027e60: 203d 2077 6f72 6b65 725f 7265 7374 7269   = worker_restri
+00027e70: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
+00027e80: 2020 2020 2020 2065 6c69 6620 616e 6e6f         elif anno
+00027e90: 7420 696e 2028 226c 6f6f 7365 5f72 6573  t in ("loose_res
+00027ea0: 7472 6963 7469 6f6e 7322 2c20 2261 6c6c  trictions", "all
+00027eb0: 6f77 5f6f 7468 6572 5f77 6f72 6b65 7273  ow_other_workers
+00027ec0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00027ed0: 2020 2020 2020 2020 7473 2e6c 6f6f 7365          ts.loose
+00027ee0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+00027ef0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00027f00: 2020 2020 2020 656c 6966 2061 6e6e 6f74        elif annot
+00027f10: 203d 3d20 2272 6573 6f75 7263 6573 223a   == "resources":
+00027f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027f30: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00027f40: 7374 616e 6365 2876 616c 7565 2c20 6469  stance(value, di
+00027f50: 6374 290a 2020 2020 2020 2020 2020 2020  ct).            
+00027f60: 2020 2020 2020 2020 7473 2e72 6573 6f75          ts.resou
+00027f70: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+00027f80: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+00027f90: 2020 2020 2020 2020 2065 6c69 6620 616e           elif an
+00027fa0: 6e6f 7420 3d3d 2022 7072 696f 7269 7479  not == "priority
+00027fb0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00027fc0: 2020 2020 2020 2023 2053 6565 2053 6368         # See Sch
+00027fd0: 6564 756c 6572 2e5f 7365 745f 7072 696f  eduler._set_prio
+00027fe0: 7269 7469 6573 0a20 2020 2020 2020 2020  rities.         
+00027ff0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00028000: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+00028010: 2020 2020 656c 6966 2061 6e6e 6f74 203d      elif annot =
+00028020: 3d20 2272 6574 7269 6573 223a 0a20 2020  = "retries":.   
+00028030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028040: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00028050: 6365 2876 616c 7565 2c20 696e 7429 0a20  ce(value, int). 
 00028060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028070: 7473 2e70 7269 6f72 6974 7920 3d20 280a  ts.priority = (.
-00028080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028090: 2020 2020 2d61 6e6e 6f74 6174 6564 5f70      -annotated_p
-000280a0: 7269 6f2c 0a20 2020 2020 2020 2020 2020  rio,.           
-000280b0: 2020 2020 2020 2020 2067 656e 6572 6174           generat
-000280c0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-000280d0: 2020 2020 2020 2020 2069 6e74 6572 6e61           interna
-000280e0: 6c5f 7072 696f 7269 7479 5b74 732e 6b65  l_priority[ts.ke
-000280f0: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
-00028100: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00028110: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00028120: 6174 6520 616e 6420 7473 2e72 756e 5f73  ate and ts.run_s
-00028130: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
-00028140: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00028150: 7374 616e 6365 2874 732e 7072 696f 7269  stance(ts.priori
-00028160: 7479 2c20 7475 706c 6529 2061 6e64 2061  ty, tuple) and a
-00028170: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
-00028180: 2020 2020 2020 2020 6973 696e 7374 616e          isinstan
-00028190: 6365 2865 6c2c 2028 696e 742c 2066 6c6f  ce(el, (int, flo
-000281a0: 6174 2929 2066 6f72 2065 6c20 696e 2074  at)) for el in t
-000281b0: 732e 7072 696f 7269 7479 0a20 2020 2020  s.priority.     
-000281c0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000281d0: 2020 6465 6620 5f70 6f70 5f6c 6f73 745f    def _pop_lost_
-000281e0: 7461 736b 7328 0a20 2020 2020 2020 2073  tasks(.        s
-000281f0: 656c 662c 2064 736b 3a20 6469 6374 2c20  elf, dsk: dict, 
-00028200: 6465 7065 6e64 656e 6369 6573 3a20 6469  dependencies: di
-00028210: 6374 2c20 6b65 7973 3a20 7365 745b 7374  ct, keys: set[st
-00028220: 725d 0a20 2020 2029 202d 3e20 7365 745b  r].    ) -> set[
-00028230: 7374 725d 3a0a 2020 2020 2020 2020 6e20  str]:.        n 
-00028240: 3d20 300a 2020 2020 2020 2020 6f75 7420  = 0.        out 
-00028250: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00028260: 7768 696c 6520 6c65 6e28 6473 6b29 2021  while len(dsk) !
-00028270: 3d20 6e3a 2020 2320 7761 6c6b 2074 6872  = n:  # walk thr
-00028280: 6f75 6768 206e 6577 2074 6173 6b73 2c20  ough new tasks, 
-00028290: 6361 6e63 656c 2061 6e79 2062 6164 2064  cancel any bad d
-000282a0: 6570 730a 2020 2020 2020 2020 2020 2020  eps.            
-000282b0: 6e20 3d20 6c65 6e28 6473 6b29 0a20 2020  n = len(dsk).   
-000282c0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
-000282d0: 6465 7073 2069 6e20 6c69 7374 2864 6570  deps in list(dep
-000282e0: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
-000282f0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00028300: 2020 2020 6966 2061 6e79 280a 2020 2020      if any(.    
-00028310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028320: 6465 7020 6e6f 7420 696e 2073 656c 662e  dep not in self.
-00028330: 7461 736b 7320 616e 6420 6465 7020 6e6f  tasks and dep no
-00028340: 7420 696e 2064 736b 2066 6f72 2064 6570  t in dsk for dep
-00028350: 2069 6e20 6465 7073 0a20 2020 2020 2020   in deps.       
-00028360: 2020 2020 2020 2020 2029 3a20 2023 2062           ):  # b
-00028370: 6164 206b 6579 0a20 2020 2020 2020 2020  ad key.         
-00028380: 2020 2020 2020 2020 2020 206f 7574 2e61             out.a
-00028390: 6464 286b 290a 2020 2020 2020 2020 2020  dd(k).          
-000283a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000283b0: 2e69 6e66 6f28 2255 7365 7220 6173 6b65  .info("User aske
-000283c0: 6420 666f 7220 636f 6d70 7574 6174 696f  d for computatio
-000283d0: 6e20 6f6e 206c 6f73 7420 6461 7461 2c20  n on lost data, 
-000283e0: 2573 222c 206b 290a 2020 2020 2020 2020  %s", k).        
-000283f0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00028400: 6473 6b5b 6b5d 0a20 2020 2020 2020 2020  dsk[k].         
-00028410: 2020 2020 2020 2020 2020 2064 656c 2064             del d
-00028420: 6570 656e 6465 6e63 6965 735b 6b5d 0a20  ependencies[k]. 
-00028430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028440: 2020 2069 6620 6b20 696e 206b 6579 733a     if k in keys:
-00028450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028460: 2020 2020 2020 2020 206b 6579 732e 7265           keys.re
-00028470: 6d6f 7665 286b 290a 2020 2020 2020 2020  move(k).        
-00028480: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
-00028490: 6465 6620 5f70 6f70 5f6b 6e6f 776e 5f74  def _pop_known_t
-000284a0: 6173 6b73 2873 656c 662c 2064 736b 3a20  asks(self, dsk: 
-000284b0: 6469 6374 2c20 6465 7065 6e64 656e 6369  dict, dependenci
-000284c0: 6573 3a20 6469 6374 2920 2d3e 2073 6574  es: dict) -> set
-000284d0: 5b73 7472 5d3a 0a20 2020 2020 2020 2023  [str]:.        #
-000284e0: 2041 766f 6964 2063 6f6d 7075 7461 7469   Avoid computati
-000284f0: 6f6e 2074 6861 7420 6973 2061 6c72 6561  on that is alrea
-00028500: 6479 2066 696e 6973 6865 640a 2020 2020  dy finished.    
-00028510: 2020 2020 616c 7265 6164 795f 696e 5f6d      already_in_m
-00028520: 656d 6f72 7920 3d20 7365 7428 2920 2023  emory = set()  #
-00028530: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
-00028540: 616c 7265 6164 7920 646f 6e65 0a20 2020  already done.   
-00028550: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
-00028560: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
-00028570: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00028580: 2020 2069 6620 7620 616e 6420 6b20 696e     if v and k in
-00028590: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
-000285a0: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
-000285b0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 5d0a  = self.tasks[k].
-000285c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285d0: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
-000285e0: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
-000285f0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00028600: 2020 2020 2020 2020 616c 7265 6164 795f          already_
-00028610: 696e 5f6d 656d 6f72 792e 6164 6428 6b29  in_memory.add(k)
-00028620: 0a0a 2020 2020 2020 2020 646f 6e65 203d  ..        done =
-00028630: 2073 6574 2861 6c72 6561 6479 5f69 6e5f   set(already_in_
-00028640: 6d65 6d6f 7279 290a 2020 2020 2020 2020  memory).        
-00028650: 6966 2061 6c72 6561 6479 5f69 6e5f 6d65  if already_in_me
-00028660: 6d6f 7279 3a0a 2020 2020 2020 2020 2020  mory:.          
-00028670: 2020 6465 7065 6e64 656e 7473 203d 2064    dependents = d
-00028680: 6173 6b2e 636f 7265 2e72 6576 6572 7365  ask.core.reverse
-00028690: 5f64 6963 7428 6465 7065 6e64 656e 6369  _dict(dependenci
-000286a0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-000286b0: 7374 6163 6b20 3d20 6c69 7374 2861 6c72  stack = list(alr
-000286c0: 6561 6479 5f69 6e5f 6d65 6d6f 7279 290a  eady_in_memory).
-000286d0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-000286e0: 6520 7374 6163 6b3a 2020 2320 7265 6d6f  e stack:  # remo
-000286f0: 7665 2075 6e6e 6563 6573 7361 7279 2064  ve unnecessary d
-00028700: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
-00028710: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
-00028720: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
-00028730: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00028740: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00028750: 2020 2020 2020 2064 6570 7320 3d20 6465         deps = de
-00028760: 7065 6e64 656e 6369 6573 5b6b 6579 5d0a  pendencies[key].
-00028770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028780: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00028790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000287a0: 2020 2020 2064 6570 7320 3d20 7365 6c66       deps = self
-000287b0: 2e74 6173 6b73 5b6b 6579 5d2e 6465 7065  .tasks[key].depe
-000287c0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
-000287d0: 2020 2020 2020 2020 2066 6f72 2064 6570           for dep
-000287e0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
-000287f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00028800: 2064 6570 2069 6e20 6465 7065 6e64 656e   dep in dependen
-00028810: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00028820: 2020 2020 2020 2020 2020 2020 6368 696c              chil
-00028830: 645f 6465 7073 203d 2064 6570 656e 6465  d_deps = depende
-00028840: 6e74 735b 6465 705d 0a20 2020 2020 2020  nts[dep].       
-00028850: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00028860: 6620 6465 7020 696e 2073 656c 662e 7461  f dep in self.ta
-00028870: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00028880: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-00028890: 6c64 5f64 6570 7320 3d20 7365 6c66 2e74  ld_deps = self.t
-000288a0: 6173 6b73 5b64 6570 5d2e 6465 7065 6e64  asks[dep].depend
-000288b0: 656e 6369 6573 0a20 2020 2020 2020 2020  encies.         
-000288c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000288d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000288e0: 2020 2020 2020 2020 2063 6869 6c64 5f64           child_d
-000288f0: 6570 7320 3d20 7365 7428 290a 2020 2020  eps = set().    
-00028900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028910: 6966 2061 6c6c 2864 2069 6e20 646f 6e65  if all(d in done
-00028920: 2066 6f72 2064 2069 6e20 6368 696c 645f   for d in child_
-00028930: 6465 7073 293a 0a20 2020 2020 2020 2020  deps):.         
-00028940: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00028950: 6620 6465 7020 696e 2073 656c 662e 7461  f dep in self.ta
-00028960: 736b 7320 616e 6420 6465 7020 6e6f 7420  sks and dep not 
-00028970: 696e 2064 6f6e 653a 0a20 2020 2020 2020  in done:.       
-00028980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028990: 2020 2020 2064 6f6e 652e 6164 6428 6465       done.add(de
-000289a0: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-000289b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000289c0: 7461 636b 2e61 7070 656e 6428 6465 7029  tack.append(dep)
-000289d0: 0a20 2020 2020 2020 2066 6f72 2061 6e63  .        for anc
-000289e0: 2069 6e20 646f 6e65 3a0a 2020 2020 2020   in done:.      
-000289f0: 2020 2020 2020 6473 6b2e 706f 7028 616e        dsk.pop(an
-00028a00: 632c 204e 6f6e 6529 0a20 2020 2020 2020  c, None).       
-00028a10: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
-00028a20: 732e 706f 7028 616e 632c 204e 6f6e 6529  s.pop(anc, None)
-00028a30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00028a40: 646f 6e65 0a0a 2020 2020 4073 7461 7469  done..    @stati
-00028a50: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00028a60: 6d61 7465 7269 616c 697a 655f 6772 6170  materialize_grap
-00028a70: 6828 686c 673a 2048 6967 684c 6576 656c  h(hlg: HighLevel
-00028a80: 4772 6170 6829 202d 3e20 7475 706c 655b  Graph) -> tuple[
-00028a90: 6469 6374 2c20 6469 6374 2c20 6469 6374  dict, dict, dict
-00028aa0: 2c20 6469 6374 5d3a 0a20 2020 2020 2020  , dict]:.       
-00028ab0: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
-00028ac0: 642e 776f 726b 6572 2069 6d70 6f72 7420  d.worker import 
-00028ad0: 6475 6d70 735f 7461 736b 0a0a 2020 2020  dumps_task..    
-00028ae0: 2020 2020 6b65 795f 616e 6e6f 7461 7469      key_annotati
-00028af0: 6f6e 7320 3d20 7b7d 0a20 2020 2020 2020  ons = {}.       
-00028b00: 2064 736b 203d 2064 6173 6b2e 7574 696c   dsk = dask.util
-00028b10: 732e 656e 7375 7265 5f64 6963 7428 686c  s.ensure_dict(hl
-00028b20: 6729 0a0a 2020 2020 2020 2020 666f 7220  g)..        for 
-00028b30: 6c61 7965 7220 696e 2068 6c67 2e6c 6179  layer in hlg.lay
-00028b40: 6572 732e 7661 6c75 6573 2829 3a0a 2020  ers.values():.  
-00028b50: 2020 2020 2020 2020 2020 6966 206c 6179            if lay
-00028b60: 6572 2e61 6e6e 6f74 6174 696f 6e73 3a0a  er.annotations:.
-00028b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b80: 616e 6e6f 7420 3d20 6c61 7965 722e 616e  annot = layer.an
-00028b90: 6e6f 7461 7469 6f6e 730a 2020 2020 2020  notations.      
-00028ba0: 2020 2020 2020 2020 2020 6b65 795f 616e            key_an
-00028bb0: 6e6f 7461 7469 6f6e 732e 7570 6461 7465  notations.update
-00028bc0: 287b 7374 7269 6e67 6966 7928 6b29 3a20  ({stringify(k): 
-00028bd0: 616e 6e6f 7420 666f 7220 6b20 696e 206c  annot for k in l
-00028be0: 6179 6572 7d29 0a0a 2020 2020 2020 2020  ayer})..        
-00028bf0: 6465 7065 6e64 656e 6369 6573 2c20 5f20  dependencies, _ 
-00028c00: 3d20 6765 745f 6465 7073 2864 736b 290a  = get_deps(dsk).
-00028c10: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-00028c20: 6520 6046 7574 7572 6560 206f 626a 6563  e `Future` objec
-00028c30: 7473 2066 726f 6d20 6772 6170 6820 616e  ts from graph an
-00028c40: 6420 6e6f 7465 2061 6e79 2066 7574 7572  d note any futur
-00028c50: 6520 6465 7065 6e64 656e 6369 6573 0a20  e dependencies. 
-00028c60: 2020 2020 2020 2064 736b 3220 3d20 7b7d         dsk2 = {}
-00028c70: 0a20 2020 2020 2020 2066 7574 5f64 6570  .        fut_dep
-00028c80: 7320 3d20 7b7d 0a20 2020 2020 2020 2066  s = {}.        f
-00028c90: 6f72 206b 2c20 7620 696e 2064 736b 2e69  or k, v in dsk.i
-00028ca0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00028cb0: 2020 2020 6473 6b32 5b6b 5d2c 2066 7574      dsk2[k], fut
-00028cc0: 7320 3d20 756e 7061 636b 5f72 656d 6f74  s = unpack_remot
-00028cd0: 6564 6174 6128 762c 2062 7974 655f 6b65  edata(v, byte_ke
-00028ce0: 7973 3d54 7275 6529 0a20 2020 2020 2020  ys=True).       
-00028cf0: 2020 2020 2069 6620 6675 7473 3a0a 2020       if futs:.  
-00028d00: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00028d10: 745f 6465 7073 5b6b 5d20 3d20 6675 7473  t_deps[k] = futs
-00028d20: 0a20 2020 2020 2020 2064 736b 203d 2064  .        dsk = d
-00028d30: 736b 320a 0a20 2020 2020 2020 2023 202d  sk2..        # -
-00028d40: 2041 6464 2069 6e20 6465 7073 2066 6f72   Add in deps for
-00028d50: 2061 6e79 2074 6173 6b73 2074 6861 7420   any tasks that 
-00028d60: 6465 7065 6e64 206f 6e20 6675 7475 7265  depend on future
-00028d70: 730a 2020 2020 2020 2020 666f 7220 6b2c  s.        for k,
-00028d80: 2066 7574 7572 6573 2069 6e20 6675 745f   futures in fut_
-00028d90: 6465 7073 2e69 7465 6d73 2829 3a0a 2020  deps.items():.  
-00028da0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
-00028db0: 656e 6369 6573 5b6b 5d2e 7570 6461 7465  encies[k].update
-00028dc0: 2866 2e6b 6579 2066 6f72 2066 2069 6e20  (f.key for f in 
-00028dd0: 6675 7475 7265 7329 0a20 2020 2020 2020  futures).       
-00028de0: 206e 6577 5f64 736b 203d 207b 7d0a 2020   new_dsk = {}.  
-00028df0: 2020 2020 2020 2320 416e 6e6f 7461 7469        # Annotati
-00028e00: 6f6e 2063 616c 6c61 626c 6573 2061 7265  on callables are
-00028e10: 2065 7661 6c75 6174 6564 206f 6e20 7468   evaluated on th
-00028e20: 6520 6e6f 6e2d 7374 7269 6e67 6966 6965  e non-stringifie
-00028e30: 6420 7665 7273 696f 6e20 6f66 0a20 2020  d version of.   
-00028e40: 2020 2020 2023 2074 6865 206b 6579 730a       # the keys.
-00028e50: 2020 2020 2020 2020 7072 655f 7374 7269          pre_stri
-00028e60: 6e67 6966 6965 645f 6b65 7973 203d 207b  ngified_keys = {
-00028e70: 7d0a 2020 2020 2020 2020 6578 636c 7573  }.        exclus
-00028e80: 6976 6520 3d20 7365 7428 686c 6729 0a20  ive = set(hlg). 
-00028e90: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-00028ea0: 696e 2064 736b 2e69 7465 6d73 2829 3a0a  in dsk.items():.
-00028eb0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-00028ec0: 6b20 3d20 7374 7269 6e67 6966 7928 6b29  k = stringify(k)
-00028ed0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-00028ee0: 5f73 7472 696e 6769 6669 6564 5f6b 6579  _stringified_key
-00028ef0: 735b 6e65 775f 6b5d 203d 206b 0a20 2020  s[new_k] = k.   
-00028f00: 2020 2020 2020 2020 206e 6577 5f64 736b           new_dsk
-00028f10: 5b6e 6577 5f6b 5d20 3d20 7374 7269 6e67  [new_k] = string
-00028f20: 6966 7928 762c 2065 7863 6c75 7369 7665  ify(v, exclusive
-00028f30: 3d65 7863 6c75 7369 7665 290a 2020 2020  =exclusive).    
-00028f40: 2020 2020 6173 7365 7274 206c 656e 286e      assert len(n
-00028f50: 6577 5f64 736b 2920 3d3d 206c 656e 2870  ew_dsk) == len(p
-00028f60: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
-00028f70: 6579 7329 0a20 2020 2020 2020 2064 736b  eys).        dsk
-00028f80: 203d 206e 6577 5f64 736b 0a20 2020 2020   = new_dsk.     
-00028f90: 2020 2064 6570 656e 6465 6e63 6965 7320     dependencies 
-00028fa0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00028fb0: 7374 7269 6e67 6966 7928 6b29 3a20 7b73  stringify(k): {s
-00028fc0: 7472 696e 6769 6679 2864 6570 2920 666f  tringify(dep) fo
-00028fd0: 7220 6465 7020 696e 2064 6570 737d 0a20  r dep in deps}. 
-00028fe0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00028ff0: 2c20 6465 7073 2069 6e20 6465 7065 6e64  , deps in depend
-00029000: 656e 6369 6573 2e69 7465 6d73 2829 0a20  encies.items(). 
-00029010: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00029020: 2020 2320 5265 6d6f 7665 2061 6e79 2073    # Remove any s
-00029030: 656c 662d 6465 7065 6e64 656e 6369 6573  elf-dependencies
-00029040: 2028 6861 7070 656e 7320 6f6e 2074 6573   (happens on tes
-00029050: 745f 7075 626c 6973 685f 6261 6728 2920  t_publish_bag() 
-00029060: 616e 6420 6f74 6865 7273 290a 2020 2020  and others).    
-00029070: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-00029080: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
-00029090: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-000290a0: 2020 6465 7073 203d 2073 6574 2876 290a    deps = set(v).
-000290b0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000290c0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
-000290d0: 2020 2020 2020 2020 2020 6465 7073 2e72            deps.r
-000290e0: 656d 6f76 6528 6b29 0a20 2020 2020 2020  emove(k).       
-000290f0: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
-00029100: 735b 6b5d 203d 2064 6570 730a 0a20 2020  s[k] = deps..   
-00029110: 2020 2020 2023 2052 656d 6f76 6520 616c       # Remove al
-00029120: 6961 7365 730a 2020 2020 2020 2020 666f  iases.        fo
-00029130: 7220 6b20 696e 206c 6973 7428 6473 6b29  r k in list(dsk)
-00029140: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00029150: 2064 736b 5b6b 5d20 6973 206b 3a0a 2020   dsk[k] is k:.  
-00029160: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00029170: 6c20 6473 6b5b 6b5d 0a20 2020 2020 2020  l dsk[k].       
-00029180: 2064 736b 203d 2076 616c 6d61 7028 6475   dsk = valmap(du
-00029190: 6d70 735f 7461 736b 2c20 6473 6b29 0a20  mps_task, dsk). 
-000291a0: 2020 2020 2020 2072 6574 7572 6e20 6473         return ds
-000291b0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
-000291c0: 206b 6579 5f61 6e6e 6f74 6174 696f 6e73   key_annotations
-000291d0: 2c20 7072 655f 7374 7269 6e67 6966 6965  , pre_stringifie
-000291e0: 645f 6b65 7973 0a0a 2020 2020 6465 6620  d_keys..    def 
-000291f0: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
-00029200: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
-00029210: 6428 7365 6c66 2c20 2a2c 2073 7469 6d75  d(self, *, stimu
-00029220: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-00029230: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00029240: 2252 6573 706f 6e64 2074 6f20 616e 2065  "Respond to an e
-00029250: 7665 6e74 2077 6869 6368 206d 6179 2068  vent which may h
-00029260: 6176 6520 6f70 656e 6564 2073 706f 7473  ave opened spots
-00029270: 206f 6e20 776f 726b 6572 2074 6872 6561   on worker threa
-00029280: 6470 6f6f 6c73 0a0a 2020 2020 2020 2020  dpools..        
-00029290: 5365 6c65 6374 7320 7468 6520 6170 7072  Selects the appr
-000292a0: 6f70 7269 6174 6520 6e75 6d62 6572 206f  opriate number o
-000292b0: 6620 7461 736b 7320 6672 6f6d 2074 6865  f tasks from the
-000292c0: 2066 726f 6e74 206f 6620 7468 6520 7175   front of the qu
-000292d0: 6575 6520 6163 636f 7264 696e 6720 746f  eue according to
-000292e0: 0a20 2020 2020 2020 2074 6865 2074 6f74  .        the tot
-000292f0: 616c 206e 756d 6265 7220 6f66 2074 6173  al number of tas
-00029300: 6b20 736c 6f74 7320 6176 6169 6c61 626c  k slots availabl
-00029310: 6520 6f6e 2077 6f72 6b65 7273 2028 706f  e on workers (po
-00029320: 7465 6e74 6961 6c6c 7920 3029 2c20 616e  tentially 0), an
-00029330: 640a 2020 2020 2020 2020 7472 616e 7369  d.        transi
-00029340: 7469 6f6e 7320 7468 656d 2074 6f20 6060  tions them to ``
-00029350: 7072 6f63 6573 7369 6e67 6060 2e0a 0a20  processing``... 
-00029360: 2020 2020 2020 204e 6f74 6573 0a20 2020         Notes.   
-00029370: 2020 2020 202d 2d2d 2d2d 0a20 2020 2020       -----.     
-00029380: 2020 204f 7468 6572 2074 7261 6e73 6974     Other transit
-00029390: 696f 6e73 2072 656c 6174 6564 2074 6f20  ions related to 
-000293a0: 7468 6973 2073 7469 6d75 6c75 7320 7368  this stimulus sh
-000293b0: 6f75 6c64 2062 6520 6675 6c6c 7920 7072  ould be fully pr
-000293c0: 6f63 6573 7365 6420 6265 666f 7265 6861  ocessed beforeha
-000293d0: 6e64 2c0a 2020 2020 2020 2020 736f 2061  nd,.        so a
-000293e0: 6e79 2074 6173 6b73 2074 6861 7420 6265  ny tasks that be
-000293f0: 6361 6d65 2072 756e 6e61 626c 6520 6172  came runnable ar
-00029400: 6520 616c 7265 6164 7920 696e 2060 6070  e already in ``p
-00029410: 726f 6365 7373 696e 6760 602e 204f 7468  rocessing``. Oth
-00029420: 6572 7769 7365 2c0a 2020 2020 2020 2020  erwise,.        
-00029430: 6f76 6572 7072 6f64 7563 7469 6f6e 2063  overproduction c
-00029440: 616e 206f 6363 7572 2069 6620 7175 6575  an occur if queu
-00029450: 6564 2074 6173 6b73 2067 6574 2073 6368  ed tasks get sch
-00029460: 6564 756c 6564 2062 6566 6f72 6520 646f  eduled before do
-00029470: 776e 7374 7265 616d 2074 6173 6b73 2e0a  wnstream tasks..
-00029480: 0a20 2020 2020 2020 204d 7573 7420 6265  .        Must be
-00029490: 2063 616c 6c65 6420 6166 7465 7220 6063   called after `c
-000294a0: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
-000294b0: 7465 6460 3b20 692e 652e 2060 6964 6c65  ted`; i.e. `idle
-000294c0: 5f74 6173 6b5f 636f 756e 7460 206d 7573  _task_count` mus
-000294d0: 7420 6265 2075 700a 2020 2020 2020 2020  t be up.        
-000294e0: 746f 2064 6174 652e 0a20 2020 2020 2020  to date..       
-000294f0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00029500: 6e6f 7420 7365 6c66 2e71 7565 7565 643a  not self.queued:
-00029510: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00029520: 7572 6e0a 2020 2020 2020 2020 736c 6f74  urn.        slot
-00029530: 735f 6176 6169 6c61 626c 6520 3d20 7375  s_available = su
-00029540: 6d28 0a20 2020 2020 2020 2020 2020 205f  m(.            _
-00029550: 7461 736b 5f73 6c6f 7473 5f61 7661 696c  task_slots_avail
-00029560: 6162 6c65 2877 732c 2073 656c 662e 574f  able(ws, self.WO
-00029570: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
-00029580: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00029590: 2077 7320 696e 2073 656c 662e 6964 6c65   ws in self.idle
-000295a0: 5f74 6173 6b5f 636f 756e 740a 2020 2020  _task_count.    
-000295b0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-000295c0: 2073 6c6f 7473 5f61 7661 696c 6162 6c65   slots_available
-000295d0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-000295e0: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-000295f0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00029600: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
-00029610: 2020 2020 2020 666f 7220 7174 7320 696e        for qts in
-00029620: 2073 656c 662e 7175 6575 6564 2e70 6565   self.queued.pee
-00029630: 6b6e 2873 6c6f 7473 5f61 7661 696c 6162  kn(slots_availab
-00029640: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
-00029650: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00029660: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00029670: 2020 2061 7373 6572 7420 7174 732e 7374     assert qts.st
-00029680: 6174 6520 3d3d 2022 7175 6575 6564 222c  ate == "queued",
-00029690: 2071 7473 2e73 7461 7465 0a20 2020 2020   qts.state.     
-000296a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000296b0: 7420 6e6f 7420 7174 732e 7072 6f63 6573  t not qts.proces
-000296c0: 7369 6e67 5f6f 6e2c 2028 7174 732c 2071  sing_on, (qts, q
-000296d0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-000296e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000296f0: 2020 6173 7365 7274 206e 6f74 2071 7473    assert not qts
-00029700: 2e77 6169 7469 6e67 5f6f 6e2c 2028 7174  .waiting_on, (qt
-00029710: 732c 2071 7473 2e70 726f 6365 7373 696e  s, qts.processin
-00029720: 675f 6f6e 290a 2020 2020 2020 2020 2020  g_on).          
-00029730: 2020 2020 2020 6173 7365 7274 2071 7473        assert qts
-00029740: 2e77 686f 5f77 616e 7473 206f 7220 7174  .who_wants or qt
-00029750: 732e 7761 6974 6572 732c 2071 7473 0a20  s.waiters, qts. 
-00029760: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00029770: 6d65 6e64 6174 696f 6e73 5b71 7473 2e6b  mendations[qts.k
-00029780: 6579 5d20 3d20 2270 726f 6365 7373 696e  ey] = "processin
-00029790: 6722 0a0a 2020 2020 2020 2020 7365 6c66  g"..        self
-000297a0: 2e74 7261 6e73 6974 696f 6e73 2872 6563  .transitions(rec
-000297b0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
-000297c0: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-000297d0: 6465 6620 7374 696d 756c 7573 5f74 6173  def stimulus_tas
-000297e0: 6b5f 6669 6e69 7368 6564 2873 656c 662c  k_finished(self,
-000297f0: 206b 6579 2c20 776f 726b 6572 2c20 7374   key, worker, st
-00029800: 696d 756c 7573 5f69 642c 2072 756e 5f69  imulus_id, run_i
-00029810: 642c 202a 2a6b 7761 7267 7329 3a0a 2020  d, **kwargs):.  
-00029820: 2020 2020 2020 2222 224d 6172 6b20 7468        """Mark th
-00029830: 6174 2061 2074 6173 6b20 6861 7320 6669  at a task has fi
-00029840: 6e69 7368 6564 2065 7865 6375 7469 6f6e  nished execution
-00029850: 206f 6e20 6120 7061 7274 6963 756c 6172   on a particular
-00029860: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
-00029870: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00029880: 2253 7469 6d75 6c75 7320 7461 736b 2066  "Stimulus task f
-00029890: 696e 6973 6865 6420 2573 5b25 645d 2025  inished %s[%d] %
-000298a0: 7322 2c20 6b65 792c 2072 756e 5f69 642c  s", key, run_id,
-000298b0: 2077 6f72 6b65 7229 0a0a 2020 2020 2020   worker)..      
-000298c0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-000298d0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-000298e0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-000298f0: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
-00029900: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
-00029910: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
-00029920: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
-00029930: 6174 6520 3d20 7365 6c66 2e77 6f72 6b65  ate = self.worke
-00029940: 7273 5b77 6f72 6b65 725d 0a20 2020 2020  rs[worker].     
-00029950: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-00029960: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-00029970: 7428 6b65 7929 0a20 2020 2020 2020 2069  t(key).        i
-00029980: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
-00029990: 7473 2e73 7461 7465 2069 6e20 2822 7265  ts.state in ("re
-000299a0: 6c65 6173 6564 222c 2022 7175 6575 6564  leased", "queued
-000299b0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-000299c0: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-000299d0: 2020 2020 2020 2020 2020 2020 2020 2252                "R
-000299e0: 6563 6569 7665 6420 616c 7265 6164 7920  eceived already 
-000299f0: 636f 6d70 7574 6564 2074 6173 6b2c 2077  computed task, w
-00029a00: 6f72 6b65 723a 2025 732c 2073 7461 7465  orker: %s, state
-00029a10: 3a20 2573 220a 2020 2020 2020 2020 2020  : %s".          
-00029a20: 2020 2020 2020 222c 206b 6579 3a20 2573        ", key: %s
-00029a30: 2c20 7768 6f5f 6861 733a 2025 7322 2c0a  , who_has: %s",.
-00029a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a50: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
-00029a60: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-00029a70: 2069 6620 7473 2065 6c73 6520 2266 6f72   if ts else "for
-00029a80: 676f 7474 656e 222c 0a20 2020 2020 2020  gotten",.       
-00029a90: 2020 2020 2020 2020 206b 6579 2c0a 2020           key,.  
-00029aa0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00029ab0: 2e77 686f 5f68 6173 2069 6620 7473 2065  .who_has if ts e
-00029ac0: 6c73 6520 7b7d 2c0a 2020 2020 2020 2020  lse {},.        
-00029ad0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00029ae0: 2020 776f 726b 6572 5f6d 7367 735b 776f    worker_msgs[wo
-00029af0: 726b 6572 5d20 3d20 5b0a 2020 2020 2020  rker] = [.      
-00029b00: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00029b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b20: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
-00029b30: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00029b40: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
-00029b50: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
-00029b60: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-00029b70: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-00029b80: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-00029b90: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00029ba0: 2020 2020 5d0a 2020 2020 2020 2020 656c      ].        el
-00029bb0: 6966 2074 732e 7275 6e5f 6964 2021 3d20  if ts.run_id != 
-00029bc0: 7275 6e5f 6964 3a0a 2020 2020 2020 2020  run_id:.        
-00029bd0: 2020 2020 6966 206e 6f74 2074 732e 7072      if not ts.pr
-00029be0: 6f63 6573 7369 6e67 5f6f 6e20 6f72 2074  ocessing_on or t
-00029bf0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2e  s.processing_on.
-00029c00: 6164 6472 6573 7320 213d 2077 6f72 6b65  address != worke
-00029c10: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00029c20: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00029c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029c40: 2020 2020 2022 5265 6365 6976 6564 2073       "Received s
-00029c50: 7461 6c65 2074 6173 6b20 7275 6e2c 2077  tale task run, w
-00029c60: 6f72 6b65 723a 2025 732c 206b 6579 3a20  orker: %s, key: 
-00029c70: 2573 2c20 7275 6e5f 6964 3a20 2564 2028  %s, run_id: %d (
-00029c80: 2564 2922 2c0a 2020 2020 2020 2020 2020  %d)",.          
-00029c90: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00029ca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00029cb0: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
-00029cc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00029cd0: 756e 5f69 642c 0a20 2020 2020 2020 2020  un_id,.         
-00029ce0: 2020 2020 2020 2020 2020 2074 732e 7275             ts.ru
-00029cf0: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
-00029d00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00029d10: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-00029d20: 7367 735b 776f 726b 6572 5d20 3d20 5b0a  sgs[worker] = [.
-00029d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029d40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00029d50: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-00029d60: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
-00029d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029d80: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
-00029d90: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
-00029da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029db0: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
-00029dc0: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
-00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029de0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00029df0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-00029e00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00029e10: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00029e20: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
-00029e30: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
-00029e40: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
-00029e50: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
-00029e60: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00029e70: 6464 5f6b 6579 7328 776f 726b 6572 3d77  dd_keys(worker=w
-00029e80: 6f72 6b65 722c 206b 6579 733d 5b6b 6579  orker, keys=[key
-00029e90: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
-00029ea0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-00029eb0: 6d65 7461 6461 7461 2e75 7064 6174 6528  metadata.update(
-00029ec0: 6b77 6172 6773 5b22 6d65 7461 6461 7461  kwargs["metadata
-00029ed0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-00029ee0: 723a 2074 7570 6c65 203d 2073 656c 662e  r: tuple = self.
-00029ef0: 5f74 7261 6e73 6974 696f 6e28 0a20 2020  _transition(.   
-00029f00: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00029f10: 2c20 226d 656d 6f72 7922 2c20 7374 696d  , "memory", stim
-00029f20: 756c 7573 5f69 642c 2077 6f72 6b65 723d  ulus_id, worker=
-00029f30: 776f 726b 6572 2c20 2a2a 6b77 6172 6773  worker, **kwargs
-00029f40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00029f50: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00029f60: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
-00029f70: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
-00029f80: 6d73 6773 203d 2072 0a0a 2020 2020 2020  msgs = r..      
-00029f90: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-00029fa0: 6520 3d3d 2022 6d65 6d6f 7279 223a 0a20  e == "memory":. 
-00029fb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00029fc0: 7373 6572 7420 7773 2069 6e20 7473 2e77  ssert ws in ts.w
-00029fd0: 686f 5f68 6173 0a20 2020 2020 2020 2072  ho_has.        r
-00029fe0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00029ff0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-0002a000: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
-0002a010: 0a20 2020 2064 6566 2073 7469 6d75 6c75  .    def stimulu
-0002a020: 735f 7461 736b 5f65 7272 6564 280a 2020  s_task_erred(.  
-0002a030: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0002a040: 2020 2020 6b65 793d 4e6f 6e65 2c0a 2020      key=None,.  
-0002a050: 2020 2020 2020 776f 726b 6572 3d4e 6f6e        worker=Non
-0002a060: 652c 0a20 2020 2020 2020 2065 7863 6570  e,.        excep
-0002a070: 7469 6f6e 3d4e 6f6e 652c 0a20 2020 2020  tion=None,.     
-0002a080: 2020 2073 7469 6d75 6c75 735f 6964 3d4e     stimulus_id=N
-0002a090: 6f6e 652c 0a20 2020 2020 2020 2074 7261  one,.        tra
-0002a0a0: 6365 6261 636b 3d4e 6f6e 652c 0a20 2020  ceback=None,.   
-0002a0b0: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-0002a0c0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-0002a0d0: 224d 6172 6b20 7468 6174 2061 2074 6173  "Mark that a tas
-0002a0e0: 6b20 6861 7320 6572 7265 6420 6f6e 2061  k has erred on a
-0002a0f0: 2070 6172 7469 6375 6c61 7220 776f 726b   particular work
-0002a100: 6572 2222 220a 2020 2020 2020 2020 6c6f  er""".        lo
-0002a110: 6767 6572 2e64 6562 7567 2822 5374 696d  gger.debug("Stim
-0002a120: 756c 7573 2074 6173 6b20 6572 7265 6420  ulus task erred 
-0002a130: 2573 2c20 2573 222c 206b 6579 2c20 776f  %s, %s", key, wo
-0002a140: 726b 6572 290a 0a20 2020 2020 2020 2074  rker)..        t
-0002a150: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
-0002a160: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002a170: 7929 0a20 2020 2020 2020 2069 6620 7473  y).        if ts
-0002a180: 2069 7320 4e6f 6e65 206f 7220 7473 2e73   is None or ts.s
-0002a190: 7461 7465 2021 3d20 2270 726f 6365 7373  tate != "process
-0002a1a0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
-0002a1b0: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-0002a1c0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-0002a1d0: 7473 2e72 6574 7269 6573 203e 2030 3a0a  ts.retries > 0:.
-0002a1e0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
-0002a1f0: 6574 7269 6573 202d 3d20 310a 2020 2020  etries -= 1.    
-0002a200: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0002a210: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
-0002a220: 6b65 792c 2022 7761 6974 696e 6722 2c20  key, "waiting", 
-0002a230: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
-0002a240: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002a250: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0002a260: 6c66 2e5f 7472 616e 7369 7469 6f6e 280a  lf._transition(.
-0002a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a280: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0002a290: 2020 2020 2022 6572 7265 6422 2c0a 2020       "erred",.  
-0002a2a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002a2b0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-0002a2c0: 2020 2020 2020 2020 2020 2063 6175 7365             cause
-0002a2d0: 3d6b 6579 2c0a 2020 2020 2020 2020 2020  =key,.          
-0002a2e0: 2020 2020 2020 6578 6365 7074 696f 6e3d        exception=
-0002a2f0: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
-0002a300: 2020 2020 2020 2020 2020 2074 7261 6365             trace
-0002a310: 6261 636b 3d74 7261 6365 6261 636b 2c0a  back=traceback,.
-0002a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a330: 776f 726b 6572 3d77 6f72 6b65 722c 0a20  worker=worker,. 
-0002a340: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-0002a350: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-0002a360: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0002a370: 7374 696d 756c 7573 5f72 6574 7279 2873  stimulus_retry(s
-0002a380: 656c 662c 206b 6579 732c 2063 6c69 656e  elf, keys, clien
-0002a390: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
-0002a3a0: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
-0002a3b0: 6965 6e74 2025 7320 7265 7175 6573 7473  ient %s requests
-0002a3c0: 2074 6f20 7265 7472 7920 2564 206b 6579   to retry %d key
-0002a3d0: 7322 2c20 636c 6965 6e74 2c20 6c65 6e28  s", client, len(
-0002a3e0: 6b65 7973 2929 0a20 2020 2020 2020 2069  keys)).        i
-0002a3f0: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
-0002a400: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-0002a410: 7665 6e74 2863 6c69 656e 742c 207b 2261  vent(client, {"a
-0002a420: 6374 696f 6e22 3a20 2272 6574 7279 222c  ction": "retry",
-0002a430: 2022 636f 756e 7422 3a20 6c65 6e28 6b65   "count": len(ke
-0002a440: 7973 297d 290a 0a20 2020 2020 2020 2073  ys)})..        s
-0002a450: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
-0002a460: 290a 2020 2020 2020 2020 7365 656e 203d  ).        seen =
-0002a470: 2073 6574 2829 0a20 2020 2020 2020 2072   set().        r
-0002a480: 6f6f 7473 203d 205b 5d0a 2020 2020 2020  oots = [].      
-0002a490: 2020 7768 696c 6520 7374 6163 6b3a 0a20    while stack:. 
-0002a4a0: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-0002a4b0: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
-0002a4c0: 2020 2020 2020 2020 2073 6565 6e2e 6164           seen.ad
-0002a4d0: 6428 6b65 7929 0a20 2020 2020 2020 2020  d(key).         
-0002a4e0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-0002a4f0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-0002a500: 2020 2020 6572 7265 645f 6465 7073 203d      erred_deps =
-0002a510: 205b 6474 732e 6b65 7920 666f 7220 6474   [dts.key for dt
-0002a520: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0002a530: 6369 6573 2069 6620 6474 732e 7374 6174  cies if dts.stat
-0002a540: 6520 3d3d 2022 6572 7265 6422 5d0a 2020  e == "erred"].  
-0002a550: 2020 2020 2020 2020 2020 6966 2065 7272            if err
-0002a560: 6564 5f64 6570 733a 0a20 2020 2020 2020  ed_deps:.       
-0002a570: 2020 2020 2020 2020 2073 7461 636b 2e65           stack.e
-0002a580: 7874 656e 6428 6572 7265 645f 6465 7073  xtend(erred_deps
-0002a590: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0002a5a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002a5b0: 2020 2020 726f 6f74 732e 6170 7065 6e64      roots.append
-0002a5c0: 286b 6579 290a 0a20 2020 2020 2020 2072  (key)..        r
-0002a5d0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0002a5e0: 5265 6373 203d 207b 6b65 793a 2022 7761  Recs = {key: "wa
-0002a5f0: 6974 696e 6722 2066 6f72 206b 6579 2069  iting" for key i
-0002a600: 6e20 726f 6f74 737d 0a20 2020 2020 2020  n roots}.       
-0002a610: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0002a620: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
-0002a630: 732c 2066 2273 7469 6d75 6c75 732d 7265  s, f"stimulus-re
-0002a640: 7472 792d 7b74 696d 6528 297d 2229 0a0a  try-{time()}")..
-0002a650: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0002a660: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-0002a670: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-0002a680: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
-0002a690: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002a6a0: 7420 7365 6c66 2e74 6173 6b73 5b6b 6579  t self.tasks[key
-0002a6b0: 5d2e 6578 6365 7074 696f 6e5f 626c 616d  ].exception_blam
-0002a6c0: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
-0002a6d0: 6e20 7475 706c 6528 7365 656e 290a 0a20  n tuple(seen).. 
-0002a6e0: 2020 2064 6566 2063 6c6f 7365 5f77 6f72     def close_wor
-0002a6f0: 6b65 7228 7365 6c66 2c20 776f 726b 6572  ker(self, worker
-0002a700: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-0002a710: 2020 2020 2020 2020 2222 2241 736b 2061          """Ask a
-0002a720: 2077 6f72 6b65 7220 746f 2073 6875 7420   worker to shut 
-0002a730: 6974 7365 6c66 2064 6f77 6e2e 2044 6f20  itself down. Do 
-0002a740: 6e6f 7420 7761 6974 2066 6f72 2069 7420  not wait for it 
-0002a750: 746f 2074 616b 6520 6566 6665 6374 2e0a  to take effect..
-0002a760: 2020 2020 2020 2020 4e6f 7465 2074 6861          Note tha
-0002a770: 7420 7468 6572 6520 6973 206e 6f20 6775  t there is no gu
-0002a780: 6172 616e 7465 6520 7468 6174 2074 6865  arantee that the
-0002a790: 2077 6f72 6b65 7220 7769 6c6c 2061 6374   worker will act
-0002a7a0: 7561 6c6c 7920 6163 6365 7074 2074 6865  ually accept the
-0002a7b0: 0a20 2020 2020 2020 2063 6f6d 6d61 6e64  .        command
-0002a7c0: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
-0002a7d0: 7468 6174 203a 6d65 7468 3a60 7265 6d6f  that :meth:`remo
-0002a7e0: 7665 5f77 6f72 6b65 7260 2073 656e 6473  ve_worker` sends
-0002a7f0: 2074 6865 2073 616d 6520 636f 6d6d 616e   the same comman
-0002a800: 6420 696e 7465 726e 616c 6c79 2069 6620  d internally if 
-0002a810: 636c 6f73 653d 5472 7565 2e0a 0a20 2020  close=True...   
-0002a820: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-0002a830: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0002a840: 2020 2020 2020 2072 6574 6972 655f 776f         retire_wo
-0002a850: 726b 6572 730a 2020 2020 2020 2020 7265  rkers.        re
-0002a860: 6d6f 7665 5f77 6f72 6b65 720a 2020 2020  move_worker.    
-0002a870: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002a880: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
-0002a890: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
-0002a8a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a8b0: 6e0a 0a20 2020 2020 2020 206c 6f67 6765  n..        logge
-0002a8c0: 722e 696e 666f 2822 436c 6f73 696e 6720  r.info("Closing 
-0002a8d0: 776f 726b 6572 2025 7322 2c20 776f 726b  worker %s", work
-0002a8e0: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
-0002a8f0: 2e6c 6f67 5f65 7665 6e74 2877 6f72 6b65  .log_event(worke
-0002a900: 722c 207b 2261 6374 696f 6e22 3a20 2263  r, {"action": "c
-0002a910: 6c6f 7365 2d77 6f72 6b65 7222 7d29 0a20  lose-worker"}). 
-0002a920: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-0002a930: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
-0002a940: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
-0002a950: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
-0002a960: 756c 6572 2d63 6c6f 7365 2d77 6f72 6b65  uler-close-worke
-0002a970: 7222 7d29 0a0a 2020 2020 406c 6f67 5f65  r"})..    @log_e
-0002a980: 7272 6f72 730a 2020 2020 6173 796e 6320  rrors.    async 
-0002a990: 6465 6620 7265 6d6f 7665 5f77 6f72 6b65  def remove_worke
-0002a9a0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-0002a9b0: 2061 6464 7265 7373 3a20 7374 722c 202a   address: str, *
-0002a9c0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0002a9d0: 7472 2c20 7361 6665 3a20 626f 6f6c 203d  tr, safe: bool =
-0002a9e0: 2046 616c 7365 2c20 636c 6f73 653a 2062   False, close: b
-0002a9f0: 6f6f 6c20 3d20 5472 7565 0a20 2020 2029  ool = True.    )
-0002aa00: 202d 3e20 4c69 7465 7261 6c5b 224f 4b22   -> Literal["OK"
-0002aa10: 2c20 2261 6c72 6561 6479 2d72 656d 6f76  , "already-remov
-0002aa20: 6564 225d 3a0a 2020 2020 2020 2020 2222  ed"]:.        ""
-0002aa30: 2252 656d 6f76 6520 776f 726b 6572 2066  "Remove worker f
-0002aa40: 726f 6d20 636c 7573 7465 722e 0a0a 2020  rom cluster...  
-0002aa50: 2020 2020 2020 5765 2064 6f20 7468 6973        We do this
-0002aa60: 2077 6865 6e20 6120 776f 726b 6572 2072   when a worker r
-0002aa70: 6570 6f72 7473 2074 6861 7420 6974 2070  eports that it p
-0002aa80: 6c61 6e73 2074 6f20 6c65 6176 6520 6f72  lans to leave or
-0002aa90: 2077 6865 6e20 6974 2061 7070 6561 7273   when it appears
-0002aaa0: 2074 6f20 6265 0a20 2020 2020 2020 2075   to be.        u
-0002aab0: 6e72 6573 706f 6e73 6976 652e 2054 6869  nresponsive. Thi
-0002aac0: 7320 6d61 7920 7365 6e64 2069 7473 2074  s may send its t
-0002aad0: 6173 6b73 2062 6163 6b20 746f 2061 2072  asks back to a r
-0002aae0: 656c 6561 7365 6420 7374 6174 652e 0a0a  eleased state...
-0002aaf0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-0002ab00: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0002ab10: 2d0a 2020 2020 2020 2020 7265 7469 7265  -.        retire
-0002ab20: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-0002ab30: 2063 6c6f 7365 5f77 6f72 6b65 720a 2020   close_worker.  
-0002ab40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0002ab50: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
-0002ab60: 203d 3d20 5374 6174 7573 2e63 6c6f 7365   == Status.close
-0002ab70: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
-0002ab80: 6574 7572 6e20 2261 6c72 6561 6479 2d72  eturn "already-r
-0002ab90: 656d 6f76 6564 220a 0a20 2020 2020 2020  emoved"..       
-0002aba0: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
-0002abb0: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
-0002abc0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-0002abd0: 2069 6620 6164 6472 6573 7320 6e6f 7420   if address not 
-0002abe0: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
-0002abf0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002ac00: 7572 6e20 2261 6c72 6561 6479 2d72 656d  urn "already-rem
-0002ac10: 6f76 6564 220a 0a20 2020 2020 2020 2068  oved"..        h
-0002ac20: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
-0002ac30: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
-0002ac40: 0a20 2020 2020 2020 2077 733a 2057 6f72  .        ws: Wor
-0002ac50: 6b65 7253 7461 7465 203d 2073 656c 662e  kerState = self.
-0002ac60: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
-0002ac70: 0a0a 2020 2020 2020 2020 6576 656e 745f  ..        event_
-0002ac80: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
-0002ac90: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
-0002aca0: 656d 6f76 652d 776f 726b 6572 222c 0a20  emove-worker",. 
-0002acb0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
-0002acc0: 6573 7369 6e67 2d74 6173 6b73 223a 207b  essing-tasks": {
-0002acd0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
-0002ace0: 2077 732e 7072 6f63 6573 7369 6e67 7d2c   ws.processing},
-0002acf0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-0002ad00: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-0002ad10: 7428 6164 6472 6573 732c 2065 7665 6e74  t(address, event
-0002ad20: 5f6d 7367 2e63 6f70 7928 2929 0a20 2020  _msg.copy()).   
-0002ad30: 2020 2020 2065 7665 6e74 5f6d 7367 5b22       event_msg["
-0002ad40: 776f 726b 6572 225d 203d 2061 6464 7265  worker"] = addre
-0002ad50: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
-0002ad60: 6c6f 675f 6576 656e 7428 2261 6c6c 222c  log_event("all",
-0002ad70: 2065 7665 6e74 5f6d 7367 290a 0a20 2020   event_msg)..   
-0002ad80: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0002ad90: 2822 5265 6d6f 7665 2077 6f72 6b65 7220  ("Remove worker 
-0002ada0: 2573 222c 2077 7329 0a20 2020 2020 2020  %s", ws).       
-0002adb0: 2069 6620 636c 6f73 653a 0a20 2020 2020   if close:.     
-0002adc0: 2020 2020 2020 2077 6974 6820 7375 7070         with supp
-0002add0: 7265 7373 2841 7474 7269 6275 7465 4572  ress(AttributeEr
-0002ade0: 726f 722c 2043 6f6d 6d43 6c6f 7365 6445  ror, CommClosedE
-0002adf0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0002ae00: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-0002ae10: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
-0002ae20: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
-0002ae30: 2020 2020 2020 2020 2020 2020 7b22 6f70              {"op
-0002ae40: 223a 2022 636c 6f73 6522 2c20 2272 6561  ": "close", "rea
-0002ae50: 736f 6e22 3a20 2273 6368 6564 756c 6572  son": "scheduler
-0002ae60: 2d72 656d 6f76 652d 776f 726b 6572 227d  -remove-worker"}
-0002ae70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ae80: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-0002ae90: 2e72 656d 6f76 655f 7265 736f 7572 6365  .remove_resource
-0002aea0: 7328 6164 6472 6573 7329 0a0a 2020 2020  s(address)..    
-0002aeb0: 2020 2020 6468 3a20 6469 6374 203d 2073      dh: dict = s
-0002aec0: 656c 662e 686f 7374 5f69 6e66 6f5b 686f  elf.host_info[ho
-0002aed0: 7374 5d0a 2020 2020 2020 2020 6468 5f61  st].        dh_a
-0002aee0: 6464 7265 7373 6573 3a20 7365 7420 3d20  ddresses: set = 
-0002aef0: 6468 5b22 6164 6472 6573 7365 7322 5d0a  dh["addresses"].
-0002af00: 2020 2020 2020 2020 6468 5f61 6464 7265          dh_addre
-0002af10: 7373 6573 2e72 656d 6f76 6528 6164 6472  sses.remove(addr
-0002af20: 6573 7329 0a20 2020 2020 2020 2064 685b  ess).        dh[
-0002af30: 226e 7468 7265 6164 7322 5d20 2d3d 2077  "nthreads"] -= w
-0002af40: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
-0002af50: 2020 2073 656c 662e 746f 7461 6c5f 6e74     self.total_nt
-0002af60: 6872 6561 6473 202d 3d20 7773 2e6e 7468  hreads -= ws.nth
-0002af70: 7265 6164 730a 2020 2020 2020 2020 6966  reads.        if
-0002af80: 206e 6f74 2064 685f 6164 6472 6573 7365   not dh_addresse
-0002af90: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-0002afa0: 656c 2073 656c 662e 686f 7374 5f69 6e66  el self.host_inf
-0002afb0: 6f5b 686f 7374 5d0a 0a20 2020 2020 2020  o[host]..       
-0002afc0: 2073 656c 662e 7270 632e 7265 6d6f 7665   self.rpc.remove
-0002afd0: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
-0002afe0: 2020 6465 6c20 7365 6c66 2e73 7472 6561    del self.strea
-0002aff0: 6d5f 636f 6d6d 735b 6164 6472 6573 735d  m_comms[address]
-0002b000: 0a20 2020 2020 2020 2064 656c 2073 656c  .        del sel
-0002b010: 662e 616c 6961 7365 735b 7773 2e6e 616d  f.aliases[ws.nam
-0002b020: 655d 0a20 2020 2020 2020 2073 656c 662e  e].        self.
-0002b030: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
-0002b040: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
-0002b050: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
-0002b060: 6b5f 636f 756e 742e 6469 7363 6172 6428  k_count.discard(
-0002b070: 7773 290a 2020 2020 2020 2020 7365 6c66  ws).        self
-0002b080: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
-0002b090: 7264 2877 7329 0a20 2020 2020 2020 2064  rd(ws).        d
-0002b0a0: 656c 2073 656c 662e 776f 726b 6572 735b  el self.workers[
-0002b0b0: 6164 6472 6573 735d 0a20 2020 2020 2020  address].       
-0002b0c0: 2077 732e 7374 6174 7573 203d 2053 7461   ws.status = Sta
-0002b0d0: 7475 732e 636c 6f73 6564 0a20 2020 2020  tus.closed.     
-0002b0e0: 2020 2073 656c 662e 7275 6e6e 696e 672e     self.running.
-0002b0f0: 6469 7363 6172 6428 7773 290a 0a20 2020  discard(ws)..   
-0002b100: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002b110: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-0002b120: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0002b130: 6b53 7461 7465 0a20 2020 2020 2020 2066  kState.        f
-0002b140: 6f72 2074 7320 696e 206c 6973 7428 7773  or ts in list(ws
-0002b150: 2e70 726f 6365 7373 696e 6729 3a0a 2020  .processing):.  
-0002b160: 2020 2020 2020 2020 2020 6b20 3d20 7473            k = ts
-0002b170: 2e6b 6579 0a20 2020 2020 2020 2020 2020  .key.           
-0002b180: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0002b190: 5b6b 5d20 3d20 2272 656c 6561 7365 6422  [k] = "released"
-0002b1a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002b1b0: 6e6f 7420 7361 6665 3a0a 2020 2020 2020  not safe:.      
-0002b1c0: 2020 2020 2020 2020 2020 7473 2e73 7573            ts.sus
-0002b1d0: 7069 6369 6f75 7320 2b3d 2031 0a20 2020  picious += 1.   
-0002b1e0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002b1f0: 7072 6566 6978 2e73 7573 7069 6369 6f75  prefix.suspiciou
-0002b200: 7320 2b3d 2031 0a20 2020 2020 2020 2020  s += 1.         
-0002b210: 2020 2020 2020 2069 6620 7473 2e73 7573         if ts.sus
-0002b220: 7069 6369 6f75 7320 3e20 7365 6c66 2e61  picious > self.a
-0002b230: 6c6c 6f77 6564 5f66 6169 6c75 7265 733a  llowed_failures:
-0002b240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b250: 2020 2020 2064 656c 2072 6563 6f6d 6d65       del recomme
-0002b260: 6e64 6174 696f 6e73 5b6b 5d0a 2020 2020  ndations[k].    
-0002b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b280: 6520 3d20 7069 636b 6c65 2e64 756d 7073  e = pickle.dumps
-0002b290: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002b2a0: 2020 2020 2020 2020 2020 4b69 6c6c 6564            Killed
-0002b2b0: 576f 726b 6572 280a 2020 2020 2020 2020  Worker(.        
-0002b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2d0: 2020 2020 7461 736b 3d6b 2c0a 2020 2020      task=k,.    
-0002b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2f0: 2020 2020 2020 2020 6c61 7374 5f77 6f72          last_wor
-0002b300: 6b65 723d 7773 2e63 6c65 616e 2829 2c0a  ker=ws.clean(),.
-0002b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b320: 2020 2020 2020 2020 2020 2020 616c 6c6f              allo
-0002b330: 7765 645f 6661 696c 7572 6573 3d73 656c  wed_failures=sel
-0002b340: 662e 616c 6c6f 7765 645f 6661 696c 7572  f.allowed_failur
-0002b350: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0002b360: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0002b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b380: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002b390: 2020 2020 2020 2020 2072 203d 2073 656c           r = sel
-0002b3a0: 662e 7472 616e 7369 7469 6f6e 280a 2020  f.transition(.  
-0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3c0: 2020 2020 2020 6b2c 0a20 2020 2020 2020        k,.       
-0002b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3e0: 2022 6572 7265 6422 2c0a 2020 2020 2020   "erred",.      
-0002b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b400: 2020 6578 6365 7074 696f 6e3d 652c 0a20    exception=e,. 
-0002b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b420: 2020 2020 2020 2063 6175 7365 3d6b 2c0a         cause=k,.
-0002b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b440: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-0002b450: 5f69 643d 7374 696d 756c 7573 5f69 642c  _id=stimulus_id,
-0002b460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b470: 2020 2020 2020 2020 2077 6f72 6b65 723d           worker=
-0002b480: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-0002b490: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4b0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0002b4c0: 6e73 2e75 7064 6174 6528 7229 0a20 2020  ns.update(r).   
-0002b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4e0: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
-0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b500: 2020 2020 2020 2254 6173 6b20 2573 206d        "Task %s m
-0002b510: 6172 6b65 6420 6173 2066 6169 6c65 6420  arked as failed 
-0002b520: 6265 6361 7573 6520 2564 2077 6f72 6b65  because %d worke
-0002b530: 7273 2064 6965 6422 0a20 2020 2020 2020  rs died".       
-0002b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b550: 2022 2077 6869 6c65 2074 7279 696e 6720   " while trying 
-0002b560: 746f 2072 756e 2069 7422 2c0a 2020 2020  to run it",.    
-0002b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b580: 2020 2020 7473 2e6b 6579 2c0a 2020 2020      ts.key,.    
-0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5a0: 2020 2020 7365 6c66 2e61 6c6c 6f77 6564      self.allowed
-0002b5b0: 5f66 6169 6c75 7265 732c 0a20 2020 2020  _failures,.     
-0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002b5d0: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
-0002b5e0: 2069 6e20 6c69 7374 2877 732e 6861 735f   in list(ws.has_
-0002b5f0: 7768 6174 293a 0a20 2020 2020 2020 2020  what):.         
-0002b600: 2020 2073 656c 662e 7265 6d6f 7665 5f72     self.remove_r
-0002b610: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
-0002b620: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0002b630: 7420 7473 2e77 686f 5f68 6173 3a0a 2020  t ts.who_has:.  
-0002b640: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002b650: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
-0002b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b670: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002b680: 735b 7473 2e6b 6579 5d20 3d20 2272 656c  s[ts.key] = "rel
-0002b690: 6561 7365 6422 0a20 2020 2020 2020 2020  eased".         
-0002b6a0: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
-0002b6b0: 7075 7265 2064 6174 610a 2020 2020 2020  pure data.      
-0002b6c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002b6d0: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
-0002b6e0: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
-0002b6f0: 656e 220a 0a20 2020 2020 2020 2073 656c  en"..        sel
-0002b700: 662e 7472 616e 7369 7469 6f6e 7328 7265  f.transitions(re
-0002b710: 636f 6d6d 656e 6461 7469 6f6e 732c 2073  commendations, s
-0002b720: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-0002b730: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
-0002b740: 2061 7761 6974 6162 6c65 7320 3d20 5b5d   awaitables = []
-0002b750: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
-0002b760: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-0002b770: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-0002b780: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002b790: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002b7a0: 2020 2020 2072 6573 756c 7420 3d20 706c       result = pl
-0002b7b0: 7567 696e 2e72 656d 6f76 655f 776f 726b  ugin.remove_work
-0002b7c0: 6572 2873 6368 6564 756c 6572 3d73 656c  er(scheduler=sel
-0002b7d0: 662c 2077 6f72 6b65 723d 6164 6472 6573  f, worker=addres
-0002b7e0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0002b7f0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
-0002b800: 6177 6169 7461 626c 6528 7265 7375 6c74  awaitable(result
-0002b810: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002b820: 2020 2020 2020 2061 7761 6974 6162 6c65         awaitable
-0002b830: 732e 6170 7065 6e64 2872 6573 756c 7429  s.append(result)
-0002b840: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0002b850: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0002b860: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0002b870: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-0002b880: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
-0002b890: 2070 6c75 6769 6e5f 6d73 6773 203d 2061   plugin_msgs = a
-0002b8a0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-0002b8b0: 6865 7228 2a61 7761 6974 6162 6c65 732c  her(*awaitables,
-0002b8c0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-0002b8d0: 6e73 3d54 7275 6529 0a20 2020 2020 2020  ns=True).       
-0002b8e0: 2070 6c75 6769 6e73 5f65 7863 6570 7469   plugins_excepti
-0002b8f0: 6f6e 7320 3d20 5b6d 7367 2066 6f72 206d  ons = [msg for m
-0002b900: 7367 2069 6e20 706c 7567 696e 5f6d 7367  sg in plugin_msg
-0002b910: 7320 6966 2069 7369 6e73 7461 6e63 6528  s if isinstance(
-0002b920: 6d73 672c 2045 7863 6570 7469 6f6e 295d  msg, Exception)]
-0002b930: 0a20 2020 2020 2020 2066 6f72 2065 7863  .        for exc
-0002b940: 2069 6e20 706c 7567 696e 735f 6578 6365   in plugins_exce
-0002b950: 7074 696f 6e73 3a0a 2020 2020 2020 2020  ptions:.        
-0002b960: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-0002b970: 7469 6f6e 2865 7863 2c20 6578 635f 696e  tion(exc, exc_in
-0002b980: 666f 3d65 7863 290a 0a20 2020 2020 2020  fo=exc)..       
-0002b990: 2069 6620 6e6f 7420 7365 6c66 2e77 6f72   if not self.wor
-0002b9a0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-0002b9b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 224c    logger.info("L
-0002b9c0: 6f73 7420 616c 6c20 776f 726b 6572 7322  ost all workers"
-0002b9d0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
-0002b9e0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0002b9f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002ba00: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
-0002ba10: 6b65 7273 2e70 6f70 2828 6164 6472 6573  kers.pop((addres
-0002ba20: 732c 2077 292c 204e 6f6e 6529 0a20 2020  s, w), None).   
-0002ba30: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-0002ba40: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
-0002ba50: 706f 7028 2877 2c20 6164 6472 6573 7329  pop((w, address)
-0002ba60: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
-0002ba70: 2061 7379 6e63 2064 6566 2072 656d 6f76   async def remov
-0002ba80: 655f 776f 726b 6572 5f66 726f 6d5f 6576  e_worker_from_ev
-0002ba90: 656e 7473 2829 202d 3e20 4e6f 6e65 3a0a  ents() -> None:.
-0002baa0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-0002bab0: 2074 6865 2077 6f72 6b65 7220 6973 6e27   the worker isn'
-0002bac0: 7420 7265 6769 7374 6572 6564 2061 6e79  t registered any
-0002bad0: 6d6f 7265 2061 6674 6572 2074 6865 2064  more after the d
-0002bae0: 656c 6179 2c20 7265 6d6f 7665 2066 726f  elay, remove fro
-0002baf0: 6d20 6576 656e 7473 0a20 2020 2020 2020  m events.       
-0002bb00: 2020 2020 2069 6620 6164 6472 6573 7320       if address 
-0002bb10: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
-0002bb20: 6572 7320 616e 6420 6164 6472 6573 7320  ers and address 
-0002bb30: 696e 2073 656c 662e 6576 656e 7473 3a0a  in self.events:.
-0002bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb50: 6465 6c20 7365 6c66 2e65 7665 6e74 735b  del self.events[
-0002bb60: 6164 6472 6573 735d 0a0a 2020 2020 2020  address]..      
-0002bb70: 2020 636c 6561 6e75 705f 6465 6c61 7920    cleanup_delay 
-0002bb80: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-0002bb90: 6128 0a20 2020 2020 2020 2020 2020 2064  a(.            d
-0002bba0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0002bbb0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0002bbc0: 6475 6c65 722e 6576 656e 7473 2d63 6c65  duler.events-cle
-0002bbd0: 616e 7570 2d64 656c 6179 2229 0a20 2020  anup-delay").   
-0002bbe0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0002bbf0: 7365 6c66 2e5f 6f6e 676f 696e 675f 6261  self._ongoing_ba
-0002bc00: 636b 6772 6f75 6e64 5f74 6173 6b73 2e63  ckground_tasks.c
-0002bc10: 616c 6c5f 6c61 7465 7228 0a20 2020 2020  all_later(.     
-0002bc20: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
-0002bc30: 656c 6179 2c20 7265 6d6f 7665 5f77 6f72  elay, remove_wor
-0002bc40: 6b65 725f 6672 6f6d 5f65 7665 6e74 730a  ker_from_events.
-0002bc50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002bc60: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0002bc70: 5265 6d6f 7665 6420 776f 726b 6572 2025  Removed worker %
-0002bc80: 7322 2c20 7773 290a 0a20 2020 2020 2020  s", ws)..       
-0002bc90: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
-0002bca0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0002bcb0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
-0002bcc0: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
-0002bcd0: 2020 2020 2020 772c 0a20 2020 2020 2020        w,.       
-0002bce0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0002bcf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002bd00: 6f70 223a 2022 7265 6d6f 7665 2d77 6f72  op": "remove-wor
-0002bd10: 6b65 7222 2c0a 2020 2020 2020 2020 2020  ker",.          
-0002bd20: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-0002bd30: 7222 3a20 6164 6472 6573 732c 0a20 2020  r": address,.   
-0002bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd50: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
-0002bd60: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-0002bd70: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
-0002bd80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0002bd90: 2020 2020 2020 2072 6574 7572 6e20 224f         return "O
-0002bda0: 4b22 0a0a 2020 2020 6465 6620 7374 696d  K"..    def stim
-0002bdb0: 756c 7573 5f63 616e 6365 6c28 0a20 2020  ulus_cancel(.   
-0002bdc0: 2020 2020 2073 656c 662c 206b 6579 733a       self, keys:
-0002bdd0: 2053 6571 7565 6e63 655b 7374 725d 2c20   Sequence[str], 
-0002bde0: 636c 6965 6e74 3a20 7374 722c 2066 6f72  client: str, for
-0002bdf0: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
-0002be00: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-0002be10: 2020 2020 2020 2020 2222 2253 746f 7020          """Stop 
-0002be20: 6578 6563 7574 696f 6e20 6f6e 2061 206c  execution on a l
-0002be30: 6973 7420 6f66 206b 6579 7322 2222 0a20  ist of keys""". 
-0002be40: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002be50: 666f 2822 436c 6965 6e74 2025 7320 7265  fo("Client %s re
-0002be60: 7175 6573 7473 2074 6f20 6361 6e63 656c  quests to cancel
-0002be70: 2025 6420 6b65 7973 222c 2063 6c69 656e   %d keys", clien
-0002be80: 742c 206c 656e 286b 6579 7329 290a 2020  t, len(keys)).  
-0002be90: 2020 2020 2020 6966 2063 6c69 656e 743a        if client:
-0002bea0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002beb0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-0002bec0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-0002bed0: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
-0002bee0: 2263 616e 6365 6c22 2c20 2263 6f75 6e74  "cancel", "count
-0002bef0: 223a 206c 656e 286b 6579 7329 2c20 2266  ": len(keys), "f
-0002bf00: 6f72 6365 223a 2066 6f72 6365 7d0a 2020  orce": force}.  
-0002bf10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002bf20: 2020 2020 6361 6e63 656c 6c65 645f 6b65      cancelled_ke
-0002bf30: 7973 203d 205b 5d0a 2020 2020 2020 2020  ys = [].        
-0002bf40: 636c 6965 6e74 7320 3d20 5b5d 0a20 2020  clients = [].   
-0002bf50: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-0002bf60: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0002bf70: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002bf80: 7c20 4e6f 6e65 203d 2073 656c 662e 7461  | None = self.ta
-0002bf90: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-0002bfa0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0002bfb0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0002bfc0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0002bfd0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0002bfe0: 2020 2020 2020 2020 2020 2020 2020 6373                cs
-0002bff0: 3a20 436c 6965 6e74 5374 6174 6520 3d20  : ClientState = 
-0002c000: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
-0002c010: 656e 745d 0a20 2020 2020 2020 2020 2020  ent].           
-0002c020: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0002c030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c040: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-0002c050: 2020 2020 2020 6966 2066 6f72 6365 206f        if force o
-0002c060: 7220 7473 2e77 686f 5f77 616e 7473 203d  r ts.who_wants =
-0002c070: 3d20 7b63 737d 3a20 2023 206e 6f20 6f6e  = {cs}:  # no on
-0002c080: 6520 656c 7365 2077 616e 7473 2074 6869  e else wants thi
-0002c090: 7320 6b65 790a 2020 2020 2020 2020 2020  s key.          
-0002c0a0: 2020 2020 2020 6966 2074 732e 6465 7065        if ts.depe
-0002c0b0: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
-0002c0c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002c0d0: 2e73 7469 6d75 6c75 735f 6361 6e63 656c  .stimulus_cancel
-0002c0e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002c0f0: 2020 2020 2020 2020 2020 5b64 7473 2e6b            [dts.k
-0002c100: 6579 2066 6f72 2064 7473 2069 6e20 7473  ey for dts in ts
-0002c110: 2e64 6570 656e 6465 6e74 735d 2c20 636c  .dependents], cl
-0002c120: 6965 6e74 2c20 666f 7263 653d 666f 7263  ient, force=forc
-0002c130: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0002c140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002c150: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0002c160: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
-0002c170: 616e 6365 6c73 206b 6579 2025 732e 2020  ancels key %s.  
-0002c180: 466f 7263 653d 2573 222c 206b 6579 2c20  Force=%s", key, 
-0002c190: 666f 7263 6529 0a20 2020 2020 2020 2020  force).         
-0002c1a0: 2020 2020 2020 2063 616e 6365 6c6c 6564         cancelled
-0002c1b0: 5f6b 6579 732e 6170 7065 6e64 286b 6579  _keys.append(key
-0002c1c0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0002c1d0: 6965 6e74 732e 6578 7465 6e64 286c 6973  ients.extend(lis
-0002c1e0: 7428 7473 2e77 686f 5f77 616e 7473 2920  t(ts.who_wants) 
-0002c1f0: 6966 2066 6f72 6365 2065 6c73 6520 5b63  if force else [c
-0002c200: 735d 290a 2020 2020 2020 2020 666f 7220  s]).        for 
-0002c210: 6373 2069 6e20 636c 6965 6e74 733a 0a20  cs in clients:. 
-0002c220: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002c230: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
-0002c240: 6b65 7973 280a 2020 2020 2020 2020 2020  keys(.          
-0002c250: 2020 2020 2020 6b65 7973 3d63 616e 6365        keys=cance
-0002c260: 6c6c 6564 5f6b 6579 732c 0a20 2020 2020  lled_keys,.     
-0002c270: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0002c280: 743d 6373 2e63 6c69 656e 745f 6b65 792c  t=cs.client_key,
-0002c290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c2a0: 2073 7469 6d75 6c75 735f 6964 3d66 2263   stimulus_id=f"c
-0002c2b0: 616e 6365 6c2d 6b65 792d 7b74 696d 6528  ancel-key-{time(
-0002c2c0: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
-0002c2d0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0002c2e0: 7265 706f 7274 287b 226f 7022 3a20 2263  report({"op": "c
-0002c2f0: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
-0002c300: 226b 6579 7322 3a20 6361 6e63 656c 6c65  "keys": cancelle
-0002c310: 645f 6b65 7973 7d29 0a0a 2020 2020 6465  d_keys})..    de
-0002c320: 6620 636c 6965 6e74 5f64 6573 6972 6573  f client_desires
-0002c330: 5f6b 6579 7328 7365 6c66 2c20 6b65 7973  _keys(self, keys
-0002c340: 3d4e 6f6e 652c 2063 6c69 656e 743d 4e6f  =None, client=No
-0002c350: 6e65 293a 0a20 2020 2020 2020 2063 733a  ne):.        cs:
-0002c360: 2043 6c69 656e 7453 7461 7465 203d 2073   ClientState = s
-0002c370: 656c 662e 636c 6965 6e74 732e 6765 7428  elf.clients.get(
-0002c380: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
-0002c390: 6966 2063 7320 6973 204e 6f6e 653a 0a20  if cs is None:. 
-0002c3a0: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
-0002c3b0: 2070 7562 6c69 7368 2c20 7175 6575 6573   publish, queues
-0002c3c0: 2065 7463 2e0a 2020 2020 2020 2020 2020   etc..          
-0002c3d0: 2020 7365 6c66 2e63 6c69 656e 7473 5b63    self.clients[c
-0002c3e0: 6c69 656e 745d 203d 2063 7320 3d20 436c  lient] = cs = Cl
-0002c3f0: 6965 6e74 5374 6174 6528 636c 6965 6e74  ientState(client
-0002c400: 290a 2020 2020 2020 2020 666f 7220 6b20  ).        for k 
-0002c410: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-0002c420: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-0002c430: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
-0002c440: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-0002c450: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0002c460: 2020 2020 2020 2023 2046 6f72 2070 7562         # For pub
-0002c470: 6c69 7368 2c20 7175 6575 6573 2065 7463  lish, queues etc
-0002c480: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002c490: 2020 7473 203d 2073 656c 662e 6e65 775f    ts = self.new_
-0002c4a0: 7461 736b 286b 2c20 4e6f 6e65 2c20 2272  task(k, None, "r
-0002c4b0: 656c 6561 7365 6422 290a 2020 2020 2020  eleased").      
-0002c4c0: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
-0002c4d0: 7473 2e61 6464 2863 7329 0a20 2020 2020  ts.add(cs).     
-0002c4e0: 2020 2020 2020 2063 732e 7761 6e74 735f         cs.wants_
-0002c4f0: 7768 6174 2e61 6464 2874 7329 0a0a 2020  what.add(ts)..  
-0002c500: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-0002c510: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
-0002c520: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
-0002c530: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0002c540: 6c66 2e72 6570 6f72 745f 6f6e 5f6b 6579  lf.report_on_key
-0002c550: 2874 733d 7473 2c20 636c 6965 6e74 3d63  (ts=ts, client=c
-0002c560: 6c69 656e 7429 0a0a 2020 2020 6465 6620  lient)..    def 
-0002c570: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
-0002c580: 6b65 7973 2873 656c 662c 206b 6579 733d  keys(self, keys=
-0002c590: 4e6f 6e65 2c20 636c 6965 6e74 3d4e 6f6e  None, client=Non
-0002c5a0: 652c 2073 7469 6d75 6c75 735f 6964 3d4e  e, stimulus_id=N
-0002c5b0: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
-0002c5c0: 2252 656d 6f76 6520 6b65 7973 2066 726f  "Remove keys fro
-0002c5d0: 6d20 636c 6965 6e74 2064 6573 6972 6564  m client desired
-0002c5e0: 206c 6973 7422 2222 0a20 2020 2020 2020   list""".       
-0002c5f0: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
-0002c600: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
-0002c610: 636c 6965 6e74 2d72 656c 6561 7365 732d  client-releases-
-0002c620: 6b65 7973 2d7b 7469 6d65 2829 7d22 0a20  keys-{time()}". 
-0002c630: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0002c640: 696e 7374 616e 6365 286b 6579 732c 206c  instance(keys, l
-0002c650: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
-0002c660: 2020 6b65 7973 203d 206c 6973 7428 6b65    keys = list(ke
-0002c670: 7973 290a 2020 2020 2020 2020 6373 203d  ys).        cs =
-0002c680: 2073 656c 662e 636c 6965 6e74 735b 636c   self.clients[cl
-0002c690: 6965 6e74 5d0a 2020 2020 2020 2020 7265  ient].        re
-0002c6a0: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-0002c6b0: 6563 7320 3d20 7b7d 0a0a 2020 2020 2020  ecs = {}..      
-0002c6c0: 2020 7365 6c66 2e5f 636c 6965 6e74 5f72    self._client_r
-0002c6d0: 656c 6561 7365 735f 6b65 7973 286b 6579  eleases_keys(key
-0002c6e0: 733d 6b65 7973 2c20 6373 3d63 732c 2072  s=keys, cs=cs, r
-0002c6f0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3d72  ecommendations=r
-0002c700: 6563 6f6d 6d65 6e64 6174 696f 6e73 290a  ecommendations).
-0002c710: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-0002c720: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
-0002c730: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
-0002c740: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
-0002c750: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
-0002c760: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
-0002c770: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
-0002c780: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-0002c790: 0a20 2020 2064 6566 2063 6c69 656e 745f  .    def client_
-0002c7a0: 6865 6172 7462 6561 7428 7365 6c66 2c20  heartbeat(self, 
-0002c7b0: 636c 6965 6e74 3d4e 6f6e 6529 3a0a 2020  client=None):.  
-0002c7c0: 2020 2020 2020 2222 2248 616e 646c 6520        """Handle 
-0002c7d0: 6865 6172 7462 6561 7473 2066 726f 6d20  heartbeats from 
-0002c7e0: 436c 6965 6e74 2222 220a 2020 2020 2020  Client""".      
-0002c7f0: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
-0002c800: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
-0002c810: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
-0002c820: 2063 732e 6c61 7374 5f73 6565 6e20 3d20   cs.last_seen = 
-0002c830: 7469 6d65 2829 0a0a 2020 2020 2323 2323  time()..    ####
-0002c840: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0002c850: 2020 2020 2320 5461 736b 2056 616c 6964      # Task Valid
-0002c860: 6174 696f 6e20 230a 2020 2020 2323 2323  ation #.    ####
-0002c870: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0002c880: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
-0002c890: 655f 7265 6c65 6173 6564 2873 656c 662c  e_released(self,
-0002c8a0: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
-0002c8b0: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
-0002c8c0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
-0002c8d0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0002c8e0: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
-0002c8f0: 6174 6520 3d3d 2022 7265 6c65 6173 6564  ate == "released
-0002c900: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0002c910: 206e 6f74 2074 732e 7761 6974 6572 730a   not ts.waiters.
-0002c920: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0002c930: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-0002c940: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002c950: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-0002c960: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002c970: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-0002c980: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0002c990: 7420 6e6f 7420 616e 7928 5b74 7320 696e  t not any([ts in
-0002c9a0: 2064 7473 2e77 6169 7465 7273 2066 6f72   dts.waiters for
-0002c9b0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0002c9c0: 6465 6e63 6965 735d 290a 2020 2020 2020  dencies]).      
-0002c9d0: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-0002c9e0: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
-0002c9f0: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
-0002ca00: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
-0002ca10: 2e71 7565 7565 640a 0a20 2020 2064 6566  .queued..    def
-0002ca20: 2076 616c 6964 6174 655f 7761 6974 696e   validate_waitin
-0002ca30: 6728 7365 6c66 2c20 6b65 793a 2073 7472  g(self, key: str
-0002ca40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002ca50: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-0002ca60: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-0002ca70: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
-0002ca80: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-0002ca90: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0002caa0: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-0002cab0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002cac0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-0002cad0: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
-0002cae0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-0002caf0: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
-0002cb00: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002cb10: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-0002cb20: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0002cb30: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0002cb40: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002cb50: 2320 5765 2061 7265 2077 6169 7469 6e67  # We are waiting
-0002cb60: 206f 6e20 6120 6465 7065 6e64 656e 6379   on a dependency
-0002cb70: 2069 6666 2069 7427 7320 6e6f 7420 7374   iff it's not st
-0002cb80: 6f72 6564 0a20 2020 2020 2020 2020 2020  ored.           
-0002cb90: 2061 7373 6572 7420 626f 6f6c 2864 7473   assert bool(dts
-0002cba0: 2e77 686f 5f68 6173 2920 213d 2028 6474  .who_has) != (dt
-0002cbb0: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
-0002cbc0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-0002cbd0: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
-0002cbe0: 2e77 6169 7465 7273 2020 2320 5858 5820  .waiters  # XXX 
-0002cbf0: 6576 656e 2069 6620 6474 732e 5f77 686f  even if dts._who
-0002cc00: 5f68 6173 3f0a 0a20 2020 2064 6566 2076  _has?..    def v
-0002cc10: 616c 6964 6174 655f 7175 6575 6564 2873  alidate_queued(s
-0002cc20: 656c 662c 206b 6579 3a20 7374 7229 202d  elf, key: str) -
-0002cc30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002cc40: 7473 3a20 5461 736b 5374 6174 6520 3d20  ts: TaskState = 
-0002cc50: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-0002cc60: 2020 2020 2020 2020 6474 733a 2054 6173          dts: Tas
-0002cc70: 6b53 7461 7465 0a20 2020 2020 2020 2061  kState.        a
-0002cc80: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
-0002cc90: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
-0002cca0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002ccb0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-0002ccc0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-0002ccd0: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
-0002cce0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-0002ccf0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-0002cd00: 2020 2061 7373 6572 7420 6e6f 7420 280a     assert not (.
-0002cd10: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
-0002cd20: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
-0002cd30: 6e73 206f 7220 7473 2e68 6f73 745f 7265  ns or ts.host_re
-0002cd40: 7374 7269 6374 696f 6e73 206f 7220 7473  strictions or ts
-0002cd50: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
-0002cd60: 6374 696f 6e73 0a20 2020 2020 2020 2029  ctions.        )
-0002cd70: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
-0002cd80: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-0002cd90: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-0002cda0: 2061 7373 6572 7420 6474 732e 7768 6f5f   assert dts.who_
-0002cdb0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-0002cdc0: 6173 7365 7274 2074 7320 696e 2064 7473  assert ts in dts
-0002cdd0: 2e77 6169 7465 7273 0a0a 2020 2020 6465  .waiters..    de
-0002cde0: 6620 7661 6c69 6461 7465 5f70 726f 6365  f validate_proce
-0002cdf0: 7373 696e 6728 7365 6c66 2c20 6b65 793a  ssing(self, key:
-0002ce00: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-0002ce10: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
-0002ce20: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
-0002ce30: 735b 6b65 795d 0a20 2020 2020 2020 2064  s[key].        d
-0002ce40: 7473 3a20 5461 736b 5374 6174 650a 2020  ts: TaskState.  
-0002ce50: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002ce60: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
-0002ce70: 2020 2020 2020 2077 7320 3d20 7473 2e70         ws = ts.p
-0002ce80: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-0002ce90: 2020 2020 2061 7373 6572 7420 7773 0a20       assert ws. 
-0002cea0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0002ceb0: 2069 6e20 7773 2e70 726f 6365 7373 696e   in ws.processin
-0002cec0: 670a 2020 2020 2020 2020 6173 7365 7274  g.        assert
-0002ced0: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
-0002cee0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002cef0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
-0002cf00: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
-0002cf10: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0002cf20: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-0002cf30: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
-0002cf40: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-0002cf50: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-0002cf60: 2064 7473 2e77 6169 7465 7273 0a0a 2020   dts.waiters..  
-0002cf70: 2020 6465 6620 7661 6c69 6461 7465 5f6d    def validate_m
-0002cf80: 656d 6f72 7928 7365 6c66 2c20 6b65 793a  emory(self, key:
-0002cf90: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-0002cfa0: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
-0002cfb0: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
-0002cfc0: 735b 6b65 795d 0a20 2020 2020 2020 2064  s[key].        d
-0002cfd0: 7473 3a20 5461 736b 5374 6174 650a 2020  ts: TaskState.  
-0002cfe0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-0002cff0: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-0002d000: 6173 7365 7274 2062 6f6f 6c28 7473 2069  assert bool(ts i
-0002d010: 6e20 7365 6c66 2e72 6570 6c69 6361 7465  n self.replicate
-0002d020: 645f 7461 736b 7329 203d 3d20 286c 656e  d_tasks) == (len
-0002d030: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
-0002d040: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0002d050: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-0002d060: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0002d070: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-0002d080: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002d090: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-0002d0a0: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-0002d0b0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002d0c0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
-0002d0d0: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
-0002d0e0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0002d0f0: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-0002d100: 2020 2061 7373 6572 7420 2864 7473 2069     assert (dts i
-0002d110: 6e20 7473 2e77 6169 7465 7273 2920 3d3d  n ts.waiters) ==
-0002d120: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0002d130: 2020 2064 7473 2e73 7461 7465 2069 6e20     dts.state in 
-0002d140: 2822 7761 6974 696e 6722 2c20 2271 7565  ("waiting", "que
-0002d150: 7565 6422 2c20 2270 726f 6365 7373 696e  ued", "processin
-0002d160: 6722 2c20 226e 6f2d 776f 726b 6572 2229  g", "no-worker")
-0002d170: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002d180: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002d190: 7420 7473 206e 6f74 2069 6e20 6474 732e  t ts not in dts.
-0002d1a0: 7761 6974 696e 675f 6f6e 0a0a 2020 2020  waiting_on..    
-0002d1b0: 6465 6620 7661 6c69 6461 7465 5f6e 6f5f  def validate_no_
-0002d1c0: 776f 726b 6572 2873 656c 662c 206b 6579  worker(self, key
-0002d1d0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-0002d1e0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
-0002d1f0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
-0002d200: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-0002d210: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
-0002d220: 662e 756e 7275 6e6e 6162 6c65 0a20 2020  f.unrunnable.   
-0002d230: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002d240: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-0002d250: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002d260: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
-0002d270: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
-0002d280: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-0002d290: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-0002d2a0: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-0002d2b0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-0002d2c0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-0002d2d0: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
-0002d2e0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-0002d2f0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-0002d300: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002d310: 2064 7473 2e77 686f 5f68 6173 0a0a 2020   dts.who_has..  
-0002d320: 2020 6465 6620 7661 6c69 6461 7465 5f65    def validate_e
-0002d330: 7272 6564 2873 656c 662c 206b 6579 3a20  rred(self, key: 
-0002d340: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-0002d350: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
-0002d360: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
-0002d370: 5b6b 6579 5d0a 2020 2020 2020 2020 6173  [key].        as
-0002d380: 7365 7274 2074 732e 6578 6365 7074 696f  sert ts.exceptio
-0002d390: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
-0002d3a0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-0002d3b0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-0002d3c0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002d3d0: 656c 662e 7175 6575 6564 0a0a 2020 2020  elf.queued..    
-0002d3e0: 6465 6620 7661 6c69 6461 7465 5f6b 6579  def validate_key
-0002d3f0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-0002d400: 2074 733a 2054 6173 6b53 7461 7465 207c   ts: TaskState |
-0002d410: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-0002d420: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-0002d430: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002d440: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
-0002d450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002d460: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-0002d470: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0002d480: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
-0002d490: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002d4a0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0002d4b0: 224b 6579 206c 6f73 743a 2025 7322 2c20  "Key lost: %s", 
-0002d4c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0002d4d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002d4e0: 2020 2020 2020 2074 732e 7661 6c69 6461         ts.valida
-0002d4f0: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
-0002d500: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002d510: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-0002d520: 6e63 203d 2067 6574 6174 7472 2873 656c  nc = getattr(sel
-0002d530: 662c 2022 7661 6c69 6461 7465 5f22 202b  f, "validate_" +
-0002d540: 2074 732e 7374 6174 652e 7265 706c 6163   ts.state.replac
-0002d550: 6528 222d 222c 2022 5f22 2929 0a20 2020  e("-", "_")).   
-0002d560: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0002d570: 6570 7420 4174 7472 6962 7574 6545 7272  ept AttributeErr
-0002d580: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0002d590: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-0002d5a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0002d5b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0002d5c0: 656c 662e 7661 6c69 6461 7465 5f25 7320  elf.validate_%s 
-0002d5d0: 6e6f 7420 666f 756e 6422 2c20 7473 2e73  not found", ts.s
-0002d5e0: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
-0002d5f0: 2c20 225f 2229 0a20 2020 2020 2020 2020  , "_").         
-0002d600: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002d610: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002d620: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002d630: 2020 2020 2020 2066 756e 6328 6b65 7929         func(key)
-0002d640: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0002d650: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0002d660: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002d670: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
-0002d680: 2020 2020 2020 2020 2020 2020 6966 204c              if L
-0002d690: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
-0002d6a0: 2020 2020 2020 2020 696d 706f 7274 2070          import p
-0002d6b0: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
-0002d6c0: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
-0002d6d0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0002d6e0: 7261 6973 650a 0a20 2020 2064 6566 2076  raise..    def v
-0002d6f0: 616c 6964 6174 655f 7374 6174 6528 7365  alidate_state(se
-0002d700: 6c66 2c20 616c 6c6f 775f 6f76 6572 6c61  lf, allow_overla
-0002d710: 703a 2062 6f6f 6c20 3d20 4661 6c73 6529  p: bool = False)
-0002d720: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002d730: 2020 7661 6c69 6461 7465 5f73 7461 7465    validate_state
-0002d740: 2873 656c 662e 7461 736b 732c 2073 656c  (self.tasks, sel
-0002d750: 662e 776f 726b 6572 732c 2073 656c 662e  f.workers, self.
-0002d760: 636c 6965 6e74 7329 0a0a 2020 2020 2020  clients)..      
-0002d770: 2020 6966 206e 6f74 2028 7365 7428 7365    if not (set(se
-0002d780: 6c66 2e77 6f72 6b65 7273 2920 3d3d 2073  lf.workers) == s
-0002d790: 6574 2873 656c 662e 7374 7265 616d 5f63  et(self.stream_c
-0002d7a0: 6f6d 6d73 2929 3a0a 2020 2020 2020 2020  omms)):.        
-0002d7b0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0002d7c0: 7272 6f72 2822 576f 726b 6572 7320 6e6f  rror("Workers no
-0002d7d0: 7420 7468 6520 7361 6d65 2069 6e20 616c  t the same in al
-0002d7e0: 6c20 636f 6c6c 6563 7469 6f6e 7322 290a  l collections").
-0002d7f0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d800: 7365 6c66 2e72 756e 6e69 6e67 2e69 7373  self.running.iss
-0002d810: 7570 6572 7365 7428 7365 6c66 2e69 646c  uperset(self.idl
-0002d820: 652e 7661 6c75 6573 2829 292c 2028 0a20  e.values()), (. 
-0002d830: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002d840: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
-0002d850: 2020 2020 2020 2020 2020 2020 7365 7428              set(
-0002d860: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
-0002d870: 2829 292c 0a20 2020 2020 2020 2029 0a20  ()),.        ). 
-0002d880: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
-0002d890: 6c66 2e72 756e 6e69 6e67 2e69 7373 7570  lf.running.issup
-0002d8a0: 6572 7365 7428 7365 6c66 2e69 646c 655f  erset(self.idle_
-0002d8b0: 7461 736b 5f63 6f75 6e74 292c 2028 0a20  task_count), (. 
-0002d8c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002d8d0: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
-0002d8e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002d8f0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-0002d900: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-0002d910: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-0002d920: 7420 7365 6c66 2e72 756e 6e69 6e67 2e69  t self.running.i
-0002d930: 7373 7570 6572 7365 7428 7365 6c66 2e73  ssuperset(self.s
-0002d940: 6174 7572 6174 6564 292c 2028 0a20 2020  aturated), (.   
-0002d950: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
-0002d960: 6e6e 696e 672e 636f 7079 2829 2c0a 2020  nning.copy(),.  
-0002d970: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0002d980: 6174 7572 6174 6564 2e63 6f70 7928 292c  aturated.copy(),
-0002d990: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0002d9a0: 2020 2061 7373 6572 7420 7365 6c66 2e73     assert self.s
-0002d9b0: 6174 7572 6174 6564 2e69 7364 6973 6a6f  aturated.isdisjo
-0002d9c0: 696e 7428 7365 6c66 2e69 646c 652e 7661  int(self.idle.va
-0002d9d0: 6c75 6573 2829 292c 2028 0a20 2020 2020  lues()), (.     
-0002d9e0: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
-0002d9f0: 7261 7465 642e 636f 7079 2829 2c0a 2020  rated.copy(),.  
-0002da00: 2020 2020 2020 2020 2020 7365 7428 7365            set(se
-0002da10: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
-0002da20: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0002da30: 2020 2020 2020 7461 736b 5f70 7265 6669        task_prefi
-0002da40: 785f 636f 756e 7473 3a20 6465 6661 756c  x_counts: defaul
-0002da50: 7464 6963 745b 7374 722c 2069 6e74 5d20  tdict[str, int] 
-0002da60: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
-0002da70: 7429 0a20 2020 2020 2020 2066 6f72 2077  t).        for w
-0002da80: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
-0002da90: 6b65 7273 2e69 7465 6d73 2829 3a0a 2020  kers.items():.  
-0002daa0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002dab0: 2069 7369 6e73 7461 6e63 6528 772c 2073   isinstance(w, s
-0002dac0: 7472 292c 2028 7479 7065 2877 292c 2077  tr), (type(w), w
-0002dad0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-0002dae0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0002daf0: 7773 2c20 576f 726b 6572 5374 6174 6529  ws, WorkerState)
-0002db00: 2c20 2874 7970 6528 7773 292c 2077 7329  , (type(ws), ws)
-0002db10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002db20: 6572 7420 7773 2e61 6464 7265 7373 203d  ert ws.address =
-0002db30: 3d20 770a 0a20 2020 2020 2020 2020 2020  = w..           
-0002db40: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
-0002db50: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-0002db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002db70: 2061 7373 6572 7420 7773 2069 6e20 7365   assert ws in se
-0002db80: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
-0002db90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002dba0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002dbb0: 6572 7420 7773 206e 6f74 2069 6e20 7365  ert ws not in se
-0002dbc0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
-0002dbd0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002dbe0: 7420 7773 2e61 6464 7265 7373 206e 6f74  t ws.address not
-0002dbf0: 2069 6e20 7365 6c66 2e69 646c 650a 2020   in self.idle.  
-0002dc00: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0002dc10: 7365 7274 2077 7320 6e6f 7420 696e 2073  sert ws not in s
-0002dc20: 656c 662e 7361 7475 7261 7465 640a 0a20  elf.saturated.. 
-0002dc30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002dc40: 7420 7773 2e6c 6f6e 675f 7275 6e6e 696e  t ws.long_runnin
-0002dc50: 672e 6973 7375 6273 6574 2877 732e 7072  g.issubset(ws.pr
-0002dc60: 6f63 6573 7369 6e67 290a 2020 2020 2020  ocessing).      
-0002dc70: 2020 2020 2020 6966 206e 6f74 2077 732e        if not ws.
-0002dc80: 7072 6f63 6573 7369 6e67 3a0a 2020 2020  processing:.    
-0002dc90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002dca0: 7274 206e 6f74 2077 732e 6f63 6375 7061  rt not ws.occupa
-0002dcb0: 6e63 790a 2020 2020 2020 2020 2020 2020  ncy.            
-0002dcc0: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-0002dcd0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-0002dce0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-0002dcf0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002dd00: 732e 6164 6472 6573 7320 696e 2073 656c  s.address in sel
-0002dd10: 662e 6964 6c65 0a20 2020 2020 2020 2020  f.idle.         
-0002dd20: 2020 2061 7373 6572 7420 6e6f 7420 7773     assert not ws
-0002dd30: 2e6e 6565 6473 5f77 6861 742e 6b65 7973  .needs_what.keys
-0002dd40: 2829 2026 2077 732e 6861 735f 7768 6174  () & ws.has_what
-0002dd50: 0a20 2020 2020 2020 2020 2020 2061 6374  .            act
-0002dd60: 7561 6c5f 6e65 6564 735f 7768 6174 3a20  ual_needs_what: 
-0002dd70: 6465 6661 756c 7464 6963 745b 5461 736b  defaultdict[Task
-0002dd80: 5374 6174 652c 2069 6e74 5d20 3d20 6465  State, int] = de
-0002dd90: 6661 756c 7464 6963 7428 696e 7429 0a20  faultdict(int). 
-0002dda0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0002ddb0: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
-0002ddc0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-0002ddd0: 2020 2020 666f 7220 7473 7320 696e 2074      for tss in t
-0002dde0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+00028070: 2020 2074 732e 7265 7472 6965 7320 3d20     ts.retries = 
+00028080: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00028090: 2020 7473 2e61 6e6e 6f74 6174 696f 6e73    ts.annotations
+000280a0: 203d 206f 7574 0a20 2020 2020 2020 2072   = out.        r
+000280b0: 6574 7572 6e20 6469 6374 2872 6573 6f6c  eturn dict(resol
+000280c0: 7665 645f 616e 6e6f 7461 7469 6f6e 7329  ved_annotations)
+000280d0: 0a0a 2020 2020 6465 6620 5f73 6574 5f70  ..    def _set_p
+000280e0: 7269 6f72 6974 6965 7328 0a20 2020 2020  riorities(.     
+000280f0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00028100: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00028110: 7479 3a20 6469 6374 5b73 7472 2c20 696e  ty: dict[str, in
+00028120: 745d 207c 204e 6f6e 652c 0a20 2020 2020  t] | None,.     
+00028130: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
+00028140: 736b 3a20 7374 7220 7c20 4e6f 6e65 2c0a  sk: str | None,.
+00028150: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
+00028160: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
+00028170: 745b 7374 722c 2069 6e74 5d2c 0a20 2020  t[str, int],.   
+00028180: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
+00028190: 743a 2069 6e74 207c 2066 6c6f 6174 207c  t: int | float |
+000281a0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+000281b0: 6172 743a 2066 6c6f 6174 2c0a 2020 2020  art: float,.    
+000281c0: 2020 2020 6473 6b3a 2064 6963 742c 0a20      dsk: dict,. 
+000281d0: 2020 2020 2020 2074 6173 6b73 3a20 6c69         tasks: li
+000281e0: 7374 5b54 6173 6b53 7461 7465 5d2c 0a20  st[TaskState],. 
+000281f0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+00028200: 6965 733a 2064 6963 742c 0a20 2020 2029  ies: dict,.    )
+00028210: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00028220: 2020 6669 666f 5f74 696d 656f 7574 203d    fifo_timeout =
+00028230: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+00028240: 2866 6966 6f5f 7469 6d65 6f75 7429 0a20  (fifo_timeout). 
+00028250: 2020 2020 2020 2069 6620 7375 626d 6974         if submit
+00028260: 7469 6e67 5f74 6173 6b3a 2020 2320 7375  ting_task:  # su
+00028270: 622d 7461 736b 7320 6765 7420 6265 7474  b-tasks get bett
+00028280: 6572 2070 7269 6f72 6974 7920 7468 616e  er priority than
+00028290: 2070 6172 656e 7420 7461 736b 730a 2020   parent tasks.  
+000282a0: 2020 2020 2020 2020 2020 7374 7320 3d20            sts = 
+000282b0: 7365 6c66 2e74 6173 6b73 2e67 6574 2873  self.tasks.get(s
+000282c0: 7562 6d69 7474 696e 675f 7461 736b 290a  ubmitting_task).
+000282d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000282e0: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
+000282f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028300: 6173 7365 7274 2073 7473 2e70 7269 6f72  assert sts.prior
+00028310: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
+00028320: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
+00028330: 2073 7473 2e70 7269 6f72 6974 795b 305d   sts.priority[0]
+00028340: 202d 2030 2e30 310a 2020 2020 2020 2020   - 0.01.        
+00028350: 2020 2020 656c 7365 3a20 2023 2073 7570      else:  # sup
+00028360: 6572 2d74 6173 6b20 616c 7265 6164 7920  er-task already 
+00028370: 636c 6561 6e65 6420 7570 0a20 2020 2020  cleaned up.     
+00028380: 2020 2020 2020 2020 2020 2067 656e 6572             gener
+00028390: 6174 696f 6e20 3d20 7365 6c66 2e67 656e  ation = self.gen
+000283a0: 6572 6174 696f 6e0a 2020 2020 2020 2020  eration.        
+000283b0: 656c 6966 2073 656c 662e 5f6c 6173 745f  elif self._last_
+000283c0: 7469 6d65 202b 2066 6966 6f5f 7469 6d65  time + fifo_time
+000283d0: 6f75 7420 3c20 7374 6172 743a 0a20 2020  out < start:.   
+000283e0: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+000283f0: 6e65 7261 7469 6f6e 202b 3d20 3120 2023  neration += 1  #
+00028400: 206f 6c64 6572 2067 7261 7068 2067 656e   older graph gen
+00028410: 6572 6174 696f 6e73 2074 616b 6520 7072  erations take pr
+00028420: 6563 6564 656e 6365 0a20 2020 2020 2020  ecedence.       
+00028430: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
+00028440: 3d20 7365 6c66 2e67 656e 6572 6174 696f  = self.generatio
+00028450: 6e0a 2020 2020 2020 2020 2020 2020 7365  n.            se
+00028460: 6c66 2e5f 6c61 7374 5f74 696d 6520 3d20  lf._last_time = 
+00028470: 7374 6172 740a 2020 2020 2020 2020 656c  start.        el
+00028480: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00028490: 6765 6e65 7261 7469 6f6e 203d 2073 656c  generation = sel
+000284a0: 662e 6765 6e65 7261 7469 6f6e 0a0a 2020  f.generation..  
+000284b0: 2020 2020 2020 6966 2069 6e74 6572 6e61        if interna
+000284c0: 6c5f 7072 696f 7269 7479 2069 7320 4e6f  l_priority is No
+000284d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000284e0: 2320 5265 6d6f 7669 6e67 2061 6c6c 206e  # Removing all n
+000284f0: 6f6e 2d6c 6f63 616c 206b 6579 7320 6265  on-local keys be
+00028500: 666f 7265 2063 616c 6c69 6e67 206f 7264  fore calling ord
+00028510: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+00028520: 2064 736b 5f6b 6579 7320 3d20 7365 7428   dsk_keys = set(
+00028530: 6473 6b29 2020 2320 696e 7465 7273 6563  dsk)  # intersec
+00028540: 7469 6f6e 2829 206f 6620 7365 7473 2069  tion() of sets i
+00028550: 7320 6d75 6368 2066 6173 7465 7220 7468  s much faster th
+00028560: 616e 2064 6963 745f 6b65 7973 0a20 2020  an dict_keys.   
+00028570: 2020 2020 2020 2020 2073 7472 6970 7065           strippe
+00028580: 645f 6465 7073 203d 207b 0a20 2020 2020  d_deps = {.     
+00028590: 2020 2020 2020 2020 2020 206b 3a20 762e             k: v.
+000285a0: 696e 7465 7273 6563 7469 6f6e 2864 736b  intersection(dsk
+000285b0: 5f6b 6579 7329 0a20 2020 2020 2020 2020  _keys).         
+000285c0: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+000285d0: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
+000285e0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+000285f0: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
+00028600: 6473 6b5f 6b65 7973 0a20 2020 2020 2020  dsk_keys.       
+00028610: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00028620: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
+00028630: 7269 7479 203d 2064 6173 6b2e 6f72 6465  rity = dask.orde
+00028640: 722e 6f72 6465 7228 6473 6b2c 2064 6570  r.order(dsk, dep
+00028650: 656e 6465 6e63 6965 733d 7374 7269 7070  endencies=stripp
+00028660: 6564 5f64 6570 7329 0a0a 2020 2020 2020  ed_deps)..      
+00028670: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
+00028680: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+00028690: 204e 6f74 653a 2055 6e64 6572 2077 6869   Note: Under whi
+000286a0: 6368 2063 6972 6375 6d73 7461 6e63 6573  ch circumstances
+000286b0: 2077 6f75 6c64 2061 2074 6173 6b20 6e6f   would a task no
+000286c0: 7420 6861 7665 2061 0a20 2020 2020 2020  t have a.       
+000286d0: 2020 2020 2023 2070 7269 6f72 6974 6979       # prioritiy
+000286e0: 2061 7373 6967 6e65 6420 6279 206e 6f77   assigned by now
+000286f0: 3f20 4172 6520 7468 6573 6520 7363 6174  ? Are these scat
+00028700: 7465 7265 6420 7461 736b 730a 2020 2020  tered tasks.    
+00028710: 2020 2020 2020 2020 2320 6578 636c 7573          # exclus
+00028720: 6976 656c 7920 6f72 2073 6f6d 6574 6869  ively or somethi
+00028730: 6e67 2065 6c73 653f 0a20 2020 2020 2020  ng else?.       
+00028740: 2020 2020 2074 6173 6b5f 7573 6572 5f70       task_user_p
+00028750: 7269 6f20 3d20 7573 6572 5f70 7269 6f72  rio = user_prior
+00028760: 6974 790a 2020 2020 2020 2020 2020 2020  ity.            
+00028770: 6966 2069 7369 6e73 7461 6e63 6528 7573  if isinstance(us
+00028780: 6572 5f70 7269 6f72 6974 792c 2064 6963  er_priority, dic
+00028790: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+000287a0: 2020 2020 7461 736b 5f75 7365 725f 7072      task_user_pr
+000287b0: 696f 203d 2075 7365 725f 7072 696f 7269  io = user_priori
+000287c0: 7479 2e67 6574 2874 732e 6b65 792c 2030  ty.get(ts.key, 0
+000287d0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
+000287e0: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
+000287f0: 732e 616e 6e6f 7461 7469 6f6e 732e 6765  s.annotations.ge
+00028800: 7428 2270 7269 6f72 6974 7922 2c20 7b7d  t("priority", {}
+00028810: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00028820: 206e 6f74 2061 6e6e 6f74 6174 6564 5f70   not annotated_p
+00028830: 7269 6f3a 0a20 2020 2020 2020 2020 2020  rio:.           
+00028840: 2020 2020 2061 6e6e 6f74 6174 6564 5f70       annotated_p
+00028850: 7269 6f20 3d20 7461 736b 5f75 7365 725f  rio = task_user_
+00028860: 7072 696f 0a0a 2020 2020 2020 2020 2020  prio..          
+00028870: 2020 6966 206e 6f74 2074 732e 7072 696f    if not ts.prio
+00028880: 7269 7479 2061 6e64 2074 732e 6b65 7920  rity and ts.key 
+00028890: 696e 2069 6e74 6572 6e61 6c5f 7072 696f  in internal_prio
+000288a0: 7269 7479 3a0a 2020 2020 2020 2020 2020  rity:.          
+000288b0: 2020 2020 2020 7473 2e70 7269 6f72 6974        ts.priorit
+000288c0: 7920 3d20 280a 2020 2020 2020 2020 2020  y = (.          
+000288d0: 2020 2020 2020 2020 2020 2d61 6e6e 6f74            -annot
+000288e0: 6174 6564 5f70 7269 6f2c 0a20 2020 2020  ated_prio,.     
+000288f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00028900: 656e 6572 6174 696f 6e2c 0a20 2020 2020  eneration,.     
+00028910: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00028920: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
+00028930: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
+00028940: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00028950: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00028960: 2e76 616c 6964 6174 6520 616e 6420 7473  .validate and ts
+00028970: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
+00028980: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00028990: 7420 6973 696e 7374 616e 6365 2874 732e  t isinstance(ts.
+000289a0: 7072 696f 7269 7479 2c20 7475 706c 6529  priority, tuple)
+000289b0: 2061 6e64 2061 6c6c 280a 2020 2020 2020   and all(.      
+000289c0: 2020 2020 2020 2020 2020 2020 2020 6973                is
+000289d0: 696e 7374 616e 6365 2865 6c2c 2028 696e  instance(el, (in
+000289e0: 742c 2066 6c6f 6174 2929 2066 6f72 2065  t, float)) for e
+000289f0: 6c20 696e 2074 732e 7072 696f 7269 7479  l in ts.priority
+00028a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028a10: 2029 0a0a 2020 2020 6465 6620 5f70 6f70   )..    def _pop
+00028a20: 5f6c 6f73 745f 7461 736b 7328 0a20 2020  _lost_tasks(.   
+00028a30: 2020 2020 2073 656c 662c 2064 736b 3a20       self, dsk: 
+00028a40: 6469 6374 2c20 6465 7065 6e64 656e 6369  dict, dependenci
+00028a50: 6573 3a20 6469 6374 2c20 6b65 7973 3a20  es: dict, keys: 
+00028a60: 7365 745b 7374 725d 0a20 2020 2029 202d  set[str].    ) -
+00028a70: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
+00028a80: 2020 2020 6e20 3d20 300a 2020 2020 2020      n = 0.      
+00028a90: 2020 6f75 7420 3d20 7365 7428 290a 2020    out = set().  
+00028aa0: 2020 2020 2020 7768 696c 6520 6c65 6e28        while len(
+00028ab0: 6473 6b29 2021 3d20 6e3a 2020 2320 7761  dsk) != n:  # wa
+00028ac0: 6c6b 2074 6872 6f75 6768 206e 6577 2074  lk through new t
+00028ad0: 6173 6b73 2c20 6361 6e63 656c 2061 6e79  asks, cancel any
+00028ae0: 2062 6164 2064 6570 730a 2020 2020 2020   bad deps.      
+00028af0: 2020 2020 2020 6e20 3d20 6c65 6e28 6473        n = len(ds
+00028b00: 6b29 0a20 2020 2020 2020 2020 2020 2066  k).            f
+00028b10: 6f72 206b 2c20 6465 7073 2069 6e20 6c69  or k, deps in li
+00028b20: 7374 2864 6570 656e 6465 6e63 6965 732e  st(dependencies.
+00028b30: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
+00028b40: 2020 2020 2020 2020 2020 6966 2061 6e79            if any
+00028b50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00028b60: 2020 2020 2020 6465 7020 6e6f 7420 696e        dep not in
+00028b70: 2073 656c 662e 7461 736b 7320 616e 6420   self.tasks and 
+00028b80: 6465 7020 6e6f 7420 696e 2064 736b 2066  dep not in dsk f
+00028b90: 6f72 2064 6570 2069 6e20 6465 7073 0a20  or dep in deps. 
+00028ba0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00028bb0: 3a20 2023 2062 6164 206b 6579 0a20 2020  :  # bad key.   
+00028bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028bd0: 206f 7574 2e61 6464 286b 290a 2020 2020   out.add(k).    
+00028be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028bf0: 6c6f 6767 6572 2e69 6e66 6f28 2255 7365  logger.info("Use
+00028c00: 7220 6173 6b65 6420 666f 7220 636f 6d70  r asked for comp
+00028c10: 7574 6174 696f 6e20 6f6e 206c 6f73 7420  utation on lost 
+00028c20: 6461 7461 2c20 2573 222c 206b 290a 2020  data, %s", k).  
+00028c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c40: 2020 6465 6c20 6473 6b5b 6b5d 0a20 2020    del dsk[k].   
+00028c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c60: 2064 656c 2064 6570 656e 6465 6e63 6965   del dependencie
+00028c70: 735b 6b5d 0a20 2020 2020 2020 2020 2020  s[k].           
+00028c80: 2020 2020 2020 2020 2069 6620 6b20 696e           if k in
+00028c90: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
+00028ca0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00028cb0: 6579 732e 7265 6d6f 7665 286b 290a 2020  eys.remove(k).  
+00028cc0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
+00028cd0: 0a0a 2020 2020 6465 6620 5f70 6f70 5f6b  ..    def _pop_k
+00028ce0: 6e6f 776e 5f74 6173 6b73 2873 656c 662c  nown_tasks(self,
+00028cf0: 2064 736b 3a20 6469 6374 2c20 6465 7065   dsk: dict, depe
+00028d00: 6e64 656e 6369 6573 3a20 6469 6374 2920  ndencies: dict) 
+00028d10: 2d3e 2073 6574 5b73 7472 5d3a 0a20 2020  -> set[str]:.   
+00028d20: 2020 2020 2023 2041 766f 6964 2063 6f6d       # Avoid com
+00028d30: 7075 7461 7469 6f6e 2074 6861 7420 6973  putation that is
+00028d40: 2061 6c72 6561 6479 2066 696e 6973 6865   already finishe
+00028d50: 640a 2020 2020 2020 2020 616c 7265 6164  d.        alread
+00028d60: 795f 696e 5f6d 656d 6f72 7920 3d20 7365  y_in_memory = se
+00028d70: 7428 2920 2023 2074 6173 6b73 2074 6861  t()  # tasks tha
+00028d80: 7420 6172 6520 616c 7265 6164 7920 646f  t are already do
+00028d90: 6e65 0a20 2020 2020 2020 2066 6f72 206b  ne.        for k
+00028da0: 2c20 7620 696e 2064 6570 656e 6465 6e63  , v in dependenc
+00028db0: 6965 732e 6974 656d 7328 293a 0a20 2020  ies.items():.   
+00028dc0: 2020 2020 2020 2020 2069 6620 7620 616e           if v an
+00028dd0: 6420 6b20 696e 2073 656c 662e 7461 736b  d k in self.task
+00028de0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00028df0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00028e00: 6b73 5b6b 5d0a 2020 2020 2020 2020 2020  ks[k].          
+00028e10: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
+00028e20: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
+00028e30: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
+00028e40: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00028e50: 7265 6164 795f 696e 5f6d 656d 6f72 792e  ready_in_memory.
+00028e60: 6164 6428 6b29 0a0a 2020 2020 2020 2020  add(k)..        
+00028e70: 646f 6e65 203d 2073 6574 2861 6c72 6561  done = set(alrea
+00028e80: 6479 5f69 6e5f 6d65 6d6f 7279 290a 2020  dy_in_memory).  
+00028e90: 2020 2020 2020 6966 2061 6c72 6561 6479        if already
+00028ea0: 5f69 6e5f 6d65 6d6f 7279 3a0a 2020 2020  _in_memory:.    
+00028eb0: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+00028ec0: 7473 203d 2064 6173 6b2e 636f 7265 2e72  ts = dask.core.r
+00028ed0: 6576 6572 7365 5f64 6963 7428 6465 7065  everse_dict(depe
+00028ee0: 6e64 656e 6369 6573 290a 2020 2020 2020  ndencies).      
+00028ef0: 2020 2020 2020 7374 6163 6b20 3d20 6c69        stack = li
+00028f00: 7374 2861 6c72 6561 6479 5f69 6e5f 6d65  st(already_in_me
+00028f10: 6d6f 7279 290a 2020 2020 2020 2020 2020  mory).          
+00028f20: 2020 7768 696c 6520 7374 6163 6b3a 2020    while stack:  
+00028f30: 2320 7265 6d6f 7665 2075 6e6e 6563 6573  # remove unneces
+00028f40: 7361 7279 2064 6570 656e 6465 6e63 6965  sary dependencie
+00028f50: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00028f60: 2020 6b65 7920 3d20 7374 6163 6b2e 706f    key = stack.po
+00028f70: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
+00028f80: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00028f90: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+00028fa0: 7320 3d20 6465 7065 6e64 656e 6369 6573  s = dependencies
+00028fb0: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
+00028fc0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+00028fd0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00028fe0: 2020 2020 2020 2020 2020 2064 6570 7320             deps 
+00028ff0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00029000: 5d2e 6465 7065 6e64 656e 6369 6573 0a20  ].dependencies. 
+00029010: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00029020: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
+00029030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029040: 2020 2020 6966 2064 6570 2069 6e20 6465      if dep in de
+00029050: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+00029060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029070: 2020 6368 696c 645f 6465 7073 203d 2064    child_deps = d
+00029080: 6570 656e 6465 6e74 735b 6465 705d 0a20  ependents[dep]. 
+00029090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290a0: 2020 2065 6c69 6620 6465 7020 696e 2073     elif dep in s
+000290b0: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
+000290c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290d0: 2020 2063 6869 6c64 5f64 6570 7320 3d20     child_deps = 
+000290e0: 7365 6c66 2e74 6173 6b73 5b64 6570 5d2e  self.tasks[dep].
+000290f0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+00029100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029110: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00029120: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00029130: 6869 6c64 5f64 6570 7320 3d20 7365 7428  hild_deps = set(
+00029140: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00029150: 2020 2020 2020 6966 2061 6c6c 2864 2069        if all(d i
+00029160: 6e20 646f 6e65 2066 6f72 2064 2069 6e20  n done for d in 
+00029170: 6368 696c 645f 6465 7073 293a 0a20 2020  child_deps):.   
+00029180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029190: 2020 2020 2069 6620 6465 7020 696e 2073       if dep in s
+000291a0: 656c 662e 7461 736b 7320 616e 6420 6465  elf.tasks and de
+000291b0: 7020 6e6f 7420 696e 2064 6f6e 653a 0a20  p not in done:. 
+000291c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291d0: 2020 2020 2020 2020 2020 2064 6f6e 652e             done.
+000291e0: 6164 6428 6465 7029 0a20 2020 2020 2020  add(dep).       
+000291f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029200: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
+00029210: 6428 6465 7029 0a20 2020 2020 2020 2066  d(dep).        f
+00029220: 6f72 2061 6e63 2069 6e20 646f 6e65 3a0a  or anc in done:.
+00029230: 2020 2020 2020 2020 2020 2020 6473 6b2e              dsk.
+00029240: 706f 7028 616e 632c 204e 6f6e 6529 0a20  pop(anc, None). 
+00029250: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00029260: 6465 6e63 6965 732e 706f 7028 616e 632c  dencies.pop(anc,
+00029270: 204e 6f6e 6529 0a20 2020 2020 2020 2072   None).        r
+00029280: 6574 7572 6e20 646f 6e65 0a0a 2020 2020  eturn done..    
+00029290: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+000292a0: 2020 6465 6620 6d61 7465 7269 616c 697a    def materializ
+000292b0: 655f 6772 6170 6828 686c 673a 2048 6967  e_graph(hlg: Hig
+000292c0: 684c 6576 656c 4772 6170 6829 202d 3e20  hLevelGraph) -> 
+000292d0: 7475 706c 655b 6469 6374 2c20 6469 6374  tuple[dict, dict
+000292e0: 2c20 6469 6374 2c20 6469 6374 5d3a 0a20  , dict, dict]:. 
+000292f0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
+00029300: 7269 6275 7465 642e 776f 726b 6572 2069  ributed.worker i
+00029310: 6d70 6f72 7420 6475 6d70 735f 7461 736b  mport dumps_task
+00029320: 0a0a 2020 2020 2020 2020 6b65 795f 616e  ..        key_an
+00029330: 6e6f 7461 7469 6f6e 7320 3d20 7b7d 0a20  notations = {}. 
+00029340: 2020 2020 2020 2064 736b 203d 2064 6173         dsk = das
+00029350: 6b2e 7574 696c 732e 656e 7375 7265 5f64  k.utils.ensure_d
+00029360: 6963 7428 686c 6729 0a0a 2020 2020 2020  ict(hlg)..      
+00029370: 2020 666f 7220 6c61 7965 7220 696e 2068    for layer in h
+00029380: 6c67 2e6c 6179 6572 732e 7661 6c75 6573  lg.layers.values
+00029390: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000293a0: 6966 206c 6179 6572 2e61 6e6e 6f74 6174  if layer.annotat
+000293b0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+000293c0: 2020 2020 2020 616e 6e6f 7420 3d20 6c61        annot = la
+000293d0: 7965 722e 616e 6e6f 7461 7469 6f6e 730a  yer.annotations.
+000293e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293f0: 6b65 795f 616e 6e6f 7461 7469 6f6e 732e  key_annotations.
+00029400: 7570 6461 7465 287b 7374 7269 6e67 6966  update({stringif
+00029410: 7928 6b29 3a20 616e 6e6f 7420 666f 7220  y(k): annot for 
+00029420: 6b20 696e 206c 6179 6572 7d29 0a0a 2020  k in layer})..  
+00029430: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+00029440: 6573 2c20 5f20 3d20 6765 745f 6465 7073  es, _ = get_deps
+00029450: 2864 736b 290a 0a20 2020 2020 2020 2023  (dsk)..        #
+00029460: 2052 656d 6f76 6520 6046 7574 7572 6560   Remove `Future`
+00029470: 206f 626a 6563 7473 2066 726f 6d20 6772   objects from gr
+00029480: 6170 6820 616e 6420 6e6f 7465 2061 6e79  aph and note any
+00029490: 2066 7574 7572 6520 6465 7065 6e64 656e   future dependen
+000294a0: 6369 6573 0a20 2020 2020 2020 2064 736b  cies.        dsk
+000294b0: 3220 3d20 7b7d 0a20 2020 2020 2020 2066  2 = {}.        f
+000294c0: 7574 5f64 6570 7320 3d20 7b7d 0a20 2020  ut_deps = {}.   
+000294d0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+000294e0: 2064 736b 2e69 7465 6d73 2829 3a0a 2020   dsk.items():.  
+000294f0: 2020 2020 2020 2020 2020 6473 6b32 5b6b            dsk2[k
+00029500: 5d2c 2066 7574 7320 3d20 756e 7061 636b  ], futs = unpack
+00029510: 5f72 656d 6f74 6564 6174 6128 762c 2062  _remotedata(v, b
+00029520: 7974 655f 6b65 7973 3d54 7275 6529 0a20  yte_keys=True). 
+00029530: 2020 2020 2020 2020 2020 2069 6620 6675             if fu
+00029540: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00029550: 2020 2020 6675 745f 6465 7073 5b6b 5d20      fut_deps[k] 
+00029560: 3d20 6675 7473 0a20 2020 2020 2020 2064  = futs.        d
+00029570: 736b 203d 2064 736b 320a 0a20 2020 2020  sk = dsk2..     
+00029580: 2020 2023 202d 2041 6464 2069 6e20 6465     # - Add in de
+00029590: 7073 2066 6f72 2061 6e79 2074 6173 6b73  ps for any tasks
+000295a0: 2074 6861 7420 6465 7065 6e64 206f 6e20   that depend on 
+000295b0: 6675 7475 7265 730a 2020 2020 2020 2020  futures.        
+000295c0: 666f 7220 6b2c 2066 7574 7572 6573 2069  for k, futures i
+000295d0: 6e20 6675 745f 6465 7073 2e69 7465 6d73  n fut_deps.items
+000295e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000295f0: 6465 7065 6e64 656e 6369 6573 5b6b 5d2e  dependencies[k].
+00029600: 7570 6461 7465 2866 2e6b 6579 2066 6f72  update(f.key for
+00029610: 2066 2069 6e20 6675 7475 7265 7329 0a20   f in futures). 
+00029620: 2020 2020 2020 206e 6577 5f64 736b 203d         new_dsk =
+00029630: 207b 7d0a 2020 2020 2020 2020 2320 416e   {}.        # An
+00029640: 6e6f 7461 7469 6f6e 2063 616c 6c61 626c  notation callabl
+00029650: 6573 2061 7265 2065 7661 6c75 6174 6564  es are evaluated
+00029660: 206f 6e20 7468 6520 6e6f 6e2d 7374 7269   on the non-stri
+00029670: 6e67 6966 6965 6420 7665 7273 696f 6e20  ngified version 
+00029680: 6f66 0a20 2020 2020 2020 2023 2074 6865  of.        # the
+00029690: 206b 6579 730a 2020 2020 2020 2020 7072   keys.        pr
+000296a0: 655f 7374 7269 6e67 6966 6965 645f 6b65  e_stringified_ke
+000296b0: 7973 203d 207b 7d0a 2020 2020 2020 2020  ys = {}.        
+000296c0: 6578 636c 7573 6976 6520 3d20 7365 7428  exclusive = set(
+000296d0: 686c 6729 0a20 2020 2020 2020 2066 6f72  hlg).        for
+000296e0: 206b 2c20 7620 696e 2064 736b 2e69 7465   k, v in dsk.ite
+000296f0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00029700: 2020 6e65 775f 6b20 3d20 7374 7269 6e67    new_k = string
+00029710: 6966 7928 6b29 0a20 2020 2020 2020 2020  ify(k).         
+00029720: 2020 2070 7265 5f73 7472 696e 6769 6669     pre_stringifi
+00029730: 6564 5f6b 6579 735b 6e65 775f 6b5d 203d  ed_keys[new_k] =
+00029740: 206b 0a20 2020 2020 2020 2020 2020 206e   k.            n
+00029750: 6577 5f64 736b 5b6e 6577 5f6b 5d20 3d20  ew_dsk[new_k] = 
+00029760: 7374 7269 6e67 6966 7928 762c 2065 7863  stringify(v, exc
+00029770: 6c75 7369 7665 3d65 7863 6c75 7369 7665  lusive=exclusive
+00029780: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00029790: 206c 656e 286e 6577 5f64 736b 2920 3d3d   len(new_dsk) ==
+000297a0: 206c 656e 2870 7265 5f73 7472 696e 6769   len(pre_stringi
+000297b0: 6669 6564 5f6b 6579 7329 0a20 2020 2020  fied_keys).     
+000297c0: 2020 2064 736b 203d 206e 6577 5f64 736b     dsk = new_dsk
+000297d0: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
+000297e0: 6e63 6965 7320 3d20 7b0a 2020 2020 2020  ncies = {.      
+000297f0: 2020 2020 2020 7374 7269 6e67 6966 7928        stringify(
+00029800: 6b29 3a20 7b73 7472 696e 6769 6679 2864  k): {stringify(d
+00029810: 6570 2920 666f 7220 6465 7020 696e 2064  ep) for dep in d
+00029820: 6570 737d 0a20 2020 2020 2020 2020 2020  eps}.           
+00029830: 2066 6f72 206b 2c20 6465 7073 2069 6e20   for k, deps in 
+00029840: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
+00029850: 6d73 2829 0a20 2020 2020 2020 207d 0a0a  ms().        }..
+00029860: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+00029870: 2061 6e79 2073 656c 662d 6465 7065 6e64   any self-depend
+00029880: 656e 6369 6573 2028 6861 7070 656e 7320  encies (happens 
+00029890: 6f6e 2074 6573 745f 7075 626c 6973 685f  on test_publish_
+000298a0: 6261 6728 2920 616e 6420 6f74 6865 7273  bag() and others
+000298b0: 290a 2020 2020 2020 2020 666f 7220 6b2c  ).        for k,
+000298c0: 2076 2069 6e20 6465 7065 6e64 656e 6369   v in dependenci
+000298d0: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
+000298e0: 2020 2020 2020 2020 6465 7073 203d 2073          deps = s
+000298f0: 6574 2876 290a 2020 2020 2020 2020 2020  et(v).          
+00029900: 2020 6966 206b 2069 6e20 6465 7073 3a0a    if k in deps:.
+00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029920: 6465 7073 2e72 656d 6f76 6528 6b29 0a20  deps.remove(k). 
+00029930: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00029940: 6465 6e63 6965 735b 6b5d 203d 2064 6570  dencies[k] = dep
+00029950: 730a 0a20 2020 2020 2020 2023 2052 656d  s..        # Rem
+00029960: 6f76 6520 616c 6961 7365 730a 2020 2020  ove aliases.    
+00029970: 2020 2020 666f 7220 6b20 696e 206c 6973      for k in lis
+00029980: 7428 6473 6b29 3a0a 2020 2020 2020 2020  t(dsk):.        
+00029990: 2020 2020 6966 2064 736b 5b6b 5d20 6973      if dsk[k] is
+000299a0: 206b 3a0a 2020 2020 2020 2020 2020 2020   k:.            
+000299b0: 2020 2020 6465 6c20 6473 6b5b 6b5d 0a20      del dsk[k]. 
+000299c0: 2020 2020 2020 2064 736b 203d 2076 616c         dsk = val
+000299d0: 6d61 7028 6475 6d70 735f 7461 736b 2c20  map(dumps_task, 
+000299e0: 6473 6b29 0a20 2020 2020 2020 2072 6574  dsk).        ret
+000299f0: 7572 6e20 6473 6b2c 2064 6570 656e 6465  urn dsk, depende
+00029a00: 6e63 6965 732c 206b 6579 5f61 6e6e 6f74  ncies, key_annot
+00029a10: 6174 696f 6e73 2c20 7072 655f 7374 7269  ations, pre_stri
+00029a20: 6e67 6966 6965 645f 6b65 7973 0a0a 2020  ngified_keys..  
+00029a30: 2020 6465 6620 7374 696d 756c 7573 5f71    def stimulus_q
+00029a40: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
+00029a50: 5f6f 7065 6e65 6428 7365 6c66 2c20 2a2c  _opened(self, *,
+00029a60: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00029a70: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+00029a80: 2020 2020 2222 2252 6573 706f 6e64 2074      """Respond t
+00029a90: 6f20 616e 2065 7665 6e74 2077 6869 6368  o an event which
+00029aa0: 206d 6179 2068 6176 6520 6f70 656e 6564   may have opened
+00029ab0: 2073 706f 7473 206f 6e20 776f 726b 6572   spots on worker
+00029ac0: 2074 6872 6561 6470 6f6f 6c73 0a0a 2020   threadpools..  
+00029ad0: 2020 2020 2020 5365 6c65 6374 7320 7468        Selects th
+00029ae0: 6520 6170 7072 6f70 7269 6174 6520 6e75  e appropriate nu
+00029af0: 6d62 6572 206f 6620 7461 736b 7320 6672  mber of tasks fr
+00029b00: 6f6d 2074 6865 2066 726f 6e74 206f 6620  om the front of 
+00029b10: 7468 6520 7175 6575 6520 6163 636f 7264  the queue accord
+00029b20: 696e 6720 746f 0a20 2020 2020 2020 2074  ing to.        t
+00029b30: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
+00029b40: 6f66 2074 6173 6b20 736c 6f74 7320 6176  of task slots av
+00029b50: 6169 6c61 626c 6520 6f6e 2077 6f72 6b65  ailable on worke
+00029b60: 7273 2028 706f 7465 6e74 6961 6c6c 7920  rs (potentially 
+00029b70: 3029 2c20 616e 640a 2020 2020 2020 2020  0), and.        
+00029b80: 7472 616e 7369 7469 6f6e 7320 7468 656d  transitions them
+00029b90: 2074 6f20 6060 7072 6f63 6573 7369 6e67   to ``processing
+00029ba0: 6060 2e0a 0a20 2020 2020 2020 204e 6f74  ``...        Not
+00029bb0: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
+00029bc0: 0a20 2020 2020 2020 204f 7468 6572 2074  .        Other t
+00029bd0: 7261 6e73 6974 696f 6e73 2072 656c 6174  ransitions relat
+00029be0: 6564 2074 6f20 7468 6973 2073 7469 6d75  ed to this stimu
+00029bf0: 6c75 7320 7368 6f75 6c64 2062 6520 6675  lus should be fu
+00029c00: 6c6c 7920 7072 6f63 6573 7365 6420 6265  lly processed be
+00029c10: 666f 7265 6861 6e64 2c0a 2020 2020 2020  forehand,.      
+00029c20: 2020 736f 2061 6e79 2074 6173 6b73 2074    so any tasks t
+00029c30: 6861 7420 6265 6361 6d65 2072 756e 6e61  hat became runna
+00029c40: 626c 6520 6172 6520 616c 7265 6164 7920  ble are already 
+00029c50: 696e 2060 6070 726f 6365 7373 696e 6760  in ``processing`
+00029c60: 602e 204f 7468 6572 7769 7365 2c0a 2020  `. Otherwise,.  
+00029c70: 2020 2020 2020 6f76 6572 7072 6f64 7563        overproduc
+00029c80: 7469 6f6e 2063 616e 206f 6363 7572 2069  tion can occur i
+00029c90: 6620 7175 6575 6564 2074 6173 6b73 2067  f queued tasks g
+00029ca0: 6574 2073 6368 6564 756c 6564 2062 6566  et scheduled bef
+00029cb0: 6f72 6520 646f 776e 7374 7265 616d 2074  ore downstream t
+00029cc0: 6173 6b73 2e0a 0a20 2020 2020 2020 204d  asks...        M
+00029cd0: 7573 7420 6265 2063 616c 6c65 6420 6166  ust be called af
+00029ce0: 7465 7220 6063 6865 636b 5f69 646c 655f  ter `check_idle_
+00029cf0: 7361 7475 7261 7465 6460 3b20 692e 652e  saturated`; i.e.
+00029d00: 2060 6964 6c65 5f74 6173 6b5f 636f 756e   `idle_task_coun
+00029d10: 7460 206d 7573 7420 6265 2075 700a 2020  t` must be up.  
+00029d20: 2020 2020 2020 746f 2064 6174 652e 0a20        to date.. 
+00029d30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00029d40: 2020 2069 6620 6e6f 7420 7365 6c66 2e71     if not self.q
+00029d50: 7565 7565 643a 0a20 2020 2020 2020 2020  ueued:.         
+00029d60: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00029d70: 2020 736c 6f74 735f 6176 6169 6c61 626c    slots_availabl
+00029d80: 6520 3d20 7375 6d28 0a20 2020 2020 2020  e = sum(.       
+00029d90: 2020 2020 205f 7461 736b 5f73 6c6f 7473       _task_slots
+00029da0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
+00029db0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+00029dc0: 4154 494f 4e29 0a20 2020 2020 2020 2020  ATION).         
+00029dd0: 2020 2066 6f72 2077 7320 696e 2073 656c     for ws in sel
+00029de0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+00029df0: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
+00029e00: 2020 2020 6966 2073 6c6f 7473 5f61 7661      if slots_ava
+00029e10: 696c 6162 6c65 203d 3d20 303a 0a20 2020  ilable == 0:.   
+00029e20: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+00029e30: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00029e40: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00029e50: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+00029e60: 7174 7320 696e 2073 656c 662e 7175 6575  qts in self.queu
+00029e70: 6564 2e70 6565 6b6e 2873 6c6f 7473 5f61  ed.peekn(slots_a
+00029e80: 7661 696c 6162 6c65 293a 0a20 2020 2020  vailable):.     
+00029e90: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00029ea0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00029eb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00029ec0: 7174 732e 7374 6174 6520 3d3d 2022 7175  qts.state == "qu
+00029ed0: 6575 6564 222c 2071 7473 2e73 7461 7465  eued", qts.state
+00029ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029ef0: 2061 7373 6572 7420 6e6f 7420 7174 732e   assert not qts.
+00029f00: 7072 6f63 6573 7369 6e67 5f6f 6e2c 2028  processing_on, (
+00029f10: 7174 732c 2071 7473 2e70 726f 6365 7373  qts, qts.process
+00029f20: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
+00029f30: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00029f40: 6f74 2071 7473 2e77 6169 7469 6e67 5f6f  ot qts.waiting_o
+00029f50: 6e2c 2028 7174 732c 2071 7473 2e70 726f  n, (qts, qts.pro
+00029f60: 6365 7373 696e 675f 6f6e 290a 2020 2020  cessing_on).    
+00029f70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00029f80: 7274 2071 7473 2e77 686f 5f77 616e 7473  rt qts.who_wants
+00029f90: 206f 7220 7174 732e 7761 6974 6572 732c   or qts.waiters,
+00029fa0: 2071 7473 0a20 2020 2020 2020 2020 2020   qts.           
+00029fb0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00029fc0: 5b71 7473 2e6b 6579 5d20 3d20 2270 726f  [qts.key] = "pro
+00029fd0: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
+00029fe0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
+00029ff0: 6e73 2872 6563 6f6d 6d65 6e64 6174 696f  ns(recommendatio
+0002a000: 6e73 2c20 7374 696d 756c 7573 5f69 6429  ns, stimulus_id)
+0002a010: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
+0002a020: 7573 5f74 6173 6b5f 6669 6e69 7368 6564  us_task_finished
+0002a030: 2873 656c 662c 206b 6579 2c20 776f 726b  (self, key, work
+0002a040: 6572 2c20 7374 696d 756c 7573 5f69 642c  er, stimulus_id,
+0002a050: 2072 756e 5f69 642c 202a 2a6b 7761 7267   run_id, **kwarg
+0002a060: 7329 3a0a 2020 2020 2020 2020 2222 224d  s):.        """M
+0002a070: 6172 6b20 7468 6174 2061 2074 6173 6b20  ark that a task 
+0002a080: 6861 7320 6669 6e69 7368 6564 2065 7865  has finished exe
+0002a090: 6375 7469 6f6e 206f 6e20 6120 7061 7274  cution on a part
+0002a0a0: 6963 756c 6172 2077 6f72 6b65 7222 2222  icular worker"""
+0002a0b0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0002a0c0: 6465 6275 6728 2253 7469 6d75 6c75 7320  debug("Stimulus 
+0002a0d0: 7461 736b 2066 696e 6973 6865 6420 2573  task finished %s
+0002a0e0: 5b25 645d 2025 7322 2c20 6b65 792c 2072  [%d] %s", key, r
+0002a0f0: 756e 5f69 642c 2077 6f72 6b65 7229 0a0a  un_id, worker)..
+0002a100: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002a110: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+0002a120: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
+0002a130: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
+0002a140: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
+0002a150: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
+0002a160: 0a0a 2020 2020 2020 2020 7773 3a20 576f  ..        ws: Wo
+0002a170: 726b 6572 5374 6174 6520 3d20 7365 6c66  rkerState = self
+0002a180: 2e77 6f72 6b65 7273 5b77 6f72 6b65 725d  .workers[worker]
+0002a190: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+0002a1a0: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
+0002a1b0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0002a1c0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+0002a1d0: 6e65 206f 7220 7473 2e73 7461 7465 2069  ne or ts.state i
+0002a1e0: 6e20 2822 7265 6c65 6173 6564 222c 2022  n ("released", "
+0002a1f0: 7175 6575 6564 2229 3a0a 2020 2020 2020  queued"):.      
+0002a200: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+0002a210: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0002a220: 2020 2020 2252 6563 6569 7665 6420 616c      "Received al
+0002a230: 7265 6164 7920 636f 6d70 7574 6564 2074  ready computed t
+0002a240: 6173 6b2c 2077 6f72 6b65 723a 2025 732c  ask, worker: %s,
+0002a250: 2073 7461 7465 3a20 2573 220a 2020 2020   state: %s".    
+0002a260: 2020 2020 2020 2020 2020 2020 222c 206b              ", k
+0002a270: 6579 3a20 2573 2c20 7768 6f5f 6861 733a  ey: %s, who_has:
+0002a280: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
+0002a290: 2020 2020 2020 776f 726b 6572 2c0a 2020        worker,.  
+0002a2a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002a2b0: 2e73 7461 7465 2069 6620 7473 2065 6c73  .state if ts els
+0002a2c0: 6520 2266 6f72 676f 7474 656e 222c 0a20  e "forgotten",. 
+0002a2d0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0002a2e0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+0002a2f0: 2020 2020 7473 2e77 686f 5f68 6173 2069      ts.who_has i
+0002a300: 6620 7473 2065 6c73 6520 7b7d 2c0a 2020  f ts else {},.  
+0002a310: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002a320: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+0002a330: 7367 735b 776f 726b 6572 5d20 3d20 5b0a  sgs[worker] = [.
+0002a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a350: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0002a360: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
+0002a370: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
+0002a380: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
+0002a390: 7973 223a 205b 6b65 795d 2c0a 2020 2020  ys": [key],.    
+0002a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a3b0: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
+0002a3c0: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+0002a3d0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0002a3e0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0002a3f0: 2020 2020 656c 6966 2074 732e 7275 6e5f      elif ts.run_
+0002a400: 6964 2021 3d20 7275 6e5f 6964 3a0a 2020  id != run_id:.  
+0002a410: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0002a420: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002a430: 6e20 6f72 2074 732e 7072 6f63 6573 7369  n or ts.processi
+0002a440: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
+0002a450: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
+0002a460: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0002a470: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0002a480: 2020 2020 2020 2020 2020 2022 5265 6365             "Rece
+0002a490: 6976 6564 2073 7461 6c65 2074 6173 6b20  ived stale task 
+0002a4a0: 7275 6e2c 2077 6f72 6b65 723a 2025 732c  run, worker: %s,
+0002a4b0: 206b 6579 3a20 2573 2c20 7275 6e5f 6964   key: %s, run_id
+0002a4c0: 3a20 2564 2028 2564 2922 2c0a 2020 2020  : %d (%d)",.    
+0002a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4e0: 776f 726b 6572 2c0a 2020 2020 2020 2020  worker,.        
+0002a4f0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+0002a500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a510: 2020 2020 2072 756e 5f69 642c 0a20 2020       run_id,.   
+0002a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a530: 2074 732e 7275 6e5f 6964 2c0a 2020 2020   ts.run_id,.    
+0002a540: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002a550: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0002a560: 726b 6572 5f6d 7367 735b 776f 726b 6572  rker_msgs[worker
+0002a570: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
+0002a580: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0002a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5a0: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
+0002a5b0: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
+0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a5d0: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
+0002a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5f0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+0002a600: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+0002a610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a620: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0002a630: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0002a640: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002a650: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0002a660: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
+0002a670: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
+0002a680: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
+0002a690: 2e73 7461 7465 203d 3d20 226d 656d 6f72  .state == "memor
+0002a6a0: 7922 3a0a 2020 2020 2020 2020 2020 2020  y":.            
+0002a6b0: 7365 6c66 2e61 6464 5f6b 6579 7328 776f  self.add_keys(wo
+0002a6c0: 726b 6572 3d77 6f72 6b65 722c 206b 6579  rker=worker, key
+0002a6d0: 733d 5b6b 6579 5d29 0a20 2020 2020 2020  s=[key]).       
+0002a6e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002a6f0: 2020 2074 732e 6d65 7461 6461 7461 2e75     ts.metadata.u
+0002a700: 7064 6174 6528 6b77 6172 6773 5b22 6d65  pdate(kwargs["me
+0002a710: 7461 6461 7461 225d 290a 2020 2020 2020  tadata"]).      
+0002a720: 2020 2020 2020 723a 2074 7570 6c65 203d        r: tuple =
+0002a730: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+0002a740: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0002a750: 2020 206b 6579 2c20 226d 656d 6f72 7922     key, "memory"
+0002a760: 2c20 7374 696d 756c 7573 5f69 642c 2077  , stimulus_id, w
+0002a770: 6f72 6b65 723d 776f 726b 6572 2c20 2a2a  orker=worker, **
+0002a780: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
+0002a790: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002a7a0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0002a7b0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+0002a7c0: 6f72 6b65 725f 6d73 6773 203d 2072 0a0a  orker_msgs = r..
+0002a7d0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0002a7e0: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+0002a7f0: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
+0002a800: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
+0002a810: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
+0002a820: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+0002a830: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+0002a840: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+0002a850: 5f6d 7367 730a 0a20 2020 2064 6566 2073  _msgs..    def s
+0002a860: 7469 6d75 6c75 735f 7461 736b 5f65 7272  timulus_task_err
+0002a870: 6564 280a 2020 2020 2020 2020 7365 6c66  ed(.        self
+0002a880: 2c0a 2020 2020 2020 2020 6b65 793d 4e6f  ,.        key=No
+0002a890: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
+0002a8a0: 6572 3d4e 6f6e 652c 0a20 2020 2020 2020  er=None,.       
+0002a8b0: 2065 7863 6570 7469 6f6e 3d4e 6f6e 652c   exception=None,
+0002a8c0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+0002a8d0: 735f 6964 3d4e 6f6e 652c 0a20 2020 2020  s_id=None,.     
+0002a8e0: 2020 2074 7261 6365 6261 636b 3d4e 6f6e     traceback=Non
+0002a8f0: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+0002a900: 7267 732c 0a20 2020 2029 3a0a 2020 2020  rgs,.    ):.    
+0002a910: 2020 2020 2222 224d 6172 6b20 7468 6174      """Mark that
+0002a920: 2061 2074 6173 6b20 6861 7320 6572 7265   a task has erre
+0002a930: 6420 6f6e 2061 2070 6172 7469 6375 6c61  d on a particula
+0002a940: 7220 776f 726b 6572 2222 220a 2020 2020  r worker""".    
+0002a950: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0002a960: 2822 5374 696d 756c 7573 2074 6173 6b20  ("Stimulus task 
+0002a970: 6572 7265 6420 2573 2c20 2573 222c 206b  erred %s, %s", k
+0002a980: 6579 2c20 776f 726b 6572 290a 0a20 2020  ey, worker)..   
+0002a990: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0002a9a0: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
+0002a9b0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0002a9c0: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
+0002a9d0: 7220 7473 2e73 7461 7465 2021 3d20 2270  r ts.state != "p
+0002a9e0: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
+0002a9f0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0002aa00: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
+0002aa10: 2020 2069 6620 7473 2e72 6574 7269 6573     if ts.retries
+0002aa20: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+0002aa30: 2020 7473 2e72 6574 7269 6573 202d 3d20    ts.retries -= 
+0002aa40: 310a 2020 2020 2020 2020 2020 2020 7265  1.            re
+0002aa50: 7475 726e 2073 656c 662e 5f74 7261 6e73  turn self._trans
+0002aa60: 6974 696f 6e28 6b65 792c 2022 7761 6974  ition(key, "wait
+0002aa70: 696e 6722 2c20 7374 696d 756c 7573 5f69  ing", stimulus_i
+0002aa80: 6429 0a20 2020 2020 2020 2065 6c73 653a  d).        else:
+0002aa90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002aaa0: 7572 6e20 7365 6c66 2e5f 7472 616e 7369  urn self._transi
+0002aab0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0002aac0: 2020 2020 2020 6b65 792c 0a20 2020 2020        key,.     
+0002aad0: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
+0002aae0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0002aaf0: 2020 2020 7374 696d 756c 7573 5f69 642c      stimulus_id,
+0002ab00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ab10: 2063 6175 7365 3d6b 6579 2c0a 2020 2020   cause=key,.    
+0002ab20: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002ab30: 7074 696f 6e3d 6578 6365 7074 696f 6e2c  ption=exception,
+0002ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ab50: 2074 7261 6365 6261 636b 3d74 7261 6365   traceback=trace
+0002ab60: 6261 636b 2c0a 2020 2020 2020 2020 2020  back,.          
+0002ab70: 2020 2020 2020 776f 726b 6572 3d77 6f72        worker=wor
+0002ab80: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+0002ab90: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+0002aba0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0002abb0: 2020 6465 6620 7374 696d 756c 7573 5f72    def stimulus_r
+0002abc0: 6574 7279 2873 656c 662c 206b 6579 732c  etry(self, keys,
+0002abd0: 2063 6c69 656e 743d 4e6f 6e65 293a 0a20   client=None):. 
+0002abe0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0002abf0: 666f 2822 436c 6965 6e74 2025 7320 7265  fo("Client %s re
+0002ac00: 7175 6573 7473 2074 6f20 7265 7472 7920  quests to retry 
+0002ac10: 2564 206b 6579 7322 2c20 636c 6965 6e74  %d keys", client
+0002ac20: 2c20 6c65 6e28 6b65 7973 2929 0a20 2020  , len(keys)).   
+0002ac30: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
+0002ac40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002ac50: 2e6c 6f67 5f65 7665 6e74 2863 6c69 656e  .log_event(clien
+0002ac60: 742c 207b 2261 6374 696f 6e22 3a20 2272  t, {"action": "r
+0002ac70: 6574 7279 222c 2022 636f 756e 7422 3a20  etry", "count": 
+0002ac80: 6c65 6e28 6b65 7973 297d 290a 0a20 2020  len(keys)})..   
+0002ac90: 2020 2020 2073 7461 636b 203d 206c 6973       stack = lis
+0002aca0: 7428 6b65 7973 290a 2020 2020 2020 2020  t(keys).        
+0002acb0: 7365 656e 203d 2073 6574 2829 0a20 2020  seen = set().   
+0002acc0: 2020 2020 2072 6f6f 7473 203d 205b 5d0a       roots = [].
+0002acd0: 2020 2020 2020 2020 7768 696c 6520 7374          while st
+0002ace0: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
+0002acf0: 206b 6579 203d 2073 7461 636b 2e70 6f70   key = stack.pop
+0002ad00: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+0002ad10: 6565 6e2e 6164 6428 6b65 7929 0a20 2020  een.add(key).   
+0002ad20: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+0002ad30: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+0002ad40: 2020 2020 2020 2020 2020 6572 7265 645f            erred_
+0002ad50: 6465 7073 203d 205b 6474 732e 6b65 7920  deps = [dts.key 
+0002ad60: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0002ad70: 7065 6e64 656e 6369 6573 2069 6620 6474  pendencies if dt
+0002ad80: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
+0002ad90: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+0002ada0: 6966 2065 7272 6564 5f64 6570 733a 0a20  if erred_deps:. 
+0002adb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002adc0: 7461 636b 2e65 7874 656e 6428 6572 7265  tack.extend(erre
+0002add0: 645f 6465 7073 290a 2020 2020 2020 2020  d_deps).        
+0002ade0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002adf0: 2020 2020 2020 2020 2020 726f 6f74 732e            roots.
+0002ae00: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
+0002ae10: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0002ae20: 696f 6e73 3a20 5265 6373 203d 207b 6b65  ions: Recs = {ke
+0002ae30: 793a 2022 7761 6974 696e 6722 2066 6f72  y: "waiting" for
+0002ae40: 206b 6579 2069 6e20 726f 6f74 737d 0a20   key in roots}. 
+0002ae50: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+0002ae60: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
+0002ae70: 6461 7469 6f6e 732c 2066 2273 7469 6d75  dations, f"stimu
+0002ae80: 6c75 732d 7265 7472 792d 7b74 696d 6528  lus-retry-{time(
+0002ae90: 297d 2229 0a0a 2020 2020 2020 2020 6966  )}")..        if
+0002aea0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+0002aeb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002aec0: 6b65 7920 696e 2073 6565 6e3a 0a20 2020  key in seen:.   
+0002aed0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002aee0: 6572 7420 6e6f 7420 7365 6c66 2e74 6173  ert not self.tas
+0002aef0: 6b73 5b6b 6579 5d2e 6578 6365 7074 696f  ks[key].exceptio
+0002af00: 6e5f 626c 616d 650a 0a20 2020 2020 2020  n_blame..       
+0002af10: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
+0002af20: 656e 290a 0a20 2020 2064 6566 2063 6c6f  en)..    def clo
+0002af30: 7365 5f77 6f72 6b65 7228 7365 6c66 2c20  se_worker(self, 
+0002af40: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
+0002af50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0002af60: 2241 736b 2061 2077 6f72 6b65 7220 746f  "Ask a worker to
+0002af70: 2073 6875 7420 6974 7365 6c66 2064 6f77   shut itself dow
+0002af80: 6e2e 2044 6f20 6e6f 7420 7761 6974 2066  n. Do not wait f
+0002af90: 6f72 2069 7420 746f 2074 616b 6520 6566  or it to take ef
+0002afa0: 6665 6374 2e0a 2020 2020 2020 2020 4e6f  fect..        No
+0002afb0: 7465 2074 6861 7420 7468 6572 6520 6973  te that there is
+0002afc0: 206e 6f20 6775 6172 616e 7465 6520 7468   no guarantee th
+0002afd0: 6174 2074 6865 2077 6f72 6b65 7220 7769  at the worker wi
+0002afe0: 6c6c 2061 6374 7561 6c6c 7920 6163 6365  ll actually acce
+0002aff0: 7074 2074 6865 0a20 2020 2020 2020 2063  pt the.        c
+0002b000: 6f6d 6d61 6e64 2e0a 0a20 2020 2020 2020  ommand...       
+0002b010: 204e 6f74 6520 7468 6174 203a 6d65 7468   Note that :meth
+0002b020: 3a60 7265 6d6f 7665 5f77 6f72 6b65 7260  :`remove_worker`
+0002b030: 2073 656e 6473 2074 6865 2073 616d 6520   sends the same 
+0002b040: 636f 6d6d 616e 6420 696e 7465 726e 616c  command internal
+0002b050: 6c79 2069 6620 636c 6f73 653d 5472 7565  ly if close=True
+0002b060: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+0002b070: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0002b080: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
+0002b090: 6972 655f 776f 726b 6572 730a 2020 2020  ire_workers.    
+0002b0a0: 2020 2020 7265 6d6f 7665 5f77 6f72 6b65      remove_worke
+0002b0b0: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
+0002b0c0: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
+0002b0d0: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
+0002b0e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0002b0f0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0002b100: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
+0002b110: 6f73 696e 6720 776f 726b 6572 2025 7322  osing worker %s"
+0002b120: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
+0002b130: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+0002b140: 2877 6f72 6b65 722c 207b 2261 6374 696f  (worker, {"actio
+0002b150: 6e22 3a20 2263 6c6f 7365 2d77 6f72 6b65  n": "close-worke
+0002b160: 7222 7d29 0a20 2020 2020 2020 2073 656c  r"}).        sel
+0002b170: 662e 776f 726b 6572 5f73 656e 6428 776f  f.worker_send(wo
+0002b180: 726b 6572 2c20 7b22 6f70 223a 2022 636c  rker, {"op": "cl
+0002b190: 6f73 6522 2c20 2272 6561 736f 6e22 3a20  ose", "reason": 
+0002b1a0: 2273 6368 6564 756c 6572 2d63 6c6f 7365  "scheduler-close
+0002b1b0: 2d77 6f72 6b65 7222 7d29 0a0a 2020 2020  -worker"})..    
+0002b1c0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+0002b1d0: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
+0002b1e0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+0002b1f0: 2073 656c 662c 2061 6464 7265 7373 3a20   self, address: 
+0002b200: 7374 722c 202a 2c20 7374 696d 756c 7573  str, *, stimulus
+0002b210: 5f69 643a 2073 7472 2c20 7361 6665 3a20  _id: str, safe: 
+0002b220: 626f 6f6c 203d 2046 616c 7365 2c20 636c  bool = False, cl
+0002b230: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
+0002b240: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
+0002b250: 6c5b 224f 4b22 2c20 2261 6c72 6561 6479  l["OK", "already
+0002b260: 2d72 656d 6f76 6564 225d 3a0a 2020 2020  -removed"]:.    
+0002b270: 2020 2020 2222 2252 656d 6f76 6520 776f      """Remove wo
+0002b280: 726b 6572 2066 726f 6d20 636c 7573 7465  rker from cluste
+0002b290: 722e 0a0a 2020 2020 2020 2020 5765 2064  r...        We d
+0002b2a0: 6f20 7468 6973 2077 6865 6e20 6120 776f  o this when a wo
+0002b2b0: 726b 6572 2072 6570 6f72 7473 2074 6861  rker reports tha
+0002b2c0: 7420 6974 2070 6c61 6e73 2074 6f20 6c65  t it plans to le
+0002b2d0: 6176 6520 6f72 2077 6865 6e20 6974 2061  ave or when it a
+0002b2e0: 7070 6561 7273 2074 6f20 6265 0a20 2020  ppears to be.   
+0002b2f0: 2020 2020 2075 6e72 6573 706f 6e73 6976       unresponsiv
+0002b300: 652e 2054 6869 7320 6d61 7920 7365 6e64  e. This may send
+0002b310: 2069 7473 2074 6173 6b73 2062 6163 6b20   its tasks back 
+0002b320: 746f 2061 2072 656c 6561 7365 6420 7374  to a released st
+0002b330: 6174 652e 0a0a 2020 2020 2020 2020 5365  ate...        Se
+0002b340: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+0002b350: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0002b360: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
+0002b370: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
+0002b380: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
+0002b390: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0002b3a0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+0002b3b0: 2e63 6c6f 7365 643a 0a20 2020 2020 2020  .closed:.       
+0002b3c0: 2020 2020 2072 6574 7572 6e20 2261 6c72       return "alr
+0002b3d0: 6561 6479 2d72 656d 6f76 6564 220a 0a20  eady-removed".. 
+0002b3e0: 2020 2020 2020 2061 6464 7265 7373 203d         address =
+0002b3f0: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
+0002b400: 7265 7373 2861 6464 7265 7373 290a 0a20  ress(address).. 
+0002b410: 2020 2020 2020 2069 6620 6164 6472 6573         if addres
+0002b420: 7320 6e6f 7420 696e 2073 656c 662e 776f  s not in self.wo
+0002b430: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+0002b440: 2020 2072 6574 7572 6e20 2261 6c72 6561     return "alrea
+0002b450: 6479 2d72 656d 6f76 6564 220a 0a20 2020  dy-removed"..   
+0002b460: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
+0002b470: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
+0002b480: 7265 7373 290a 0a20 2020 2020 2020 2077  ress)..        w
+0002b490: 733a 2057 6f72 6b65 7253 7461 7465 203d  s: WorkerState =
+0002b4a0: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
+0002b4b0: 6472 6573 735d 0a0a 2020 2020 2020 2020  dress]..        
+0002b4c0: 6576 656e 745f 6d73 6720 3d20 7b0a 2020  event_msg = {.  
+0002b4d0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+0002b4e0: 6e22 3a20 2272 656d 6f76 652d 776f 726b  n": "remove-work
+0002b4f0: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
+0002b500: 2022 7072 6f63 6573 7369 6e67 2d74 6173   "processing-tas
+0002b510: 6b73 223a 207b 7473 2e6b 6579 2066 6f72  ks": {ts.key for
+0002b520: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
+0002b530: 7369 6e67 7d2c 0a20 2020 2020 2020 207d  sing},.        }
+0002b540: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0002b550: 675f 6576 656e 7428 6164 6472 6573 732c  g_event(address,
+0002b560: 2065 7665 6e74 5f6d 7367 2e63 6f70 7928   event_msg.copy(
+0002b570: 2929 0a20 2020 2020 2020 2065 7665 6e74  )).        event
+0002b580: 5f6d 7367 5b22 776f 726b 6572 225d 203d  _msg["worker"] =
+0002b590: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+0002b5a0: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+0002b5b0: 2261 6c6c 222c 2065 7665 6e74 5f6d 7367  "all", event_msg
+0002b5c0: 290a 0a20 2020 2020 2020 206c 6f67 6765  )..        logge
+0002b5d0: 722e 696e 666f 2822 5265 6d6f 7665 2077  r.info("Remove w
+0002b5e0: 6f72 6b65 7220 2573 222c 2077 7329 0a20  orker %s", ws). 
+0002b5f0: 2020 2020 2020 2069 6620 636c 6f73 653a         if close:
+0002b600: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+0002b610: 6820 7375 7070 7265 7373 2841 7474 7269  h suppress(Attri
+0002b620: 6275 7465 4572 726f 722c 2043 6f6d 6d43  buteError, CommC
+0002b630: 6c6f 7365 6445 7272 6f72 293a 0a20 2020  losedError):.   
+0002b640: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002b650: 662e 7374 7265 616d 5f63 6f6d 6d73 5b61  f.stream_comms[a
+0002b660: 6464 7265 7373 5d2e 7365 6e64 280a 2020  ddress].send(.  
+0002b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b680: 2020 7b22 6f70 223a 2022 636c 6f73 6522    {"op": "close"
+0002b690: 2c20 2272 6561 736f 6e22 3a20 2273 6368  , "reason": "sch
+0002b6a0: 6564 756c 6572 2d72 656d 6f76 652d 776f  eduler-remove-wo
+0002b6b0: 726b 6572 227d 0a20 2020 2020 2020 2020  rker"}.         
+0002b6c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002b6d0: 2020 7365 6c66 2e72 656d 6f76 655f 7265    self.remove_re
+0002b6e0: 736f 7572 6365 7328 6164 6472 6573 7329  sources(address)
+0002b6f0: 0a0a 2020 2020 2020 2020 6468 3a20 6469  ..        dh: di
+0002b700: 6374 203d 2073 656c 662e 686f 7374 5f69  ct = self.host_i
+0002b710: 6e66 6f5b 686f 7374 5d0a 2020 2020 2020  nfo[host].      
+0002b720: 2020 6468 5f61 6464 7265 7373 6573 3a20    dh_addresses: 
+0002b730: 7365 7420 3d20 6468 5b22 6164 6472 6573  set = dh["addres
+0002b740: 7365 7322 5d0a 2020 2020 2020 2020 6468  ses"].        dh
+0002b750: 5f61 6464 7265 7373 6573 2e72 656d 6f76  _addresses.remov
+0002b760: 6528 6164 6472 6573 7329 0a20 2020 2020  e(address).     
+0002b770: 2020 2064 685b 226e 7468 7265 6164 7322     dh["nthreads"
+0002b780: 5d20 2d3d 2077 732e 6e74 6872 6561 6473  ] -= ws.nthreads
+0002b790: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+0002b7a0: 7461 6c5f 6e74 6872 6561 6473 202d 3d20  tal_nthreads -= 
+0002b7b0: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
+0002b7c0: 2020 2020 6966 206e 6f74 2064 685f 6164      if not dh_ad
+0002b7d0: 6472 6573 7365 733a 0a20 2020 2020 2020  dresses:.       
+0002b7e0: 2020 2020 2064 656c 2073 656c 662e 686f       del self.ho
+0002b7f0: 7374 5f69 6e66 6f5b 686f 7374 5d0a 0a20  st_info[host].. 
+0002b800: 2020 2020 2020 2073 656c 662e 7270 632e         self.rpc.
+0002b810: 7265 6d6f 7665 2861 6464 7265 7373 290a  remove(address).
+0002b820: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+0002b830: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
+0002b840: 6472 6573 735d 0a20 2020 2020 2020 2064  dress].        d
+0002b850: 656c 2073 656c 662e 616c 6961 7365 735b  el self.aliases[
+0002b860: 7773 2e6e 616d 655d 0a20 2020 2020 2020  ws.name].       
+0002b870: 2073 656c 662e 6964 6c65 2e70 6f70 2877   self.idle.pop(w
+0002b880: 732e 6164 6472 6573 732c 204e 6f6e 6529  s.address, None)
+0002b890: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
+0002b8a0: 6c65 5f74 6173 6b5f 636f 756e 742e 6469  le_task_count.di
+0002b8b0: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
+0002b8c0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
+0002b8d0: 2e64 6973 6361 7264 2877 7329 0a20 2020  .discard(ws).   
+0002b8e0: 2020 2020 2064 656c 2073 656c 662e 776f       del self.wo
+0002b8f0: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
+0002b900: 2020 2020 2020 2077 732e 7374 6174 7573         ws.status
+0002b910: 203d 2053 7461 7475 732e 636c 6f73 6564   = Status.closed
+0002b920: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+0002b930: 6e6e 696e 672e 6469 7363 6172 6428 7773  nning.discard(ws
+0002b940: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
+0002b950: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0002b960: 203d 207b 7d0a 0a20 2020 2020 2020 2074   = {}..        t
+0002b970: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
+0002b980: 2020 2020 2066 6f72 2074 7320 696e 206c       for ts in l
+0002b990: 6973 7428 7773 2e70 726f 6365 7373 696e  ist(ws.processin
+0002b9a0: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
+0002b9b0: 6b20 3d20 7473 2e6b 6579 0a20 2020 2020  k = ts.key.     
+0002b9c0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0002b9d0: 6174 696f 6e73 5b6b 5d20 3d20 2272 656c  ations[k] = "rel
+0002b9e0: 6561 7365 6422 0a20 2020 2020 2020 2020  eased".         
+0002b9f0: 2020 2069 6620 6e6f 7420 7361 6665 3a0a     if not safe:.
+0002ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ba10: 7473 2e73 7573 7069 6369 6f75 7320 2b3d  ts.suspicious +=
+0002ba20: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+0002ba30: 2020 2074 732e 7072 6566 6978 2e73 7573     ts.prefix.sus
+0002ba40: 7069 6369 6f75 7320 2b3d 2031 0a20 2020  picious += 1.   
+0002ba50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002ba60: 7473 2e73 7573 7069 6369 6f75 7320 3e20  ts.suspicious > 
+0002ba70: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
+0002ba80: 6c75 7265 733a 0a20 2020 2020 2020 2020  lures:.         
+0002ba90: 2020 2020 2020 2020 2020 2064 656c 2072             del r
+0002baa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+0002bab0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0002bac0: 2020 2020 2020 6520 3d20 7069 636b 6c65        e = pickle
+0002bad0: 2e64 756d 7073 280a 2020 2020 2020 2020  .dumps(.        
+0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002baf0: 4b69 6c6c 6564 576f 726b 6572 280a 2020  KilledWorker(.  
+0002bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb10: 2020 2020 2020 2020 2020 7461 736b 3d6b            task=k
+0002bb20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bb30: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0002bb40: 7374 5f77 6f72 6b65 723d 7773 2e63 6c65  st_worker=ws.cle
+0002bb50: 616e 2829 2c0a 2020 2020 2020 2020 2020  an(),.          
+0002bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb70: 2020 616c 6c6f 7765 645f 6661 696c 7572    allowed_failur
+0002bb80: 6573 3d73 656c 662e 616c 6c6f 7765 645f  es=self.allowed_
+0002bb90: 6661 696c 7572 6573 2c0a 2020 2020 2020  failures,.      
+0002bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbb0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+0002bbc0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002bbe0: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
+0002bbf0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0002bc00: 2020 2020 2020 2020 2020 2020 6b2c 0a20              k,. 
+0002bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc20: 2020 2020 2020 2022 6572 7265 6422 2c0a         "erred",.
+0002bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc40: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0002bc50: 6e3d 652c 0a20 2020 2020 2020 2020 2020  n=e,.           
+0002bc60: 2020 2020 2020 2020 2020 2020 2063 6175               cau
+0002bc70: 7365 3d6b 2c0a 2020 2020 2020 2020 2020  se=k,.          
+0002bc80: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002bc90: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+0002bca0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+0002bcb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0002bcc0: 6f72 6b65 723d 6164 6472 6573 732c 0a20  orker=address,. 
+0002bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bce0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002bcf0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0002bd00: 6e64 6174 696f 6e73 2e75 7064 6174 6528  ndations.update(
+0002bd10: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+0002bd20: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0002bd30: 666f 280a 2020 2020 2020 2020 2020 2020  fo(.            
+0002bd40: 2020 2020 2020 2020 2020 2020 2254 6173              "Tas
+0002bd50: 6b20 2573 206d 6172 6b65 6420 6173 2066  k %s marked as f
+0002bd60: 6169 6c65 6420 6265 6361 7573 6520 2564  ailed because %d
+0002bd70: 2077 6f72 6b65 7273 2064 6965 6422 0a20   workers died". 
+0002bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd90: 2020 2020 2020 2022 2077 6869 6c65 2074         " while t
+0002bda0: 7279 696e 6720 746f 2072 756e 2069 7422  rying to run it"
+0002bdb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bdc0: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
+0002bdd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bde0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+0002bdf0: 6c6c 6f77 6564 5f66 6169 6c75 7265 732c  llowed_failures,
+0002be00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002be20: 666f 7220 7473 2069 6e20 6c69 7374 2877  for ts in list(w
+0002be30: 732e 6861 735f 7768 6174 293a 0a20 2020  s.has_what):.   
+0002be40: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+0002be50: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
+0002be60: 2077 7329 0a20 2020 2020 2020 2020 2020   ws).           
+0002be70: 2069 6620 6e6f 7420 7473 2e77 686f 5f68   if not ts.who_h
+0002be80: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+0002be90: 2020 2020 6966 2074 732e 7275 6e5f 7370      if ts.run_sp
+0002bea0: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
+0002beb0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002bec0: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0002bed0: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0002bee0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0002bef0: 653a 2020 2320 7075 7265 2064 6174 610a  e:  # pure data.
+0002bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf10: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0002bf20: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2266  ons[ts.key] = "f
+0002bf30: 6f72 676f 7474 656e 220a 0a20 2020 2020  orgotten"..     
+0002bf40: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+0002bf50: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+0002bf60: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
+0002bf70: 3d73 7469 6d75 6c75 735f 6964 290a 0a20  =stimulus_id).. 
+0002bf80: 2020 2020 2020 2061 7761 6974 6162 6c65         awaitable
+0002bf90: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+0002bfa0: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
+0002bfb0: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
+0002bfc0: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
+0002bfd0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002bfe0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0002bff0: 7420 3d20 706c 7567 696e 2e72 656d 6f76  t = plugin.remov
+0002c000: 655f 776f 726b 6572 2873 6368 6564 756c  e_worker(schedul
+0002c010: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
+0002c020: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+0002c030: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
+0002c040: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
+0002c050: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
+0002c060: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+0002c070: 6974 6162 6c65 732e 6170 7065 6e64 2872  itables.append(r
+0002c080: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
+0002c090: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0002c0a0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0002c0b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002c0c0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+0002c0d0: 2020 2020 2020 2070 6c75 6769 6e5f 6d73         plugin_ms
+0002c0e0: 6773 203d 2061 7761 6974 2061 7379 6e63  gs = await async
+0002c0f0: 696f 2e67 6174 6865 7228 2a61 7761 6974  io.gather(*await
+0002c100: 6162 6c65 732c 2072 6574 7572 6e5f 6578  ables, return_ex
+0002c110: 6365 7074 696f 6e73 3d54 7275 6529 0a20  ceptions=True). 
+0002c120: 2020 2020 2020 2070 6c75 6769 6e73 5f65         plugins_e
+0002c130: 7863 6570 7469 6f6e 7320 3d20 5b6d 7367  xceptions = [msg
+0002c140: 2066 6f72 206d 7367 2069 6e20 706c 7567   for msg in plug
+0002c150: 696e 5f6d 7367 7320 6966 2069 7369 6e73  in_msgs if isins
+0002c160: 7461 6e63 6528 6d73 672c 2045 7863 6570  tance(msg, Excep
+0002c170: 7469 6f6e 295d 0a20 2020 2020 2020 2066  tion)].        f
+0002c180: 6f72 2065 7863 2069 6e20 706c 7567 696e  or exc in plugin
+0002c190: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
+0002c1a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002c1b0: 2e65 7863 6570 7469 6f6e 2865 7863 2c20  .exception(exc, 
+0002c1c0: 6578 635f 696e 666f 3d65 7863 290a 0a20  exc_info=exc).. 
+0002c1d0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0002c1e0: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
+0002c1f0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0002c200: 6e66 6f28 224c 6f73 7420 616c 6c20 776f  nfo("Lost all wo
+0002c210: 726b 6572 7322 290a 0a20 2020 2020 2020  rkers")..       
+0002c220: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
+0002c230: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+0002c240: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0002c250: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
+0002c260: 6164 6472 6573 732c 2077 292c 204e 6f6e  address, w), Non
+0002c270: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002c280: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
+0002c290: 726b 6572 732e 706f 7028 2877 2c20 6164  rkers.pop((w, ad
+0002c2a0: 6472 6573 7329 2c20 4e6f 6e65 290a 0a20  dress), None).. 
+0002c2b0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+0002c2c0: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
+0002c2d0: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
+0002c2e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002c2f0: 2020 2320 4966 2074 6865 2077 6f72 6b65    # If the worke
+0002c300: 7220 6973 6e27 7420 7265 6769 7374 6572  r isn't register
+0002c310: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
+0002c320: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
+0002c330: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
+0002c340: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
+0002c350: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
+0002c360: 662e 776f 726b 6572 7320 616e 6420 6164  f.workers and ad
+0002c370: 6472 6573 7320 696e 2073 656c 662e 6576  dress in self.ev
+0002c380: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+0002c390: 2020 2020 2020 6465 6c20 7365 6c66 2e65        del self.e
+0002c3a0: 7665 6e74 735b 6164 6472 6573 735d 0a0a  vents[address]..
+0002c3b0: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
+0002c3c0: 6465 6c61 7920 3d20 7061 7273 655f 7469  delay = parse_ti
+0002c3d0: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
+0002c3e0: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
+0002c3f0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0002c400: 642e 7363 6865 6475 6c65 722e 6576 656e  d.scheduler.even
+0002c410: 7473 2d63 6c65 616e 7570 2d64 656c 6179  ts-cleanup-delay
+0002c420: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
+0002c430: 2020 2020 2020 7365 6c66 2e5f 6f6e 676f        self._ongo
+0002c440: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
+0002c450: 6173 6b73 2e63 616c 6c5f 6c61 7465 7228  asks.call_later(
+0002c460: 0a20 2020 2020 2020 2020 2020 2063 6c65  .            cle
+0002c470: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
+0002c480: 7665 5f77 6f72 6b65 725f 6672 6f6d 5f65  ve_worker_from_e
+0002c490: 7665 6e74 730a 2020 2020 2020 2020 290a  vents.        ).
+0002c4a0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0002c4b0: 6562 7567 2822 5265 6d6f 7665 6420 776f  ebug("Removed wo
+0002c4c0: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
+0002c4d0: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0002c4e0: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
+0002c4f0: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
+0002c500: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
+0002c510: 2020 2020 2020 2020 2020 2020 772c 0a20              w,. 
+0002c520: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0002c530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c540: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
+0002c550: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
+0002c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c570: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
+0002c580: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002c590: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0002c5a0: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0002c5b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002c5c0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+0002c5d0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+0002c5e0: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
+0002c5f0: 6620 7374 696d 756c 7573 5f63 616e 6365  f stimulus_cance
+0002c600: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
+0002c610: 206b 6579 733a 2053 6571 7565 6e63 655b   keys: Sequence[
+0002c620: 7374 725d 2c20 636c 6965 6e74 3a20 7374  str], client: st
+0002c630: 722c 2066 6f72 6365 3a20 626f 6f6c 203d  r, force: bool =
+0002c640: 2046 616c 7365 0a20 2020 2029 202d 3e20   False.    ) -> 
+0002c650: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0002c660: 2253 746f 7020 6578 6563 7574 696f 6e20  "Stop execution 
+0002c670: 6f6e 2061 206c 6973 7420 6f66 206b 6579  on a list of key
+0002c680: 7322 2222 0a20 2020 2020 2020 206c 6f67  s""".        log
+0002c690: 6765 722e 696e 666f 2822 436c 6965 6e74  ger.info("Client
+0002c6a0: 2025 7320 7265 7175 6573 7473 2074 6f20   %s requests to 
+0002c6b0: 6361 6e63 656c 2025 6420 6b65 7973 222c  cancel %d keys",
+0002c6c0: 2063 6c69 656e 742c 206c 656e 286b 6579   client, len(key
+0002c6d0: 7329 290a 2020 2020 2020 2020 6966 2063  s)).        if c
+0002c6e0: 6c69 656e 743a 0a20 2020 2020 2020 2020  lient:.         
+0002c6f0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0002c700: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002c710: 2020 2063 6c69 656e 742c 207b 2261 6374     client, {"act
+0002c720: 696f 6e22 3a20 2263 616e 6365 6c22 2c20  ion": "cancel", 
+0002c730: 2263 6f75 6e74 223a 206c 656e 286b 6579  "count": len(key
+0002c740: 7329 2c20 2266 6f72 6365 223a 2066 6f72  s), "force": for
+0002c750: 6365 7d0a 2020 2020 2020 2020 2020 2020  ce}.            
+0002c760: 290a 2020 2020 2020 2020 6361 6e63 656c  ).        cancel
+0002c770: 6c65 645f 6b65 7973 203d 205b 5d0a 2020  led_keys = [].  
+0002c780: 2020 2020 2020 636c 6965 6e74 7320 3d20        clients = 
+0002c790: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
+0002c7a0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
+0002c7b0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0002c7c0: 5374 6174 6520 7c20 4e6f 6e65 203d 2073  State | None = s
+0002c7d0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+0002c7e0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+0002c7f0: 6620 6e6f 7420 7473 3a0a 2020 2020 2020  f not ts:.      
+0002c800: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0002c810: 7565 0a20 2020 2020 2020 2020 2020 2074  ue.            t
+0002c820: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002c830: 2020 2020 6373 3a20 436c 6965 6e74 5374      cs: ClientSt
+0002c840: 6174 6520 3d20 7365 6c66 2e63 6c69 656e  ate = self.clien
+0002c850: 7473 5b63 6c69 656e 745d 0a20 2020 2020  ts[client].     
+0002c860: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+0002c870: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+0002c880: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+0002c890: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+0002c8a0: 6f72 6365 206f 7220 7473 2e77 686f 5f77  orce or ts.who_w
+0002c8b0: 616e 7473 203d 3d20 7b63 737d 3a20 2023  ants == {cs}:  #
+0002c8c0: 206e 6f20 6f6e 6520 656c 7365 2077 616e   no one else wan
+0002c8d0: 7473 2074 6869 7320 6b65 790a 2020 2020  ts this key.    
+0002c8e0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0002c8f0: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
+0002c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c910: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
+0002c920: 6361 6e63 656c 280a 2020 2020 2020 2020  cancel(.        
+0002c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c940: 5b64 7473 2e6b 6579 2066 6f72 2064 7473  [dts.key for dts
+0002c950: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
+0002c960: 735d 2c20 636c 6965 6e74 2c20 666f 7263  s], client, forc
+0002c970: 653d 666f 7263 650a 2020 2020 2020 2020  e=force.        
+0002c980: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002c990: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0002c9a0: 6767 6572 2e69 6e66 6f28 2253 6368 6564  gger.info("Sched
+0002c9b0: 756c 6572 2063 616e 6365 6c73 206b 6579  uler cancels key
+0002c9c0: 2025 732e 2020 466f 7263 653d 2573 222c   %s.  Force=%s",
+0002c9d0: 206b 6579 2c20 666f 7263 6529 0a20 2020   key, force).   
+0002c9e0: 2020 2020 2020 2020 2020 2020 2063 616e               can
+0002c9f0: 6365 6c6c 6564 5f6b 6579 732e 6170 7065  celled_keys.appe
+0002ca00: 6e64 286b 6579 290a 2020 2020 2020 2020  nd(key).        
+0002ca10: 2020 2020 636c 6965 6e74 732e 6578 7465      clients.exte
+0002ca20: 6e64 286c 6973 7428 7473 2e77 686f 5f77  nd(list(ts.who_w
+0002ca30: 616e 7473 2920 6966 2066 6f72 6365 2065  ants) if force e
+0002ca40: 6c73 6520 5b63 735d 290a 2020 2020 2020  lse [cs]).      
+0002ca50: 2020 666f 7220 6373 2069 6e20 636c 6965    for cs in clie
+0002ca60: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0002ca70: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
+0002ca80: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
+0002ca90: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+0002caa0: 3d63 616e 6365 6c6c 6564 5f6b 6579 732c  =cancelled_keys,
+0002cab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cac0: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
+0002cad0: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
+0002cae0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0002caf0: 6964 3d66 2263 616e 6365 6c2d 6b65 792d  id=f"cancel-key-
+0002cb00: 7b74 696d 6528 297d 222c 0a20 2020 2020  {time()}",.     
+0002cb10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002cb20: 2073 656c 662e 7265 706f 7274 287b 226f   self.report({"o
+0002cb30: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
+0002cb40: 6579 7322 2c20 226b 6579 7322 3a20 6361  eys", "keys": ca
+0002cb50: 6e63 656c 6c65 645f 6b65 7973 7d29 0a0a  ncelled_keys})..
+0002cb60: 2020 2020 6465 6620 636c 6965 6e74 5f64      def client_d
+0002cb70: 6573 6972 6573 5f6b 6579 7328 7365 6c66  esires_keys(self
+0002cb80: 2c20 6b65 7973 3d4e 6f6e 652c 2063 6c69  , keys=None, cli
+0002cb90: 656e 743d 4e6f 6e65 293a 0a20 2020 2020  ent=None):.     
+0002cba0: 2020 2063 733a 2043 6c69 656e 7453 7461     cs: ClientSta
+0002cbb0: 7465 203d 2073 656c 662e 636c 6965 6e74  te = self.client
+0002cbc0: 732e 6765 7428 636c 6965 6e74 290a 2020  s.get(client).  
+0002cbd0: 2020 2020 2020 6966 2063 7320 6973 204e        if cs is N
+0002cbe0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002cbf0: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
+0002cc00: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
+0002cc10: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0002cc20: 656e 7473 5b63 6c69 656e 745d 203d 2063  ents[client] = c
+0002cc30: 7320 3d20 436c 6965 6e74 5374 6174 6528  s = ClientState(
+0002cc40: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002cc50: 666f 7220 6b20 696e 206b 6579 733a 0a20  for k in keys:. 
+0002cc60: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0002cc70: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
+0002cc80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002cc90: 2074 7320 6973 204e 6f6e 653a 0a20 2020   ts is None:.   
+0002cca0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
+0002ccb0: 6f72 2070 7562 6c69 7368 2c20 7175 6575  or publish, queu
+0002ccc0: 6573 2065 7463 2e0a 2020 2020 2020 2020  es etc..        
+0002ccd0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+0002cce0: 662e 6e65 775f 7461 736b 286b 2c20 4e6f  f.new_task(k, No
+0002ccf0: 6e65 2c20 2272 656c 6561 7365 6422 290a  ne, "released").
+0002cd00: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+0002cd10: 686f 5f77 616e 7473 2e61 6464 2863 7329  ho_wants.add(cs)
+0002cd20: 0a20 2020 2020 2020 2020 2020 2063 732e  .            cs.
+0002cd30: 7761 6e74 735f 7768 6174 2e61 6464 2874  wants_what.add(t
+0002cd40: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0002cd50: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+0002cd60: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
+0002cd70: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+0002cd80: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
+0002cd90: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
+0002cda0: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+0002cdb0: 2020 6465 6620 636c 6965 6e74 5f72 656c    def client_rel
+0002cdc0: 6561 7365 735f 6b65 7973 2873 656c 662c  eases_keys(self,
+0002cdd0: 206b 6579 733d 4e6f 6e65 2c20 636c 6965   keys=None, clie
+0002cde0: 6e74 3d4e 6f6e 652c 2073 7469 6d75 6c75  nt=None, stimulu
+0002cdf0: 735f 6964 3d4e 6f6e 6529 3a0a 2020 2020  s_id=None):.    
+0002ce00: 2020 2020 2222 2252 656d 6f76 6520 6b65      """Remove ke
+0002ce10: 7973 2066 726f 6d20 636c 6965 6e74 2064  ys from client d
+0002ce20: 6573 6972 6564 206c 6973 7422 2222 0a20  esired list""". 
+0002ce30: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0002ce40: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
+0002ce50: 206f 7220 6622 636c 6965 6e74 2d72 656c   or f"client-rel
+0002ce60: 6561 7365 732d 6b65 7973 2d7b 7469 6d65  eases-keys-{time
+0002ce70: 2829 7d22 0a20 2020 2020 2020 2069 6620  ()}".        if 
+0002ce80: 6e6f 7420 6973 696e 7374 616e 6365 286b  not isinstance(k
+0002ce90: 6579 732c 206c 6973 7429 3a0a 2020 2020  eys, list):.    
+0002cea0: 2020 2020 2020 2020 6b65 7973 203d 206c          keys = l
+0002ceb0: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
+0002cec0: 2020 6373 203d 2073 656c 662e 636c 6965    cs = self.clie
+0002ced0: 6e74 735b 636c 6965 6e74 5d0a 2020 2020  nts[client].    
+0002cee0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0002cef0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
+0002cf00: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+0002cf10: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
+0002cf20: 7973 286b 6579 733d 6b65 7973 2c20 6373  ys(keys=keys, cs
+0002cf30: 3d63 732c 2072 6563 6f6d 6d65 6e64 6174  =cs, recommendat
+0002cf40: 696f 6e73 3d72 6563 6f6d 6d65 6e64 6174  ions=recommendat
+0002cf50: 696f 6e73 290a 2020 2020 2020 2020 7365  ions).        se
+0002cf60: 6c66 2e74 7261 6e73 6974 696f 6e73 2872  lf.transitions(r
+0002cf70: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+0002cf80: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+0002cf90: 2020 2020 2020 7365 6c66 2e73 7469 6d75        self.stimu
+0002cfa0: 6c75 735f 7175 6575 655f 736c 6f74 735f  lus_queue_slots_
+0002cfb0: 6d61 7962 655f 6f70 656e 6564 2873 7469  maybe_opened(sti
+0002cfc0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+0002cfd0: 735f 6964 290a 0a20 2020 2064 6566 2063  s_id)..    def c
+0002cfe0: 6c69 656e 745f 6865 6172 7462 6561 7428  lient_heartbeat(
+0002cff0: 7365 6c66 2c20 636c 6965 6e74 3d4e 6f6e  self, client=Non
+0002d000: 6529 3a0a 2020 2020 2020 2020 2222 2248  e):.        """H
+0002d010: 616e 646c 6520 6865 6172 7462 6561 7473  andle heartbeats
+0002d020: 2066 726f 6d20 436c 6965 6e74 2222 220a   from Client""".
+0002d030: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
+0002d040: 6e74 5374 6174 6520 3d20 7365 6c66 2e63  ntState = self.c
+0002d050: 6c69 656e 7473 5b63 6c69 656e 745d 0a20  lients[client]. 
+0002d060: 2020 2020 2020 2063 732e 6c61 7374 5f73         cs.last_s
+0002d070: 6565 6e20 3d20 7469 6d65 2829 0a0a 2020  een = time()..  
+0002d080: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0002d090: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
+0002d0a0: 2056 616c 6964 6174 696f 6e20 230a 2020   Validation #.  
+0002d0b0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0002d0c0: 2323 2323 230a 0a20 2020 2064 6566 2076  #####..    def v
+0002d0d0: 616c 6964 6174 655f 7265 6c65 6173 6564  alidate_released
+0002d0e0: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
+0002d0f0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002d100: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
+0002d110: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+0002d120: 5d0a 2020 2020 2020 2020 6173 7365 7274  ].        assert
+0002d130: 2074 732e 7374 6174 6520 3d3d 2022 7265   ts.state == "re
+0002d140: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
+0002d150: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+0002d160: 6974 6572 730a 2020 2020 2020 2020 6173  iters.        as
+0002d170: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+0002d180: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+0002d190: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+0002d1a0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+0002d1b0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+0002d1c0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+0002d1d0: 2061 7373 6572 7420 6e6f 7420 616e 7928   assert not any(
+0002d1e0: 5b74 7320 696e 2064 7473 2e77 6169 7465  [ts in dts.waite
+0002d1f0: 7273 2066 6f72 2064 7473 2069 6e20 7473  rs for dts in ts
+0002d200: 2e64 6570 656e 6465 6e63 6965 735d 290a  .dependencies]).
+0002d210: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002d220: 7320 6e6f 7420 696e 2073 656c 662e 756e  s not in self.un
+0002d230: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
+0002d240: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
+0002d250: 6e20 7365 6c66 2e71 7565 7565 640a 0a20  n self.queued.. 
+0002d260: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
+0002d270: 7761 6974 696e 6728 7365 6c66 2c20 6b65  waiting(self, ke
+0002d280: 793a 2073 7472 2920 2d3e 204e 6f6e 653a  y: str) -> None:
+0002d290: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+0002d2a0: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
+0002d2b0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+0002d2c0: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
+0002d2d0: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0002d2e0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+0002d2f0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0002d300: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+0002d310: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0002d320: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+0002d330: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+0002d340: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002d350: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
+0002d360: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
+0002d370: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0002d380: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+0002d390: 2020 2020 2020 2320 5765 2061 7265 2077        # We are w
+0002d3a0: 6169 7469 6e67 206f 6e20 6120 6465 7065  aiting on a depe
+0002d3b0: 6e64 656e 6379 2069 6666 2069 7427 7320  ndency iff it's 
+0002d3c0: 6e6f 7420 7374 6f72 6564 0a20 2020 2020  not stored.     
+0002d3d0: 2020 2020 2020 2061 7373 6572 7420 626f         assert bo
+0002d3e0: 6f6c 2864 7473 2e77 686f 5f68 6173 2920  ol(dts.who_has) 
+0002d3f0: 213d 2028 6474 7320 696e 2074 732e 7761  != (dts in ts.wa
+0002d400: 6974 696e 675f 6f6e 290a 2020 2020 2020  iting_on).      
+0002d410: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0002d420: 696e 2064 7473 2e77 6169 7465 7273 2020  in dts.waiters  
+0002d430: 2320 5858 5820 6576 656e 2069 6620 6474  # XXX even if dt
+0002d440: 732e 5f77 686f 5f68 6173 3f0a 0a20 2020  s._who_has?..   
+0002d450: 2064 6566 2076 616c 6964 6174 655f 7175   def validate_qu
+0002d460: 6575 6564 2873 656c 662c 206b 6579 3a20  eued(self, key: 
+0002d470: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+0002d480: 2020 2020 2020 7473 3a20 5461 736b 5374        ts: TaskSt
+0002d490: 6174 6520 3d20 7365 6c66 2e74 6173 6b73  ate = self.tasks
+0002d4a0: 5b6b 6579 5d0a 2020 2020 2020 2020 6474  [key].        dt
+0002d4b0: 733a 2054 6173 6b53 7461 7465 0a20 2020  s: TaskState.   
+0002d4c0: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0002d4d0: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
+0002d4e0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002d4f0: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+0002d500: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002d510: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+0002d520: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002d530: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+0002d540: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002d550: 6e6f 7420 280a 2020 2020 2020 2020 2020  not (.          
+0002d560: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
+0002d570: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
+0002d580: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+0002d590: 206f 7220 7473 2e72 6573 6f75 7263 655f   or ts.resource_
+0002d5a0: 7265 7374 7269 6374 696f 6e73 0a20 2020  restrictions.   
+0002d5b0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+0002d5c0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0002d5d0: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0002d5e0: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+0002d5f0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+0002d600: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0002d610: 696e 2064 7473 2e77 6169 7465 7273 0a0a  in dts.waiters..
+0002d620: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
+0002d630: 5f70 726f 6365 7373 696e 6728 7365 6c66  _processing(self
+0002d640: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
+0002d650: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
+0002d660: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
+0002d670: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+0002d680: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
+0002d690: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
+0002d6a0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+0002d6b0: 675f 6f6e 0a20 2020 2020 2020 2077 7320  g_on.        ws 
+0002d6c0: 3d20 7473 2e70 726f 6365 7373 696e 675f  = ts.processing_
+0002d6d0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002d6e0: 7420 7773 0a20 2020 2020 2020 2061 7373  t ws.        ass
+0002d6f0: 6572 7420 7473 2069 6e20 7773 2e70 726f  ert ts in ws.pro
+0002d700: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
+0002d710: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+0002d720: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
+0002d730: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0002d740: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+0002d750: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+0002d760: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+0002d770: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002d780: 7420 6474 732e 7768 6f5f 6861 730a 2020  t dts.who_has.  
+0002d790: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002d7a0: 2074 7320 696e 2064 7473 2e77 6169 7465   ts in dts.waite
+0002d7b0: 7273 0a0a 2020 2020 6465 6620 7661 6c69  rs..    def vali
+0002d7c0: 6461 7465 5f6d 656d 6f72 7928 7365 6c66  date_memory(self
+0002d7d0: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
+0002d7e0: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
+0002d7f0: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
+0002d800: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+0002d810: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
+0002d820: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
+0002d830: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
+0002d840: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
+0002d850: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
+0002d860: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
+0002d870: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
+0002d880: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
+0002d890: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+0002d8a0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+0002d8b0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002d8c0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+0002d8d0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0002d8e0: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
+0002d8f0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
+0002d900: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0002d910: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+0002d920: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+0002d930: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+0002d940: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002d950: 2864 7473 2069 6e20 7473 2e77 6169 7465  (dts in ts.waite
+0002d960: 7273 2920 3d3d 2028 0a20 2020 2020 2020  rs) == (.       
+0002d970: 2020 2020 2020 2020 2064 7473 2e73 7461           dts.sta
+0002d980: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
+0002d990: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
+0002d9a0: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
+0002d9b0: 726b 6572 2229 0a20 2020 2020 2020 2020  rker").         
+0002d9c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002d9d0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
+0002d9e0: 6e20 6474 732e 7761 6974 696e 675f 6f6e  n dts.waiting_on
+0002d9f0: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
+0002da00: 7465 5f6e 6f5f 776f 726b 6572 2873 656c  te_no_worker(sel
+0002da10: 662c 206b 6579 3a20 7374 7229 202d 3e20  f, key: str) -> 
+0002da20: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+0002da30: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
+0002da40: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+0002da50: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0002da60: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+0002da70: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+0002da80: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+0002da90: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
+0002daa0: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
+0002dab0: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
+0002dac0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+0002dad0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+0002dae0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002daf0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0002db00: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+0002db10: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
+0002db20: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0002db30: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0002db40: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0002db50: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
+0002db60: 6173 0a0a 2020 2020 6465 6620 7661 6c69  as..    def vali
+0002db70: 6461 7465 5f65 7272 6564 2873 656c 662c  date_erred(self,
+0002db80: 206b 6579 3a20 7374 7229 202d 3e20 4e6f   key: str) -> No
+0002db90: 6e65 3a0a 2020 2020 2020 2020 7473 3a20  ne:.        ts: 
+0002dba0: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002dbb0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+0002dbc0: 2020 2020 6173 7365 7274 2074 732e 6578      assert ts.ex
+0002dbd0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
+0002dbe0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002dbf0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+0002dc00: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+0002dc10: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
+0002dc20: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
+0002dc30: 7465 5f6b 6579 2873 656c 662c 206b 6579  te_key(self, key
+0002dc40: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
+0002dc50: 7461 7465 207c 204e 6f6e 6520 3d20 4e6f  tate | None = No
+0002dc60: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+0002dc70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002dc80: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0002dc90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002dca0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0002dcb0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+0002dcc0: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+0002dcd0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002dce0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0002dcf0: 6465 6275 6728 224b 6579 206c 6f73 743a  debug("Key lost:
+0002dd00: 2025 7322 2c20 6b65 7929 0a20 2020 2020   %s", key).     
+0002dd10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002dd20: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002dd30: 7661 6c69 6461 7465 2829 0a20 2020 2020  validate().     
+0002dd40: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd60: 2020 2020 6675 6e63 203d 2067 6574 6174      func = getat
+0002dd70: 7472 2873 656c 662c 2022 7661 6c69 6461  tr(self, "valida
+0002dd80: 7465 5f22 202b 2074 732e 7374 6174 652e  te_" + ts.state.
+0002dd90: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
+0002dda0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0002ddb0: 2020 2065 7863 6570 7420 4174 7472 6962     except Attrib
+0002ddc0: 7574 6545 7272 6f72 3a0a 2020 2020 2020  uteError:.      
+0002ddd0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0002dde0: 6767 6572 2e65 7272 6f72 280a 2020 2020  gger.error(.    
 0002ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de00: 2020 2020 6966 2074 7373 206e 6f74 2069      if tss not i
-0002de10: 6e20 7773 2e68 6173 5f77 6861 743a 0a20  n ws.has_what:. 
-0002de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002de30: 2020 2020 2020 2061 6374 7561 6c5f 6e65         actual_ne
-0002de40: 6564 735f 7768 6174 5b74 7373 5d20 2b3d  eds_what[tss] +=
-0002de50: 2031 0a20 2020 2020 2020 2020 2020 2061   1.            a
-0002de60: 7373 6572 7420 6163 7475 616c 5f6e 6565  ssert actual_nee
-0002de70: 6473 5f77 6861 7420 3d3d 2077 732e 6e65  ds_what == ws.ne
-0002de80: 6564 735f 7768 6174 0a20 2020 2020 2020  eds_what.       
-0002de90: 2020 2020 2061 7373 6572 7420 2877 732e       assert (ws.
-0002dea0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
-0002deb0: 2e72 756e 6e69 6e67 2920 3d3d 2028 7773  .running) == (ws
-0002dec0: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
-0002ded0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0002dee0: 7220 6e61 6d65 2c20 636f 756e 7420 696e  r name, count in
-0002def0: 2077 732e 7461 736b 5f70 7265 6669 785f   ws.task_prefix_
-0002df00: 636f 756e 742e 6974 656d 7328 293a 0a20  count.items():. 
-0002df10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002df20: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0002df30: 735b 6e61 6d65 5d20 2b3d 2063 6f75 6e74  s[name] += count
-0002df40: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-0002df50: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
-0002df60: 6e74 732e 6b65 7973 2829 203d 3d20 7365  nts.keys() == se
-0002df70: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
-0002df80: 636f 756e 745f 676c 6f62 616c 2e6b 6579  count_global.key
-0002df90: 7328 290a 2020 2020 2020 2020 666f 7220  s().        for 
-0002dfa0: 6e61 6d65 2c20 676c 6f62 616c 5f63 6f75  name, global_cou
-0002dfb0: 6e74 2069 6e20 7365 6c66 2e5f 7461 736b  nt in self._task
-0002dfc0: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
-0002dfd0: 6f62 616c 2e69 7465 6d73 2829 3a0a 2020  obal.items():.  
-0002dfe0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002dff0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0002e000: 2020 2074 6173 6b5f 7072 6566 6978 5f63     task_prefix_c
-0002e010: 6f75 6e74 735b 6e61 6d65 5d20 3d3d 2067  ounts[name] == g
-0002e020: 6c6f 6261 6c5f 636f 756e 740a 2020 2020  lobal_count.    
-0002e030: 2020 2020 2020 2020 292c 2066 227b 6e61          ), f"{na
-0002e040: 6d65 7d3a 207b 7461 736b 5f70 7265 6669  me}: {task_prefi
-0002e050: 785f 636f 756e 7473 5b6e 616d 655d 7d20  x_counts[name]} 
-0002e060: 2877 7373 292c 207b 676c 6f62 616c 5f63  (wss), {global_c
-0002e070: 6f75 6e74 7d20 2867 6c6f 6261 6c29 220a  ount} (global)".
-0002e080: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
-0002e090: 696e 2073 656c 662e 7275 6e6e 696e 673a  in self.running:
-0002e0a0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002e0b0: 6572 7420 7773 2e73 7461 7475 7320 3d3d  ert ws.status ==
-0002e0c0: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
-0002e0d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002e0e0: 7274 2077 732e 6164 6472 6573 7320 696e  rt ws.address in
-0002e0f0: 2073 656c 662e 776f 726b 6572 730a 0a20   self.workers.. 
-0002e100: 2020 2020 2020 2066 6f72 206b 2c20 7473         for k, ts
-0002e110: 2069 6e20 7365 6c66 2e74 6173 6b73 2e69   in self.tasks.i
-0002e120: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0002e130: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0002e140: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
-0002e150: 6174 6529 2c20 2874 7970 6528 7473 292c  ate), (type(ts),
-0002e160: 2074 7329 0a20 2020 2020 2020 2020 2020   ts).           
-0002e170: 2061 7373 6572 7420 7473 2e6b 6579 203d   assert ts.key =
-0002e180: 3d20 6b0a 2020 2020 2020 2020 2020 2020  = k.            
-0002e190: 6173 7365 7274 2062 6f6f 6c28 7473 2069  assert bool(ts i
-0002e1a0: 6e20 7365 6c66 2e72 6570 6c69 6361 7465  n self.replicate
-0002e1b0: 645f 7461 736b 7329 203d 3d20 286c 656e  d_tasks) == (len
-0002e1c0: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
-0002e1d0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0002e1e0: 6c66 2e76 616c 6964 6174 655f 6b65 7928  lf.validate_key(
-0002e1f0: 6b2c 2074 7329 0a0a 2020 2020 2020 2020  k, ts)..        
-0002e200: 666f 7220 7473 2069 6e20 7365 6c66 2e72  for ts in self.r
-0002e210: 6570 6c69 6361 7465 645f 7461 736b 733a  eplicated_tasks:
-0002e220: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002e230: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
-0002e240: 226d 656d 6f72 7922 0a20 2020 2020 2020  "memory".       
-0002e250: 2020 2020 2061 7373 6572 7420 7473 2e6b       assert ts.k
-0002e260: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
-0002e270: 0a0a 2020 2020 2020 2020 666f 7220 632c  ..        for c,
-0002e280: 2063 7320 696e 2073 656c 662e 636c 6965   cs in self.clie
-0002e290: 6e74 732e 6974 656d 7328 293a 0a20 2020  nts.items():.   
-0002e2a0: 2020 2020 2020 2020 2023 2063 6c69 656e           # clien
-0002e2b0: 743d 4e6f 6e65 2069 7320 6f66 7465 6e20  t=None is often 
-0002e2c0: 7573 6564 2069 6e20 7465 7374 732e 2e2e  used in tests...
-0002e2d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002e2e0: 6572 7420 6320 6973 204e 6f6e 6520 6f72  ert c is None or
-0002e2f0: 2074 7970 6528 6329 203d 3d20 7374 722c   type(c) == str,
-0002e300: 2028 7479 7065 2863 292c 2063 290a 2020   (type(c), c).  
-0002e310: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002e320: 2074 7970 6528 6373 2920 3d3d 2043 6c69   type(cs) == Cli
-0002e330: 656e 7453 7461 7465 2c20 2874 7970 6528  entState, (type(
-0002e340: 6373 292c 2063 7329 0a20 2020 2020 2020  cs), cs).       
-0002e350: 2020 2020 2061 7373 6572 7420 6373 2e63       assert cs.c
-0002e360: 6c69 656e 745f 6b65 7920 3d3d 2063 0a0a  lient_key == c..
-0002e370: 2020 2020 2020 2020 6120 3d20 7b77 3a20          a = {w: 
-0002e380: 7773 2e6e 6279 7465 7320 666f 7220 772c  ws.nbytes for w,
-0002e390: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-0002e3a0: 6572 732e 6974 656d 7328 297d 0a20 2020  ers.items()}.   
-0002e3b0: 2020 2020 2062 203d 207b 0a20 2020 2020       b = {.     
-0002e3c0: 2020 2020 2020 2077 3a20 7375 6d28 7473         w: sum(ts
-0002e3d0: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
-0002e3e0: 7220 7473 2069 6e20 7773 2e68 6173 5f77  r ts in ws.has_w
-0002e3f0: 6861 7429 0a20 2020 2020 2020 2020 2020  hat).           
-0002e400: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
-0002e410: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
-0002e420: 2829 0a20 2020 2020 2020 207d 0a20 2020  ().        }.   
-0002e430: 2020 2020 2061 7373 6572 7420 6120 3d3d       assert a ==
-0002e440: 2062 2c20 2861 2c20 6229 0a0a 2020 2020   b, (a, b)..    
-0002e450: 2020 2020 6966 2073 656c 662e 7472 616e      if self.tran
-0002e460: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
-0002e470: 6178 3a0a 2020 2020 2020 2020 2020 2020  ax:.            
-0002e480: 6173 7365 7274 2073 656c 662e 7472 616e  assert self.tran
-0002e490: 7369 7469 6f6e 5f63 6f75 6e74 6572 203c  sition_counter <
-0002e4a0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0002e4b0: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
-0002e4c0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002e4d0: 2323 2323 230a 2020 2020 2320 4d61 6e61  #####.    # Mana
-0002e4e0: 6765 204d 6573 7361 6765 7320 230a 2020  ge Messages #.  
-0002e4f0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0002e500: 2323 2323 230a 0a20 2020 2064 6566 2072  #####..    def r
-0002e510: 6570 6f72 7428 0a20 2020 2020 2020 2073  eport(.        s
-0002e520: 656c 662c 206d 7367 3a20 6469 6374 2c20  elf, msg: dict, 
-0002e530: 7473 3a20 5461 736b 5374 6174 6520 7c20  ts: TaskState | 
-0002e540: 4e6f 6e65 203d 204e 6f6e 652c 2063 6c69  None = None, cli
-0002e550: 656e 743a 2073 7472 207c 204e 6f6e 6520  ent: str | None 
-0002e560: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
-0002e570: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002e580: 220a 2020 2020 2020 2020 5075 626c 6973  ".        Publis
-0002e590: 6820 7570 6461 7465 7320 746f 2061 6c6c  h updates to all
-0002e5a0: 206c 6973 7465 6e69 6e67 2051 7565 7565   listening Queue
-0002e5b0: 7320 616e 6420 436f 6d6d 730a 0a20 2020  s and Comms..   
-0002e5c0: 2020 2020 2049 6620 7468 6520 6d65 7373       If the mess
-0002e5d0: 6167 6520 636f 6e74 6169 6e73 2061 206b  age contains a k
-0002e5e0: 6579 2074 6865 6e20 7765 206f 6e6c 7920  ey then we only 
-0002e5f0: 7365 6e64 2074 6865 206d 6573 7361 6765  send the message
-0002e600: 2074 6f20 7468 6f73 650a 2020 2020 2020   to those.      
-0002e610: 2020 636f 6d6d 7320 7468 6174 2063 6172    comms that car
-0002e620: 6520 6162 6f75 7420 7468 6520 6b65 792e  e about the key.
-0002e630: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002e640: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-0002e650: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002e660: 6d73 675f 6b65 7920 3d20 6d73 672e 6765  msg_key = msg.ge
-0002e670: 7428 226b 6579 2229 0a20 2020 2020 2020  t("key").       
-0002e680: 2020 2020 2069 6620 6d73 675f 6b65 7920       if msg_key 
-0002e690: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0002e6a0: 2020 2020 2020 2020 2020 2020 2074 6173               tas
-0002e6b0: 6b73 3a20 6469 6374 203d 2073 656c 662e  ks: dict = self.
-0002e6c0: 7461 736b 730a 2020 2020 2020 2020 2020  tasks.          
-0002e6d0: 2020 2020 2020 7473 203d 2074 6173 6b73        ts = tasks
-0002e6e0: 2e67 6574 286d 7367 5f6b 6579 290a 0a20  .get(msg_key).. 
-0002e6f0: 2020 2020 2020 2063 6c69 656e 745f 636f         client_co
-0002e700: 6d6d 733a 2064 6963 7420 3d20 7365 6c66  mms: dict = self
-0002e710: 2e63 6c69 656e 745f 636f 6d6d 730a 2020  .client_comms.  
-0002e720: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-0002e730: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002e740: 2023 204e 6f74 6966 7920 616c 6c20 636c   # Notify all cl
-0002e750: 6965 6e74 730a 2020 2020 2020 2020 2020  ients.          
-0002e760: 2020 636c 6965 6e74 5f6b 6579 7320 3d20    client_keys = 
-0002e770: 6c69 7374 2863 6c69 656e 745f 636f 6d6d  list(client_comm
-0002e780: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
-0002e790: 636c 6965 6e74 2069 7320 4e6f 6e65 3a0a  client is None:.
-0002e7a0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-0002e7b0: 7469 6679 2063 6c69 656e 7473 2069 6e74  tify clients int
-0002e7c0: 6572 6573 7465 6420 696e 206b 6579 0a20  erested in key. 
-0002e7d0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0002e7e0: 745f 6b65 7973 203d 205b 6373 2e63 6c69  t_keys = [cs.cli
-0002e7f0: 656e 745f 6b65 7920 666f 7220 6373 2069  ent_key for cs i
-0002e800: 6e20 7473 2e77 686f 5f77 616e 7473 5d0a  n ts.who_wants].
-0002e810: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e820: 2020 2020 2020 2020 2020 2320 4e6f 7469            # Noti
-0002e830: 6679 2063 6c69 656e 7473 2069 6e74 6572  fy clients inter
-0002e840: 6573 7465 6420 696e 206b 6579 2028 696e  ested in key (in
-0002e850: 636c 7564 696e 6720 6063 6c69 656e 7460  cluding `client`
-0002e860: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0002e870: 6965 6e74 5f6b 6579 7320 3d20 5b0a 2020  ient_keys = [.  
-0002e880: 2020 2020 2020 2020 2020 2020 2020 6373                cs
-0002e890: 2e63 6c69 656e 745f 6b65 7920 666f 7220  .client_key for 
-0002e8a0: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
-0002e8b0: 7473 2069 6620 6373 2e63 6c69 656e 745f  ts if cs.client_
-0002e8c0: 6b65 7920 213d 2063 6c69 656e 740a 2020  key != client.  
-0002e8d0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0002e8e0: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
-0002e8f0: 6579 732e 6170 7065 6e64 2863 6c69 656e  eys.append(clien
-0002e900: 7429 0a0a 2020 2020 2020 2020 6b3a 2073  t)..        k: s
-0002e910: 7472 0a20 2020 2020 2020 2066 6f72 206b  tr.        for k
-0002e920: 2069 6e20 636c 6965 6e74 5f6b 6579 733a   in client_keys:
-0002e930: 0a20 2020 2020 2020 2020 2020 2063 203d  .            c =
-0002e940: 2063 6c69 656e 745f 636f 6d6d 732e 6765   client_comms.ge
-0002e950: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
-0002e960: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
-0002e970: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e980: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0002e990: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002e9a0: 2020 2020 2020 2020 2063 2e73 656e 6428           c.send(
-0002e9b0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-0002e9c0: 2020 2020 2023 206c 6f67 6765 722e 6465       # logger.de
-0002e9d0: 6275 6728 2253 6368 6564 756c 6572 2073  bug("Scheduler s
-0002e9e0: 656e 6473 206d 6573 7361 6765 2074 6f20  ends message to 
-0002e9f0: 636c 6965 6e74 2025 7322 2c20 6d73 6729  client %s", msg)
-0002ea00: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0002ea10: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
-0002ea20: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0002ea30: 2020 2020 2069 6620 7365 6c66 2e73 7461       if self.sta
-0002ea40: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0002ea50: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-0002ea60: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0002ea70: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
-0002ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea90: 2020 2020 2243 6c6f 7365 6420 636f 6d6d      "Closed comm
-0002eaa0: 2025 7220 7768 696c 6520 7472 7969 6e67   %r while trying
-0002eab0: 2074 6f20 7772 6974 6520 2573 222c 2063   to write %s", c
-0002eac0: 2c20 6d73 672c 2065 7863 5f69 6e66 6f3d  , msg, exc_info=
-0002ead0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0002eae0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0002eaf0: 6173 796e 6320 6465 6620 6164 645f 636c  async def add_cl
-0002eb00: 6965 6e74 280a 2020 2020 2020 2020 7365  ient(.        se
-0002eb10: 6c66 2c20 636f 6d6d 3a20 436f 6d6d 2c20  lf, comm: Comm, 
-0002eb20: 636c 6965 6e74 3a20 7374 722c 2076 6572  client: str, ver
-0002eb30: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
-0002eb40: 2041 6e79 5d0a 2020 2020 2920 2d3e 204e   Any].    ) -> N
-0002eb50: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0002eb60: 4164 6420 636c 6965 6e74 2074 6f20 6e65  Add client to ne
-0002eb70: 7477 6f72 6b0a 0a20 2020 2020 2020 2057  twork..        W
-0002eb80: 6520 6c69 7374 656e 2074 6f20 616c 6c20  e listen to all 
-0002eb90: 6675 7475 7265 206d 6573 7361 6765 7320  future messages 
-0002eba0: 6672 6f6d 2074 6869 7320 436f 6d6d 2e0a  from this Comm..
-0002ebb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0002ebc0: 2020 2020 6173 7365 7274 2063 6c69 656e      assert clien
-0002ebd0: 7420 6973 206e 6f74 204e 6f6e 650a 2020  t is not None.  
-0002ebe0: 2020 2020 2020 636f 6d6d 2e6e 616d 6520        comm.name 
-0002ebf0: 3d20 2253 6368 6564 756c 6572 2d3e 436c  = "Scheduler->Cl
-0002ec00: 6965 6e74 220a 2020 2020 2020 2020 6c6f  ient".        lo
-0002ec10: 6767 6572 2e69 6e66 6f28 2252 6563 6569  gger.info("Recei
-0002ec20: 7665 2063 6c69 656e 7420 636f 6e6e 6563  ve client connec
-0002ec30: 7469 6f6e 3a20 2573 222c 2063 6c69 656e  tion: %s", clien
-0002ec40: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-0002ec50: 6c6f 675f 6576 656e 7428 5b22 616c 6c22  log_event(["all"
-0002ec60: 2c20 636c 6965 6e74 5d2c 207b 2261 6374  , client], {"act
-0002ec70: 696f 6e22 3a20 2261 6464 2d63 6c69 656e  ion": "add-clien
-0002ec80: 7422 2c20 2263 6c69 656e 7422 3a20 636c  t", "client": cl
-0002ec90: 6965 6e74 7d29 0a20 2020 2020 2020 2073  ient}).        s
-0002eca0: 656c 662e 636c 6965 6e74 735b 636c 6965  elf.clients[clie
-0002ecb0: 6e74 5d20 3d20 436c 6965 6e74 5374 6174  nt] = ClientStat
-0002ecc0: 6528 636c 6965 6e74 2c20 7665 7273 696f  e(client, versio
-0002ecd0: 6e73 3d76 6572 7369 6f6e 7329 0a0a 2020  ns=versions)..  
-0002ece0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-0002ecf0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-0002ed00: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-0002ed10: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0002ed20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002ed30: 2020 706c 7567 696e 2e61 6464 5f63 6c69    plugin.add_cli
-0002ed40: 656e 7428 7363 6865 6475 6c65 723d 7365  ent(scheduler=se
-0002ed50: 6c66 2c20 636c 6965 6e74 3d63 6c69 656e  lf, client=clien
-0002ed60: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
-0002ed70: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0002ed80: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002ed90: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-0002eda0: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
-0002edb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0002edc0: 2020 2020 6263 6f6d 6d20 3d20 4261 7463      bcomm = Batc
-0002edd0: 6865 6453 656e 6428 696e 7465 7276 616c  hedSend(interval
-0002ede0: 3d22 326d 7322 2c20 6c6f 6f70 3d73 656c  ="2ms", loop=sel
-0002edf0: 662e 6c6f 6f70 290a 2020 2020 2020 2020  f.loop).        
-0002ee00: 2020 2020 6263 6f6d 6d2e 7374 6172 7428      bcomm.start(
-0002ee10: 636f 6d6d 290a 2020 2020 2020 2020 2020  comm).          
-0002ee20: 2020 7365 6c66 2e63 6c69 656e 745f 636f    self.client_co
-0002ee30: 6d6d 735b 636c 6965 6e74 5d20 3d20 6263  mms[client] = bc
-0002ee40: 6f6d 6d0a 2020 2020 2020 2020 2020 2020  omm.            
-0002ee50: 6d73 6720 3d20 7b22 6f70 223a 2022 7374  msg = {"op": "st
-0002ee60: 7265 616d 2d73 7461 7274 227d 0a20 2020  ream-start"}.   
-0002ee70: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
-0002ee80: 5f77 6172 6e69 6e67 203d 2076 6572 7369  _warning = versi
-0002ee90: 6f6e 5f6d 6f64 756c 652e 6572 726f 725f  on_module.error_
-0002eea0: 6d65 7373 6167 6528 0a20 2020 2020 2020  message(.       
-0002eeb0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
-0002eec0: 5f6d 6f64 756c 652e 6765 745f 7665 7273  _module.get_vers
-0002eed0: 696f 6e73 2829 2c0a 2020 2020 2020 2020  ions(),.        
-0002eee0: 2020 2020 2020 2020 7b77 3a20 7773 2e76          {w: ws.v
-0002eef0: 6572 7369 6f6e 7320 666f 7220 772c 2077  ersions for w, w
-0002ef00: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-0002ef10: 732e 6974 656d 7328 297d 2c0a 2020 2020  s.items()},.    
-0002ef20: 2020 2020 2020 2020 2020 2020 7665 7273              vers
-0002ef30: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
-0002ef40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002ef50: 6d73 672e 7570 6461 7465 2876 6572 7369  msg.update(versi
-0002ef60: 6f6e 5f77 6172 6e69 6e67 290a 2020 2020  on_warning).    
-0002ef70: 2020 2020 2020 2020 6263 6f6d 6d2e 7365          bcomm.se
-0002ef80: 6e64 286d 7367 290a 0a20 2020 2020 2020  nd(msg)..       
-0002ef90: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002efa0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0002efb0: 7365 6c66 2e68 616e 646c 655f 7374 7265  self.handle_stre
-0002efc0: 616d 2863 6f6d 6d3d 636f 6d6d 2c20 6578  am(comm=comm, ex
-0002efd0: 7472 613d 7b22 636c 6965 6e74 223a 2063  tra={"client": c
-0002efe0: 6c69 656e 747d 290a 2020 2020 2020 2020  lient}).        
-0002eff0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-0002f000: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002f010: 662e 7265 6d6f 7665 5f63 6c69 656e 7428  f.remove_client(
-0002f020: 636c 6965 6e74 3d63 6c69 656e 742c 2073  client=client, s
-0002f030: 7469 6d75 6c75 735f 6964 3d66 2272 656d  timulus_id=f"rem
-0002f040: 6f76 652d 636c 6965 6e74 2d7b 7469 6d65  ove-client-{time
-0002f050: 2829 7d22 290a 2020 2020 2020 2020 2020  ()}").          
-0002f060: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0002f070: 7567 2822 4669 6e69 7368 6564 2068 616e  ug("Finished han
-0002f080: 646c 696e 6720 636c 6965 6e74 2025 7322  dling client %s"
-0002f090: 2c20 636c 6965 6e74 290a 2020 2020 2020  , client).      
-0002f0a0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-0002f0b0: 2020 2020 2020 2069 6620 6e6f 7420 636f         if not co
-0002f0c0: 6d6d 2e63 6c6f 7365 6428 293a 0a20 2020  mm.closed():.   
-0002f0d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002f0e0: 662e 636c 6965 6e74 5f63 6f6d 6d73 5b63  f.client_comms[c
-0002f0f0: 6c69 656e 745d 2e73 656e 6428 7b22 6f70  lient].send({"op
-0002f100: 223a 2022 7374 7265 616d 2d63 6c6f 7365  ": "stream-close
-0002f110: 6422 7d29 0a20 2020 2020 2020 2020 2020  d"}).           
-0002f120: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002f130: 2020 2020 2020 6966 206e 6f74 2073 7973        if not sys
-0002f140: 2e69 735f 6669 6e61 6c69 7a69 6e67 2829  .is_finalizing()
-0002f150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f160: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
-0002f170: 2e63 6c69 656e 745f 636f 6d6d 735b 636c  .client_comms[cl
-0002f180: 6965 6e74 5d2e 636c 6f73 6528 290a 2020  ient].close().  
-0002f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1a0: 2020 6465 6c20 7365 6c66 2e63 6c69 656e    del self.clien
-0002f1b0: 745f 636f 6d6d 735b 636c 6965 6e74 5d0a  t_comms[client].
-0002f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1d0: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
-0002f1e0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
-0002f1f0: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
-0002f200: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002f210: 6767 6572 2e69 6e66 6f28 2243 6c6f 7365  gger.info("Close
-0002f220: 2063 6c69 656e 7420 636f 6e6e 6563 7469   client connecti
-0002f230: 6f6e 3a20 2573 222c 2063 6c69 656e 7429  on: %s", client)
-0002f240: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0002f250: 6570 7420 5479 7065 4572 726f 723a 2020  ept TypeError:  
-0002f260: 2320 636f 6d6d 2062 6563 6f6d 6573 204e  # comm becomes N
-0002f270: 6f6e 6520 6475 7269 6e67 2047 430a 2020  one during GC.  
-0002f280: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0002f290: 7373 0a0a 2020 2020 6465 6620 7265 6d6f  ss..    def remo
-0002f2a0: 7665 5f63 6c69 656e 7428 7365 6c66 2c20  ve_client(self, 
-0002f2b0: 636c 6965 6e74 3a20 7374 722c 2073 7469  client: str, sti
-0002f2c0: 6d75 6c75 735f 6964 3a20 7374 7220 7c20  mulus_id: str | 
-0002f2d0: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
-0002f2e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0002f2f0: 2252 656d 6f76 6520 636c 6965 6e74 2066  "Remove client f
-0002f300: 726f 6d20 6e65 7477 6f72 6b22 2222 0a20  rom network""". 
-0002f310: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0002f320: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
-0002f330: 206f 7220 6622 7265 6d6f 7665 2d63 6c69   or f"remove-cli
-0002f340: 656e 742d 7b74 696d 6528 297d 220a 2020  ent-{time()}".  
-0002f350: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-0002f360: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
-0002f370: 756e 6e69 6e67 3a0a 2020 2020 2020 2020  unning:.        
-0002f380: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002f390: 2252 656d 6f76 6520 636c 6965 6e74 2025  "Remove client %
-0002f3a0: 7322 2c20 636c 6965 6e74 290a 2020 2020  s", client).    
-0002f3b0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-0002f3c0: 6e74 285b 2261 6c6c 222c 2063 6c69 656e  nt(["all", clien
-0002f3d0: 745d 2c20 7b22 6163 7469 6f6e 223a 2022  t], {"action": "
-0002f3e0: 7265 6d6f 7665 2d63 6c69 656e 7422 2c20  remove-client", 
-0002f3f0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
-0002f400: 7d29 0a20 2020 2020 2020 2074 7279 3a0a  }).        try:.
-0002f410: 2020 2020 2020 2020 2020 2020 6373 3a20              cs: 
-0002f420: 436c 6965 6e74 5374 6174 6520 3d20 7365  ClientState = se
-0002f430: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
-0002f440: 745d 0a20 2020 2020 2020 2065 7863 6570  t].        excep
-0002f450: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
-0002f460: 2020 2020 2020 2020 2320 5858 5820 6973          # XXX is
-0002f470: 2074 6869 7320 6120 6c65 6769 7469 6d61   this a legitima
-0002f480: 7465 2063 6f6e 6469 7469 6f6e 3f0a 2020  te condition?.  
-0002f490: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0002f4a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002f4b0: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-0002f4c0: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-0002f4d0: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
-0002f4e0: 2020 2020 6b65 7973 3d5b 7473 2e6b 6579      keys=[ts.key
-0002f4f0: 2066 6f72 2074 7320 696e 2063 732e 7761   for ts in cs.wa
-0002f500: 6e74 735f 7768 6174 5d2c 0a20 2020 2020  nts_what],.     
-0002f510: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0002f520: 743d 6373 2e63 6c69 656e 745f 6b65 792c  t=cs.client_key,
-0002f530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f540: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-0002f550: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-0002f560: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002f570: 2020 2020 6465 6c20 7365 6c66 2e63 6c69      del self.cli
-0002f580: 656e 7473 5b63 6c69 656e 745d 0a0a 2020  ents[client]..  
-0002f590: 2020 2020 2020 2020 2020 666f 7220 706c            for pl
-0002f5a0: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
-0002f5b0: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
-0002f5c0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-0002f5d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002f5e0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-0002f5f0: 7567 696e 2e72 656d 6f76 655f 636c 6965  ugin.remove_clie
-0002f600: 6e74 2873 6368 6564 756c 6572 3d73 656c  nt(scheduler=sel
-0002f610: 662c 2063 6c69 656e 743d 636c 6965 6e74  f, client=client
-0002f620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002f630: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0002f640: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0002f650: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0002f660: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
-0002f670: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-0002f680: 6465 6620 7265 6d6f 7665 5f63 6c69 656e  def remove_clien
-0002f690: 745f 6672 6f6d 5f65 7665 6e74 7328 293a  t_from_events():
-0002f6a0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-0002f6b0: 6620 7468 6520 636c 6965 6e74 2069 736e  f the client isn
-0002f6c0: 2774 2072 6567 6973 7465 7265 6420 616e  't registered an
-0002f6d0: 796d 6f72 6520 6166 7465 7220 7468 6520  ymore after the 
-0002f6e0: 6465 6c61 792c 2072 656d 6f76 6520 6672  delay, remove fr
-0002f6f0: 6f6d 2065 7665 6e74 730a 2020 2020 2020  om events.      
-0002f700: 2020 2020 2020 6966 2063 6c69 656e 7420        if client 
-0002f710: 6e6f 7420 696e 2073 656c 662e 636c 6965  not in self.clie
-0002f720: 6e74 7320 616e 6420 636c 6965 6e74 2069  nts and client i
-0002f730: 6e20 7365 6c66 2e65 7665 6e74 733a 0a20  n self.events:. 
-0002f740: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002f750: 656c 2073 656c 662e 6576 656e 7473 5b63  el self.events[c
-0002f760: 6c69 656e 745d 0a0a 2020 2020 2020 2020  lient]..        
-0002f770: 636c 6561 6e75 705f 6465 6c61 7920 3d20  cleanup_delay = 
-0002f780: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-0002f790: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
-0002f7a0: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0002f7b0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0002f7c0: 6c65 722e 6576 656e 7473 2d63 6c65 616e  ler.events-clean
-0002f7d0: 7570 2d64 656c 6179 2229 0a20 2020 2020  up-delay").     
-0002f7e0: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-0002f7f0: 6e6f 7420 7365 6c66 2e5f 6f6e 676f 696e  not self._ongoin
-0002f800: 675f 6261 636b 6772 6f75 6e64 5f74 6173  g_background_tas
-0002f810: 6b73 2e63 6c6f 7365 643a 0a20 2020 2020  ks.closed:.     
-0002f820: 2020 2020 2020 2073 656c 662e 5f6f 6e67         self._ong
-0002f830: 6f69 6e67 5f62 6163 6b67 726f 756e 645f  oing_background_
-0002f840: 7461 736b 732e 6361 6c6c 5f6c 6174 6572  tasks.call_later
-0002f850: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002f860: 2020 636c 6561 6e75 705f 6465 6c61 792c    cleanup_delay,
-0002f870: 2072 656d 6f76 655f 636c 6965 6e74 5f66   remove_client_f
-0002f880: 726f 6d5f 6576 656e 7473 0a20 2020 2020  rom_events.     
-0002f890: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0002f8a0: 6620 7365 6e64 5f74 6173 6b5f 746f 5f77  f send_task_to_w
-0002f8b0: 6f72 6b65 7228 0a20 2020 2020 2020 2073  orker(.        s
-0002f8c0: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-0002f8d0: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
-0002f8e0: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
-0002f8f0: 203d 202d 310a 2020 2020 2920 2d3e 204e   = -1.    ) -> N
-0002f900: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0002f910: 5365 6e64 2061 2073 696e 676c 6520 636f  Send a single co
-0002f920: 6d70 7574 6174 696f 6e61 6c20 7461 736b  mputational task
-0002f930: 2074 6f20 6120 776f 726b 6572 2222 220a   to a worker""".
-0002f940: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002f950: 2020 2020 2020 2020 206d 7367 3a20 6469           msg: di
-0002f960: 6374 203d 2073 656c 662e 5f74 6173 6b5f  ct = self._task_
-0002f970: 746f 5f6d 7367 2874 732c 2064 7572 6174  to_msg(ts, durat
-0002f980: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
-0002f990: 2073 656c 662e 776f 726b 6572 5f73 656e   self.worker_sen
-0002f9a0: 6428 776f 726b 6572 2c20 6d73 6729 0a20  d(worker, msg). 
-0002f9b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0002f9c0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0002f9d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002f9e0: 2e65 7863 6570 7469 6f6e 2865 290a 2020  .exception(e).  
-0002f9f0: 2020 2020 2020 2020 2020 6966 204c 4f47            if LOG
-0002fa00: 5f50 4442 3a0a 2020 2020 2020 2020 2020  _PDB:.          
-0002fa10: 2020 2020 2020 696d 706f 7274 2070 6462        import pdb
-0002fa20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002fa30: 2020 7064 622e 7365 745f 7472 6163 6528    pdb.set_trace(
-0002fa40: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-0002fa50: 6973 650a 0a20 2020 2064 6566 2068 616e  ise..    def han
-0002fa60: 646c 655f 756e 6361 7567 6874 5f65 7272  dle_uncaught_err
-0002fa70: 6f72 2873 656c 662c 202a 2a6d 7367 3a20  or(self, **msg: 
-0002fa80: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
-0002fa90: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-0002faa0: 6570 7469 6f6e 2863 6c65 616e 5f65 7863  eption(clean_exc
-0002fab0: 6570 7469 6f6e 282a 2a6d 7367 295b 315d  eption(**msg)[1]
-0002fac0: 290a 0a20 2020 2064 6566 2068 616e 646c  )..    def handl
-0002fad0: 655f 7461 736b 5f66 696e 6973 6865 6428  e_task_finished(
-0002fae0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
-0002faf0: 6579 3a20 7374 722c 2077 6f72 6b65 723a  ey: str, worker:
-0002fb00: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-0002fb10: 643a 2073 7472 2c20 2a2a 6d73 673a 2041  d: str, **msg: A
-0002fb20: 6e79 0a20 2020 2029 202d 3e20 4e6f 6e65  ny.    ) -> None
-0002fb30: 3a0a 2020 2020 2020 2020 6966 2077 6f72  :.        if wor
-0002fb40: 6b65 7220 6e6f 7420 696e 2073 656c 662e  ker not in self.
-0002fb50: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-0002fb60: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0002fb70: 2020 2020 7661 6c69 6461 7465 5f6b 6579      validate_key
-0002fb80: 286b 6579 290a 0a20 2020 2020 2020 2072  (key)..        r
-0002fb90: 3a20 7475 706c 6520 3d20 7365 6c66 2e73  : tuple = self.s
-0002fba0: 7469 6d75 6c75 735f 7461 736b 5f66 696e  timulus_task_fin
-0002fbb0: 6973 6865 6428 0a20 2020 2020 2020 2020  ished(.         
-0002fbc0: 2020 206b 6579 3d6b 6579 2c20 776f 726b     key=key, work
-0002fbd0: 6572 3d77 6f72 6b65 722c 2073 7469 6d75  er=worker, stimu
-0002fbe0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-0002fbf0: 6964 2c20 2a2a 6d73 670a 2020 2020 2020  id, **msg.      
-0002fc00: 2020 290a 2020 2020 2020 2020 7265 636f    ).        reco
-0002fc10: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-0002fc20: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-0002fc30: 5f6d 7367 7320 3d20 720a 2020 2020 2020  _msgs = r.      
-0002fc40: 2020 7365 6c66 2e5f 7472 616e 7369 7469    self._transiti
-0002fc50: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-0002fc60: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-0002fc70: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
-0002fc80: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
-0002fc90: 2020 2020 7365 6c66 2e73 656e 645f 616c      self.send_al
-0002fca0: 6c28 636c 6965 6e74 5f6d 7367 732c 2077  l(client_msgs, w
-0002fcb0: 6f72 6b65 725f 6d73 6773 290a 0a20 2020  orker_msgs)..   
-0002fcc0: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
-0002fcd0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
-0002fce0: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
-0002fcf0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-0002fd00: 5f69 6429 0a0a 2020 2020 6465 6620 6861  _id)..    def ha
-0002fd10: 6e64 6c65 5f74 6173 6b5f 6572 7265 6428  ndle_task_erred(
-0002fd20: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-0002fd30: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-0002fd40: 2c20 2a2a 6d73 673a 2041 6e79 2920 2d3e  , **msg: Any) ->
-0002fd50: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
-0002fd60: 3a20 7475 706c 6520 3d20 7365 6c66 2e73  : tuple = self.s
-0002fd70: 7469 6d75 6c75 735f 7461 736b 5f65 7272  timulus_task_err
-0002fd80: 6564 286b 6579 3d6b 6579 2c20 7374 696d  ed(key=key, stim
-0002fd90: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-0002fda0: 5f69 642c 202a 2a6d 7367 290a 2020 2020  _id, **msg).    
-0002fdb0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002fdc0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-0002fdd0: 2c20 776f 726b 6572 5f6d 7367 7320 3d20  , worker_msgs = 
-0002fde0: 720a 2020 2020 2020 2020 7365 6c66 2e5f  r.        self._
-0002fdf0: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
-0002fe00: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-0002fe10: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-0002fe20: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
-0002fe30: 6964 290a 2020 2020 2020 2020 7365 6c66  id).        self
-0002fe40: 2e73 656e 645f 616c 6c28 636c 6965 6e74  .send_all(client
-0002fe50: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-0002fe60: 6773 290a 0a20 2020 2020 2020 2073 656c  gs)..        sel
-0002fe70: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
-0002fe80: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
-0002fe90: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
-0002fea0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-0002feb0: 2020 6465 6620 7265 6c65 6173 655f 776f    def release_wo
-0002fec0: 726b 6572 5f64 6174 6128 7365 6c66 2c20  rker_data(self, 
-0002fed0: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
-0002fee0: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-0002fef0: 6964 3a20 7374 7229 202d 3e20 4e6f 6e65  id: str) -> None
-0002ff00: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-0002ff10: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002ff20: 7929 0a20 2020 2020 2020 2077 7320 3d20  y).        ws = 
-0002ff30: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
-0002ff40: 2877 6f72 6b65 7229 0a20 2020 2020 2020  (worker).       
-0002ff50: 2069 6620 6e6f 7420 7473 206f 7220 6e6f   if not ts or no
-0002ff60: 7420 7773 206f 7220 7773 206e 6f74 2069  t ws or ws not i
-0002ff70: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
-0002ff80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002ff90: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0002ffa0: 656d 6f76 655f 7265 706c 6963 6128 7473  emove_replica(ts
-0002ffb0: 2c20 7773 290a 2020 2020 2020 2020 6966  , ws).        if
-0002ffc0: 206e 6f74 2074 732e 7768 6f5f 6861 733a   not ts.who_has:
-0002ffd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002ffe0: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
-0002fff0: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
-00030000: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
-00030010: 2020 2064 6566 2068 616e 646c 655f 6c6f     def handle_lo
-00030020: 6e67 5f72 756e 6e69 6e67 280a 2020 2020  ng_running(.    
-00030030: 2020 2020 7365 6c66 2c20 6b65 793a 2073      self, key: s
-00030040: 7472 2c20 776f 726b 6572 3a20 7374 722c  tr, worker: str,
-00030050: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
-00030060: 6e3a 2066 6c6f 6174 207c 204e 6f6e 652c  n: float | None,
-00030070: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00030080: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
-00030090: 0a20 2020 2020 2020 2022 2222 4120 7461  .        """A ta
-000300a0: 736b 2068 6173 2073 6563 6564 6564 2066  sk has seceded f
-000300b0: 726f 6d20 7468 6520 7468 7265 6164 2070  rom the thread p
-000300c0: 6f6f 6c0a 0a20 2020 2020 2020 2057 6520  ool..        We 
-000300d0: 7374 6f70 2074 6865 2074 6173 6b20 6672  stop the task fr
-000300e0: 6f6d 2062 6569 6e67 2073 746f 6c65 6e20  om being stolen 
-000300f0: 696e 2074 6865 2066 7574 7572 652c 2061  in the future, a
-00030100: 6e64 2063 6861 6e67 6520 7461 736b 0a20  nd change task. 
-00030110: 2020 2020 2020 2064 7572 6174 696f 6e20         duration 
-00030120: 6163 636f 756e 7469 6e67 2061 7320 6966  accounting as if
-00030130: 2074 6865 2074 6173 6b20 6861 7320 7374   the task has st
-00030140: 6f70 7065 642e 0a20 2020 2020 2020 2022  opped..        "
-00030150: 2222 0a20 2020 2020 2020 2069 6620 6b65  "".        if ke
-00030160: 7920 6e6f 7420 696e 2073 656c 662e 7461  y not in self.ta
-00030170: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00030180: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
-00030190: 6b69 7070 696e 6720 6c6f 6e67 5f72 756e  kipping long_run
-000301a0: 6e69 6e67 2073 696e 6365 206b 6579 2025  ning since key %
-000301b0: 7320 7761 7320 616c 7265 6164 7920 7265  s was already re
-000301c0: 6c65 6173 6564 222c 206b 6579 290a 2020  leased", key).  
-000301d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000301e0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-000301f0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-00030200: 2020 2020 2020 7374 6561 6c20 3d20 7365        steal = se
-00030210: 6c66 2e65 7874 656e 7369 6f6e 732e 6765  lf.extensions.ge
-00030220: 7428 2273 7465 616c 696e 6722 290a 2020  t("stealing").  
-00030230: 2020 2020 2020 6966 2073 7465 616c 2069        if steal i
-00030240: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00030250: 2020 2020 2020 2020 7374 6561 6c2e 7265          steal.re
-00030260: 6d6f 7665 5f6b 6579 5f66 726f 6d5f 7374  move_key_from_st
-00030270: 6561 6c61 626c 6528 7473 290a 0a20 2020  ealable(ts)..   
-00030280: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
-00030290: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-000302a0: 2020 2069 6620 7773 2069 7320 4e6f 6e65     if ws is None
-000302b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-000302c0: 6767 6572 2e64 6562 7567 2822 5265 6365  gger.debug("Rece
-000302d0: 6976 6564 206c 6f6e 672d 7275 6e6e 696e  ived long-runnin
-000302e0: 6720 7369 676e 616c 2066 726f 6d20 6475  g signal from du
-000302f0: 706c 6963 6174 6520 7461 736b 2e20 4967  plicate task. Ig
-00030300: 6e6f 7269 6e67 2e22 290a 2020 2020 2020  noring.").      
-00030310: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00030320: 2020 2020 2020 6966 2063 6f6d 7075 7465        if compute
-00030330: 5f64 7572 6174 696f 6e20 6973 206e 6f74  _duration is not
-00030340: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00030350: 2020 206f 6c64 5f64 7572 6174 696f 6e20     old_duration 
-00030360: 3d20 7473 2e70 7265 6669 782e 6475 7261  = ts.prefix.dura
-00030370: 7469 6f6e 5f61 7665 7261 6765 0a20 2020  tion_average.   
-00030380: 2020 2020 2020 2020 2069 6620 6f6c 645f           if old_
-00030390: 6475 7261 7469 6f6e 203c 2030 3a0a 2020  duration < 0:.  
-000303a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000303b0: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
-000303c0: 5f61 7665 7261 6765 203d 2063 6f6d 7075  _average = compu
-000303d0: 7465 5f64 7572 6174 696f 6e0a 2020 2020  te_duration.    
-000303e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000303f0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00030400: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
-00030410: 5f61 7665 7261 6765 203d 2028 6f6c 645f  _average = (old_
-00030420: 6475 7261 7469 6f6e 202b 2063 6f6d 7075  duration + compu
-00030430: 7465 5f64 7572 6174 696f 6e29 202f 2032  te_duration) / 2
-00030440: 0a0a 2020 2020 2020 2020 7773 2e61 6464  ..        ws.add
-00030450: 5f74 6f5f 6c6f 6e67 5f72 756e 6e69 6e67  _to_long_running
-00030460: 2874 7329 0a20 2020 2020 2020 2073 656c  (ts).        sel
-00030470: 662e 6368 6563 6b5f 6964 6c65 5f73 6174  f.check_idle_sat
-00030480: 7572 6174 6564 2877 7329 0a0a 2020 2020  urated(ws)..    
-00030490: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
-000304a0: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
-000304b0: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
-000304c0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-000304d0: 6964 290a 0a20 2020 2064 6566 2068 616e  id)..    def han
-000304e0: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
-000304f0: 735f 6368 616e 6765 280a 2020 2020 2020  s_change(.      
-00030500: 2020 7365 6c66 2c20 7374 6174 7573 3a20    self, status: 
-00030510: 7374 7220 7c20 5374 6174 7573 2c20 776f  str | Status, wo
-00030520: 726b 6572 3a20 7374 7220 7c20 576f 726b  rker: str | Work
-00030530: 6572 5374 6174 652c 2073 7469 6d75 6c75  erState, stimulu
-00030540: 735f 6964 3a20 7374 720a 2020 2020 2920  s_id: str.    ) 
-00030550: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00030560: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-00030570: 7273 2e67 6574 2877 6f72 6b65 7229 2069  rs.get(worker) i
-00030580: 6620 6973 696e 7374 616e 6365 2877 6f72  f isinstance(wor
-00030590: 6b65 722c 2073 7472 2920 656c 7365 2077  ker, str) else w
-000305a0: 6f72 6b65 720a 2020 2020 2020 2020 6966  orker.        if
-000305b0: 206e 6f74 2077 733a 0a20 2020 2020 2020   not ws:.       
-000305c0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-000305d0: 2020 2020 7072 6576 5f73 7461 7475 7320      prev_status 
-000305e0: 3d20 7773 2e73 7461 7475 730a 2020 2020  = ws.status.    
-000305f0: 2020 2020 7773 2e73 7461 7475 7320 3d20      ws.status = 
-00030600: 5374 6174 7573 5b73 7461 7475 735d 2069  Status[status] i
-00030610: 6620 6973 696e 7374 616e 6365 2873 7461  f isinstance(sta
-00030620: 7475 732c 2073 7472 2920 656c 7365 2073  tus, str) else s
-00030630: 7461 7475 730a 2020 2020 2020 2020 6966  tatus.        if
-00030640: 2077 732e 7374 6174 7573 203d 3d20 7072   ws.status == pr
-00030650: 6576 5f73 7461 7475 733a 0a20 2020 2020  ev_status:.     
-00030660: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00030670: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-00030680: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
-00030690: 2020 2077 732e 6164 6472 6573 732c 0a20     ws.address,. 
-000306a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-000306b0: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
-000306c0: 7469 6f6e 223a 2022 776f 726b 6572 2d73  tion": "worker-s
-000306d0: 7461 7475 732d 6368 616e 6765 222c 0a20  tatus-change",. 
-000306e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000306f0: 7072 6576 2d73 7461 7475 7322 3a20 7072  prev-status": pr
-00030700: 6576 5f73 7461 7475 732e 6e61 6d65 2c0a  ev_status.name,.
-00030710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030720: 2273 7461 7475 7322 3a20 7773 2e73 7461  "status": ws.sta
-00030730: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
-00030740: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00030750: 2029 0a20 2020 2020 2020 206c 6f67 6765   ).        logge
-00030760: 722e 6465 6275 6728 6622 576f 726b 6572  r.debug(f"Worker
-00030770: 2073 7461 7475 7320 7b70 7265 765f 7374   status {prev_st
-00030780: 6174 7573 2e6e 616d 657d 202d 3e20 7b73  atus.name} -> {s
-00030790: 7461 7475 737d 202d 207b 7773 7d22 290a  tatus} - {ws}").
-000307a0: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
-000307b0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-000307c0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-000307d0: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
-000307e0: 672e 6164 6428 7773 290a 2020 2020 2020  g.add(ws).      
-000307f0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
-00030800: 5f69 646c 655f 7361 7475 7261 7465 6428  _idle_saturated(
-00030810: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
-00030820: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
-00030830: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00030840: 2020 7365 6c66 2e62 756c 6b5f 7363 6865    self.bulk_sche
-00030850: 6475 6c65 5f75 6e72 756e 6e61 626c 655f  dule_unrunnable_
-00030860: 6166 7465 725f 6164 6469 6e67 5f77 6f72  after_adding_wor
-00030870: 6b65 7228 7773 292c 2073 7469 6d75 6c75  ker(ws), stimulu
-00030880: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
-00030890: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-000308a0: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
-000308b0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
-000308c0: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
-000308d0: 643d 7374 696d 756c 7573 5f69 6429 0a20  d=stimulus_id). 
-000308e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000308f0: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
-00030900: 6e6e 696e 672e 6469 7363 6172 6428 7773  nning.discard(ws
-00030910: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00030920: 6c66 2e69 646c 652e 706f 7028 7773 2e61  lf.idle.pop(ws.a
-00030930: 6464 7265 7373 2c20 4e6f 6e65 290a 2020  ddress, None).  
-00030940: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-00030950: 646c 655f 7461 736b 5f63 6f75 6e74 2e64  dle_task_count.d
-00030960: 6973 6361 7264 2877 7329 0a20 2020 2020  iscard(ws).     
-00030970: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
-00030980: 7261 7465 642e 6469 7363 6172 6428 7773  rated.discard(ws
-00030990: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-000309a0: 2068 616e 646c 655f 7265 7175 6573 745f   handle_request_
-000309b0: 7265 6672 6573 685f 7768 6f5f 6861 7328  refresh_who_has(
-000309c0: 0a20 2020 2020 2020 2073 656c 662c 206b  .        self, k
-000309d0: 6579 733a 2049 7465 7261 626c 655b 7374  eys: Iterable[st
-000309e0: 725d 2c20 776f 726b 6572 3a20 7374 722c  r], worker: str,
-000309f0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00030a00: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
-00030a10: 0a20 2020 2020 2020 2022 2222 4173 796e  .        """Asyn
-00030a20: 6368 726f 6e6f 7573 2072 6571 7565 7374  chronous request
-00030a30: 2028 7468 726f 7567 6820 6275 6c6b 2063   (through bulk c
-00030a40: 6f6d 6d73 2920 6672 6f6d 2061 2057 6f72  omms) from a Wor
-00030a50: 6b65 7220 746f 2072 6566 7265 7368 2074  ker to refresh t
-00030a60: 6865 0a20 2020 2020 2020 2077 686f 5f68  he.        who_h
-00030a70: 6173 2066 6f72 2073 6f6d 6520 6b65 7973  as for some keys
-00030a80: 2e20 4e6f 7420 746f 2062 6520 636f 6e66  . Not to be conf
-00030a90: 7573 6564 2077 6974 6820 7363 6865 6475  used with schedu
-00030aa0: 6c65 722e 7768 6f5f 6861 732c 2077 6869  ler.who_has, whi
-00030ab0: 6368 2069 7320 610a 2020 2020 2020 2020  ch is a.        
-00030ac0: 7379 6e63 6872 6f6e 6f75 7320 5250 4320  synchronous RPC 
-00030ad0: 7265 7175 6573 7420 6672 6f6d 2061 2043  request from a C
-00030ae0: 6c69 656e 742e 0a20 2020 2020 2020 2022  lient..        "
-00030af0: 2222 0a20 2020 2020 2020 2077 686f 5f68  "".        who_h
-00030b00: 6173 203d 207b 7d0a 2020 2020 2020 2020  as = {}.        
-00030b10: 6672 6565 5f6b 6579 7320 3d20 5b5d 0a20  free_keys = []. 
-00030b20: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00030b30: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-00030b40: 2020 2020 6966 206b 6579 2069 6e20 7365      if key in se
-00030b50: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
-00030b60: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
-00030b70: 735b 6b65 795d 203d 205b 7773 2e61 6464  s[key] = [ws.add
-00030b80: 7265 7373 2066 6f72 2077 7320 696e 2073  ress for ws in s
-00030b90: 656c 662e 7461 736b 735b 6b65 795d 2e77  elf.tasks[key].w
-00030ba0: 686f 5f68 6173 5d0a 2020 2020 2020 2020  ho_has].        
-00030bb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00030bc0: 2020 2020 2020 2020 2020 6672 6565 5f6b            free_k
-00030bd0: 6579 732e 6170 7065 6e64 286b 6579 290a  eys.append(key).
-00030be0: 0a20 2020 2020 2020 2069 6620 7768 6f5f  .        if who_
-00030bf0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-00030c00: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
-00030c10: 6d73 5b77 6f72 6b65 725d 2e73 656e 6428  ms[worker].send(
-00030c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030c30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00030c40: 2020 2020 2020 2022 6f70 223a 2022 7265         "op": "re
-00030c50: 6672 6573 682d 7768 6f2d 6861 7322 2c0a  fresh-who-has",.
-00030c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c70: 2020 2020 2277 686f 5f68 6173 223a 2077      "who_has": w
-00030c80: 686f 5f68 6173 2c0a 2020 2020 2020 2020  ho_has,.        
-00030c90: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00030ca0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00030cb0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00030cc0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00030cd0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00030ce0: 6966 2066 7265 655f 6b65 7973 3a0a 2020  if free_keys:.  
-00030cf0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00030d00: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
-00030d10: 6572 5d2e 7365 6e64 280a 2020 2020 2020  er].send(.      
-00030d20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00030d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d40: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
-00030d50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00030d60: 2020 2020 2020 2022 6b65 7973 223a 2066         "keys": f
-00030d70: 7265 655f 6b65 7973 2c0a 2020 2020 2020  ree_keys,.      
-00030d80: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-00030d90: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-00030da0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-00030db0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00030dc0: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
-00030dd0: 7379 6e63 2064 6566 2068 616e 646c 655f  sync def handle_
-00030de0: 776f 726b 6572 2873 656c 662c 2063 6f6d  worker(self, com
-00030df0: 6d3a 2043 6f6d 6d2c 2077 6f72 6b65 723a  m: Comm, worker:
-00030e00: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00030e10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00030e20: 2020 204c 6973 7465 6e20 746f 2072 6573     Listen to res
-00030e30: 706f 6e73 6573 2066 726f 6d20 6120 7369  ponses from a si
-00030e40: 6e67 6c65 2077 6f72 6b65 720a 0a20 2020  ngle worker..   
-00030e50: 2020 2020 2054 6869 7320 6973 2074 6865       This is the
-00030e60: 206d 6169 6e20 6c6f 6f70 2066 6f72 2073   main loop for s
-00030e70: 6368 6564 756c 6572 2d77 6f72 6b65 7220  cheduler-worker 
-00030e80: 696e 7465 7261 6374 696f 6e0a 0a20 2020  interaction..   
-00030e90: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-00030ea0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00030eb0: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-00030ec0: 2e68 616e 646c 655f 636c 6965 6e74 3a20  .handle_client: 
-00030ed0: 4571 7569 7661 6c65 6e74 2063 6f72 6f75  Equivalent corou
-00030ee0: 7469 6e65 2066 6f72 2063 6c69 656e 7473  tine for clients
-00030ef0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00030f00: 2020 2020 2063 6f6d 6d2e 6e61 6d65 203d       comm.name =
-00030f10: 2022 5363 6865 6475 6c65 7220 636f 6e6e   "Scheduler conn
-00030f20: 6563 7469 6f6e 2074 6f20 776f 726b 6572  ection to worker
-00030f30: 220a 2020 2020 2020 2020 776f 726b 6572  ".        worker
-00030f40: 5f63 6f6d 6d20 3d20 7365 6c66 2e73 7472  _comm = self.str
-00030f50: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
-00030f60: 5d0a 2020 2020 2020 2020 776f 726b 6572  ].        worker
-00030f70: 5f63 6f6d 6d2e 7374 6172 7428 636f 6d6d  _comm.start(comm
-00030f80: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
-00030f90: 2e69 6e66 6f28 2253 7461 7274 696e 6720  .info("Starting 
-00030fa0: 776f 726b 6572 2063 6f6d 7075 7465 2073  worker compute s
-00030fb0: 7472 6561 6d2c 2025 7322 2c20 776f 726b  tream, %s", work
-00030fc0: 6572 290a 2020 2020 2020 2020 7472 793a  er).        try:
-00030fd0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00030fe0: 6974 2073 656c 662e 6861 6e64 6c65 5f73  it self.handle_s
-00030ff0: 7472 6561 6d28 636f 6d6d 3d63 6f6d 6d2c  tream(comm=comm,
-00031000: 2065 7874 7261 3d7b 2277 6f72 6b65 7222   extra={"worker"
-00031010: 3a20 776f 726b 6572 7d29 0a20 2020 2020  : worker}).     
-00031020: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00031030: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00031040: 7220 696e 2073 656c 662e 7374 7265 616d  r in self.stream
-00031050: 5f63 6f6d 6d73 3a0a 2020 2020 2020 2020  _comms:.        
-00031060: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
-00031070: 6f6d 6d2e 6162 6f72 7428 290a 2020 2020  omm.abort().    
-00031080: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00031090: 7420 7365 6c66 2e72 656d 6f76 655f 776f  t self.remove_wo
-000310a0: 726b 6572 280a 2020 2020 2020 2020 2020  rker(.          
-000310b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-000310c0: 2c20 7374 696d 756c 7573 5f69 643d 6622  , stimulus_id=f"
-000310d0: 6861 6e64 6c65 2d77 6f72 6b65 722d 636c  handle-worker-cl
-000310e0: 6561 6e75 702d 7b74 696d 6528 297d 220a  eanup-{time()}".
-000310f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031100: 290a 0a20 2020 2064 6566 2061 6464 5f70  )..    def add_p
-00031110: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
-00031120: 656c 662c 0a20 2020 2020 2020 2070 6c75  elf,.        plu
-00031130: 6769 6e3a 2053 6368 6564 756c 6572 506c  gin: SchedulerPl
-00031140: 7567 696e 2c0a 2020 2020 2020 2020 2a2c  ugin,.        *,
-00031150: 0a20 2020 2020 2020 2069 6465 6d70 6f74  .        idempot
-00031160: 656e 743a 2062 6f6f 6c20 3d20 4661 6c73  ent: bool = Fals
-00031170: 652c 0a20 2020 2020 2020 206e 616d 653a  e,.        name:
-00031180: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-00031190: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-000311a0: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-000311b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000311c0: 2020 2222 2241 6464 2065 7874 6572 6e61    """Add externa
-000311d0: 6c20 706c 7567 696e 2074 6f20 7363 6865  l plugin to sche
-000311e0: 6475 6c65 722e 0a0a 2020 2020 2020 2020  duler...        
-000311f0: 5365 6520 6874 7470 733a 2f2f 6469 7374  See https://dist
-00031200: 7269 6275 7465 642e 7265 6164 7468 6564  ributed.readthed
-00031210: 6f63 732e 696f 2f65 6e2f 6c61 7465 7374  ocs.io/en/latest
-00031220: 2f70 6c75 6769 6e73 2e68 746d 6c0a 0a20  /plugins.html.. 
-00031230: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-00031240: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00031250: 2d2d 2d2d 0a20 2020 2020 2020 2070 6c75  ----.        plu
-00031260: 6769 6e20 3a20 5363 6865 6475 6c65 7250  gin : SchedulerP
-00031270: 6c75 6769 6e0a 2020 2020 2020 2020 2020  lugin.          
-00031280: 2020 5363 6865 6475 6c65 7250 6c75 6769    SchedulerPlugi
-00031290: 6e20 696e 7374 616e 6365 2074 6f20 6164  n instance to ad
-000312a0: 640a 2020 2020 2020 2020 6964 656d 706f  d.        idempo
-000312b0: 7465 6e74 203a 2062 6f6f 6c0a 2020 2020  tent : bool.    
-000312c0: 2020 2020 2020 2020 4966 2074 7275 652c          If true,
-000312d0: 2074 6865 2070 6c75 6769 6e20 6973 2061   the plugin is a
-000312e0: 7373 756d 6564 2074 6f20 616c 7265 6164  ssumed to alread
-000312f0: 7920 6578 6973 7420 616e 6420 6e6f 0a20  y exist and no. 
-00031300: 2020 2020 2020 2020 2020 2061 6374 696f             actio
-00031310: 6e20 6973 2074 616b 656e 2e0a 2020 2020  n is taken..    
-00031320: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
-00031330: 2020 2020 2020 2020 2020 2041 206e 616d             A nam
-00031340: 6520 666f 7220 7468 6520 706c 7567 696e  e for the plugin
-00031350: 2c20 6966 204e 6f6e 652c 2074 6865 206e  , if None, the n
-00031360: 616d 6520 6174 7472 6962 7574 6520 6973  ame attribute is
-00031370: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-00031380: 636b 6564 206f 6e20 7468 6520 506c 7567  cked on the Plug
-00031390: 696e 2069 6e73 7461 6e63 6520 616e 6420  in instance and 
-000313a0: 6765 6e65 7261 7465 6420 6966 206e 6f74  generated if not
-000313b0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-000313c0: 636f 7665 7265 642e 0a20 2020 2020 2020  covered..       
-000313d0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-000313e0: 6e61 6d65 2069 7320 4e6f 6e65 3a0a 2020  name is None:.  
-000313f0: 2020 2020 2020 2020 2020 6e61 6d65 203d            name =
-00031400: 205f 6765 745f 706c 7567 696e 5f6e 616d   _get_plugin_nam
-00031410: 6528 706c 7567 696e 290a 0a20 2020 2020  e(plugin)..     
-00031420: 2020 2069 6620 6e61 6d65 2069 6e20 7365     if name in se
-00031430: 6c66 2e70 6c75 6769 6e73 3a0a 2020 2020  lf.plugins:.    
-00031440: 2020 2020 2020 2020 6966 2069 6465 6d70          if idemp
-00031450: 6f74 656e 743a 0a20 2020 2020 2020 2020  otent:.         
-00031460: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-00031470: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
-00031480: 6773 2e77 6172 6e28 0a20 2020 2020 2020  gs.warn(.       
-00031490: 2020 2020 2020 2020 2066 2253 6368 6564           f"Sched
-000314a0: 756c 6572 2061 6c72 6561 6479 2063 6f6e  uler already con
-000314b0: 7461 696e 7320 6120 706c 7567 696e 2077  tains a plugin w
-000314c0: 6974 6820 6e61 6d65 207b 6e61 6d65 7d3b  ith name {name};
-000314d0: 206f 7665 7277 7269 7469 6e67 2e22 2c0a   overwriting.",.
-000314e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314f0: 6361 7465 676f 7279 3d55 7365 7257 6172  category=UserWar
-00031500: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
-00031510: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00031520: 662e 706c 7567 696e 735b 6e61 6d65 5d20  f.plugins[name] 
-00031530: 3d20 706c 7567 696e 0a0a 2020 2020 6465  = plugin..    de
-00031540: 6620 7265 6d6f 7665 5f70 6c75 6769 6e28  f remove_plugin(
-00031550: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00031560: 2020 2020 2020 206e 616d 653a 2073 7472         name: str
-00031570: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00031580: 2020 2020 2020 2020 706c 7567 696e 3a20          plugin: 
-00031590: 5363 6865 6475 6c65 7250 6c75 6769 6e20  SchedulerPlugin 
-000315a0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-000315b0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-000315c0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-000315d0: 6578 7465 726e 616c 2070 6c75 6769 6e20  external plugin 
-000315e0: 6672 6f6d 2073 6368 6564 756c 6572 0a0a  from scheduler..
-000315f0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-00031600: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-00031610: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6e61  -----.        na
-00031620: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
-00031630: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-00031640: 2070 6c75 6769 6e20 746f 2072 656d 6f76   plugin to remov
-00031650: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-00031660: 2020 2020 2020 6173 7365 7274 206e 616d        assert nam
-00031670: 6520 6973 206e 6f74 204e 6f6e 650a 0a20  e is not None.. 
-00031680: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00031690: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-000316a0: 2e70 6c75 6769 6e73 5b6e 616d 655d 0a20  .plugins[name]. 
-000316b0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-000316c0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-000316d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000316e0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-000316f0: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
-00031700: 7420 6669 6e64 2070 6c75 6769 6e20 7b6e  t find plugin {n
-00031710: 616d 6521 727d 2061 6d6f 6e67 2074 6865  ame!r} among the
-00031720: 2063 7572 7265 6e74 2073 6368 6564 756c   current schedul
-00031730: 6572 2070 6c75 6769 6e73 220a 2020 2020  er plugins".    
-00031740: 2020 2020 2020 2020 290a 0a20 2020 2061          )..    a
-00031750: 7379 6e63 2064 6566 2072 6567 6973 7465  sync def registe
-00031760: 725f 7363 6865 6475 6c65 725f 706c 7567  r_scheduler_plug
-00031770: 696e 280a 2020 2020 2020 2020 7365 6c66  in(.        self
-00031780: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
-00031790: 3a20 6279 7465 7320 7c20 5363 6865 6475  : bytes | Schedu
-000317a0: 6c65 7250 6c75 6769 6e2c 0a20 2020 2020  lerPlugin,.     
-000317b0: 2020 206e 616d 653a 2073 7472 207c 204e     name: str | N
-000317c0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-000317d0: 2020 2020 6964 656d 706f 7465 6e74 3a20      idempotent: 
-000317e0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-000317f0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00031800: 2020 2020 2022 2222 5265 6769 7374 6572       """Register
-00031810: 2061 2070 6c75 6769 6e20 6f6e 2074 6865   a plugin on the
-00031820: 2073 6368 6564 756c 6572 2e22 2222 0a20   scheduler.""". 
-00031830: 2020 2020 2020 2069 6620 6e6f 7420 6461         if not da
-00031840: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-00031850: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00031860: 756c 6572 2e70 6963 6b6c 6522 293a 0a20  uler.pickle"):. 
-00031870: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00031880: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-00031890: 2020 2020 2020 2020 2020 2020 2022 4361               "Ca
-000318a0: 6e6e 6f74 2072 6567 6973 7465 7220 6120  nnot register a 
-000318b0: 7363 6865 6475 6c65 7220 706c 7567 696e  scheduler plugin
-000318c0: 2061 7320 7468 6520 7363 6865 6475 6c65   as the schedule
-000318d0: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
-000318e0: 2020 2020 2268 6173 2062 6565 6e20 6578      "has been ex
-000318f0: 706c 6963 6974 6c79 2064 6973 616c 6c6f  plicitly disallo
-00031900: 7765 6420 6672 6f6d 2064 6573 6572 6961  wed from deseria
-00031910: 6c69 7a69 6e67 2022 0a20 2020 2020 2020  lizing ".       
-00031920: 2020 2020 2020 2020 2022 6172 6269 7472           "arbitr
-00031930: 6172 7920 6279 7465 7374 7269 6e67 7320  ary bytestrings 
-00031940: 7573 696e 6720 7069 636b 6c65 2076 6961  using pickle via
-00031950: 2074 6865 2022 0a20 2020 2020 2020 2020   the ".         
-00031960: 2020 2020 2020 2022 2764 6973 7472 6962         "'distrib
-00031970: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-00031980: 6963 6b6c 6527 2063 6f6e 6669 6775 7261  ickle' configura
-00031990: 7469 6f6e 2073 6574 7469 6e67 2e22 0a20  tion setting.". 
-000319a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000319b0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-000319c0: 7374 616e 6365 2870 6c75 6769 6e2c 2053  stance(plugin, S
-000319d0: 6368 6564 756c 6572 506c 7567 696e 293a  chedulerPlugin):
-000319e0: 0a20 2020 2020 2020 2020 2020 2070 6c75  .            plu
-000319f0: 6769 6e20 3d20 6c6f 6164 7328 706c 7567  gin = loads(plug
-00031a00: 696e 290a 2020 2020 2020 2020 2020 2020  in).            
-00031a10: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00031a20: 6528 706c 7567 696e 2c20 5363 6865 6475  e(plugin, Schedu
-00031a30: 6c65 7250 6c75 6769 6e29 0a0a 2020 2020  lerPlugin)..    
-00031a40: 2020 2020 6966 206e 616d 6520 6973 204e      if name is N
-00031a50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00031a60: 206e 616d 6520 3d20 5f67 6574 5f70 6c75   name = _get_plu
-00031a70: 6769 6e5f 6e61 6d65 2870 6c75 6769 6e29  gin_name(plugin)
-00031a80: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
-00031a90: 6520 696e 2073 656c 662e 706c 7567 696e  e in self.plugin
-00031aa0: 7320 616e 6420 6964 656d 706f 7465 6e74  s and idempotent
-00031ab0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00031ac0: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
-00031ad0: 2068 6173 6174 7472 2870 6c75 6769 6e2c   hasattr(plugin,
-00031ae0: 2022 7374 6172 7422 293a 0a20 2020 2020   "start"):.     
-00031af0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00031b00: 706c 7567 696e 2e73 7461 7274 2873 656c  plugin.start(sel
-00031b10: 6629 0a20 2020 2020 2020 2020 2020 2069  f).            i
-00031b20: 6620 696e 7370 6563 742e 6973 6177 6169  f inspect.isawai
-00031b30: 7461 626c 6528 7265 7375 6c74 293a 0a20  table(result):. 
-00031b40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00031b50: 7761 6974 2072 6573 756c 740a 0a20 2020  wait result..   
-00031b60: 2020 2020 2073 656c 662e 6164 645f 706c       self.add_pl
-00031b70: 7567 696e 2870 6c75 6769 6e2c 206e 616d  ugin(plugin, nam
-00031b80: 653d 6e61 6d65 2c20 6964 656d 706f 7465  e=name, idempote
-00031b90: 6e74 3d69 6465 6d70 6f74 656e 7429 0a0a  nt=idempotent)..
-00031ba0: 2020 2020 6465 6620 776f 726b 6572 5f73      def worker_s
-00031bb0: 656e 6428 7365 6c66 2c20 776f 726b 6572  end(self, worker
-00031bc0: 3a20 7374 722c 206d 7367 3a20 6469 6374  : str, msg: dict
-00031bd0: 5b73 7472 2c20 416e 795d 2920 2d3e 204e  [str, Any]) -> N
-00031be0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00031bf0: 5365 6e64 206d 6573 7361 6765 2074 6f20  Send message to 
-00031c00: 776f 726b 6572 0a0a 2020 2020 2020 2020  worker..        
-00031c10: 5468 6973 2061 6c73 6f20 6861 6e64 6c65  This also handle
-00031c20: 7320 636f 6e6e 6563 7469 6f6e 2066 6169  s connection fai
-00031c30: 6c75 7265 7320 6279 2061 6464 696e 6720  lures by adding 
-00031c40: 6120 6361 6c6c 6261 636b 2074 6f20 7265  a callback to re
-00031c50: 6d6f 7665 0a20 2020 2020 2020 2074 6865  move.        the
-00031c60: 2077 6f72 6b65 7220 6f6e 2074 6865 206e   worker on the n
-00031c70: 6578 7420 6379 636c 652e 0a20 2020 2020  ext cycle..     
-00031c80: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-00031c90: 7472 6561 6d5f 636f 6d6d 733a 2064 6963  tream_comms: dic
-00031ca0: 7420 3d20 7365 6c66 2e73 7472 6561 6d5f  t = self.stream_
-00031cb0: 636f 6d6d 730a 2020 2020 2020 2020 7472  comms.        tr
-00031cc0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-00031cd0: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
-00031ce0: 6572 5d2e 7365 6e64 286d 7367 290a 2020  er].send(msg).  
-00031cf0: 2020 2020 2020 6578 6365 7074 2028 436f        except (Co
-00031d00: 6d6d 436c 6f73 6564 4572 726f 722c 2041  mmClosedError, A
-00031d10: 7474 7269 6275 7465 4572 726f 7229 3a0a  ttributeError):.
-00031d20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031d30: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
-00031d40: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
-00031d50: 736f 6f6e 280a 2020 2020 2020 2020 2020  soon(.          
-00031d60: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00031d70: 655f 776f 726b 6572 2c0a 2020 2020 2020  e_worker,.      
-00031d80: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00031d90: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
-00031da0: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
-00031db0: 7573 5f69 643d 6622 776f 726b 6572 2d73  us_id=f"worker-s
-00031dc0: 656e 642d 636f 6d6d 2d66 6169 6c2d 7b74  end-comm-fail-{t
-00031dd0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
-00031de0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00031df0: 636c 6965 6e74 5f73 656e 6428 7365 6c66  client_send(self
-00031e00: 2c20 636c 6965 6e74 2c20 6d73 6729 3a0a  , client, msg):.
-00031e10: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
-00031e20: 6d65 7373 6167 6520 746f 2063 6c69 656e  message to clien
-00031e30: 7422 2222 0a20 2020 2020 2020 2063 6c69  t""".        cli
-00031e40: 656e 745f 636f 6d6d 733a 2064 6963 7420  ent_comms: dict 
-00031e50: 3d20 7365 6c66 2e63 6c69 656e 745f 636f  = self.client_co
-00031e60: 6d6d 730a 2020 2020 2020 2020 6320 3d20  mms.        c = 
-00031e70: 636c 6965 6e74 5f63 6f6d 6d73 2e67 6574  client_comms.get
-00031e80: 2863 6c69 656e 7429 0a20 2020 2020 2020  (client).       
-00031e90: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
-00031ea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00031eb0: 6e0a 2020 2020 2020 2020 7472 793a 0a20  n.        try:. 
-00031ec0: 2020 2020 2020 2020 2020 2063 2e73 656e             c.sen
-00031ed0: 6428 6d73 6729 0a20 2020 2020 2020 2065  d(msg).        e
-00031ee0: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
-00031ef0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00031f00: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
-00031f10: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00031f20: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00031f30: 2020 2020 206c 6f67 6765 722e 6372 6974       logger.crit
-00031f40: 6963 616c 280a 2020 2020 2020 2020 2020  ical(.          
-00031f50: 2020 2020 2020 2020 2020 2243 6c6f 7365            "Close
-00031f60: 6420 636f 6d6d 2025 7220 7768 696c 6520  d comm %r while 
-00031f70: 7472 7969 6e67 2074 6f20 7772 6974 6520  trying to write 
-00031f80: 2573 222c 2063 2c20 6d73 672c 2065 7863  %s", c, msg, exc
-00031f90: 5f69 6e66 6f3d 5472 7565 0a20 2020 2020  _info=True.     
-00031fa0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00031fb0: 2020 6465 6620 7365 6e64 5f61 6c6c 2873    def send_all(s
-00031fc0: 656c 662c 2063 6c69 656e 745f 6d73 6773  elf, client_msgs
-00031fd0: 3a20 4d73 6773 2c20 776f 726b 6572 5f6d  : Msgs, worker_m
-00031fe0: 7367 733a 204d 7367 7329 202d 3e20 4e6f  sgs: Msgs) -> No
-00031ff0: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
-00032000: 656e 6420 6d65 7373 6167 6573 2074 6f20  end messages to 
-00032010: 636c 6965 6e74 2061 6e64 2077 6f72 6b65  client and worke
-00032020: 7273 2222 220a 0a20 2020 2020 2020 2066  rs"""..        f
-00032030: 6f72 2063 6c69 656e 742c 206d 7367 7320  or client, msgs 
-00032040: 696e 2063 6c69 656e 745f 6d73 6773 2e69  in client_msgs.i
-00032050: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00032060: 2020 2020 6320 3d20 7365 6c66 2e63 6c69      c = self.cli
-00032070: 656e 745f 636f 6d6d 732e 6765 7428 636c  ent_comms.get(cl
-00032080: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
-00032090: 2020 6966 2063 2069 7320 4e6f 6e65 3a0a    if c is None:.
-000320a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320b0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000320c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000320d0: 2020 2020 2020 2020 2020 632e 7365 6e64            c.send
-000320e0: 282a 6d73 6773 290a 2020 2020 2020 2020  (*msgs).        
-000320f0: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
-00032100: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
-00032110: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00032120: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
-00032130: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-00032140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032150: 2020 6c6f 6767 6572 2e63 7269 7469 6361    logger.critica
-00032160: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00032170: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
-00032180: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
-00032190: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
-000321a0: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-000321b0: 2020 2020 2020 2020 2020 2020 2020 632c                c,
-000321c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000321d0: 2020 2020 2020 2020 206d 7367 732c 0a20           msgs,. 
-000321e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000321f0: 2020 2020 2020 2065 7863 5f69 6e66 6f3d         exc_info=
-00032200: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00032210: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00032220: 2020 2020 2066 6f72 2077 6f72 6b65 722c       for worker,
-00032230: 206d 7367 7320 696e 2077 6f72 6b65 725f   msgs in worker_
-00032240: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-00032250: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00032260: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00032270: 203d 2073 656c 662e 7374 7265 616d 5f63   = self.stream_c
-00032280: 6f6d 6d73 5b77 6f72 6b65 725d 0a20 2020  omms[worker].   
-00032290: 2020 2020 2020 2020 2020 2020 2077 2e73               w.s
-000322a0: 656e 6428 2a6d 7367 7329 0a20 2020 2020  end(*msgs).     
-000322b0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-000322c0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-000322d0: 2020 2020 2020 2020 2320 776f 726b 6572          # worker
-000322e0: 2061 6c72 6561 6479 2067 6f6e 650a 2020   already gone.  
-000322f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00032300: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00032310: 7863 6570 7420 2843 6f6d 6d43 6c6f 7365  xcept (CommClose
-00032320: 6445 7272 6f72 2c20 4174 7472 6962 7574  dError, Attribut
-00032330: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00032340: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
-00032350: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
-00032360: 645f 7461 736b 732e 6361 6c6c 5f73 6f6f  d_tasks.call_soo
-00032370: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00032380: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-00032390: 7665 5f77 6f72 6b65 722c 0a20 2020 2020  ve_worker,.     
-000323a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000323b0: 6464 7265 7373 3d77 6f72 6b65 722c 0a20  ddress=worker,. 
-000323c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323d0: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
-000323e0: 2273 656e 642d 616c 6c2d 636f 6d6d 2d66  "send-all-comm-f
-000323f0: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
-00032400: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00032410: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-00032420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032430: 2323 0a20 2020 2023 204c 6573 7320 636f  ##.    # Less co
-00032440: 6d6d 6f6e 2069 6e74 6572 6163 7469 6f6e  mmon interaction
-00032450: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
-00032460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00032470: 2323 2323 0a0a 2020 2020 6173 796e 6320  ####..    async 
-00032480: 6465 6620 7363 6174 7465 7228 0a20 2020  def scatter(.   
-00032490: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000324a0: 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020     comm=None,.  
-000324b0: 2020 2020 2020 6461 7461 3d4e 6f6e 652c        data=None,
-000324c0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-000324d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2063  =None,.        c
-000324e0: 6c69 656e 743d 4e6f 6e65 2c0a 2020 2020  lient=None,.    
-000324f0: 2020 2020 6272 6f61 6463 6173 743d 4661      broadcast=Fa
-00032500: 6c73 652c 0a20 2020 2020 2020 2074 696d  lse,.        tim
-00032510: 656f 7574 3d32 2c0a 2020 2020 293a 0a20  eout=2,.    ):. 
-00032520: 2020 2020 2020 2022 2222 5365 6e64 2064         """Send d
-00032530: 6174 6120 6f75 7420 746f 2077 6f72 6b65  ata out to worke
-00032540: 7273 0a0a 2020 2020 2020 2020 5365 6520  rs..        See 
-00032550: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-00032560: 2d2d 2d2d 2d0a 2020 2020 2020 2020 5363  -----.        Sc
-00032570: 6865 6475 6c65 722e 6272 6f61 6463 6173  heduler.broadcas
-00032580: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-00032590: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-000325a0: 696d 6528 290a 2020 2020 2020 2020 7768  ime().        wh
-000325b0: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
-000325c0: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-000325d0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000325e0: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
-000325f0: 7365 6c66 2e72 756e 6e69 6e67 0a20 2020  self.running.   
-00032600: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00032610: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00032620: 6f72 6b65 7273 203d 205b 7365 6c66 2e63  orkers = [self.c
-00032630: 6f65 7263 655f 6164 6472 6573 7328 7729  oerce_address(w)
-00032640: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
-00032650: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
-00032660: 2020 2077 7373 203d 207b 7365 6c66 2e77     wss = {self.w
-00032670: 6f72 6b65 7273 5b77 5d20 666f 7220 7720  orkers[w] for w 
-00032680: 696e 2077 6f72 6b65 7273 7d0a 2020 2020  in workers}.    
-00032690: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
-000326a0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
-000326b0: 7773 7320 6966 2077 732e 7374 6174 7573  wss if ws.status
-000326c0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-000326d0: 6e67 7d0a 0a20 2020 2020 2020 2020 2020  ng}..           
-000326e0: 2069 6620 7773 733a 0a20 2020 2020 2020   if wss:.       
-000326f0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-00032700: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
-00032710: 6d65 2829 203e 2073 7461 7274 202b 2074  me() > start + t
-00032720: 696d 656f 7574 3a0a 2020 2020 2020 2020  imeout:.        
-00032730: 2020 2020 2020 2020 7261 6973 6520 5469          raise Ti
-00032740: 6d65 6f75 7445 7272 6f72 2822 4e6f 2076  meoutError("No v
-00032750: 616c 6964 2077 6f72 6b65 7273 2066 6f75  alid workers fou
-00032760: 6e64 2229 0a20 2020 2020 2020 2020 2020  nd").           
-00032770: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
-00032780: 6c65 6570 2830 2e31 290a 0a20 2020 2020  leep(0.1)..     
-00032790: 2020 206e 7468 7265 6164 7320 3d20 7b77     nthreads = {w
-000327a0: 732e 6164 6472 6573 733a 2077 732e 6e74  s.address: ws.nt
-000327b0: 6872 6561 6473 2066 6f72 2077 7320 696e  hreads for ws in
-000327c0: 2077 7373 7d0a 0a20 2020 2020 2020 2061   wss}..        a
-000327d0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-000327e0: 2864 6174 612c 2064 6963 7429 0a0a 2020  (data, dict)..  
-000327f0: 2020 2020 2020 6b65 7973 2c20 7768 6f5f        keys, who_
-00032800: 6861 732c 206e 6279 7465 7320 3d20 6177  has, nbytes = aw
-00032810: 6169 7420 7363 6174 7465 725f 746f 5f77  ait scatter_to_w
-00032820: 6f72 6b65 7273 286e 7468 7265 6164 732c  orkers(nthreads,
-00032830: 2064 6174 612c 2072 7063 3d73 656c 662e   data, rpc=self.
-00032840: 7270 6329 0a0a 2020 2020 2020 2020 7365  rpc)..        se
-00032850: 6c66 2e75 7064 6174 655f 6461 7461 2877  lf.update_data(w
-00032860: 686f 5f68 6173 3d77 686f 5f68 6173 2c20  ho_has=who_has, 
-00032870: 6e62 7974 6573 3d6e 6279 7465 732c 2063  nbytes=nbytes, c
-00032880: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
-00032890: 2020 2020 2020 2069 6620 6272 6f61 6463         if broadc
-000328a0: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
-000328b0: 206e 203d 206c 656e 286e 7468 7265 6164   n = len(nthread
-000328c0: 7329 2069 6620 6272 6f61 6463 6173 7420  s) if broadcast 
-000328d0: 6973 2054 7275 6520 656c 7365 2062 726f  is True else bro
-000328e0: 6164 6361 7374 0a20 2020 2020 2020 2020  adcast.         
-000328f0: 2020 2061 7761 6974 2073 656c 662e 7265     await self.re
-00032900: 706c 6963 6174 6528 6b65 7973 3d6b 6579  plicate(keys=key
-00032910: 732c 2077 6f72 6b65 7273 3d77 6f72 6b65  s, workers=worke
-00032920: 7273 2c20 6e3d 6e29 0a0a 2020 2020 2020  rs, n=n)..      
-00032930: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00032940: 280a 2020 2020 2020 2020 2020 2020 5b63  (.            [c
-00032950: 6c69 656e 742c 2022 616c 6c22 5d2c 207b  lient, "all"], {
-00032960: 2261 6374 696f 6e22 3a20 2273 6361 7474  "action": "scatt
-00032970: 6572 222c 2022 636c 6965 6e74 223a 2063  er", "client": c
-00032980: 6c69 656e 742c 2022 636f 756e 7422 3a20  lient, "count": 
-00032990: 6c65 6e28 6461 7461 297d 0a20 2020 2020  len(data)}.     
-000329a0: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
-000329b0: 7572 6e20 6b65 7973 0a0a 2020 2020 6173  urn keys..    as
-000329c0: 796e 6320 6465 6620 6761 7468 6572 2873  ync def gather(s
-000329d0: 656c 662c 206b 6579 732c 2073 6572 6961  elf, keys, seria
-000329e0: 6c69 7a65 7273 3d4e 6f6e 6529 3a0a 2020  lizers=None):.  
-000329f0: 2020 2020 2020 2222 2243 6f6c 6c65 6374        """Collect
-00032a00: 2064 6174 6120 6672 6f6d 2077 6f72 6b65   data from worke
-00032a10: 7273 2074 6f20 7468 6520 7363 6865 6475  rs to the schedu
-00032a20: 6c65 7222 2222 0a20 2020 2020 2020 2073  ler""".        s
-00032a30: 7469 6d75 6c75 735f 6964 203d 2066 2267  timulus_id = f"g
-00032a40: 6174 6865 722d 7b74 696d 6528 297d 220a  ather-{time()}".
-00032a50: 2020 2020 2020 2020 6b65 7973 203d 206c          keys = l
-00032a60: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
-00032a70: 2020 7768 6f5f 6861 7320 3d20 7b7d 0a20    who_has = {}. 
-00032a80: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00032a90: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-00032aa0: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
-00032ab0: 6520 3d20 7365 6c66 2e74 6173 6b73 2e67  e = self.tasks.g
-00032ac0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-00032ad0: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
-00032ae0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00032af0: 2020 2020 2020 2077 686f 5f68 6173 5b6b         who_has[k
-00032b00: 6579 5d20 3d20 5b77 732e 6164 6472 6573  ey] = [ws.addres
-00032b10: 7320 666f 7220 7773 2069 6e20 7473 2e77  s for ws in ts.w
-00032b20: 686f 5f68 6173 5d0a 2020 2020 2020 2020  ho_has].        
-00032b30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00032b40: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
-00032b50: 735b 6b65 795d 203d 205b 5d0a 0a20 2020  s[key] = []..   
-00032b60: 2020 2020 2064 6174 612c 206d 6973 7369       data, missi
-00032b70: 6e67 5f6b 6579 732c 206d 6973 7369 6e67  ng_keys, missing
-00032b80: 5f77 6f72 6b65 7273 203d 2061 7761 6974  _workers = await
-00032b90: 2067 6174 6865 725f 6672 6f6d 5f77 6f72   gather_from_wor
-00032ba0: 6b65 7273 280a 2020 2020 2020 2020 2020  kers(.          
-00032bb0: 2020 7768 6f5f 6861 732c 2072 7063 3d73    who_has, rpc=s
-00032bc0: 656c 662e 7270 632c 2063 6c6f 7365 3d46  elf.rpc, close=F
-00032bd0: 616c 7365 2c20 7365 7269 616c 697a 6572  alse, serializer
-00032be0: 733d 7365 7269 616c 697a 6572 730a 2020  s=serializers.  
-00032bf0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00032c00: 6966 206e 6f74 206d 6973 7369 6e67 5f6b  if not missing_k
-00032c10: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-00032c20: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
-00032c30: 7573 223a 2022 4f4b 222c 2022 6461 7461  us": "OK", "data
-00032c40: 223a 2064 6174 617d 0a20 2020 2020 2020  ": data}.       
-00032c50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00032c60: 2020 206d 6973 7369 6e67 5f73 7461 7465     missing_state
-00032c70: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00032c80: 2020 2020 2020 2873 656c 662e 7461 736b        (self.task
-00032c90: 735b 6b65 795d 2e73 7461 7465 2069 6620  s[key].state if 
-00032ca0: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
-00032cb0: 7320 656c 7365 204e 6f6e 6529 0a20 2020  s else None).   
-00032cc0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00032cd0: 206b 6579 2069 6e20 6d69 7373 696e 675f   key in missing_
-00032ce0: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
-00032cf0: 205d 0a20 2020 2020 2020 2020 2020 206c   ].            l
-00032d00: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00032d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032d20: 2022 436f 756c 646e 2774 2067 6174 6865   "Couldn't gathe
-00032d30: 7220 6b65 7973 2025 7320 7374 6174 653a  r keys %s state:
-00032d40: 2025 7320 776f 726b 6572 733a 2025 7322   %s workers: %s"
-00032d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032d60: 2020 6d69 7373 696e 675f 6b65 7973 2c0a    missing_keys,.
-00032d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d80: 6d69 7373 696e 675f 7374 6174 6573 2c0a  missing_states,.
-00032d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032da0: 6d69 7373 696e 675f 776f 726b 6572 732c  missing_workers,
-00032db0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00032dc0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00032dd0: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
-00032de0: 6572 726f 7222 2c20 226b 6579 7322 3a20  error", "keys": 
-00032df0: 6d69 7373 696e 675f 6b65 7973 7d0a 2020  missing_keys}.  
-00032e00: 2020 2020 2020 2020 2020 7769 7468 206c            with l
-00032e10: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
-00032e20: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-00032e30: 656d 6f76 6520 7375 7370 6963 696f 7573  emove suspicious
-00032e40: 2077 6f72 6b65 7273 2066 726f 6d20 7468   workers from th
-00032e50: 6520 7363 6865 6475 6c65 7220 616e 6420  e scheduler and 
-00032e60: 7368 7574 2074 6865 6d20 646f 776e 2e0a  shut them down..
-00032e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e80: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00032e90: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00032ea0: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
-00032eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ec0: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
-00032ed0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-00032ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ef0: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-00032f00: 6b65 722c 2063 6c6f 7365 3d54 7275 652c  ker, close=True,
-00032f10: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-00032f20: 6d75 6c75 735f 6964 0a20 2020 2020 2020  mulus_id.       
-00032f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00032f50: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-00032f60: 6f72 6b65 7220 696e 206d 6973 7369 6e67  orker in missing
-00032f70: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-00032f80: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00032f90: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00032fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032fb0: 2066 6f72 206b 6579 2c20 776f 726b 6572   for key, worker
-00032fc0: 7320 696e 206d 6973 7369 6e67 5f6b 6579  s in missing_key
-00032fd0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00032fe0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00032ff0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00033000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033010: 2020 2020 2020 2020 2022 5368 7574 2064           "Shut d
-00033020: 6f77 6e20 776f 726b 6572 7320 7468 6174  own workers that
-00033030: 2064 6f6e 2774 2068 6176 6520 7072 6f6d   don't have prom
-00033040: 6973 6564 206b 6579 3a20 2573 2c20 2573  ised key: %s, %s
-00033050: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00033060: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
-00033070: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
-00033080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033090: 2073 7472 286b 6579 292c 0a20 2020 2020   str(key),.     
-000330a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000330b0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-000330c0: 6f67 5f65 7665 6e74 2822 616c 6c22 2c20  og_event("all", 
-000330d0: 7b22 6163 7469 6f6e 223a 2022 6761 7468  {"action": "gath
-000330e0: 6572 222c 2022 636f 756e 7422 3a20 6c65  er", "count": le
-000330f0: 6e28 6b65 7973 297d 290a 2020 2020 2020  n(keys)}).      
-00033100: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-00033110: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-00033120: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-00033130: 6573 7461 7274 2873 656c 662c 2063 6c69  estart(self, cli
-00033140: 656e 743d 4e6f 6e65 2c20 7469 6d65 6f75  ent=None, timeou
-00033150: 743d 3330 2c20 7761 6974 5f66 6f72 5f77  t=30, wait_for_w
-00033160: 6f72 6b65 7273 3d54 7275 6529 3a0a 2020  orkers=True):.  
-00033170: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00033180: 2020 5265 7374 6172 7420 616c 6c20 776f    Restart all wo
-00033190: 726b 6572 732e 2052 6573 6574 206c 6f63  rkers. Reset loc
-000331a0: 616c 2073 7461 7465 2e20 4f70 7469 6f6e  al state. Option
-000331b0: 616c 6c79 2077 6169 7420 666f 7220 776f  ally wait for wo
-000331c0: 726b 6572 7320 746f 2072 6574 7572 6e2e  rkers to return.
-000331d0: 0a0a 2020 2020 2020 2020 576f 726b 6572  ..        Worker
-000331e0: 7320 7769 7468 6f75 7420 6e61 6e6e 6965  s without nannie
-000331f0: 7320 6172 6520 7368 7574 2064 6f77 6e2c  s are shut down,
-00033200: 2068 6f70 696e 6720 616e 2065 7874 6572   hoping an exter
-00033210: 6e61 6c20 6465 706c 6f79 6d65 6e74 2073  nal deployment s
-00033220: 7973 7465 6d0a 2020 2020 2020 2020 7769  ystem.        wi
-00033230: 6c6c 2072 6573 7461 7274 2074 6865 6d2e  ll restart them.
-00033240: 2054 6865 7265 666f 7265 2c20 6966 206e   Therefore, if n
-00033250: 6f74 2075 7369 6e67 206e 616e 6e69 6573  ot using nannies
-00033260: 2061 6e64 2079 6f75 7220 6465 706c 6f79   and your deploy
-00033270: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
-00033280: 2020 2020 646f 6573 206e 6f74 2061 7574      does not aut
-00033290: 6f6d 6174 6963 616c 6c79 2072 6573 7461  omatically resta
-000332a0: 7274 2077 6f72 6b65 7273 2c20 6060 7265  rt workers, ``re
-000332b0: 7374 6172 7460 6020 7769 6c6c 206a 7573  start`` will jus
-000332c0: 7420 7368 7574 2064 6f77 6e20 616c 6c0a  t shut down all.
-000332d0: 2020 2020 2020 2020 776f 726b 6572 732c          workers,
-000332e0: 2074 6865 6e20 7469 6d65 206f 7574 210a   then time out!.
-000332f0: 0a20 2020 2020 2020 2041 6674 6572 2060  .        After `
-00033300: 6072 6573 7461 7274 6060 2c20 616c 6c20  `restart``, all 
-00033310: 636f 6e6e 6563 7465 6420 776f 726b 6572  connected worker
-00033320: 7320 6172 6520 6e65 772c 2072 6567 6172  s are new, regar
-00033330: 646c 6573 7320 6f66 2077 6865 7468 6572  dless of whether
-00033340: 2060 6054 696d 656f 7574 4572 726f 7260   ``TimeoutError`
-00033350: 600a 2020 2020 2020 2020 7761 7320 7261  `.        was ra
-00033360: 6973 6564 2e20 416e 7920 776f 726b 6572  ised. Any worker
-00033370: 7320 7468 6174 2066 6169 6c65 6420 746f  s that failed to
-00033380: 2073 6875 7420 646f 776e 2069 6e20 7469   shut down in ti
-00033390: 6d65 2061 7265 2072 656d 6f76 6564 2c20  me are removed, 
-000333a0: 616e 640a 2020 2020 2020 2020 6d61 7920  and.        may 
-000333b0: 6f72 206d 6179 206e 6f74 2073 6875 7420  or may not shut 
-000333c0: 646f 776e 206f 6e20 7468 6569 7220 6f77  down on their ow
-000333d0: 6e20 696e 2074 6865 2066 7574 7572 652e  n in the future.
-000333e0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-000333f0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00033400: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00033410: 7469 6d65 6f75 743a 0a20 2020 2020 2020  timeout:.       
-00033420: 2020 2020 2048 6f77 206c 6f6e 6720 746f       How long to
-00033430: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
-00033440: 7320 746f 2073 6875 7420 646f 776e 2061  s to shut down a
-00033450: 6e64 2063 6f6d 6520 6261 636b 2c20 6966  nd come back, if
-00033460: 2060 6077 6169 745f 666f 725f 776f 726b   ``wait_for_work
-00033470: 6572 7360 600a 2020 2020 2020 2020 2020  ers``.          
-00033480: 2020 6973 2054 7275 652c 206f 7468 6572    is True, other
-00033490: 7769 7365 206a 7573 7420 686f 7720 6c6f  wise just how lo
-000334a0: 6e67 2074 6f20 7761 6974 2066 6f72 2077  ng to wait for w
-000334b0: 6f72 6b65 7273 2074 6f20 7368 7574 2064  orkers to shut d
-000334c0: 6f77 6e2e 0a20 2020 2020 2020 2020 2020  own..           
-000334d0: 2052 6169 7365 7320 6060 6173 796e 6369   Raises ``asynci
-000334e0: 6f2e 5469 6d65 6f75 7445 7272 6f72 6060  o.TimeoutError``
-000334f0: 2069 6620 7468 6973 2069 7320 6578 6365   if this is exce
-00033500: 6564 6564 2e0a 2020 2020 2020 2020 7761  eded..        wa
-00033510: 6974 5f66 6f72 5f77 6f72 6b65 7273 3a0a  it_for_workers:.
-00033520: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
-00033530: 6865 7220 746f 2077 6169 7420 666f 7220  her to wait for 
-00033540: 616c 6c20 776f 726b 6572 7320 746f 2072  all workers to r
-00033550: 6563 6f6e 6e65 6374 2c20 6f72 206a 7573  econnect, or jus
-00033560: 7420 666f 7220 7468 656d 2074 6f20 7368  t for them to sh
-00033570: 7574 2064 6f77 6e0a 2020 2020 2020 2020  ut down.        
-00033580: 2020 2020 2864 6566 6175 6c74 2054 7275      (default Tru
-00033590: 6529 2e20 5573 6520 6060 7265 7374 6172  e). Use ``restar
-000335a0: 7428 7761 6974 5f66 6f72 5f77 6f72 6b65  t(wait_for_worke
-000335b0: 7273 3d46 616c 7365 2960 6020 636f 6d62  rs=False)`` comb
-000335c0: 696e 6564 2077 6974 680a 2020 2020 2020  ined with.      
-000335d0: 2020 2020 2020 3a6d 6574 683a 6043 6c69        :meth:`Cli
-000335e0: 656e 742e 7761 6974 5f66 6f72 5f77 6f72  ent.wait_for_wor
-000335f0: 6b65 7273 6020 666f 7220 6772 616e 756c  kers` for granul
-00033600: 6172 2063 6f6e 7472 6f6c 206f 7665 7220  ar control over 
-00033610: 686f 7720 6d61 6e79 2077 6f72 6b65 7273  how many workers
-00033620: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-00033630: 7761 6974 2066 6f72 2e0a 0a20 2020 2020  wait for...     
-00033640: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-00033650: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00033660: 2020 2020 2043 6c69 656e 742e 7265 7374       Client.rest
-00033670: 6172 740a 2020 2020 2020 2020 436c 6965  art.        Clie
-00033680: 6e74 2e72 6573 7461 7274 5f77 6f72 6b65  nt.restart_worke
-00033690: 7273 0a20 2020 2020 2020 2022 2222 0a20  rs.        """. 
-000336a0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-000336b0: 6964 203d 2066 2272 6573 7461 7274 2d7b  id = f"restart-{
-000336c0: 7469 6d65 2829 7d22 0a0a 2020 2020 2020  time()}"..      
-000336d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-000336e0: 6573 7461 7274 696e 6720 776f 726b 6572  estarting worker
-000336f0: 7320 616e 6420 7265 6c65 6173 696e 6720  s and releasing 
-00033700: 616c 6c20 6b65 7973 2e22 290a 2020 2020  all keys.").    
-00033710: 2020 2020 666f 7220 6373 2069 6e20 7365      for cs in se
-00033720: 6c66 2e63 6c69 656e 7473 2e76 616c 7565  lf.clients.value
-00033730: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00033740: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
-00033750: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
-00033760: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00033770: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
-00033780: 696e 2063 732e 7761 6e74 735f 7768 6174  in cs.wants_what
-00033790: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000337a0: 2020 2063 6c69 656e 743d 6373 2e63 6c69     client=cs.cli
-000337b0: 656e 745f 6b65 792c 0a20 2020 2020 2020  ent_key,.       
-000337c0: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-000337d0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-000337e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-000337f0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
-00033800: 6c65 6172 5f74 6173 6b5f 7374 6174 6528  lear_task_state(
-00033810: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00033820: 206e 6f74 2073 656c 662e 7461 736b 730a   not self.tasks.
-00033830: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-00033840: 6f72 7428 7b22 6f70 223a 2022 7265 7374  ort({"op": "rest
-00033850: 6172 7422 7d29 0a0a 2020 2020 2020 2020  art"})..        
-00033860: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-00033870: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-00033880: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
-00033890: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000338a0: 2020 2020 2020 2020 2020 2020 706c 7567              plug
-000338b0: 696e 2e72 6573 7461 7274 2873 656c 6629  in.restart(self)
-000338c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000338d0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-000338e0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000338f0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-00033900: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
-00033910: 206e 5f77 6f72 6b65 7273 203d 206c 656e   n_workers = len
-00033920: 2873 656c 662e 776f 726b 6572 7329 0a20  (self.workers). 
-00033930: 2020 2020 2020 206e 616e 6e79 5f77 6f72         nanny_wor
-00033940: 6b65 7273 203d 207b 0a20 2020 2020 2020  kers = {.       
-00033950: 2020 2020 2061 6464 723a 2077 732e 6e61       addr: ws.na
-00033960: 6e6e 7920 666f 7220 6164 6472 2c20 7773  nny for addr, ws
-00033970: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00033980: 2e69 7465 6d73 2829 2069 6620 7773 2e6e  .items() if ws.n
-00033990: 616e 6e79 0a20 2020 2020 2020 207d 0a20  anny.        }. 
-000339a0: 2020 2020 2020 2023 2043 6c6f 7365 206e         # Close n
-000339b0: 6f6e 2d4e 616e 6e79 2077 6f72 6b65 7273  on-Nanny workers
-000339c0: 2e20 5765 2068 6176 6520 6e6f 2077 6179  . We have no way
-000339d0: 2074 6f20 7265 7374 6172 7420 7468 656d   to restart them
-000339e0: 2c20 736f 2077 6520 6a75 7374 206c 6574  , so we just let
-000339f0: 2074 6865 6d20 676f 2c0a 2020 2020 2020   them go,.      
-00033a00: 2020 2320 616e 6420 6173 7375 6d65 2061    # and assume a
-00033a10: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
-00033a20: 656d 2069 7320 676f 696e 6720 746f 2072  em is going to r
-00033a30: 6573 7461 7274 2074 6865 6d20 666f 7220  estart them for 
-00033a40: 7573 2e0a 2020 2020 2020 2020 6177 6169  us..        awai
-00033a50: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-00033a60: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-00033a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033a80: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-00033a90: 6b65 7228 6164 6472 6573 733d 6164 6472  ker(address=addr
-00033aa0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-00033ab0: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
-00033ac0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-00033ad0: 6464 7220 696e 2073 656c 662e 776f 726b  ddr in self.work
-00033ae0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-00033af0: 2020 2020 6966 2061 6464 7220 6e6f 7420      if addr not 
-00033b00: 696e 206e 616e 6e79 5f77 6f72 6b65 7273  in nanny_workers
-00033b10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00033b20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00033b30: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-00033b40: 5365 6e64 206b 696c 6c20 7369 676e 616c  Send kill signal
-00033b50: 2074 6f20 6e61 6e6e 6965 733a 2025 7322   to nannies: %s"
-00033b60: 2c20 6e61 6e6e 795f 776f 726b 6572 7329  , nanny_workers)
-00033b70: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00033b80: 6974 6820 636f 6e74 6578 746c 6962 2e41  ith contextlib.A
-00033b90: 7379 6e63 4578 6974 5374 6163 6b28 2920  syncExitStack() 
-00033ba0: 6173 2073 7461 636b 3a0a 2020 2020 2020  as stack:.      
-00033bb0: 2020 2020 2020 6e61 6e6e 6965 7320 3d20        nannies = 
-00033bc0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00033bd0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00033be0: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
-00033bf0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00033c00: 636b 2e65 6e74 6572 5f61 7379 6e63 5f63  ck.enter_async_c
-00033c10: 6f6e 7465 7874 280a 2020 2020 2020 2020  ontext(.        
-00033c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033c30: 7270 6328 6e61 6e6e 795f 6164 6472 6573  rpc(nanny_addres
-00033c40: 732c 2063 6f6e 6e65 6374 696f 6e5f 6172  s, connection_ar
-00033c50: 6773 3d73 656c 662e 636f 6e6e 6563 7469  gs=self.connecti
-00033c60: 6f6e 5f61 7267 7329 0a20 2020 2020 2020  on_args).       
-00033c70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00033c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033c90: 2020 2066 6f72 206e 616e 6e79 5f61 6464     for nanny_add
-00033ca0: 7265 7373 2069 6e20 6e61 6e6e 795f 776f  ress in nanny_wo
-00033cb0: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-00033cc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00033cd0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00033ce0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00033cf0: 7420 3d20 6d6f 6e6f 746f 6e69 6328 290a  t = monotonic().
-00033d00: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00033d10: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
-00033d20: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00033d30: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
-00033d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033d50: 2077 6169 745f 666f 7228 0a20 2020 2020   wait_for(.     
-00033d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033d70: 2020 2023 2046 4958 4d45 2064 6f65 7320     # FIXME does 
-00033d80: 6e6f 7420 7261 6973 6520 6966 2074 6865  not raise if the
-00033d90: 2070 726f 6365 7373 2066 6169 6c73 2074   process fails t
-00033da0: 6f20 7368 7574 2064 6f77 6e2c 0a20 2020  o shut down,.   
-00033db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033dc0: 2020 2020 2023 2073 6565 2068 7474 7073       # see https
-00033dd0: 3a2f 2f67 6974 6875 622e 636f 6d2f 6461  ://github.com/da
-00033de0: 736b 2f64 6973 7472 6962 7574 6564 2f70  sk/distributed/p
-00033df0: 756c 6c2f 3634 3237 2f66 696c 6573 2372  ull/6427/files#r
-00033e00: 3839 3439 3137 3432 340a 2020 2020 2020  894917424.      
-00033e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033e20: 2020 2320 4e4f 5445 3a20 4e61 6e6e 7920    # NOTE: Nanny 
-00033e30: 7769 6c6c 2061 7574 6f6d 6174 6963 616c  will automatical
-00033e40: 6c79 2072 6573 7461 7274 2077 6f72 6b65  ly restart worke
-00033e50: 7220 7072 6f63 6573 7320 7768 656e 2069  r process when i
-00033e60: 7427 7320 6b69 6c6c 6564 0a20 2020 2020  t's killed.     
-00033e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033e80: 2020 206e 616e 6e79 2e6b 696c 6c28 0a20     nanny.kill(. 
-00033e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ea0: 2020 2020 2020 2020 2020 2072 6561 736f             reaso
-00033eb0: 6e3d 2273 6368 6564 756c 6572 2d72 6573  n="scheduler-res
-00033ec0: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
-00033ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ee0: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
-00033ef0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00033f00: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-00033f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033f20: 2020 2020 2020 2074 696d 656f 7574 2c0a         timeout,.
-00033f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033f40: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00033f50: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
-00033f60: 6e6e 7920 696e 206e 616e 6e69 6573 0a20  nny in nannies. 
-00033f70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00033f80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00033f90: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-00033fa0: 6f6e 733d 5472 7565 2c0a 2020 2020 2020  ons=True,.      
-00033fb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00033fc0: 2020 2020 2320 4e4f 5445 3a20 7468 6520      # NOTE: the 
-00033fd0: 6057 6f72 6b65 7253 7461 7465 6020 656e  `WorkerState` en
-00033fe0: 7472 6965 7320 666f 7220 7468 6573 6520  tries for these 
-00033ff0: 776f 726b 6572 7320 7769 6c6c 2062 6520  workers will be 
-00034000: 7265 6d6f 7665 640a 2020 2020 2020 2020  removed.        
-00034010: 2020 2020 2320 6e61 7475 7261 6c6c 7920      # naturally 
-00034020: 7768 656e 2074 6865 7920 6469 7363 6f6e  when they discon
-00034030: 6e65 6374 2066 726f 6d20 7468 6520 7363  nect from the sc
-00034040: 6865 6475 6c65 722e 0a0a 2020 2020 2020  heduler...      
-00034050: 2020 2020 2020 2320 5265 6d6f 7665 2061        # Remove a
-00034060: 6e79 2077 6f72 6b65 7273 2074 6861 7420  ny workers that 
-00034070: 6661 696c 6564 2074 6f20 7368 7574 2064  failed to shut d
-00034080: 6f77 6e2c 2073 6f20 7765 2063 616e 2067  own, so we can g
-00034090: 7561 7261 6e74 6565 0a20 2020 2020 2020  uarantee.       
-000340a0: 2020 2020 2023 2074 6861 7420 6166 7465       # that afte
-000340b0: 7220 6072 6573 7461 7274 602c 2074 6865  r `restart`, the
-000340c0: 7265 2061 7265 206e 6f20 6f6c 6420 776f  re are no old wo
-000340d0: 726b 6572 7320 6172 6f75 6e64 2e0a 2020  rkers around..  
-000340e0: 2020 2020 2020 2020 2020 6261 645f 6e61            bad_na
-000340f0: 6e6e 6965 7320 3d20 5b0a 2020 2020 2020  nnies = [.      
-00034100: 2020 2020 2020 2020 2020 6164 6472 2066            addr f
-00034110: 6f72 2061 6464 722c 2072 6573 7020 696e  or addr, resp in
-00034120: 207a 6970 286e 616e 6e79 5f77 6f72 6b65   zip(nanny_worke
-00034130: 7273 2c20 7265 7370 7329 2069 6620 7265  rs, resps) if re
-00034140: 7370 2069 7320 6e6f 7420 4e6f 6e65 0a20  sp is not None. 
-00034150: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-00034160: 2020 2020 2020 2020 2069 6620 6261 645f           if bad_
-00034170: 6e61 6e6e 6965 733a 0a20 2020 2020 2020  nannies:.       
-00034180: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00034190: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-000341a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000341b0: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
-000341c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000341d0: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
-000341e0: 2861 6464 722c 2073 7469 6d75 6c75 735f  (addr, stimulus_
-000341f0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00034200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034210: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
-00034220: 2069 6e20 6261 645f 6e61 6e6e 6965 730a   in bad_nannies.
-00034230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034240: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00034250: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00034260: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-00034270: 696d 656f 7574 4572 726f 7228 0a20 2020  imeoutError(.   
-00034280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034290: 2066 227b 6c65 6e28 6261 645f 6e61 6e6e   f"{len(bad_nann
-000342a0: 6965 7329 7d2f 7b6c 656e 286e 616e 6e69  ies)}/{len(nanni
-000342b0: 6573 297d 206e 616e 6e79 2077 6f72 6b65  es)} nanny worke
-000342c0: 7228 7329 2064 6964 206e 6f74 2073 6875  r(s) did not shu
-000342d0: 7420 646f 776e 2077 6974 6869 6e20 7b74  t down within {t
-000342e0: 696d 656f 7574 7d73 220a 2020 2020 2020  imeout}s".      
-000342f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00034300: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00034310: 656e 7428 5b63 6c69 656e 742c 2022 616c  ent([client, "al
-00034320: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
-00034330: 2272 6573 7461 7274 222c 2022 636c 6965  "restart", "clie
-00034340: 6e74 223a 2063 6c69 656e 747d 290a 0a20  nt": client}).. 
-00034350: 2020 2020 2020 2069 6620 7761 6974 5f66         if wait_f
-00034360: 6f72 5f77 6f72 6b65 7273 3a0a 2020 2020  or_workers:.    
-00034370: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
-00034380: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-00034390: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
-000343a0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-000343b0: 4f54 453a 2069 6620 6e65 7720 2875 6e72  OTE: if new (unr
-000343c0: 656c 6174 6564 2920 776f 726b 6572 7320  elated) workers 
-000343d0: 6a6f 696e 2077 6869 6c65 2077 6527 7265  join while we're
-000343e0: 2077 6169 7469 6e67 2c20 7765 206d 6179   waiting, we may
-000343f0: 2072 6574 7572 6e20 6265 666f 7265 0a20   return before. 
-00034400: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00034410: 206f 7572 2073 6875 742d 646f 776e 2077   our shut-down w
-00034420: 6f72 6b65 7273 2068 6176 6520 636f 6d65  orkers have come
-00034430: 2062 6163 6b20 7570 2e20 5468 6174 2773   back up. That's
-00034440: 2066 696e 653b 2077 6f72 6b65 7273 2061   fine; workers a
-00034450: 7265 2069 6e74 6572 6368 616e 6765 6162  re interchangeab
-00034460: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
-00034470: 2020 2020 6966 206d 6f6e 6f74 6f6e 6963      if monotonic
-00034480: 2829 203c 2073 7461 7274 202b 2074 696d  () < start + tim
-00034490: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
-000344a0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000344b0: 6173 796e 6369 6f2e 736c 6565 7028 302e  asyncio.sleep(0.
-000344c0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000344d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000344e0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-000344f0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00034500: 2020 2020 2020 2020 2020 2020 2066 2257               f"W
-00034510: 6169 7465 6420 666f 7220 7b6e 5f77 6f72  aited for {n_wor
-00034520: 6b65 7273 7d20 776f 726b 6572 2873 2920  kers} worker(s) 
-00034530: 746f 2072 6563 6f6e 6e65 6374 2061 6674  to reconnect aft
-00034540: 6572 2072 6573 7461 7274 696e 672c 2022  er restarting, "
-00034550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034560: 2020 2020 2020 2020 2066 2262 7574 2061           f"but a
-00034570: 6674 6572 207b 7469 6d65 6f75 747d 732c  fter {timeout}s,
-00034580: 206f 6e6c 7920 7b6c 656e 2873 656c 662e   only {len(self.
-00034590: 776f 726b 6572 7329 7d20 6861 7665 2072  workers)} have r
-000345a0: 6574 7572 6e65 642e 2022 0a20 2020 2020  eturned. ".     
-000345b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000345c0: 2020 2022 436f 6e73 6964 6572 2061 206c     "Consider a l
-000345d0: 6f6e 6765 7220 7469 6d65 6f75 742c 206f  onger timeout, o
-000345e0: 7220 6077 6169 745f 666f 725f 776f 726b  r `wait_for_work
-000345f0: 6572 733d 4661 6c73 6560 2e22 0a20 2020  ers=False`.".   
-00034600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034610: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00034620: 2020 2020 2020 2020 6966 2028 6e5f 6e61          if (n_na
-00034630: 6e6e 7920 3a3d 206c 656e 286e 616e 6e79  nny := len(nanny
-00034640: 5f77 6f72 6b65 7273 2929 203c 206e 5f77  _workers)) < n_w
-00034650: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00034660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034670: 6d73 6720 2b3d 2028 0a20 2020 2020 2020  msg += (.       
-00034680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034690: 2020 2020 2066 2220 5468 6520 7b6e 5f77       f" The {n_w
-000346a0: 6f72 6b65 7273 202d 206e 5f6e 616e 6e79  orkers - n_nanny
-000346b0: 7d20 776f 726b 6572 2873 2920 6e6f 7420  } worker(s) not 
-000346c0: 7573 696e 6720 4e61 6e6e 6965 7320 7765  using Nannies we
-000346d0: 7265 206a 7573 7420 7368 7574 2022 0a20  re just shut ". 
+0002de00: 2020 2020 2273 656c 662e 7661 6c69 6461      "self.valida
+0002de10: 7465 5f25 7320 6e6f 7420 666f 756e 6422  te_%s not found"
+0002de20: 2c20 7473 2e73 7461 7465 2e72 6570 6c61  , ts.state.repla
+0002de30: 6365 2822 2d22 2c20 225f 2229 0a20 2020  ce("-", "_").   
+0002de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0002de60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002de70: 2020 2020 2020 2020 2020 2020 2066 756e               fun
+0002de80: 6328 6b65 7929 0a20 2020 2020 2020 2065  c(key).        e
+0002de90: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+0002dea0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0002deb0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+0002dec0: 6f6e 2865 290a 2020 2020 2020 2020 2020  on(e).          
+0002ded0: 2020 6966 204c 4f47 5f50 4442 3a0a 2020    if LOG_PDB:.  
+0002dee0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0002def0: 706f 7274 2070 6462 0a0a 2020 2020 2020  port pdb..      
+0002df00: 2020 2020 2020 2020 2020 7064 622e 7365            pdb.se
+0002df10: 745f 7472 6163 6528 290a 2020 2020 2020  t_trace().      
+0002df20: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
+0002df30: 2064 6566 2076 616c 6964 6174 655f 7374   def validate_st
+0002df40: 6174 6528 7365 6c66 2c20 616c 6c6f 775f  ate(self, allow_
+0002df50: 6f76 6572 6c61 703a 2062 6f6f 6c20 3d20  overlap: bool = 
+0002df60: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
+0002df70: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0002df80: 5f73 7461 7465 2873 656c 662e 7461 736b  _state(self.task
+0002df90: 732c 2073 656c 662e 776f 726b 6572 732c  s, self.workers,
+0002dfa0: 2073 656c 662e 636c 6965 6e74 7329 0a0a   self.clients)..
+0002dfb0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+0002dfc0: 7365 7428 7365 6c66 2e77 6f72 6b65 7273  set(self.workers
+0002dfd0: 2920 3d3d 2073 6574 2873 656c 662e 7374  ) == set(self.st
+0002dfe0: 7265 616d 5f63 6f6d 6d73 2929 3a0a 2020  ream_comms)):.  
+0002dff0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0002e000: 5661 6c75 6545 7272 6f72 2822 576f 726b  ValueError("Work
+0002e010: 6572 7320 6e6f 7420 7468 6520 7361 6d65  ers not the same
+0002e020: 2069 6e20 616c 6c20 636f 6c6c 6563 7469   in all collecti
+0002e030: 6f6e 7322 290a 0a20 2020 2020 2020 2061  ons")..        a
+0002e040: 7373 6572 7420 7365 6c66 2e72 756e 6e69  ssert self.runni
+0002e050: 6e67 2e69 7373 7570 6572 7365 7428 7365  ng.issuperset(se
+0002e060: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
+0002e070: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+0002e080: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
+0002e090: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
+0002e0a0: 2020 7365 7428 7365 6c66 2e69 646c 652e    set(self.idle.
+0002e0b0: 7661 6c75 6573 2829 292c 0a20 2020 2020  values()),.     
+0002e0c0: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+0002e0d0: 6572 7420 7365 6c66 2e72 756e 6e69 6e67  ert self.running
+0002e0e0: 2e69 7373 7570 6572 7365 7428 7365 6c66  .issuperset(self
+0002e0f0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+0002e100: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+0002e110: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
+0002e120: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
+0002e130: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
+0002e140: 5f63 6f75 6e74 2e63 6f70 7928 292c 0a20  _count.copy(),. 
+0002e150: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002e160: 2061 7373 6572 7420 7365 6c66 2e72 756e   assert self.run
+0002e170: 6e69 6e67 2e69 7373 7570 6572 7365 7428  ning.issuperset(
+0002e180: 7365 6c66 2e73 6174 7572 6174 6564 292c  self.saturated),
+0002e190: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
+0002e1a0: 656c 662e 7275 6e6e 696e 672e 636f 7079  elf.running.copy
+0002e1b0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0002e1c0: 7365 6c66 2e73 6174 7572 6174 6564 2e63  self.saturated.c
+0002e1d0: 6f70 7928 292c 0a20 2020 2020 2020 2029  opy(),.        )
+0002e1e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002e1f0: 7365 6c66 2e73 6174 7572 6174 6564 2e69  self.saturated.i
+0002e200: 7364 6973 6a6f 696e 7428 7365 6c66 2e69  sdisjoint(self.i
+0002e210: 646c 652e 7661 6c75 6573 2829 292c 2028  dle.values()), (
+0002e220: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002e230: 662e 7361 7475 7261 7465 642e 636f 7079  f.saturated.copy
+0002e240: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0002e250: 7365 7428 7365 6c66 2e69 646c 652e 7661  set(self.idle.va
+0002e260: 6c75 6573 2829 292c 0a20 2020 2020 2020  lues()),.       
+0002e270: 2029 0a0a 2020 2020 2020 2020 7461 736b   )..        task
+0002e280: 5f70 7265 6669 785f 636f 756e 7473 3a20  _prefix_counts: 
+0002e290: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+0002e2a0: 2069 6e74 5d20 3d20 6465 6661 756c 7464   int] = defaultd
+0002e2b0: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
+0002e2c0: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
+0002e2d0: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
+0002e2e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0002e2f0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0002e300: 6528 772c 2073 7472 292c 2028 7479 7065  e(w, str), (type
+0002e310: 2877 292c 2077 290a 2020 2020 2020 2020  (w), w).        
+0002e320: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0002e330: 7461 6e63 6528 7773 2c20 576f 726b 6572  tance(ws, Worker
+0002e340: 5374 6174 6529 2c20 2874 7970 6528 7773  State), (type(ws
+0002e350: 292c 2077 7329 0a20 2020 2020 2020 2020  ), ws).         
+0002e360: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
+0002e370: 7265 7373 203d 3d20 770a 0a20 2020 2020  ress == w..     
+0002e380: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
+0002e390: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+0002e3a0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
+0002e3b0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0002e3c0: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+0002e3d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002e3e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002e3f0: 2020 2061 7373 6572 7420 7773 206e 6f74     assert ws not
+0002e400: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+0002e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e420: 2061 7373 6572 7420 7773 2e61 6464 7265   assert ws.addre
+0002e430: 7373 206e 6f74 2069 6e20 7365 6c66 2e69  ss not in self.i
+0002e440: 646c 650a 2020 2020 2020 2020 2020 2020  dle.            
+0002e450: 2020 2020 6173 7365 7274 2077 7320 6e6f      assert ws no
+0002e460: 7420 696e 2073 656c 662e 7361 7475 7261  t in self.satura
+0002e470: 7465 640a 0a20 2020 2020 2020 2020 2020  ted..           
+0002e480: 2061 7373 6572 7420 7773 2e6c 6f6e 675f   assert ws.long_
+0002e490: 7275 6e6e 696e 672e 6973 7375 6273 6574  running.issubset
+0002e4a0: 2877 732e 7072 6f63 6573 7369 6e67 290a  (ws.processing).
+0002e4b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002e4c0: 6f74 2077 732e 7072 6f63 6573 7369 6e67  ot ws.processing
+0002e4d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e4e0: 2020 6173 7365 7274 206e 6f74 2077 732e    assert not ws.
+0002e4f0: 6f63 6375 7061 6e63 790a 2020 2020 2020  occupancy.      
+0002e500: 2020 2020 2020 2020 2020 6966 2077 732e            if ws.
+0002e510: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+0002e520: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+0002e530: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002e540: 7365 7274 2077 732e 6164 6472 6573 7320  sert ws.address 
+0002e550: 696e 2073 656c 662e 6964 6c65 0a20 2020  in self.idle.   
+0002e560: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002e570: 6e6f 7420 7773 2e6e 6565 6473 5f77 6861  not ws.needs_wha
+0002e580: 742e 6b65 7973 2829 2026 2077 732e 6861  t.keys() & ws.ha
+0002e590: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
+0002e5a0: 2020 2061 6374 7561 6c5f 6e65 6564 735f     actual_needs_
+0002e5b0: 7768 6174 3a20 6465 6661 756c 7464 6963  what: defaultdic
+0002e5c0: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
+0002e5d0: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
+0002e5e0: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
+0002e5f0: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
+0002e600: 6f63 6573 7369 6e67 3a0a 2020 2020 2020  ocessing:.      
+0002e610: 2020 2020 2020 2020 2020 666f 7220 7473            for ts
+0002e620: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002e630: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+0002e640: 2020 2020 2020 2020 2020 6966 2074 7373            if tss
+0002e650: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
+0002e660: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
+0002e670: 2020 2020 2020 2020 2020 2020 2061 6374               act
+0002e680: 7561 6c5f 6e65 6564 735f 7768 6174 5b74  ual_needs_what[t
+0002e690: 7373 5d20 2b3d 2031 0a20 2020 2020 2020  ss] += 1.       
+0002e6a0: 2020 2020 2061 7373 6572 7420 6163 7475       assert actu
+0002e6b0: 616c 5f6e 6565 6473 5f77 6861 7420 3d3d  al_needs_what ==
+0002e6c0: 2077 732e 6e65 6564 735f 7768 6174 0a20   ws.needs_what. 
+0002e6d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002e6e0: 7420 2877 732e 7374 6174 7573 203d 3d20  t (ws.status == 
+0002e6f0: 5374 6174 7573 2e72 756e 6e69 6e67 2920  Status.running) 
+0002e700: 3d3d 2028 7773 2069 6e20 7365 6c66 2e72  == (ws in self.r
+0002e710: 756e 6e69 6e67 290a 2020 2020 2020 2020  unning).        
+0002e720: 2020 2020 666f 7220 6e61 6d65 2c20 636f      for name, co
+0002e730: 756e 7420 696e 2077 732e 7461 736b 5f70  unt in ws.task_p
+0002e740: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
+0002e750: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0002e760: 2020 2020 2074 6173 6b5f 7072 6566 6978       task_prefix
+0002e770: 5f63 6f75 6e74 735b 6e61 6d65 5d20 2b3d  _counts[name] +=
+0002e780: 2063 6f75 6e74 0a0a 2020 2020 2020 2020   count..        
+0002e790: 6173 7365 7274 2074 6173 6b5f 7072 6566  assert task_pref
+0002e7a0: 6978 5f63 6f75 6e74 732e 6b65 7973 2829  ix_counts.keys()
+0002e7b0: 203d 3d20 7365 6c66 2e5f 7461 736b 5f70   == self._task_p
+0002e7c0: 7265 6669 785f 636f 756e 745f 676c 6f62  refix_count_glob
+0002e7d0: 616c 2e6b 6579 7328 290a 2020 2020 2020  al.keys().      
+0002e7e0: 2020 666f 7220 6e61 6d65 2c20 676c 6f62    for name, glob
+0002e7f0: 616c 5f63 6f75 6e74 2069 6e20 7365 6c66  al_count in self
+0002e800: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
+0002e810: 756e 745f 676c 6f62 616c 2e69 7465 6d73  unt_global.items
+0002e820: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0002e830: 6173 7365 7274 2028 0a20 2020 2020 2020  assert (.       
+0002e840: 2020 2020 2020 2020 2074 6173 6b5f 7072           task_pr
+0002e850: 6566 6978 5f63 6f75 6e74 735b 6e61 6d65  efix_counts[name
+0002e860: 5d20 3d3d 2067 6c6f 6261 6c5f 636f 756e  ] == global_coun
+0002e870: 740a 2020 2020 2020 2020 2020 2020 292c  t.            ),
+0002e880: 2066 227b 6e61 6d65 7d3a 207b 7461 736b   f"{name}: {task
+0002e890: 5f70 7265 6669 785f 636f 756e 7473 5b6e  _prefix_counts[n
+0002e8a0: 616d 655d 7d20 2877 7373 292c 207b 676c  ame]} (wss), {gl
+0002e8b0: 6f62 616c 5f63 6f75 6e74 7d20 2867 6c6f  obal_count} (glo
+0002e8c0: 6261 6c29 220a 0a20 2020 2020 2020 2066  bal)"..        f
+0002e8d0: 6f72 2077 7320 696e 2073 656c 662e 7275  or ws in self.ru
+0002e8e0: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
+0002e8f0: 2020 2061 7373 6572 7420 7773 2e73 7461     assert ws.sta
+0002e900: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+0002e910: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
+0002e920: 2020 6173 7365 7274 2077 732e 6164 6472    assert ws.addr
+0002e930: 6573 7320 696e 2073 656c 662e 776f 726b  ess in self.work
+0002e940: 6572 730a 0a20 2020 2020 2020 2066 6f72  ers..        for
+0002e950: 206b 2c20 7473 2069 6e20 7365 6c66 2e74   k, ts in self.t
+0002e960: 6173 6b73 2e69 7465 6d73 2829 3a0a 2020  asks.items():.  
+0002e970: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e980: 2069 7369 6e73 7461 6e63 6528 7473 2c20   isinstance(ts, 
+0002e990: 5461 736b 5374 6174 6529 2c20 2874 7970  TaskState), (typ
+0002e9a0: 6528 7473 292c 2074 7329 0a20 2020 2020  e(ts), ts).     
+0002e9b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002e9c0: 2e6b 6579 203d 3d20 6b0a 2020 2020 2020  .key == k.      
+0002e9d0: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
+0002e9e0: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
+0002e9f0: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
+0002ea00: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
+0002ea10: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
+0002ea20: 2020 2020 7365 6c66 2e76 616c 6964 6174      self.validat
+0002ea30: 655f 6b65 7928 6b2c 2074 7329 0a0a 2020  e_key(k, ts)..  
+0002ea40: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0002ea50: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
+0002ea60: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+0002ea70: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
+0002ea80: 7465 203d 3d20 226d 656d 6f72 7922 0a20  te == "memory". 
+0002ea90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002eaa0: 7420 7473 2e6b 6579 2069 6e20 7365 6c66  t ts.key in self
+0002eab0: 2e74 6173 6b73 0a0a 2020 2020 2020 2020  .tasks..        
+0002eac0: 666f 7220 632c 2063 7320 696e 2073 656c  for c, cs in sel
+0002ead0: 662e 636c 6965 6e74 732e 6974 656d 7328  f.clients.items(
+0002eae0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0002eaf0: 2063 6c69 656e 743d 4e6f 6e65 2069 7320   client=None is 
+0002eb00: 6f66 7465 6e20 7573 6564 2069 6e20 7465  often used in te
+0002eb10: 7374 732e 2e2e 0a20 2020 2020 2020 2020  sts....         
+0002eb20: 2020 2061 7373 6572 7420 6320 6973 204e     assert c is N
+0002eb30: 6f6e 6520 6f72 2074 7970 6528 6329 203d  one or type(c) =
+0002eb40: 3d20 7374 722c 2028 7479 7065 2863 292c  = str, (type(c),
+0002eb50: 2063 290a 2020 2020 2020 2020 2020 2020   c).            
+0002eb60: 6173 7365 7274 2074 7970 6528 6373 2920  assert type(cs) 
+0002eb70: 3d3d 2043 6c69 656e 7453 7461 7465 2c20  == ClientState, 
+0002eb80: 2874 7970 6528 6373 292c 2063 7329 0a20  (type(cs), cs). 
+0002eb90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002eba0: 7420 6373 2e63 6c69 656e 745f 6b65 7920  t cs.client_key 
+0002ebb0: 3d3d 2063 0a0a 2020 2020 2020 2020 6120  == c..        a 
+0002ebc0: 3d20 7b77 3a20 7773 2e6e 6279 7465 7320  = {w: ws.nbytes 
+0002ebd0: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
+0002ebe0: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
+0002ebf0: 297d 0a20 2020 2020 2020 2062 203d 207b  )}.        b = {
+0002ec00: 0a20 2020 2020 2020 2020 2020 2077 3a20  .            w: 
+0002ec10: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
+0002ec20: 7328 2920 666f 7220 7473 2069 6e20 7773  s() for ts in ws
+0002ec30: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
+0002ec40: 2020 2020 2020 2066 6f72 2077 2c20 7773         for w, ws
+0002ec50: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002ec60: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+0002ec70: 207d 0a20 2020 2020 2020 2061 7373 6572   }.        asser
+0002ec80: 7420 6120 3d3d 2062 2c20 2861 2c20 6229  t a == b, (a, b)
+0002ec90: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0002eca0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+0002ecb0: 6e74 6572 5f6d 6178 3a0a 2020 2020 2020  nter_max:.      
+0002ecc0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0002ecd0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+0002ece0: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
+0002ecf0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
+0002ed00: 6178 0a0a 2020 2020 2323 2323 2323 2323  ax..    ########
+0002ed10: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0002ed20: 2320 4d61 6e61 6765 204d 6573 7361 6765  # Manage Message
+0002ed30: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+0002ed40: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+0002ed50: 2064 6566 2072 6570 6f72 7428 0a20 2020   def report(.   
+0002ed60: 2020 2020 2073 656c 662c 206d 7367 3a20       self, msg: 
+0002ed70: 6469 6374 2c20 7473 3a20 5461 736b 5374  dict, ts: TaskSt
+0002ed80: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
+0002ed90: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
+0002eda0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
+0002edb0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0002edc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002edd0: 5075 626c 6973 6820 7570 6461 7465 7320  Publish updates 
+0002ede0: 746f 2061 6c6c 206c 6973 7465 6e69 6e67  to all listening
+0002edf0: 2051 7565 7565 7320 616e 6420 436f 6d6d   Queues and Comm
+0002ee00: 730a 0a20 2020 2020 2020 2049 6620 7468  s..        If th
+0002ee10: 6520 6d65 7373 6167 6520 636f 6e74 6169  e message contai
+0002ee20: 6e73 2061 206b 6579 2074 6865 6e20 7765  ns a key then we
+0002ee30: 206f 6e6c 7920 7365 6e64 2074 6865 206d   only send the m
+0002ee40: 6573 7361 6765 2074 6f20 7468 6f73 650a  essage to those.
+0002ee50: 2020 2020 2020 2020 636f 6d6d 7320 7468          comms th
+0002ee60: 6174 2063 6172 6520 6162 6f75 7420 7468  at care about th
+0002ee70: 6520 6b65 792e 0a20 2020 2020 2020 2022  e key..        "
+0002ee80: 2222 0a20 2020 2020 2020 2069 6620 7473  "".        if ts
+0002ee90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0002eea0: 2020 2020 2020 6d73 675f 6b65 7920 3d20        msg_key = 
+0002eeb0: 6d73 672e 6765 7428 226b 6579 2229 0a20  msg.get("key"). 
+0002eec0: 2020 2020 2020 2020 2020 2069 6620 6d73             if ms
+0002eed0: 675f 6b65 7920 6973 206e 6f74 204e 6f6e  g_key is not Non
+0002eee0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002eef0: 2020 2074 6173 6b73 3a20 6469 6374 203d     tasks: dict =
+0002ef00: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
+0002ef10: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0002ef20: 2074 6173 6b73 2e67 6574 286d 7367 5f6b   tasks.get(msg_k
+0002ef30: 6579 290a 0a20 2020 2020 2020 2063 6c69  ey)..        cli
+0002ef40: 656e 745f 636f 6d6d 733a 2064 6963 7420  ent_comms: dict 
+0002ef50: 3d20 7365 6c66 2e63 6c69 656e 745f 636f  = self.client_co
+0002ef60: 6d6d 730a 2020 2020 2020 2020 6966 2074  mms.        if t
+0002ef70: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0002ef80: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
+0002ef90: 616c 6c20 636c 6965 6e74 730a 2020 2020  all clients.    
+0002efa0: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
+0002efb0: 6579 7320 3d20 6c69 7374 2863 6c69 656e  eys = list(clien
+0002efc0: 745f 636f 6d6d 7329 0a20 2020 2020 2020  t_comms).       
+0002efd0: 2065 6c69 6620 636c 6965 6e74 2069 7320   elif client is 
+0002efe0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002eff0: 2020 2320 4e6f 7469 6679 2063 6c69 656e    # Notify clien
+0002f000: 7473 2069 6e74 6572 6573 7465 6420 696e  ts interested in
+0002f010: 206b 6579 0a20 2020 2020 2020 2020 2020   key.           
+0002f020: 2063 6c69 656e 745f 6b65 7973 203d 205b   client_keys = [
+0002f030: 6373 2e63 6c69 656e 745f 6b65 7920 666f  cs.client_key fo
+0002f040: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
+0002f050: 616e 7473 5d0a 2020 2020 2020 2020 656c  ants].        el
+0002f060: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002f070: 2320 4e6f 7469 6679 2063 6c69 656e 7473  # Notify clients
+0002f080: 2069 6e74 6572 6573 7465 6420 696e 206b   interested in k
+0002f090: 6579 2028 696e 636c 7564 696e 6720 6063  ey (including `c
+0002f0a0: 6c69 656e 7460 290a 2020 2020 2020 2020  lient`).        
+0002f0b0: 2020 2020 636c 6965 6e74 5f6b 6579 7320      client_keys 
+0002f0c0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0002f0d0: 2020 2020 6373 2e63 6c69 656e 745f 6b65      cs.client_ke
+0002f0e0: 7920 666f 7220 6373 2069 6e20 7473 2e77  y for cs in ts.w
+0002f0f0: 686f 5f77 616e 7473 2069 6620 6373 2e63  ho_wants if cs.c
+0002f100: 6c69 656e 745f 6b65 7920 213d 2063 6c69  lient_key != cli
+0002f110: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0002f120: 5d0a 2020 2020 2020 2020 2020 2020 636c  ].            cl
+0002f130: 6965 6e74 5f6b 6579 732e 6170 7065 6e64  ient_keys.append
+0002f140: 2863 6c69 656e 7429 0a0a 2020 2020 2020  (client)..      
+0002f150: 2020 6b3a 2073 7472 0a20 2020 2020 2020    k: str.       
+0002f160: 2066 6f72 206b 2069 6e20 636c 6965 6e74   for k in client
+0002f170: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
+0002f180: 2020 2063 203d 2063 6c69 656e 745f 636f     c = client_co
+0002f190: 6d6d 732e 6765 7428 6b29 0a20 2020 2020  mms.get(k).     
+0002f1a0: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
+0002f1b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0002f1c0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+0002f1d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0002f1e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002f1f0: 2e73 656e 6428 6d73 6729 0a20 2020 2020  .send(msg).     
+0002f200: 2020 2020 2020 2020 2020 2023 206c 6f67             # log
+0002f210: 6765 722e 6465 6275 6728 2253 6368 6564  ger.debug("Sched
+0002f220: 756c 6572 2073 656e 6473 206d 6573 7361  uler sends messa
+0002f230: 6765 2074 6f20 636c 6965 6e74 2025 7322  ge to client %s"
+0002f240: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
+0002f250: 2020 2065 7863 6570 7420 436f 6d6d 436c     except CommCl
+0002f260: 6f73 6564 4572 726f 723a 0a20 2020 2020  osedError:.     
+0002f270: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0002f280: 6c66 2e73 7461 7475 7320 3d3d 2053 7461  lf.status == Sta
+0002f290: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+0002f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2b0: 206c 6f67 6765 722e 6372 6974 6963 616c   logger.critical
+0002f2c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002f2d0: 2020 2020 2020 2020 2020 2243 6c6f 7365            "Close
+0002f2e0: 6420 636f 6d6d 2025 7220 7768 696c 6520  d comm %r while 
+0002f2f0: 7472 7969 6e67 2074 6f20 7772 6974 6520  trying to write 
+0002f300: 2573 222c 2063 2c20 6d73 672c 2065 7863  %s", c, msg, exc
+0002f310: 5f69 6e66 6f3d 5472 7565 0a20 2020 2020  _info=True.     
+0002f320: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0002f330: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+0002f340: 6164 645f 636c 6965 6e74 280a 2020 2020  add_client(.    
+0002f350: 2020 2020 7365 6c66 2c20 636f 6d6d 3a20      self, comm: 
+0002f360: 436f 6d6d 2c20 636c 6965 6e74 3a20 7374  Comm, client: st
+0002f370: 722c 2076 6572 7369 6f6e 733a 2064 6963  r, versions: dic
+0002f380: 745b 7374 722c 2041 6e79 5d0a 2020 2020  t[str, Any].    
+0002f390: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002f3a0: 2020 2022 2222 4164 6420 636c 6965 6e74     """Add client
+0002f3b0: 2074 6f20 6e65 7477 6f72 6b0a 0a20 2020   to network..   
+0002f3c0: 2020 2020 2057 6520 6c69 7374 656e 2074       We listen t
+0002f3d0: 6f20 616c 6c20 6675 7475 7265 206d 6573  o all future mes
+0002f3e0: 7361 6765 7320 6672 6f6d 2074 6869 7320  sages from this 
+0002f3f0: 436f 6d6d 2e0a 2020 2020 2020 2020 2222  Comm..        ""
+0002f400: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
+0002f410: 2063 6c69 656e 7420 6973 206e 6f74 204e   client is not N
+0002f420: 6f6e 650a 2020 2020 2020 2020 636f 6d6d  one.        comm
+0002f430: 2e6e 616d 6520 3d20 2253 6368 6564 756c  .name = "Schedul
+0002f440: 6572 2d3e 436c 6965 6e74 220a 2020 2020  er->Client".    
+0002f450: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002f460: 2252 6563 6569 7665 2063 6c69 656e 7420  "Receive client 
+0002f470: 636f 6e6e 6563 7469 6f6e 3a20 2573 222c  connection: %s",
+0002f480: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
+0002f490: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+0002f4a0: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
+0002f4b0: 207b 2261 6374 696f 6e22 3a20 2261 6464   {"action": "add
+0002f4c0: 2d63 6c69 656e 7422 2c20 2263 6c69 656e  -client", "clien
+0002f4d0: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
+0002f4e0: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
+0002f4f0: 735b 636c 6965 6e74 5d20 3d20 436c 6965  s[client] = Clie
+0002f500: 6e74 5374 6174 6528 636c 6965 6e74 2c20  ntState(client, 
+0002f510: 7665 7273 696f 6e73 3d76 6572 7369 6f6e  versions=version
+0002f520: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
+0002f530: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
+0002f540: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
+0002f550: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
+0002f560: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0002f570: 2020 2020 2020 2020 706c 7567 696e 2e61          plugin.a
+0002f580: 6464 5f63 6c69 656e 7428 7363 6865 6475  dd_client(schedu
+0002f590: 6c65 723d 7365 6c66 2c20 636c 6965 6e74  ler=self, client
+0002f5a0: 3d63 6c69 656e 7429 0a20 2020 2020 2020  =client).       
+0002f5b0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0002f5c0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+0002f5d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002f5e0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+0002f5f0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0002f600: 2020 2020 2020 2020 2020 6263 6f6d 6d20            bcomm 
+0002f610: 3d20 4261 7463 6865 6453 656e 6428 696e  = BatchedSend(in
+0002f620: 7465 7276 616c 3d22 326d 7322 2c20 6c6f  terval="2ms", lo
+0002f630: 6f70 3d73 656c 662e 6c6f 6f70 290a 2020  op=self.loop).  
+0002f640: 2020 2020 2020 2020 2020 6263 6f6d 6d2e            bcomm.
+0002f650: 7374 6172 7428 636f 6d6d 290a 2020 2020  start(comm).    
+0002f660: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0002f670: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
+0002f680: 5d20 3d20 6263 6f6d 6d0a 2020 2020 2020  ] = bcomm.      
+0002f690: 2020 2020 2020 6d73 6720 3d20 7b22 6f70        msg = {"op
+0002f6a0: 223a 2022 7374 7265 616d 2d73 7461 7274  ": "stream-start
+0002f6b0: 227d 0a20 2020 2020 2020 2020 2020 2076  "}.            v
+0002f6c0: 6572 7369 6f6e 5f77 6172 6e69 6e67 203d  ersion_warning =
+0002f6d0: 2076 6572 7369 6f6e 5f6d 6f64 756c 652e   version_module.
+0002f6e0: 6572 726f 725f 6d65 7373 6167 6528 0a20  error_message(. 
+0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0002f700: 6572 7369 6f6e 5f6d 6f64 756c 652e 6765  ersion_module.ge
+0002f710: 745f 7665 7273 696f 6e73 2829 2c0a 2020  t_versions(),.  
+0002f720: 2020 2020 2020 2020 2020 2020 2020 7b77                {w
+0002f730: 3a20 7773 2e76 6572 7369 6f6e 7320 666f  : ws.versions fo
+0002f740: 7220 772c 2077 7320 696e 2073 656c 662e  r w, ws in self.
+0002f750: 776f 726b 6572 732e 6974 656d 7328 297d  workers.items()}
+0002f760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f770: 2020 7665 7273 696f 6e73 2c0a 2020 2020    versions,.    
+0002f780: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002f790: 2020 2020 2020 6d73 672e 7570 6461 7465        msg.update
+0002f7a0: 2876 6572 7369 6f6e 5f77 6172 6e69 6e67  (version_warning
+0002f7b0: 290a 2020 2020 2020 2020 2020 2020 6263  ).            bc
+0002f7c0: 6f6d 6d2e 7365 6e64 286d 7367 290a 0a20  omm.send(msg).. 
+0002f7d0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7f0: 6177 6169 7420 7365 6c66 2e68 616e 646c  await self.handl
+0002f800: 655f 7374 7265 616d 2863 6f6d 6d3d 636f  e_stream(comm=co
+0002f810: 6d6d 2c20 6578 7472 613d 7b22 636c 6965  mm, extra={"clie
+0002f820: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
+0002f830: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
+0002f840: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002f850: 2020 2073 656c 662e 7265 6d6f 7665 5f63     self.remove_c
+0002f860: 6c69 656e 7428 636c 6965 6e74 3d63 6c69  lient(client=cli
+0002f870: 656e 742c 2073 7469 6d75 6c75 735f 6964  ent, stimulus_id
+0002f880: 3d66 2272 656d 6f76 652d 636c 6965 6e74  =f"remove-client
+0002f890: 2d7b 7469 6d65 2829 7d22 290a 2020 2020  -{time()}").    
+0002f8a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002f8b0: 6572 2e64 6562 7567 2822 4669 6e69 7368  er.debug("Finish
+0002f8c0: 6564 2068 616e 646c 696e 6720 636c 6965  ed handling clie
+0002f8d0: 6e74 2025 7322 2c20 636c 6965 6e74 290a  nt %s", client).
+0002f8e0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
+0002f8f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002f900: 6e6f 7420 636f 6d6d 2e63 6c6f 7365 6428  not comm.closed(
+0002f910: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002f920: 2020 2073 656c 662e 636c 6965 6e74 5f63     self.client_c
+0002f930: 6f6d 6d73 5b63 6c69 656e 745d 2e73 656e  omms[client].sen
+0002f940: 6428 7b22 6f70 223a 2022 7374 7265 616d  d({"op": "stream
+0002f950: 2d63 6c6f 7365 6422 7d29 0a20 2020 2020  -closed"}).     
+0002f960: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002f970: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002f980: 6f74 2073 7973 2e69 735f 6669 6e61 6c69  ot sys.is_finali
+0002f990: 7a69 6e67 2829 3a0a 2020 2020 2020 2020  zing():.        
+0002f9a0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0002f9b0: 7420 7365 6c66 2e63 6c69 656e 745f 636f  t self.client_co
+0002f9c0: 6d6d 735b 636c 6965 6e74 5d2e 636c 6f73  mms[client].clos
+0002f9d0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0002f9e0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+0002f9f0: 2e63 6c69 656e 745f 636f 6d6d 735b 636c  .client_comms[cl
+0002fa00: 6965 6e74 5d0a 2020 2020 2020 2020 2020  ient].          
+0002fa10: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0002fa20: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
+0002fa30: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+0002fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fa50: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002fa60: 2243 6c6f 7365 2063 6c69 656e 7420 636f  "Close client co
+0002fa70: 6e6e 6563 7469 6f6e 3a20 2573 222c 2063  nnection: %s", c
+0002fa80: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
+0002fa90: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
+0002faa0: 726f 723a 2020 2320 636f 6d6d 2062 6563  ror:  # comm bec
+0002fab0: 6f6d 6573 204e 6f6e 6520 6475 7269 6e67  omes None during
+0002fac0: 2047 430a 2020 2020 2020 2020 2020 2020   GC.            
+0002fad0: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
+0002fae0: 6620 7265 6d6f 7665 5f63 6c69 656e 7428  f remove_client(
+0002faf0: 7365 6c66 2c20 636c 6965 6e74 3a20 7374  self, client: st
+0002fb00: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+0002fb10: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+0002fb20: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0002fb30: 2020 2020 2222 2252 656d 6f76 6520 636c      """Remove cl
+0002fb40: 6965 6e74 2066 726f 6d20 6e65 7477 6f72  ient from networ
+0002fb50: 6b22 2222 0a20 2020 2020 2020 2073 7469  k""".        sti
+0002fb60: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
+0002fb70: 6c75 735f 6964 206f 7220 6622 7265 6d6f  lus_id or f"remo
+0002fb80: 7665 2d63 6c69 656e 742d 7b74 696d 6528  ve-client-{time(
+0002fb90: 297d 220a 2020 2020 2020 2020 6966 2073  )}".        if s
+0002fba0: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
+0002fbb0: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
+0002fbc0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002fbd0: 2e69 6e66 6f28 2252 656d 6f76 6520 636c  .info("Remove cl
+0002fbe0: 6965 6e74 2025 7322 2c20 636c 6965 6e74  ient %s", client
+0002fbf0: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+0002fc00: 6f67 5f65 7665 6e74 285b 2261 6c6c 222c  og_event(["all",
+0002fc10: 2063 6c69 656e 745d 2c20 7b22 6163 7469   client], {"acti
+0002fc20: 6f6e 223a 2022 7265 6d6f 7665 2d63 6c69  on": "remove-cli
+0002fc30: 656e 7422 2c20 2263 6c69 656e 7422 3a20  ent", "client": 
+0002fc40: 636c 6965 6e74 7d29 0a20 2020 2020 2020  client}).       
+0002fc50: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002fc60: 2020 6373 3a20 436c 6965 6e74 5374 6174    cs: ClientStat
+0002fc70: 6520 3d20 7365 6c66 2e63 6c69 656e 7473  e = self.clients
+0002fc80: 5b63 6c69 656e 745d 0a20 2020 2020 2020  [client].       
+0002fc90: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+0002fca0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0002fcb0: 5858 5820 6973 2074 6869 7320 6120 6c65  XXX is this a le
+0002fcc0: 6769 7469 6d61 7465 2063 6f6e 6469 7469  gitimate conditi
+0002fcd0: 6f6e 3f0a 2020 2020 2020 2020 2020 2020  on?.            
+0002fce0: 7061 7373 0a20 2020 2020 2020 2065 6c73  pass.        els
+0002fcf0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0002fd00: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
+0002fd10: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
+0002fd20: 2020 2020 2020 2020 2020 6b65 7973 3d5b            keys=[
+0002fd30: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+0002fd40: 2063 732e 7761 6e74 735f 7768 6174 5d2c   cs.wants_what],
+0002fd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fd60: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
+0002fd70: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
+0002fd80: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+0002fd90: 6964 3d73 7469 6d75 6c75 735f 6964 2c0a  id=stimulus_id,.
+0002fda0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002fdb0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+0002fdc0: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
+0002fdd0: 745d 0a0a 2020 2020 2020 2020 2020 2020  t]..            
+0002fde0: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+0002fdf0: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+0002fe00: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
+0002fe10: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe30: 2020 2020 706c 7567 696e 2e72 656d 6f76      plugin.remov
+0002fe40: 655f 636c 6965 6e74 2873 6368 6564 756c  e_client(schedul
+0002fe50: 6572 3d73 656c 662c 2063 6c69 656e 743d  er=self, client=
+0002fe60: 636c 6965 6e74 290a 2020 2020 2020 2020  client).        
+0002fe70: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0002fe80: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0002fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fea0: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+0002feb0: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
+0002fec0: 6173 796e 6320 6465 6620 7265 6d6f 7665  async def remove
+0002fed0: 5f63 6c69 656e 745f 6672 6f6d 5f65 7665  _client_from_eve
+0002fee0: 6e74 7328 293a 0a20 2020 2020 2020 2020  nts():.         
+0002fef0: 2020 2023 2049 6620 7468 6520 636c 6965     # If the clie
+0002ff00: 6e74 2069 736e 2774 2072 6567 6973 7465  nt isn't registe
+0002ff10: 7265 6420 616e 796d 6f72 6520 6166 7465  red anymore afte
+0002ff20: 7220 7468 6520 6465 6c61 792c 2072 656d  r the delay, rem
+0002ff30: 6f76 6520 6672 6f6d 2065 7665 6e74 730a  ove from events.
+0002ff40: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0002ff50: 6c69 656e 7420 6e6f 7420 696e 2073 656c  lient not in sel
+0002ff60: 662e 636c 6965 6e74 7320 616e 6420 636c  f.clients and cl
+0002ff70: 6965 6e74 2069 6e20 7365 6c66 2e65 7665  ient in self.eve
+0002ff80: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0002ff90: 2020 2020 2064 656c 2073 656c 662e 6576       del self.ev
+0002ffa0: 656e 7473 5b63 6c69 656e 745d 0a0a 2020  ents[client]..  
+0002ffb0: 2020 2020 2020 636c 6561 6e75 705f 6465        cleanup_de
+0002ffc0: 6c61 7920 3d20 7061 7273 655f 7469 6d65  lay = parse_time
+0002ffd0: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
+0002ffe0: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
+0002fff0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00030000: 7363 6865 6475 6c65 722e 6576 656e 7473  scheduler.events
+00030010: 2d63 6c65 616e 7570 2d64 656c 6179 2229  -cleanup-delay")
+00030020: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00030030: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
+00030040: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
+00030050: 6e64 5f74 6173 6b73 2e63 6c6f 7365 643a  nd_tasks.closed:
+00030060: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00030070: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
+00030080: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
+00030090: 5f6c 6174 6572 280a 2020 2020 2020 2020  _later(.        
+000300a0: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
+000300b0: 6465 6c61 792c 2072 656d 6f76 655f 636c  delay, remove_cl
+000300c0: 6965 6e74 5f66 726f 6d5f 6576 656e 7473  ient_from_events
+000300d0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000300e0: 2020 2020 6465 6620 7365 6e64 5f74 6173      def send_tas
+000300f0: 6b5f 746f 5f77 6f72 6b65 7228 0a20 2020  k_to_worker(.   
+00030100: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
+00030110: 723a 2073 7472 2c20 7473 3a20 5461 736b  r: str, ts: Task
+00030120: 5374 6174 652c 2064 7572 6174 696f 6e3a  State, duration:
+00030130: 2066 6c6f 6174 203d 202d 310a 2020 2020   float = -1.    
+00030140: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00030150: 2020 2022 2222 5365 6e64 2061 2073 696e     """Send a sin
+00030160: 676c 6520 636f 6d70 7574 6174 696f 6e61  gle computationa
+00030170: 6c20 7461 736b 2074 6f20 6120 776f 726b  l task to a work
+00030180: 6572 2222 220a 2020 2020 2020 2020 7472  er""".        tr
+00030190: 793a 0a20 2020 2020 2020 2020 2020 206d  y:.            m
+000301a0: 7367 3a20 6469 6374 203d 2073 656c 662e  sg: dict = self.
+000301b0: 5f74 6173 6b5f 746f 5f6d 7367 2874 732c  _task_to_msg(ts,
+000301c0: 2064 7572 6174 696f 6e29 0a20 2020 2020   duration).     
+000301d0: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
+000301e0: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
+000301f0: 6d73 6729 0a20 2020 2020 2020 2065 7863  msg).        exc
+00030200: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+00030210: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00030220: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00030230: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
+00030240: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
+00030250: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+00030260: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
+00030270: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
+00030280: 7472 6163 6528 290a 2020 2020 2020 2020  trace().        
+00030290: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
+000302a0: 6566 2068 616e 646c 655f 756e 6361 7567  ef handle_uncaug
+000302b0: 6874 5f65 7272 6f72 2873 656c 662c 202a  ht_error(self, *
+000302c0: 2a6d 7367 3a20 416e 7929 202d 3e20 4e6f  *msg: Any) -> No
+000302d0: 6e65 3a0a 2020 2020 2020 2020 6c6f 6767  ne:.        logg
+000302e0: 6572 2e65 7863 6570 7469 6f6e 2863 6c65  er.exception(cle
+000302f0: 616e 5f65 7863 6570 7469 6f6e 282a 2a6d  an_exception(**m
+00030300: 7367 295b 315d 290a 0a20 2020 2064 6566  sg)[1])..    def
+00030310: 2068 616e 646c 655f 7461 736b 5f66 696e   handle_task_fin
+00030320: 6973 6865 6428 0a20 2020 2020 2020 2073  ished(.        s
+00030330: 656c 662c 206b 6579 3a20 7374 722c 2077  elf, key: str, w
+00030340: 6f72 6b65 723a 2073 7472 2c20 7374 696d  orker: str, stim
+00030350: 756c 7573 5f69 643a 2073 7472 2c20 2a2a  ulus_id: str, **
+00030360: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
+00030370: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00030380: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
+00030390: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
+000303a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000303b0: 6e0a 2020 2020 2020 2020 7661 6c69 6461  n.        valida
+000303c0: 7465 5f6b 6579 286b 6579 290a 0a20 2020  te_key(key)..   
+000303d0: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
+000303e0: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
+000303f0: 736b 5f66 696e 6973 6865 6428 0a20 2020  sk_finished(.   
+00030400: 2020 2020 2020 2020 206b 6579 3d6b 6579           key=key
+00030410: 2c20 776f 726b 6572 3d77 6f72 6b65 722c  , worker=worker,
+00030420: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+00030430: 6d75 6c75 735f 6964 2c20 2a2a 6d73 670a  mulus_id, **msg.
+00030440: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00030450: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00030460: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00030470: 776f 726b 6572 5f6d 7367 7320 3d20 720a  worker_msgs = r.
+00030480: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
+00030490: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
+000304a0: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+000304b0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+000304c0: 7367 732c 2073 7469 6d75 6c75 735f 6964  sgs, stimulus_id
+000304d0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+000304e0: 656e 645f 616c 6c28 636c 6965 6e74 5f6d  end_all(client_m
+000304f0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+00030500: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00030510: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
+00030520: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
+00030530: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
+00030540: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+00030550: 6465 6620 6861 6e64 6c65 5f74 6173 6b5f  def handle_task_
+00030560: 6572 7265 6428 7365 6c66 2c20 6b65 793a  erred(self, key:
+00030570: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00030580: 643a 2073 7472 2c20 2a2a 6d73 673a 2041  d: str, **msg: A
+00030590: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
+000305a0: 2020 2020 2072 3a20 7475 706c 6520 3d20       r: tuple = 
+000305b0: 7365 6c66 2e73 7469 6d75 6c75 735f 7461  self.stimulus_ta
+000305c0: 736b 5f65 7272 6564 286b 6579 3d6b 6579  sk_erred(key=key
+000305d0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
+000305e0: 696d 756c 7573 5f69 642c 202a 2a6d 7367  imulus_id, **msg
+000305f0: 290a 2020 2020 2020 2020 7265 636f 6d6d  ).        recomm
+00030600: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00030610: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00030620: 7367 7320 3d20 720a 2020 2020 2020 2020  sgs = r.        
+00030630: 7365 6c66 2e5f 7472 616e 7369 7469 6f6e  self._transition
+00030640: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
+00030650: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00030660: 776f 726b 6572 5f6d 7367 732c 2073 7469  worker_msgs, sti
+00030670: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
+00030680: 2020 7365 6c66 2e73 656e 645f 616c 6c28    self.send_all(
+00030690: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
+000306a0: 6b65 725f 6d73 6773 290a 0a20 2020 2020  ker_msgs)..     
+000306b0: 2020 2073 656c 662e 7374 696d 756c 7573     self.stimulus
+000306c0: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
+000306d0: 6265 5f6f 7065 6e65 6428 7374 696d 756c  be_opened(stimul
+000306e0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
+000306f0: 6429 0a0a 2020 2020 6465 6620 7265 6c65  d)..    def rele
+00030700: 6173 655f 776f 726b 6572 5f64 6174 6128  ase_worker_data(
+00030710: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00030720: 776f 726b 6572 3a20 7374 722c 2073 7469  worker: str, sti
+00030730: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
+00030740: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00030750: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
+00030760: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+00030770: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
+00030780: 7273 2e67 6574 2877 6f72 6b65 7229 0a20  rs.get(worker). 
+00030790: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+000307a0: 206f 7220 6e6f 7420 7773 206f 7220 7773   or not ws or ws
+000307b0: 206e 6f74 2069 6e20 7473 2e77 686f 5f68   not in ts.who_h
+000307c0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+000307d0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+000307e0: 7365 6c66 2e72 656d 6f76 655f 7265 706c  self.remove_repl
+000307f0: 6963 6128 7473 2c20 7773 290a 2020 2020  ica(ts, ws).    
+00030800: 2020 2020 6966 206e 6f74 2074 732e 7768      if not ts.wh
+00030810: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+00030820: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+00030830: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
+00030840: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
+00030850: 6964 290a 0a20 2020 2064 6566 2068 616e  id)..    def han
+00030860: 646c 655f 6c6f 6e67 5f72 756e 6e69 6e67  dle_long_running
+00030870: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00030880: 6b65 793a 2073 7472 2c20 776f 726b 6572  key: str, worker
+00030890: 3a20 7374 722c 2063 6f6d 7075 7465 5f64  : str, compute_d
+000308a0: 7572 6174 696f 6e3a 2066 6c6f 6174 207c  uration: float |
+000308b0: 204e 6f6e 652c 2073 7469 6d75 6c75 735f   None, stimulus_
+000308c0: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
+000308d0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+000308e0: 2222 4120 7461 736b 2068 6173 2073 6563  ""A task has sec
+000308f0: 6564 6564 2066 726f 6d20 7468 6520 7468  eded from the th
+00030900: 7265 6164 2070 6f6f 6c0a 0a20 2020 2020  read pool..     
+00030910: 2020 2057 6520 7374 6f70 2074 6865 2074     We stop the t
+00030920: 6173 6b20 6672 6f6d 2062 6569 6e67 2073  ask from being s
+00030930: 746f 6c65 6e20 696e 2074 6865 2066 7574  tolen in the fut
+00030940: 7572 652c 2061 6e64 2063 6861 6e67 6520  ure, and change 
+00030950: 7461 736b 0a20 2020 2020 2020 2064 7572  task.        dur
+00030960: 6174 696f 6e20 6163 636f 756e 7469 6e67  ation accounting
+00030970: 2061 7320 6966 2074 6865 2074 6173 6b20   as if the task 
+00030980: 6861 7320 7374 6f70 7065 642e 0a20 2020  has stopped..   
+00030990: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000309a0: 2069 6620 6b65 7920 6e6f 7420 696e 2073   if key not in s
+000309b0: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
+000309c0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+000309d0: 6275 6728 2253 6b69 7070 696e 6720 6c6f  bug("Skipping lo
+000309e0: 6e67 5f72 756e 6e69 6e67 2073 696e 6365  ng_running since
+000309f0: 206b 6579 2025 7320 7761 7320 616c 7265   key %s was alre
+00030a00: 6164 7920 7265 6c65 6173 6564 222c 206b  ady released", k
+00030a10: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+00030a20: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
+00030a30: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00030a40: 6579 5d0a 2020 2020 2020 2020 7374 6561  ey].        stea
+00030a50: 6c20 3d20 7365 6c66 2e65 7874 656e 7369  l = self.extensi
+00030a60: 6f6e 732e 6765 7428 2273 7465 616c 696e  ons.get("stealin
+00030a70: 6722 290a 2020 2020 2020 2020 6966 2073  g").        if s
+00030a80: 7465 616c 2069 7320 6e6f 7420 4e6f 6e65  teal is not None
+00030a90: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00030aa0: 6561 6c2e 7265 6d6f 7665 5f6b 6579 5f66  eal.remove_key_f
+00030ab0: 726f 6d5f 7374 6561 6c61 626c 6528 7473  rom_stealable(ts
+00030ac0: 290a 0a20 2020 2020 2020 2077 7320 3d20  )..        ws = 
+00030ad0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00030ae0: 0a20 2020 2020 2020 2069 6620 7773 2069  .        if ws i
+00030af0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00030b00: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00030b10: 2822 5265 6365 6976 6564 206c 6f6e 672d  ("Received long-
+00030b20: 7275 6e6e 696e 6720 7369 676e 616c 2066  running signal f
+00030b30: 726f 6d20 6475 706c 6963 6174 6520 7461  rom duplicate ta
+00030b40: 736b 2e20 4967 6e6f 7269 6e67 2e22 290a  sk. Ignoring.").
+00030b50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00030b60: 726e 0a0a 2020 2020 2020 2020 6966 2063  rn..        if c
+00030b70: 6f6d 7075 7465 5f64 7572 6174 696f 6e20  ompute_duration 
+00030b80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00030b90: 2020 2020 2020 2020 206f 6c64 5f64 7572           old_dur
+00030ba0: 6174 696f 6e20 3d20 7473 2e70 7265 6669  ation = ts.prefi
+00030bb0: 782e 6475 7261 7469 6f6e 5f61 7665 7261  x.duration_avera
+00030bc0: 6765 0a20 2020 2020 2020 2020 2020 2069  ge.            i
+00030bd0: 6620 6f6c 645f 6475 7261 7469 6f6e 203c  f old_duration <
+00030be0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00030bf0: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
+00030c00: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
+00030c10: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
+00030c20: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+00030c30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00030c40: 2020 2020 7473 2e70 7265 6669 782e 6475      ts.prefix.du
+00030c50: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
+00030c60: 2028 6f6c 645f 6475 7261 7469 6f6e 202b   (old_duration +
+00030c70: 2063 6f6d 7075 7465 5f64 7572 6174 696f   compute_duratio
+00030c80: 6e29 202f 2032 0a0a 2020 2020 2020 2020  n) / 2..        
+00030c90: 7773 2e61 6464 5f74 6f5f 6c6f 6e67 5f72  ws.add_to_long_r
+00030ca0: 756e 6e69 6e67 2874 7329 0a20 2020 2020  unning(ts).     
+00030cb0: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
+00030cc0: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
+00030cd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00030ce0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
+00030cf0: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
+00030d00: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
+00030d10: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
+00030d20: 6566 2068 616e 646c 655f 776f 726b 6572  ef handle_worker
+00030d30: 5f73 7461 7475 735f 6368 616e 6765 280a  _status_change(.
+00030d40: 2020 2020 2020 2020 7365 6c66 2c20 7374          self, st
+00030d50: 6174 7573 3a20 7374 7220 7c20 5374 6174  atus: str | Stat
+00030d60: 7573 2c20 776f 726b 6572 3a20 7374 7220  us, worker: str 
+00030d70: 7c20 576f 726b 6572 5374 6174 652c 2073  | WorkerState, s
+00030d80: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
+00030d90: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00030da0: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+00030db0: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
+00030dc0: 6b65 7229 2069 6620 6973 696e 7374 616e  ker) if isinstan
+00030dd0: 6365 2877 6f72 6b65 722c 2073 7472 2920  ce(worker, str) 
+00030de0: 656c 7365 2077 6f72 6b65 720a 2020 2020  else worker.    
+00030df0: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
+00030e00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00030e10: 6e0a 2020 2020 2020 2020 7072 6576 5f73  n.        prev_s
+00030e20: 7461 7475 7320 3d20 7773 2e73 7461 7475  tatus = ws.statu
+00030e30: 730a 2020 2020 2020 2020 7773 2e73 7461  s.        ws.sta
+00030e40: 7475 7320 3d20 5374 6174 7573 5b73 7461  tus = Status[sta
+00030e50: 7475 735d 2069 6620 6973 696e 7374 616e  tus] if isinstan
+00030e60: 6365 2873 7461 7475 732c 2073 7472 2920  ce(status, str) 
+00030e70: 656c 7365 2073 7461 7475 730a 2020 2020  else status.    
+00030e80: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
+00030e90: 203d 3d20 7072 6576 5f73 7461 7475 733a   == prev_status:
+00030ea0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00030eb0: 7572 6e0a 0a20 2020 2020 2020 2073 656c  urn..        sel
+00030ec0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
+00030ed0: 2020 2020 2020 2020 2077 732e 6164 6472           ws.addr
+00030ee0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+00030ef0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00030f00: 2020 2022 6163 7469 6f6e 223a 2022 776f     "action": "wo
+00030f10: 726b 6572 2d73 7461 7475 732d 6368 616e  rker-status-chan
+00030f20: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
+00030f30: 2020 2020 2022 7072 6576 2d73 7461 7475       "prev-statu
+00030f40: 7322 3a20 7072 6576 5f73 7461 7475 732e  s": prev_status.
+00030f50: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00030f60: 2020 2020 2020 2273 7461 7475 7322 3a20        "status": 
+00030f70: 7773 2e73 7461 7475 732e 6e61 6d65 2c0a  ws.status.name,.
+00030f80: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00030f90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00030fa0: 206c 6f67 6765 722e 6465 6275 6728 6622   logger.debug(f"
+00030fb0: 576f 726b 6572 2073 7461 7475 7320 7b70  Worker status {p
+00030fc0: 7265 765f 7374 6174 7573 2e6e 616d 657d  rev_status.name}
+00030fd0: 202d 3e20 7b73 7461 7475 737d 202d 207b   -> {status} - {
+00030fe0: 7773 7d22 290a 0a20 2020 2020 2020 2069  ws}")..        i
+00030ff0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+00031000: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00031010: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00031020: 7275 6e6e 696e 672e 6164 6428 7773 290a  running.add(ws).
+00031030: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031040: 2e63 6865 636b 5f69 646c 655f 7361 7475  .check_idle_satu
+00031050: 7261 7465 6428 7773 290a 2020 2020 2020  rated(ws).      
+00031060: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00031070: 6974 696f 6e73 280a 2020 2020 2020 2020  itions(.        
+00031080: 2020 2020 2020 2020 7365 6c66 2e62 756c          self.bul
+00031090: 6b5f 7363 6865 6475 6c65 5f75 6e72 756e  k_schedule_unrun
+000310a0: 6e61 626c 655f 6166 7465 725f 6164 6469  nable_after_addi
+000310b0: 6e67 5f77 6f72 6b65 7228 7773 292c 2073  ng_worker(ws), s
+000310c0: 7469 6d75 6c75 735f 6964 0a20 2020 2020  timulus_id.     
+000310d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000310e0: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
+000310f0: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
+00031100: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
+00031110: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00031120: 5f69 6429 0a20 2020 2020 2020 2065 6c73  _id).        els
+00031130: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00031140: 656c 662e 7275 6e6e 696e 672e 6469 7363  elf.running.disc
+00031150: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
+00031160: 2020 2020 7365 6c66 2e69 646c 652e 706f      self.idle.po
+00031170: 7028 7773 2e61 6464 7265 7373 2c20 4e6f  p(ws.address, No
+00031180: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00031190: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
+000311a0: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
+000311b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000311c0: 662e 7361 7475 7261 7465 642e 6469 7363  f.saturated.disc
+000311d0: 6172 6428 7773 290a 0a20 2020 2061 7379  ard(ws)..    asy
+000311e0: 6e63 2064 6566 2068 616e 646c 655f 7265  nc def handle_re
+000311f0: 7175 6573 745f 7265 6672 6573 685f 7768  quest_refresh_wh
+00031200: 6f5f 6861 7328 0a20 2020 2020 2020 2073  o_has(.        s
+00031210: 656c 662c 206b 6579 733a 2049 7465 7261  elf, keys: Itera
+00031220: 626c 655b 7374 725d 2c20 776f 726b 6572  ble[str], worker
+00031230: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
+00031240: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
+00031250: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00031260: 2222 4173 796e 6368 726f 6e6f 7573 2072  ""Asynchronous r
+00031270: 6571 7565 7374 2028 7468 726f 7567 6820  equest (through 
+00031280: 6275 6c6b 2063 6f6d 6d73 2920 6672 6f6d  bulk comms) from
+00031290: 2061 2057 6f72 6b65 7220 746f 2072 6566   a Worker to ref
+000312a0: 7265 7368 2074 6865 0a20 2020 2020 2020  resh the.       
+000312b0: 2077 686f 5f68 6173 2066 6f72 2073 6f6d   who_has for som
+000312c0: 6520 6b65 7973 2e20 4e6f 7420 746f 2062  e keys. Not to b
+000312d0: 6520 636f 6e66 7573 6564 2077 6974 6820  e confused with 
+000312e0: 7363 6865 6475 6c65 722e 7768 6f5f 6861  scheduler.who_ha
+000312f0: 732c 2077 6869 6368 2069 7320 610a 2020  s, which is a.  
+00031300: 2020 2020 2020 7379 6e63 6872 6f6e 6f75        synchronou
+00031310: 7320 5250 4320 7265 7175 6573 7420 6672  s RPC request fr
+00031320: 6f6d 2061 2043 6c69 656e 742e 0a20 2020  om a Client..   
+00031330: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00031340: 2077 686f 5f68 6173 203d 207b 7d0a 2020   who_has = {}.  
+00031350: 2020 2020 2020 6672 6565 5f6b 6579 7320        free_keys 
+00031360: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+00031370: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+00031380: 2020 2020 2020 2020 2020 6966 206b 6579            if key
+00031390: 2069 6e20 7365 6c66 2e74 6173 6b73 3a0a   in self.tasks:.
+000313a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313b0: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
+000313c0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
+000313d0: 7320 696e 2073 656c 662e 7461 736b 735b  s in self.tasks[
+000313e0: 6b65 795d 2e77 686f 5f68 6173 5d0a 2020  key].who_has].  
+000313f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00031400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031410: 6672 6565 5f6b 6579 732e 6170 7065 6e64  free_keys.append
+00031420: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
+00031430: 6620 7768 6f5f 6861 733a 0a20 2020 2020  f who_has:.     
+00031440: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+00031450: 616d 5f63 6f6d 6d73 5b77 6f72 6b65 725d  am_comms[worker]
+00031460: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
+00031470: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00031480: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+00031490: 223a 2022 7265 6672 6573 682d 7768 6f2d  ": "refresh-who-
+000314a0: 6861 7322 2c0a 2020 2020 2020 2020 2020  has",.          
+000314b0: 2020 2020 2020 2020 2020 2277 686f 5f68            "who_h
+000314c0: 6173 223a 2077 686f 5f68 6173 2c0a 2020  as": who_has,.  
+000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314e0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+000314f0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+00031500: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00031510: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00031520: 2020 2020 2020 6966 2066 7265 655f 6b65        if free_ke
+00031530: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00031540: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+00031550: 735b 776f 726b 6572 5d2e 7365 6e64 280a  s[worker].send(.
+00031560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031570: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00031580: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
+00031590: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
+000315a0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
+000315b0: 7973 223a 2066 7265 655f 6b65 7973 2c0a  ys": free_keys,.
+000315c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315d0: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
+000315e0: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
+000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031600: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
+00031610: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
+00031620: 616e 646c 655f 776f 726b 6572 2873 656c  andle_worker(sel
+00031630: 662c 2063 6f6d 6d3a 2043 6f6d 6d2c 2077  f, comm: Comm, w
+00031640: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
+00031650: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00031660: 0a20 2020 2020 2020 204c 6973 7465 6e20  .        Listen 
+00031670: 746f 2072 6573 706f 6e73 6573 2066 726f  to responses fro
+00031680: 6d20 6120 7369 6e67 6c65 2077 6f72 6b65  m a single worke
+00031690: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
+000316a0: 6973 2074 6865 206d 6169 6e20 6c6f 6f70  is the main loop
+000316b0: 2066 6f72 2073 6368 6564 756c 6572 2d77   for scheduler-w
+000316c0: 6f72 6b65 7220 696e 7465 7261 6374 696f  orker interactio
+000316d0: 6e0a 0a20 2020 2020 2020 2053 6565 2041  n..        See A
+000316e0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+000316f0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+00031700: 6564 756c 6572 2e68 616e 646c 655f 636c  eduler.handle_cl
+00031710: 6965 6e74 3a20 4571 7569 7661 6c65 6e74  ient: Equivalent
+00031720: 2063 6f72 6f75 7469 6e65 2066 6f72 2063   coroutine for c
+00031730: 6c69 656e 7473 0a20 2020 2020 2020 2022  lients.        "
+00031740: 2222 0a20 2020 2020 2020 2063 6f6d 6d2e  "".        comm.
+00031750: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
+00031760: 7220 636f 6e6e 6563 7469 6f6e 2074 6f20  r connection to 
+00031770: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
+00031780: 776f 726b 6572 5f63 6f6d 6d20 3d20 7365  worker_comm = se
+00031790: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+000317a0: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
+000317b0: 776f 726b 6572 5f63 6f6d 6d2e 7374 6172  worker_comm.star
+000317c0: 7428 636f 6d6d 290a 2020 2020 2020 2020  t(comm).        
+000317d0: 6c6f 6767 6572 2e69 6e66 6f28 2253 7461  logger.info("Sta
+000317e0: 7274 696e 6720 776f 726b 6572 2063 6f6d  rting worker com
+000317f0: 7075 7465 2073 7472 6561 6d2c 2025 7322  pute stream, %s"
+00031800: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
+00031810: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00031820: 2020 2061 7761 6974 2073 656c 662e 6861     await self.ha
+00031830: 6e64 6c65 5f73 7472 6561 6d28 636f 6d6d  ndle_stream(comm
+00031840: 3d63 6f6d 6d2c 2065 7874 7261 3d7b 2277  =comm, extra={"w
+00031850: 6f72 6b65 7222 3a20 776f 726b 6572 7d29  orker": worker})
+00031860: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+00031870: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031880: 2077 6f72 6b65 7220 696e 2073 656c 662e   worker in self.
+00031890: 7374 7265 616d 5f63 6f6d 6d73 3a0a 2020  stream_comms:.  
+000318a0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+000318b0: 726b 6572 5f63 6f6d 6d2e 6162 6f72 7428  rker_comm.abort(
+000318c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000318d0: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
+000318e0: 6f76 655f 776f 726b 6572 280a 2020 2020  ove_worker(.    
+000318f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031900: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
+00031910: 5f69 643d 6622 6861 6e64 6c65 2d77 6f72  _id=f"handle-wor
+00031920: 6b65 722d 636c 6561 6e75 702d 7b74 696d  ker-cleanup-{tim
+00031930: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
+00031940: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00031950: 2061 6464 5f70 6c75 6769 6e28 0a20 2020   add_plugin(.   
+00031960: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00031970: 2020 2070 6c75 6769 6e3a 2053 6368 6564     plugin: Sched
+00031980: 756c 6572 506c 7567 696e 2c0a 2020 2020  ulerPlugin,.    
+00031990: 2020 2020 2a2c 0a20 2020 2020 2020 2069      *,.        i
+000319a0: 6465 6d70 6f74 656e 743a 2062 6f6f 6c20  dempotent: bool 
+000319b0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000319c0: 206e 616d 653a 2073 7472 207c 204e 6f6e   name: str | Non
+000319d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000319e0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+000319f0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00031a00: 2020 2020 2020 2020 2222 2241 6464 2065          """Add e
+00031a10: 7874 6572 6e61 6c20 706c 7567 696e 2074  xternal plugin t
+00031a20: 6f20 7363 6865 6475 6c65 722e 0a0a 2020  o scheduler...  
+00031a30: 2020 2020 2020 5365 6520 6874 7470 733a        See https:
+00031a40: 2f2f 6469 7374 7269 6275 7465 642e 7265  //distributed.re
+00031a50: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
+00031a60: 6c61 7465 7374 2f70 6c75 6769 6e73 2e68  latest/plugins.h
+00031a70: 746d 6c0a 0a20 2020 2020 2020 2050 6172  tml..        Par
+00031a80: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00031a90: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00031aa0: 2020 2070 6c75 6769 6e20 3a20 5363 6865     plugin : Sche
+00031ab0: 6475 6c65 7250 6c75 6769 6e0a 2020 2020  dulerPlugin.    
+00031ac0: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
+00031ad0: 7250 6c75 6769 6e20 696e 7374 616e 6365  rPlugin instance
+00031ae0: 2074 6f20 6164 640a 2020 2020 2020 2020   to add.        
+00031af0: 6964 656d 706f 7465 6e74 203a 2062 6f6f  idempotent : boo
+00031b00: 6c0a 2020 2020 2020 2020 2020 2020 4966  l.            If
+00031b10: 2074 7275 652c 2074 6865 2070 6c75 6769   true, the plugi
+00031b20: 6e20 6973 2061 7373 756d 6564 2074 6f20  n is assumed to 
+00031b30: 616c 7265 6164 7920 6578 6973 7420 616e  already exist an
+00031b40: 6420 6e6f 0a20 2020 2020 2020 2020 2020  d no.           
+00031b50: 2061 6374 696f 6e20 6973 2074 616b 656e   action is taken
+00031b60: 2e0a 2020 2020 2020 2020 6e61 6d65 203a  ..        name :
+00031b70: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00031b80: 2041 206e 616d 6520 666f 7220 7468 6520   A name for the 
+00031b90: 706c 7567 696e 2c20 6966 204e 6f6e 652c  plugin, if None,
+00031ba0: 2074 6865 206e 616d 6520 6174 7472 6962   the name attrib
+00031bb0: 7574 6520 6973 0a20 2020 2020 2020 2020  ute is.         
+00031bc0: 2020 2063 6865 636b 6564 206f 6e20 7468     checked on th
+00031bd0: 6520 506c 7567 696e 2069 6e73 7461 6e63  e Plugin instanc
+00031be0: 6520 616e 6420 6765 6e65 7261 7465 6420  e and generated 
+00031bf0: 6966 206e 6f74 0a20 2020 2020 2020 2020  if not.         
+00031c00: 2020 2064 6973 636f 7665 7265 642e 0a20     discovered.. 
+00031c10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00031c20: 2020 2069 6620 6e61 6d65 2069 7320 4e6f     if name is No
+00031c30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00031c40: 6e61 6d65 203d 205f 6765 745f 706c 7567  name = _get_plug
+00031c50: 696e 5f6e 616d 6528 706c 7567 696e 290a  in_name(plugin).
+00031c60: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+00031c70: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
+00031c80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031c90: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
+00031ca0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00031cb0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+00031cc0: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
+00031cd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00031ce0: 2253 6368 6564 756c 6572 2061 6c72 6561  "Scheduler alrea
+00031cf0: 6479 2063 6f6e 7461 696e 7320 6120 706c  dy contains a pl
+00031d00: 7567 696e 2077 6974 6820 6e61 6d65 207b  ugin with name {
+00031d10: 6e61 6d65 7d3b 206f 7665 7277 7269 7469  name}; overwriti
+00031d20: 6e67 2e22 2c0a 2020 2020 2020 2020 2020  ng.",.          
+00031d30: 2020 2020 2020 6361 7465 676f 7279 3d55        category=U
+00031d40: 7365 7257 6172 6e69 6e67 2c0a 2020 2020  serWarning,.    
+00031d50: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00031d60: 2020 2073 656c 662e 706c 7567 696e 735b     self.plugins[
+00031d70: 6e61 6d65 5d20 3d20 706c 7567 696e 0a0a  name] = plugin..
+00031d80: 2020 2020 6465 6620 7265 6d6f 7665 5f70      def remove_p
+00031d90: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
+00031da0: 656c 662c 0a20 2020 2020 2020 206e 616d  elf,.        nam
+00031db0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+00031dc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 706c  None,.        pl
+00031dd0: 7567 696e 3a20 5363 6865 6475 6c65 7250  ugin: SchedulerP
+00031de0: 6c75 6769 6e20 7c20 4e6f 6e65 203d 204e  lugin | None = N
+00031df0: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
+00031e00: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00031e10: 656d 6f76 6520 6578 7465 726e 616c 2070  emove external p
+00031e20: 6c75 6769 6e20 6672 6f6d 2073 6368 6564  lugin from sched
+00031e30: 756c 6572 0a0a 2020 2020 2020 2020 5061  uler..        Pa
+00031e40: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00031e50: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00031e60: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
+00031e70: 2020 2020 2020 2020 2020 204e 616d 6520             Name 
+00031e80: 6f66 2074 6865 2070 6c75 6769 6e20 746f  of the plugin to
+00031e90: 2072 656d 6f76 650a 2020 2020 2020 2020   remove.        
+00031ea0: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
+00031eb0: 7274 206e 616d 6520 6973 206e 6f74 204e  rt name is not N
+00031ec0: 6f6e 650a 0a20 2020 2020 2020 2074 7279  one..        try
+00031ed0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+00031ee0: 6c20 7365 6c66 2e70 6c75 6769 6e73 5b6e  l self.plugins[n
+00031ef0: 616d 655d 0a20 2020 2020 2020 2065 7863  ame].        exc
+00031f00: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00031f10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00031f20: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+00031f30: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
+00031f40: 756c 6420 6e6f 7420 6669 6e64 2070 6c75  uld not find plu
+00031f50: 6769 6e20 7b6e 616d 6521 727d 2061 6d6f  gin {name!r} amo
+00031f60: 6e67 2074 6865 2063 7572 7265 6e74 2073  ng the current s
+00031f70: 6368 6564 756c 6572 2070 6c75 6769 6e73  cheduler plugins
+00031f80: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00031f90: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+00031fa0: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
+00031fb0: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
+00031fc0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00031fd0: 706c 7567 696e 3a20 6279 7465 7320 7c20  plugin: bytes | 
+00031fe0: 5363 6865 6475 6c65 7250 6c75 6769 6e2c  SchedulerPlugin,
+00031ff0: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
+00032000: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00032010: 2c0a 2020 2020 2020 2020 6964 656d 706f  ,.        idempo
+00032020: 7465 6e74 3a20 626f 6f6c 203d 2046 616c  tent: bool = Fal
+00032030: 7365 2c0a 2020 2020 2920 2d3e 204e 6f6e  se,.    ) -> Non
+00032040: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00032050: 6769 7374 6572 2061 2070 6c75 6769 6e20  gister a plugin 
+00032060: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
+00032070: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
+00032080: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
+00032090: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+000320a0: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
+000320b0: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
+000320c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000320d0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000320e0: 2020 2022 4361 6e6e 6f74 2072 6567 6973     "Cannot regis
+000320f0: 7465 7220 6120 7363 6865 6475 6c65 7220  ter a scheduler 
+00032100: 706c 7567 696e 2061 7320 7468 6520 7363  plugin as the sc
+00032110: 6865 6475 6c65 7220 220a 2020 2020 2020  heduler ".      
+00032120: 2020 2020 2020 2020 2020 2268 6173 2062            "has b
+00032130: 6565 6e20 6578 706c 6963 6974 6c79 2064  een explicitly d
+00032140: 6973 616c 6c6f 7765 6420 6672 6f6d 2064  isallowed from d
+00032150: 6573 6572 6961 6c69 7a69 6e67 2022 0a20  eserializing ". 
+00032160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00032170: 6172 6269 7472 6172 7920 6279 7465 7374  arbitrary bytest
+00032180: 7269 6e67 7320 7573 696e 6720 7069 636b  rings using pick
+00032190: 6c65 2076 6961 2074 6865 2022 0a20 2020  le via the ".   
+000321a0: 2020 2020 2020 2020 2020 2020 2022 2764               "'d
+000321b0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+000321c0: 756c 6572 2e70 6963 6b6c 6527 2063 6f6e  uler.pickle' con
+000321d0: 6669 6775 7261 7469 6f6e 2073 6574 7469  figuration setti
+000321e0: 6e67 2e22 0a20 2020 2020 2020 2020 2020  ng.".           
+000321f0: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
+00032200: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
+00032210: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
+00032220: 7567 696e 293a 0a20 2020 2020 2020 2020  ugin):.         
+00032230: 2020 2070 6c75 6769 6e20 3d20 6c6f 6164     plugin = load
+00032240: 7328 706c 7567 696e 290a 2020 2020 2020  s(plugin).      
+00032250: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00032260: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
+00032270: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
+00032280: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+00032290: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+000322a0: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+000322b0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
+000322c0: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
+000322d0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+000322e0: 706c 7567 696e 7320 616e 6420 6964 656d  plugins and idem
+000322f0: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
+00032300: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00032310: 2020 2020 6966 2068 6173 6174 7472 2870      if hasattr(p
+00032320: 6c75 6769 6e2c 2022 7374 6172 7422 293a  lugin, "start"):
+00032330: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00032340: 756c 7420 3d20 706c 7567 696e 2e73 7461  ult = plugin.sta
+00032350: 7274 2873 656c 6629 0a20 2020 2020 2020  rt(self).       
+00032360: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+00032370: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
+00032380: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
+00032390: 2020 2020 2061 7761 6974 2072 6573 756c       await resul
+000323a0: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+000323b0: 6164 645f 706c 7567 696e 2870 6c75 6769  add_plugin(plugi
+000323c0: 6e2c 206e 616d 653d 6e61 6d65 2c20 6964  n, name=name, id
+000323d0: 656d 706f 7465 6e74 3d69 6465 6d70 6f74  empotent=idempot
+000323e0: 656e 7429 0a0a 2020 2020 6465 6620 776f  ent)..    def wo
+000323f0: 726b 6572 5f73 656e 6428 7365 6c66 2c20  rker_send(self, 
+00032400: 776f 726b 6572 3a20 7374 722c 206d 7367  worker: str, msg
+00032410: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00032420: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00032430: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
+00032440: 6765 2074 6f20 776f 726b 6572 0a0a 2020  ge to worker..  
+00032450: 2020 2020 2020 5468 6973 2061 6c73 6f20        This also 
+00032460: 6861 6e64 6c65 7320 636f 6e6e 6563 7469  handles connecti
+00032470: 6f6e 2066 6169 6c75 7265 7320 6279 2061  on failures by a
+00032480: 6464 696e 6720 6120 6361 6c6c 6261 636b  dding a callback
+00032490: 2074 6f20 7265 6d6f 7665 0a20 2020 2020   to remove.     
+000324a0: 2020 2074 6865 2077 6f72 6b65 7220 6f6e     the worker on
+000324b0: 2074 6865 206e 6578 7420 6379 636c 652e   the next cycle.
+000324c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000324d0: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
+000324e0: 733a 2064 6963 7420 3d20 7365 6c66 2e73  s: dict = self.s
+000324f0: 7472 6561 6d5f 636f 6d6d 730a 2020 2020  tream_comms.    
+00032500: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00032510: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
+00032520: 735b 776f 726b 6572 5d2e 7365 6e64 286d  s[worker].send(m
+00032530: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
+00032540: 7074 2028 436f 6d6d 436c 6f73 6564 4572  pt (CommClosedEr
+00032550: 726f 722c 2041 7474 7269 6275 7465 4572  ror, AttributeEr
+00032560: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00032570: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
+00032580: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
+00032590: 2e63 616c 6c5f 736f 6f6e 280a 2020 2020  .call_soon(.    
+000325a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000325b0: 2e72 656d 6f76 655f 776f 726b 6572 2c0a  .remove_worker,.
+000325c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000325d0: 6164 6472 6573 733d 776f 726b 6572 2c0a  address=worker,.
+000325e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000325f0: 7374 696d 756c 7573 5f69 643d 6622 776f  stimulus_id=f"wo
+00032600: 726b 6572 2d73 656e 642d 636f 6d6d 2d66  rker-send-comm-f
+00032610: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
+00032620: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00032630: 2020 6465 6620 636c 6965 6e74 5f73 656e    def client_sen
+00032640: 6428 7365 6c66 2c20 636c 6965 6e74 2c20  d(self, client, 
+00032650: 6d73 6729 3a0a 2020 2020 2020 2020 2222  msg):.        ""
+00032660: 2253 656e 6420 6d65 7373 6167 6520 746f  "Send message to
+00032670: 2063 6c69 656e 7422 2222 0a20 2020 2020   client""".     
+00032680: 2020 2063 6c69 656e 745f 636f 6d6d 733a     client_comms:
+00032690: 2064 6963 7420 3d20 7365 6c66 2e63 6c69   dict = self.cli
+000326a0: 656e 745f 636f 6d6d 730a 2020 2020 2020  ent_comms.      
+000326b0: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
+000326c0: 6d73 2e67 6574 2863 6c69 656e 7429 0a20  ms.get(client). 
+000326d0: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
+000326e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000326f0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00032700: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00032710: 2063 2e73 656e 6428 6d73 6729 0a20 2020   c.send(msg).   
+00032720: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
+00032730: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
+00032740: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00032750: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00032760: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
+00032770: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00032780: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
+00032790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000327a0: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+000327b0: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+000327c0: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
+000327d0: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
+000327e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000327f0: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
+00032800: 5f61 6c6c 2873 656c 662c 2063 6c69 656e  _all(self, clien
+00032810: 745f 6d73 6773 3a20 4d73 6773 2c20 776f  t_msgs: Msgs, wo
+00032820: 726b 6572 5f6d 7367 733a 204d 7367 7329  rker_msgs: Msgs)
+00032830: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00032840: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
+00032850: 6573 2074 6f20 636c 6965 6e74 2061 6e64  es to client and
+00032860: 2077 6f72 6b65 7273 2222 220a 0a20 2020   workers"""..   
+00032870: 2020 2020 2066 6f72 2063 6c69 656e 742c       for client,
+00032880: 206d 7367 7320 696e 2063 6c69 656e 745f   msgs in client_
+00032890: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
+000328a0: 2020 2020 2020 2020 2020 6320 3d20 7365            c = se
+000328b0: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
+000328c0: 6765 7428 636c 6965 6e74 290a 2020 2020  get(client).    
+000328d0: 2020 2020 2020 2020 6966 2063 2069 7320          if c is 
+000328e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000328f0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00032900: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032920: 632e 7365 6e64 282a 6d73 6773 290a 2020  c.send(*msgs).  
+00032930: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00032940: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
+00032950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032960: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+00032970: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00032980: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00032990: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
+000329a0: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
+000329b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000329c0: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
+000329d0: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
+000329e0: 2077 7269 7465 2025 7322 2c0a 2020 2020   write %s",.    
+000329f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a00: 2020 2020 632c 0a20 2020 2020 2020 2020      c,.         
+00032a10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00032a20: 7367 732c 0a20 2020 2020 2020 2020 2020  sgs,.           
+00032a30: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00032a40: 5f69 6e66 6f3d 5472 7565 2c0a 2020 2020  _info=True,.    
+00032a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a60: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
+00032a70: 6f72 6b65 722c 206d 7367 7320 696e 2077  orker, msgs in w
+00032a80: 6f72 6b65 725f 6d73 6773 2e69 7465 6d73  orker_msgs.items
+00032a90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00032aa0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00032ab0: 2020 2020 2077 203d 2073 656c 662e 7374       w = self.st
+00032ac0: 7265 616d 5f63 6f6d 6d73 5b77 6f72 6b65  ream_comms[worke
+00032ad0: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
+00032ae0: 2020 2077 2e73 656e 6428 2a6d 7367 7329     w.send(*msgs)
+00032af0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00032b00: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00032b10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00032b20: 776f 726b 6572 2061 6c72 6561 6479 2067  worker already g
+00032b30: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00032b40: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00032b50: 2020 2020 2065 7863 6570 7420 2843 6f6d       except (Com
+00032b60: 6d43 6c6f 7365 6445 7272 6f72 2c20 4174  mClosedError, At
+00032b70: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00032b80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00032b90: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
+00032ba0: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
+00032bb0: 6c6c 5f73 6f6f 6e28 0a20 2020 2020 2020  ll_soon(.       
+00032bc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00032bd0: 662e 7265 6d6f 7665 5f77 6f72 6b65 722c  f.remove_worker,
+00032be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032bf0: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
+00032c00: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+00032c10: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
+00032c20: 735f 6964 3d66 2273 656e 642d 616c 6c2d  s_id=f"send-all-
+00032c30: 636f 6d6d 2d66 6169 6c2d 7b74 696d 6528  comm-fail-{time(
+00032c40: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
+00032c50: 2020 2020 2029 0a0a 2020 2020 2323 2323       )..    ####
+00032c60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00032c70: 2323 2323 2323 2323 0a20 2020 2023 204c  ########.    # L
+00032c80: 6573 7320 636f 6d6d 6f6e 2069 6e74 6572  ess common inter
+00032c90: 6163 7469 6f6e 7320 230a 2020 2020 2323  actions #.    ##
+00032ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00032cb0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+00032cc0: 6173 796e 6320 6465 6620 7363 6174 7465  async def scatte
+00032cd0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+00032ce0: 0a20 2020 2020 2020 2063 6f6d 6d3d 4e6f  .        comm=No
+00032cf0: 6e65 2c0a 2020 2020 2020 2020 6461 7461  ne,.        data
+00032d00: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
+00032d10: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
+00032d20: 2020 2020 2063 6c69 656e 743d 4e6f 6e65       client=None
+00032d30: 2c0a 2020 2020 2020 2020 6272 6f61 6463  ,.        broadc
+00032d40: 6173 743d 4661 6c73 652c 0a20 2020 2020  ast=False,.     
+00032d50: 2020 2074 696d 656f 7574 3d32 2c0a 2020     timeout=2,.  
+00032d60: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00032d70: 5365 6e64 2064 6174 6120 6f75 7420 746f  Send data out to
+00032d80: 2077 6f72 6b65 7273 0a0a 2020 2020 2020   workers..      
+00032d90: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+00032da0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00032db0: 2020 2020 5363 6865 6475 6c65 722e 6272      Scheduler.br
+00032dc0: 6f61 6463 6173 743a 0a20 2020 2020 2020  oadcast:.       
+00032dd0: 2022 2222 0a20 2020 2020 2020 2073 7461   """.        sta
+00032de0: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
+00032df0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+00032e00: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+00032e10: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+00032e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032e30: 7773 7320 3d20 7365 6c66 2e72 756e 6e69  wss = self.runni
+00032e40: 6e67 0a20 2020 2020 2020 2020 2020 2065  ng.            e
+00032e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00032e60: 2020 2020 2077 6f72 6b65 7273 203d 205b       workers = [
+00032e70: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
+00032e80: 6573 7328 7729 2066 6f72 2077 2069 6e20  ess(w) for w in 
+00032e90: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
+00032ea0: 2020 2020 2020 2020 2077 7373 203d 207b           wss = {
+00032eb0: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d20  self.workers[w] 
+00032ec0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+00032ed0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00032ee0: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
+00032ef0: 7773 2069 6e20 7773 7320 6966 2077 732e  ws in wss if ws.
+00032f00: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00032f10: 2e72 756e 6e69 6e67 7d0a 0a20 2020 2020  .running}..     
+00032f20: 2020 2020 2020 2069 6620 7773 733a 0a20         if wss:. 
+00032f30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00032f40: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+00032f50: 2069 6620 7469 6d65 2829 203e 2073 7461   if time() > sta
+00032f60: 7274 202b 2074 696d 656f 7574 3a0a 2020  rt + timeout:.  
+00032f70: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00032f80: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
+00032f90: 2822 4e6f 2076 616c 6964 2077 6f72 6b65  ("No valid worke
+00032fa0: 7273 2066 6f75 6e64 2229 0a20 2020 2020  rs found").     
+00032fb0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+00032fc0: 6e63 696f 2e73 6c65 6570 2830 2e31 290a  ncio.sleep(0.1).
+00032fd0: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
+00032fe0: 7320 3d20 7b77 732e 6164 6472 6573 733a  s = {ws.address:
+00032ff0: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
+00033000: 2077 7320 696e 2077 7373 7d0a 0a20 2020   ws in wss}..   
+00033010: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00033020: 7374 616e 6365 2864 6174 612c 2064 6963  stance(data, dic
+00033030: 7429 0a0a 2020 2020 2020 2020 6b65 7973  t)..        keys
+00033040: 2c20 7768 6f5f 6861 732c 206e 6279 7465  , who_has, nbyte
+00033050: 7320 3d20 6177 6169 7420 7363 6174 7465  s = await scatte
+00033060: 725f 746f 5f77 6f72 6b65 7273 286e 7468  r_to_workers(nth
+00033070: 7265 6164 732c 2064 6174 612c 2072 7063  reads, data, rpc
+00033080: 3d73 656c 662e 7270 6329 0a0a 2020 2020  =self.rpc)..    
+00033090: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
+000330a0: 6461 7461 2877 686f 5f68 6173 3d77 686f  data(who_has=who
+000330b0: 5f68 6173 2c20 6e62 7974 6573 3d6e 6279  _has, nbytes=nby
+000330c0: 7465 732c 2063 6c69 656e 743d 636c 6965  tes, client=clie
+000330d0: 6e74 290a 0a20 2020 2020 2020 2069 6620  nt)..        if 
+000330e0: 6272 6f61 6463 6173 743a 0a20 2020 2020  broadcast:.     
+000330f0: 2020 2020 2020 206e 203d 206c 656e 286e         n = len(n
+00033100: 7468 7265 6164 7329 2069 6620 6272 6f61  threads) if broa
+00033110: 6463 6173 7420 6973 2054 7275 6520 656c  dcast is True el
+00033120: 7365 2062 726f 6164 6361 7374 0a20 2020  se broadcast.   
+00033130: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00033140: 656c 662e 7265 706c 6963 6174 6528 6b65  elf.replicate(ke
+00033150: 7973 3d6b 6579 732c 2077 6f72 6b65 7273  ys=keys, workers
+00033160: 3d77 6f72 6b65 7273 2c20 6e3d 6e29 0a0a  =workers, n=n)..
+00033170: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00033180: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00033190: 2020 2020 5b63 6c69 656e 742c 2022 616c      [client, "al
+000331a0: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
+000331b0: 2273 6361 7474 6572 222c 2022 636c 6965  "scatter", "clie
+000331c0: 6e74 223a 2063 6c69 656e 742c 2022 636f  nt": client, "co
+000331d0: 756e 7422 3a20 6c65 6e28 6461 7461 297d  unt": len(data)}
+000331e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000331f0: 2020 2072 6574 7572 6e20 6b65 7973 0a0a     return keys..
+00033200: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
+00033210: 7468 6572 2873 656c 662c 206b 6579 732c  ther(self, keys,
+00033220: 2073 6572 6961 6c69 7a65 7273 3d4e 6f6e   serializers=Non
+00033230: 6529 3a0a 2020 2020 2020 2020 2222 2243  e):.        """C
+00033240: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
+00033250: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
+00033260: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
+00033270: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00033280: 203d 2066 2267 6174 6865 722d 7b74 696d   = f"gather-{tim
+00033290: 6528 297d 220a 2020 2020 2020 2020 6b65  e()}".        ke
+000332a0: 7973 203d 206c 6973 7428 6b65 7973 290a  ys = list(keys).
+000332b0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
+000332c0: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+000332d0: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+000332e0: 2020 2020 2020 2020 2020 7473 3a20 5461            ts: Ta
+000332f0: 736b 5374 6174 6520 3d20 7365 6c66 2e74  skState = self.t
+00033300: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+00033310: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+00033320: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00033330: 2020 2020 2020 2020 2020 2020 2077 686f               who
+00033340: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
+00033350: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
+00033360: 6e20 7473 2e77 686f 5f68 6173 5d0a 2020  n ts.who_has].  
+00033370: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00033380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033390: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
+000333a0: 5d0a 0a20 2020 2020 2020 2064 6174 612c  ]..        data,
+000333b0: 206d 6973 7369 6e67 5f6b 6579 732c 206d   missing_keys, m
+000333c0: 6973 7369 6e67 5f77 6f72 6b65 7273 203d  issing_workers =
+000333d0: 2061 7761 6974 2067 6174 6865 725f 6672   await gather_fr
+000333e0: 6f6d 5f77 6f72 6b65 7273 280a 2020 2020  om_workers(.    
+000333f0: 2020 2020 2020 2020 7768 6f5f 6861 732c          who_has,
+00033400: 2072 7063 3d73 656c 662e 7270 632c 2063   rpc=self.rpc, c
+00033410: 6c6f 7365 3d46 616c 7365 2c20 7365 7269  lose=False, seri
+00033420: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
+00033430: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
+00033440: 2020 2020 2020 6966 206e 6f74 206d 6973        if not mis
+00033450: 7369 6e67 5f6b 6579 733a 0a20 2020 2020  sing_keys:.     
+00033460: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00033470: 7b22 7374 6174 7573 223a 2022 4f4b 222c  {"status": "OK",
+00033480: 2022 6461 7461 223a 2064 6174 617d 0a20   "data": data}. 
+00033490: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000334a0: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
+000334b0: 5f73 7461 7465 7320 3d20 5b0a 2020 2020  _states = [.    
+000334c0: 2020 2020 2020 2020 2020 2020 2873 656c              (sel
+000334d0: 662e 7461 736b 735b 6b65 795d 2e73 7461  f.tasks[key].sta
+000334e0: 7465 2069 6620 6b65 7920 696e 2073 656c  te if key in sel
+000334f0: 662e 7461 736b 7320 656c 7365 204e 6f6e  f.tasks else Non
+00033500: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00033510: 2020 2066 6f72 206b 6579 2069 6e20 6d69     for key in mi
+00033520: 7373 696e 675f 6b65 7973 0a20 2020 2020  ssing_keys.     
+00033530: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00033540: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00033550: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+00033560: 2020 2020 2020 2022 436f 756c 646e 2774         "Couldn't
+00033570: 2067 6174 6865 7220 6b65 7973 2025 7320   gather keys %s 
+00033580: 7374 6174 653a 2025 7320 776f 726b 6572  state: %s worker
+00033590: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
+000335a0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+000335b0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+000335c0: 2020 2020 2020 6d69 7373 696e 675f 7374        missing_st
+000335d0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+000335e0: 2020 2020 2020 6d69 7373 696e 675f 776f        missing_wo
+000335f0: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+00033600: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00033610: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
+00033620: 7573 223a 2022 6572 726f 7222 2c20 226b  us": "error", "k
+00033630: 6579 7322 3a20 6d69 7373 696e 675f 6b65  eys": missing_ke
+00033640: 7973 7d0a 2020 2020 2020 2020 2020 2020  ys}.            
+00033650: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
+00033660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00033670: 2020 2023 2052 656d 6f76 6520 7375 7370     # Remove susp
+00033680: 6963 696f 7573 2077 6f72 6b65 7273 2066  icious workers f
+00033690: 726f 6d20 7468 6520 7363 6865 6475 6c65  rom the schedule
+000336a0: 7220 616e 6420 7368 7574 2074 6865 6d20  r and shut them 
+000336b0: 646f 776e 2e0a 2020 2020 2020 2020 2020  down..          
+000336c0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+000336d0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+000336e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000336f0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+00033700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00033710: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
+00033720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033730: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00033740: 7373 3d77 6f72 6b65 722c 2063 6c6f 7365  ss=worker, close
+00033750: 3d54 7275 652c 2073 7469 6d75 6c75 735f  =True, stimulus_
+00033760: 6964 3d73 7469 6d75 6c75 735f 6964 0a20  id=stimulus_id. 
+00033770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033780: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00033790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000337a0: 2066 6f72 2077 6f72 6b65 7220 696e 206d   for worker in m
+000337b0: 6973 7369 6e67 5f77 6f72 6b65 7273 0a20  issing_workers. 
+000337c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000337d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000337e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000337f0: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
+00033800: 776f 726b 6572 7320 696e 206d 6973 7369  workers in missi
+00033810: 6e67 5f6b 6579 732e 6974 656d 7328 293a  ng_keys.items():
+00033820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033830: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00033840: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+00033850: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00033860: 5368 7574 2064 6f77 6e20 776f 726b 6572  Shut down worker
+00033870: 7320 7468 6174 2064 6f6e 2774 2068 6176  s that don't hav
+00033880: 6520 7072 6f6d 6973 6564 206b 6579 3a20  e promised key: 
+00033890: 2573 2c20 2573 222c 0a20 2020 2020 2020  %s, %s",.       
+000338a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000338b0: 2073 7472 2877 6f72 6b65 7273 292c 0a20   str(workers),. 
+000338c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000338d0: 2020 2020 2020 2073 7472 286b 6579 292c         str(key),
+000338e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000338f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00033900: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
+00033910: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
+00033920: 2022 6761 7468 6572 222c 2022 636f 756e   "gather", "coun
+00033930: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
+00033940: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00033950: 6573 756c 740a 0a20 2020 2040 6c6f 675f  esult..    @log_
+00033960: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+00033970: 2064 6566 2072 6573 7461 7274 2873 656c   def restart(sel
+00033980: 662c 2063 6c69 656e 743d 4e6f 6e65 2c20  f, client=None, 
+00033990: 7469 6d65 6f75 743d 3330 2c20 7761 6974  timeout=30, wait
+000339a0: 5f66 6f72 5f77 6f72 6b65 7273 3d54 7275  _for_workers=Tru
+000339b0: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
+000339c0: 2020 2020 2020 2020 5265 7374 6172 7420          Restart 
+000339d0: 616c 6c20 776f 726b 6572 732e 2052 6573  all workers. Res
+000339e0: 6574 206c 6f63 616c 2073 7461 7465 2e20  et local state. 
+000339f0: 4f70 7469 6f6e 616c 6c79 2077 6169 7420  Optionally wait 
+00033a00: 666f 7220 776f 726b 6572 7320 746f 2072  for workers to r
+00033a10: 6574 7572 6e2e 0a0a 2020 2020 2020 2020  eturn...        
+00033a20: 576f 726b 6572 7320 7769 7468 6f75 7420  Workers without 
+00033a30: 6e61 6e6e 6965 7320 6172 6520 7368 7574  nannies are shut
+00033a40: 2064 6f77 6e2c 2068 6f70 696e 6720 616e   down, hoping an
+00033a50: 2065 7874 6572 6e61 6c20 6465 706c 6f79   external deploy
+00033a60: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
+00033a70: 2020 2020 7769 6c6c 2072 6573 7461 7274      will restart
+00033a80: 2074 6865 6d2e 2054 6865 7265 666f 7265   them. Therefore
+00033a90: 2c20 6966 206e 6f74 2075 7369 6e67 206e  , if not using n
+00033aa0: 616e 6e69 6573 2061 6e64 2079 6f75 7220  annies and your 
+00033ab0: 6465 706c 6f79 6d65 6e74 2073 7973 7465  deployment syste
+00033ac0: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
+00033ad0: 6f74 2061 7574 6f6d 6174 6963 616c 6c79  ot automatically
+00033ae0: 2072 6573 7461 7274 2077 6f72 6b65 7273   restart workers
+00033af0: 2c20 6060 7265 7374 6172 7460 6020 7769  , ``restart`` wi
+00033b00: 6c6c 206a 7573 7420 7368 7574 2064 6f77  ll just shut dow
+00033b10: 6e20 616c 6c0a 2020 2020 2020 2020 776f  n all.        wo
+00033b20: 726b 6572 732c 2074 6865 6e20 7469 6d65  rkers, then time
+00033b30: 206f 7574 210a 0a20 2020 2020 2020 2041   out!..        A
+00033b40: 6674 6572 2060 6072 6573 7461 7274 6060  fter ``restart``
+00033b50: 2c20 616c 6c20 636f 6e6e 6563 7465 6420  , all connected 
+00033b60: 776f 726b 6572 7320 6172 6520 6e65 772c  workers are new,
+00033b70: 2072 6567 6172 646c 6573 7320 6f66 2077   regardless of w
+00033b80: 6865 7468 6572 2060 6054 696d 656f 7574  hether ``Timeout
+00033b90: 4572 726f 7260 600a 2020 2020 2020 2020  Error``.        
+00033ba0: 7761 7320 7261 6973 6564 2e20 416e 7920  was raised. Any 
+00033bb0: 776f 726b 6572 7320 7468 6174 2066 6169  workers that fai
+00033bc0: 6c65 6420 746f 2073 6875 7420 646f 776e  led to shut down
+00033bd0: 2069 6e20 7469 6d65 2061 7265 2072 656d   in time are rem
+00033be0: 6f76 6564 2c20 616e 640a 2020 2020 2020  oved, and.      
+00033bf0: 2020 6d61 7920 6f72 206d 6179 206e 6f74    may or may not
+00033c00: 2073 6875 7420 646f 776e 206f 6e20 7468   shut down on th
+00033c10: 6569 7220 6f77 6e20 696e 2074 6865 2066  eir own in the f
+00033c20: 7574 7572 652e 0a0a 2020 2020 2020 2020  uture...        
+00033c30: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+00033c40: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00033c50: 2020 2020 2020 7469 6d65 6f75 743a 0a20        timeout:. 
+00033c60: 2020 2020 2020 2020 2020 2048 6f77 206c             How l
+00033c70: 6f6e 6720 746f 2077 6169 7420 666f 7220  ong to wait for 
+00033c80: 776f 726b 6572 7320 746f 2073 6875 7420  workers to shut 
+00033c90: 646f 776e 2061 6e64 2063 6f6d 6520 6261  down and come ba
+00033ca0: 636b 2c20 6966 2060 6077 6169 745f 666f  ck, if ``wait_fo
+00033cb0: 725f 776f 726b 6572 7360 600a 2020 2020  r_workers``.    
+00033cc0: 2020 2020 2020 2020 6973 2054 7275 652c          is True,
+00033cd0: 206f 7468 6572 7769 7365 206a 7573 7420   otherwise just 
+00033ce0: 686f 7720 6c6f 6e67 2074 6f20 7761 6974  how long to wait
+00033cf0: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
+00033d00: 7368 7574 2064 6f77 6e2e 0a20 2020 2020  shut down..     
+00033d10: 2020 2020 2020 2052 6169 7365 7320 6060         Raises ``
+00033d20: 6173 796e 6369 6f2e 5469 6d65 6f75 7445  asyncio.TimeoutE
+00033d30: 7272 6f72 6060 2069 6620 7468 6973 2069  rror`` if this i
+00033d40: 7320 6578 6365 6564 6564 2e0a 2020 2020  s exceeded..    
+00033d50: 2020 2020 7761 6974 5f66 6f72 5f77 6f72      wait_for_wor
+00033d60: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+00033d70: 2020 5768 6574 6865 7220 746f 2077 6169    Whether to wai
+00033d80: 7420 666f 7220 616c 6c20 776f 726b 6572  t for all worker
+00033d90: 7320 746f 2072 6563 6f6e 6e65 6374 2c20  s to reconnect, 
+00033da0: 6f72 206a 7573 7420 666f 7220 7468 656d  or just for them
+00033db0: 2074 6f20 7368 7574 2064 6f77 6e0a 2020   to shut down.  
+00033dc0: 2020 2020 2020 2020 2020 2864 6566 6175            (defau
+00033dd0: 6c74 2054 7275 6529 2e20 5573 6520 6060  lt True). Use ``
+00033de0: 7265 7374 6172 7428 7761 6974 5f66 6f72  restart(wait_for
+00033df0: 5f77 6f72 6b65 7273 3d46 616c 7365 2960  _workers=False)`
+00033e00: 6020 636f 6d62 696e 6564 2077 6974 680a  ` combined with.
+00033e10: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
+00033e20: 683a 6043 6c69 656e 742e 7761 6974 5f66  h:`Client.wait_f
+00033e30: 6f72 5f77 6f72 6b65 7273 6020 666f 7220  or_workers` for 
+00033e40: 6772 616e 756c 6172 2063 6f6e 7472 6f6c  granular control
+00033e50: 206f 7665 7220 686f 7720 6d61 6e79 2077   over how many w
+00033e60: 6f72 6b65 7273 2074 6f0a 2020 2020 2020  orkers to.      
+00033e70: 2020 2020 2020 7761 6974 2066 6f72 2e0a        wait for..
+00033e80: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+00033e90: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+00033ea0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
+00033eb0: 742e 7265 7374 6172 740a 2020 2020 2020  t.restart.      
+00033ec0: 2020 436c 6965 6e74 2e72 6573 7461 7274    Client.restart
+00033ed0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00033ee0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
+00033ef0: 6d75 6c75 735f 6964 203d 2066 2272 6573  mulus_id = f"res
+00033f00: 7461 7274 2d7b 7469 6d65 2829 7d22 0a0a  tart-{time()}"..
+00033f10: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00033f20: 6e66 6f28 2252 6573 7461 7274 696e 6720  nfo("Restarting 
+00033f30: 776f 726b 6572 7320 616e 6420 7265 6c65  workers and rele
+00033f40: 6173 696e 6720 616c 6c20 6b65 7973 2e22  asing all keys."
+00033f50: 290a 2020 2020 2020 2020 666f 7220 6373  ).        for cs
+00033f60: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
+00033f70: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+00033f80: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00033f90: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
+00033fa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00033fb0: 2020 6b65 7973 3d5b 7473 2e6b 6579 2066    keys=[ts.key f
+00033fc0: 6f72 2074 7320 696e 2063 732e 7761 6e74  or ts in cs.want
+00033fd0: 735f 7768 6174 5d2c 0a20 2020 2020 2020  s_what],.       
+00033fe0: 2020 2020 2020 2020 2063 6c69 656e 743d           client=
+00033ff0: 6373 2e63 6c69 656e 745f 6b65 792c 0a20  cs.client_key,. 
+00034000: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00034010: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00034020: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00034030: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00034040: 656c 662e 5f63 6c65 6172 5f74 6173 6b5f  elf._clear_task_
+00034050: 7374 6174 6528 290a 2020 2020 2020 2020  state().        
+00034060: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
+00034070: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
+00034080: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
+00034090: 2022 7265 7374 6172 7422 7d29 0a0a 2020   "restart"})..  
+000340a0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
+000340b0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+000340c0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
+000340d0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+000340e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000340f0: 2020 706c 7567 696e 2e72 6573 7461 7274    plugin.restart
+00034100: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
+00034110: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00034120: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00034130: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00034140: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+00034150: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
+00034160: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
+00034170: 6572 7329 0a20 2020 2020 2020 206e 616e  ers).        nan
+00034180: 6e79 5f77 6f72 6b65 7273 203d 207b 0a20  ny_workers = {. 
+00034190: 2020 2020 2020 2020 2020 2061 6464 723a             addr:
+000341a0: 2077 732e 6e61 6e6e 7920 666f 7220 6164   ws.nanny for ad
+000341b0: 6472 2c20 7773 2069 6e20 7365 6c66 2e77  dr, ws in self.w
+000341c0: 6f72 6b65 7273 2e69 7465 6d73 2829 2069  orkers.items() i
+000341d0: 6620 7773 2e6e 616e 6e79 0a20 2020 2020  f ws.nanny.     
+000341e0: 2020 207d 0a20 2020 2020 2020 2023 2043     }.        # C
+000341f0: 6c6f 7365 206e 6f6e 2d4e 616e 6e79 2077  lose non-Nanny w
+00034200: 6f72 6b65 7273 2e20 5765 2068 6176 6520  orkers. We have 
+00034210: 6e6f 2077 6179 2074 6f20 7265 7374 6172  no way to restar
+00034220: 7420 7468 656d 2c20 736f 2077 6520 6a75  t them, so we ju
+00034230: 7374 206c 6574 2074 6865 6d20 676f 2c0a  st let them go,.
+00034240: 2020 2020 2020 2020 2320 616e 6420 6173          # and as
+00034250: 7375 6d65 2061 2064 6570 6c6f 796d 656e  sume a deploymen
+00034260: 7420 7379 7374 656d 2069 7320 676f 696e  t system is goin
+00034270: 6720 746f 2072 6573 7461 7274 2074 6865  g to restart the
+00034280: 6d20 666f 7220 7573 2e0a 2020 2020 2020  m for us..      
+00034290: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+000342a0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+000342b0: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
+000342c0: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+000342d0: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
+000342e0: 733d 6164 6472 2c20 7374 696d 756c 7573  s=addr, stimulus
+000342f0: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00034300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034310: 2066 6f72 2061 6464 7220 696e 2073 656c   for addr in sel
+00034320: 662e 776f 726b 6572 730a 2020 2020 2020  f.workers.      
+00034330: 2020 2020 2020 2020 2020 6966 2061 6464            if add
+00034340: 7220 6e6f 7420 696e 206e 616e 6e79 5f77  r not in nanny_w
+00034350: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+00034360: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
+00034370: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00034380: 6562 7567 2822 5365 6e64 206b 696c 6c20  ebug("Send kill 
+00034390: 7369 676e 616c 2074 6f20 6e61 6e6e 6965  signal to nannie
+000343a0: 733a 2025 7322 2c20 6e61 6e6e 795f 776f  s: %s", nanny_wo
+000343b0: 726b 6572 7329 0a20 2020 2020 2020 2061  rkers).        a
+000343c0: 7379 6e63 2077 6974 6820 636f 6e74 6578  sync with contex
+000343d0: 746c 6962 2e41 7379 6e63 4578 6974 5374  tlib.AsyncExitSt
+000343e0: 6163 6b28 2920 6173 2073 7461 636b 3a0a  ack() as stack:.
+000343f0: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
+00034400: 6965 7320 3d20 6177 6169 7420 6173 796e  ies = await asyn
+00034410: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+00034420: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
+00034430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034440: 2020 2073 7461 636b 2e65 6e74 6572 5f61     stack.enter_a
+00034450: 7379 6e63 5f63 6f6e 7465 7874 280a 2020  sync_context(.  
+00034460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034470: 2020 2020 2020 7270 6328 6e61 6e6e 795f        rpc(nanny_
+00034480: 6164 6472 6573 732c 2063 6f6e 6e65 6374  address, connect
+00034490: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
+000344a0: 6e6e 6563 7469 6f6e 5f61 7267 7329 0a20  nnection_args). 
+000344b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000344c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000344d0: 2020 2020 2020 2020 2066 6f72 206e 616e           for nan
+000344e0: 6e79 5f61 6464 7265 7373 2069 6e20 6e61  ny_address in na
+000344f0: 6e6e 795f 776f 726b 6572 732e 7661 6c75  nny_workers.valu
+00034500: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+00034510: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00034520: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00034530: 2020 7374 6172 7420 3d20 6d6f 6e6f 746f    start = monoto
+00034540: 6e69 6328 290a 2020 2020 2020 2020 2020  nic().          
+00034550: 2020 7265 7370 7320 3d20 6177 6169 7420    resps = await 
+00034560: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00034570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034580: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+00034590: 2020 2020 2020 2077 6169 745f 666f 7228         wait_for(
+000345a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000345b0: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+000345c0: 2064 6f65 7320 6e6f 7420 7261 6973 6520   does not raise 
+000345d0: 6966 2074 6865 2070 726f 6365 7373 2066  if the process f
+000345e0: 6169 6c73 2074 6f20 7368 7574 2064 6f77  ails to shut dow
+000345f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00034600: 2020 2020 2020 2020 2020 2023 2073 6565             # see
+00034610: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+00034620: 636f 6d2f 6461 736b 2f64 6973 7472 6962  com/dask/distrib
+00034630: 7574 6564 2f70 756c 6c2f 3634 3237 2f66  uted/pull/6427/f
+00034640: 696c 6573 2372 3839 3439 3137 3432 340a  iles#r894917424.
+00034650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034660: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
+00034670: 4e61 6e6e 7920 7769 6c6c 2061 7574 6f6d  Nanny will autom
+00034680: 6174 6963 616c 6c79 2072 6573 7461 7274  atically restart
+00034690: 2077 6f72 6b65 7220 7072 6f63 6573 7320   worker process 
+000346a0: 7768 656e 2069 7427 7320 6b69 6c6c 6564  when it's killed
+000346b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000346c0: 2020 2020 2020 2020 206e 616e 6e79 2e6b           nanny.k
+000346d0: 696c 6c28 0a20 2020 2020 2020 2020 2020  ill(.           
 000346e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000346f0: 2020 2020 2020 2020 2020 2022 646f 776e             "down
-00034700: 2069 6e73 7465 6164 206f 6620 7265 7374   instead of rest
-00034710: 6172 7465 6420 2872 6573 7461 7274 2069  arted (restart i
-00034720: 7320 6f6e 6c79 2070 6f73 7369 626c 6520  s only possible 
-00034730: 7769 7468 204e 616e 6e69 6573 292e 2049  with Nannies). I
-00034740: 6620 220a 2020 2020 2020 2020 2020 2020  f ".            
-00034750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034760: 2279 6f75 7220 6465 706c 6f79 6d65 6e74  "your deployment
-00034770: 2073 7973 7465 6d20 646f 6573 206e 6f74   system does not
-00034780: 2061 7574 6f6d 6174 6963 616c 6c79 2072   automatically r
-00034790: 652d 6c61 756e 6368 2074 6572 6d69 6e61  e-launch termina
-000347a0: 7465 6420 220a 2020 2020 2020 2020 2020  ted ".          
-000347b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347c0: 2020 2270 726f 6365 7373 6573 2c20 7468    "processes, th
-000347d0: 656e 2074 686f 7365 2077 6f72 6b65 7273  en those workers
-000347e0: 2077 696c 6c20 6e65 7665 7220 636f 6d65   will never come
-000347f0: 2062 6163 6b2c 2061 6e64 2060 436c 6965   back, and `Clie
-00034800: 6e74 2e72 6573 7461 7274 6020 220a 2020  nt.restart` ".  
-00034810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034820: 2020 2020 2020 2020 2020 2277 696c 6c20            "will 
-00034830: 616c 7761 7973 2074 696d 6520 6f75 742e  always time out.
-00034840: 2044 6f20 6e6f 7420 7573 6520 6043 6c69   Do not use `Cli
-00034850: 656e 742e 7265 7374 6172 7460 2069 6e20  ent.restart` in 
-00034860: 7468 6174 2063 6173 652e 220a 2020 2020  that case.".    
-00034870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034880: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00034890: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000348a0: 5469 6d65 6f75 7445 7272 6f72 286d 7367  TimeoutError(msg
-000348b0: 2920 6672 6f6d 204e 6f6e 650a 2020 2020  ) from None.    
-000348c0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-000348d0: 2252 6573 7461 7274 696e 6720 6669 6e69  "Restarting fini
-000348e0: 7368 6564 2e22 290a 0a20 2020 2061 7379  shed.")..    asy
-000348f0: 6e63 2064 6566 2062 726f 6164 6361 7374  nc def broadcast
-00034900: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00034910: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00034920: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
-00034930: 2020 2020 2020 776f 726b 6572 733a 206c        workers: l
-00034940: 6973 745b 7374 725d 207c 204e 6f6e 6520  ist[str] | None 
-00034950: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00034960: 686f 7374 733a 206c 6973 745b 7374 725d  hosts: list[str]
-00034970: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00034980: 2020 2020 2020 2020 6e61 6e6e 793a 2062          nanny: b
-00034990: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-000349a0: 2020 2020 2073 6572 6961 6c69 7a65 7273       serializers
-000349b0: 3a20 416e 7920 3d20 4e6f 6e65 2c0a 2020  : Any = None,.  
-000349c0: 2020 2020 2020 6f6e 5f65 7272 6f72 3a20        on_error: 
-000349d0: 224c 6974 6572 616c 5b27 7261 6973 6527  "Literal['raise'
-000349e0: 2c20 2772 6574 7572 6e27 2c20 2772 6574  , 'return', 'ret
-000349f0: 7572 6e5f 7069 636b 6c65 272c 2027 6967  urn_pickle', 'ig
-00034a00: 6e6f 7265 275d 2220 3d20 2272 6169 7365  nore']" = "raise
-00034a10: 222c 0a20 2020 2029 202d 3e20 6469 6374  ",.    ) -> dict
-00034a20: 3a20 2023 2064 6963 745b 7374 722c 2041  :  # dict[str, A
-00034a30: 6e79 5d0a 2020 2020 2020 2020 2222 2242  ny].        """B
-00034a40: 726f 6164 6361 7374 206d 6573 7361 6765  roadcast message
-00034a50: 2074 6f20 776f 726b 6572 732c 2072 6574   to workers, ret
-00034a60: 7572 6e20 616c 6c20 7265 7375 6c74 7322  urn all results"
-00034a70: 2222 0a20 2020 2020 2020 2069 6620 776f  "".        if wo
-00034a80: 726b 6572 7320 6973 204e 6f6e 653a 0a20  rkers is None:. 
-00034a90: 2020 2020 2020 2020 2020 2069 6620 686f             if ho
-00034aa0: 7374 7320 6973 204e 6f6e 653a 0a20 2020  sts is None:.   
-00034ab0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-00034ac0: 6b65 7273 203d 206c 6973 7428 7365 6c66  kers = list(self
-00034ad0: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
-00034ae0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00034af0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00034b00: 6572 7320 3d20 5b5d 0a20 2020 2020 2020  ers = [].       
-00034b10: 2069 6620 686f 7374 7320 6973 206e 6f74   if hosts is not
-00034b20: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00034b30: 2020 2066 6f72 2068 6f73 7420 696e 2068     for host in h
-00034b40: 6f73 7473 3a0a 2020 2020 2020 2020 2020  osts:.          
-00034b50: 2020 2020 2020 6468 3a20 6469 6374 203d        dh: dict =
-00034b60: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
-00034b70: 6765 7428 686f 7374 2920 2023 2074 7970  get(host)  # typ
-00034b80: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00034b90: 2020 2020 2020 2020 2020 6966 2064 6820            if dh 
-00034ba0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00034bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034bc0: 2077 6f72 6b65 7273 2e65 7874 656e 6428   workers.extend(
-00034bd0: 6468 5b22 6164 6472 6573 7365 7322 5d29  dh["addresses"])
-00034be0: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-00034bf0: 7265 706c 6163 6520 7769 7468 2077 6f72  replace with wor
-00034c00: 6b65 725f 6c69 7374 0a0a 2020 2020 2020  ker_list..      
-00034c10: 2020 6966 206e 616e 6e79 3a0a 2020 2020    if nanny:.    
-00034c20: 2020 2020 2020 2020 6164 6472 6573 7365          addresse
-00034c30: 7320 3d20 5b73 656c 662e 776f 726b 6572  s = [self.worker
-00034c40: 735b 775d 2e6e 616e 6e79 2066 6f72 2077  s[w].nanny for w
-00034c50: 2069 6e20 776f 726b 6572 735d 0a20 2020   in workers].   
-00034c60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00034c70: 2020 2020 2020 2061 6464 7265 7373 6573         addresses
-00034c80: 203d 2077 6f72 6b65 7273 0a0a 2020 2020   = workers..    
-00034c90: 2020 2020 4552 524f 5220 3d20 6f62 6a65      ERROR = obje
-00034ca0: 6374 2829 0a0a 2020 2020 2020 2020 6173  ct()..        as
-00034cb0: 796e 6320 6465 6620 7365 6e64 5f6d 6573  ync def send_mes
-00034cc0: 7361 6765 2861 6464 7229 3a0a 2020 2020  sage(addr):.    
-00034cd0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00034ce0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-00034cf0: 6d20 3d20 6177 6169 7420 7365 6c66 2e72  m = await self.r
-00034d00: 7063 2e63 6f6e 6e65 6374 2861 6464 7229  pc.connect(addr)
-00034d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034d20: 2063 6f6d 6d2e 6e61 6d65 203d 2022 5363   comm.name = "Sc
-00034d30: 6865 6475 6c65 7220 4272 6f61 6463 6173  heduler Broadcas
-00034d40: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
-00034d50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00034d60: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-00034d70: 203d 2061 7761 6974 2073 656e 645f 7265   = await send_re
-00034d80: 6376 280a 2020 2020 2020 2020 2020 2020  cv(.            
-00034d90: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00034da0: 2c20 636c 6f73 653d 5472 7565 2c20 7365  , close=True, se
-00034db0: 7269 616c 697a 6572 733d 7365 7269 616c  rializers=serial
-00034dc0: 697a 6572 732c 202a 2a6d 7367 0a20 2020  izers, **msg.   
-00034dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034de0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00034df0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-00034e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034e10: 7365 6c66 2e72 7063 2e72 6575 7365 2861  self.rpc.reuse(a
-00034e20: 6464 722c 2063 6f6d 6d29 0a20 2020 2020  ddr, comm).     
-00034e30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00034e40: 6e20 7265 7370 0a20 2020 2020 2020 2020  n resp.         
-00034e50: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00034e60: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00034e70: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00034e80: 2e65 7272 6f72 2866 2262 726f 6164 6361  .error(f"broadca
-00034e90: 7374 2074 6f20 7b61 6464 727d 2066 6169  st to {addr} fai
-00034ea0: 6c65 643a 207b 652e 5f5f 636c 6173 735f  led: {e.__class_
-00034eb0: 5f2e 5f5f 6e61 6d65 5f5f 7d3a 207b 657d  _.__name__}: {e}
-00034ec0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00034ed0: 2020 2069 6620 6f6e 5f65 7272 6f72 203d     if on_error =
-00034ee0: 3d20 2272 6169 7365 223a 0a20 2020 2020  = "raise":.     
-00034ef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00034f00: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
-00034f10: 2020 2020 2065 6c69 6620 6f6e 5f65 7272       elif on_err
-00034f20: 6f72 203d 3d20 2272 6574 7572 6e22 3a0a  or == "return":.
+000346f0: 2072 6561 736f 6e3d 2273 6368 6564 756c   reason="schedul
+00034700: 6572 2d72 6573 7461 7274 222c 0a20 2020  er-restart",.   
+00034710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034720: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00034730: 3d74 696d 656f 7574 2c0a 2020 2020 2020  =timeout,.      
+00034740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034750: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00034760: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00034770: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
+00034780: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00034790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000347a0: 666f 7220 6e61 6e6e 7920 696e 206e 616e  for nanny in nan
+000347b0: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
+000347c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+000347d0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+000347e0: 7863 6570 7469 6f6e 733d 5472 7565 2c0a  xceptions=True,.
+000347f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00034800: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00034810: 3a20 7468 6520 6057 6f72 6b65 7253 7461  : the `WorkerSta
+00034820: 7465 6020 656e 7472 6965 7320 666f 7220  te` entries for 
+00034830: 7468 6573 6520 776f 726b 6572 7320 7769  these workers wi
+00034840: 6c6c 2062 6520 7265 6d6f 7665 640a 2020  ll be removed.  
+00034850: 2020 2020 2020 2020 2020 2320 6e61 7475            # natu
+00034860: 7261 6c6c 7920 7768 656e 2074 6865 7920  rally when they 
+00034870: 6469 7363 6f6e 6e65 6374 2066 726f 6d20  disconnect from 
+00034880: 7468 6520 7363 6865 6475 6c65 722e 0a0a  the scheduler...
+00034890: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+000348a0: 6d6f 7665 2061 6e79 2077 6f72 6b65 7273  move any workers
+000348b0: 2074 6861 7420 6661 696c 6564 2074 6f20   that failed to 
+000348c0: 7368 7574 2064 6f77 6e2c 2073 6f20 7765  shut down, so we
+000348d0: 2063 616e 2067 7561 7261 6e74 6565 0a20   can guarantee. 
+000348e0: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
+000348f0: 7420 6166 7465 7220 6072 6573 7461 7274  t after `restart
+00034900: 602c 2074 6865 7265 2061 7265 206e 6f20  `, there are no 
+00034910: 6f6c 6420 776f 726b 6572 7320 6172 6f75  old workers arou
+00034920: 6e64 2e0a 2020 2020 2020 2020 2020 2020  nd..            
+00034930: 6261 645f 6e61 6e6e 6965 7320 3d20 5b0a  bad_nannies = [.
+00034940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034950: 6164 6472 2066 6f72 2061 6464 722c 2072  addr for addr, r
+00034960: 6573 7020 696e 207a 6970 286e 616e 6e79  esp in zip(nanny
+00034970: 5f77 6f72 6b65 7273 2c20 7265 7370 7329  _workers, resps)
+00034980: 2069 6620 7265 7370 2069 7320 6e6f 7420   if resp is not 
+00034990: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000349a0: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
+000349b0: 6620 6261 645f 6e61 6e6e 6965 733a 0a20  f bad_nannies:. 
+000349c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000349d0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+000349e0: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+000349f0: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
+00034a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034a10: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+00034a20: 776f 726b 6572 2861 6464 722c 2073 7469  worker(addr, sti
+00034a30: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00034a40: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
+00034a50: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00034a60: 7220 6164 6472 2069 6e20 6261 645f 6e61  r addr in bad_na
+00034a70: 6e6e 6965 730a 2020 2020 2020 2020 2020  nnies.          
+00034a80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00034a90: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00034aa0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00034ab0: 6169 7365 2054 696d 656f 7574 4572 726f  aise TimeoutErro
+00034ac0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00034ad0: 2020 2020 2020 2066 227b 6c65 6e28 6261         f"{len(ba
+00034ae0: 645f 6e61 6e6e 6965 7329 7d2f 7b6c 656e  d_nannies)}/{len
+00034af0: 286e 616e 6e69 6573 297d 206e 616e 6e79  (nannies)} nanny
+00034b00: 2077 6f72 6b65 7228 7329 2064 6964 206e   worker(s) did n
+00034b10: 6f74 2073 6875 7420 646f 776e 2077 6974  ot shut down wit
+00034b20: 6869 6e20 7b74 696d 656f 7574 7d73 220a  hin {timeout}s".
+00034b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034b40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00034b50: 6c6f 675f 6576 656e 7428 5b63 6c69 656e  log_event([clien
+00034b60: 742c 2022 616c 6c22 5d2c 207b 2261 6374  t, "all"], {"act
+00034b70: 696f 6e22 3a20 2272 6573 7461 7274 222c  ion": "restart",
+00034b80: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
+00034b90: 747d 290a 0a20 2020 2020 2020 2069 6620  t})..        if 
+00034ba0: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
+00034bb0: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
+00034bc0: 696c 6520 6c65 6e28 7365 6c66 2e77 6f72  ile len(self.wor
+00034bd0: 6b65 7273 2920 3c20 6e5f 776f 726b 6572  kers) < n_worker
+00034be0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00034bf0: 2020 2023 204e 4f54 453a 2069 6620 6e65     # NOTE: if ne
+00034c00: 7720 2875 6e72 656c 6174 6564 2920 776f  w (unrelated) wo
+00034c10: 726b 6572 7320 6a6f 696e 2077 6869 6c65  rkers join while
+00034c20: 2077 6527 7265 2077 6169 7469 6e67 2c20   we're waiting, 
+00034c30: 7765 206d 6179 2072 6574 7572 6e20 6265  we may return be
+00034c40: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
+00034c50: 2020 2020 2023 206f 7572 2073 6875 742d       # our shut-
+00034c60: 646f 776e 2077 6f72 6b65 7273 2068 6176  down workers hav
+00034c70: 6520 636f 6d65 2062 6163 6b20 7570 2e20  e come back up. 
+00034c80: 5468 6174 2773 2066 696e 653b 2077 6f72  That's fine; wor
+00034c90: 6b65 7273 2061 7265 2069 6e74 6572 6368  kers are interch
+00034ca0: 616e 6765 6162 6c65 2e0a 2020 2020 2020  angeable..      
+00034cb0: 2020 2020 2020 2020 2020 6966 206d 6f6e            if mon
+00034cc0: 6f74 6f6e 6963 2829 203c 2073 7461 7274  otonic() < start
+00034cd0: 202b 2074 696d 656f 7574 3a0a 2020 2020   + timeout:.    
+00034ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034cf0: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
+00034d00: 6565 7028 302e 3229 0a20 2020 2020 2020  eep(0.2).       
+00034d10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00034d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034d30: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
+00034d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034d50: 2020 2066 2257 6169 7465 6420 666f 7220     f"Waited for 
+00034d60: 7b6e 5f77 6f72 6b65 7273 7d20 776f 726b  {n_workers} work
+00034d70: 6572 2873 2920 746f 2072 6563 6f6e 6e65  er(s) to reconne
+00034d80: 6374 2061 6674 6572 2072 6573 7461 7274  ct after restart
+00034d90: 696e 672c 2022 0a20 2020 2020 2020 2020  ing, ".         
+00034da0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00034db0: 2262 7574 2061 6674 6572 207b 7469 6d65  "but after {time
+00034dc0: 6f75 747d 732c 206f 6e6c 7920 7b6c 656e  out}s, only {len
+00034dd0: 2873 656c 662e 776f 726b 6572 7329 7d20  (self.workers)} 
+00034de0: 6861 7665 2072 6574 7572 6e65 642e 2022  have returned. "
+00034df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034e00: 2020 2020 2020 2020 2022 436f 6e73 6964           "Consid
+00034e10: 6572 2061 206c 6f6e 6765 7220 7469 6d65  er a longer time
+00034e20: 6f75 742c 206f 7220 6077 6169 745f 666f  out, or `wait_fo
+00034e30: 725f 776f 726b 6572 733d 4661 6c73 6560  r_workers=False`
+00034e40: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00034e50: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00034e60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00034e70: 2028 6e5f 6e61 6e6e 7920 3a3d 206c 656e   (n_nanny := len
+00034e80: 286e 616e 6e79 5f77 6f72 6b65 7273 2929  (nanny_workers))
+00034e90: 203c 206e 5f77 6f72 6b65 7273 3a0a 2020   < n_workers:.  
+00034ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034eb0: 2020 2020 2020 6d73 6720 2b3d 2028 0a20        msg += (. 
+00034ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ed0: 2020 2020 2020 2020 2020 2066 2220 5468             f" Th
+00034ee0: 6520 7b6e 5f77 6f72 6b65 7273 202d 206e  e {n_workers - n
+00034ef0: 5f6e 616e 6e79 7d20 776f 726b 6572 2873  _nanny} worker(s
+00034f00: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
+00034f10: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
+00034f20: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
 00034f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034f40: 2020 2020 7265 7475 726e 2065 0a20 2020      return e.   
-00034f50: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00034f60: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
-00034f70: 6574 7572 6e5f 7069 636b 6c65 223a 0a20  eturn_pickle":. 
-00034f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034f90: 2020 2072 6574 7572 6e20 6475 6d70 7328     return dumps(
-00034fa0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00034fb0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
-00034fc0: 203d 3d20 2269 676e 6f72 6522 3a0a 2020   == "ignore":.  
-00034fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034fe0: 2020 7265 7475 726e 2045 5252 4f52 0a20    return ERROR. 
-00034ff0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00035000: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00035010: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00035020: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-00035030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035040: 2020 2022 6f6e 5f65 7272 6f72 206d 7573     "on_error mus
-00035050: 7420 6265 2027 7261 6973 6527 2c20 2772  t be 'raise', 'r
-00035060: 6574 7572 6e27 2c20 2772 6574 7572 6e5f  eturn', 'return_
-00035070: 7069 636b 6c65 272c 2022 0a20 2020 2020  pickle', ".     
-00035080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035090: 2020 2066 226f 7220 2769 676e 6f72 6527     f"or 'ignore'
-000350a0: 3b20 676f 7420 7b6f 6e5f 6572 726f 7221  ; got {on_error!
-000350b0: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
-000350c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000350d0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
-000350e0: 6974 2041 6c6c 280a 2020 2020 2020 2020  it All(.        
-000350f0: 2020 2020 5b73 656e 645f 6d65 7373 6167      [send_messag
-00035100: 6528 6164 6472 6573 7329 2066 6f72 2061  e(address) for a
-00035110: 6464 7265 7373 2069 6e20 6164 6472 6573  ddress in addres
-00035120: 7365 7320 6966 2061 6464 7265 7373 2069  ses if address i
-00035130: 7320 6e6f 7420 4e6f 6e65 5d0a 2020 2020  s not None].    
-00035140: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
-00035150: 6574 7572 6e20 7b6b 3a20 7620 666f 7220  eturn {k: v for 
-00035160: 6b2c 2076 2069 6e20 7a69 7028 776f 726b  k, v in zip(work
-00035170: 6572 732c 2072 6573 756c 7473 2920 6966  ers, results) if
-00035180: 2076 2069 7320 6e6f 7420 4552 524f 527d   v is not ERROR}
-00035190: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000351a0: 7072 6f78 7928 0a20 2020 2020 2020 2073  proxy(.        s
-000351b0: 656c 662c 0a20 2020 2020 2020 206d 7367  elf,.        msg
-000351c0: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
-000351d0: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
-000351e0: 2020 2020 2073 6572 6961 6c69 7a65 7273       serializers
-000351f0: 3a20 416e 7920 3d20 4e6f 6e65 2c0a 2020  : Any = None,.  
-00035200: 2020 2920 2d3e 2041 6e79 3a0a 2020 2020    ) -> Any:.    
-00035210: 2020 2020 2222 2250 726f 7879 2061 2063      """Proxy a c
-00035220: 6f6d 6d75 6e69 6361 7469 6f6e 2074 6872  ommunication thr
-00035230: 6f75 6768 2074 6865 2073 6368 6564 756c  ough the schedul
-00035240: 6572 2074 6f20 736f 6d65 206f 7468 6572  er to some other
-00035250: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
-00035260: 2020 2064 203d 2061 7761 6974 2073 656c     d = await sel
-00035270: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00035280: 6d73 672c 2077 6f72 6b65 7273 3d5b 776f  msg, workers=[wo
-00035290: 726b 6572 5d2c 2073 6572 6961 6c69 7a65  rker], serialize
-000352a0: 7273 3d73 6572 6961 6c69 7a65 7273 290a  rs=serializers).
-000352b0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-000352c0: 5b77 6f72 6b65 725d 0a0a 2020 2020 6173  [worker]..    as
-000352d0: 796e 6320 6465 6620 6761 7468 6572 5f6f  ync def gather_o
-000352e0: 6e5f 776f 726b 6572 280a 2020 2020 2020  n_worker(.      
-000352f0: 2020 7365 6c66 2c20 776f 726b 6572 5f61    self, worker_a
-00035300: 6464 7265 7373 3a20 7374 722c 2077 686f  ddress: str, who
-00035310: 5f68 6173 3a20 2264 6963 745b 7374 722c  _has: "dict[str,
-00035320: 206c 6973 745b 7374 725d 5d22 0a20 2020   list[str]]".   
-00035330: 2029 202d 3e20 7365 743a 0a20 2020 2020   ) -> set:.     
-00035340: 2020 2022 2222 5065 6572 2d74 6f2d 7065     """Peer-to-pe
-00035350: 6572 2063 6f70 7920 6f66 206b 6579 7320  er copy of keys 
-00035360: 6672 6f6d 206d 756c 7469 706c 6520 776f  from multiple wo
-00035370: 726b 6572 7320 746f 2061 2073 696e 676c  rkers to a singl
-00035380: 6520 776f 726b 6572 0a0a 2020 2020 2020  e worker..      
-00035390: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-000353a0: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-000353b0: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
-000353c0: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
-000353d0: 2020 2020 2020 2020 5265 6369 7069 656e          Recipien
-000353e0: 7420 776f 726b 6572 2061 6464 7265 7373  t worker address
-000353f0: 2074 6f20 636f 7079 206b 6579 7320 746f   to copy keys to
-00035400: 0a20 2020 2020 2020 2077 686f 5f68 6173  .        who_has
-00035410: 3a20 6469 6374 5b48 6173 6861 626c 652c  : dict[Hashable,
-00035420: 206c 6973 745b 7374 725d 5d0a 2020 2020   list[str]].    
-00035430: 2020 2020 2020 2020 7b6b 6579 3a20 5b73          {key: [s
-00035440: 656e 6465 7220 6164 6472 6573 732c 2073  ender address, s
-00035450: 656e 6465 7220 6164 6472 6573 732c 202e  ender address, .
-00035460: 2e2e 5d2c 206b 6579 3a20 2e2e 2e7d 0a0a  ..], key: ...}..
-00035470: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-00035480: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-00035490: 2020 2020 2020 2020 7265 7475 726e 733a          returns:
-000354a0: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
-000354b0: 206f 6620 6b65 7973 2074 6861 7420 6661   of keys that fa
-000354c0: 696c 6564 2074 6f20 6265 2063 6f70 6965  iled to be copie
-000354d0: 640a 2020 2020 2020 2020 2222 220a 2020  d.        """.  
-000354e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000354f0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00035500: 6177 6169 7420 7265 7472 795f 6f70 6572  await retry_oper
-00035510: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-00035520: 2020 2020 2020 2073 656c 662e 7270 6328         self.rpc(
-00035530: 6164 6472 3d77 6f72 6b65 725f 6164 6472  addr=worker_addr
-00035540: 6573 7329 2e67 6174 6865 722c 2077 686f  ess).gather, who
-00035550: 5f68 6173 3d77 686f 5f68 6173 0a20 2020  _has=who_has.   
-00035560: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00035570: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
-00035580: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-00035590: 2020 2020 2320 5468 6973 2063 616e 2068      # This can h
-000355a0: 6170 7065 6e20 652e 672e 2069 6620 7468  appen e.g. if th
-000355b0: 6520 776f 726b 6572 2069 7320 676f 696e  e worker is goin
-000355c0: 6720 7468 726f 7567 6820 636f 6e74 726f  g through contro
-000355d0: 6c6c 6564 2073 6875 7464 6f77 6e3b 0a20  lled shutdown;. 
-000355e0: 2020 2020 2020 2020 2020 2023 2069 7420             # it 
-000355f0: 646f 6573 6e27 7420 6e65 6365 7373 6172  doesn't necessar
-00035600: 696c 7920 6d65 616e 2074 6861 7420 6974  ily mean that it
-00035610: 2077 656e 7420 756e 6578 7065 6374 6564   went unexpected
-00035620: 6c79 206d 6973 7369 6e67 0a20 2020 2020  ly missing.     
-00035630: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00035640: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
-00035650: 2020 2020 2020 2066 2243 6f6d 6d75 6e69         f"Communi
-00035660: 6361 7469 6f6e 2077 6974 6820 776f 726b  cation with work
-00035670: 6572 207b 776f 726b 6572 5f61 6464 7265  er {worker_addre
-00035680: 7373 7d20 6661 696c 6564 2064 7572 696e  ss} failed durin
-00035690: 6720 220a 2020 2020 2020 2020 2020 2020  g ".            
-000356a0: 2020 2020 6622 7265 706c 6963 6174 696f      f"replicatio
-000356b0: 6e3a 207b 652e 5f5f 636c 6173 735f 5f2e  n: {e.__class__.
-000356c0: 5f5f 6e61 6d65 5f5f 7d3a 207b 657d 220a  __name__}: {e}".
-000356d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000356e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000356f0: 2073 6574 2877 686f 5f68 6173 290a 0a20   set(who_has).. 
-00035700: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
-00035710: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
-00035720: 6b65 725f 6164 6472 6573 7329 0a0a 2020  ker_address)..  
-00035730: 2020 2020 2020 6966 206e 6f74 2077 733a        if not ws:
-00035740: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00035750: 6765 722e 7761 726e 696e 6728 6622 576f  ger.warning(f"Wo
-00035760: 726b 6572 207b 776f 726b 6572 5f61 6464  rker {worker_add
-00035770: 7265 7373 7d20 6c6f 7374 2064 7572 696e  ress} lost durin
-00035780: 6720 7265 706c 6963 6174 696f 6e22 290a  g replication").
-00035790: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000357a0: 726e 2073 6574 2877 686f 5f68 6173 290a  rn set(who_has).
-000357b0: 2020 2020 2020 2020 656c 6966 2072 6573          elif res
-000357c0: 756c 745b 2273 7461 7475 7322 5d20 3d3d  ult["status"] ==
-000357d0: 2022 4f4b 223a 0a20 2020 2020 2020 2020   "OK":.         
-000357e0: 2020 206b 6579 735f 6661 696c 6564 203d     keys_failed =
-000357f0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-00035800: 2020 206b 6579 735f 6f6b 3a20 5365 7420     keys_ok: Set 
-00035810: 3d20 7768 6f5f 6861 732e 6b65 7973 2829  = who_has.keys()
-00035820: 0a20 2020 2020 2020 2065 6c69 6620 7265  .        elif re
-00035830: 7375 6c74 5b22 7374 6174 7573 225d 203d  sult["status"] =
-00035840: 3d20 2270 6172 7469 616c 2d66 6169 6c22  = "partial-fail"
-00035850: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-00035860: 7973 5f66 6169 6c65 6420 3d20 7365 7428  ys_failed = set(
-00035870: 7265 7375 6c74 5b22 6b65 7973 225d 290a  result["keys"]).
-00035880: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00035890: 5f6f 6b20 3d20 7768 6f5f 6861 732e 6b65  _ok = who_has.ke
-000358a0: 7973 2829 202d 206b 6579 735f 6661 696c  ys() - keys_fail
-000358b0: 6564 0a20 2020 2020 2020 2020 2020 206c  ed.            l
-000358c0: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
-000358d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000358e0: 2257 6f72 6b65 7220 7b77 6f72 6b65 725f  "Worker {worker_
-000358f0: 6164 6472 6573 737d 2066 6169 6c65 6420  address} failed 
-00035900: 746f 2061 6371 7569 7265 206b 6579 733a  to acquire keys:
-00035910: 207b 7265 7375 6c74 5b27 6b65 7973 275d   {result['keys']
-00035920: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00035930: 0a20 2020 2020 2020 2065 6c73 653a 2020  .        else:  
-00035940: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
-00035950: 720a 2020 2020 2020 2020 2020 2020 7261  r.            ra
-00035960: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00035970: 2255 6e65 7870 6563 7465 6420 6d65 7373  "Unexpected mess
-00035980: 6167 6520 6672 6f6d 207b 776f 726b 6572  age from {worker
-00035990: 5f61 6464 7265 7373 7d3a 207b 7265 7375  _address}: {resu
-000359a0: 6c74 7d22 290a 0a20 2020 2020 2020 2066  lt}")..        f
-000359b0: 6f72 206b 6579 2069 6e20 6b65 7973 5f6f  or key in keys_o
-000359c0: 6b3a 0a20 2020 2020 2020 2020 2020 2074  k:.            t
-000359d0: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
-000359e0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-000359f0: 7929 2020 2320 7479 7065 3a20 6967 6e6f  y)  # type: igno
-00035a00: 7265 0a20 2020 2020 2020 2020 2020 2069  re.            i
-00035a10: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
-00035a20: 7473 2e73 7461 7465 2021 3d20 226d 656d  ts.state != "mem
-00035a30: 6f72 7922 3a0a 2020 2020 2020 2020 2020  ory":.          
-00035a40: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00035a50: 6e69 6e67 2866 224b 6579 206c 6f73 7420  ning(f"Key lost 
-00035a60: 6475 7269 6e67 2072 6570 6c69 6361 7469  during replicati
-00035a70: 6f6e 3a20 7b6b 6579 7d22 290a 2020 2020  on: {key}").    
-00035a80: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00035a90: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00035aa0: 2069 6620 7773 206e 6f74 2069 6e20 7473   if ws not in ts
-00035ab0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-00035ac0: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
-00035ad0: 6464 5f72 6570 6c69 6361 2874 732c 2077  dd_replica(ts, w
-00035ae0: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-00035af0: 726e 206b 6579 735f 6661 696c 6564 0a0a  rn keys_failed..
-00035b00: 2020 2020 6173 796e 6320 6465 6620 6465      async def de
-00035b10: 6c65 7465 5f77 6f72 6b65 725f 6461 7461  lete_worker_data
-00035b20: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-00035b30: 776f 726b 6572 5f61 6464 7265 7373 3a20  worker_address: 
-00035b40: 7374 722c 206b 6579 733a 2022 436f 6c6c  str, keys: "Coll
-00035b50: 6563 7469 6f6e 5b73 7472 5d22 2c20 7374  ection[str]", st
-00035b60: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
-00035b70: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00035b80: 2020 2020 2020 2222 2244 656c 6574 6520        """Delete 
-00035b90: 6461 7461 2066 726f 6d20 6120 776f 726b  data from a work
-00035ba0: 6572 2061 6e64 2075 7064 6174 6520 7468  er and update th
-00035bb0: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
-00035bc0: 776f 726b 6572 2f74 6173 6b20 7374 6174  worker/task stat
-00035bd0: 6573 0a0a 2020 2020 2020 2020 5061 7261  es..        Para
-00035be0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
-00035bf0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-00035c00: 2020 776f 726b 6572 5f61 6464 7265 7373    worker_address
-00035c10: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
-00035c20: 2020 576f 726b 6572 2061 6464 7265 7373    Worker address
-00035c30: 2074 6f20 6465 6c65 7465 206b 6579 7320   to delete keys 
-00035c40: 6672 6f6d 0a20 2020 2020 2020 206b 6579  from.        key
-00035c50: 733a 206c 6973 745b 7374 725d 0a20 2020  s: list[str].   
-00035c60: 2020 2020 2020 2020 204c 6973 7420 6f66           List of
-00035c70: 206b 6579 7320 746f 2064 656c 6574 6520   keys to delete 
-00035c80: 6f6e 2074 6865 2073 7065 6369 6669 6564  on the specified
-00035c90: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-00035ca0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00035cb0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00035cc0: 6974 2072 6574 7279 5f6f 7065 7261 7469  it retry_operati
-00035cd0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00035ce0: 2020 2020 7365 6c66 2e72 7063 2861 6464      self.rpc(add
-00035cf0: 723d 776f 726b 6572 5f61 6464 7265 7373  r=worker_address
-00035d00: 292e 6672 6565 5f6b 6579 732c 0a20 2020  ).free_keys,.   
-00035d10: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00035d20: 733d 6c69 7374 286b 6579 7329 2c0a 2020  s=list(keys),.  
-00035d30: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00035d40: 696d 756c 7573 5f69 643d 6622 6465 6c65  imulus_id=f"dele
-00035d50: 7465 2d64 6174 612d 7b74 696d 6528 297d  te-data-{time()}
-00035d60: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
-00035d70: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00035d80: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
-00035d90: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-00035da0: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
-00035db0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
-00035dc0: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
-00035dd0: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
-00035de0: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
-00035df0: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
-00035e00: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
-00035e10: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
-00035e20: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
-00035e30: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00035e40: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00035e50: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
-00035e60: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
-00035e70: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
-00035e80: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
-00035e90: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
-00035ea0: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
-00035eb0: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
-00035ec0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
-00035ed0: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
-00035ee0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00035ef0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00035f00: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
-00035f10: 732e 6765 7428 776f 726b 6572 5f61 6464  s.get(worker_add
-00035f20: 7265 7373 290a 2020 2020 2020 2020 6966  ress).        if
-00035f30: 206e 6f74 2077 733a 0a20 2020 2020 2020   not ws:.       
-00035f40: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00035f50: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00035f60: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-00035f70: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-00035f80: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-00035f90: 286b 6579 2920 2023 2074 7970 653a 2069  (key)  # type: i
-00035fa0: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
-00035fb0: 2020 6966 2074 7320 6973 206e 6f74 204e    if ts is not N
-00035fc0: 6f6e 6520 616e 6420 7773 2069 6e20 7473  one and ws in ts
-00035fd0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-00035fe0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00035ff0: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
-00036000: 6d6f 7279 220a 2020 2020 2020 2020 2020  mory".          
-00036010: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00036020: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
-00036030: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00036040: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
-00036050: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-00036060: 2020 2020 2020 2020 2023 204c 6173 7420           # Last 
-00036070: 636f 7079 2064 656c 6574 6564 0a20 2020  copy deleted.   
-00036080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036090: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-000360a0: 7328 7b6b 6579 3a20 2272 656c 6561 7365  s({key: "release
-000360b0: 6422 7d2c 2073 7469 6d75 6c75 735f 6964  d"}, stimulus_id
-000360c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000360d0: 6c6f 675f 6576 656e 7428 7773 2e61 6464  log_event(ws.add
-000360e0: 7265 7373 2c20 7b22 6163 7469 6f6e 223a  ress, {"action":
-000360f0: 2022 7265 6d6f 7665 2d77 6f72 6b65 722d   "remove-worker-
-00036100: 6461 7461 222c 2022 6b65 7973 223a 206b  data", "keys": k
-00036110: 6579 737d 290a 0a20 2020 2040 6c6f 675f  eys})..    @log_
-00036120: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00036130: 2064 6566 2072 6562 616c 616e 6365 280a   def rebalance(.
-00036140: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00036150: 2020 2020 2020 6b65 7973 3a20 4974 6572        keys: Iter
-00036160: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
-00036170: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00036180: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-00036190: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
-000361a0: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-000361b0: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
-000361c0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-000361d0: 2020 2029 202d 3e20 6469 6374 3a0a 2020     ) -> dict:.  
-000361e0: 2020 2020 2020 2222 2252 6562 616c 616e        """Rebalan
-000361f0: 6365 206b 6579 7320 736f 2074 6861 7420  ce keys so that 
-00036200: 6561 6368 2077 6f72 6b65 7220 656e 6473  each worker ends
-00036210: 2075 7020 7769 7468 2072 6f75 6768 6c79   up with roughly
-00036220: 2074 6865 2073 616d 6520 7072 6f63 6573   the same proces
-00036230: 730a 2020 2020 2020 2020 6d65 6d6f 7279  s.        memory
-00036240: 2028 6d61 6e61 6765 642b 756e 6d61 6e61   (managed+unmana
-00036250: 6765 6429 2e0a 0a20 2020 2020 2020 202e  ged)...        .
-00036260: 2e20 7761 726e 696e 673a 3a0a 2020 2020  . warning::.    
-00036270: 2020 2020 2020 2054 6869 7320 6f70 6572         This oper
-00036280: 6174 696f 6e20 6973 2067 656e 6572 616c  ation is general
-00036290: 6c79 206e 6f74 2077 656c 6c20 7465 7374  ly not well test
-000362a0: 6564 2061 6761 696e 7374 206e 6f72 6d61  ed against norma
-000362b0: 6c20 6f70 6572 6174 696f 6e20 6f66 2074  l operation of t
-000362c0: 6865 0a20 2020 2020 2020 2020 2020 7363  he.           sc
-000362d0: 6865 6475 6c65 722e 2049 7420 6973 206e  heduler. It is n
-000362e0: 6f74 2072 6563 6f6d 6d65 6e64 6564 2074  ot recommended t
-000362f0: 6f20 7573 6520 6974 2077 6869 6c65 2077  o use it while w
-00036300: 6169 7469 6e67 206f 6e20 636f 6d70 7574  aiting on comput
-00036310: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
-00036320: 202a 2a41 6c67 6f72 6974 686d 2a2a 0a0a   **Algorithm**..
-00036330: 2020 2020 2020 2020 232e 2046 696e 6420          #. Find 
-00036340: 7468 6520 6d65 616e 206f 6363 7570 616e  the mean occupan
-00036350: 6379 206f 6620 7468 6520 636c 7573 7465  cy of the cluste
-00036360: 722c 2064 6566 696e 6564 2061 7320 6461  r, defined as da
-00036370: 7461 206d 616e 6167 6564 2062 7920 6461  ta managed by da
-00036380: 736b 202b 0a20 2020 2020 2020 2020 2020  sk +.           
-00036390: 756e 6d61 6e61 6765 6420 7072 6f63 6573  unmanaged proces
-000363a0: 7320 6d65 6d6f 7279 2074 6861 7420 6861  s memory that ha
-000363b0: 7320 6265 656e 2074 6865 7265 2066 6f72  s been there for
-000363c0: 2061 7420 6c65 6173 7420 3330 2073 6563   at least 30 sec
-000363d0: 6f6e 6473 0a20 2020 2020 2020 2020 2020  onds.           
-000363e0: 2860 6064 6973 7472 6962 7574 6564 2e77  (``distributed.w
-000363f0: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
-00036400: 656e 742d 746f 2d6f 6c64 2d74 696d 6560  ent-to-old-time`
-00036410: 6029 2e0a 2020 2020 2020 2020 2020 2054  `)..           T
-00036420: 6869 7320 6c65 7473 2075 7320 6967 6e6f  his lets us igno
-00036430: 7265 2074 656d 706f 7261 7279 2073 7069  re temporary spi
-00036440: 6b65 7320 6361 7573 6564 2062 7920 7461  kes caused by ta
-00036450: 736b 2068 6561 7020 7573 6167 652e 0a0a  sk heap usage...
-00036460: 2020 2020 2020 2020 2020 2041 6c74 6572             Alter
-00036470: 6e61 7469 7665 6c79 2c20 796f 7520 6d61  natively, you ma
-00036480: 7920 6368 616e 6765 2068 6f77 206d 656d  y change how mem
-00036490: 6f72 7920 6973 206d 6561 7375 7265 6420  ory is measured 
-000364a0: 626f 7468 2066 6f72 2074 6865 2069 6e64  both for the ind
-000364b0: 6976 6964 7561 6c0a 2020 2020 2020 2020  ividual.        
-000364c0: 2020 2077 6f72 6b65 7273 2061 7320 7765     workers as we
-000364d0: 6c6c 2061 7320 746f 2063 616c 6375 6c61  ll as to calcula
-000364e0: 7465 2074 6865 206d 6561 6e20 7468 726f  te the mean thro
-000364f0: 7567 680a 2020 2020 2020 2020 2020 2060  ugh.           `
-00036500: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
-00036510: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-00036520: 616e 6365 2e6d 6561 7375 7265 6060 2e20  ance.measure``. 
-00036530: 4e61 6d65 6c79 2c20 7468 6973 2063 616e  Namely, this can
-00036540: 2062 6520 7573 6566 756c 0a20 2020 2020   be useful.     
-00036550: 2020 2020 2020 746f 2064 6973 7265 6761        to disrega
-00036560: 7264 2069 6e61 6363 7572 6174 6520 4f53  rd inaccurate OS
-00036570: 206d 656d 6f72 7920 6d65 6173 7572 656d   memory measurem
-00036580: 656e 7473 2e0a 0a20 2020 2020 2020 2023  ents...        #
-00036590: 2e20 4469 7363 6172 6420 776f 726b 6572  . Discard worker
-000365a0: 7320 7768 6f73 6520 6f63 6375 7061 6e63  s whose occupanc
-000365b0: 7920 6973 2077 6974 6869 6e20 3525 206f  y is within 5% o
-000365c0: 6620 7468 6520 6d65 616e 2063 6c75 7374  f the mean clust
-000365d0: 6572 206f 6363 7570 616e 6379 0a20 2020  er occupancy.   
-000365e0: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
-000365f0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-00036600: 6d6f 7279 2e72 6562 616c 616e 6365 2e73  mory.rebalance.s
-00036610: 656e 6465 722d 7265 6369 7069 656e 742d  ender-recipient-
-00036620: 6761 7060 6020 2f20 3229 2e0a 2020 2020  gap`` / 2)..    
-00036630: 2020 2020 2020 2054 6869 7320 6865 6c70         This help
-00036640: 7320 6176 6f69 6420 6461 7461 2066 726f  s avoid data fro
-00036650: 6d20 626f 756e 6369 6e67 2061 726f 756e  m bouncing aroun
-00036660: 6420 7468 6520 636c 7573 7465 7220 7265  d the cluster re
-00036670: 7065 6174 6564 6c79 2e0a 2020 2020 2020  peatedly..      
-00036680: 2020 232e 2057 6f72 6b65 7273 2061 626f    #. Workers abo
-00036690: 7665 2074 6865 206d 6561 6e20 6172 6520  ve the mean are 
-000366a0: 7365 6e64 6572 733b 2074 686f 7365 2062  senders; those b
-000366b0: 656c 6f77 2061 7265 2072 6563 6970 6965  elow are recipie
-000366c0: 6e74 732e 0a20 2020 2020 2020 2023 2e20  nts..        #. 
-000366d0: 4469 7363 6172 6420 7365 6e64 6572 7320  Discard senders 
-000366e0: 7768 6f73 6520 6162 736f 6c75 7465 206f  whose absolute o
-000366f0: 6363 7570 616e 6379 2069 7320 6265 6c6f  ccupancy is belo
-00036700: 7720 3330 250a 2020 2020 2020 2020 2020  w 30%.          
-00036710: 2028 6060 6469 7374 7269 6275 7465 642e   (``distributed.
-00036720: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-00036730: 6261 6c61 6e63 652e 7365 6e64 6572 2d6d  balance.sender-m
-00036740: 696e 6060 292e 2049 6e20 6f74 6865 7220  in``). In other 
-00036750: 776f 7264 732c 206e 6f20 6461 7461 0a20  words, no data. 
-00036760: 2020 2020 2020 2020 2020 6973 206d 6f76            is mov
-00036770: 6564 2072 6567 6172 646c 6573 7320 6f66  ed regardless of
-00036780: 2069 6d62 616c 616e 6369 6e67 2061 7320   imbalancing as 
-00036790: 6c6f 6e67 2061 7320 616c 6c20 776f 726b  long as all work
-000367a0: 6572 7320 6172 6520 6265 6c6f 7720 3330  ers are below 30
-000367b0: 252e 0a20 2020 2020 2020 2023 2e20 4469  %..        #. Di
-000367c0: 7363 6172 6420 7265 6369 7069 656e 7473  scard recipients
-000367d0: 2077 686f 7365 2061 6273 6f6c 7574 6520   whose absolute 
-000367e0: 6f63 6375 7061 6e63 7920 6973 2061 626f  occupancy is abo
-000367f0: 7665 2036 3025 0a20 2020 2020 2020 2020  ve 60%.         
-00036800: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
-00036810: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-00036820: 6562 616c 616e 6365 2e72 6563 6970 6965  ebalance.recipie
-00036830: 6e74 2d6d 6178 6060 292e 0a20 2020 2020  nt-max``)..     
-00036840: 2020 2020 2020 4e6f 7465 2074 6861 7420        Note that 
-00036850: 7468 6973 2074 6872 6573 686f 6c64 2062  this threshold b
-00036860: 7920 6465 6661 756c 7420 6973 2074 6865  y default is the
-00036870: 2073 616d 6520 6173 0a20 2020 2020 2020   same as.       
-00036880: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
-00036890: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-000368a0: 7461 7267 6574 6060 2074 6f20 7072 6576  target`` to prev
-000368b0: 656e 7420 776f 726b 6572 7320 6672 6f6d  ent workers from
-000368c0: 2061 6363 6570 7469 6e67 2064 6174 610a   accepting data.
-000368d0: 2020 2020 2020 2020 2020 2061 6e64 2069             and i
-000368e0: 6d6d 6564 6961 7465 6c79 2073 7069 6c6c  mmediately spill
-000368f0: 696e 6720 6974 206f 7574 2074 6f20 6469  ing it out to di
-00036900: 736b 2e0a 2020 2020 2020 2020 232e 2049  sk..        #. I
-00036910: 7465 7261 7469 7665 6c79 2070 6963 6b20  teratively pick 
-00036920: 7468 6520 7365 6e64 6572 2061 6e64 2072  the sender and r
-00036930: 6563 6970 6965 6e74 2074 6861 7420 6172  ecipient that ar
-00036940: 6520 6661 7274 6865 7374 2066 726f 6d20  e farthest from 
-00036950: 7468 6520 6d65 616e 2061 6e64 0a20 2020  the mean and.   
-00036960: 2020 2020 2020 2020 6d6f 7665 2074 6865          move the
-00036970: 202a 6c65 6173 7420 7265 6365 6e74 6c79   *least recently
-00036980: 2069 6e73 6572 7465 642a 206b 6579 2062   inserted* key b
-00036990: 6574 7765 656e 2074 6865 2074 776f 2c20  etween the two, 
-000369a0: 756e 7469 6c20 6569 7468 6572 2061 6c6c  until either all
-000369b0: 0a20 2020 2020 2020 2020 2020 7365 6e64  .           send
-000369c0: 6572 7320 6f72 2061 6c6c 2072 6563 6970  ers or all recip
-000369d0: 6965 6e74 7320 6661 6c6c 2077 6974 6869  ients fall withi
-000369e0: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
-000369f0: 2e0a 0a20 2020 2020 2020 2020 2020 4120  ...           A 
-00036a00: 7265 6369 7069 656e 7420 7769 6c6c 2062  recipient will b
-00036a10: 6520 736b 6970 7065 6420 6966 2069 7420  e skipped if it 
-00036a20: 616c 7265 6164 7920 6861 7320 6120 636f  already has a co
-00036a30: 7079 206f 6620 7468 6520 6461 7461 2e20  py of the data. 
-00036a40: 496e 206f 7468 6572 0a20 2020 2020 2020  In other.       
-00036a50: 2020 2020 776f 7264 732c 2074 6869 7320      words, this 
-00036a60: 6d65 7468 6f64 2064 6f65 7320 6e6f 7420  method does not 
-00036a70: 6465 6772 6164 6520 7265 706c 6963 6174  degrade replicat
-00036a80: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-00036a90: 4120 6b65 7920 7769 6c6c 2062 6520 736b  A key will be sk
-00036aa0: 6970 7065 6420 6966 2074 6865 7265 2061  ipped if there a
-00036ab0: 7265 206e 6f20 7265 6369 7069 656e 7473  re no recipients
-00036ac0: 2061 7661 696c 6162 6c65 2077 6974 6820   available with 
-00036ad0: 656e 6f75 6768 206d 656d 6f72 790a 2020  enough memory.  
-00036ae0: 2020 2020 2020 2020 2074 6f20 6163 6365           to acce
-00036af0: 7074 2074 6865 206b 6579 2061 6e64 2074  pt the key and t
-00036b00: 6861 7420 646f 6e27 7420 616c 7265 6164  hat don't alread
-00036b10: 7920 686f 6c64 2061 2063 6f70 792e 0a0a  y hold a copy...
-00036b20: 2020 2020 2020 2020 5468 6520 6c65 6173          The leas
-00036b30: 7420 7265 6365 6e74 6c79 2069 6e73 6572  t recently inser
-00036b40: 7464 2028 4c52 4929 2070 6f6c 6963 7920  td (LRI) policy 
-00036b50: 6973 2061 2067 7265 6564 7920 6368 6f69  is a greedy choi
-00036b60: 6365 2077 6974 6820 7468 6520 6164 7661  ce with the adva
-00036b70: 6e74 6167 6520 6f66 0a20 2020 2020 2020  ntage of.       
-00036b80: 2062 6569 6e67 204f 2831 292c 2074 7269   being O(1), tri
-00036b90: 7669 616c 2074 6f20 696d 706c 656d 656e  vial to implemen
-00036ba0: 7420 2869 7420 7265 6c69 6573 206f 6e20  t (it relies on 
-00036bb0: 7079 7468 6f6e 2064 6963 7420 696e 7365  python dict inse
-00036bc0: 7274 696f 6e2d 736f 7274 696e 6729 0a20  rtion-sorting). 
-00036bd0: 2020 2020 2020 2061 6e64 2068 6f70 6566         and hopef
-00036be0: 756c 6c79 2067 6f6f 6420 656e 6f75 6768  ully good enough
-00036bf0: 2069 6e20 6d6f 7374 2063 6173 6573 2e20   in most cases. 
-00036c00: 4469 7363 6172 6465 6420 616c 7465 726e  Discarded altern
-00036c10: 6174 6976 6520 706f 6c69 6369 6573 2077  ative policies w
-00036c20: 6572 653a 0a0a 2020 2020 2020 2020 2d20  ere:..        - 
-00036c30: 4c61 7267 6573 7420 6669 7273 742e 204f  Largest first. O
-00036c40: 286e 2a6c 6f67 286e 2929 2073 6176 6520  (n*log(n)) save 
-00036c50: 666f 7220 6e6f 6e2d 7472 6976 6961 6c20  for non-trivial 
-00036c60: 6164 6469 7469 6f6e 616c 2064 6174 6120  additional data 
-00036c70: 7374 7275 6374 7572 6573 2061 6e64 0a20  structures and. 
-00036c80: 2020 2020 2020 2020 2072 6973 6b73 2063           risks c
-00036c90: 6175 7369 6e67 2074 6865 206c 6172 6765  ausing the large
-00036ca0: 7374 2063 6875 6e6b 7320 6f66 2064 6174  st chunks of dat
-00036cb0: 6120 746f 2072 6570 6561 7465 646c 7920  a to repeatedly 
-00036cc0: 6d6f 7665 2061 726f 756e 6420 7468 650a  move around the.
-00036cd0: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00036ce0: 7220 6c69 6b65 2070 696e 6261 6c6c 732e  r like pinballs.
-00036cf0: 0a20 2020 2020 2020 202d 204c 6561 7374  .        - Least
-00036d00: 2072 6563 656e 746c 7920 7573 6564 2028   recently used (
-00036d10: 4c52 5529 2e20 5468 6973 2069 6e66 6f72  LRU). This infor
-00036d20: 6d61 7469 6f6e 2069 7320 6375 7272 656e  mation is curren
-00036d30: 746c 7920 6176 6169 6c61 626c 6520 6f6e  tly available on
-00036d40: 2074 6865 0a20 2020 2020 2020 2020 2077   the.          w
-00036d50: 6f72 6b65 7273 206f 6e6c 7920 616e 6420  orkers only and 
-00036d60: 6e6f 7420 7472 6976 6961 6c20 746f 2072  not trivial to r
-00036d70: 6570 6c69 6361 7465 206f 6e20 7468 6520  eplicate on the 
-00036d80: 7363 6865 6475 6c65 723b 2074 7261 6e73  scheduler; trans
-00036d90: 6d69 7474 696e 6720 6974 0a20 2020 2020  mitting it.     
-00036da0: 2020 2020 206f 7665 7220 7468 6520 6e65       over the ne
-00036db0: 7477 6f72 6b20 776f 756c 6420 6265 2076  twork would be v
-00036dc0: 6572 7920 6578 7065 6e73 6976 652e 2041  ery expensive. A
-00036dd0: 6c73 6f2c 206e 6f74 6520 7468 6174 2064  lso, note that d
-00036de0: 6173 6b20 7769 6c6c 2067 6f20 6f75 7420  ask will go out 
-00036df0: 6f66 0a20 2020 2020 2020 2020 2069 7473  of.          its
-00036e00: 2077 6179 2074 6f20 6d69 6e69 6d69 7365   way to minimise
-00036e10: 2074 6865 2061 6d6f 756e 7420 6f66 2074   the amount of t
-00036e20: 696d 6520 696e 7465 726d 6564 6961 7465  ime intermediate
-00036e30: 206b 6579 7320 6172 6520 6865 6c64 2069   keys are held i
-00036e40: 6e20 6d65 6d6f 7279 2c0a 2020 2020 2020  n memory,.      
-00036e50: 2020 2020 736f 2069 6e20 7375 6368 2061      so in such a
-00036e60: 2063 6173 6520 4c52 4920 6973 2061 2063   case LRI is a c
-00036e70: 6c6f 7365 2061 7070 726f 7869 6d61 7469  lose approximati
-00036e80: 6f6e 206f 6620 4c52 552e 0a0a 2020 2020  on of LRU...    
-00036e90: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00036ea0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-00036eb0: 2d0a 2020 2020 2020 2020 6b65 7973 3a20  -.        keys: 
-00036ec0: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-00036ed0: 2020 2020 2061 6c6c 6f77 6c69 7374 206f       allowlist o
-00036ee0: 6620 6461 736b 206b 6579 7320 7468 6174  f dask keys that
-00036ef0: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
-00036f00: 6465 7265 6420 666f 7220 6d6f 7669 6e67  dered for moving
-00036f10: 2e20 416c 6c20 6f74 6865 7220 6b65 7973  . All other keys
-00036f20: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
-00036f30: 6c20 6265 2069 676e 6f72 6564 2e20 4e6f  l be ignored. No
-00036f40: 7465 2074 6861 7420 7468 6973 206f 6666  te that this off
-00036f50: 6572 7320 6e6f 2067 7561 7261 6e74 6565  ers no guarantee
-00036f60: 2074 6861 7420 6120 6b65 7920 7769 6c6c   that a key will
-00036f70: 2061 6374 7561 6c6c 790a 2020 2020 2020   actually.      
-00036f80: 2020 2020 2020 6265 206d 6f76 6564 2028        be moved (
-00036f90: 652e 672e 2062 6563 6175 7365 2069 7420  e.g. because it 
-00036fa0: 6973 2075 6e6e 6563 6573 7361 7279 206f  is unnecessary o
-00036fb0: 7220 6265 6361 7573 6520 7468 6572 6520  r because there 
-00036fc0: 6172 6520 6e6f 2076 6961 626c 650a 2020  are no viable.  
-00036fd0: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00036fe0: 656e 7420 776f 726b 6572 7320 666f 7220  ent workers for 
-00036ff0: 6974 292e 0a20 2020 2020 2020 2077 6f72  it)..        wor
-00037000: 6b65 7273 3a20 6f70 7469 6f6e 616c 0a20  kers: optional. 
-00037010: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-00037020: 6c69 7374 206f 6620 776f 726b 6572 7320  list of workers 
-00037030: 6164 6472 6573 7365 7320 746f 2062 6520  addresses to be 
-00037040: 636f 6e73 6964 6572 6564 2061 7320 7365  considered as se
-00037050: 6e64 6572 7320 6f72 2072 6563 6970 6965  nders or recipie
-00037060: 6e74 732e 0a20 2020 2020 2020 2020 2020  nts..           
-00037070: 2041 6c6c 206f 7468 6572 2077 6f72 6b65   All other worke
-00037080: 7273 2077 696c 6c20 6265 2069 676e 6f72  rs will be ignor
-00037090: 6564 2e20 5468 6520 6d65 616e 2063 6c75  ed. The mean clu
-000370a0: 7374 6572 206f 6363 7570 616e 6379 2077  ster occupancy w
-000370b0: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
-000370c0: 2020 2063 616c 6375 6c61 7465 6420 6f6e     calculated on
-000370d0: 6c79 2075 7369 6e67 2074 6865 2061 6c6c  ly using the all
-000370e0: 6f77 6564 2077 6f72 6b65 7273 2e0a 2020  owed workers..  
-000370f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00037100: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00037110: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-00037120: 2272 6562 616c 616e 6365 2d7b 7469 6d65  "rebalance-{time
-00037130: 2829 7d22 0a0a 2020 2020 2020 2020 7773  ()}"..        ws
-00037140: 733a 2043 6f6c 6c65 6374 696f 6e5b 576f  s: Collection[Wo
-00037150: 726b 6572 5374 6174 655d 0a20 2020 2020  rkerState].     
-00037160: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
-00037170: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00037180: 2020 2020 2020 2077 7373 203d 205b 7365         wss = [se
-00037190: 6c66 2e77 6f72 6b65 7273 5b77 5d20 666f  lf.workers[w] fo
-000371a0: 7220 7720 696e 2077 6f72 6b65 7273 5d0a  r w in workers].
-000371b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000371c0: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
-000371d0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-000371e0: 7565 7328 290a 2020 2020 2020 2020 6966  ues().        if
-000371f0: 206e 6f74 2077 7373 3a0a 2020 2020 2020   not wss:.      
-00037200: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
-00037210: 7461 7475 7322 3a20 224f 4b22 7d0a 0a20  tatus": "OK"}.. 
-00037220: 2020 2020 2020 2069 6620 6b65 7973 2069         if keys i
-00037230: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00037240: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00037250: 7369 6e73 7461 6e63 6528 6b65 7973 2c20  sinstance(keys, 
-00037260: 5365 7429 3a0a 2020 2020 2020 2020 2020  Set):.          
-00037270: 2020 2020 2020 6b65 7973 203d 2073 6574        keys = set
-00037280: 286b 6579 7329 2020 2320 756e 6c65 7373  (keys)  # unless
-00037290: 2061 6c72 6561 6479 2061 2073 6574 2d6c   already a set-l
-000372a0: 696b 650a 2020 2020 2020 2020 2020 2020  ike.            
-000372b0: 6966 206e 6f74 206b 6579 733a 0a20 2020  if not keys:.   
-000372c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000372d0: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
-000372e0: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
-000372f0: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
-00037300: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00037310: 2020 6b20 666f 7220 6b20 696e 206b 6579    k for k in key
-00037320: 7320 6966 206b 206e 6f74 2069 6e20 7365  s if k not in se
-00037330: 6c66 2e74 6173 6b73 206f 7220 6e6f 7420  lf.tasks or not 
-00037340: 7365 6c66 2e74 6173 6b73 5b6b 5d2e 7768  self.tasks[k].wh
-00037350: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-00037360: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-00037370: 6966 206d 6973 7369 6e67 5f64 6174 613a  if missing_data:
-00037380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037390: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
-000373a0: 223a 2022 7061 7274 6961 6c2d 6661 696c  ": "partial-fail
-000373b0: 222c 2022 6b65 7973 223a 206d 6973 7369  ", "keys": missi
-000373c0: 6e67 5f64 6174 617d 0a0a 2020 2020 2020  ng_data}..      
-000373d0: 2020 6d73 6773 203d 2073 656c 662e 5f72    msgs = self._r
-000373e0: 6562 616c 616e 6365 5f66 696e 645f 6d73  ebalance_find_ms
-000373f0: 6773 286b 6579 732c 2077 7373 290a 2020  gs(keys, wss).  
-00037400: 2020 2020 2020 6966 206e 6f74 206d 7367        if not msg
-00037410: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00037420: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
-00037430: 2022 4f4b 227d 0a0a 2020 2020 2020 2020   "OK"}..        
-00037440: 6173 796e 6320 7769 7468 2073 656c 662e  async with self.
-00037450: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
-00037460: 2020 2072 6573 756c 7420 3d20 6177 6169     result = awai
-00037470: 7420 7365 6c66 2e5f 7265 6261 6c61 6e63  t self._rebalanc
-00037480: 655f 6d6f 7665 5f64 6174 6128 6d73 6773  e_move_data(msgs
-00037490: 2c20 7374 696d 756c 7573 5f69 6429 0a20  , stimulus_id). 
-000374a0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-000374b0: 7375 6c74 5b22 7374 6174 7573 225d 203d  sult["status"] =
-000374c0: 3d20 2270 6172 7469 616c 2d66 6169 6c22  = "partial-fail"
-000374d0: 2061 6e64 206b 6579 7320 6973 204e 6f6e   and keys is Non
-000374e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000374f0: 2020 2023 204f 6e6c 7920 7265 7475 726e     # Only return
-00037500: 2066 6169 6c65 6420 6b65 7973 2069 6620   failed keys if 
-00037510: 7468 6520 636c 6965 6e74 2065 7870 6c69  the client expli
-00037520: 6369 746c 7920 6173 6b65 6420 666f 7220  citly asked for 
-00037530: 7468 656d 0a20 2020 2020 2020 2020 2020  them.           
-00037540: 2020 2020 2072 6573 756c 7420 3d20 7b22       result = {"
-00037550: 7374 6174 7573 223a 2022 4f4b 227d 0a20  status": "OK"}. 
-00037560: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00037570: 6e20 7265 7375 6c74 0a0a 2020 2020 6465  n result..    de
-00037580: 6620 5f72 6562 616c 616e 6365 5f66 696e  f _rebalance_fin
-00037590: 645f 6d73 6773 280a 2020 2020 2020 2020  d_msgs(.        
-000375a0: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-000375b0: 7973 3a20 5365 745b 4861 7368 6162 6c65  ys: Set[Hashable
-000375c0: 5d20 7c20 4e6f 6e65 2c0a 2020 2020 2020  ] | None,.      
-000375d0: 2020 776f 726b 6572 733a 2049 7465 7261    workers: Itera
-000375e0: 626c 655b 576f 726b 6572 5374 6174 655d  ble[WorkerState]
-000375f0: 2c0a 2020 2020 2920 2d3e 206c 6973 745b  ,.    ) -> list[
-00037600: 7475 706c 655b 576f 726b 6572 5374 6174  tuple[WorkerStat
-00037610: 652c 2057 6f72 6b65 7253 7461 7465 2c20  e, WorkerState, 
-00037620: 5461 736b 5374 6174 655d 5d3a 0a20 2020  TaskState]]:.   
-00037630: 2020 2020 2022 2222 4964 656e 7469 6679       """Identify
-00037640: 2077 6f72 6b65 7273 2074 6861 7420 6e65   workers that ne
-00037650: 6564 2074 6f20 6c6f 7365 206b 6579 7320  ed to lose keys 
-00037660: 616e 6420 7468 6f73 6520 7468 6174 2063  and those that c
-00037670: 616e 2072 6563 6569 7665 2074 6865 6d2c  an receive them,
-00037680: 0a20 2020 2020 2020 2074 6f67 6574 6865  .        togethe
-00037690: 7220 7769 7468 2068 6f77 206d 616e 7920  r with how many 
-000376a0: 6279 7465 7320 6561 6368 206e 6565 6473  bytes each needs
-000376b0: 2074 6f20 6c6f 7365 2f72 6563 6569 7665   to lose/receive
-000376c0: 2e20 5468 656e 2c20 7061 6972 2061 2073  . Then, pair a s
-000376d0: 656e 6465 720a 2020 2020 2020 2020 776f  ender.        wo
-000376e0: 726b 6572 2077 6974 6820 6120 7265 6369  rker with a reci
-000376f0: 7069 656e 7420 776f 726b 6572 2066 6f72  pient worker for
-00037700: 2065 6163 6820 6b65 792c 2075 6e74 696c   each key, until
-00037710: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00037720: 7265 6261 6c61 6e63 6564 2e0a 0a20 2020  rebalanced...   
-00037730: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
-00037740: 206f 6e6c 7920 6465 6669 6e65 7320 7468   only defines th
-00037750: 6520 776f 726b 2074 6f20 6265 2070 6572  e work to be per
-00037760: 666f 726d 6564 3b20 6974 2064 6f65 7320  formed; it does 
-00037770: 6e6f 7420 7374 6172 7420 616e 7920 6e65  not start any ne
-00037780: 7477 6f72 6b0a 2020 2020 2020 2020 7472  twork.        tr
-00037790: 616e 7366 6572 7320 6974 7365 6c66 2e0a  ansfers itself..
-000377a0: 0a20 2020 2020 2020 2054 6865 2062 6967  .        The big
-000377b0: 2d4f 2063 6f6d 706c 6578 6974 7920 6973  -O complexity is
-000377c0: 204f 2877 7420 2b20 6b65 2a6c 6f67 2877   O(wt + ke*log(w
-000377d0: 6529 292c 2077 6865 7265 0a0a 2020 2020  e)), where..    
-000377e0: 2020 2020 2d20 7774 2069 7320 7468 6520      - wt is the 
-000377f0: 746f 7461 6c20 6e75 6d62 6572 206f 6620  total number of 
-00037800: 776f 726b 6572 7320 6f6e 2074 6865 2063  workers on the c
-00037810: 6c75 7374 6572 2028 6f72 2074 6865 206e  luster (or the n
-00037820: 756d 6265 7220 6f66 2061 6c6c 6f77 6564  umber of allowed
-00037830: 0a20 2020 2020 2020 2020 2077 6f72 6b65  .          worke
-00037840: 7273 2c20 6966 2065 7870 6c69 6369 746c  rs, if explicitl
-00037850: 7920 7374 6174 6564 2062 7920 7468 6520  y stated by the 
-00037860: 7573 6572 290a 2020 2020 2020 2020 2d20  user).        - 
-00037870: 7765 2069 7320 7468 6520 6e75 6d62 6572  we is the number
-00037880: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
-00037890: 2061 7265 2065 6c69 6769 626c 6520 746f   are eligible to
-000378a0: 2062 6520 7365 6e64 6572 7320 6f72 2072   be senders or r
-000378b0: 6563 6970 6965 6e74 730a 2020 2020 2020  ecipients.      
-000378c0: 2020 2d20 6b74 2069 7320 7468 6520 746f    - kt is the to
-000378d0: 7461 6c20 6e75 6d62 6572 206f 6620 6b65  tal number of ke
-000378e0: 7973 206f 6e20 7468 6520 636c 7573 7465  ys on the cluste
-000378f0: 7220 286f 7220 6f6e 2074 6865 2061 6c6c  r (or on the all
-00037900: 6f77 6564 2077 6f72 6b65 7273 290a 2020  owed workers).  
-00037910: 2020 2020 2020 2d20 6b65 2069 7320 7468        - ke is th
-00037920: 6520 6e75 6d62 6572 206f 6620 6b65 7973  e number of keys
-00037930: 2074 6861 7420 6e65 6564 2074 6f20 6265   that need to be
-00037940: 206d 6f76 6564 2069 6e20 6f72 6465 7220   moved in order 
-00037950: 746f 2061 6368 6965 7665 2061 2062 616c  to achieve a bal
-00037960: 616e 6365 640a 2020 2020 2020 2020 2020  anced.          
-00037970: 636c 7573 7465 720a 0a20 2020 2020 2020  cluster..       
-00037980: 2054 6865 7265 2069 7320 6120 6465 6765   There is a dege
-00037990: 6e65 7261 7465 2065 6467 6520 6361 7365  nerate edge case
-000379a0: 204f 2877 7420 2b20 6b74 2a6c 6f67 2877   O(wt + kt*log(w
-000379b0: 6529 2920 7768 656e 206b 7420 6973 206d  e)) when kt is m
-000379c0: 7563 6820 6772 6561 7465 7220 7468 616e  uch greater than
-000379d0: 0a20 2020 2020 2020 2074 6865 206e 756d  .        the num
-000379e0: 6265 7220 6f66 2061 6c6c 6f77 6564 206b  ber of allowed k
-000379f0: 6579 732c 206f 7220 7768 656e 206d 6f73  eys, or when mos
-00037a00: 7420 6b65 7973 2061 7265 2072 6570 6c69  t keys are repli
-00037a10: 6361 7465 6420 6f72 2063 616e 6e6f 7420  cated or cannot 
-00037a20: 6265 0a20 2020 2020 2020 206d 6f76 6564  be.        moved
-00037a30: 2066 6f72 2073 6f6d 6520 6f74 6865 7220   for some other 
-00037a40: 7265 6173 6f6e 2e0a 0a20 2020 2020 2020  reason...       
-00037a50: 2052 6574 7572 6e73 206c 6973 7420 6f66   Returns list of
-00037a60: 2074 7570 6c65 7320 746f 2066 6565 6420   tuples to feed 
-00037a70: 696e 746f 205f 7265 6261 6c61 6e63 655f  into _rebalance_
-00037a80: 6d6f 7665 5f64 6174 613a 0a0a 2020 2020  move_data:..    
-00037a90: 2020 2020 2d20 7365 6e64 6572 2077 6f72      - sender wor
-00037aa0: 6b65 720a 2020 2020 2020 2020 2d20 7265  ker.        - re
-00037ab0: 6369 7069 656e 7420 776f 726b 6572 0a20  cipient worker. 
-00037ac0: 2020 2020 2020 202d 2074 6173 6b20 746f         - task to
-00037ad0: 2062 6520 7472 616e 7366 6572 7265 640a   be transferred.
-00037ae0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00037af0: 2020 2020 2320 4865 6170 7320 6f66 2077      # Heaps of w
-00037b00: 6f72 6b65 7273 2c20 6d61 6e61 6765 6420  orkers, managed 
-00037b10: 6279 2074 6865 2068 6561 7071 206d 6f64  by the heapq mod
-00037b20: 756c 652c 2074 6861 7420 6e65 6564 2074  ule, that need t
-00037b30: 6f20 7365 6e64 2f72 6563 6569 7665 2064  o send/receive d
-00037b40: 6174 612c 0a20 2020 2020 2020 2023 2077  ata,.        # w
-00037b50: 6974 6820 686f 7720 6d61 6e79 2062 7974  ith how many byt
-00037b60: 6573 2065 6163 6820 6e65 6564 7320 746f  es each needs to
-00037b70: 2073 656e 642f 7265 6365 6976 652e 0a20   send/receive.. 
-00037b80: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00037b90: 2023 2045 6163 6820 656c 656d 656e 7420   # Each element 
-00037ba0: 6f66 2074 6865 2068 6561 7020 6973 2061  of the heap is a
-00037bb0: 2074 7570 6c65 2063 6f6e 7374 7275 6374   tuple construct
-00037bc0: 6564 2061 7320 666f 6c6c 6f77 733a 0a20  ed as follows:. 
-00037bd0: 2020 2020 2020 2023 202d 2073 6e64 5f62         # - snd_b
-00037be0: 7974 6573 5f6d 6178 2f72 6563 5f62 7974  ytes_max/rec_byt
-00037bf0: 6573 5f6d 6178 3a20 6d61 7869 6d75 6d20  es_max: maximum 
-00037c00: 6e75 6d62 6572 206f 6620 6279 7465 7320  number of bytes 
-00037c10: 746f 2073 656e 6420 6f72 2072 6563 6569  to send or recei
-00037c20: 7665 2e0a 2020 2020 2020 2020 2320 2020  ve..        #   
-00037c30: 5468 6973 206e 756d 6265 7220 6973 206e  This number is n
-00037c40: 6567 6174 6976 652c 2073 6f20 7468 6174  egative, so that
-00037c50: 2074 6865 2077 6f72 6b65 7273 2066 6172   the workers far
-00037c60: 7468 6573 7420 6672 6f6d 2074 6865 2063  thest from the c
-00037c70: 6c75 7374 6572 206d 6561 6e0a 2020 2020  luster mean.    
-00037c80: 2020 2020 2320 2020 6172 6520 6174 2074      #   are at t
-00037c90: 6865 2074 6f70 206f 6620 7468 6520 736d  he top of the sm
-00037ca0: 616c 6c65 7374 2d66 6972 7374 2068 6561  allest-first hea
-00037cb0: 7073 2e0a 2020 2020 2020 2020 2320 2d20  ps..        # - 
-00037cc0: 736e 645f 6279 7465 735f 6d69 6e2f 7265  snd_bytes_min/re
-00037cd0: 635f 6279 7465 735f 6d69 6e3a 206d 696e  c_bytes_min: min
-00037ce0: 696d 756d 206e 756d 6265 7220 6f66 2062  imum number of b
-00037cf0: 7974 6573 2061 6674 6572 2073 656e 6469  ytes after sendi
-00037d00: 6e67 2f72 6563 6569 7669 6e67 0a20 2020  ng/receiving.   
-00037d10: 2020 2020 2023 2020 2077 6869 6368 2074       #   which t
-00037d20: 6865 2077 6f72 6b65 7220 7368 6f75 6c64  he worker should
-00037d30: 206e 6f74 2062 6520 636f 6e73 6964 6572   not be consider
-00037d40: 6564 2061 6e79 6d6f 7265 2e20 5468 6973  ed anymore. This
-00037d50: 2069 7320 616c 736f 206e 6567 6174 6976   is also negativ
-00037d60: 652e 0a20 2020 2020 2020 2023 202d 2061  e..        # - a
-00037d70: 7262 6974 7261 7279 2075 6e69 7175 6520  rbitrary unique 
-00037d80: 6e75 6d62 6572 2c20 7468 6572 6520 6a75  number, there ju
-00037d90: 7374 2074 6f20 746f 206d 616b 6520 7375  st to to make su
-00037da0: 7265 2074 6861 7420 576f 726b 6572 5374  re that WorkerSt
-00037db0: 6174 6520 6f62 6a65 6374 730a 2020 2020  ate objects.    
-00037dc0: 2020 2020 2320 2020 6172 6520 6e65 7665      #   are neve
-00037dd0: 7220 7573 6564 2066 6f72 2073 6f72 7469  r used for sorti
-00037de0: 6e67 2069 6e20 7468 6520 756e 6c69 6b65  ng in the unlike
-00037df0: 6c79 2065 7665 6e74 2074 6861 7420 7477  ly event that tw
-00037e00: 6f20 7072 6f63 6573 7365 7320 6861 7665  o processes have
-00037e10: 0a20 2020 2020 2020 2023 2020 2065 7861  .        #   exa
-00037e20: 6374 6c79 2074 6865 2073 616d 6520 6e75  ctly the same nu
-00037e30: 6d62 6572 206f 6620 6279 7465 7320 616c  mber of bytes al
-00037e40: 6c6f 6361 7465 642e 0a20 2020 2020 2020  located..       
-00037e50: 2023 202d 2057 6f72 6b65 7253 7461 7465   # - WorkerState
-00037e60: 0a20 2020 2020 2020 2023 202d 2069 7465  .        # - ite
-00037e70: 7261 746f 7220 6f66 2061 6c6c 2074 6173  rator of all tas
-00037e80: 6b73 2069 6e20 6d65 6d6f 7279 206f 6e20  ks in memory on 
-00037e90: 7468 6520 776f 726b 6572 2028 7365 6e64  the worker (send
-00037ea0: 6572 7320 6f6e 6c79 292c 2069 6e73 6572  ers only), inser
-00037eb0: 7469 6f6e 0a20 2020 2020 2020 2023 2020  tion.        #  
-00037ec0: 2073 6f72 7465 6420 286c 6561 7374 2072   sorted (least r
-00037ed0: 6563 656e 746c 7920 696e 7365 7274 6564  ecently inserted
-00037ee0: 2066 6972 7374 292e 0a20 2020 2020 2020   first)..       
-00037ef0: 2023 2020 204e 6f74 6520 7468 6174 2074   #   Note that t
-00037f00: 6869 7320 6974 6572 6174 6f72 2077 696c  his iterator wil
-00037f10: 6c20 7479 7069 6361 6c6c 7920 2a6e 6f74  l typically *not
-00037f20: 2a20 6265 2065 7868 6175 7374 6564 2e20  * be exhausted. 
-00037f30: 4974 2077 696c 6c20 6f6e 6c79 2062 650a  It will only be.
-00037f40: 2020 2020 2020 2020 2320 2020 6578 6861          #   exha
-00037f50: 7573 7465 6420 6966 2c20 6166 7465 7220  usted if, after 
-00037f60: 6d6f 7669 6e67 2061 7761 7920 6672 6f6d  moving away from
-00037f70: 2074 6865 2077 6f72 6b65 7220 616c 6c20   the worker all 
-00037f80: 6b65 7973 2074 6861 7420 6361 6e20 6265  keys that can be
-00037f90: 206d 6f76 6564 2c0a 2020 2020 2020 2020   moved,.        
-00037fa0: 2320 2020 6973 2069 6e73 7566 6669 6369  #   is insuffici
-00037fb0: 656e 7420 746f 2064 726f 7020 736e 645f  ent to drop snd_
-00037fc0: 6279 7465 735f 6d69 6e20 6162 6f76 6520  bytes_min above 
-00037fd0: 302e 0a20 2020 2020 2020 2073 656e 6465  0..        sende
-00037fe0: 7273 3a20 6c69 7374 5b74 7570 6c65 5b69  rs: list[tuple[i
-00037ff0: 6e74 2c20 696e 742c 2069 6e74 2c20 576f  nt, int, int, Wo
-00038000: 726b 6572 5374 6174 652c 2049 7465 7261  rkerState, Itera
-00038010: 746f 725b 5461 736b 5374 6174 655d 5d5d  tor[TaskState]]]
-00038020: 203d 205b 5d0a 2020 2020 2020 2020 7265   = [].        re
-00038030: 6369 7069 656e 7473 3a20 6c69 7374 5b74  cipients: list[t
-00038040: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
-00038050: 6e74 2c20 576f 726b 6572 5374 6174 655d  nt, WorkerState]
-00038060: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
-00038070: 2320 4f75 7470 7574 3a20 5b28 7365 6e64  # Output: [(send
-00038080: 6572 2c20 7265 6369 7069 656e 742c 2074  er, recipient, t
-00038090: 6173 6b29 2c20 2e2e 2e5d 0a20 2020 2020  ask), ...].     
-000380a0: 2020 206d 7367 733a 206c 6973 745b 7475     msgs: list[tu
-000380b0: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
-000380c0: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
-000380d0: 736b 5374 6174 655d 5d20 3d20 5b5d 0a0a  skState]] = []..
-000380e0: 2020 2020 2020 2020 2320 4279 2064 6566          # By def
-000380f0: 6175 6c74 2c20 7468 6973 2069 7320 7468  ault, this is th
-00038100: 6520 6f70 7469 6d69 7374 6963 206d 656d  e optimistic mem
-00038110: 6f72 792c 206d 6561 6e69 6e67 2074 6f74  ory, meaning tot
-00038120: 616c 2070 726f 6365 7373 206d 656d 6f72  al process memor
-00038130: 7920 6d69 6e75 730a 2020 2020 2020 2020  y minus.        
-00038140: 2320 756e 6d61 6e61 6765 6420 6d65 6d6f  # unmanaged memo
-00038150: 7279 2074 6861 7420 6170 7065 6172 6564  ry that appeared
-00038160: 206f 7665 7220 7468 6520 6c61 7374 2033   over the last 3
-00038170: 3020 7365 636f 6e64 730a 2020 2020 2020  0 seconds.      
-00038180: 2020 2320 2864 6973 7472 6962 7574 6564    # (distributed
-00038190: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-000381a0: 6563 656e 742d 746f 2d6f 6c64 2d74 696d  ecent-to-old-tim
-000381b0: 6529 2e0a 2020 2020 2020 2020 2320 5468  e)..        # Th
-000381c0: 6973 206c 6574 7320 7573 2069 676e 6f72  is lets us ignor
-000381d0: 6520 7465 6d70 6f72 6172 7920 7370 696b  e temporary spik
-000381e0: 6573 2063 6175 7365 6420 6279 2074 6173  es caused by tas
-000381f0: 6b20 6865 6170 2075 7361 6765 2e0a 2020  k heap usage..  
-00038200: 2020 2020 2020 6d65 6d6f 7279 5f62 795f        memory_by_
-00038210: 776f 726b 6572 203d 205b 0a20 2020 2020  worker = [.     
-00038220: 2020 2020 2020 2028 7773 2c20 6765 7461         (ws, geta
-00038230: 7474 7228 7773 2e6d 656d 6f72 792c 2073  ttr(ws.memory, s
-00038240: 656c 662e 4d45 4d4f 5259 5f52 4542 414c  elf.MEMORY_REBAL
-00038250: 414e 4345 5f4d 4541 5355 5245 2929 2066  ANCE_MEASURE)) f
-00038260: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
-00038270: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-00038280: 2020 206d 6561 6e5f 6d65 6d6f 7279 203d     mean_memory =
-00038290: 2073 756d 286d 2066 6f72 205f 2c20 6d20   sum(m for _, m 
-000382a0: 696e 206d 656d 6f72 795f 6279 5f77 6f72  in memory_by_wor
-000382b0: 6b65 7229 202f 2f20 6c65 6e28 6d65 6d6f  ker) // len(memo
-000382c0: 7279 5f62 795f 776f 726b 6572 290a 0a20  ry_by_worker).. 
-000382d0: 2020 2020 2020 2066 6f72 2077 732c 2077         for ws, w
-000382e0: 735f 6d65 6d6f 7279 2069 6e20 6d65 6d6f  s_memory in memo
-000382f0: 7279 5f62 795f 776f 726b 6572 3a0a 2020  ry_by_worker:.  
-00038300: 2020 2020 2020 2020 2020 6966 2077 732e            if ws.
-00038310: 6d65 6d6f 7279 5f6c 696d 6974 3a0a 2020  memory_limit:.  
-00038320: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00038330: 6c66 5f67 6170 203d 2069 6e74 2873 656c  lf_gap = int(sel
-00038340: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
-00038350: 4345 5f48 414c 465f 4741 5020 2a20 7773  CE_HALF_GAP * ws
-00038360: 2e6d 656d 6f72 795f 6c69 6d69 7429 0a20  .memory_limit). 
-00038370: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00038380: 656e 6465 725f 6d69 6e20 3d20 7365 6c66  ender_min = self
-00038390: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
-000383a0: 455f 5345 4e44 4552 5f4d 494e 202a 2077  E_SENDER_MIN * w
-000383b0: 732e 6d65 6d6f 7279 5f6c 696d 6974 0a20  s.memory_limit. 
-000383c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000383d0: 6563 6970 6965 6e74 5f6d 6178 203d 2073  ecipient_max = s
-000383e0: 656c 662e 4d45 4d4f 5259 5f52 4542 414c  elf.MEMORY_REBAL
-000383f0: 414e 4345 5f52 4543 4950 4945 4e54 5f4d  ANCE_RECIPIENT_M
-00038400: 4158 202a 2077 732e 6d65 6d6f 7279 5f6c  AX * ws.memory_l
-00038410: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
-00038420: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00038430: 2020 2020 2020 2068 616c 665f 6761 7020         half_gap 
-00038440: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-00038450: 2020 2020 7365 6e64 6572 5f6d 696e 203d      sender_min =
-00038460: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
-00038470: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
-00038480: 6178 203d 206d 6174 682e 696e 660a 0a20  ax = math.inf.. 
-00038490: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
-000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384b0: 7773 2e5f 6861 735f 7768 6174 0a20 2020  ws._has_what.   
-000384c0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
-000384d0: 2077 735f 6d65 6d6f 7279 203e 3d20 6d65   ws_memory >= me
-000384e0: 616e 5f6d 656d 6f72 7920 2b20 6861 6c66  an_memory + half
-000384f0: 5f67 6170 0a20 2020 2020 2020 2020 2020  _gap.           
-00038500: 2020 2020 2061 6e64 2077 735f 6d65 6d6f       and ws_memo
-00038510: 7279 203e 3d20 7365 6e64 6572 5f6d 696e  ry >= sender_min
-00038520: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-00038530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038540: 2320 5468 6973 206d 6179 2073 656e 6420  # This may send 
-00038550: 7468 6520 776f 726b 6572 2062 656c 6f77  the worker below
-00038560: 2073 656e 6465 725f 6d69 6e20 2862 7920   sender_min (by 
-00038570: 6465 7369 676e 290a 2020 2020 2020 2020  design).        
-00038580: 2020 2020 2020 2020 736e 645f 6279 7465          snd_byte
-00038590: 735f 6d61 7820 3d20 6d65 616e 5f6d 656d  s_max = mean_mem
-000385a0: 6f72 7920 2d20 7773 5f6d 656d 6f72 7920  ory - ws_memory 
-000385b0: 2023 206e 6567 6174 6976 650a 2020 2020   # negative.    
-000385c0: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
-000385d0: 6279 7465 735f 6d69 6e20 3d20 736e 645f  bytes_min = snd_
-000385e0: 6279 7465 735f 6d61 7820 2b20 6861 6c66  bytes_max + half
-000385f0: 5f67 6170 2020 2320 6e65 6761 7469 7665  _gap  # negative
-00038600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038610: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
-00038620: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
-00038630: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
-00038640: 2020 2073 656e 6465 7273 2e61 7070 656e     senders.appen
-00038650: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00038660: 2020 2020 2020 2028 736e 645f 6279 7465         (snd_byte
-00038670: 735f 6d61 782c 2073 6e64 5f62 7974 6573  s_max, snd_bytes
-00038680: 5f6d 696e 2c20 6964 2877 7329 2c20 7773  _min, id(ws), ws
-00038690: 2c20 6974 6572 2877 732e 5f68 6173 5f77  , iter(ws._has_w
-000386a0: 6861 7429 290a 2020 2020 2020 2020 2020  hat)).          
-000386b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000386c0: 2020 2020 656c 6966 2077 735f 6d65 6d6f      elif ws_memo
-000386d0: 7279 203c 206d 6561 6e5f 6d65 6d6f 7279  ry < mean_memory
-000386e0: 202d 2068 616c 665f 6761 7020 616e 6420   - half_gap and 
-000386f0: 7773 5f6d 656d 6f72 7920 3c20 7265 6369  ws_memory < reci
-00038700: 7069 656e 745f 6d61 783a 0a20 2020 2020  pient_max:.     
-00038710: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00038720: 7320 6d61 7920 7365 6e64 2074 6865 2077  s may send the w
-00038730: 6f72 6b65 7220 6162 6f76 6520 7265 6369  orker above reci
-00038740: 7069 656e 745f 6d61 7820 2862 7920 6465  pient_max (by de
-00038750: 7369 676e 290a 2020 2020 2020 2020 2020  sign).          
-00038760: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
-00038770: 6d61 7820 3d20 7773 5f6d 656d 6f72 7920  max = ws_memory 
-00038780: 2d20 6d65 616e 5f6d 656d 6f72 7920 2023  - mean_memory  #
-00038790: 206e 6567 6174 6976 650a 2020 2020 2020   negative.      
-000387a0: 2020 2020 2020 2020 2020 7265 635f 6279            rec_by
-000387b0: 7465 735f 6d69 6e20 3d20 7265 635f 6279  tes_min = rec_by
-000387c0: 7465 735f 6d61 7820 2b20 6861 6c66 5f67  tes_max + half_g
-000387d0: 6170 2020 2320 6e65 6761 7469 7665 0a20  ap  # negative. 
-000387e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000387f0: 2053 6565 2064 6566 696e 6974 696f 6e20   See definition 
-00038800: 6f66 2072 6563 6970 6965 6e74 7320 6162  of recipients ab
-00038810: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
-00038820: 2020 2020 7265 6369 7069 656e 7473 2e61      recipients.a
-00038830: 7070 656e 6428 2872 6563 5f62 7974 6573  ppend((rec_bytes
-00038840: 5f6d 6178 2c20 7265 635f 6279 7465 735f  _max, rec_bytes_
-00038850: 6d69 6e2c 2069 6428 7773 292c 2077 7329  min, id(ws), ws)
-00038860: 290a 0a20 2020 2020 2020 2023 2046 6173  )..        # Fas
-00038870: 7420 6578 6974 2069 6e20 6361 7365 206e  t exit in case n
-00038880: 6f20 7472 616e 7366 6572 7320 6172 6520  o transfers are 
-00038890: 6e65 6365 7373 6172 7920 6f72 2070 6f73  necessary or pos
-000388a0: 7369 626c 650a 2020 2020 2020 2020 6966  sible.        if
-000388b0: 206e 6f74 2073 656e 6465 7273 206f 7220   not senders or 
-000388c0: 6e6f 7420 7265 6369 7069 656e 7473 3a0a  not recipients:.
-000388d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000388e0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
-000388f0: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
-00038900: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00038910: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00038920: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
-00038930: 223a 2022 7265 6261 6c61 6e63 6522 2c0a  ": "rebalance",.
-00038940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038950: 2020 2020 2273 656e 6465 7273 223a 206c      "senders": l
-00038960: 656e 2873 656e 6465 7273 292c 0a20 2020  en(senders),.   
-00038970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038980: 2022 7265 6369 7069 656e 7473 223a 206c   "recipients": l
-00038990: 656e 2872 6563 6970 6965 6e74 7329 2c0a  en(recipients),.
-000389a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000389b0: 2020 2020 226d 6f76 6564 5f6b 6579 7322      "moved_keys"
-000389c0: 3a20 302c 0a20 2020 2020 2020 2020 2020  : 0,.           
-000389d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000389e0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000389f0: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
-00038a00: 2020 2020 2068 6561 7071 2e68 6561 7069       heapq.heapi
-00038a10: 6679 2873 656e 6465 7273 290a 2020 2020  fy(senders).    
-00038a20: 2020 2020 6865 6170 712e 6865 6170 6966      heapq.heapif
-00038a30: 7928 7265 6369 7069 656e 7473 290a 0a20  y(recipients).. 
-00038a40: 2020 2020 2020 2077 6869 6c65 2073 656e         while sen
-00038a50: 6465 7273 2061 6e64 2072 6563 6970 6965  ders and recipie
-00038a60: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00038a70: 2073 6e64 5f62 7974 6573 5f6d 6178 2c20   snd_bytes_max, 
-00038a80: 736e 645f 6279 7465 735f 6d69 6e2c 205f  snd_bytes_min, _
-00038a90: 2c20 736e 645f 7773 2c20 7473 5f69 7465  , snd_ws, ts_ite
-00038aa0: 7220 3d20 7365 6e64 6572 735b 305d 0a0a  r = senders[0]..
-00038ab0: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-00038ac0: 6572 6174 6520 7468 726f 7567 6820 7461  erate through ta
-00038ad0: 736b 7320 696e 206d 656d 6f72 792c 206c  sks in memory, l
-00038ae0: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
-00038af0: 7365 7274 6564 2066 6972 7374 0a20 2020  serted first.   
-00038b00: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
-00038b10: 696e 2074 735f 6974 6572 3a0a 2020 2020  in ts_iter:.    
-00038b20: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00038b30: 6579 7320 6973 206e 6f74 204e 6f6e 6520  eys is not None 
-00038b40: 616e 6420 7473 2e6b 6579 206e 6f74 2069  and ts.key not i
-00038b50: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-00038b60: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00038b70: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00038b80: 2020 2020 206e 6279 7465 7320 3d20 7473       nbytes = ts
-00038b90: 2e6e 6279 7465 730a 2020 2020 2020 2020  .nbytes.        
-00038ba0: 2020 2020 2020 2020 6966 206e 6279 7465          if nbyte
-00038bb0: 7320 2b20 736e 645f 6279 7465 735f 6d61  s + snd_bytes_ma
-00038bc0: 7820 3e20 303a 0a20 2020 2020 2020 2020  x > 0:.         
-00038bd0: 2020 2020 2020 2020 2020 2023 204d 6f76             # Mov
-00038be0: 696e 6720 7468 6973 2074 6173 6b20 776f  ing this task wo
-00038bf0: 756c 6420 6361 7573 6520 7468 6520 7365  uld cause the se
-00038c00: 6e64 6572 2074 6f20 676f 2062 656c 6f77  nder to go below
-00038c10: 206d 6561 6e20 616e 640a 2020 2020 2020   mean and.      
-00038c20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00038c30: 706f 7465 6e74 6961 6c6c 7920 7269 736b  potentially risk
-00038c40: 2062 6563 6f6d 696e 6720 6120 7265 6369   becoming a reci
-00038c50: 7069 656e 742c 2077 6869 6368 2077 6f75  pient, which wou
-00038c60: 6c64 2063 6175 7365 2074 6173 6b73 2074  ld cause tasks t
-00038c70: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-00038c80: 2020 2020 2020 2320 626f 756e 6365 2061        # bounce a
-00038c90: 726f 756e 642e 204d 6f76 6520 6f6e 2074  round. Move on t
-00038ca0: 6f20 7468 6520 6e65 7874 2074 6173 6b20  o the next task 
-00038cb0: 6f66 2074 6865 2073 616d 6520 7365 6e64  of the same send
-00038cc0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-00038cd0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00038ce0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00038cf0: 2020 2320 4669 6e64 2074 6865 2072 6563    # Find the rec
-00038d00: 6970 6965 6e74 2c20 6661 7274 6865 7374  ipient, farthest
-00038d10: 2066 726f 6d20 7468 6520 6d65 616e 2c20   from the mean, 
-00038d20: 7768 6963 680a 2020 2020 2020 2020 2020  which.          
-00038d30: 2020 2020 2020 2320 312e 2068 6173 2065        # 1. has e
-00038d40: 6e6f 7567 6820 6176 6169 6c61 626c 6520  nough available 
-00038d50: 5241 4d20 666f 7220 7468 6973 2074 6173  RAM for this tas
-00038d60: 6b2c 2061 6e64 0a20 2020 2020 2020 2020  k, and.         
-00038d70: 2020 2020 2020 2023 2032 2e20 646f 6573         # 2. does
-00038d80: 6e27 7420 686f 6c64 2061 2063 6f70 7920  n't hold a copy 
-00038d90: 6f66 2074 6869 7320 7461 736b 2061 6c72  of this task alr
-00038da0: 6561 6479 0a20 2020 2020 2020 2020 2020  eady.           
-00038db0: 2020 2020 2023 2054 6865 7265 206d 6179       # There may
-00038dc0: 206e 6f74 2062 6520 616e 7920 7468 6174   not be any that
-00038dd0: 2073 6174 6973 6669 6573 2074 6865 7365   satisfies these
-00038de0: 2063 6f6e 6469 7469 6f6e 733b 2069 6e20   conditions; in 
-00038df0: 7468 6973 2063 6173 650a 2020 2020 2020  this case.      
-00038e00: 2020 2020 2020 2020 2020 2320 7468 6973            # this
-00038e10: 2074 6173 6b20 776f 6e27 7420 6265 206d   task won't be m
-00038e20: 6f76 6564 2e0a 2020 2020 2020 2020 2020  oved..          
-00038e30: 2020 2020 2020 736b 6970 7065 645f 7265        skipped_re
-00038e40: 6369 7069 656e 7473 203d 205b 5d0a 2020  cipients = [].  
-00038e50: 2020 2020 2020 2020 2020 2020 2020 7573                us
-00038e60: 655f 7265 6369 7069 656e 7420 3d20 4661  e_recipient = Fa
-00038e70: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00038e80: 2020 2020 7768 696c 6520 7265 6369 7069      while recipi
-00038e90: 656e 7473 2061 6e64 206e 6f74 2075 7365  ents and not use
-00038ea0: 5f72 6563 6970 6965 6e74 3a0a 2020 2020  _recipient:.    
-00038eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ec0: 7265 635f 6279 7465 735f 6d61 782c 2072  rec_bytes_max, r
-00038ed0: 6563 5f62 7974 6573 5f6d 696e 2c20 5f2c  ec_bytes_min, _,
-00038ee0: 2072 6563 5f77 7320 3d20 7265 6369 7069   rec_ws = recipi
-00038ef0: 656e 7473 5b30 5d0a 2020 2020 2020 2020  ents[0].        
-00038f00: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00038f10: 6279 7465 7320 2b20 7265 635f 6279 7465  bytes + rec_byte
-00038f20: 735f 6d61 7820 3e20 303a 0a20 2020 2020  s_max > 0:.     
-00038f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f40: 2020 2023 2072 6563 6970 6965 6e74 7320     # recipients 
-00038f50: 6172 6520 736f 7274 6564 2062 7920 7265  are sorted by re
-00038f60: 635f 6279 7465 735f 6d61 782e 0a20 2020  c_bytes_max..   
-00038f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f80: 2020 2020 2023 2054 6865 206e 6578 7420       # The next 
-00038f90: 6f6e 6573 2077 696c 6c20 6265 2077 6f72  ones will be wor
-00038fa0: 7365 3b20 6e6f 2072 6561 736f 6e20 746f  se; no reason to
-00038fb0: 2063 6f6e 7469 6e75 6520 6974 6572 6174   continue iterat
-00038fc0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00038fd0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00038fe0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-00038ff0: 2020 2020 2020 7573 655f 7265 6369 7069        use_recipi
-00039000: 656e 7420 3d20 7473 206e 6f74 2069 6e20  ent = ts not in 
-00039010: 7265 635f 7773 2e5f 6861 735f 7768 6174  rec_ws._has_what
-00039020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039030: 2020 2020 2069 6620 6e6f 7420 7573 655f       if not use_
-00039040: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
-00039050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039060: 2020 2073 6b69 7070 6564 5f72 6563 6970     skipped_recip
-00039070: 6965 6e74 732e 6170 7065 6e64 2868 6561  ients.append(hea
-00039080: 7071 2e68 6561 7070 6f70 2872 6563 6970  pq.heappop(recip
-00039090: 6965 6e74 7329 290a 0a20 2020 2020 2020  ients))..       
-000390a0: 2020 2020 2020 2020 2066 6f72 2072 6563           for rec
-000390b0: 6970 6965 6e74 2069 6e20 736b 6970 7065  ipient in skippe
-000390c0: 645f 7265 6369 7069 656e 7473 3a0a 2020  d_recipients:.  
-000390d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000390e0: 2020 6865 6170 712e 6865 6170 7075 7368    heapq.heappush
-000390f0: 2872 6563 6970 6965 6e74 732c 2072 6563  (recipients, rec
-00039100: 6970 6965 6e74 290a 0a20 2020 2020 2020  ipient)..       
-00039110: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00039120: 7573 655f 7265 6369 7069 656e 743a 0a20  use_recipient:. 
-00039130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039140: 2020 2023 2054 6869 7320 7461 736b 2068     # This task h
-00039150: 6173 206e 6f20 7265 6369 7069 656e 7473  as no recipients
-00039160: 2061 7661 696c 6162 6c65 2e20 4c65 6176   available. Leav
-00039170: 6520 6974 206f 6e20 7468 6520 7365 6e64  e it on the send
-00039180: 6572 2061 6e64 0a20 2020 2020 2020 2020  er and.         
-00039190: 2020 2020 2020 2020 2020 2023 206d 6f76             # mov
-000391a0: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
-000391b0: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
-000391c0: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
-000391d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000391e0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-000391f0: 2020 2020 2020 2020 2320 5363 6865 6475          # Schedu
-00039200: 6c65 2074 6173 6b20 666f 7220 7472 616e  le task for tran
-00039210: 7366 6572 2066 726f 6d20 7365 6e64 6572  sfer from sender
-00039220: 2074 6f20 7265 6369 7069 656e 740a 2020   to recipient.  
-00039230: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00039240: 6773 2e61 7070 656e 6428 2873 6e64 5f77  gs.append((snd_w
-00039250: 732c 2072 6563 5f77 732c 2074 7329 290a  s, rec_ws, ts)).
-00039260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039270: 2023 202a 5f62 7974 6573 5f6d 6178 2f6d   # *_bytes_max/m
-00039280: 696e 2061 7265 2061 6c6c 206e 6567 6174  in are all negat
-00039290: 6976 6520 666f 7220 6865 6170 2073 6f72  ive for heap sor
-000392a0: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
-000392b0: 2020 2020 2073 6e64 5f62 7974 6573 5f6d       snd_bytes_m
-000392c0: 6178 202b 3d20 6e62 7974 6573 0a20 2020  ax += nbytes.   
-000392d0: 2020 2020 2020 2020 2020 2020 2073 6e64               snd
-000392e0: 5f62 7974 6573 5f6d 696e 202b 3d20 6e62  _bytes_min += nb
-000392f0: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
-00039300: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
-00039310: 6178 202b 3d20 6e62 7974 6573 0a20 2020  ax += nbytes.   
-00039320: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-00039330: 5f62 7974 6573 5f6d 696e 202b 3d20 6e62  _bytes_min += nb
-00039340: 7974 6573 0a0a 2020 2020 2020 2020 2020  ytes..          
-00039350: 2020 2020 2020 2320 5374 6f70 2069 7465        # Stop ite
-00039360: 7261 7469 6e67 206f 6e20 7468 6520 7461  rating on the ta
-00039370: 736b 7320 6f66 2074 6869 7320 7365 6e64  sks of this send
-00039380: 6572 2066 6f72 206e 6f77 2061 6e64 2c20  er for now and, 
-00039390: 6966 2069 7420 7374 696c 6c0a 2020 2020  if it still.    
-000393a0: 2020 2020 2020 2020 2020 2020 2320 6861              # ha
-000393b0: 7320 6279 7465 7320 746f 206c 6f73 652c  s bytes to lose,
-000393c0: 2070 7573 6820 6974 2062 6163 6b20 696e   push it back in
-000393d0: 746f 2074 6865 2073 656e 6465 7273 2068  to the senders h
-000393e0: 6561 703b 2069 7420 6d61 7920 6f72 206d  eap; it may or m
-000393f0: 6179 0a20 2020 2020 2020 2020 2020 2020  ay.             
-00039400: 2020 2023 206e 6f74 2063 6f6d 6520 6261     # not come ba
-00039410: 636b 206f 6e20 746f 7020 6167 6169 6e2e  ck on top again.
-00039420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039430: 2069 6620 736e 645f 6279 7465 735f 6d69   if snd_bytes_mi
-00039440: 6e20 3c20 303a 0a20 2020 2020 2020 2020  n < 0:.         
-00039450: 2020 2020 2020 2020 2020 2023 2053 6565             # See
-00039460: 2064 6566 696e 6974 696f 6e20 6f66 2073   definition of s
-00039470: 656e 6465 7273 2061 626f 7665 0a20 2020  enders above.   
-00039480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039490: 2068 6561 7071 2e68 6561 7072 6570 6c61   heapq.heaprepla
-000394a0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-000394b0: 2020 2020 2020 2020 2020 2020 7365 6e64              send
-000394c0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-000394d0: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
-000394e0: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
-000394f0: 5f62 7974 6573 5f6d 696e 2c20 6964 2873  _bytes_min, id(s
-00039500: 6e64 5f77 7329 2c20 736e 645f 7773 2c20  nd_ws), snd_ws, 
-00039510: 7473 5f69 7465 7229 2c0a 2020 2020 2020  ts_iter),.      
-00039520: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00039530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039540: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00039550: 2020 2020 2020 2020 2020 6865 6170 712e            heapq.
-00039560: 6865 6170 706f 7028 7365 6e64 6572 7329  heappop(senders)
-00039570: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00039580: 2020 2320 4966 2072 6563 6970 6965 6e74    # If recipient
-00039590: 2073 7469 6c6c 2068 6173 2062 7974 6573   still has bytes
-000395a0: 2074 6f20 6761 696e 2c20 7075 7368 2069   to gain, push i
-000395b0: 7420 6261 636b 2069 6e74 6f20 7468 6520  t back into the 
-000395c0: 7265 6369 7069 656e 7473 0a20 2020 2020  recipients.     
-000395d0: 2020 2020 2020 2020 2020 2023 2068 6561             # hea
-000395e0: 703b 2069 7420 6d61 7920 6f72 206d 6179  p; it may or may
-000395f0: 206e 6f74 2063 6f6d 6520 6261 636b 206f   not come back o
-00039600: 6e20 746f 7020 6167 6169 6e2e 0a20 2020  n top again..   
-00039610: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00039620: 7265 635f 6279 7465 735f 6d69 6e20 3c20  rec_bytes_min < 
-00039630: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00039640: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
-00039650: 696e 6974 696f 6e20 6f66 2072 6563 6970  inition of recip
-00039660: 6965 6e74 7320 6162 6f76 650a 2020 2020  ients above.    
-00039670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039680: 6865 6170 712e 6865 6170 7265 706c 6163  heapq.heapreplac
-00039690: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-000396a0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
-000396b0: 6965 6e74 732c 0a20 2020 2020 2020 2020  ients,.         
-000396c0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000396d0: 7265 635f 6279 7465 735f 6d61 782c 2072  rec_bytes_max, r
-000396e0: 6563 5f62 7974 6573 5f6d 696e 2c20 6964  ec_bytes_min, id
-000396f0: 2872 6563 5f77 7329 2c20 7265 635f 7773  (rec_ws), rec_ws
-00039700: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00039710: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00039720: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00039730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039740: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
-00039750: 2872 6563 6970 6965 6e74 7329 0a0a 2020  (recipients)..  
-00039760: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00039770: 4d6f 7665 2074 6f20 6e65 7874 2073 656e  Move to next sen
-00039780: 6465 7220 7769 7468 2074 6865 206d 6f73  der with the mos
-00039790: 7420 6461 7461 2074 6f20 6c6f 7365 2e0a  t data to lose..
-000397a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397b0: 2320 4974 206d 6179 206f 7220 6d61 7920  # It may or may 
-000397c0: 6e6f 7420 6265 2074 6865 2073 616d 6520  not be the same 
-000397d0: 7365 6e64 6572 2061 6761 696e 2e0a 2020  sender again..  
-000397e0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-000397f0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
-00039800: 2065 6c73 653a 2020 2320 666f 7220 7473   else:  # for ts
-00039810: 2069 6e20 7473 5f69 7465 720a 2020 2020   in ts_iter.    
-00039820: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
-00039830: 6861 7573 7465 6420 7461 736b 7320 6f6e  hausted tasks on
-00039840: 2074 6869 7320 7365 6e64 6572 0a20 2020   this sender.   
-00039850: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-00039860: 7071 2e68 6561 7070 6f70 2873 656e 6465  pq.heappop(sende
-00039870: 7273 290a 0a20 2020 2020 2020 2072 6574  rs)..        ret
-00039880: 7572 6e20 6d73 6773 0a0a 2020 2020 6173  urn msgs..    as
-00039890: 796e 6320 6465 6620 5f72 6562 616c 616e  ync def _rebalan
-000398a0: 6365 5f6d 6f76 655f 6461 7461 280a 2020  ce_move_data(.  
-000398b0: 2020 2020 2020 7365 6c66 2c20 6d73 6773        self, msgs
-000398c0: 3a20 226c 6973 745b 7475 706c 655b 576f  : "list[tuple[Wo
-000398d0: 726b 6572 5374 6174 652c 2057 6f72 6b65  rkerState, Worke
-000398e0: 7253 7461 7465 2c20 5461 736b 5374 6174  rState, TaskStat
-000398f0: 655d 5d22 2c20 7374 696d 756c 7573 5f69  e]]", stimulus_i
-00039900: 643a 2073 7472 0a20 2020 2029 202d 3e20  d: str.    ) -> 
-00039910: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
-00039920: 2250 6572 666f 726d 2074 6865 2061 6374  "Perform the act
-00039930: 7561 6c20 7472 616e 7366 6572 206f 6620  ual transfer of 
-00039940: 6461 7461 2061 6372 6f73 7320 7468 6520  data across the 
-00039950: 6e65 7477 6f72 6b20 696e 2072 6562 616c  network in rebal
-00039960: 616e 6365 2829 2e0a 2020 2020 2020 2020  ance()..        
-00039970: 5461 6b65 7320 696e 2069 6e70 7574 2074  Takes in input t
-00039980: 6865 206f 7574 7075 7420 6f66 205f 7265  he output of _re
-00039990: 6261 6c61 6e63 655f 6669 6e64 5f6d 7367  balance_find_msg
-000399a0: 7328 292c 2074 6861 7420 6973 2061 206c  s(), that is a l
-000399b0: 6973 7420 6f66 2074 7570 6c65 733a 0a0a  ist of tuples:..
-000399c0: 2020 2020 2020 2020 2d20 7365 6e64 6572          - sender
-000399d0: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
-000399e0: 2d20 7265 6369 7069 656e 7420 776f 726b  - recipient work
-000399f0: 6572 0a20 2020 2020 2020 202d 2074 6173  er.        - tas
-00039a00: 6b20 746f 2062 6520 7472 616e 7366 6572  k to be transfer
-00039a10: 7265 640a 0a20 2020 2020 2020 2046 4958  red..        FIX
-00039a20: 4d45 2074 6869 7320 6d65 7468 6f64 2069  ME this method i
-00039a30: 7320 6e6f 7420 726f 6275 7374 2077 6865  s not robust whe
-00039a40: 6e20 7468 6520 636c 7573 7465 7220 6973  n the cluster is
-00039a50: 206e 6f74 2069 646c 652e 0a20 2020 2020   not idle..     
-00039a60: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00039a70: 6f5f 7265 6369 7069 656e 7473 3a20 6465  o_recipients: de
-00039a80: 6661 756c 7464 6963 745b 7374 722c 2064  faultdict[str, d
-00039a90: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
-00039aa0: 6c69 7374 5b73 7472 5d5d 5d20 3d20 6465  list[str]]] = de
-00039ab0: 6661 756c 7464 6963 7428 0a20 2020 2020  faultdict(.     
-00039ac0: 2020 2020 2020 206c 616d 6264 613a 2064         lambda: d
-00039ad0: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
-00039ae0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00039af0: 2020 2066 6f72 2073 6e64 5f77 732c 2072     for snd_ws, r
-00039b00: 6563 5f77 732c 2074 7320 696e 206d 7367  ec_ws, ts in msg
-00039b10: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00039b20: 6f5f 7265 6369 7069 656e 7473 5b72 6563  o_recipients[rec
-00039b30: 5f77 732e 6164 6472 6573 735d 5b74 732e  _ws.address][ts.
-00039b40: 6b65 795d 2e61 7070 656e 6428 736e 645f  key].append(snd_
-00039b50: 7773 2e61 6464 7265 7373 290a 2020 2020  ws.address).    
-00039b60: 2020 2020 6661 696c 6564 5f6b 6579 735f      failed_keys_
-00039b70: 6279 5f72 6563 6970 6965 6e74 203d 2064  by_recipient = d
-00039b80: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-00039b90: 207a 6970 280a 2020 2020 2020 2020 2020   zip(.          
-00039ba0: 2020 2020 2020 746f 5f72 6563 6970 6965        to_recipie
-00039bb0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
-00039bc0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00039bd0: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00039be0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00039bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00039c00: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-00039c10: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
-00039c20: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
-00039c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c40: 2020 2020 2020 2073 656c 662e 6761 7468         self.gath
-00039c50: 6572 5f6f 6e5f 776f 726b 6572 2877 2c20  er_on_worker(w, 
-00039c60: 7768 6f5f 6861 7329 0a20 2020 2020 2020  who_has).       
-00039c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c80: 2066 6f72 2077 2c20 7768 6f5f 6861 7320   for w, who_has 
-00039c90: 696e 2074 6f5f 7265 6369 7069 656e 7473  in to_recipients
-00039ca0: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-00039cb0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00039cc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00039cd0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00039ce0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00039cf0: 2020 2074 6f5f 7365 6e64 6572 7320 3d20     to_senders = 
-00039d00: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
-00039d10: 290a 2020 2020 2020 2020 666f 7220 736e  ).        for sn
-00039d20: 645f 7773 2c20 7265 635f 7773 2c20 7473  d_ws, rec_ws, ts
-00039d30: 2069 6e20 6d73 6773 3a0a 2020 2020 2020   in msgs:.      
-00039d40: 2020 2020 2020 6966 2074 732e 6b65 7920        if ts.key 
-00039d50: 6e6f 7420 696e 2066 6169 6c65 645f 6b65  not in failed_ke
-00039d60: 7973 5f62 795f 7265 6369 7069 656e 745b  ys_by_recipient[
-00039d70: 7265 635f 7773 2e61 6464 7265 7373 5d3a  rec_ws.address]:
-00039d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039d90: 2074 6f5f 7365 6e64 6572 735b 736e 645f   to_senders[snd_
-00039da0: 7773 2e61 6464 7265 7373 5d2e 6170 7065  ws.address].appe
-00039db0: 6e64 2874 732e 6b65 7929 0a0a 2020 2020  nd(ts.key)..    
-00039dc0: 2020 2020 2320 4e6f 7465 3a20 7468 6973      # Note: this
-00039dd0: 206e 6576 6572 2072 6169 7365 7320 6578   never raises ex
-00039de0: 6365 7074 696f 6e73 0a20 2020 2020 2020  ceptions.       
-00039df0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00039e00: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-00039e10: 2020 202a 2873 656c 662e 6465 6c65 7465     *(self.delete
-00039e20: 5f77 6f72 6b65 725f 6461 7461 2872 2c20  _worker_data(r, 
-00039e30: 762c 2073 7469 6d75 6c75 735f 6964 2920  v, stimulus_id) 
-00039e40: 666f 7220 722c 2076 2069 6e20 746f 5f73  for r, v in to_s
-00039e50: 656e 6465 7273 2e69 7465 6d73 2829 290a  enders.items()).
-00039e60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00039e70: 2020 2066 6f72 2072 2c20 7620 696e 2074     for r, v in t
-00039e80: 6f5f 7265 6369 7069 656e 7473 2e69 7465  o_recipients.ite
-00039e90: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00039ea0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00039eb0: 2872 2c20 7b22 6163 7469 6f6e 223a 2022  (r, {"action": "
-00039ec0: 7265 6261 6c61 6e63 6522 2c20 2277 686f  rebalance", "who
-00039ed0: 5f68 6173 223a 2076 7d29 0a20 2020 2020  _has": v}).     
-00039ee0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-00039ef0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
-00039f00: 616c 6c22 2c0a 2020 2020 2020 2020 2020  all",.          
-00039f10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00039f20: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
-00039f30: 6562 616c 616e 6365 222c 0a20 2020 2020  ebalance",.     
-00039f40: 2020 2020 2020 2020 2020 2022 7365 6e64             "send
-00039f50: 6572 7322 3a20 7661 6c6d 6170 286c 656e  ers": valmap(len
-00039f60: 2c20 746f 5f73 656e 6465 7273 292c 0a20  , to_senders),. 
-00039f70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039f80: 7265 6369 7069 656e 7473 223a 2076 616c  recipients": val
-00039f90: 6d61 7028 6c65 6e2c 2074 6f5f 7265 6369  map(len, to_reci
-00039fa0: 7069 656e 7473 292c 0a20 2020 2020 2020  pients),.       
-00039fb0: 2020 2020 2020 2020 2022 6d6f 7665 645f           "moved_
-00039fc0: 6b65 7973 223a 206c 656e 286d 7367 7329  keys": len(msgs)
-00039fd0: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00039fe0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00039ff0: 2020 2020 6d69 7373 696e 675f 6b65 7973      missing_keys
-0003a000: 203d 207b 6b20 666f 7220 7220 696e 2066   = {k for r in f
-0003a010: 6169 6c65 645f 6b65 7973 5f62 795f 7265  ailed_keys_by_re
-0003a020: 6369 7069 656e 742e 7661 6c75 6573 2829  cipient.values()
-0003a030: 2066 6f72 206b 2069 6e20 727d 0a20 2020   for k in r}.   
-0003a040: 2020 2020 2069 6620 6d69 7373 696e 675f       if missing_
-0003a050: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0003a060: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
-0003a070: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
-0003a080: 6c22 2c20 226b 6579 7322 3a20 6c69 7374  l", "keys": list
-0003a090: 286d 6973 7369 6e67 5f6b 6579 7329 7d0a  (missing_keys)}.
-0003a0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003a0b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003a0c0: 207b 2273 7461 7475 7322 3a20 224f 4b22   {"status": "OK"
-0003a0d0: 7d0a 0a20 2020 2061 7379 6e63 2064 6566  }..    async def
-0003a0e0: 2072 6570 6c69 6361 7465 280a 2020 2020   replicate(.    
-0003a0f0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0003a100: 2020 636f 6d6d 3d4e 6f6e 652c 0a20 2020    comm=None,.   
-0003a110: 2020 2020 206b 6579 733d 4e6f 6e65 2c0a       keys=None,.
-0003a120: 2020 2020 2020 2020 6e3d 4e6f 6e65 2c0a          n=None,.
-0003a130: 2020 2020 2020 2020 776f 726b 6572 733d          workers=
-0003a140: 4e6f 6e65 2c0a 2020 2020 2020 2020 6272  None,.        br
-0003a150: 616e 6368 696e 675f 6661 6374 6f72 3d32  anching_factor=2
-0003a160: 2c0a 2020 2020 2020 2020 6465 6c65 7465  ,.        delete
-0003a170: 3d54 7275 652c 0a20 2020 2020 2020 206c  =True,.        l
-0003a180: 6f63 6b3d 5472 7565 2c0a 2020 2020 2020  ock=True,.      
-0003a190: 2020 7374 696d 756c 7573 5f69 643d 4e6f    stimulus_id=No
-0003a1a0: 6e65 2c0a 2020 2020 293a 0a20 2020 2020  ne,.    ):.     
-0003a1b0: 2020 2022 2222 5265 706c 6963 6174 6520     """Replicate 
-0003a1c0: 6461 7461 2074 6872 6f75 6768 6f75 7420  data throughout 
-0003a1d0: 636c 7573 7465 720a 0a20 2020 2020 2020  cluster..       
-0003a1e0: 2054 6869 7320 7065 7266 6f72 6d73 2061   This performs a
-0003a1f0: 2074 7265 6520 636f 7079 206f 6620 7468   tree copy of th
-0003a200: 6520 6461 7461 2074 6872 6f75 6768 6f75  e data throughou
-0003a210: 7420 7468 6520 6e65 7477 6f72 6b0a 2020  t the network.  
-0003a220: 2020 2020 2020 696e 6469 7669 6475 616c        individual
-0003a230: 6c79 206f 6e20 6561 6368 2070 6965 6365  ly on each piece
-0003a240: 206f 6620 6461 7461 2e0a 0a20 2020 2020   of data...     
-0003a250: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0003a260: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-0003a270: 0a20 2020 2020 2020 206b 6579 733a 2049  .        keys: I
-0003a280: 7465 7261 626c 650a 2020 2020 2020 2020  terable.        
-0003a290: 2020 2020 6c69 7374 206f 6620 6b65 7973      list of keys
-0003a2a0: 2074 6f20 7265 706c 6963 6174 650a 2020   to replicate.  
-0003a2b0: 2020 2020 2020 6e3a 2069 6e74 0a20 2020        n: int.   
-0003a2c0: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
-0003a2d0: 6f66 2072 6570 6c69 6361 7469 6f6e 7320  of replications 
-0003a2e0: 7765 2065 7870 6563 7420 746f 2073 6565  we expect to see
-0003a2f0: 2077 6974 6869 6e20 7468 6520 636c 7573   within the clus
-0003a300: 7465 720a 2020 2020 2020 2020 6272 616e  ter.        bran
-0003a310: 6368 696e 675f 6661 6374 6f72 3a20 696e  ching_factor: in
-0003a320: 742c 206f 7074 696f 6e61 6c0a 2020 2020  t, optional.    
-0003a330: 2020 2020 2020 2020 5468 6520 6e75 6d62          The numb
-0003a340: 6572 206f 6620 776f 726b 6572 7320 7468  er of workers th
-0003a350: 6174 2063 616e 2063 6f70 7920 6461 7461  at can copy data
-0003a360: 2069 6e20 6561 6368 2067 656e 6572 6174   in each generat
-0003a370: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-0003a380: 2054 6865 206c 6172 6765 7220 7468 6520   The larger the 
-0003a390: 6272 616e 6368 696e 6720 6661 6374 6f72  branching factor
-0003a3a0: 2c20 7468 6520 6d6f 7265 2064 6174 6120  , the more data 
-0003a3b0: 7765 2063 6f70 7920 696e 0a20 2020 2020  we copy in.     
-0003a3c0: 2020 2020 2020 2061 2073 696e 676c 6520         a single 
-0003a3d0: 7374 6570 2c20 6275 7420 7468 6520 6d6f  step, but the mo
-0003a3e0: 7265 2061 2067 6976 656e 2077 6f72 6b65  re a given worke
-0003a3f0: 7220 7269 736b 7320 6265 696e 670a 2020  r risks being.  
-0003a400: 2020 2020 2020 2020 2020 7377 616d 7065            swampe
-0003a410: 6420 6279 2064 6174 6120 7265 7175 6573  d by data reques
-0003a420: 7473 2e0a 0a20 2020 2020 2020 2053 6565  ts...        See
-0003a430: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
-0003a440: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-0003a450: 6368 6564 756c 6572 2e72 6562 616c 616e  cheduler.rebalan
-0003a460: 6365 0a20 2020 2020 2020 2022 2222 0a20  ce.        """. 
-0003a470: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-0003a480: 6964 203d 2073 7469 6d75 6c75 735f 6964  id = stimulus_id
-0003a490: 206f 7220 6622 7265 706c 6963 6174 652d   or f"replicate-
-0003a4a0: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
-0003a4b0: 2020 6173 7365 7274 2062 7261 6e63 6869    assert branchi
-0003a4c0: 6e67 5f66 6163 746f 7220 3e20 300a 2020  ng_factor > 0.  
-0003a4d0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-0003a4e0: 2073 656c 662e 5f6c 6f63 6b20 6966 206c   self._lock if l
-0003a4f0: 6f63 6b20 656c 7365 2065 6d70 7479 5f63  ock else empty_c
-0003a500: 6f6e 7465 7874 3a0a 2020 2020 2020 2020  ontext:.        
-0003a510: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
-0003a520: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0003a530: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0003a540: 6572 7320 3d20 7b73 656c 662e 776f 726b  ers = {self.work
-0003a550: 6572 735b 775d 2066 6f72 2077 2069 6e20  ers[w] for w in 
-0003a560: 7365 6c66 2e77 6f72 6b65 7273 5f6c 6973  self.workers_lis
-0003a570: 7428 776f 726b 6572 7329 7d0a 2020 2020  t(workers)}.    
-0003a580: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0003a590: 6572 7320 3d20 7b77 7320 666f 7220 7773  ers = {ws for ws
-0003a5a0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
-0003a5b0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0003a5c0: 7573 2e72 756e 6e69 6e67 7d0a 2020 2020  us.running}.    
-0003a5d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003a5e0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0003a5f0: 726b 6572 7320 3d20 7365 6c66 2e72 756e  rkers = self.run
-0003a600: 6e69 6e67 0a0a 2020 2020 2020 2020 2020  ning..          
-0003a610: 2020 6966 206e 2069 7320 4e6f 6e65 3a0a    if n is None:.
-0003a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a630: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
-0003a640: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0003a650: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003a660: 2020 206e 203d 206d 696e 286e 2c20 6c65     n = min(n, le
-0003a670: 6e28 776f 726b 6572 7329 290a 2020 2020  n(workers)).    
-0003a680: 2020 2020 2020 2020 6966 206e 203d 3d20          if n == 
-0003a690: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0003a6a0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0003a6b0: 726f 7228 2243 616e 206e 6f74 2075 7365  ror("Can not use
-0003a6c0: 2072 6570 6c69 6361 7465 2074 6f20 6465   replicate to de
-0003a6d0: 6c65 7465 2064 6174 6122 290a 0a20 2020  lete data")..   
-0003a6e0: 2020 2020 2020 2020 2074 6173 6b73 203d           tasks =
-0003a6f0: 207b 7365 6c66 2e74 6173 6b73 5b6b 5d20   {self.tasks[k] 
-0003a700: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
-0003a710: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0003a720: 6e67 5f64 6174 6120 3d20 5b74 732e 6b65  ng_data = [ts.ke
-0003a730: 7920 666f 7220 7473 2069 6e20 7461 736b  y for ts in task
-0003a740: 7320 6966 206e 6f74 2074 732e 7768 6f5f  s if not ts.who_
-0003a750: 6861 735d 0a20 2020 2020 2020 2020 2020  has].           
-0003a760: 2069 6620 6d69 7373 696e 675f 6461 7461   if missing_data
-0003a770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a780: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
-0003a790: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
-0003a7a0: 6c22 2c20 226b 6579 7322 3a20 6d69 7373  l", "keys": miss
-0003a7b0: 696e 675f 6461 7461 7d0a 0a20 2020 2020  ing_data}..     
-0003a7c0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
-0003a7d0: 6578 7472 616e 656f 7573 2064 6174 610a  extraneous data.
-0003a7e0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0003a7f0: 656c 6574 653a 0a20 2020 2020 2020 2020  elete:.         
-0003a800: 2020 2020 2020 2064 656c 5f77 6f72 6b65         del_worke
-0003a810: 725f 7461 736b 7320 3d20 6465 6661 756c  r_tasks = defaul
-0003a820: 7464 6963 7428 7365 7429 0a20 2020 2020  tdict(set).     
-0003a830: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0003a840: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
-0003a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a860: 6465 6c5f 6361 6e64 6964 6174 6573 203d  del_candidates =
-0003a870: 2074 7570 6c65 2874 732e 7768 6f5f 6861   tuple(ts.who_ha
-0003a880: 7320 2620 776f 726b 6572 7329 0a20 2020  s & workers).   
-0003a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a8a0: 2069 6620 6c65 6e28 6465 6c5f 6361 6e64   if len(del_cand
-0003a8b0: 6964 6174 6573 2920 3e20 6e3a 0a20 2020  idates) > n:.   
-0003a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a8d0: 2020 2020 2066 6f72 2077 7320 696e 2072       for ws in r
-0003a8e0: 616e 646f 6d2e 7361 6d70 6c65 280a 2020  andom.sample(.  
-0003a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a900: 2020 2020 2020 2020 2020 6465 6c5f 6361            del_ca
-0003a910: 6e64 6964 6174 6573 2c20 6c65 6e28 6465  ndidates, len(de
-0003a920: 6c5f 6361 6e64 6964 6174 6573 2920 2d20  l_candidates) - 
-0003a930: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0003a940: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
-0003a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a960: 2020 2020 2020 2020 2064 656c 5f77 6f72           del_wor
-0003a970: 6b65 725f 7461 736b 735b 7773 5d2e 6164  ker_tasks[ws].ad
-0003a980: 6428 7473 290a 0a20 2020 2020 2020 2020  d(ts)..         
-0003a990: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
-0003a9a0: 6869 7320 6e65 7665 7220 7261 6973 6573  his never raises
-0003a9b0: 2065 7863 6570 7469 6f6e 730a 2020 2020   exceptions.    
-0003a9c0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003a9d0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0003a9e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003a9f0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-0003aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa10: 2073 656c 662e 6465 6c65 7465 5f77 6f72   self.delete_wor
-0003aa20: 6b65 725f 6461 7461 280a 2020 2020 2020  ker_data(.      
-0003aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aa40: 2020 2020 2020 7773 2e61 6464 7265 7373        ws.address
-0003aa50: 2c20 5b74 2e6b 6579 2066 6f72 2074 2069  , [t.key for t i
-0003aa60: 6e20 7461 736b 735d 2c20 7374 696d 756c  n tasks], stimul
-0003aa70: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-0003aa80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aaa0: 2020 2020 2020 2020 666f 7220 7773 2c20          for ws, 
-0003aab0: 7461 736b 7320 696e 2064 656c 5f77 6f72  tasks in del_wor
-0003aac0: 6b65 725f 7461 736b 732e 6974 656d 7328  ker_tasks.items(
-0003aad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003aae0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0003aaf0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0003ab00: 2020 2020 2020 2023 2043 6f70 7920 6e6f         # Copy no
-0003ab10: 742d 7965 742d 6669 6c6c 6564 2064 6174  t-yet-filled dat
-0003ab20: 610a 2020 2020 2020 2020 2020 2020 7768  a.            wh
-0003ab30: 696c 6520 7461 736b 733a 0a20 2020 2020  ile tasks:.     
-0003ab40: 2020 2020 2020 2020 2020 2067 6174 6865             gathe
-0003ab50: 7273 203d 2064 6566 6175 6c74 6469 6374  rs = defaultdict
-0003ab60: 2864 6963 7429 0a20 2020 2020 2020 2020  (dict).         
-0003ab70: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-0003ab80: 206c 6973 7428 7461 736b 7329 3a0a 2020   list(tasks):.  
-0003ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aba0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-0003abb0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
-0003abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003abd0: 2020 2020 2020 2320 7461 736b 2069 7320        # task is 
-0003abe0: 6e6f 206c 6f6e 6765 7220 6e65 6564 6564  no longer needed
-0003abf0: 2062 7920 616e 7920 636c 6965 6e74 206f   by any client o
-0003ac00: 7220 6465 7065 6e64 656e 7420 7461 736b  r dependent task
-0003ac10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ac20: 2020 2020 2020 2020 2074 6173 6b73 2e72           tasks.r
-0003ac30: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
-0003ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ac50: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0003ac60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0003ac70: 5f6d 6973 7369 6e67 203d 206e 202d 206c  _missing = n - l
-0003ac80: 656e 2874 732e 7768 6f5f 6861 7320 2620  en(ts.who_has & 
-0003ac90: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
-0003aca0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003acb0: 6e5f 6d69 7373 696e 6720 3c3d 2030 3a0a  n_missing <= 0:.
-0003acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003acd0: 2020 2020 2020 2020 2320 416c 7265 6164          # Alread
-0003ace0: 7920 7265 706c 6963 6174 6564 2065 6e6f  y replicated eno
-0003acf0: 7567 680a 2020 2020 2020 2020 2020 2020  ugh.            
-0003ad00: 2020 2020 2020 2020 2020 2020 7461 736b              task
-0003ad10: 732e 7265 6d6f 7665 2874 7329 0a20 2020  s.remove(ts).   
-0003ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad30: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-0003ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ad50: 2020 2063 6f75 6e74 203d 206d 696e 286e     count = min(n
-0003ad60: 5f6d 6973 7369 6e67 2c20 6272 616e 6368  _missing, branch
-0003ad70: 696e 675f 6661 6374 6f72 202a 206c 656e  ing_factor * len
-0003ad80: 2874 732e 7768 6f5f 6861 7329 290a 2020  (ts.who_has)).  
-0003ad90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ada0: 2020 6173 7365 7274 2063 6f75 6e74 203e    assert count >
-0003adb0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
-0003adc0: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-0003add0: 6e20 7261 6e64 6f6d 2e73 616d 706c 6528  n random.sample(
-0003ade0: 7475 706c 6528 776f 726b 6572 7320 2d20  tuple(workers - 
-0003adf0: 7473 2e77 686f 5f68 6173 292c 2063 6f75  ts.who_has), cou
-0003ae00: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-0003ae10: 2020 2020 2020 2020 2020 2020 2067 6174               gat
-0003ae20: 6865 7273 5b77 732e 6164 6472 6573 735d  hers[ws.address]
-0003ae30: 5b74 732e 6b65 795d 203d 205b 0a20 2020  [ts.key] = [.   
-0003ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae50: 2020 2020 2020 2020 2077 7773 2e61 6464           wws.add
-0003ae60: 7265 7373 2066 6f72 2077 7773 2069 6e20  ress for wws in 
-0003ae70: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0003ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ae90: 2020 205d 0a0a 2020 2020 2020 2020 2020     ]..          
-0003aea0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-0003aeb0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-0003aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003aed0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
-0003aee0: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-0003aef0: 653a 2074 6869 7320 6e65 7665 7220 7261  e: this never ra
-0003af00: 6973 6573 2065 7863 6570 7469 6f6e 730a  ises exceptions.
-0003af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003af20: 2020 2020 2020 2020 7365 6c66 2e67 6174          self.gat
-0003af30: 6865 725f 6f6e 5f77 6f72 6b65 7228 772c  her_on_worker(w,
-0003af40: 2077 686f 5f68 6173 290a 2020 2020 2020   who_has).      
-0003af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003af60: 2020 666f 7220 772c 2077 686f 5f68 6173    for w, who_has
-0003af70: 2069 6e20 6761 7468 6572 732e 6974 656d   in gathers.item
-0003af80: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0003af90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0003afa0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0003afb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0003afc0: 722c 2076 2069 6e20 6761 7468 6572 732e  r, v in gathers.
-0003afd0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0003afe0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003aff0: 662e 6c6f 675f 6576 656e 7428 722c 207b  f.log_event(r, {
-0003b000: 2261 6374 696f 6e22 3a20 2272 6570 6c69  "action": "repli
-0003b010: 6361 7465 2d61 6464 222c 2022 7768 6f5f  cate-add", "who_
-0003b020: 6861 7322 3a20 767d 290a 0a20 2020 2020  has": v})..     
-0003b030: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-0003b040: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
-0003b050: 2020 2020 2020 2022 616c 6c22 2c0a 2020         "all",.  
-0003b060: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0003b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b080: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
-0003b090: 6570 6c69 6361 7465 222c 0a20 2020 2020  eplicate",.     
-0003b0a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003b0b0: 776f 726b 6572 7322 3a20 6c69 7374 2877  workers": list(w
-0003b0c0: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
-0003b0d0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-0003b0e0: 792d 636f 756e 7422 3a20 6c65 6e28 6b65  y-count": len(ke
-0003b0f0: 7973 292c 0a20 2020 2020 2020 2020 2020  ys),.           
-0003b100: 2020 2020 2020 2020 2022 6272 616e 6368           "branch
-0003b110: 696e 672d 6661 6374 6f72 223a 2062 7261  ing-factor": bra
-0003b120: 6e63 6869 6e67 5f66 6163 746f 722c 0a20  nching_factor,. 
-0003b130: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0003b140: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0003b150: 0a20 2020 2064 6566 2077 6f72 6b65 7273  .    def workers
-0003b160: 5f74 6f5f 636c 6f73 6528 0a20 2020 2020  _to_close(.     
-0003b170: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0003b180: 206d 656d 6f72 795f 7261 7469 6f3a 2069   memory_ratio: i
-0003b190: 6e74 207c 2066 6c6f 6174 207c 204e 6f6e  nt | float | Non
-0003b1a0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0003b1b0: 2020 6e3a 2069 6e74 207c 204e 6f6e 6520    n: int | None 
-0003b1c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003b1d0: 6b65 793a 2043 616c 6c61 626c 655b 5b57  key: Callable[[W
-0003b1e0: 6f72 6b65 7253 7461 7465 5d2c 2048 6173  orkerState], Has
-0003b1f0: 6861 626c 655d 207c 2062 7974 6573 207c  hable] | bytes |
-0003b200: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-0003b210: 2020 2020 2020 6d69 6e69 6d75 6d3a 2069        minimum: i
-0003b220: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
-0003b230: 2c0a 2020 2020 2020 2020 7461 7267 6574  ,.        target
-0003b240: 3a20 696e 7420 7c20 4e6f 6e65 203d 204e  : int | None = N
-0003b250: 6f6e 652c 0a20 2020 2020 2020 2061 7474  one,.        att
-0003b260: 7269 6275 7465 3a20 7374 7220 3d20 2261  ribute: str = "a
-0003b270: 6464 7265 7373 222c 0a20 2020 2029 202d  ddress",.    ) -
-0003b280: 3e20 6c69 7374 5b73 7472 5d3a 0a20 2020  > list[str]:.   
-0003b290: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0003b2a0: 2046 696e 6420 776f 726b 6572 7320 7468   Find workers th
-0003b2b0: 6174 2077 6520 6361 6e20 636c 6f73 6520  at we can close 
-0003b2c0: 7769 7468 206c 6f77 2063 6f73 740a 0a20  with low cost.. 
-0003b2d0: 2020 2020 2020 2054 6869 7320 7265 7475         This retu
-0003b2e0: 726e 7320 6120 6c69 7374 206f 6620 776f  rns a list of wo
-0003b2f0: 726b 6572 7320 7468 6174 2061 7265 2067  rkers that are g
-0003b300: 6f6f 6420 6361 6e64 6964 6174 6573 2074  ood candidates t
-0003b310: 6f20 7265 7469 7265 2e0a 2020 2020 2020  o retire..      
-0003b320: 2020 5468 6573 6520 776f 726b 6572 7320    These workers 
-0003b330: 6172 6520 6e6f 7420 7275 6e6e 696e 6720  are not running 
-0003b340: 616e 7974 6869 6e67 2061 6e64 2061 7265  anything and are
-0003b350: 2073 746f 7269 6e67 0a20 2020 2020 2020   storing.       
-0003b360: 2072 656c 6174 6976 656c 7920 6c69 7474   relatively litt
-0003b370: 6c65 2064 6174 6120 7265 6c61 7469 7665  le data relative
-0003b380: 2074 6f20 7468 6569 7220 7065 6572 732e   to their peers.
-0003b390: 2020 4966 2061 6c6c 2077 6f72 6b65 7273    If all workers
-0003b3a0: 2061 7265 0a20 2020 2020 2020 2069 646c   are.        idl
-0003b3b0: 6520 7468 656e 2077 6520 7374 696c 6c20  e then we still 
-0003b3c0: 6d61 696e 7461 696e 2065 6e6f 7567 6820  maintain enough 
-0003b3d0: 776f 726b 6572 7320 746f 2068 6176 6520  workers to have 
-0003b3e0: 656e 6f75 6768 2052 414d 2074 6f20 7374  enough RAM to st
-0003b3f0: 6f72 650a 2020 2020 2020 2020 6f75 7220  ore.        our 
-0003b400: 6461 7461 2c20 7769 7468 2061 2063 6f6d  data, with a com
-0003b410: 666f 7274 6162 6c65 2062 7566 6665 722e  fortable buffer.
-0003b420: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
-0003b430: 7320 666f 7220 7573 6520 7769 7468 2073  s for use with s
-0003b440: 7973 7465 6d73 206c 696b 6520 6060 6469  ystems like ``di
-0003b450: 7374 7269 6275 7465 642e 6465 706c 6f79  stributed.deploy
-0003b460: 2e61 6461 7074 6976 6560 602e 0a0a 2020  .adaptive``...  
-0003b470: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-0003b480: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003b490: 2d2d 2d0a 2020 2020 2020 2020 6d65 6d6f  ---.        memo
-0003b4a0: 7279 5f72 6174 696f 203a 204e 756d 6265  ry_ratio : Numbe
-0003b4b0: 720a 2020 2020 2020 2020 2020 2020 416d  r.            Am
-0003b4c0: 6f75 6e74 206f 6620 6578 7472 6120 7370  ount of extra sp
-0003b4d0: 6163 6520 7765 2077 616e 7420 746f 2068  ace we want to h
-0003b4e0: 6176 6520 666f 7220 6f75 7220 7374 6f72  ave for our stor
-0003b4f0: 6564 2064 6174 612e 0a20 2020 2020 2020  ed data..       
-0003b500: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
-0003b510: 2032 2c20 6f72 2074 6861 7420 7765 2077   2, or that we w
-0003b520: 616e 7420 746f 2068 6176 6520 7477 6963  ant to have twic
-0003b530: 6520 6173 206d 7563 6820 6d65 6d6f 7279  e as much memory
-0003b540: 2061 7320 7765 0a20 2020 2020 2020 2020   as we.         
-0003b550: 2020 2063 7572 7265 6e74 6c79 2068 6176     currently hav
-0003b560: 6520 6461 7461 2e0a 2020 2020 2020 2020  e data..        
-0003b570: 6e20 3a20 696e 740a 2020 2020 2020 2020  n : int.        
-0003b580: 2020 2020 4e75 6d62 6572 206f 6620 776f      Number of wo
-0003b590: 726b 6572 7320 746f 2063 6c6f 7365 0a20  rkers to close. 
-0003b5a0: 2020 2020 2020 206d 696e 696d 756d 203a         minimum :
-0003b5b0: 2069 6e74 0a20 2020 2020 2020 2020 2020   int.           
-0003b5c0: 204d 696e 696d 756d 206e 756d 6265 7220   Minimum number 
-0003b5d0: 6f66 2077 6f72 6b65 7273 2074 6f20 6b65  of workers to ke
-0003b5e0: 6570 2061 726f 756e 640a 2020 2020 2020  ep around.      
-0003b5f0: 2020 6b65 7920 3a20 4361 6c6c 6162 6c65    key : Callable
-0003b600: 2857 6f72 6b65 7253 7461 7465 290a 2020  (WorkerState).  
-0003b610: 2020 2020 2020 2020 2020 416e 206f 7074            An opt
-0003b620: 696f 6e61 6c20 6361 6c6c 6162 6c65 206d  ional callable m
-0003b630: 6170 7069 6e67 2061 2057 6f72 6b65 7253  apping a WorkerS
-0003b640: 7461 7465 206f 626a 6563 7420 746f 2061  tate object to a
-0003b650: 2067 726f 7570 0a20 2020 2020 2020 2020   group.         
-0003b660: 2020 2061 6666 696c 6961 7469 6f6e 2e20     affiliation. 
-0003b670: 4772 6f75 7073 2077 696c 6c20 6265 2063  Groups will be c
-0003b680: 6c6f 7365 6420 746f 6765 7468 6572 2e20  losed together. 
-0003b690: 5468 6973 2069 7320 7573 6566 756c 2077  This is useful w
-0003b6a0: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
-0003b6b0: 636c 6f73 696e 6720 776f 726b 6572 7320  closing workers 
-0003b6c0: 6d75 7374 2062 6520 646f 6e65 2063 6f6c  must be done col
-0003b6d0: 6c65 6374 6976 656c 792c 2073 7563 6820  lectively, such 
-0003b6e0: 6173 2062 7920 686f 7374 6e61 6d65 2e0a  as by hostname..
-0003b6f0: 2020 2020 2020 2020 7461 7267 6574 203a          target :
-0003b700: 2069 6e74 0a20 2020 2020 2020 2020 2020   int.           
-0003b710: 2054 6172 6765 7420 6e75 6d62 6572 206f   Target number o
-0003b720: 6620 776f 726b 6572 7320 746f 2068 6176  f workers to hav
-0003b730: 6520 6166 7465 7220 7765 2063 6c6f 7365  e after we close
-0003b740: 0a20 2020 2020 2020 2061 7474 7269 6275  .        attribu
-0003b750: 7465 203a 2073 7472 0a20 2020 2020 2020  te : str.       
-0003b760: 2020 2020 2054 6865 2061 7474 7269 6275       The attribu
-0003b770: 7465 206f 6620 7468 6520 576f 726b 6572  te of the Worker
-0003b780: 5374 6174 6520 6f62 6a65 6374 2074 6f20  State object to 
-0003b790: 7265 7475 726e 2c20 6c69 6b65 2022 6164  return, like "ad
-0003b7a0: 6472 6573 7322 0a20 2020 2020 2020 2020  dress".         
-0003b7b0: 2020 206f 7220 226e 616d 6522 2e20 2044     or "name".  D
-0003b7c0: 6566 6175 6c74 7320 746f 2022 6164 6472  efaults to "addr
-0003b7d0: 6573 7322 2e0a 0a20 2020 2020 2020 2045  ess"...        E
-0003b7e0: 7861 6d70 6c65 730a 2020 2020 2020 2020  xamples.        
-0003b7f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-0003b800: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
-0003b810: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0003b820: 290a 2020 2020 2020 2020 5b27 7463 703a  ).        ['tcp:
-0003b830: 2f2f 3139 322e 3136 382e 302e 313a 3132  //192.168.0.1:12
-0003b840: 3334 272c 2027 7463 703a 2f2f 3139 322e  34', 'tcp://192.
-0003b850: 3136 382e 302e 323a 3132 3334 275d 0a0a  168.0.2:1234']..
-0003b860: 2020 2020 2020 2020 4772 6f75 7020 776f          Group wo
-0003b870: 726b 6572 7320 6279 2068 6f73 746e 616d  rkers by hostnam
-0003b880: 6520 7072 696f 7220 746f 2063 6c6f 7369  e prior to closi
-0003b890: 6e67 0a0a 2020 2020 2020 2020 3e3e 3e20  ng..        >>> 
-0003b8a0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-0003b8b0: 735f 746f 5f63 6c6f 7365 286b 6579 3d6c  s_to_close(key=l
-0003b8c0: 616d 6264 6120 7773 3a20 7773 2e68 6f73  ambda ws: ws.hos
-0003b8d0: 7429 0a20 2020 2020 2020 205b 2774 6370  t).        ['tcp
-0003b8e0: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a31  ://192.168.0.1:1
-0003b8f0: 3233 3427 2c20 2774 6370 3a2f 2f31 3932  234', 'tcp://192
-0003b900: 2e31 3638 2e30 2e31 3a34 3536 3727 5d0a  .168.0.1:4567'].
-0003b910: 0a20 2020 2020 2020 2052 656d 6f76 6520  .        Remove 
-0003b920: 7477 6f20 776f 726b 6572 730a 0a20 2020  two workers..   
-0003b930: 2020 2020 203e 3e3e 2073 6368 6564 756c       >>> schedul
-0003b940: 6572 2e77 6f72 6b65 7273 5f74 6f5f 636c  er.workers_to_cl
-0003b950: 6f73 6528 6e3d 3229 0a0a 2020 2020 2020  ose(n=2)..      
-0003b960: 2020 4b65 6570 2065 6e6f 7567 6820 776f    Keep enough wo
-0003b970: 726b 6572 7320 746f 2068 6176 6520 7477  rkers to have tw
-0003b980: 6963 6520 6173 206d 7563 6820 6d65 6d6f  ice as much memo
-0003b990: 7279 2061 7320 7765 2077 6520 6e65 6564  ry as we we need
-0003b9a0: 2e0a 0a20 2020 2020 2020 203e 3e3e 2073  ...        >>> s
-0003b9b0: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-0003b9c0: 5f74 6f5f 636c 6f73 6528 6d65 6d6f 7279  _to_close(memory
-0003b9d0: 5f72 6174 696f 3d32 290a 0a20 2020 2020  _ratio=2)..     
-0003b9e0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-0003b9f0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-0003ba00: 2020 2074 6f5f 636c 6f73 653a 206c 6973     to_close: lis
-0003ba10: 7420 6f66 2077 6f72 6b65 7220 6164 6472  t of worker addr
-0003ba20: 6573 7365 7320 7468 6174 2061 7265 204f  esses that are O
-0003ba30: 4b20 746f 2063 6c6f 7365 0a0a 2020 2020  K to close..    
-0003ba40: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
-0003ba50: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-0003ba60: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
-0003ba70: 7265 7469 7265 5f77 6f72 6b65 7273 0a20  retire_workers. 
-0003ba80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0003ba90: 2020 2069 6620 7461 7267 6574 2069 7320     if target is 
-0003baa0: 6e6f 7420 4e6f 6e65 2061 6e64 206e 2069  not None and n i
-0003bab0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0003bac0: 2020 2020 6e20 3d20 6c65 6e28 7365 6c66      n = len(self
-0003bad0: 2e77 6f72 6b65 7273 2920 2d20 7461 7267  .workers) - targ
-0003bae0: 6574 0a20 2020 2020 2020 2069 6620 6e20  et.        if n 
-0003baf0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0003bb00: 2020 2020 2020 2020 2069 6620 6e20 3c20           if n < 
-0003bb10: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0003bb20: 2020 206e 203d 2030 0a20 2020 2020 2020     n = 0.       
-0003bb30: 2020 2020 2074 6172 6765 7420 3d20 6c65       target = le
-0003bb40: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-0003bb50: 2d20 6e0a 0a20 2020 2020 2020 2069 6620  - n..        if 
-0003bb60: 6e20 6973 204e 6f6e 6520 616e 6420 6d65  n is None and me
-0003bb70: 6d6f 7279 5f72 6174 696f 2069 7320 4e6f  mory_ratio is No
-0003bb80: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003bb90: 6d65 6d6f 7279 5f72 6174 696f 203d 2032  memory_ratio = 2
-0003bba0: 0a0a 2020 2020 2020 2020 7769 7468 206c  ..        with l
-0003bbb0: 6f67 5f65 7272 6f72 7328 293a 0a20 2020  og_errors():.   
-0003bbc0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0003bbd0: 6e20 616e 6420 616c 6c28 5b77 732e 7072  n and all([ws.pr
-0003bbe0: 6f63 6573 7369 6e67 2066 6f72 2077 7320  ocessing for ws 
-0003bbf0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0003bc00: 7661 6c75 6573 2829 5d29 3a0a 2020 2020  values()]):.    
-0003bc10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003bc20: 726e 205b 5d0a 0a20 2020 2020 2020 2020  rn []..         
-0003bc30: 2020 2069 6620 6b65 7920 6973 204e 6f6e     if key is Non
-0003bc40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003bc50: 2020 206b 6579 203d 206f 7065 7261 746f     key = operato
-0003bc60: 722e 6174 7472 6765 7474 6572 2822 6164  r.attrgetter("ad
-0003bc70: 6472 6573 7322 290a 2020 2020 2020 2020  dress").        
-0003bc80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0003bc90: 6528 6b65 792c 2062 7974 6573 2920 616e  e(key, bytes) an
-0003bca0: 6420 6461 736b 2e63 6f6e 6669 672e 6765  d dask.config.ge
-0003bcb0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0003bcc0: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-0003bcd0: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
-0003bce0: 220a 2020 2020 2020 2020 2020 2020 293a  ".            ):
-0003bcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bd00: 206b 6579 203d 2070 6963 6b6c 652e 6c6f   key = pickle.lo
-0003bd10: 6164 7328 6b65 7929 0a0a 2020 2020 2020  ads(key)..      
-0003bd20: 2020 2020 2020 6772 6f75 7073 203d 2067        groups = g
-0003bd30: 726f 7570 6279 286b 6579 2c20 7365 6c66  roupby(key, self
-0003bd40: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0003bd50: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-0003bd60: 6c69 6d69 745f 6279 7465 7320 3d20 7b0a  limit_bytes = {.
-0003bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bd80: 6b3a 2073 756d 2877 732e 6d65 6d6f 7279  k: sum(ws.memory
-0003bd90: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
-0003bda0: 2076 2920 666f 7220 6b2c 2076 2069 6e20   v) for k, v in 
-0003bdb0: 6772 6f75 7073 2e69 7465 6d73 2829 0a20  groups.items(). 
-0003bdc0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003bdd0: 2020 2020 2020 2020 2067 726f 7570 5f62           group_b
-0003bde0: 7974 6573 203d 207b 6b3a 2073 756d 2877  ytes = {k: sum(w
-0003bdf0: 732e 6e62 7974 6573 2066 6f72 2077 7320  s.nbytes for ws 
-0003be00: 696e 2076 2920 666f 7220 6b2c 2076 2069  in v) for k, v i
-0003be10: 6e20 6772 6f75 7073 2e69 7465 6d73 2829  n groups.items()
-0003be20: 7d0a 0a20 2020 2020 2020 2020 2020 206c  }..            l
-0003be30: 696d 6974 203d 2073 756d 286c 696d 6974  imit = sum(limit
-0003be40: 5f62 7974 6573 2e76 616c 7565 7328 2929  _bytes.values())
-0003be50: 0a20 2020 2020 2020 2020 2020 2074 6f74  .            tot
-0003be60: 616c 203d 2073 756d 2867 726f 7570 5f62  al = sum(group_b
-0003be70: 7974 6573 2e76 616c 7565 7328 2929 0a0a  ytes.values())..
-0003be80: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-0003be90: 5f6b 6579 2867 726f 7570 293a 0a20 2020  _key(group):.   
-0003bea0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-0003beb0: 6964 6c65 203d 206e 6f74 2061 6e79 285b  idle = not any([
-0003bec0: 7777 732e 7072 6f63 6573 7369 6e67 2066  wws.processing f
-0003bed0: 6f72 2077 7773 2069 6e20 6772 6f75 7073  or wws in groups
-0003bee0: 5b67 726f 7570 5d5d 290a 2020 2020 2020  [group]]).      
-0003bef0: 2020 2020 2020 2020 2020 6279 7465 7320            bytes 
-0003bf00: 3d20 2d67 726f 7570 5f62 7974 6573 5b67  = -group_bytes[g
-0003bf10: 726f 7570 5d0a 2020 2020 2020 2020 2020  roup].          
-0003bf20: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
-0003bf30: 6964 6c65 2c20 6279 7465 730a 0a20 2020  idle, bytes..   
-0003bf40: 2020 2020 2020 2020 2069 646c 6520 3d20           idle = 
-0003bf50: 736f 7274 6564 2867 726f 7570 732c 206b  sorted(groups, k
-0003bf60: 6579 3d5f 6b65 7929 0a0a 2020 2020 2020  ey=_key)..      
-0003bf70: 2020 2020 2020 746f 5f63 6c6f 7365 203d        to_close =
-0003bf80: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0003bf90: 6e5f 7265 6d61 696e 203d 206c 656e 2873  n_remain = len(s
-0003bfa0: 656c 662e 776f 726b 6572 7329 0a0a 2020  elf.workers)..  
-0003bfb0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-0003bfc0: 6964 6c65 3a0a 2020 2020 2020 2020 2020  idle:.          
-0003bfd0: 2020 2020 2020 6772 6f75 7020 3d20 6964        group = id
-0003bfe0: 6c65 2e70 6f70 2829 0a20 2020 2020 2020  le.pop().       
-0003bff0: 2020 2020 2020 2020 2069 6620 6e20 6973           if n is
-0003c000: 204e 6f6e 6520 616e 6420 616e 7928 5b77   None and any([w
-0003c010: 732e 7072 6f63 6573 7369 6e67 2066 6f72  s.processing for
-0003c020: 2077 7320 696e 2067 726f 7570 735b 6772   ws in groups[gr
-0003c030: 6f75 705d 5d29 3a0a 2020 2020 2020 2020  oup]]):.        
-0003c040: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0003c050: 6b0a 0a20 2020 2020 2020 2020 2020 2020  k..             
-0003c060: 2020 2069 6620 6d69 6e69 6d75 6d20 616e     if minimum an
-0003c070: 6420 6e5f 7265 6d61 696e 202d 206c 656e  d n_remain - len
-0003c080: 2867 726f 7570 735b 6772 6f75 705d 2920  (groups[group]) 
-0003c090: 3c20 6d69 6e69 6d75 6d3a 0a20 2020 2020  < minimum:.     
-0003c0a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0003c0b0: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
-0003c0c0: 2020 2020 2020 6c69 6d69 7420 2d3d 206c        limit -= l
-0003c0d0: 696d 6974 5f62 7974 6573 5b67 726f 7570  imit_bytes[group
-0003c0e0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-0003c0f0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-0003c100: 2020 2020 2020 2020 2020 2020 6e20 6973              n is
-0003c110: 206e 6f74 204e 6f6e 6520 616e 6420 6e5f   not None and n_
-0003c120: 7265 6d61 696e 202d 206c 656e 2867 726f  remain - len(gro
-0003c130: 7570 735b 6772 6f75 705d 2920 3e3d 2028  ups[group]) >= (
-0003c140: 7461 7267 6574 206f 7220 3029 0a20 2020  target or 0).   
-0003c150: 2020 2020 2020 2020 2020 2020 2029 206f               ) o
-0003c160: 7220 286d 656d 6f72 795f 7261 7469 6f20  r (memory_ratio 
-0003c170: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-0003c180: 6c69 6d69 7420 3e3d 206d 656d 6f72 795f  limit >= memory_
-0003c190: 7261 7469 6f20 2a20 746f 7461 6c29 3a0a  ratio * total):.
-0003c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c1b0: 2020 2020 746f 5f63 6c6f 7365 2e61 7070      to_close.app
-0003c1c0: 656e 6428 6772 6f75 7029 0a20 2020 2020  end(group).     
-0003c1d0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0003c1e0: 5f72 656d 6169 6e20 2d3d 206c 656e 2867  _remain -= len(g
-0003c1f0: 726f 7570 735b 6772 6f75 705d 290a 0a20  roups[group]).. 
-0003c200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003c210: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003c220: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0003c230: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0003c240: 6c74 203d 205b 6765 7461 7474 7228 7773  lt = [getattr(ws
-0003c250: 2c20 6174 7472 6962 7574 6529 2066 6f72  , attribute) for
-0003c260: 2067 2069 6e20 746f 5f63 6c6f 7365 2066   g in to_close f
-0003c270: 6f72 2077 7320 696e 2067 726f 7570 735b  or ws in groups[
-0003c280: 675d 5d0a 2020 2020 2020 2020 2020 2020  g]].            
-0003c290: 6966 2072 6573 756c 743a 0a20 2020 2020  if result:.     
-0003c2a0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0003c2b0: 722e 6465 6275 6728 2253 7567 6765 7374  r.debug("Suggest
-0003c2c0: 2063 6c6f 7369 6e67 2077 6f72 6b65 7273   closing workers
-0003c2d0: 3a20 2573 222c 2072 6573 756c 7429 0a0a  : %s", result)..
-0003c2e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003c2f0: 726e 2072 6573 756c 740a 0a20 2020 2040  rn result..    @
-0003c300: 6c6f 675f 6572 726f 7273 0a20 2020 2061  log_errors.    a
-0003c310: 7379 6e63 2064 6566 2072 6574 6972 655f  sync def retire_
-0003c320: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
-0003c330: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
-0003c340: 6f72 6b65 7273 3a20 6c69 7374 5b73 7472  orkers: list[str
-0003c350: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
-0003c360: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-0003c370: 2020 2020 6e61 6d65 733a 206c 6973 7420      names: list 
-0003c380: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0003c390: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-0003c3a0: 6b65 7273 3a20 626f 6f6c 203d 2046 616c  kers: bool = Fal
-0003c3b0: 7365 2c0a 2020 2020 2020 2020 7265 6d6f  se,.        remo
-0003c3c0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
-0003c3d0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-0003c3e0: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
-0003c3f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0003c400: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-0003c410: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
-0003c420: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-0003c430: 2022 2222 4772 6163 6566 756c 6c79 2072   """Gracefully r
-0003c440: 6574 6972 6520 776f 726b 6572 7320 6672  etire workers fr
-0003c450: 6f6d 2063 6c75 7374 6572 2e20 416e 7920  om cluster. Any 
-0003c460: 6b65 7920 7468 6174 2069 7320 696e 206d  key that is in m
-0003c470: 656d 6f72 7920 6578 636c 7573 6976 656c  emory exclusivel
-0003c480: 790a 2020 2020 2020 2020 6f6e 2074 6865  y.        on the
-0003c490: 2072 6574 6972 6564 2077 6f72 6b65 7273   retired workers
-0003c4a0: 2069 7320 7265 706c 6963 6174 6564 2073   is replicated s
-0003c4b0: 6f6d 6577 6865 7265 2065 6c73 652e 0a0a  omewhere else...
-0003c4c0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-0003c4d0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-0003c4e0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
-0003c4f0: 726b 6572 733a 206c 6973 745b 7374 725d  rkers: list[str]
-0003c500: 2028 6f70 7469 6f6e 616c 290a 2020 2020   (optional).    
-0003c510: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
-0003c520: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
-0003c530: 2074 6f20 7265 7469 7265 2e0a 2020 2020   to retire..    
-0003c540: 2020 2020 6e61 6d65 733a 206c 6973 7420      names: list 
-0003c550: 286f 7074 696f 6e61 6c29 0a20 2020 2020  (optional).     
-0003c560: 2020 2020 2020 204c 6973 7420 6f66 2077         List of w
-0003c570: 6f72 6b65 7220 6e61 6d65 7320 746f 2072  orker names to r
-0003c580: 6574 6972 652e 0a20 2020 2020 2020 2020  etire..         
-0003c590: 2020 204d 7574 7561 6c6c 7920 6578 636c     Mutually excl
-0003c5a0: 7573 6976 6520 7769 7468 2060 6077 6f72  usive with ``wor
-0003c5b0: 6b65 7273 6060 2e0a 2020 2020 2020 2020  kers``..        
-0003c5c0: 2020 2020 4966 206e 6569 7468 6572 2060      If neither `
-0003c5d0: 6077 6f72 6b65 7273 6060 206e 6f72 2060  `workers`` nor `
-0003c5e0: 606e 616d 6573 6060 2061 7265 2070 726f  `names`` are pro
-0003c5f0: 7669 6465 642c 2077 6520 6361 6c6c 0a20  vided, we call. 
-0003c600: 2020 2020 2020 2020 2020 2060 6077 6f72             ``wor
-0003c610: 6b65 7273 5f74 6f5f 636c 6f73 6560 6020  kers_to_close`` 
-0003c620: 7768 6963 6820 6669 6e64 7320 6120 676f  which finds a go
-0003c630: 6f64 2073 6574 2e0a 2020 2020 2020 2020  od set..        
-0003c640: 636c 6f73 655f 776f 726b 6572 733a 2062  close_workers: b
-0003c650: 6f6f 6c20 2864 6566 6175 6c74 7320 746f  ool (defaults to
-0003c660: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
-0003c670: 2020 2020 5768 6574 6865 7220 6f72 206e      Whether or n
-0003c680: 6f74 2074 6f20 6163 7475 616c 6c79 2063  ot to actually c
-0003c690: 6c6f 7365 2074 6865 2077 6f72 6b65 7220  lose the worker 
-0003c6a0: 6578 706c 6963 6974 6c79 2066 726f 6d20  explicitly from 
-0003c6b0: 6865 7265 2e0a 2020 2020 2020 2020 2020  here..          
-0003c6c0: 2020 4f74 6865 7277 6973 6520 7765 2065    Otherwise we e
-0003c6d0: 7870 6563 7420 736f 6d65 2065 7874 6572  xpect some exter
-0003c6e0: 6e61 6c20 6a6f 6220 7363 6865 6475 6c65  nal job schedule
-0003c6f0: 7220 746f 2066 696e 6973 6820 6f66 6620  r to finish off 
-0003c700: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0003c710: 776f 726b 6572 2e0a 2020 2020 2020 2020  worker..        
-0003c720: 7265 6d6f 7665 3a20 626f 6f6c 2028 6465  remove: bool (de
-0003c730: 6661 756c 7473 2074 6f20 5472 7565 290a  faults to True).
-0003c740: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
-0003c750: 6865 7220 6f72 206e 6f74 2074 6f20 7265  her or not to re
-0003c760: 6d6f 7665 2074 6865 2077 6f72 6b65 7220  move the worker 
-0003c770: 6d65 7461 6461 7461 2069 6d6d 6564 6961  metadata immedia
-0003c780: 7465 6c79 206f 7220 656c 7365 0a20 2020  tely or else.   
-0003c790: 2020 2020 2020 2020 2077 6169 7420 666f           wait fo
-0003c7a0: 7220 7468 6520 776f 726b 6572 2074 6f20  r the worker to 
-0003c7b0: 636f 6e74 6163 7420 7573 2e0a 0a20 2020  contact us...   
-0003c7c0: 2020 2020 2020 2020 2049 6620 636c 6f73           If clos
-0003c7d0: 655f 776f 726b 6572 733d 4661 6c73 6520  e_workers=False 
-0003c7e0: 616e 6420 7265 6d6f 7665 3d46 616c 7365  and remove=False
-0003c7f0: 2c20 7468 6973 206d 6574 686f 6420 6a75  , this method ju
-0003c800: 7374 2066 6c75 7368 6573 2074 6865 2074  st flushes the t
-0003c810: 6173 6b73 0a20 2020 2020 2020 2020 2020  asks.           
-0003c820: 2069 6e20 6d65 6d6f 7279 206f 7574 206f   in memory out o
-0003c830: 6620 7468 6520 776f 726b 6572 7320 616e  f the workers an
-0003c840: 6420 7468 656e 2072 6574 7572 6e73 2e0a  d then returns..
-0003c850: 2020 2020 2020 2020 2020 2020 4966 2063              If c
-0003c860: 6c6f 7365 5f77 6f72 6b65 7273 3d54 7275  lose_workers=Tru
-0003c870: 6520 616e 6420 7265 6d6f 7665 3d46 616c  e and remove=Fal
-0003c880: 7365 2c20 7468 6973 206d 6574 686f 6420  se, this method 
-0003c890: 7769 6c6c 2072 6574 7572 6e20 7768 696c  will return whil
-0003c8a0: 6520 7468 650a 2020 2020 2020 2020 2020  e the.          
-0003c8b0: 2020 776f 726b 6572 7320 6172 6520 7374    workers are st
-0003c8c0: 696c 6c20 696e 2074 6865 2063 6c75 7374  ill in the clust
-0003c8d0: 6572 2c20 616c 7468 6f75 6768 2074 6865  er, although the
-0003c8e0: 7920 776f 6e27 7420 6163 6365 7074 206e  y won't accept n
-0003c8f0: 6577 2074 6173 6b73 2e0a 2020 2020 2020  ew tasks..      
-0003c900: 2020 2020 2020 4966 2063 6c6f 7365 5f77        If close_w
-0003c910: 6f72 6b65 7273 3d46 616c 7365 206f 7220  orkers=False or 
-0003c920: 666f 7220 7768 6174 6576 6572 2072 6561  for whatever rea
-0003c930: 736f 6e20 6120 776f 726b 6572 2064 6f65  son a worker doe
-0003c940: 736e 2774 2061 6363 6570 7420 7468 650a  sn't accept the.
-0003c950: 2020 2020 2020 2020 2020 2020 636c 6f73              clos
-0003c960: 6520 636f 6d6d 616e 642c 2069 7420 7769  e command, it wi
-0003c970: 6c6c 2062 6520 6c65 6674 2070 6572 6d61  ll be left perma
-0003c980: 6e65 6e74 6c79 2075 6e61 626c 6520 746f  nently unable to
-0003c990: 2061 6363 6570 7420 6e65 7720 7461 736b   accept new task
-0003c9a0: 7320 616e 640a 2020 2020 2020 2020 2020  s and.          
-0003c9b0: 2020 6974 2069 7320 6578 7065 6374 6564    it is expected
-0003c9c0: 2074 6f20 6265 2063 6c6f 7365 6420 696e   to be closed in
-0003c9d0: 2073 6f6d 6520 6f74 6865 7220 7761 792e   some other way.
-0003c9e0: 0a0a 2020 2020 2020 2020 2a2a 6b77 6172  ..        **kwar
-0003c9f0: 6773 3a20 6469 6374 0a20 2020 2020 2020  gs: dict.       
-0003ca00: 2020 2020 2045 7874 7261 206f 7074 696f       Extra optio
-0003ca10: 6e73 2074 6f20 7061 7373 2074 6f20 776f  ns to pass to wo
-0003ca20: 726b 6572 735f 746f 5f63 6c6f 7365 2074  rkers_to_close t
-0003ca30: 6f20 6465 7465 726d 696e 6520 7768 6963  o determine whic
-0003ca40: 680a 2020 2020 2020 2020 2020 2020 776f  h.            wo
-0003ca50: 726b 6572 7320 7765 2073 686f 756c 6420  rkers we should 
-0003ca60: 6472 6f70 0a0a 2020 2020 2020 2020 5265  drop..        Re
-0003ca70: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-0003ca80: 2d2d 2d2d 2d0a 2020 2020 2020 2020 4469  -----.        Di
-0003ca90: 6374 696f 6e61 7279 206d 6170 7069 6e67  ctionary mapping
-0003caa0: 2077 6f72 6b65 7220 4944 2f61 6464 7265   worker ID/addre
-0003cab0: 7373 2074 6f20 6469 6374 696f 6e61 7279  ss to dictionary
-0003cac0: 206f 6620 696e 666f 726d 6174 696f 6e20   of information 
-0003cad0: 6162 6f75 740a 2020 2020 2020 2020 7468  about.        th
-0003cae0: 6174 2077 6f72 6b65 7220 666f 7220 6561  at worker for ea
-0003caf0: 6368 2072 6574 6972 6564 2077 6f72 6b65  ch retired worke
-0003cb00: 722e 0a0a 2020 2020 2020 2020 4966 2074  r...        If t
-0003cb10: 6865 7265 2061 7265 206b 6579 7320 7468  here are keys th
-0003cb20: 6174 2065 7869 7374 2069 6e20 6d65 6d6f  at exist in memo
-0003cb30: 7279 206f 6e6c 7920 6f6e 2074 6865 2077  ry only on the w
-0003cb40: 6f72 6b65 7273 2062 6569 6e67 2072 6574  orkers being ret
-0003cb50: 6972 6564 2061 6e64 2069 740a 2020 2020  ired and it.    
-0003cb60: 2020 2020 7761 7320 696d 706f 7373 6962      was impossib
-0003cb70: 6c65 2074 6f20 7265 706c 6963 6174 6520  le to replicate 
-0003cb80: 7468 656d 2073 6f6d 6577 6865 7265 2065  them somewhere e
-0003cb90: 6c73 6520 2865 2e67 2e20 6265 6361 7573  lse (e.g. becaus
-0003cba0: 6520 7468 6572 6520 6172 656e 2774 0a20  e there aren't. 
-0003cbb0: 2020 2020 2020 2061 6e79 206f 7468 6572         any other
-0003cbc0: 2072 756e 6e69 6e67 2077 6f72 6b65 7273   running workers
-0003cbd0: 292c 2074 6865 2077 6f72 6b65 7273 2068  ), the workers h
-0003cbe0: 6f6c 6469 6e67 2073 7563 6820 6b65 7973  olding such keys
-0003cbf0: 2077 6f6e 2774 2062 6520 7265 7469 7265   won't be retire
-0003cc00: 6420 616e 640a 2020 2020 2020 2020 776f  d and.        wo
-0003cc10: 6e27 7420 6170 7065 6172 2069 6e20 7468  n't appear in th
-0003cc20: 6520 7265 7475 726e 6564 2064 6963 742e  e returned dict.
-0003cc30: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-0003cc40: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-0003cc50: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
-0003cc60: 6475 6c65 722e 776f 726b 6572 735f 746f  duler.workers_to
-0003cc70: 5f63 6c6f 7365 0a20 2020 2020 2020 2022  _close.        "
-0003cc80: 2222 0a20 2020 2020 2020 2073 7469 6d75  "".        stimu
-0003cc90: 6c75 735f 6964 203d 2073 7469 6d75 6c75  lus_id = stimulu
-0003cca0: 735f 6964 206f 7220 6622 7265 7469 7265  s_id or f"retire
-0003ccb0: 2d77 6f72 6b65 7273 2d7b 7469 6d65 2829  -workers-{time()
-0003ccc0: 7d22 0a20 2020 2020 2020 2023 2054 6869  }".        # Thi
-0003ccd0: 7320 6c6f 636b 206d 616b 6573 2072 6574  s lock makes ret
-0003cce0: 6972 655f 776f 726b 6572 732c 2072 6562  ire_workers, reb
-0003ccf0: 616c 616e 6365 2c20 616e 6420 7265 706c  alance, and repl
-0003cd00: 6963 6174 6520 6d75 7475 616c 6c79 0a20  icate mutually. 
-0003cd10: 2020 2020 2020 2023 2065 7863 6c75 7369         # exclusi
-0003cd20: 7665 2061 6e64 2077 696c 6c20 6e6f 206c  ve and will no l
-0003cd30: 6f6e 6765 7220 6265 206e 6563 6573 7361  onger be necessa
-0003cd40: 7279 206f 6e63 6520 7265 6261 6c61 6e63  ry once rebalanc
-0003cd50: 6520 616e 6420 7265 706c 6963 6174 6520  e and replicate 
-0003cd60: 6172 650a 2020 2020 2020 2020 2320 6d69  are.        # mi
-0003cd70: 6772 6174 6564 2074 6f20 7468 6520 4163  grated to the Ac
-0003cd80: 7469 7665 204d 656d 6f72 7920 4d61 6e61  tive Memory Mana
-0003cd90: 6765 722e 0a20 2020 2020 2020 2023 204e  ger..        # N
-0003cda0: 6f74 6520 7468 6174 2c20 696e 6369 6465  ote that, incide
-0003cdb0: 6e74 616c 6c79 2c20 6974 2061 6c73 6f20  ntally, it also 
-0003cdc0: 7072 6576 656e 7473 206d 756c 7469 706c  prevents multipl
-0003cdd0: 6520 6361 6c6c 7320 746f 2072 6574 6972  e calls to retir
-0003cde0: 655f 776f 726b 6572 730a 2020 2020 2020  e_workers.      
-0003cdf0: 2020 2320 6672 6f6d 2072 756e 6e69 6e67    # from running
-0003ce00: 2069 6e20 7061 7261 6c6c 656c 202d 2074   in parallel - t
-0003ce10: 6869 7320 6973 2075 6e6e 6563 6573 7361  his is unnecessa
-0003ce20: 7279 2e0a 2020 2020 2020 2020 6173 796e  ry..        asyn
-0003ce30: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
-0003ce40: 6b3a 0a20 2020 2020 2020 2020 2020 2069  k:.            i
-0003ce50: 6620 6e61 6d65 7320 6973 206e 6f74 204e  f names is not N
-0003ce60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003ce70: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-0003ce80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0003ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cea0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-0003ceb0: 2822 6e61 6d65 7320 616e 6420 776f 726b  ("names and work
-0003cec0: 6572 7320 6172 6520 6d75 7475 616c 6c79  ers are mutually
-0003ced0: 2065 7863 6c75 7369 7665 2229 0a20 2020   exclusive").   
-0003cee0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003cef0: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-0003cf00: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0003cf10: 722e 696e 666f 2822 5265 7469 7265 2077  r.info("Retire w
-0003cf20: 6f72 6b65 7220 6e61 6d65 7320 2573 222c  orker names %s",
-0003cf30: 206e 616d 6573 290a 2020 2020 2020 2020   names).        
-0003cf40: 2020 2020 2020 2020 2320 5375 7070 6f72          # Suppor
-0003cf50: 7420 6361 7365 7320 7768 6572 6520 6e61  t cases where na
-0003cf60: 6d65 7320 6172 6520 7061 7373 6564 2074  mes are passed t
-0003cf70: 6872 6f75 6768 2061 2043 4c49 2061 6e64  hrough a CLI and
-0003cf80: 2062 6563 6f6d 650a 2020 2020 2020 2020   become.        
-0003cf90: 2020 2020 2020 2020 2320 7374 7269 6e67          # string
-0003cfa0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003cfb0: 2020 6e61 6d65 735f 7365 7420 3d20 7b73    names_set = {s
-0003cfc0: 7472 286e 616d 6529 2066 6f72 206e 616d  tr(name) for nam
-0003cfd0: 6520 696e 206e 616d 6573 7d0a 2020 2020  e in names}.    
-0003cfe0: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
-0003cff0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
-0003d000: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-0003d010: 7565 7328 2920 6966 2073 7472 2877 732e  ues() if str(ws.
-0003d020: 6e61 6d65 2920 696e 206e 616d 6573 5f73  name) in names_s
-0003d030: 6574 7d0a 2020 2020 2020 2020 2020 2020  et}.            
-0003d040: 656c 6966 2077 6f72 6b65 7273 2069 7320  elif workers is 
-0003d050: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0003d060: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
-0003d070: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003d080: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0003d090: 7273 5b61 6464 7265 7373 5d0a 2020 2020  rs[address].    
-0003d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d0b0: 666f 7220 6164 6472 6573 7320 696e 2077  for address in w
-0003d0c0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-0003d0d0: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
-0003d0e0: 6472 6573 7320 696e 2073 656c 662e 776f  dress in self.wo
-0003d0f0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-0003d100: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003d110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003d120: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
-0003d130: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003d140: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0003d150: 7273 5b61 6464 7265 7373 5d20 666f 7220  rs[address] for 
-0003d160: 6164 6472 6573 7320 696e 2073 656c 662e  address in self.
-0003d170: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
-0003d180: 282a 2a6b 7761 7267 7329 0a20 2020 2020  (**kwargs).     
-0003d190: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003d1a0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0003d1b0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
-0003d1c0: 2020 2020 2072 6574 7572 6e20 7b7d 0a0a       return {}..
-0003d1d0: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
-0003d1e0: 5f61 6d6d 203d 2046 616c 7365 0a20 2020  _amm = False.   
-0003d1f0: 2020 2020 2020 2020 2061 6d6d 3a20 4163           amm: Ac
-0003d200: 7469 7665 4d65 6d6f 7279 4d61 6e61 6765  tiveMemoryManage
-0003d210: 7245 7874 656e 7369 6f6e 203d 2073 656c  rExtension = sel
-0003d220: 662e 6578 7465 6e73 696f 6e73 5b22 616d  f.extensions["am
-0003d230: 6d22 5d0a 2020 2020 2020 2020 2020 2020  m"].            
-0003d240: 6966 206e 6f74 2061 6d6d 2e72 756e 6e69  if not amm.runni
-0003d250: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-0003d260: 2020 2020 616d 6d20 3d20 4163 7469 7665      amm = Active
-0003d270: 4d65 6d6f 7279 4d61 6e61 6765 7245 7874  MemoryManagerExt
-0003d280: 656e 7369 6f6e 280a 2020 2020 2020 2020  ension(.        
-0003d290: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003d2a0: 2c20 706f 6c69 6369 6573 3d73 6574 2829  , policies=set()
-0003d2b0: 2c20 7265 6769 7374 6572 3d46 616c 7365  , register=False
-0003d2c0: 2c20 7374 6172 743d 5472 7565 2c20 696e  , start=True, in
-0003d2d0: 7465 7276 616c 3d32 2e30 0a20 2020 2020  terval=2.0.     
-0003d2e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0003d2f0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0003d300: 705f 616d 6d20 3d20 5472 7565 0a0a 2020  p_amm = True..  
-0003d310: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0003d320: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003d330: 6f72 6f73 203d 205b 5d0a 2020 2020 2020  oros = [].      
-0003d340: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
-0003d350: 2069 6e20 7773 733a 0a20 2020 2020 2020   in wss:.       
-0003d360: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0003d370: 6765 722e 696e 666f 2822 5265 7469 7269  ger.info("Retiri
-0003d380: 6e67 2077 6f72 6b65 7220 2573 222c 2077  ng worker %s", w
-0003d390: 732e 6164 6472 6573 7329 0a0a 2020 2020  s.address)..    
-0003d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d3b0: 706f 6c69 6379 203d 2052 6574 6972 6557  policy = RetireW
-0003d3c0: 6f72 6b65 7228 7773 2e61 6464 7265 7373  orker(ws.address
-0003d3d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003d3e0: 2020 2020 2020 616d 6d2e 6164 645f 706f        amm.add_po
-0003d3f0: 6c69 6379 2870 6f6c 6963 7929 0a0a 2020  licy(policy)..  
-0003d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d410: 2020 2320 4368 616e 6765 2057 6f72 6b65    # Change Worke
-0003d420: 722e 7374 6174 7573 2074 6f20 636c 6f73  r.status to clos
-0003d430: 696e 675f 6772 6163 6566 756c 6c79 2e20  ing_gracefully. 
-0003d440: 496d 6d65 6469 6174 656c 7920 7365 740a  Immediately set.
-0003d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d460: 2020 2020 2320 7468 6520 7361 6d65 206f      # the same o
-0003d470: 6e20 7468 6520 7363 6865 6475 6c65 7220  n the scheduler 
-0003d480: 746f 2070 7265 7665 6e74 2072 6163 6520  to prevent race 
-0003d490: 636f 6e64 6974 696f 6e73 2e0a 2020 2020  conditions..    
-0003d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4b0: 7072 6576 5f73 7461 7475 7320 3d20 7773  prev_status = ws
-0003d4c0: 2e73 7461 7475 730a 2020 2020 2020 2020  .status.        
-0003d4d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003d4e0: 2e68 616e 646c 655f 776f 726b 6572 5f73  .handle_worker_s
-0003d4f0: 7461 7475 735f 6368 616e 6765 280a 2020  tatus_change(.  
-0003d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d510: 2020 2020 2020 5374 6174 7573 2e63 6c6f        Status.clo
-0003d520: 7369 6e67 5f67 7261 6365 6675 6c6c 792c  sing_gracefully,
-0003d530: 2077 732c 2073 7469 6d75 6c75 735f 6964   ws, stimulus_id
-0003d540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d550: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0003d560: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
-0003d570: 4d45 3a20 5765 2073 686f 756c 6420 7365  ME: We should se
-0003d580: 6e64 2061 206d 6573 7361 6765 2074 6f20  nd a message to 
-0003d590: 7468 6520 6e61 6e6e 7920 6669 7273 743b  the nanny first;
-0003d5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d5b0: 2020 2020 2023 2065 7665 6e74 7561 6c6c       # eventuall
-0003d5c0: 7920 776f 726b 6572 7320 776f 6e27 7420  y workers won't 
-0003d5d0: 6265 2061 626c 6520 746f 2063 6c6f 7365  be able to close
-0003d5e0: 2074 6865 6972 206f 776e 206e 616e 6e69   their own nanni
-0003d5f0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
-0003d600: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-0003d610: 6561 6d5f 636f 6d6d 735b 7773 2e61 6464  eam_comms[ws.add
-0003d620: 7265 7373 5d2e 7365 6e64 280a 2020 2020  ress].send(.    
-0003d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d640: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0003d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d660: 2020 226f 7022 3a20 2277 6f72 6b65 722d    "op": "worker-
-0003d670: 7374 6174 7573 2d63 6861 6e67 6522 2c0a  status-change",.
-0003d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d690: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0003d6a0: 7475 7322 3a20 7773 2e73 7461 7475 732e  tus": ws.status.
-0003d6b0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0003d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d6d0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-0003d6e0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d700: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003d710: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0003d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d730: 2020 2063 6f72 6f73 2e61 7070 656e 6428     coros.append(
-0003d740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d750: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
-0003d760: 7261 636b 5f72 6574 6972 655f 776f 726b  rack_retire_work
-0003d770: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-0003d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d790: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
-0003d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7b0: 706f 6c69 6379 2c0a 2020 2020 2020 2020  policy,.        
-0003d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7d0: 2020 2020 7072 6576 5f73 7461 7475 733d      prev_status=
-0003d7e0: 7072 6576 5f73 7461 7475 732c 0a20 2020  prev_status,.   
-0003d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d800: 2020 2020 2020 2020 2063 6c6f 7365 3d63           close=c
-0003d810: 6c6f 7365 5f77 6f72 6b65 7273 2c0a 2020  lose_workers,.  
-0003d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d830: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
-0003d840: 3d72 656d 6f76 652c 0a20 2020 2020 2020  =remove,.       
-0003d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d860: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-0003d870: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
-0003d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d890: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003d8a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0003d8b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003d8c0: 2047 6976 6520 7468 6520 414d 4d20 6120   Give the AMM a 
-0003d8d0: 6b69 636b 2c20 696e 2061 6464 6974 696f  kick, in additio
-0003d8e0: 6e20 746f 2069 7473 2070 6572 696f 6469  n to its periodi
-0003d8f0: 6320 7275 6e6e 696e 672e 2054 6869 7320  c running. This 
-0003d900: 6973 0a20 2020 2020 2020 2020 2020 2020  is.             
-0003d910: 2020 2023 2074 6f20 6176 6f69 6420 756e     # to avoid un
-0003d920: 6e65 6365 7373 6172 696c 7920 7761 6974  necessarily wait
-0003d930: 696e 6720 666f 7220 6120 706f 7465 6e74  ing for a potent
-0003d940: 6961 6c6c 7920 6172 6269 7472 6172 696c  ially arbitraril
-0003d950: 7920 6c6f 6e67 0a20 2020 2020 2020 2020  y long.         
-0003d960: 2020 2020 2020 2023 2074 696d 6520 2864         # time (d
-0003d970: 6570 656e 6469 6e67 206f 6e20 696e 7465  epending on inte
-0003d980: 7276 616c 2073 6574 7469 6e67 7329 0a20  rval settings). 
-0003d990: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0003d9a0: 6d6d 2e72 756e 5f6f 6e63 6528 290a 0a20  mm.run_once().. 
-0003d9b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0003d9c0: 6f72 6b65 7273 5f69 6e66 6f20 3d20 6469  orkers_info = di
-0003d9d0: 6374 2861 7761 6974 2061 7379 6e63 696f  ct(await asyncio
-0003d9e0: 2e67 6174 6865 7228 2a63 6f72 6f73 2929  .gather(*coros))
-0003d9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003da00: 2077 6f72 6b65 7273 5f69 6e66 6f2e 706f   workers_info.po
-0003da10: 7028 4e6f 6e65 2c20 4e6f 6e65 290a 2020  p(None, None).  
-0003da20: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
-0003da30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0003da40: 2020 2069 6620 7374 6f70 5f61 6d6d 3a0a     if stop_amm:.
-0003da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003da60: 2020 2020 616d 6d2e 7374 6f70 2829 0a0a      amm.stop()..
-0003da70: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0003da80: 5f65 7665 6e74 2822 616c 6c22 2c20 7b22  _event("all", {"
-0003da90: 6163 7469 6f6e 223a 2022 7265 7469 7265  action": "retire
-0003daa0: 2d77 6f72 6b65 7273 222c 2022 776f 726b  -workers", "work
-0003dab0: 6572 7322 3a20 776f 726b 6572 735f 696e  ers": workers_in
-0003dac0: 666f 7d29 0a20 2020 2020 2020 2073 656c  fo}).        sel
-0003dad0: 662e 6c6f 675f 6576 656e 7428 6c69 7374  f.log_event(list
-0003dae0: 2877 6f72 6b65 7273 5f69 6e66 6f29 2c20  (workers_info), 
-0003daf0: 7b22 6163 7469 6f6e 223a 2022 7265 7469  {"action": "reti
-0003db00: 7265 6422 7d29 0a0a 2020 2020 2020 2020  red"})..        
-0003db10: 7265 7475 726e 2077 6f72 6b65 7273 5f69  return workers_i
-0003db20: 6e66 6f0a 0a20 2020 2061 7379 6e63 2064  nfo..    async d
-0003db30: 6566 205f 7472 6163 6b5f 7265 7469 7265  ef _track_retire
-0003db40: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-0003db50: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
-0003db60: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
-0003db70: 2020 2020 2020 2020 706f 6c69 6379 3a20          policy: 
-0003db80: 5265 7469 7265 576f 726b 6572 2c0a 2020  RetireWorker,.  
-0003db90: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
-0003dba0: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
-0003dbb0: 2020 2063 6c6f 7365 3a20 626f 6f6c 2c0a     close: bool,.
-0003dbc0: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
-0003dbd0: 626f 6f6c 2c0a 2020 2020 2020 2020 7374  bool,.        st
-0003dbe0: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
-0003dbf0: 2020 2020 2920 2d3e 2074 7570 6c65 3a20      ) -> tuple: 
-0003dc00: 2023 2074 7570 6c65 5b73 7472 207c 204e   # tuple[str | N
-0003dc10: 6f6e 652c 2064 6963 745d 0a20 2020 2020  one, dict].     
-0003dc20: 2020 2077 6869 6c65 206e 6f74 2070 6f6c     while not pol
-0003dc30: 6963 792e 646f 6e65 2829 3a0a 2020 2020  icy.done():.    
-0003dc40: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
-0003dc50: 302e 3031 7320 7768 656e 2074 6865 7265  0.01s when there
-0003dc60: 2061 7265 2034 2074 6173 6b73 206f 7220   are 4 tasks or 
-0003dc70: 6c65 7373 0a20 2020 2020 2020 2020 2020  less.           
-0003dc80: 2023 2053 6c65 6570 2030 2e35 7320 7768   # Sleep 0.5s wh
-0003dc90: 656e 2074 6865 7265 2061 7265 2032 3030  en there are 200
-0003dca0: 206f 7220 6d6f 7265 0a20 2020 2020 2020   or more.       
-0003dcb0: 2020 2020 2070 6f6c 6c5f 696e 7465 7276       poll_interv
-0003dcc0: 616c 203d 206d 6178 2830 2e30 312c 206d  al = max(0.01, m
-0003dcd0: 696e 2830 2e35 2c20 6c65 6e28 7773 2e68  in(0.5, len(ws.h
-0003dce0: 6173 5f77 6861 7429 202f 2034 3030 2929  as_what) / 400))
-0003dcf0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-0003dd00: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
-0003dd10: 2870 6f6c 6c5f 696e 7465 7276 616c 290a  (poll_interval).
-0003dd20: 0a20 2020 2020 2020 2069 6620 706f 6c69  .        if poli
-0003dd30: 6379 2e6e 6f5f 7265 6369 7069 656e 7473  cy.no_recipients
-0003dd40: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0003dd50: 4162 6f72 7420 7265 7469 7265 6d65 6e74  Abort retirement
-0003dd60: 2e20 5468 6973 2074 696d 6520 7765 2064  . This time we d
-0003dd70: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
-0003dd80: 7279 2061 626f 7574 2072 6163 650a 2020  ry about race.  
-0003dd90: 2020 2020 2020 2020 2020 2320 636f 6e64            # cond
-0003dda0: 6974 696f 6e73 2061 6e64 2077 6520 6361  itions and we ca
-0003ddb0: 6e20 7761 6974 2066 6f72 2061 2073 6368  n wait for a sch
-0003ddc0: 6564 756c 6572 2d3e 776f 726b 6572 2d3e  eduler->worker->
-0003ddd0: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-0003dde0: 2020 2020 2020 2320 726f 756e 642d 7472        # round-tr
-0003ddf0: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
-0003de00: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-0003de10: 735b 7773 2e61 6464 7265 7373 5d2e 7365  s[ws.address].se
-0003de20: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-0003de30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0003de40: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-0003de50: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-0003de60: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
-0003de70: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-0003de80: 7475 7322 3a20 7072 6576 5f73 7461 7475  tus": prev_statu
-0003de90: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
-0003dea0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0003deb0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-0003dec0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-0003ded0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0003dee0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003def0: 2020 2020 7265 7475 726e 204e 6f6e 652c      return None,
-0003df00: 207b 7d0a 0a20 2020 2020 2020 206c 6f67   {}..        log
-0003df10: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-0003df20: 2020 2020 2020 2022 416c 6c20 756e 6971         "All uniq
-0003df30: 7565 206b 6579 7320 6f6e 2077 6f72 6b65  ue keys on worke
-0003df40: 7220 2573 2068 6176 6520 6265 656e 2072  r %s have been r
-0003df50: 6570 6c69 6361 7465 6420 656c 7365 7768  eplicated elsewh
-0003df60: 6572 6522 2c20 7773 2e61 6464 7265 7373  ere", ws.address
-0003df70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0003df80: 2020 2020 6966 2072 656d 6f76 653a 0a20      if remove:. 
-0003df90: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0003dfa0: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-0003dfb0: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-0003dfc0: 2020 2020 2077 732e 6164 6472 6573 732c       ws.address,
-0003dfd0: 2073 6166 653d 5472 7565 2c20 636c 6f73   safe=True, clos
-0003dfe0: 653d 636c 6f73 652c 2073 7469 6d75 6c75  e=close, stimulu
-0003dff0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-0003e000: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0003e010: 2020 2020 2020 2065 6c69 6620 636c 6f73         elif clos
-0003e020: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0003e030: 656c 662e 636c 6f73 655f 776f 726b 6572  elf.close_worker
-0003e040: 2877 732e 6164 6472 6573 7329 0a0a 2020  (ws.address)..  
-0003e050: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-0003e060: 6f28 2252 6574 6972 6564 2077 6f72 6b65  o("Retired worke
-0003e070: 7220 2573 222c 2077 732e 6164 6472 6573  r %s", ws.addres
-0003e080: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-0003e090: 6e20 7773 2e61 6464 7265 7373 2c20 7773  n ws.address, ws
-0003e0a0: 2e69 6465 6e74 6974 7928 290a 0a20 2020  .identity()..   
-0003e0b0: 2064 6566 2061 6464 5f6b 6579 7328 0a20   def add_keys(. 
-0003e0c0: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
-0003e0d0: 6b65 723a 2073 7472 2c20 6b65 7973 3a20  ker: str, keys: 
-0003e0e0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
-0003e0f0: 3d20 2829 2c20 7374 696d 756c 7573 5f69  = (), stimulus_i
-0003e100: 643a 2073 7472 207c 204e 6f6e 6520 3d20  d: str | None = 
-0003e110: 4e6f 6e65 0a20 2020 2029 202d 3e20 4c69  None.    ) -> Li
-0003e120: 7465 7261 6c5b 224f 4b22 2c20 226e 6f74  teral["OK", "not
-0003e130: 2066 6f75 6e64 225d 3a0a 2020 2020 2020   found"]:.      
-0003e140: 2020 2222 220a 2020 2020 2020 2020 4c65    """.        Le
-0003e150: 6172 6e20 7468 6174 2061 2077 6f72 6b65  arn that a worke
-0003e160: 7220 6861 7320 6365 7274 6169 6e20 6b65  r has certain ke
-0003e170: 7973 0a0a 2020 2020 2020 2020 5468 6973  ys..        This
-0003e180: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
-0003e190: 7365 6420 696e 2070 7261 6374 6963 6520  sed in practice 
-0003e1a0: 616e 6420 6973 206d 6f73 746c 7920 6865  and is mostly he
-0003e1b0: 7265 2066 6f72 206c 6567 6163 790a 2020  re for legacy.  
-0003e1c0: 2020 2020 2020 7265 6173 6f6e 732e 2020        reasons.  
-0003e1d0: 486f 7765 7665 722c 2069 7420 6973 2073  However, it is s
-0003e1e0: 656e 7420 6279 2077 6f72 6b65 7273 2066  ent by workers f
-0003e1f0: 726f 6d20 7469 6d65 2074 6f20 7469 6d65  rom time to time
-0003e200: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0003e210: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
-0003e220: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
-0003e230: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0003e240: 2072 6574 7572 6e20 226e 6f74 2066 6f75   return "not fou
-0003e250: 6e64 220a 2020 2020 2020 2020 7773 3a20  nd".        ws: 
-0003e260: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
-0003e270: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
-0003e280: 725d 0a20 2020 2020 2020 2072 6564 756e  r].        redun
-0003e290: 6461 6e74 5f72 6570 6c69 6361 7320 3d20  dant_replicas = 
-0003e2a0: 5b5d 0a20 2020 2020 2020 2066 6f72 206b  [].        for k
-0003e2b0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-0003e2c0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0003e2d0: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0003e2e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003e2f0: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
-0003e300: 6e64 2074 732e 7374 6174 6520 3d3d 2022  nd ts.state == "
-0003e310: 6d65 6d6f 7279 223a 0a20 2020 2020 2020  memory":.       
-0003e320: 2020 2020 2020 2020 2069 6620 7773 206e           if ws n
-0003e330: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
-0003e340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e350: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
-0003e360: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
-0003e370: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0003e380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e390: 2072 6564 756e 6461 6e74 5f72 6570 6c69   redundant_repli
-0003e3a0: 6361 732e 6170 7065 6e64 286b 6579 290a  cas.append(key).
-0003e3b0: 0a20 2020 2020 2020 2069 6620 7265 6475  .        if redu
-0003e3c0: 6e64 616e 745f 7265 706c 6963 6173 3a0a  ndant_replicas:.
-0003e3d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0003e3e0: 6f74 2073 7469 6d75 6c75 735f 6964 3a0a  ot stimulus_id:.
-0003e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e400: 7374 696d 756c 7573 5f69 6420 3d20 6622  stimulus_id = f"
-0003e410: 7265 6475 6e64 616e 742d 7265 706c 6963  redundant-replic
-0003e420: 6173 2d7b 7469 6d65 2829 7d22 0a20 2020  as-{time()}".   
-0003e430: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-0003e440: 726b 6572 5f73 656e 6428 0a20 2020 2020  rker_send(.     
-0003e450: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0003e460: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0003e470: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0003e480: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-0003e490: 7265 6d6f 7665 2d72 6570 6c69 6361 7322  remove-replicas"
-0003e4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e4b0: 2020 2020 2020 226b 6579 7322 3a20 7265        "keys": re
-0003e4c0: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
-0003e4d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e4e0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-0003e4f0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-0003e500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e510: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
-0003e520: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-0003e530: 726e 2022 4f4b 220a 0a20 2020 2040 6c6f  rn "OK"..    @lo
-0003e540: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0003e550: 2075 7064 6174 655f 6461 7461 280a 2020   update_data(.  
-0003e560: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0003e570: 2020 2020 2a2c 0a20 2020 2020 2020 2077      *,.        w
-0003e580: 686f 5f68 6173 3a20 6469 6374 5b73 7472  ho_has: dict[str
-0003e590: 2c20 6c69 7374 5b73 7472 5d5d 2c0a 2020  , list[str]],.  
-0003e5a0: 2020 2020 2020 6e62 7974 6573 3a20 6469        nbytes: di
-0003e5b0: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
-0003e5c0: 2020 2020 2020 636c 6965 6e74 3a20 7374        client: st
-0003e5d0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-0003e5e0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-0003e5f0: 2020 2020 2020 2020 2222 224c 6561 726e          """Learn
-0003e600: 2074 6861 7420 6e65 7720 6461 7461 2068   that new data h
-0003e610: 6173 2065 6e74 6572 6564 2074 6865 206e  as entered the n
-0003e620: 6574 776f 726b 2066 726f 6d20 616e 2065  etwork from an e
-0003e630: 7874 6572 6e61 6c20 736f 7572 6365 2222  xternal source""
-0003e640: 220a 2020 2020 2020 2020 7768 6f5f 6861  ".        who_ha
-0003e650: 7320 3d20 7b6b 3a20 5b73 656c 662e 636f  s = {k: [self.co
-0003e660: 6572 6365 5f61 6464 7265 7373 2876 7629  erce_address(vv)
-0003e670: 2066 6f72 2076 7620 696e 2076 5d20 666f   for vv in v] fo
-0003e680: 7220 6b2c 2076 2069 6e20 7768 6f5f 6861  r k, v in who_ha
-0003e690: 732e 6974 656d 7328 297d 0a20 2020 2020  s.items()}.     
-0003e6a0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0003e6b0: 2255 7064 6174 6520 6461 7461 2025 7322  "Update data %s"
-0003e6c0: 2c20 7768 6f5f 6861 7329 0a0a 2020 2020  , who_has)..    
-0003e6d0: 2020 2020 666f 7220 6b65 792c 2077 6f72      for key, wor
-0003e6e0: 6b65 7273 2069 6e20 7768 6f5f 6861 732e  kers in who_has.
-0003e6f0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0003e700: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-0003e710: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-0003e720: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-0003e730: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003e740: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0003e750: 6c66 2e6e 6577 5f74 6173 6b28 6b65 792c  lf.new_task(key,
-0003e760: 204e 6f6e 652c 2022 6d65 6d6f 7279 2229   None, "memory")
-0003e770: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-0003e780: 7374 6174 6520 3d20 226d 656d 6f72 7922  state = "memory"
-0003e790: 0a20 2020 2020 2020 2020 2020 2074 735f  .            ts_
-0003e7a0: 6e62 7974 6573 203d 206e 6279 7465 732e  nbytes = nbytes.
-0003e7b0: 6765 7428 6b65 792c 202d 3129 0a20 2020  get(key, -1).   
-0003e7c0: 2020 2020 2020 2020 2069 6620 7473 5f6e           if ts_n
-0003e7d0: 6279 7465 7320 3e3d 2030 3a0a 2020 2020  bytes >= 0:.    
-0003e7e0: 2020 2020 2020 2020 2020 2020 7473 2e73              ts.s
-0003e7f0: 6574 5f6e 6279 7465 7328 7473 5f6e 6279  et_nbytes(ts_nby
-0003e800: 7465 7329 0a0a 2020 2020 2020 2020 2020  tes)..          
-0003e810: 2020 666f 7220 7720 696e 2077 6f72 6b65    for w in worke
-0003e820: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0003e830: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
-0003e840: 726b 6572 735b 775d 0a20 2020 2020 2020  rkers[w].       
-0003e850: 2020 2020 2020 2020 2069 6620 7773 206e           if ws n
-0003e860: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
-0003e870: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e880: 2020 2020 2020 7365 6c66 2e61 6464 5f72        self.add_r
-0003e890: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
-0003e8a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003e8b0: 7265 706f 7274 287b 226f 7022 3a20 226b  report({"op": "k
-0003e8c0: 6579 2d69 6e2d 6d65 6d6f 7279 222c 2022  ey-in-memory", "
-0003e8d0: 6b65 7922 3a20 6b65 792c 2022 776f 726b  key": key, "work
-0003e8e0: 6572 7322 3a20 6c69 7374 2877 6f72 6b65  ers": list(worke
-0003e8f0: 7273 297d 290a 0a20 2020 2020 2020 2069  rs)})..        i
-0003e900: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
-0003e910: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0003e920: 745f 6465 7369 7265 735f 6b65 7973 286b  t_desires_keys(k
-0003e930: 6579 733d 6c69 7374 2877 686f 5f68 6173  eys=list(who_has
-0003e940: 292c 2063 6c69 656e 743d 636c 6965 6e74  ), client=client
-0003e950: 290a 0a20 2020 2040 6f76 6572 6c6f 6164  )..    @overload
-0003e960: 0a20 2020 2064 6566 2072 6570 6f72 745f  .    def report_
-0003e970: 6f6e 5f6b 6579 2873 656c 662c 206b 6579  on_key(self, key
-0003e980: 3a20 7374 722c 202a 2c20 636c 6965 6e74  : str, *, client
-0003e990: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-0003e9a0: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
-0003e9b0: 2020 2020 2020 2e2e 2e0a 0a20 2020 2040        .....    @
-0003e9c0: 6f76 6572 6c6f 6164 0a20 2020 2064 6566  overload.    def
-0003e9d0: 2072 6570 6f72 745f 6f6e 5f6b 6579 2873   report_on_key(s
-0003e9e0: 656c 662c 202a 2c20 7473 3a20 5461 736b  elf, *, ts: Task
-0003e9f0: 5374 6174 652c 2063 6c69 656e 743a 2073  State, client: s
-0003ea00: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0003ea10: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0003ea20: 2020 202e 2e2e 0a0a 2020 2020 6465 6620     .....    def 
-0003ea30: 7265 706f 7274 5f6f 6e5f 6b65 7928 7365  report_on_key(se
-0003ea40: 6c66 2c20 6b65 793d 4e6f 6e65 2c20 2a2c  lf, key=None, *,
-0003ea50: 2074 733d 4e6f 6e65 2c20 636c 6965 6e74   ts=None, client
-0003ea60: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-0003ea70: 6966 2028 7473 2069 7320 4e6f 6e65 2920  if (ts is None) 
-0003ea80: 3d3d 2028 6b65 7920 6973 204e 6f6e 6529  == (key is None)
-0003ea90: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0003eaa0: 6973 6520 5661 6c75 6545 7272 6f72 2820  ise ValueError( 
-0003eab0: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-0003eac0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-0003ead0: 2020 2066 2274 7320 616e 6420 6b65 7920     f"ts and key 
-0003eae0: 6172 6520 6d75 7475 616c 6c79 2065 7863  are mutually exc
-0003eaf0: 6c75 7369 7665 3b20 7265 6365 6976 6564  lusive; received
-0003eb00: 207b 6b65 793d 2172 7d2c 207b 7473 3d21   {key=!r}, {ts=!
-0003eb10: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
-0003eb20: 290a 2020 2020 2020 2020 6966 2074 7320  ).        if ts 
-0003eb30: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0003eb40: 2020 2020 2061 7373 6572 7420 6b65 7920       assert key 
-0003eb50: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-0003eb60: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0003eb70: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0003eb80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0003eb90: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-0003eba0: 2074 732e 6b65 790a 0a20 2020 2020 2020   ts.key..       
-0003ebb0: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
-0003ebc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003ebd0: 7265 706f 7274 5f6d 7367 203d 205f 7461  report_msg = _ta
-0003ebe0: 736b 5f74 6f5f 7265 706f 7274 5f6d 7367  sk_to_report_msg
-0003ebf0: 2874 7329 0a20 2020 2020 2020 2065 6c73  (ts).        els
-0003ec00: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0003ec10: 6570 6f72 745f 6d73 6720 3d20 7b22 6f70  eport_msg = {"op
-0003ec20: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
-0003ec30: 7973 222c 2022 6b65 7973 223a 205b 6b65  ys", "keys": [ke
-0003ec40: 795d 7d0a 2020 2020 2020 2020 6966 2072  y]}.        if r
-0003ec50: 6570 6f72 745f 6d73 6720 6973 206e 6f74  eport_msg is not
-0003ec60: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003ec70: 2020 2073 656c 662e 7265 706f 7274 2872     self.report(r
-0003ec80: 6570 6f72 745f 6d73 672c 2074 733d 7473  eport_msg, ts=ts
-0003ec90: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
-0003eca0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-0003ecb0: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
-0003ecc0: 6665 6564 280a 2020 2020 2020 2020 7365  feed(.        se
-0003ecd0: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-0003ece0: 3a20 436f 6d6d 2c0a 2020 2020 2020 2020  : Comm,.        
-0003ecf0: 6675 6e63 7469 6f6e 3a20 6279 7465 7320  function: bytes 
-0003ed00: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0003ed10: 2020 2020 2020 2073 6574 7570 3a20 6279         setup: by
-0003ed20: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
-0003ed30: 652c 0a20 2020 2020 2020 2074 6561 7264  e,.        teard
-0003ed40: 6f77 6e3a 2062 7974 6573 207c 204e 6f6e  own: bytes | Non
-0003ed50: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0003ed60: 2020 696e 7465 7276 616c 3a20 7374 7220    interval: str 
-0003ed70: 7c20 666c 6f61 7420 3d20 2231 7322 2c0a  | float = "1s",.
-0003ed80: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0003ed90: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
-0003eda0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0003edb0: 220a 2020 2020 2020 2020 5072 6f76 6964  ".        Provid
-0003edc0: 6573 2061 2064 6174 6120 436f 6d6d 2074  es a data Comm t
-0003edd0: 6f20 6578 7465 726e 616c 2072 6571 7565  o external reque
-0003ede0: 7374 6572 0a0a 2020 2020 2020 2020 4361  ster..        Ca
-0003edf0: 7574 696f 6e3a 2074 6869 7320 7275 6e73  ution: this runs
-0003ee00: 2061 7262 6974 7261 7279 2050 7974 686f   arbitrary Pytho
-0003ee10: 6e20 636f 6465 206f 6e20 7468 6520 7363  n code on the sc
-0003ee20: 6865 6475 6c65 722e 2020 5468 6973 2073  heduler.  This s
-0003ee30: 686f 756c 640a 2020 2020 2020 2020 6576  hould.        ev
-0003ee40: 656e 7475 616c 6c79 2062 6520 7068 6173  entually be phas
-0003ee50: 6564 206f 7574 2e20 2049 7420 6973 206d  ed out.  It is m
-0003ee60: 6f73 746c 7920 7573 6564 2062 7920 6469  ostly used by di
-0003ee70: 6167 6e6f 7374 6963 732e 0a20 2020 2020  agnostics..     
-0003ee80: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-0003ee90: 6620 6e6f 7420 6461 736b 2e63 6f6e 6669  f not dask.confi
-0003eea0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0003eeb0: 6564 2e73 6368 6564 756c 6572 2e70 6963  ed.scheduler.pic
-0003eec0: 6b6c 6522 293a 0a20 2020 2020 2020 2020  kle"):.         
-0003eed0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-0003eee0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0003eef0: 2020 2022 5472 6965 6420 746f 2063 616c     "Tried to cal
-0003ef00: 6c20 2766 6565 6427 2072 6f75 7465 2077  l 'feed' route w
-0003ef10: 6974 6820 6375 7374 6f6d 2066 756e 6374  ith custom funct
-0003ef20: 696f 6e73 2c20 6275 7420 220a 2020 2020  ions, but ".    
-0003ef30: 2020 2020 2020 2020 2020 2020 2270 6963              "pic
-0003ef40: 6b6c 6520 6973 2064 6973 616c 6c6f 7765  kle is disallowe
-0003ef50: 642e 2020 5365 7420 7468 6520 2764 6973  d.  Set the 'dis
-0003ef60: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0003ef70: 6572 2e70 6963 6b6c 6527 220a 2020 2020  er.pickle'".    
-0003ef80: 2020 2020 2020 2020 2020 2020 2263 6f6e              "con
-0003ef90: 6669 6720 7661 6c75 6520 746f 2054 7275  fig value to Tru
-0003efa0: 6520 746f 2075 7365 2074 6865 2027 6665  e to use the 'fe
-0003efb0: 6564 2720 726f 7574 6520 2874 6869 7320  ed' route (this 
-0003efc0: 6973 206d 6f73 746c 7920 220a 2020 2020  is mostly ".    
-0003efd0: 2020 2020 2020 2020 2020 2020 2263 6f6d              "com
-0003efe0: 6d6f 6e6c 7920 7573 6564 2077 6974 6820  monly used with 
-0003eff0: 7072 6f67 7265 7373 2062 6172 7329 220a  progress bars)".
-0003f000: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003f010: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003f020: 0a0a 2020 2020 2020 2020 696e 7465 7276  ..        interv
-0003f030: 616c 203d 2070 6172 7365 5f74 696d 6564  al = parse_timed
-0003f040: 656c 7461 2869 6e74 6572 7661 6c29 0a20  elta(interval). 
-0003f050: 2020 2020 2020 2069 6620 6675 6e63 7469         if functi
-0003f060: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0003f070: 6675 6e63 7469 6f6e 203d 2070 6963 6b6c  function = pickl
-0003f080: 652e 6c6f 6164 7328 6675 6e63 7469 6f6e  e.loads(function
-0003f090: 290a 2020 2020 2020 2020 6966 2073 6574  ).        if set
-0003f0a0: 7570 3a0a 2020 2020 2020 2020 2020 2020  up:.            
-0003f0b0: 7365 7475 7020 3d20 7069 636b 6c65 2e6c  setup = pickle.l
-0003f0c0: 6f61 6473 2873 6574 7570 290a 0a20 2020  oads(setup)..   
-0003f0d0: 2020 2020 2069 6620 7465 6172 646f 776e       if teardown
-0003f0e0: 3a0a 2020 2020 2020 2020 2020 2020 7465  :.            te
-0003f0f0: 6172 646f 776e 203d 2070 6963 6b6c 652e  ardown = pickle.
-0003f100: 6c6f 6164 7328 7465 6172 646f 776e 290a  loads(teardown).
-0003f110: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-0003f120: 7365 7475 7028 7365 6c66 2920 6966 2073  setup(self) if s
-0003f130: 6574 7570 2065 6c73 6520 4e6f 6e65 2020  etup else None  
-0003f140: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0003f150: 2020 2020 2020 2069 6620 696e 7370 6563         if inspec
-0003f160: 742e 6973 6177 6169 7461 626c 6528 7374  t.isawaitable(st
-0003f170: 6174 6529 3a0a 2020 2020 2020 2020 2020  ate):.          
-0003f180: 2020 7374 6174 6520 3d20 6177 6169 7420    state = await 
-0003f190: 7374 6174 650a 2020 2020 2020 2020 7472  state.        tr
-0003f1a0: 793a 0a20 2020 2020 2020 2020 2020 2077  y:.            w
-0003f1b0: 6869 6c65 2073 656c 662e 7374 6174 7573  hile self.status
-0003f1c0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-0003f1d0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-0003f1e0: 2020 2020 6966 2073 7461 7465 2069 7320      if state is 
-0003f1f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003f200: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-0003f210: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
-0003f220: 6c66 2920 2023 2074 7970 653a 2069 676e  lf)  # type: ign
-0003f230: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-0003f240: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003f250: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0003f260: 7370 6f6e 7365 203d 2066 756e 6374 696f  sponse = functio
-0003f270: 6e28 7365 6c66 2c20 7374 6174 6529 2020  n(self, state)  
-0003f280: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0003f290: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0003f2a0: 7761 6974 2063 6f6d 6d2e 7772 6974 6528  wait comm.write(
-0003f2b0: 7265 7370 6f6e 7365 290a 2020 2020 2020  response).      
-0003f2c0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0003f2d0: 6173 796e 6369 6f2e 736c 6565 7028 696e  asyncio.sleep(in
-0003f2e0: 7465 7276 616c 290a 2020 2020 2020 2020  terval).        
-0003f2f0: 6578 6365 7074 204f 5345 7272 6f72 3a0a  except OSError:.
-0003f300: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0003f310: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-0003f320: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0003f330: 2074 6561 7264 6f77 6e3a 0a20 2020 2020   teardown:.     
-0003f340: 2020 2020 2020 2020 2020 2074 6561 7264             teard
-0003f350: 6f77 6e28 7365 6c66 2c20 7374 6174 6529  own(self, state)
-0003f360: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0003f370: 0a0a 2020 2020 6465 6620 6c6f 675f 776f  ..    def log_wo
-0003f380: 726b 6572 5f65 7665 6e74 280a 2020 2020  rker_event(.    
-0003f390: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
-0003f3a0: 3a20 7374 722c 2074 6f70 6963 3a20 7374  : str, topic: st
-0003f3b0: 7220 7c20 436f 6c6c 6563 7469 6f6e 5b73  r | Collection[s
-0003f3c0: 7472 5d2c 206d 7367 3a20 416e 790a 2020  tr], msg: Any.  
-0003f3d0: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-0003f3e0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0003f3f0: 6365 286d 7367 2c20 6469 6374 293a 0a20  ce(msg, dict):. 
-0003f400: 2020 2020 2020 2020 2020 206d 7367 5b22             msg["
-0003f410: 776f 726b 6572 225d 203d 2077 6f72 6b65  worker"] = worke
-0003f420: 720a 2020 2020 2020 2020 7365 6c66 2e6c  r.        self.l
-0003f430: 6f67 5f65 7665 6e74 2874 6f70 6963 2c20  og_event(topic, 
-0003f440: 6d73 6729 0a0a 2020 2020 6465 6620 7375  msg)..    def su
-0003f450: 6273 6372 6962 655f 776f 726b 6572 5f73  bscribe_worker_s
-0003f460: 7461 7475 7328 7365 6c66 2c20 636f 6d6d  tatus(self, comm
-0003f470: 3a20 436f 6d6d 2920 2d3e 2073 7472 3a0a  : Comm) -> str:.
-0003f480: 2020 2020 2020 2020 576f 726b 6572 5374          WorkerSt
-0003f490: 6174 7573 506c 7567 696e 2873 656c 662c  atusPlugin(self,
-0003f4a0: 2063 6f6d 6d29 0a20 2020 2020 2020 2069   comm).        i
-0003f4b0: 6465 6e74 203d 2073 656c 662e 6964 656e  dent = self.iden
-0003f4c0: 7469 7479 2829 0a20 2020 2020 2020 2066  tity().        f
-0003f4d0: 6f72 2076 2069 6e20 6964 656e 745b 2277  or v in ident["w
-0003f4e0: 6f72 6b65 7273 225d 2e76 616c 7565 7328  orkers"].values(
-0003f4f0: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-0003f500: 656c 2076 5b22 6d65 7472 6963 7322 5d0a  el v["metrics"].
-0003f510: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-0003f520: 765b 226c 6173 745f 7365 656e 225d 0a20  v["last_seen"]. 
-0003f530: 2020 2020 2020 2072 6574 7572 6e20 6964         return id
-0003f540: 656e 740a 0a20 2020 2064 6566 2067 6574  ent..    def get
-0003f550: 5f70 726f 6365 7373 696e 6728 0a20 2020  _processing(.   
-0003f560: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-0003f570: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-0003f580: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
-0003f590: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
-0003f5a0: 722c 206c 6973 745b 7374 725d 5d3a 0a20  r, list[str]]:. 
-0003f5b0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
-0003f5c0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-0003f5d0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0003f5e0: 7273 203d 2073 6574 286d 6170 2873 656c  rs = set(map(sel
-0003f5f0: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
-0003f600: 2c20 776f 726b 6572 7329 290a 2020 2020  , workers)).    
-0003f610: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0003f620: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
-0003f630: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-0003f640: 735b 775d 2e70 726f 6365 7373 696e 675d  s[w].processing]
-0003f650: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
-0003f660: 737d 0a20 2020 2020 2020 2065 6c73 653a  s}.        else:
-0003f670: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003f680: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-0003f690: 2020 2020 2020 773a 205b 7473 2e6b 6579        w: [ts.key
-0003f6a0: 2066 6f72 2074 7320 696e 2077 732e 7072   for ts in ws.pr
-0003f6b0: 6f63 6573 7369 6e67 5d20 666f 7220 772c  ocessing] for w,
-0003f6c0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-0003f6d0: 6572 732e 6974 656d 7328 290a 2020 2020  ers.items().    
-0003f6e0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
-0003f6f0: 6566 2067 6574 5f77 686f 5f68 6173 2873  ef get_who_has(s
-0003f700: 656c 662c 206b 6579 733a 2049 7465 7261  elf, keys: Itera
-0003f710: 626c 655b 7374 725d 207c 204e 6f6e 6520  ble[str] | None 
-0003f720: 3d20 4e6f 6e65 2920 2d3e 2064 6963 745b  = None) -> dict[
-0003f730: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
-0003f740: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
-0003f750: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0003f760: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003f770: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0003f780: 2020 206b 6579 3a20 5b77 732e 6164 6472     key: [ws.addr
-0003f790: 6573 7320 666f 7220 7773 2069 6e20 7365  ess for ws in se
-0003f7a0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 7768  lf.tasks[key].wh
-0003f7b0: 6f5f 6861 735d 0a20 2020 2020 2020 2020  o_has].         
-0003f7c0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-0003f7d0: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-0003f7e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003f7f0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0003f800: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-0003f810: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
-0003f820: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-0003f830: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0003f840: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-0003f850: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
-0003f860: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
-0003f870: 7473 2e77 686f 5f68 6173 5d20 666f 7220  ts.who_has] for 
-0003f880: 6b65 792c 2074 7320 696e 2073 656c 662e  key, ts in self.
-0003f890: 7461 736b 732e 6974 656d 7328 290a 2020  tasks.items().  
-0003f8a0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0003f8b0: 2064 6566 2067 6574 5f68 6173 5f77 6861   def get_has_wha
-0003f8c0: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
-0003f8d0: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-0003f8e0: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
-0003f8f0: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
-0003f900: 6963 745b 7374 722c 206c 6973 745b 7374  ict[str, list[st
-0003f910: 725d 5d3a 0a20 2020 2020 2020 2069 6620  r]]:.        if 
-0003f920: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003f930: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003f940: 2077 6f72 6b65 7273 203d 206d 6170 2873   workers = map(s
-0003f950: 656c 662e 636f 6572 6365 5f61 6464 7265  elf.coerce_addre
-0003f960: 7373 2c20 776f 726b 6572 7329 0a20 2020  ss, workers).   
-0003f970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003f980: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003f990: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
-0003f9a0: 2074 7320 696e 2073 656c 662e 776f 726b   ts in self.work
-0003f9b0: 6572 735b 775d 2e68 6173 5f77 6861 745d  ers[w].has_what]
-0003f9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f9d0: 2069 6620 7720 696e 2073 656c 662e 776f   if w in self.wo
-0003f9e0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-0003f9f0: 2020 2020 2020 656c 7365 205b 5d0a 2020        else [].  
-0003fa00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003fa10: 7220 7720 696e 2077 6f72 6b65 7273 0a20  r w in workers. 
-0003fa20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0003fa30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003fa40: 2020 2020 2020 2072 6574 7572 6e20 7b77         return {w
-0003fa50: 3a20 5b74 732e 6b65 7920 666f 7220 7473  : [ts.key for ts
-0003fa60: 2069 6e20 7773 2e68 6173 5f77 6861 745d   in ws.has_what]
-0003fa70: 2066 6f72 2077 2c20 7773 2069 6e20 7365   for w, ws in se
-0003fa80: 6c66 2e77 6f72 6b65 7273 2e69 7465 6d73  lf.workers.items
-0003fa90: 2829 7d0a 0a20 2020 2064 6566 2067 6574  ()}..    def get
-0003faa0: 5f6e 636f 7265 7328 7365 6c66 2c20 776f  _ncores(self, wo
-0003fab0: 726b 6572 733a 2049 7465 7261 626c 655b  rkers: Iterable[
-0003fac0: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
-0003fad0: 6e65 2920 2d3e 2064 6963 745b 7374 722c  ne) -> dict[str,
-0003fae0: 2069 6e74 5d3a 0a20 2020 2020 2020 2069   int]:.        i
-0003faf0: 6620 776f 726b 6572 7320 6973 206e 6f74  f workers is not
-0003fb00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003fb10: 2020 2077 6f72 6b65 7273 203d 206d 6170     workers = map
-0003fb20: 2873 656c 662e 636f 6572 6365 5f61 6464  (self.coerce_add
-0003fb30: 7265 7373 2c20 776f 726b 6572 7329 0a20  ress, workers). 
-0003fb40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003fb50: 6e20 7b77 3a20 7365 6c66 2e77 6f72 6b65  n {w: self.worke
-0003fb60: 7273 5b77 5d2e 6e74 6872 6561 6473 2066  rs[w].nthreads f
-0003fb70: 6f72 2077 2069 6e20 776f 726b 6572 7320  or w in workers 
-0003fb80: 6966 2077 2069 6e20 7365 6c66 2e77 6f72  if w in self.wor
-0003fb90: 6b65 7273 7d0a 2020 2020 2020 2020 656c  kers}.        el
-0003fba0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003fbb0: 7265 7475 726e 207b 773a 2077 732e 6e74  return {w: ws.nt
-0003fbc0: 6872 6561 6473 2066 6f72 2077 2c20 7773  hreads for w, ws
-0003fbd0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0003fbe0: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
-0003fbf0: 6566 2067 6574 5f6e 636f 7265 735f 7275  ef get_ncores_ru
-0003fc00: 6e6e 696e 6728 0a20 2020 2020 2020 2073  nning(.        s
-0003fc10: 656c 662c 2077 6f72 6b65 7273 3a20 4974  elf, workers: It
-0003fc20: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-0003fc30: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
-0003fc40: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
-0003fc50: 5d3a 0a20 2020 2020 2020 206e 636f 7265  ]:.        ncore
-0003fc60: 7320 3d20 7365 6c66 2e67 6574 5f6e 636f  s = self.get_nco
-0003fc70: 7265 7328 776f 726b 6572 733d 776f 726b  res(workers=work
-0003fc80: 6572 7329 0a20 2020 2020 2020 2072 6574  ers).        ret
-0003fc90: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-0003fca0: 2020 773a 206e 2066 6f72 2077 2c20 6e20    w: n for w, n 
-0003fcb0: 696e 206e 636f 7265 732e 6974 656d 7328  in ncores.items(
-0003fcc0: 2920 6966 2073 656c 662e 776f 726b 6572  ) if self.worker
-0003fcd0: 735b 775d 2e73 7461 7475 7320 3d3d 2053  s[w].status == S
-0003fce0: 7461 7475 732e 7275 6e6e 696e 670a 2020  tatus.running.  
-0003fcf0: 2020 2020 2020 7d0a 0a20 2020 2061 7379        }..    asy
-0003fd00: 6e63 2064 6566 2067 6574 5f63 616c 6c5f  nc def get_call_
-0003fd10: 7374 6163 6b28 7365 6c66 2c20 6b65 7973  stack(self, keys
-0003fd20: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
-0003fd30: 7c20 4e6f 6e65 203d 204e 6f6e 6529 202d  | None = None) -
-0003fd40: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
-0003fd50: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
-0003fd60: 722c 206c 6973 745b 7374 725d 207c 204e  r, list[str] | N
-0003fd70: 6f6e 655d 0a20 2020 2020 2020 2069 6620  one].        if 
-0003fd80: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-0003fd90: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0003fda0: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
-0003fdb0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0003fdc0: 6365 7373 696e 6720 3d20 7365 7428 290a  cessing = set().
-0003fdd0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-0003fde0: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
-0003fdf0: 2020 2020 2020 2020 206b 6579 203d 2073           key = s
-0003fe00: 7461 636b 2e70 6f70 2829 0a20 2020 2020  tack.pop().     
-0003fe10: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0003fe20: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-0003fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fe40: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-0003fe50: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
-0003fe60: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0003fe70: 6163 6b2e 6578 7465 6e64 285b 6474 732e  ack.extend([dts.
-0003fe80: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
-0003fe90: 732e 6465 7065 6e64 656e 6369 6573 5d29  s.dependencies])
-0003fea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003feb0: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
-0003fec0: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
-0003fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fee0: 2020 2020 7072 6f63 6573 7369 6e67 2e61      processing.a
-0003fef0: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
-0003ff00: 2020 2020 776f 726b 6572 7320 3d20 6465      workers = de
-0003ff10: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
-0003ff20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0003ff30: 7473 2069 6e20 7072 6f63 6573 7369 6e67  ts in processing
-0003ff40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003ff50: 2020 6966 2074 732e 7072 6f63 6573 7369    if ts.processi
-0003ff60: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2020  ng_on:.         
-0003ff70: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
-0003ff80: 203d 2077 6f72 6b65 7273 5b74 732e 7072   = workers[ts.pr
-0003ff90: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
-0003ffa0: 6573 735d 0a20 2020 2020 2020 2020 2020  ess].           
-0003ffb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0003ffc0: 776b 6579 7320 6973 206e 6f74 204e 6f6e  wkeys is not Non
-0003ffd0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0003ffe0: 2020 2020 2020 776b 6579 732e 6170 7065        wkeys.appe
-0003fff0: 6e64 2874 732e 6b65 7929 0a20 2020 2020  nd(ts.key).     
-00040000: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00040010: 2020 2020 2077 6f72 6b65 7273 203d 207b       workers = {
-00040020: 773a 204e 6f6e 6520 666f 7220 7720 696e  w: None for w in
-00040030: 2073 656c 662e 776f 726b 6572 737d 0a0a   self.workers}..
-00040040: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
-00040050: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00040060: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
-00040070: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-00040080: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00040090: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-000400a0: 2020 202a 2873 656c 662e 7270 6328 7729     *(self.rpc(w)
-000400b0: 2e63 616c 6c5f 7374 6163 6b28 6b65 7973  .call_stack(keys
-000400c0: 3d76 2920 666f 7220 772c 2076 2069 6e20  =v) for w, v in 
-000400d0: 776f 726b 6572 732e 6974 656d 7328 2929  workers.items())
-000400e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000400f0: 2020 2072 6573 706f 6e73 6520 3d20 7b77     response = {w
-00040100: 3a20 7220 666f 7220 772c 2072 2069 6e20  : r for w, r in 
-00040110: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
-00040120: 756c 7473 2920 6966 2072 7d0a 2020 2020  ults) if r}.    
-00040130: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
-00040140: 6e73 650a 0a20 2020 2061 7379 6e63 2064  nse..    async d
-00040150: 6566 2062 656e 6368 6d61 726b 5f68 6172  ef benchmark_har
-00040160: 6477 6172 6528 7365 6c66 2920 2d3e 2022  dware(self) -> "
-00040170: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
-00040180: 7472 2c20 666c 6f61 745d 5d22 3a0a 2020  tr, float]]":.  
-00040190: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000401a0: 2020 5275 6e20 6120 6265 6e63 686d 6172    Run a benchmar
-000401b0: 6b20 6f6e 2074 6865 2077 6f72 6b65 7273  k on the workers
-000401c0: 2066 6f72 206d 656d 6f72 792c 2064 6973   for memory, dis
-000401d0: 6b2c 2061 6e64 206e 6574 776f 726b 2062  k, and network b
-000401e0: 616e 6477 6964 7468 730a 0a20 2020 2020  andwidths..     
-000401f0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00040200: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00040210: 2020 2072 6573 756c 743a 2064 6963 740a     result: dict.
-00040220: 2020 2020 2020 2020 2020 2020 4120 6469              A di
-00040230: 6374 696f 6e61 7279 206d 6170 7069 6e67  ctionary mapping
-00040240: 2074 6865 206e 616d 6573 2022 6469 736b   the names "disk
-00040250: 222c 2022 6d65 6d6f 7279 222c 2061 6e64  ", "memory", and
-00040260: 2022 6e65 7477 6f72 6b22 2074 6f0a 2020   "network" to.  
-00040270: 2020 2020 2020 2020 2020 6469 6374 696f            dictio
-00040280: 6e61 7269 6573 206d 6170 7069 6e67 2073  naries mapping s
-00040290: 697a 6573 2074 6f20 6261 6e64 7769 6474  izes to bandwidt
-000402a0: 6873 2e20 2054 6865 7365 2062 616e 6477  hs.  These bandw
-000402b0: 6964 7468 7320 6172 650a 2020 2020 2020  idths are.      
-000402c0: 2020 2020 2020 6176 6572 6167 6564 206f        averaged o
-000402d0: 7665 7220 6d61 6e79 2077 6f72 6b65 7273  ver many workers
-000402e0: 2072 756e 6e69 6e67 2063 6f6d 7075 7461   running computa
-000402f0: 7469 6f6e 7320 6163 726f 7373 2074 6865  tions across the
-00040300: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
-00040310: 2020 2222 220a 2020 2020 2020 2020 6f75    """.        ou
-00040320: 743a 2064 6963 745b 7374 722c 2064 6566  t: dict[str, def
-00040330: 6175 6c74 6469 6374 5b73 7472 2c20 6c69  aultdict[str, li
-00040340: 7374 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a  st[float]]] = {.
-00040350: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00040360: 3a20 6465 6661 756c 7464 6963 7428 6c69  : defaultdict(li
-00040370: 7374 2920 666f 7220 6e61 6d65 2069 6e20  st) for name in 
-00040380: 5b22 6469 736b 222c 2022 6d65 6d6f 7279  ["disk", "memory
-00040390: 222c 2022 6e65 7477 6f72 6b22 5d0a 2020  ", "network"].  
-000403a0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000403b0: 2023 2064 6973 6b0a 2020 2020 2020 2020   # disk.        
-000403c0: 7265 7375 6c74 203d 2061 7761 6974 2073  result = await s
-000403d0: 656c 662e 6272 6f61 6463 6173 7428 6d73  elf.broadcast(ms
-000403e0: 673d 7b22 6f70 223a 2022 6265 6e63 686d  g={"op": "benchm
-000403f0: 6172 6b5f 6469 736b 227d 290a 2020 2020  ark_disk"}).    
-00040400: 2020 2020 666f 7220 6420 696e 2072 6573      for d in res
-00040410: 756c 742e 7661 6c75 6573 2829 3a0a 2020  ult.values():.  
-00040420: 2020 2020 2020 2020 2020 666f 7220 7369            for si
-00040430: 7a65 2c20 6475 7261 7469 6f6e 2069 6e20  ze, duration in 
-00040440: 642e 6974 656d 7328 293a 0a20 2020 2020  d.items():.     
-00040450: 2020 2020 2020 2020 2020 206f 7574 5b22             out["
-00040460: 6469 736b 225d 5b73 697a 655d 2e61 7070  disk"][size].app
-00040470: 656e 6428 6475 7261 7469 6f6e 290a 0a20  end(duration).. 
-00040480: 2020 2020 2020 2023 206d 656d 6f72 790a         # memory.
-00040490: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-000404a0: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
-000404b0: 6463 6173 7428 6d73 673d 7b22 6f70 223a  dcast(msg={"op":
-000404c0: 2022 6265 6e63 686d 6172 6b5f 6d65 6d6f   "benchmark_memo
-000404d0: 7279 227d 290a 2020 2020 2020 2020 666f  ry"}).        fo
-000404e0: 7220 6420 696e 2072 6573 756c 742e 7661  r d in result.va
-000404f0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00040500: 2020 2020 666f 7220 7369 7a65 2c20 6475      for size, du
-00040510: 7261 7469 6f6e 2069 6e20 642e 6974 656d  ration in d.item
-00040520: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00040530: 2020 2020 206f 7574 5b22 6d65 6d6f 7279       out["memory
-00040540: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
-00040550: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
-00040560: 2020 2023 206e 6574 776f 726b 0a20 2020     # network.   
-00040570: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
-00040580: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
-00040590: 290a 2020 2020 2020 2020 2320 4f6e 2061  ).        # On a
-000405a0: 6e20 6164 6170 7469 7665 2063 6c75 7374  n adaptive clust
-000405b0: 6572 2c20 6966 206d 756c 7469 706c 6520  er, if multiple 
-000405c0: 776f 726b 6572 7320 6172 6520 7374 6172  workers are star
-000405d0: 7465 6420 6f6e 2074 6865 2073 616d 6520  ted on the same 
-000405e0: 7068 7973 6963 616c 2068 6f73 742c 0a20  physical host,. 
-000405f0: 2020 2020 2020 2023 2074 6865 7920 6172         # they ar
-00040600: 6520 6d6f 7265 206c 696b 656c 7920 746f  e more likely to
-00040610: 2063 6f6e 6e65 6374 2074 6f20 7468 6520   connect to the 
-00040620: 5363 6865 6475 6c65 7220 696e 2073 6571  Scheduler in seq
-00040630: 7565 6e63 652c 2065 6e64 696e 6720 7570  uence, ending up
-00040640: 206e 6578 7420 746f 0a20 2020 2020 2020   next to.       
-00040650: 2023 2065 6163 6820 6f74 6865 7220 696e   # each other in
-00040660: 2074 6869 7320 6c69 7374 2e0a 2020 2020   this list..    
-00040670: 2020 2020 2320 5468 6520 7472 616e 7366      # The transf
-00040680: 6572 2073 7065 6564 2077 6974 6869 6e20  er speed within 
-00040690: 7375 6368 2063 6c75 7374 6572 7320 6f66  such clusters of
-000406a0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
-000406b0: 2065 6666 6563 7469 7665 6c79 2074 6861   effectively tha
-000406c0: 7420 6f66 0a20 2020 2020 2020 2023 206c  t of.        # l
-000406d0: 6f63 616c 686f 7374 2e20 5468 6973 2063  ocalhost. This c
-000406e0: 6f75 6c64 2068 6170 7065 6e20 6163 726f  ould happen acro
-000406f0: 7373 2064 6966 6665 7265 6e74 2056 4d73  ss different VMs
-00040700: 2061 6e64 2f6f 7220 646f 636b 6572 2069   and/or docker i
-00040710: 6d61 6765 732c 2073 6f0a 2020 2020 2020  mages, so.      
-00040720: 2020 2320 696d 706c 656d 656e 7469 6e67    # implementing
-00040730: 206c 6f67 6963 2062 6173 6564 206f 6e20   logic based on 
-00040740: 4950 2061 6464 7265 7373 6573 2077 6f75  IP addresses wou
-00040750: 6c64 206e 6f74 206e 6563 6573 7361 7269  ld not necessari
-00040760: 6c79 2068 656c 702e 0a20 2020 2020 2020  ly help..       
-00040770: 2023 2052 616e 646f 6d69 7a65 2074 6865   # Randomize the
-00040780: 2063 6f6e 6e65 6374 696f 6e73 2074 6f20   connections to 
-00040790: 6576 656e 206f 7574 2074 6865 206d 6561  even out the mea
-000407a0: 6e20 6d65 6173 7572 6573 2e0a 2020 2020  n measures..    
-000407b0: 2020 2020 7261 6e64 6f6d 2e73 6875 6666      random.shuff
-000407c0: 6c65 2877 6f72 6b65 7273 290a 2020 2020  le(workers).    
-000407d0: 2020 2020 6675 7475 7265 7320 3d20 5b0a      futures = [.
-000407e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000407f0: 2e72 7063 2861 292e 6265 6e63 686d 6172  .rpc(a).benchmar
-00040800: 6b5f 6e65 7477 6f72 6b28 6164 6472 6573  k_network(addres
-00040810: 733d 6229 2066 6f72 2061 2c20 6220 696e  s=b) for a, b in
-00040820: 2070 6172 7469 7469 6f6e 2832 2c20 776f   partition(2, wo
-00040830: 726b 6572 7329 0a20 2020 2020 2020 205d  rkers).        ]
-00040840: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-00040850: 6573 203d 2061 7761 6974 2061 7379 6e63  es = await async
-00040860: 696f 2e67 6174 6865 7228 2a66 7574 7572  io.gather(*futur
-00040870: 6573 290a 0a20 2020 2020 2020 2066 6f72  es)..        for
-00040880: 2064 2069 6e20 7265 7370 6f6e 7365 733a   d in responses:
-00040890: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000408a0: 2073 697a 652c 2064 7572 6174 696f 6e20   size, duration 
-000408b0: 696e 2064 2e69 7465 6d73 2829 3a0a 2020  in d.items():.  
-000408c0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-000408d0: 745b 226e 6574 776f 726b 225d 5b73 697a  t["network"][siz
-000408e0: 655d 2e61 7070 656e 6428 6475 7261 7469  e].append(durati
-000408f0: 6f6e 290a 0a20 2020 2020 2020 2072 6573  on)..        res
-00040900: 756c 7420 3d20 7b7d 0a20 2020 2020 2020  ult = {}.       
-00040910: 2066 6f72 206d 6f64 6520 696e 206f 7574   for mode in out
-00040920: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00040930: 7375 6c74 5b6d 6f64 655d 203d 207b 0a20  sult[mode] = {. 
-00040940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00040950: 697a 653a 2073 756d 2864 7572 6174 696f  ize: sum(duratio
-00040960: 6e73 2920 2f20 6c65 6e28 6475 7261 7469  ns) / len(durati
-00040970: 6f6e 7329 0a20 2020 2020 2020 2020 2020  ons).           
-00040980: 2020 2020 2066 6f72 2073 697a 652c 2064       for size, d
-00040990: 7572 6174 696f 6e73 2069 6e20 6f75 745b  urations in out[
-000409a0: 6d6f 6465 5d2e 6974 656d 7328 290a 2020  mode].items().  
-000409b0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-000409c0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-000409d0: 6c74 0a0a 2020 2020 406c 6f67 5f65 7272  lt..    @log_err
-000409e0: 6f72 730a 2020 2020 6465 6620 6765 745f  ors.    def get_
-000409f0: 6e62 7974 6573 280a 2020 2020 2020 2020  nbytes(.        
-00040a00: 7365 6c66 2c20 6b65 7973 3a20 4974 6572  self, keys: Iter
-00040a10: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
-00040a20: 203d 204e 6f6e 652c 2073 756d 6d61 7279   = None, summary
-00040a30: 3a20 626f 6f6c 203d 2054 7275 650a 2020  : bool = True.  
-00040a40: 2020 2920 2d3e 2064 6963 745b 7374 722c    ) -> dict[str,
-00040a50: 2069 6e74 5d3a 0a20 2020 2020 2020 2069   int]:.        i
-00040a60: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
-00040a70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00040a80: 7265 7375 6c74 203d 207b 6b3a 2073 656c  result = {k: sel
-00040a90: 662e 7461 736b 735b 6b5d 2e6e 6279 7465  f.tasks[k].nbyte
-00040aa0: 7320 666f 7220 6b20 696e 206b 6579 737d  s for k in keys}
-00040ab0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00040ac0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00040ad0: 7420 3d20 7b6b 3a20 7473 2e6e 6279 7465  t = {k: ts.nbyte
-00040ae0: 7320 666f 7220 6b2c 2074 7320 696e 2073  s for k, ts in s
-00040af0: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
-00040b00: 2920 6966 2074 732e 6e62 7974 6573 203e  ) if ts.nbytes >
-00040b10: 3d20 307d 0a0a 2020 2020 2020 2020 6966  = 0}..        if
-00040b20: 2073 756d 6d61 7279 3a0a 2020 2020 2020   summary:.      
-00040b30: 2020 2020 2020 6f75 743a 2064 6566 6175        out: defau
-00040b40: 6c74 6469 6374 5b73 7472 2c20 696e 745d  ltdict[str, int]
-00040b50: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
-00040b60: 616d 6264 613a 2030 290a 2020 2020 2020  ambda: 0).      
-00040b70: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-00040b80: 6e20 7265 7375 6c74 2e69 7465 6d73 2829  n result.items()
-00040b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00040ba0: 2020 6f75 745b 6b65 795f 7370 6c69 7428    out[key_split(
-00040bb0: 6b29 5d20 2b3d 2076 0a20 2020 2020 2020  k)] += v.       
-00040bc0: 2020 2020 2072 6573 756c 7420 3d20 6469       result = di
-00040bd0: 6374 286f 7574 290a 0a20 2020 2020 2020  ct(out)..       
-00040be0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00040bf0: 2020 2020 6465 6620 7275 6e5f 6675 6e63      def run_func
-00040c00: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
-00040c10: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-00040c20: 3a20 436f 6d6d 2c0a 2020 2020 2020 2020  : Comm,.        
-00040c30: 6675 6e63 7469 6f6e 3a20 4361 6c6c 6162  function: Callab
-00040c40: 6c65 2c0a 2020 2020 2020 2020 6172 6773  le,.        args
-00040c50: 3a20 7475 706c 6520 3d20 2829 2c0a 2020  : tuple = (),.  
-00040c60: 2020 2020 2020 6b77 6172 6773 3a20 6469        kwargs: di
-00040c70: 6374 207c 204e 6f6e 6520 3d20 4e6f 6e65  ct | None = None
-00040c80: 2c0a 2020 2020 2020 2020 7761 6974 3a20  ,.        wait: 
-00040c90: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00040ca0: 2029 202d 3e20 416e 793a 0a20 2020 2020   ) -> Any:.     
-00040cb0: 2020 2022 2222 5275 6e20 6120 6675 6e63     """Run a func
-00040cc0: 7469 6f6e 2077 6974 6869 6e20 7468 6973  tion within this
-00040cd0: 2070 726f 6365 7373 0a0a 2020 2020 2020   process..      
-00040ce0: 2020 5365 6520 416c 736f 0a20 2020 2020    See Also.     
-00040cf0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00040d00: 2020 2020 436c 6965 6e74 2e72 756e 5f6f      Client.run_o
-00040d10: 6e5f 7363 6865 6475 6c65 720a 2020 2020  n_scheduler.    
-00040d20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00040d30: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00040d40: 2e77 6f72 6b65 7220 696d 706f 7274 2072  .worker import r
-00040d50: 756e 0a0a 2020 2020 2020 2020 6966 206e  un..        if n
-00040d60: 6f74 2064 6173 6b2e 636f 6e66 6967 2e67  ot dask.config.g
-00040d70: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-00040d80: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
-00040d90: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00040da0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00040db0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00040dc0: 2020 2243 616e 6e6f 7420 7275 6e20 6675    "Cannot run fu
-00040dd0: 6e63 7469 6f6e 2061 7320 7468 6520 7363  nction as the sc
-00040de0: 6865 6475 6c65 7220 6861 7320 6265 656e  heduler has been
-00040df0: 2065 7870 6c69 6369 746c 7920 6469 7361   explicitly disa
-00040e00: 6c6c 6f77 6564 2066 726f 6d20 220a 2020  llowed from ".  
-00040e10: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-00040e20: 6573 6572 6961 6c69 7a69 6e67 2061 7262  eserializing arb
-00040e30: 6974 7261 7279 2062 7974 6573 7472 696e  itrary bytestrin
-00040e40: 6773 2075 7369 6e67 2070 6963 6b6c 6520  gs using pickle 
-00040e50: 7669 6120 7468 6520 220a 2020 2020 2020  via the ".      
-00040e60: 2020 2020 2020 2020 2020 2227 6469 7374            "'dist
-00040e70: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-00040e80: 722e 7069 636b 6c65 2720 636f 6e66 6967  r.pickle' config
-00040e90: 7572 6174 696f 6e20 7365 7474 696e 672e  uration setting.
-00040ea0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00040eb0: 2020 2020 2020 2020 6b77 6172 6773 203d          kwargs =
-00040ec0: 206b 7761 7267 7320 6f72 207b 7d0a 2020   kwargs or {}.  
-00040ed0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-00040ee0: 7665 6e74 2822 616c 6c22 2c20 7b22 6163  vent("all", {"ac
-00040ef0: 7469 6f6e 223a 2022 7275 6e2d 6675 6e63  tion": "run-func
-00040f00: 7469 6f6e 222c 2022 6675 6e63 7469 6f6e  tion", "function
-00040f10: 223a 2066 756e 6374 696f 6e7d 290a 2020  ": function}).  
-00040f20: 2020 2020 2020 7265 7475 726e 2072 756e        return run
-00040f30: 2873 656c 662c 2063 6f6d 6d2c 2066 756e  (self, comm, fun
-00040f40: 6374 696f 6e3d 6675 6e63 7469 6f6e 2c20  ction=function, 
-00040f50: 6172 6773 3d61 7267 732c 206b 7761 7267  args=args, kwarg
-00040f60: 733d 6b77 6172 6773 2c20 7761 6974 3d77  s=kwargs, wait=w
-00040f70: 6169 7429 0a0a 2020 2020 6465 6620 7365  ait)..    def se
-00040f80: 745f 6d65 7461 6461 7461 2873 656c 662c  t_metadata(self,
-00040f90: 206b 6579 733a 206c 6973 745b 7374 725d   keys: list[str]
-00040fa0: 2c20 7661 6c75 653a 206f 626a 6563 7420  , value: object 
-00040fb0: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
-00040fc0: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
-00040fd0: 6120 3d20 7365 6c66 2e74 6173 6b5f 6d65  a = self.task_me
-00040fe0: 7461 6461 7461 0a20 2020 2020 2020 2066  tadata.        f
-00040ff0: 6f72 206b 6579 2069 6e20 6b65 7973 5b3a  or key in keys[:
-00041000: 2d31 5d3a 0a20 2020 2020 2020 2020 2020  -1]:.           
-00041010: 2069 6620 6b65 7920 6e6f 7420 696e 206d   if key not in m
-00041020: 6574 6164 6174 6120 6f72 206e 6f74 2069  etadata or not i
-00041030: 7369 6e73 7461 6e63 6528 6d65 7461 6461  sinstance(metada
-00041040: 7461 5b6b 6579 5d2c 2028 6469 6374 2c20  ta[key], (dict, 
-00041050: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
-00041060: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00041070: 5b6b 6579 5d20 3d20 7b7d 0a20 2020 2020  [key] = {}.     
-00041080: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-00041090: 3d20 6d65 7461 6461 7461 5b6b 6579 5d0a  = metadata[key].
-000410a0: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-000410b0: 5b6b 6579 735b 2d31 5d5d 203d 2076 616c  [keys[-1]] = val
-000410c0: 7565 0a0a 2020 2020 6465 6620 6765 745f  ue..    def get_
-000410d0: 6d65 7461 6461 7461 2873 656c 662c 206b  metadata(self, k
-000410e0: 6579 733a 206c 6973 745b 7374 725d 2c20  eys: list[str], 
-000410f0: 6465 6661 756c 743a 2041 6e79 203d 206e  default: Any = n
-00041100: 6f5f 6465 6661 756c 7429 202d 3e20 416e  o_default) -> An
-00041110: 793a 0a20 2020 2020 2020 206d 6574 6164  y:.        metad
-00041120: 6174 6120 3d20 7365 6c66 2e74 6173 6b5f  ata = self.task_
-00041130: 6d65 7461 6461 7461 0a20 2020 2020 2020  metadata.       
-00041140: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00041150: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00041160: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00041170: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
-00041180: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
-00041190: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-000411a0: 6574 6164 6174 610a 2020 2020 2020 2020  etadata.        
-000411b0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-000411c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000411d0: 6465 6661 756c 7420 213d 206e 6f5f 6465  default != no_de
-000411e0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-000411f0: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
-00041200: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-00041210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00041220: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
-00041230: 2020 2064 6566 2073 6574 5f72 6573 7472     def set_restr
-00041240: 6963 7469 6f6e 7328 7365 6c66 2c20 776f  ictions(self, wo
-00041250: 726b 6572 3a20 6469 6374 5b73 7472 2c20  rker: dict[str, 
-00041260: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
-00041270: 7c20 7374 725d 2920 2d3e 204e 6f6e 653a  | str]) -> None:
-00041280: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-00041290: 2c20 7265 7374 7269 6374 696f 6e73 2069  , restrictions i
-000412a0: 6e20 776f 726b 6572 2e69 7465 6d73 2829  n worker.items()
-000412b0: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-000412c0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-000412d0: 795d 0a20 2020 2020 2020 2020 2020 2069  y].            i
-000412e0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-000412f0: 7472 6963 7469 6f6e 732c 2073 7472 293a  trictions, str):
-00041300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041310: 2072 6573 7472 6963 7469 6f6e 7320 3d20   restrictions = 
-00041320: 7b72 6573 7472 6963 7469 6f6e 737d 0a20  {restrictions}. 
-00041330: 2020 2020 2020 2020 2020 2074 732e 776f             ts.wo
-00041340: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
-00041350: 7320 3d20 7365 7428 7265 7374 7269 6374  s = set(restrict
-00041360: 696f 6e73 290a 0a20 2020 2040 6c6f 675f  ions)..    @log_
-00041370: 6572 726f 7273 0a20 2020 2064 6566 2067  errors.    def g
-00041380: 6574 5f74 6173 6b5f 7072 6566 6978 5f73  et_task_prefix_s
-00041390: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
-000413a0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-000413b0: 722c 2069 6e74 5d5d 3a0a 2020 2020 2020  r, int]]:.      
-000413c0: 2020 7374 6174 6520 3d20 7b7d 0a0a 2020    state = {}..  
-000413d0: 2020 2020 2020 666f 7220 7470 2069 6e20        for tp in 
-000413e0: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
-000413f0: 6573 2e76 616c 7565 7328 293a 0a20 2020  es.values():.   
-00041400: 2020 2020 2020 2020 2061 6374 6976 655f           active_
-00041410: 7374 6174 6573 203d 2074 702e 6163 7469  states = tp.acti
-00041420: 7665 5f73 7461 7465 730a 2020 2020 2020  ve_states.      
-00041430: 2020 2020 2020 6966 2061 6e79 280a 2020        if any(.  
-00041440: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-00041450: 7469 7665 5f73 7461 7465 732e 6765 7428  tive_states.get(
-00041460: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00041470: 2020 2066 6f72 2073 2069 6e20 7b22 6d65     for s in {"me
-00041480: 6d6f 7279 222c 2022 6572 7265 6422 2c20  mory", "erred", 
-00041490: 2272 656c 6561 7365 6422 2c20 2270 726f  "released", "pro
-000414a0: 6365 7373 696e 6722 2c20 2277 6169 7469  cessing", "waiti
-000414b0: 6e67 227d 0a20 2020 2020 2020 2020 2020  ng"}.           
-000414c0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000414d0: 2020 2020 7374 6174 655b 7470 2e6e 616d      state[tp.nam
-000414e0: 655d 203d 207b 0a20 2020 2020 2020 2020  e] = {.         
-000414f0: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00041500: 7279 223a 2061 6374 6976 655f 7374 6174  ry": active_stat
-00041510: 6573 5b22 6d65 6d6f 7279 225d 2c0a 2020  es["memory"],.  
-00041520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041530: 2020 2265 7272 6564 223a 2061 6374 6976    "erred": activ
-00041540: 655f 7374 6174 6573 5b22 6572 7265 6422  e_states["erred"
-00041550: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00041560: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
-00041570: 223a 2061 6374 6976 655f 7374 6174 6573  ": active_states
-00041580: 5b22 7265 6c65 6173 6564 225d 2c0a 2020  ["released"],.  
-00041590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000415a0: 2020 2270 726f 6365 7373 696e 6722 3a20    "processing": 
-000415b0: 6163 7469 7665 5f73 7461 7465 735b 2270  active_states["p
-000415c0: 726f 6365 7373 696e 6722 5d2c 0a20 2020  rocessing"],.   
-000415d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000415e0: 2022 7761 6974 696e 6722 3a20 6163 7469   "waiting": acti
-000415f0: 7665 5f73 7461 7465 735b 2277 6169 7469  ve_states["waiti
-00041600: 6e67 225d 2c0a 2020 2020 2020 2020 2020  ng"],.          
-00041610: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00041620: 2072 6574 7572 6e20 7374 6174 650a 0a20   return state.. 
-00041630: 2020 2064 6566 2067 6574 5f74 6173 6b5f     def get_task_
-00041640: 7374 6174 7573 2873 656c 662c 206b 6579  status(self, key
-00041650: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-00041660: 2920 2d3e 2064 6963 745b 7374 722c 2054  ) -> dict[str, T
-00041670: 6173 6b53 7461 7465 5374 6174 6520 7c20  askStateState | 
-00041680: 4e6f 6e65 5d3a 0a20 2020 2020 2020 2072  None]:.        r
-00041690: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-000416a0: 2020 2020 6b65 793a 2028 7365 6c66 2e74      key: (self.t
-000416b0: 6173 6b73 5b6b 6579 5d2e 7374 6174 6520  asks[key].state 
-000416c0: 6966 206b 6579 2069 6e20 7365 6c66 2e74  if key in self.t
-000416d0: 6173 6b73 2065 6c73 6520 4e6f 6e65 2920  asks else None) 
-000416e0: 666f 7220 6b65 7920 696e 206b 6579 730a  for key in keys.
-000416f0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
-00041700: 6566 2067 6574 5f74 6173 6b5f 7374 7265  ef get_task_stre
-00041710: 616d 280a 2020 2020 2020 2020 7365 6c66  am(.        self
-00041720: 2c0a 2020 2020 2020 2020 7374 6172 743a  ,.        start:
-00041730: 2073 7472 207c 2066 6c6f 6174 207c 204e   str | float | N
-00041740: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00041750: 2020 2020 7374 6f70 3a20 7374 7220 7c20      stop: str | 
-00041760: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
-00041770: 6f6e 652c 0a20 2020 2020 2020 2063 6f75  one,.        cou
-00041780: 6e74 3a20 696e 7420 7c20 4e6f 6e65 203d  nt: int | None =
-00041790: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-000417a0: 6c69 7374 3a0a 2020 2020 2020 2020 6672  list:.        fr
-000417b0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-000417c0: 6961 676e 6f73 7469 6373 2e74 6173 6b5f  iagnostics.task_
-000417d0: 7374 7265 616d 2069 6d70 6f72 7420 5461  stream import Ta
-000417e0: 736b 5374 7265 616d 506c 7567 696e 0a0a  skStreamPlugin..
-000417f0: 2020 2020 2020 2020 6966 2054 6173 6b53          if TaskS
-00041800: 7472 6561 6d50 6c75 6769 6e2e 6e61 6d65  treamPlugin.name
-00041810: 206e 6f74 2069 6e20 7365 6c66 2e70 6c75   not in self.plu
-00041820: 6769 6e73 3a0a 2020 2020 2020 2020 2020  gins:.          
-00041830: 2020 7365 6c66 2e61 6464 5f70 6c75 6769    self.add_plugi
-00041840: 6e28 5461 736b 5374 7265 616d 506c 7567  n(TaskStreamPlug
-00041850: 696e 2873 656c 6629 290a 0a20 2020 2020  in(self))..     
-00041860: 2020 2070 6c75 6769 6e20 3d20 6361 7374     plugin = cast
-00041870: 2854 6173 6b53 7472 6561 6d50 6c75 6769  (TaskStreamPlugi
-00041880: 6e2c 2073 656c 662e 706c 7567 696e 735b  n, self.plugins[
-00041890: 5461 736b 5374 7265 616d 506c 7567 696e  TaskStreamPlugin
-000418a0: 2e6e 616d 655d 290a 0a20 2020 2020 2020  .name])..       
-000418b0: 2072 6574 7572 6e20 706c 7567 696e 2e63   return plugin.c
-000418c0: 6f6c 6c65 6374 2873 7461 7274 3d73 7461  ollect(start=sta
-000418d0: 7274 2c20 7374 6f70 3d73 746f 702c 2063  rt, stop=stop, c
-000418e0: 6f75 6e74 3d63 6f75 6e74 290a 0a20 2020  ount=count)..   
-000418f0: 2064 6566 2073 7461 7274 5f74 6173 6b5f   def start_task_
-00041900: 6d65 7461 6461 7461 2873 656c 662c 206e  metadata(self, n
-00041910: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
-00041920: 653a 0a20 2020 2020 2020 2070 6c75 6769  e:.        plugi
-00041930: 6e20 3d20 436f 6c6c 6563 7454 6173 6b4d  n = CollectTaskM
-00041940: 6574 6144 6174 6150 6c75 6769 6e28 7363  etaDataPlugin(sc
-00041950: 6865 6475 6c65 723d 7365 6c66 2c20 6e61  heduler=self, na
-00041960: 6d65 3d6e 616d 6529 0a20 2020 2020 2020  me=name).       
-00041970: 2073 656c 662e 6164 645f 706c 7567 696e   self.add_plugin
-00041980: 2870 6c75 6769 6e29 0a0a 2020 2020 6465  (plugin)..    de
-00041990: 6620 7374 6f70 5f74 6173 6b5f 6d65 7461  f stop_task_meta
-000419a0: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
-000419b0: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-000419c0: 6e65 2920 2d3e 2064 6963 743a 0a20 2020  ne) -> dict:.   
-000419d0: 2020 2020 2070 6c75 6769 6e73 203d 205b       plugins = [
-000419e0: 0a20 2020 2020 2020 2020 2020 2070 0a20  .            p. 
-000419f0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-00041a00: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00041a10: 7567 696e 732e 7661 6c75 6573 2829 290a  ugins.values()).
-00041a20: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00041a30: 7369 6e73 7461 6e63 6528 702c 2043 6f6c  sinstance(p, Col
-00041a40: 6c65 6374 5461 736b 4d65 7461 4461 7461  lectTaskMetaData
-00041a50: 506c 7567 696e 2920 616e 6420 702e 6e61  Plugin) and p.na
-00041a60: 6d65 203d 3d20 6e61 6d65 0a20 2020 2020  me == name.     
-00041a70: 2020 205d 0a20 2020 2020 2020 2069 6620     ].        if 
-00041a80: 6c65 6e28 706c 7567 696e 7329 2021 3d20  len(plugins) != 
-00041a90: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
-00041aa0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00041ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041ac0: 2022 4578 7065 6374 6564 2074 6f20 6669   "Expected to fi
-00041ad0: 6e64 2065 7861 6374 6c79 206f 6e65 2043  nd exactly one C
-00041ae0: 6f6c 6c65 6374 5461 736b 4d65 7461 4461  ollectTaskMetaDa
-00041af0: 7461 506c 7567 696e 2022 0a20 2020 2020  taPlugin ".     
-00041b00: 2020 2020 2020 2020 2020 2066 2277 6974             f"wit
-00041b10: 6820 6e61 6d65 207b 6e61 6d65 7d20 6275  h name {name} bu
-00041b20: 7420 666f 756e 6420 7b6c 656e 2870 6c75  t found {len(plu
-00041b30: 6769 6e73 297d 2e22 0a20 2020 2020 2020  gins)}.".       
-00041b40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00041b50: 706c 7567 696e 203d 2070 6c75 6769 6e73  plugin = plugins
-00041b60: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-00041b70: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
-00041b80: 616d 653d 706c 7567 696e 2e6e 616d 6529  ame=plugin.name)
-00041b90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00041ba0: 7b22 6d65 7461 6461 7461 223a 2070 6c75  {"metadata": plu
-00041bb0: 6769 6e2e 6d65 7461 6461 7461 2c20 2273  gin.metadata, "s
-00041bc0: 7461 7465 223a 2070 6c75 6769 6e2e 7374  tate": plugin.st
-00041bd0: 6174 657d 0a0a 2020 2020 6173 796e 6320  ate}..    async 
-00041be0: 6465 6620 7265 6769 7374 6572 5f77 6f72  def register_wor
-00041bf0: 6b65 725f 706c 7567 696e 2873 656c 662c  ker_plugin(self,
-00041c00: 2063 6f6d 6d2c 2070 6c75 6769 6e2c 206e   comm, plugin, n
-00041c10: 616d 653d 4e6f 6e65 293a 0a20 2020 2020  ame=None):.     
-00041c20: 2020 2022 2222 5265 6769 7374 6572 7320     """Registers 
-00041c30: 6120 776f 726b 6572 2070 6c75 6769 6e20  a worker plugin 
-00041c40: 6f6e 2061 6c6c 2072 756e 6e69 6e67 2061  on all running a
-00041c50: 6e64 2066 7574 7572 6520 776f 726b 6572  nd future worker
-00041c60: 7322 2222 0a20 2020 2020 2020 2073 656c  s""".        sel
-00041c70: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
-00041c80: 5b6e 616d 655d 203d 2070 6c75 6769 6e0a  [name] = plugin.
-00041c90: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-00041ca0: 6573 203d 2061 7761 6974 2073 656c 662e  es = await self.
-00041cb0: 6272 6f61 6463 6173 7428 0a20 2020 2020  broadcast(.     
-00041cc0: 2020 2020 2020 206d 7367 3d64 6963 7428         msg=dict(
-00041cd0: 6f70 3d22 706c 7567 696e 2d61 6464 222c  op="plugin-add",
-00041ce0: 2070 6c75 6769 6e3d 706c 7567 696e 2c20   plugin=plugin, 
-00041cf0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
-00041d00: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
-00041d10: 7572 6e20 7265 7370 6f6e 7365 730a 0a20  urn responses.. 
-00041d20: 2020 2061 7379 6e63 2064 6566 2075 6e72     async def unr
-00041d30: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
-00041d40: 6c75 6769 6e28 7365 6c66 2c20 636f 6d6d  lugin(self, comm
-00041d50: 2c20 6e61 6d65 293a 0a20 2020 2020 2020  , name):.       
-00041d60: 2022 2222 556e 7265 6769 7374 6572 7320   """Unregisters 
-00041d70: 6120 776f 726b 6572 2070 6c75 6769 6e22  a worker plugin"
-00041d80: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
-00041d90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00041da0: 2e77 6f72 6b65 725f 706c 7567 696e 732e  .worker_plugins.
-00041db0: 706f 7028 6e61 6d65 290a 2020 2020 2020  pop(name).      
-00041dc0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00041dd0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00041de0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00041df0: 6622 5468 6520 776f 726b 6572 2070 6c75  f"The worker plu
-00041e00: 6769 6e20 7b6e 616d 657d 2064 6f65 7320  gin {name} does 
-00041e10: 6e6f 7420 6578 6973 7422 290a 0a20 2020  not exist")..   
-00041e20: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
-00041e30: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
-00041e40: 6463 6173 7428 6d73 673d 6469 6374 286f  dcast(msg=dict(o
-00041e50: 703d 2270 6c75 6769 6e2d 7265 6d6f 7665  p="plugin-remove
-00041e60: 222c 206e 616d 653d 6e61 6d65 2929 0a20  ", name=name)). 
-00041e70: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00041e80: 7370 6f6e 7365 730a 0a20 2020 2061 7379  sponses..    asy
-00041e90: 6e63 2064 6566 2072 6567 6973 7465 725f  nc def register_
-00041ea0: 6e61 6e6e 795f 706c 7567 696e 2873 656c  nanny_plugin(sel
-00041eb0: 662c 2063 6f6d 6d2c 2070 6c75 6769 6e2c  f, comm, plugin,
-00041ec0: 206e 616d 653d 4e6f 6e65 293a 0a20 2020   name=None):.   
-00041ed0: 2020 2020 2022 2222 5265 6769 7374 6572       """Register
-00041ee0: 7320 6120 7365 7475 7020 6675 6e63 7469  s a setup functi
-00041ef0: 6f6e 2c20 616e 6420 6361 6c6c 2069 7420  on, and call it 
-00041f00: 6f6e 2065 7665 7279 2077 6f72 6b65 7222  on every worker"
-00041f10: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-00041f20: 6e61 6e6e 795f 706c 7567 696e 735b 6e61  nanny_plugins[na
-00041f30: 6d65 5d20 3d20 706c 7567 696e 0a0a 2020  me] = plugin..  
-00041f40: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
-00041f50: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00041f60: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
-00041f70: 2020 2020 6d73 673d 6469 6374 286f 703d      msg=dict(op=
-00041f80: 2270 6c75 6769 6e5f 6164 6422 2c20 706c  "plugin_add", pl
-00041f90: 7567 696e 3d70 6c75 6769 6e2c 206e 616d  ugin=plugin, nam
-00041fa0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00041fb0: 2020 2020 206e 616e 6e79 3d54 7275 652c       nanny=True,
-00041fc0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00041fd0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
-00041fe0: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
-00041ff0: 6566 2075 6e72 6567 6973 7465 725f 6e61  ef unregister_na
-00042000: 6e6e 795f 706c 7567 696e 2873 656c 662c  nny_plugin(self,
-00042010: 2063 6f6d 6d2c 206e 616d 6529 3a0a 2020   comm, name):.  
-00042020: 2020 2020 2020 2222 2255 6e72 6567 6973        """Unregis
-00042030: 7465 7273 2061 2077 6f72 6b65 7220 706c  ters a worker pl
-00042040: 7567 696e 2222 220a 2020 2020 2020 2020  ugin""".        
-00042050: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00042060: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-00042070: 696e 732e 706f 7028 6e61 6d65 290a 2020  ins.pop(name).  
-00042080: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-00042090: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000420a0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000420b0: 726f 7228 6622 5468 6520 6e61 6e6e 7920  ror(f"The nanny 
-000420c0: 706c 7567 696e 207b 6e61 6d65 7d20 646f  plugin {name} do
-000420d0: 6573 206e 6f74 2065 7869 7374 2229 0a0a  es not exist")..
-000420e0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000420f0: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
-00042100: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
-00042110: 2020 2020 2020 6d73 673d 6469 6374 286f        msg=dict(o
-00042120: 703d 2270 6c75 6769 6e5f 7265 6d6f 7665  p="plugin_remove
-00042130: 222c 206e 616d 653d 6e61 6d65 292c 206e  ", name=name), n
-00042140: 616e 6e79 3d54 7275 650a 2020 2020 2020  anny=True.      
-00042150: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-00042160: 726e 2072 6573 706f 6e73 6573 0a0a 2020  rn responses..  
-00042170: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
-00042180: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00042190: 2020 2020 2020 2020 6b65 793a 2073 7472          key: str
-000421a0: 2c0a 2020 2020 2020 2020 6669 6e69 7368  ,.        finish
-000421b0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-000421c0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-000421d0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
-000421e0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-000421f0: 792c 0a20 2020 2029 202d 3e20 5265 6373  y,.    ) -> Recs
-00042200: 3a0a 2020 2020 2020 2020 2222 2254 7261  :.        """Tra
-00042210: 6e73 6974 696f 6e20 6120 6b65 7920 6672  nsition a key fr
-00042220: 6f6d 2069 7473 2063 7572 7265 6e74 2073  om its current s
-00042230: 7461 7465 2074 6f20 7468 6520 6669 6e69  tate to the fini
-00042240: 7368 2073 7461 7465 0a0a 2020 2020 2020  sh state..      
-00042250: 2020 4578 616d 706c 6573 0a20 2020 2020    Examples.     
-00042260: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00042270: 2020 2020 3e3e 3e20 7365 6c66 2e74 7261      >>> self.tra
-00042280: 6e73 6974 696f 6e28 2778 272c 2027 7761  nsition('x', 'wa
-00042290: 6974 696e 6727 290a 2020 2020 2020 2020  iting').        
-000422a0: 7b27 7827 3a20 2770 726f 6365 7373 696e  {'x': 'processin
-000422b0: 6727 7d0a 0a20 2020 2020 2020 2052 6574  g'}..        Ret
-000422c0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-000422d0: 2d2d 2d2d 0a20 2020 2020 2020 2044 6963  ----.        Dic
-000422e0: 7469 6f6e 6172 7920 6f66 2072 6563 6f6d  tionary of recom
-000422f0: 6d65 6e64 6174 696f 6e73 2066 6f72 2066  mendations for f
-00042300: 7574 7572 6520 7472 616e 7369 7469 6f6e  uture transition
-00042310: 730a 0a20 2020 2020 2020 2053 6565 2041  s..        See A
-00042320: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-00042330: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-00042340: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-00042350: 6e73 3a20 7472 616e 7369 7469 7665 2076  ns: transitive v
-00042360: 6572 7369 6f6e 206f 6620 7468 6973 2066  ersion of this f
-00042370: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
-00042380: 2222 220a 2020 2020 2020 2020 7265 636f  """.        reco
-00042390: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-000423a0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-000423b0: 5f6d 7367 7320 3d20 7365 6c66 2e5f 7472  _msgs = self._tr
-000423c0: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
-000423d0: 2020 2020 2020 6b65 792c 2066 696e 6973        key, finis
-000423e0: 682c 2073 7469 6d75 6c75 735f 6964 2c20  h, stimulus_id, 
-000423f0: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
-00042400: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00042410: 7365 6e64 5f61 6c6c 2863 6c69 656e 745f  send_all(client_
-00042420: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00042430: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00042440: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-00042450: 730a 0a20 2020 2064 6566 2074 7261 6e73  s..    def trans
-00042460: 6974 696f 6e73 2873 656c 662c 2072 6563  itions(self, rec
-00042470: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00042480: 6373 2c20 7374 696d 756c 7573 5f69 643a  cs, stimulus_id:
-00042490: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-000424a0: 2020 2020 2020 2022 2222 5072 6f63 6573         """Proces
-000424b0: 7320 7472 616e 7369 7469 6f6e 7320 756e  s transitions un
-000424c0: 7469 6c20 6e6f 6e65 2061 7265 206c 6566  til none are lef
-000424d0: 740a 0a20 2020 2020 2020 2054 6869 7320  t..        This 
-000424e0: 696e 636c 7564 6573 2066 6565 6462 6163  includes feedbac
-000424f0: 6b20 6672 6f6d 2070 7265 7669 6f75 7320  k from previous 
-00042500: 7472 616e 7369 7469 6f6e 7320 616e 6420  transitions and 
-00042510: 636f 6e74 696e 7565 7320 756e 7469 6c20  continues until 
-00042520: 7765 0a20 2020 2020 2020 2072 6561 6368  we.        reach
-00042530: 2061 2073 7465 6164 7920 7374 6174 650a   a steady state.
-00042540: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00042550: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-00042560: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
-00042570: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-00042580: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
-00042590: 2020 7365 6c66 2e5f 7472 616e 7369 7469    self._transiti
-000425a0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-000425b0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-000425c0: 2c20 776f 726b 6572 5f6d 7367 732c 2073  , worker_msgs, s
-000425d0: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
-000425e0: 2020 2020 7365 6c66 2e73 656e 645f 616c      self.send_al
-000425f0: 6c28 636c 6965 6e74 5f6d 7367 732c 2077  l(client_msgs, w
-00042600: 6f72 6b65 725f 6d73 6773 290a 0a20 2020  orker_msgs)..   
-00042610: 2061 7379 6e63 2064 6566 2067 6574 5f73   async def get_s
-00042620: 746f 7279 2873 656c 662c 206b 6579 735f  tory(self, keys_
-00042630: 6f72 5f73 7469 6d75 6c69 3a20 4974 6572  or_stimuli: Iter
-00042640: 6162 6c65 5b73 7472 5d29 202d 3e20 6c69  able[str]) -> li
-00042650: 7374 5b54 7261 6e73 6974 696f 6e5d 3a0a  st[Transition]:.
-00042660: 2020 2020 2020 2020 2222 2252 5043 2068          """RPC h
-00042670: 6f6f 6b20 666f 7220 3a6d 6574 683a 6053  ook for :meth:`S
-00042680: 6368 6564 756c 6572 5374 6174 652e 7374  chedulerState.st
-00042690: 6f72 7960 2e0a 0a20 2020 2020 2020 204e  ory`...        N
-000426a0: 6f74 6520 7468 6174 2074 6865 206d 7367  ote that the msg
-000426b0: 7061 636b 2073 6572 6961 6c69 7a61 7469  pack serializati
-000426c0: 6f6e 2f64 6573 6572 6961 6c69 7a61 7469  on/deserializati
-000426d0: 6f6e 2072 6f75 6e64 2d74 7269 7020 7769  on round-trip wi
-000426e0: 6c6c 2074 7261 6e73 666f 726d 0a20 2020  ll transform.   
-000426f0: 2020 2020 2074 6865 203a 636c 6173 733a       the :class:
-00042700: 6054 7261 6e73 6974 696f 6e60 206e 616d  `Transition` nam
-00042710: 6564 7475 706c 6573 2069 6e74 6f20 7265  edtuples into re
-00042720: 6775 6c61 7220 7475 706c 6573 2e0a 2020  gular tuples..  
-00042730: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00042740: 2020 7265 7475 726e 2073 656c 662e 7374    return self.st
-00042750: 6f72 7928 2a6b 6579 735f 6f72 5f73 7469  ory(*keys_or_sti
-00042760: 6d75 6c69 290a 0a20 2020 2064 6566 205f  muli)..    def _
-00042770: 7265 7363 6865 6475 6c65 280a 2020 2020  reschedule(.    
-00042780: 2020 2020 7365 6c66 2c20 6b65 793a 2073      self, key: s
-00042790: 7472 2c20 776f 726b 6572 3a20 7374 7220  tr, worker: str 
-000427a0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 202a  | None = None, *
-000427b0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-000427c0: 7472 0a20 2020 2029 202d 3e20 4e6f 6e65  tr.    ) -> None
-000427d0: 3a0a 2020 2020 2020 2020 2222 2252 6573  :.        """Res
-000427e0: 6368 6564 756c 6520 6120 7461 736b 2e0a  chedule a task..
-000427f0: 0a20 2020 2020 2020 2054 6869 7320 6675  .        This fu
-00042800: 6e63 7469 6f6e 2073 686f 756c 6420 6f6e  nction should on
-00042810: 6c79 2062 6520 7573 6564 2077 6865 6e20  ly be used when 
-00042820: 7468 6520 7461 736b 2068 6173 2061 6c72  the task has alr
-00042830: 6561 6479 2062 6565 6e20 7265 6c65 6173  eady been releas
-00042840: 6564 2069 6e0a 2020 2020 2020 2020 736f  ed in.        so
-00042850: 6d65 2077 6179 206f 6e20 7468 6520 776f  me way on the wo
-00042860: 726b 6572 2069 7427 7320 6173 7369 676e  rker it's assign
-00042870: 6564 2074 6f20 e280 9420 6569 7468 6572  ed to ... either
-00042880: 2076 6961 2063 616e 6365 6c6c 6174 696f   via cancellatio
-00042890: 6e20 6f72 2061 0a20 2020 2020 2020 2052  n or a.        R
-000428a0: 6573 6368 6564 756c 6520 6578 6365 7074  eschedule except
-000428b0: 696f 6e20 e280 9420 616e 6420 796f 7520  ion ... and you 
-000428c0: 6172 6520 6365 7274 6169 6e20 7468 6520  are certain the 
-000428d0: 776f 726b 6572 2077 696c 6c20 6e6f 7420  worker will not 
-000428e0: 7365 6e64 2061 6e79 2066 7572 7468 6572  send any further
-000428f0: 0a20 2020 2020 2020 2075 7064 6174 6573  .        updates
-00042900: 2061 626f 7574 2074 6865 2074 6173 6b20   about the task 
-00042910: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-00042920: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00042930: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00042940: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00042950: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00042960: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
-00042970: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00042980: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00042990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000429a0: 2066 2241 7474 656d 7074 696e 6720 746f   f"Attempting to
-000429b0: 2072 6573 6368 6564 756c 6520 7461 736b   reschedule task
-000429c0: 207b 6b65 797d 2c20 7768 6963 6820 7761   {key}, which wa
-000429d0: 7320 6e6f 7420 220a 2020 2020 2020 2020  s not ".        
-000429e0: 2020 2020 2020 2020 2266 6f75 6e64 206f          "found o
-000429f0: 6e20 7468 6520 7363 6865 6475 6c65 722e  n the scheduler.
-00042a00: 2041 626f 7274 696e 6720 7265 7363 6865   Aborting resche
-00042a10: 6475 6c65 2e22 0a20 2020 2020 2020 2020  dule.".         
-00042a20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00042a30: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00042a40: 6966 2074 732e 7374 6174 6520 213d 2022  if ts.state != "
-00042a50: 7072 6f63 6573 7369 6e67 223a 0a20 2020  processing":.   
-00042a60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00042a70: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00042a80: 7220 616e 6420 7473 2e70 726f 6365 7373  r and ts.process
-00042a90: 696e 675f 6f6e 2061 6e64 2074 732e 7072  ing_on and ts.pr
-00042aa0: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
-00042ab0: 6573 7320 213d 2077 6f72 6b65 723a 0a20  ess != worker:. 
-00042ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00042ad0: 6e0a 2020 2020 2020 2020 2320 7472 616e  n.        # tran
-00042ae0: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
-00042af0: 675f 7265 6c65 6173 6564 2077 696c 6c20  g_released will 
-00042b00: 696d 6d65 6469 6174 656c 7920 7375 6767  immediately sugg
-00042b10: 6573 7420 616e 2061 6464 6974 696f 6e61  est an additiona
-00042b20: 6c0a 2020 2020 2020 2020 2320 7472 616e  l.        # tran
-00042b30: 7369 7469 6f6e 2074 6f20 7761 6974 696e  sition to waitin
-00042b40: 6720 6966 2074 6865 2074 6173 6b20 6861  g if the task ha
-00042b50: 7320 616e 7920 7761 6974 6572 7320 6f72  s any waiters or
-00042b60: 2063 6c69 656e 7473 2068 6f6c 6469 6e67   clients holding
-00042b70: 2061 2066 7574 7572 652e 0a20 2020 2020   a future..     
-00042b80: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-00042b90: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
-00042ba0: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
-00042bb0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00042bc0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-00042bd0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00042be0: 2055 7469 6c69 7479 2066 756e 6374 696f   Utility functio
-00042bf0: 6e73 2023 0a20 2020 2023 2323 2323 2323  ns #.    #######
-00042c00: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-00042c10: 2020 2020 6465 6620 6164 645f 7265 736f      def add_reso
-00042c20: 7572 6365 7328 0a20 2020 2020 2020 2073  urces(.        s
-00042c30: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-00042c40: 2c20 7265 736f 7572 6365 733a 2064 6963  , resources: dic
-00042c50: 7420 7c20 4e6f 6e65 203d 204e 6f6e 650a  t | None = None.
-00042c60: 2020 2020 2920 2d3e 204c 6974 6572 616c      ) -> Literal
-00042c70: 5b22 4f4b 225d 3a0a 2020 2020 2020 2020  ["OK"]:.        
-00042c80: 7773 3a20 576f 726b 6572 5374 6174 6520  ws: WorkerState 
-00042c90: 3d20 7365 6c66 2e77 6f72 6b65 7273 5b77  = self.workers[w
-00042ca0: 6f72 6b65 725d 0a20 2020 2020 2020 2069  orker].        i
-00042cb0: 6620 7265 736f 7572 6365 733a 0a20 2020  f resources:.   
-00042cc0: 2020 2020 2020 2020 2077 732e 7265 736f           ws.reso
-00042cd0: 7572 6365 732e 7570 6461 7465 2872 6573  urces.update(res
-00042ce0: 6f75 7263 6573 290a 2020 2020 2020 2020  ources).        
-00042cf0: 7773 2e75 7365 645f 7265 736f 7572 6365  ws.used_resource
-00042d00: 7320 3d20 7b7d 0a20 2020 2020 2020 2066  s = {}.        f
-00042d10: 6f72 2072 6573 6f75 7263 652c 2071 7561  or resource, qua
-00042d20: 6e74 6974 7920 696e 2077 732e 7265 736f  ntity in ws.reso
-00042d30: 7572 6365 732e 6974 656d 7328 293a 0a20  urces.items():. 
-00042d40: 2020 2020 2020 2020 2020 2077 732e 7573             ws.us
-00042d50: 6564 5f72 6573 6f75 7263 6573 5b72 6573  ed_resources[res
-00042d60: 6f75 7263 655d 203d 2030 0a20 2020 2020  ource] = 0.     
-00042d70: 2020 2020 2020 2064 7220 3d20 7365 6c66         dr = self
-00042d80: 2e72 6573 6f75 7263 6573 2e67 6574 2872  .resources.get(r
-00042d90: 6573 6f75 7263 652c 204e 6f6e 6529 0a20  esource, None). 
-00042da0: 2020 2020 2020 2020 2020 2069 6620 6472             if dr
-00042db0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00042dc0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00042dd0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
-00042de0: 655d 203d 2064 7220 3d20 7b7d 0a20 2020  e] = dr = {}.   
-00042df0: 2020 2020 2020 2020 2064 725b 776f 726b           dr[work
-00042e00: 6572 5d20 3d20 7175 616e 7469 7479 0a20  er] = quantity. 
-00042e10: 2020 2020 2020 2072 6574 7572 6e20 224f         return "O
-00042e20: 4b22 0a0a 2020 2020 6465 6620 7265 6d6f  K"..    def remo
-00042e30: 7665 5f72 6573 6f75 7263 6573 2873 656c  ve_resources(sel
-00042e40: 662c 2077 6f72 6b65 723a 2073 7472 2920  f, worker: str) 
-00042e50: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00042e60: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-00042e70: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
-00042e80: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00042e90: 666f 7220 7265 736f 7572 6365 2069 6e20  for resource in 
-00042ea0: 7773 2e72 6573 6f75 7263 6573 3a0a 2020  ws.resources:.  
-00042eb0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
-00042ec0: 656c 662e 7265 736f 7572 6365 732e 7365  elf.resources.se
-00042ed0: 7464 6566 6175 6c74 2872 6573 6f75 7263  tdefault(resourc
-00042ee0: 652c 207b 7d29 0a20 2020 2020 2020 2020  e, {}).         
-00042ef0: 2020 2064 656c 2064 725b 776f 726b 6572     del dr[worker
-00042f00: 5d0a 0a20 2020 2064 6566 2063 6f65 7263  ]..    def coerc
-00042f10: 655f 6164 6472 6573 7328 7365 6c66 2c20  e_address(self, 
-00042f20: 6164 6472 3a20 7374 7220 7c20 7475 706c  addr: str | tupl
-00042f30: 652c 2072 6573 6f6c 7665 3a20 626f 6f6c  e, resolve: bool
-00042f40: 203d 2054 7275 6529 202d 3e20 7374 723a   = True) -> str:
-00042f50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00042f60: 2020 2020 2043 6f65 7263 6520 706f 7373       Coerce poss
-00042f70: 6962 6c65 2069 6e70 7574 2061 6464 7265  ible input addre
-00042f80: 7373 6573 2074 6f20 6361 6e6f 6e69 6361  sses to canonica
-00042f90: 6c20 666f 726d 2e0a 2020 2020 2020 2020  l form..        
-00042fa0: 2a72 6573 6f6c 7665 2a20 6361 6e20 6265  *resolve* can be
-00042fb0: 2064 6973 6162 6c65 6420 666f 7220 7465   disabled for te
-00042fc0: 7374 696e 6720 7769 7468 2066 616b 6520  sting with fake 
-00042fd0: 686f 7374 6e61 6d65 732e 0a0a 2020 2020  hostnames...    
-00042fe0: 2020 2020 4861 6e64 6c65 7320 7374 7269      Handles stri
-00042ff0: 6e67 732c 2074 7570 6c65 732c 206f 7220  ngs, tuples, or 
-00043000: 616c 6961 7365 732e 0a20 2020 2020 2020  aliases..       
-00043010: 2022 2222 0a20 2020 2020 2020 2023 2058   """.        # X
-00043020: 5858 2068 6f77 206d 616e 7920 6164 6472  XX how many addr
-00043030: 6573 732d 7061 7273 696e 6720 726f 7574  ess-parsing rout
-00043040: 696e 6573 2064 6f20 7765 2068 6176 653f  ines do we have?
-00043050: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
-00043060: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
-00043070: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00043080: 6472 203d 2073 656c 662e 616c 6961 7365  dr = self.aliase
-00043090: 735b 6164 6472 5d0a 2020 2020 2020 2020  s[addr].        
-000430a0: 6966 2069 7369 6e73 7461 6e63 6528 6164  if isinstance(ad
-000430b0: 6472 2c20 7475 706c 6529 3a0a 2020 2020  dr, tuple):.    
-000430c0: 2020 2020 2020 2020 6164 6472 203d 2075          addr = u
-000430d0: 6e70 6172 7365 5f68 6f73 745f 706f 7274  nparse_host_port
-000430e0: 282a 6164 6472 290a 2020 2020 2020 2020  (*addr).        
-000430f0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00043100: 6528 6164 6472 2c20 7374 7229 3a0a 2020  e(addr, str):.  
-00043110: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00043120: 5479 7065 4572 726f 7228 6622 6164 6472  TypeError(f"addr
-00043130: 6573 7365 7320 7368 6f75 6c64 2062 6520  esses should be 
-00043140: 7374 7269 6e67 7320 6f72 2074 7570 6c65  strings or tuple
-00043150: 732c 2067 6f74 207b 6164 6472 2172 7d22  s, got {addr!r}"
-00043160: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-00043170: 736f 6c76 653a 0a20 2020 2020 2020 2020  solve:.         
-00043180: 2020 2061 6464 7220 3d20 7265 736f 6c76     addr = resolv
-00043190: 655f 6164 6472 6573 7328 6164 6472 290a  e_address(addr).
-000431a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000431b0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
-000431c0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
-000431d0: 7373 2861 6464 7229 0a0a 2020 2020 2020  ss(addr)..      
-000431e0: 2020 7265 7475 726e 2061 6464 720a 0a20    return addr.. 
-000431f0: 2020 2064 6566 2077 6f72 6b65 7273 5f6c     def workers_l
-00043200: 6973 7428 7365 6c66 2c20 776f 726b 6572  ist(self, worker
-00043210: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-00043220: 207c 204e 6f6e 6529 202d 3e20 6c69 7374   | None) -> list
-00043230: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
-00043240: 2222 0a20 2020 2020 2020 204c 6973 7420  "".        List 
-00043250: 6f66 2071 7561 6c69 6679 696e 6720 776f  of qualifying wo
-00043260: 726b 6572 730a 0a20 2020 2020 2020 2054  rkers..        T
-00043270: 616b 6573 2061 206c 6973 7420 6f66 2077  akes a list of w
-00043280: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-00043290: 6f72 2068 6f73 746e 616d 6573 2e0a 2020  or hostnames..  
-000432a0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
-000432b0: 6c69 7374 206f 6620 616c 6c20 776f 726b  list of all work
-000432c0: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
-000432d0: 7420 6d61 7463 680a 2020 2020 2020 2020  t match.        
-000432e0: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
-000432f0: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-00043300: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00043310: 726e 206c 6973 7428 7365 6c66 2e77 6f72  rn list(self.wor
-00043320: 6b65 7273 290a 0a20 2020 2020 2020 206f  kers)..        o
-00043330: 7574 203d 2073 6574 2829 0a20 2020 2020  ut = set().     
-00043340: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
-00043350: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00043360: 2069 6620 223a 2220 696e 2077 3a0a 2020   if ":" in w:.  
-00043370: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-00043380: 742e 6164 6428 7729 0a20 2020 2020 2020  t.add(w).       
-00043390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000433a0: 2020 2020 2020 2020 2020 206f 7574 2e75             out.u
-000433b0: 7064 6174 6528 7b77 7720 666f 7220 7777  pdate({ww for ww
-000433c0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-000433d0: 2069 6620 7720 696e 2077 777d 2920 2023   if w in ww})  #
-000433e0: 2054 4f44 4f3a 2071 7561 6472 6174 6963   TODO: quadratic
-000433f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00043400: 6c69 7374 286f 7574 290a 0a20 2020 2061  list(out)..    a
-00043410: 7379 6e63 2064 6566 2067 6574 5f70 726f  sync def get_pro
-00043420: 6669 6c65 280a 2020 2020 2020 2020 7365  file(.        se
-00043430: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-00043440: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-00043450: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
-00043460: 2020 2020 2073 6368 6564 756c 6572 3d46       scheduler=F
-00043470: 616c 7365 2c0a 2020 2020 2020 2020 7365  alse,.        se
-00043480: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
-00043490: 2020 2020 6d65 7267 655f 776f 726b 6572      merge_worker
-000434a0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-000434b0: 7374 6172 743d 4e6f 6e65 2c0a 2020 2020  start=None,.    
-000434c0: 2020 2020 7374 6f70 3d4e 6f6e 652c 0a20      stop=None,. 
-000434d0: 2020 2020 2020 206b 6579 3d4e 6f6e 652c         key=None,
-000434e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-000434f0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
-00043500: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00043510: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
-00043520: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
-00043530: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00043540: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
-00043550: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
-00043560: 6574 2877 6f72 6b65 7273 290a 0a20 2020  et(workers)..   
-00043570: 2020 2020 2069 6620 7363 6865 6475 6c65       if schedule
-00043580: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00043590: 6574 7572 6e20 7072 6f66 696c 652e 6765  eturn profile.ge
-000435a0: 745f 7072 6f66 696c 6528 7365 6c66 2e69  t_profile(self.i
-000435b0: 6f5f 6c6f 6f70 2e70 726f 6669 6c65 2c20  o_loop.profile, 
-000435c0: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
-000435d0: 703d 7374 6f70 290a 0a20 2020 2020 2020  p=stop)..       
-000435e0: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
-000435f0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00043600: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
-00043610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043620: 7365 6c66 2e72 7063 2877 292e 7072 6f66  self.rpc(w).prof
-00043630: 696c 6528 7374 6172 743d 7374 6172 742c  ile(start=start,
-00043640: 2073 746f 703d 7374 6f70 2c20 6b65 793d   stop=stop, key=
-00043650: 6b65 792c 2073 6572 7665 723d 7365 7276  key, server=serv
-00043660: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00043670: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-00043680: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-00043690: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-000436a0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-000436b0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-000436c0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-000436d0: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
-000436e0: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
-000436f0: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
-00043700: 6365 7074 696f 6e29 5d0a 0a20 2020 2020  ception)]..     
-00043710: 2020 2069 6620 6d65 7267 655f 776f 726b     if merge_work
-00043720: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00043730: 2072 6573 706f 6e73 6520 3d20 7072 6f66   response = prof
-00043740: 696c 652e 6d65 7267 6528 2a72 6573 756c  ile.merge(*resul
-00043750: 7473 290a 2020 2020 2020 2020 656c 7365  ts).        else
-00043760: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00043770: 7370 6f6e 7365 203d 2064 6963 7428 7a69  sponse = dict(zi
-00043780: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
-00043790: 7473 2929 0a20 2020 2020 2020 2072 6574  ts)).        ret
-000437a0: 7572 6e20 7265 7370 6f6e 7365 0a0a 2020  urn response..  
-000437b0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
-000437c0: 7072 6f66 696c 655f 6d65 7461 6461 7461  profile_metadata
-000437d0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-000437e0: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-000437f0: 2022 4974 6572 6162 6c65 5b73 7472 5d20   "Iterable[str] 
-00043800: 7c20 4e6f 6e65 2220 3d20 4e6f 6e65 2c0a  | None" = None,.
-00043810: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
-00043820: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
-00043830: 2020 7374 6f70 3a20 2266 6c6f 6174 207c    stop: "float |
-00043840: 204e 6f6e 6522 203d 204e 6f6e 652c 0a20   None" = None,. 
-00043850: 2020 2020 2020 2070 726f 6669 6c65 5f63         profile_c
-00043860: 7963 6c65 5f69 6e74 6572 7661 6c3a 2022  ycle_interval: "
-00043870: 7374 7220 7c20 666c 6f61 7420 7c20 4e6f  str | float | No
-00043880: 6e65 2220 3d20 4e6f 6e65 2c0a 2020 2020  ne" = None,.    
-00043890: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
-000438a0: 2020 2064 7420 3d20 7072 6f66 696c 655f     dt = profile_
-000438b0: 6379 636c 655f 696e 7465 7276 616c 206f  cycle_interval o
-000438c0: 7220 6461 736b 2e63 6f6e 6669 672e 6765  r dask.config.ge
-000438d0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
-000438e0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-000438f0: 6572 2e70 726f 6669 6c65 2e63 7963 6c65  er.profile.cycle
-00043900: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-00043910: 2020 2020 6474 203d 2070 6172 7365 5f74      dt = parse_t
-00043920: 696d 6564 656c 7461 2864 742c 2064 6566  imedelta(dt, def
-00043930: 6175 6c74 3d22 6d73 2229 0a0a 2020 2020  ault="ms")..    
-00043940: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
-00043950: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00043960: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-00043970: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
-00043980: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00043990: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-000439a0: 6574 2873 656c 662e 776f 726b 6572 7329  et(self.workers)
-000439b0: 2026 2073 6574 2877 6f72 6b65 7273 290a   & set(workers).
-000439c0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
-000439d0: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-000439e0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-000439f0: 2020 2020 2a28 7365 6c66 2e72 7063 2877      *(self.rpc(w
-00043a00: 292e 7072 6f66 696c 655f 6d65 7461 6461  ).profile_metada
-00043a10: 7461 2873 7461 7274 3d73 7461 7274 2c20  ta(start=start, 
-00043a20: 7374 6f70 3d73 746f 7029 2066 6f72 2077  stop=stop) for w
-00043a30: 2069 6e20 776f 726b 6572 7329 2c0a 2020   in workers),.  
-00043a40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00043a50: 5f65 7863 6570 7469 6f6e 733d 5472 7565  _exceptions=True
-00043a60: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00043a70: 2020 2020 2072 6573 756c 7473 203d 205b       results = [
-00043a80: 7220 666f 7220 7220 696e 2072 6573 756c  r for r in resul
-00043a90: 7473 2069 6620 6e6f 7420 6973 696e 7374  ts if not isinst
-00043aa0: 616e 6365 2872 2c20 4578 6365 7074 696f  ance(r, Exceptio
-00043ab0: 6e29 5d0a 2020 2020 2020 2020 636f 756e  n)].        coun
-00043ac0: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
-00043ad0: 2020 2028 7469 6d65 2c20 7375 6d28 706c     (time, sum(pl
-00043ae0: 7563 6b28 312c 2067 726f 7570 2929 290a  uck(1, group))).
-00043af0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00043b00: 7469 6d65 2c20 6772 6f75 7020 696e 2069  time, group in i
-00043b10: 7465 7274 6f6f 6c73 2e67 726f 7570 6279  tertools.groupby
-00043b20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00043b30: 2020 6d65 7267 655f 736f 7274 6564 280a    merge_sorted(.
-00043b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043b50: 2020 2020 2a28 765b 2263 6f75 6e74 7322      *(v["counts"
-00043b60: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
-00043b70: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00043b80: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00043b90: 2020 2020 2020 2020 6c61 6d62 6461 2074          lambda t
-00043ba0: 3a20 745b 305d 202f 2f20 6474 202a 2064  : t[0] // dt * d
-00043bb0: 742c 0a20 2020 2020 2020 2020 2020 2029  t,.            )
-00043bc0: 0a20 2020 2020 2020 205d 0a0a 2020 2020  .        ]..    
-00043bd0: 2020 2020 6b65 7973 3a20 6469 6374 5b73      keys: dict[s
-00043be0: 7472 2c20 6c69 7374 5b6c 6973 745d 5d20  tr, list[list]] 
-00043bf0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00043c00: 6b3a 205b 5d20 666f 7220 7620 696e 2072  k: [] for v in r
-00043c10: 6573 756c 7473 2066 6f72 2074 2c20 6420  esults for t, d 
-00043c20: 696e 2076 5b22 6b65 7973 225d 2066 6f72  in v["keys"] for
-00043c30: 206b 2069 6e20 640a 2020 2020 2020 2020   k in d.        
-00043c40: 7d0a 0a20 2020 2020 2020 2067 726f 7570  }..        group
-00043c50: 7331 203d 205b 765b 226b 6579 7322 5d20  s1 = [v["keys"] 
-00043c60: 666f 7220 7620 696e 2072 6573 756c 7473  for v in results
-00043c70: 5d0a 2020 2020 2020 2020 6772 6f75 7073  ].        groups
-00043c80: 3220 3d20 6c69 7374 286d 6572 6765 5f73  2 = list(merge_s
-00043c90: 6f72 7465 6428 2a67 726f 7570 7331 2c20  orted(*groups1, 
-00043ca0: 6b65 793d 6669 7273 7429 290a 0a20 2020  key=first))..   
-00043cb0: 2020 2020 206c 6173 7420 3d20 300a 2020       last = 0.  
-00043cc0: 2020 2020 2020 666f 7220 742c 2064 2069        for t, d i
-00043cd0: 6e20 6772 6f75 7073 323a 0a20 2020 2020  n groups2:.     
-00043ce0: 2020 2020 2020 2074 7420 3d20 7420 2f2f         tt = t //
-00043cf0: 2064 7420 2a20 6474 0a20 2020 2020 2020   dt * dt.       
-00043d00: 2020 2020 2069 6620 7474 203e 206c 6173       if tt > las
-00043d10: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00043d20: 2020 206c 6173 7420 3d20 7474 0a20 2020     last = tt.   
-00043d30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00043d40: 2076 2069 6e20 6b65 7973 2e76 616c 7565   v in keys.value
-00043d50: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00043d60: 2020 2020 2020 2020 2076 2e61 7070 656e           v.appen
-00043d70: 6428 5b74 742c 2030 5d29 0a20 2020 2020  d([tt, 0]).     
-00043d80: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-00043d90: 696e 2064 2e69 7465 6d73 2829 3a0a 2020  in d.items():.  
-00043da0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00043db0: 7973 5b6b 5d5b 2d31 5d5b 315d 202b 3d20  ys[k][-1][1] += 
-00043dc0: 760a 0a20 2020 2020 2020 2072 6574 7572  v..        retur
-00043dd0: 6e20 7b22 636f 756e 7473 223a 2063 6f75  n {"counts": cou
-00043de0: 6e74 732c 2022 6b65 7973 223a 206b 6579  nts, "keys": key
-00043df0: 737d 0a0a 2020 2020 6173 796e 6320 6465  s}..    async de
-00043e00: 6620 7065 7266 6f72 6d61 6e63 655f 7265  f performance_re
-00043e10: 706f 7274 280a 2020 2020 2020 2020 7365  port(.        se
-00043e20: 6c66 2c20 7374 6172 743a 2066 6c6f 6174  lf, start: float
-00043e30: 2c20 6c61 7374 5f63 6f75 6e74 3a20 696e  , last_count: in
-00043e40: 742c 2063 6f64 653a 2073 7472 203d 2022  t, code: str = "
-00043e50: 222c 206d 6f64 653a 2073 7472 207c 204e  ", mode: str | N
-00043e60: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-00043e70: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00043e80: 2073 746f 7020 3d20 7469 6d65 2829 0a20   stop = time(). 
-00043e90: 2020 2020 2020 2023 2050 726f 6669 6c65         # Profile
-00043ea0: 730a 2020 2020 2020 2020 636f 6d70 7574  s.        comput
-00043eb0: 652c 2073 6368 6564 756c 6572 2c20 776f  e, scheduler, wo
-00043ec0: 726b 6572 7320 3d20 6177 6169 7420 6173  rkers = await as
-00043ed0: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
-00043ee0: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-00043ef0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00043f00: 662e 6765 745f 7072 6f66 696c 6528 7374  f.get_profile(st
-00043f10: 6172 743d 7374 6172 7429 2c0a 2020 2020  art=start),.    
-00043f20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00043f30: 2e67 6574 5f70 726f 6669 6c65 2873 6368  .get_profile(sch
-00043f40: 6564 756c 6572 3d54 7275 652c 2073 7461  eduler=True, sta
-00043f50: 7274 3d73 7461 7274 292c 0a20 2020 2020  rt=start),.     
-00043f60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00043f70: 6765 745f 7072 6f66 696c 6528 7365 7276  get_profile(serv
-00043f80: 6572 3d54 7275 652c 2073 7461 7274 3d73  er=True, start=s
-00043f90: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
-00043fa0: 2020 205d 0a20 2020 2020 2020 2029 0a20     ].        ). 
-00043fb0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
-00043fc0: 7269 6275 7465 6420 696d 706f 7274 2070  ributed import p
-00043fd0: 726f 6669 6c65 0a0a 2020 2020 2020 2020  rofile..        
-00043fe0: 6465 6620 7072 6f66 696c 655f 746f 5f66  def profile_to_f
-00043ff0: 6967 7572 6528 7374 6174 6529 3a0a 2020  igure(state):.  
-00044000: 2020 2020 2020 2020 2020 6461 7461 203d            data =
-00044010: 2070 726f 6669 6c65 2e70 6c6f 745f 6461   profile.plot_da
-00044020: 7461 2873 7461 7465 290a 2020 2020 2020  ta(state).      
-00044030: 2020 2020 2020 6669 6775 7265 2c20 736f        figure, so
-00044040: 7572 6365 203d 2070 726f 6669 6c65 2e70  urce = profile.p
-00044050: 6c6f 745f 6669 6775 7265 2864 6174 612c  lot_figure(data,
-00044060: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
-00044070: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00044080: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00044090: 6669 6775 7265 0a0a 2020 2020 2020 2020  figure..        
-000440a0: 636f 6d70 7574 652c 2073 6368 6564 756c  compute, schedul
-000440b0: 6572 2c20 776f 726b 6572 7320 3d20 6d61  er, workers = ma
-000440c0: 7028 0a20 2020 2020 2020 2020 2020 2070  p(.            p
-000440d0: 726f 6669 6c65 5f74 6f5f 6669 6775 7265  rofile_to_figure
-000440e0: 2c20 2863 6f6d 7075 7465 2c20 7363 6865  , (compute, sche
-000440f0: 6475 6c65 722c 2077 6f72 6b65 7273 290a  duler, workers).
-00044100: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00044110: 2020 2023 2054 6173 6b20 7374 7265 616d     # Task stream
-00044120: 0a20 2020 2020 2020 2074 6173 6b5f 7374  .        task_st
-00044130: 7265 616d 203d 2073 656c 662e 6765 745f  ream = self.get_
-00044140: 7461 736b 5f73 7472 6561 6d28 7374 6172  task_stream(star
-00044150: 743d 7374 6172 7429 0a20 2020 2020 2020  t=start).       
-00044160: 2074 6f74 616c 5f74 6173 6b73 203d 206c   total_tasks = l
-00044170: 656e 2874 6173 6b5f 7374 7265 616d 290a  en(task_stream).
-00044180: 2020 2020 2020 2020 7469 6d65 7370 656e          timespen
-00044190: 743a 2064 6566 6175 6c74 6469 6374 5b73  t: defaultdict[s
-000441a0: 7472 2c20 666c 6f61 745d 203d 2064 6566  tr, float] = def
-000441b0: 6175 6c74 6469 6374 2866 6c6f 6174 290a  aultdict(float).
-000441c0: 2020 2020 2020 2020 666f 7220 6420 696e          for d in
-000441d0: 2074 6173 6b5f 7374 7265 616d 3a0a 2020   task_stream:.  
-000441e0: 2020 2020 2020 2020 2020 666f 7220 7820            for x 
-000441f0: 696e 2064 5b22 7374 6172 7473 746f 7073  in d["startstops
-00044200: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-00044210: 2020 2020 7469 6d65 7370 656e 745b 785b      timespent[x[
-00044220: 2261 6374 696f 6e22 5d5d 202b 3d20 785b  "action"]] += x[
-00044230: 2273 746f 7022 5d20 2d20 785b 2273 7461  "stop"] - x["sta
-00044240: 7274 225d 0a20 2020 2020 2020 2074 6173  rt"].        tas
-00044250: 6b73 5f74 696d 696e 6773 203d 2022 220a  ks_timings = "".
-00044260: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-00044270: 2073 6f72 7465 6428 7469 6d65 7370 656e   sorted(timespen
-00044280: 742e 6b65 7973 2829 293a 0a20 2020 2020  t.keys()):.     
-00044290: 2020 2020 2020 2074 6173 6b73 5f74 696d         tasks_tim
-000442a0: 696e 6773 202b 3d20 6622 5c6e 3c6c 693e  ings += f"\n<li>
-000442b0: 207b 6b7d 2074 696d 653a 207b 666f 726d   {k} time: {form
-000442c0: 6174 5f74 696d 6528 7469 6d65 7370 656e  at_time(timespen
-000442d0: 745b 6b5d 297d 203c 2f6c 693e 220a 0a20  t[k])} </li>".. 
-000442e0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
-000442f0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-00044300: 642e 636f 6d70 6f6e 656e 7473 2e73 6368  d.components.sch
-00044310: 6564 756c 6572 2069 6d70 6f72 7420 7461  eduler import ta
-00044320: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
-00044330: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
-00044340: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
-00044350: 7374 6963 732e 7461 736b 5f73 7472 6561  stics.task_strea
-00044360: 6d20 696d 706f 7274 2072 6563 7461 6e67  m import rectang
-00044370: 6c65 730a 0a20 2020 2020 2020 2072 6563  les..        rec
-00044380: 7473 203d 2072 6563 7461 6e67 6c65 7328  ts = rectangles(
-00044390: 7461 736b 5f73 7472 6561 6d29 0a20 2020  task_stream).   
-000443a0: 2020 2020 2073 6f75 7263 652c 2074 6173       source, tas
-000443b0: 6b5f 7374 7265 616d 203d 2074 6173 6b5f  k_stream = task_
-000443c0: 7374 7265 616d 5f66 6967 7572 6528 7369  stream_figure(si
-000443d0: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
-000443e0: 6368 5f62 6f74 6822 290a 2020 2020 2020  ch_both").      
-000443f0: 2020 736f 7572 6365 2e64 6174 612e 7570    source.data.up
-00044400: 6461 7465 2872 6563 7473 290a 0a20 2020  date(rects)..   
-00044410: 2020 2020 2023 2042 616e 6477 6964 7468       # Bandwidth
-00044420: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
-00044430: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
-00044440: 6172 642e 636f 6d70 6f6e 656e 7473 2e73  ard.components.s
-00044450: 6368 6564 756c 6572 2069 6d70 6f72 7420  cheduler import 
-00044460: 280a 2020 2020 2020 2020 2020 2020 4261  (.            Ba
-00044470: 6e64 7769 6474 6854 7970 6573 2c0a 2020  ndwidthTypes,.  
-00044480: 2020 2020 2020 2020 2020 4261 6e64 7769            Bandwi
-00044490: 6474 6857 6f72 6b65 7273 2c0a 2020 2020  dthWorkers,.    
-000444a0: 2020 2020 290a 0a20 2020 2020 2020 2062      )..        b
-000444b0: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
-000444c0: 203d 2042 616e 6477 6964 7468 576f 726b   = BandwidthWork
-000444d0: 6572 7328 7365 6c66 2c20 7369 7a69 6e67  ers(self, sizing
-000444e0: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
-000444f0: 6f74 6822 290a 2020 2020 2020 2020 6261  oth").        ba
-00044500: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
-00044510: 7570 6461 7465 2829 0a20 2020 2020 2020  update().       
-00044520: 2062 616e 6477 6964 7468 5f74 7970 6573   bandwidth_types
-00044530: 203d 2042 616e 6477 6964 7468 5479 7065   = BandwidthType
-00044540: 7328 7365 6c66 2c20 7369 7a69 6e67 5f6d  s(self, sizing_m
-00044550: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-00044560: 6822 290a 2020 2020 2020 2020 6261 6e64  h").        band
-00044570: 7769 6474 685f 7479 7065 732e 7570 6461  width_types.upda
-00044580: 7465 2829 0a0a 2020 2020 2020 2020 2320  te()..        # 
-00044590: 5379 7374 656d 206d 6f6e 6974 6f72 0a20  System monitor. 
-000445a0: 2020 2020 2020 2066 726f 6d20 6469 7374         from dist
-000445b0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-000445c0: 642e 636f 6d70 6f6e 656e 7473 2e73 6861  d.components.sha
-000445d0: 7265 6420 696d 706f 7274 2053 7973 7465  red import Syste
-000445e0: 6d4d 6f6e 6974 6f72 0a0a 2020 2020 2020  mMonitor..      
-000445f0: 2020 7379 736d 6f6e 203d 2053 7973 7465    sysmon = Syste
-00044600: 6d4d 6f6e 6974 6f72 2873 656c 662c 206c  mMonitor(self, l
-00044610: 6173 745f 636f 756e 743d 6c61 7374 5f63  ast_count=last_c
-00044620: 6f75 6e74 2c20 7369 7a69 6e67 5f6d 6f64  ount, sizing_mod
-00044630: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00044640: 290a 2020 2020 2020 2020 7379 736d 6f6e  ).        sysmon
-00044650: 2e75 7064 6174 6528 290a 0a20 2020 2020  .update()..     
-00044660: 2020 2023 2053 6368 6564 756c 6572 206c     # Scheduler l
-00044670: 6f67 730a 2020 2020 2020 2020 6672 6f6d  ogs.        from
-00044680: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-00044690: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
-000446a0: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
-000446b0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-000446c0: 205f 424f 4b45 485f 5354 594c 4553 5f4b   _BOKEH_STYLES_K
-000446d0: 5741 5247 532c 0a20 2020 2020 2020 2020  WARGS,.         
-000446e0: 2020 2053 6368 6564 756c 6572 4c6f 6773     SchedulerLogs
-000446f0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00044700: 2020 2020 206c 6f67 7320 3d20 5363 6865       logs = Sche
-00044710: 6475 6c65 724c 6f67 7328 7365 6c66 2c20  dulerLogs(self, 
-00044720: 7374 6172 743d 7374 6172 7429 0a0a 2020  start=start)..  
-00044730: 2020 2020 2020 6672 6f6d 2062 6f6b 6568        from bokeh
-00044740: 2e6d 6f64 656c 7320 696d 706f 7274 2044  .models import D
-00044750: 6976 2c20 5461 6273 0a0a 2020 2020 2020  iv, Tabs..      
-00044760: 2020 696d 706f 7274 2064 6973 7472 6962    import distrib
-00044770: 7574 6564 0a20 2020 2020 2020 2066 726f  uted.        fro
-00044780: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-00044790: 7368 626f 6172 642e 636f 7265 2069 6d70  shboard.core imp
-000447a0: 6f72 7420 5461 6250 616e 656c 0a0a 2020  ort TabPanel..  
-000447b0: 2020 2020 2020 2320 4854 4d4c 0a20 2020        # HTML.   
-000447c0: 2020 2020 2068 746d 6c20 3d20 2222 220a       html = """.
-000447d0: 2020 2020 2020 2020 3c68 313e 2044 6173          <h1> Das
-000447e0: 6b20 5065 7266 6f72 6d61 6e63 6520 5265  k Performance Re
-000447f0: 706f 7274 203c 2f68 313e 0a0a 2020 2020  port </h1>..    
-00044800: 2020 2020 3c69 3e20 5365 6c65 6374 2064      <i> Select d
-00044810: 6966 6665 7265 6e74 2074 6162 7320 6f6e  ifferent tabs on
-00044820: 2074 6865 2074 6f70 2066 6f72 2061 6464   the top for add
-00044830: 6974 696f 6e61 6c20 696e 666f 726d 6174  itional informat
-00044840: 696f 6e20 3c2f 693e 0a0a 2020 2020 2020  ion </i>..      
-00044850: 2020 3c68 323e 2044 7572 6174 696f 6e3a    <h2> Duration:
-00044860: 207b 7469 6d65 7d20 3c2f 6832 3e0a 2020   {time} </h2>.  
-00044870: 2020 2020 2020 3c68 323e 2054 6173 6b73        <h2> Tasks
-00044880: 2049 6e66 6f72 6d61 7469 6f6e 203c 2f68   Information </h
-00044890: 323e 0a20 2020 2020 2020 203c 756c 3e0a  2>.        <ul>.
-000448a0: 2020 2020 2020 2020 203c 6c69 3e20 6e75           <li> nu
-000448b0: 6d62 6572 206f 6620 7461 736b 733a 207b  mber of tasks: {
-000448c0: 6e74 6173 6b73 7d20 3c2f 6c69 3e0a 2020  ntasks} </li>.  
-000448d0: 2020 2020 2020 207b 7461 736b 735f 7469         {tasks_ti
-000448e0: 6d69 6e67 737d 0a20 2020 2020 2020 203c  mings}.        <
-000448f0: 2f75 6c3e 0a0a 2020 2020 2020 2020 3c68  /ul>..        <h
-00044900: 323e 2053 6368 6564 756c 6572 2049 6e66  2> Scheduler Inf
-00044910: 6f72 6d61 7469 6f6e 203c 2f68 323e 0a20  ormation </h2>. 
-00044920: 2020 2020 2020 203c 756c 3e0a 2020 2020         <ul>.    
-00044930: 2020 2020 2020 3c6c 693e 2041 6464 7265        <li> Addre
-00044940: 7373 3a20 7b61 6464 7265 7373 7d20 3c2f  ss: {address} </
-00044950: 6c69 3e0a 2020 2020 2020 2020 2020 3c6c  li>.          <l
-00044960: 693e 2057 6f72 6b65 7273 3a20 7b6e 776f  i> Workers: {nwo
-00044970: 726b 6572 737d 203c 2f6c 693e 0a20 2020  rkers} </li>.   
-00044980: 2020 2020 2020 203c 6c69 3e20 5468 7265         <li> Thre
-00044990: 6164 733a 207b 7468 7265 6164 737d 203c  ads: {threads} <
-000449a0: 2f6c 693e 0a20 2020 2020 2020 2020 203c  /li>.          <
-000449b0: 6c69 3e20 4d65 6d6f 7279 3a20 7b6d 656d  li> Memory: {mem
-000449c0: 6f72 797d 203c 2f6c 693e 0a20 2020 2020  ory} </li>.     
-000449d0: 2020 2020 203c 6c69 3e20 4461 736b 2056       <li> Dask V
-000449e0: 6572 7369 6f6e 3a20 7b64 6173 6b5f 7665  ersion: {dask_ve
-000449f0: 7273 696f 6e7d 203c 2f6c 693e 0a20 2020  rsion} </li>.   
-00044a00: 2020 2020 2020 203c 6c69 3e20 4461 736b         <li> Dask
-00044a10: 2e44 6973 7472 6962 7574 6564 2056 6572  .Distributed Ver
-00044a20: 7369 6f6e 3a20 7b64 6973 7472 6962 7574  sion: {distribut
-00044a30: 6564 5f76 6572 7369 6f6e 7d20 3c2f 6c69  ed_version} </li
-00044a40: 3e0a 2020 2020 2020 2020 3c2f 756c 3e0a  >.        </ul>.
-00044a50: 0a20 2020 2020 2020 203c 6832 3e20 4361  .        <h2> Ca
-00044a60: 6c6c 696e 6720 436f 6465 203c 2f68 323e  lling Code </h2>
-00044a70: 0a20 2020 2020 2020 203c 7072 653e 0a7b  .        <pre>.{
-00044a80: 636f 6465 7d0a 2020 2020 2020 2020 3c2f  code}.        </
-00044a90: 7072 653e 0a20 2020 2020 2020 2022 2222  pre>.        """
-00044aa0: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
-00044ab0: 2020 2020 2074 696d 653d 666f 726d 6174       time=format
-00044ac0: 5f74 696d 6528 7374 6f70 202d 2073 7461  _time(stop - sta
-00044ad0: 7274 292c 0a20 2020 2020 2020 2020 2020  rt),.           
-00044ae0: 206e 7461 736b 733d 746f 7461 6c5f 7461   ntasks=total_ta
-00044af0: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
-00044b00: 2074 6173 6b73 5f74 696d 696e 6773 3d74   tasks_timings=t
-00044b10: 6173 6b73 5f74 696d 696e 6773 2c0a 2020  asks_timings,.  
-00044b20: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00044b30: 733d 7365 6c66 2e61 6464 7265 7373 2c0a  s=self.address,.
-00044b40: 2020 2020 2020 2020 2020 2020 6e77 6f72              nwor
-00044b50: 6b65 7273 3d6c 656e 2873 656c 662e 776f  kers=len(self.wo
-00044b60: 726b 6572 7329 2c0a 2020 2020 2020 2020  rkers),.        
-00044b70: 2020 2020 7468 7265 6164 733d 7375 6d28      threads=sum(
-00044b80: 7773 2e6e 7468 7265 6164 7320 666f 7220  ws.nthreads for 
-00044b90: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-00044ba0: 7273 2e76 616c 7565 7328 2929 2c0a 2020  rs.values()),.  
-00044bb0: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
-00044bc0: 3d66 6f72 6d61 745f 6279 7465 7328 7375  =format_bytes(su
-00044bd0: 6d28 7773 2e6d 656d 6f72 795f 6c69 6d69  m(ws.memory_limi
-00044be0: 7420 666f 7220 7773 2069 6e20 7365 6c66  t for ws in self
-00044bf0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00044c00: 2929 292c 0a20 2020 2020 2020 2020 2020  ))),.           
-00044c10: 2063 6f64 653d 636f 6465 2c0a 2020 2020   code=code,.    
-00044c20: 2020 2020 2020 2020 6461 736b 5f76 6572          dask_ver
-00044c30: 7369 6f6e 3d64 6173 6b2e 5f5f 7665 7273  sion=dask.__vers
-00044c40: 696f 6e5f 5f2c 0a20 2020 2020 2020 2020  ion__,.         
-00044c50: 2020 2064 6973 7472 6962 7574 6564 5f76     distributed_v
-00044c60: 6572 7369 6f6e 3d64 6973 7472 6962 7574  ersion=distribut
-00044c70: 6564 2e5f 5f76 6572 7369 6f6e 5f5f 2c0a  ed.__version__,.
-00044c80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00044c90: 2020 6874 6d6c 203d 2044 6976 2874 6578    html = Div(tex
-00044ca0: 743d 6874 6d6c 2c20 2a2a 5f42 4f4b 4548  t=html, **_BOKEH
-00044cb0: 5f53 5459 4c45 535f 4b57 4152 4753 290a  _STYLES_KWARGS).
-00044cc0: 0a20 2020 2020 2020 2068 746d 6c20 3d20  .        html = 
-00044cd0: 5461 6250 616e 656c 2863 6869 6c64 3d68  TabPanel(child=h
-00044ce0: 746d 6c2c 2074 6974 6c65 3d22 5375 6d6d  tml, title="Summ
-00044cf0: 6172 7922 290a 2020 2020 2020 2020 636f  ary").        co
-00044d00: 6d70 7574 6520 3d20 5461 6250 616e 656c  mpute = TabPanel
-00044d10: 2863 6869 6c64 3d63 6f6d 7075 7465 2c20  (child=compute, 
-00044d20: 7469 746c 653d 2257 6f72 6b65 7220 5072  title="Worker Pr
-00044d30: 6f66 696c 6520 2863 6f6d 7075 7465 2922  ofile (compute)"
-00044d40: 290a 2020 2020 2020 2020 776f 726b 6572  ).        worker
-00044d50: 7320 3d20 5461 6250 616e 656c 2863 6869  s = TabPanel(chi
-00044d60: 6c64 3d77 6f72 6b65 7273 2c20 7469 746c  ld=workers, titl
-00044d70: 653d 2257 6f72 6b65 7220 5072 6f66 696c  e="Worker Profil
-00044d80: 6520 2861 646d 696e 6973 7472 6174 6976  e (administrativ
-00044d90: 6529 2229 0a20 2020 2020 2020 2073 6368  e)").        sch
-00044da0: 6564 756c 6572 203d 2054 6162 5061 6e65  eduler = TabPane
-00044db0: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
-00044dc0: 6869 6c64 3d73 6368 6564 756c 6572 2c20  hild=scheduler, 
-00044dd0: 7469 746c 653d 2253 6368 6564 756c 6572  title="Scheduler
-00044de0: 2050 726f 6669 6c65 2028 6164 6d69 6e69   Profile (admini
-00044df0: 7374 7261 7469 7665 2922 0a20 2020 2020  strative)".     
-00044e00: 2020 2029 0a20 2020 2020 2020 2074 6173     ).        tas
-00044e10: 6b5f 7374 7265 616d 203d 2054 6162 5061  k_stream = TabPa
-00044e20: 6e65 6c28 6368 696c 643d 7461 736b 5f73  nel(child=task_s
-00044e30: 7472 6561 6d2c 2074 6974 6c65 3d22 5461  tream, title="Ta
-00044e40: 736b 2053 7472 6561 6d22 290a 2020 2020  sk Stream").    
-00044e50: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
-00044e60: 726b 6572 7320 3d20 5461 6250 616e 656c  rkers = TabPanel
-00044e70: 280a 2020 2020 2020 2020 2020 2020 6368  (.            ch
-00044e80: 696c 643d 6261 6e64 7769 6474 685f 776f  ild=bandwidth_wo
-00044e90: 726b 6572 732e 726f 6f74 2c20 7469 746c  rkers.root, titl
-00044ea0: 653d 2242 616e 6477 6964 7468 2028 576f  e="Bandwidth (Wo
-00044eb0: 726b 6572 7329 220a 2020 2020 2020 2020  rkers)".        
-00044ec0: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
-00044ed0: 6474 685f 7479 7065 7320 3d20 5461 6250  dth_types = TabP
-00044ee0: 616e 656c 280a 2020 2020 2020 2020 2020  anel(.          
-00044ef0: 2020 6368 696c 643d 6261 6e64 7769 6474    child=bandwidt
-00044f00: 685f 7479 7065 732e 726f 6f74 2c20 7469  h_types.root, ti
-00044f10: 746c 653d 2242 616e 6477 6964 7468 2028  tle="Bandwidth (
-00044f20: 5479 7065 7329 220a 2020 2020 2020 2020  Types)".        
-00044f30: 290a 2020 2020 2020 2020 7379 7374 656d  ).        system
-00044f40: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
-00044f50: 643d 7379 736d 6f6e 2e72 6f6f 742c 2074  d=sysmon.root, t
-00044f60: 6974 6c65 3d22 5379 7374 656d 2229 0a20  itle="System"). 
-00044f70: 2020 2020 2020 206c 6f67 7320 3d20 5461         logs = Ta
-00044f80: 6250 616e 656c 2863 6869 6c64 3d6c 6f67  bPanel(child=log
-00044f90: 732e 726f 6f74 2c20 7469 746c 653d 2253  s.root, title="S
-00044fa0: 6368 6564 756c 6572 204c 6f67 7322 290a  cheduler Logs").
-00044fb0: 0a20 2020 2020 2020 2074 6162 7320 3d20  .        tabs = 
-00044fc0: 5461 6273 280a 2020 2020 2020 2020 2020  Tabs(.          
-00044fd0: 2020 7461 6273 3d5b 0a20 2020 2020 2020    tabs=[.       
-00044fe0: 2020 2020 2020 2020 2068 746d 6c2c 0a20           html,. 
-00044ff0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00045000: 6173 6b5f 7374 7265 616d 2c0a 2020 2020  ask_stream,.    
-00045010: 2020 2020 2020 2020 2020 2020 7379 7374              syst
-00045020: 656d 2c0a 2020 2020 2020 2020 2020 2020  em,.            
-00045030: 2020 2020 6c6f 6773 2c0a 2020 2020 2020      logs,.      
-00045040: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-00045050: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00045060: 2020 2077 6f72 6b65 7273 2c0a 2020 2020     workers,.    
-00045070: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-00045080: 6475 6c65 722c 0a20 2020 2020 2020 2020  duler,.         
-00045090: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
-000450a0: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
-000450b0: 2020 2020 2020 2020 2020 6261 6e64 7769            bandwi
-000450c0: 6474 685f 7479 7065 732c 0a20 2020 2020  dth_types,.     
-000450d0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000450e0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
-000450f0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00045100: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00045110: 2020 2020 2066 726f 6d20 626f 6b65 682e       from bokeh.
-00045120: 636f 7265 2e74 656d 706c 6174 6573 2069  core.templates i
-00045130: 6d70 6f72 7420 6765 745f 656e 760a 2020  mport get_env.  
-00045140: 2020 2020 2020 6672 6f6d 2062 6f6b 6568        from bokeh
-00045150: 2e70 6c6f 7474 696e 6720 696d 706f 7274  .plotting import
-00045160: 206f 7574 7075 745f 6669 6c65 2c20 7361   output_file, sa
-00045170: 7665 0a0a 2020 2020 2020 2020 7769 7468  ve..        with
-00045180: 2074 6d70 6669 6c65 2865 7874 656e 7369   tmpfile(extensi
-00045190: 6f6e 3d22 2e68 746d 6c22 2920 6173 2066  on=".html") as f
-000451a0: 6e3a 0a20 2020 2020 2020 2020 2020 206f  n:.            o
-000451b0: 7574 7075 745f 6669 6c65 2866 696c 656e  utput_file(filen
-000451c0: 616d 653d 666e 2c20 7469 746c 653d 2244  ame=fn, title="D
-000451d0: 6173 6b20 5065 7266 6f72 6d61 6e63 6520  ask Performance 
-000451e0: 5265 706f 7274 222c 206d 6f64 653d 6d6f  Report", mode=mo
-000451f0: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
-00045200: 7465 6d70 6c61 7465 5f64 6972 6563 746f  template_directo
-00045210: 7279 203d 206f 732e 7061 7468 2e6a 6f69  ry = os.path.joi
-00045220: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00045230: 2020 206f 732e 7061 7468 2e64 6972 6e61     os.path.dirna
-00045240: 6d65 286f 732e 7061 7468 2e61 6273 7061  me(os.path.abspa
-00045250: 7468 285f 5f66 696c 655f 5f29 292c 2022  th(__file__)), "
-00045260: 6461 7368 626f 6172 6422 2c20 2274 656d  dashboard", "tem
-00045270: 706c 6174 6573 220a 2020 2020 2020 2020  plates".        
-00045280: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00045290: 2020 7465 6d70 6c61 7465 5f65 6e76 6972    template_envir
-000452a0: 6f6e 6d65 6e74 203d 2067 6574 5f65 6e76  onment = get_env
-000452b0: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
-000452c0: 656d 706c 6174 655f 656e 7669 726f 6e6d  emplate_environm
-000452d0: 656e 742e 6c6f 6164 6572 2e73 6561 7263  ent.loader.searc
-000452e0: 6870 6174 682e 6170 7065 6e64 2874 656d  hpath.append(tem
-000452f0: 706c 6174 655f 6469 7265 6374 6f72 7929  plate_directory)
-00045300: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
-00045310: 706c 6174 6520 3d20 7465 6d70 6c61 7465  plate = template
-00045320: 5f65 6e76 6972 6f6e 6d65 6e74 2e67 6574  _environment.get
-00045330: 5f74 656d 706c 6174 6528 2270 6572 666f  _template("perfo
-00045340: 726d 616e 6365 5f72 6570 6f72 742e 6874  rmance_report.ht
-00045350: 6d6c 2229 0a20 2020 2020 2020 2020 2020  ml").           
-00045360: 2073 6176 6528 7461 6273 2c20 6669 6c65   save(tabs, file
-00045370: 6e61 6d65 3d66 6e2c 2074 656d 706c 6174  name=fn, templat
-00045380: 653d 7465 6d70 6c61 7465 290a 0a20 2020  e=template)..   
-00045390: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
-000453a0: 656e 2866 6e29 2061 7320 663a 0a20 2020  en(fn) as f:.   
-000453b0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-000453c0: 6120 3d20 662e 7265 6164 2829 0a0a 2020  a = f.read()..  
-000453d0: 2020 2020 2020 7265 7475 726e 2064 6174        return dat
-000453e0: 610a 0a20 2020 2061 7379 6e63 2064 6566  a..    async def
-000453f0: 2067 6574 5f77 6f72 6b65 725f 6c6f 6773   get_worker_logs
-00045400: 2873 656c 662c 206e 3d4e 6f6e 652c 2077  (self, n=None, w
-00045410: 6f72 6b65 7273 3d4e 6f6e 652c 206e 616e  orkers=None, nan
-00045420: 6e79 3d46 616c 7365 293a 0a20 2020 2020  ny=False):.     
-00045430: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
-00045440: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
-00045450: 7428 0a20 2020 2020 2020 2020 2020 206d  t(.            m
-00045460: 7367 3d7b 226f 7022 3a20 2267 6574 5f6c  sg={"op": "get_l
-00045470: 6f67 7322 2c20 226e 223a 206e 7d2c 2077  ogs", "n": n}, w
-00045480: 6f72 6b65 7273 3d77 6f72 6b65 7273 2c20  orkers=workers, 
-00045490: 6e61 6e6e 793d 6e61 6e6e 790a 2020 2020  nanny=nanny.    
-000454a0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-000454b0: 7475 726e 2072 6573 756c 7473 0a0a 2020  turn results..  
-000454c0: 2020 6465 6620 6c6f 675f 6576 656e 7428    def log_event(
-000454d0: 7365 6c66 2c20 746f 7069 633a 2073 7472  self, topic: str
-000454e0: 207c 2043 6f6c 6c65 6374 696f 6e5b 7374   | Collection[st
-000454f0: 725d 2c20 6d73 673a 2041 6e79 2920 2d3e  r], msg: Any) ->
-00045500: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00045510: 2222 4c6f 6720 616e 2065 7665 6e74 2075  ""Log an event u
-00045520: 6e64 6572 2061 2067 6976 656e 2074 6f70  nder a given top
-00045530: 6963 0a0a 2020 2020 2020 2020 5061 7261  ic..        Para
-00045540: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
-00045550: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
-00045560: 2020 746f 7069 6320 3a20 7374 722c 206c    topic : str, l
-00045570: 6973 745b 7374 725d 0a20 2020 2020 2020  ist[str].       
-00045580: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-00045590: 2074 6f70 6963 2075 6e64 6572 2077 6869   topic under whi
-000455a0: 6368 2074 6f20 6c6f 6720 616e 2065 7665  ch to log an eve
-000455b0: 6e74 2e20 546f 206c 6f67 2074 6865 2073  nt. To log the s
-000455c0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
-000455d0: 6576 656e 7420 756e 6465 7220 6d75 6c74  event under mult
-000455e0: 6970 6c65 2074 6f70 6963 732c 2070 6173  iple topics, pas
-000455f0: 7320 6120 6c69 7374 206f 6620 746f 7069  s a list of topi
-00045600: 6320 6e61 6d65 732e 0a20 2020 2020 2020  c names..       
-00045610: 206d 7367 0a20 2020 2020 2020 2020 2020   msg.           
-00045620: 2045 7665 6e74 206d 6573 7361 6765 2074   Event message t
-00045630: 6f20 6c6f 672e 204e 6f74 6520 7468 6973  o log. Note this
-00045640: 206d 7573 7420 6265 206d 7367 7061 636b   must be msgpack
-00045650: 2073 6572 6961 6c69 7a61 626c 652e 0a0a   serializable...
-00045660: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-00045670: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00045680: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
-00045690: 2e6c 6f67 5f65 7665 6e74 0a20 2020 2020  .log_event.     
-000456a0: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
-000456b0: 7665 6e74 203d 2028 7469 6d65 2829 2c20  vent = (time(), 
-000456c0: 6d73 6729 0a20 2020 2020 2020 2069 6620  msg).        if 
-000456d0: 6e6f 7420 6973 696e 7374 616e 6365 2874  not isinstance(t
-000456e0: 6f70 6963 2c20 7374 7229 3a0a 2020 2020  opic, str):.    
-000456f0: 2020 2020 2020 2020 666f 7220 7420 696e          for t in
-00045700: 2074 6f70 6963 3a0a 2020 2020 2020 2020   topic:.        
-00045710: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
-00045720: 6e74 735b 745d 2e61 7070 656e 6428 6576  nts[t].append(ev
-00045730: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-00045740: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
-00045750: 636f 756e 7473 5b74 5d20 2b3d 2031 0a20  counts[t] += 1. 
-00045760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00045770: 656c 662e 5f72 6570 6f72 745f 6576 656e  elf._report_even
-00045780: 7428 742c 2065 7665 6e74 290a 2020 2020  t(t, event).    
-00045790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000457a0: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-000457b0: 735b 746f 7069 635d 2e61 7070 656e 6428  s[topic].append(
-000457c0: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
-000457d0: 2020 2073 656c 662e 6576 656e 745f 636f     self.event_co
-000457e0: 756e 7473 5b74 6f70 6963 5d20 2b3d 2031  unts[topic] += 1
-000457f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00045800: 662e 5f72 6570 6f72 745f 6576 656e 7428  f._report_event(
-00045810: 746f 7069 632c 2065 7665 6e74 290a 0a20  topic, event).. 
-00045820: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-00045830: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-00045840: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-00045850: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00045860: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00045870: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00045880: 6c75 6769 6e2e 6c6f 675f 6576 656e 7428  lugin.log_event(
-00045890: 746f 7069 632c 206d 7367 290a 2020 2020  topic, msg).    
-000458a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000458b0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-000458c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000458d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2250    logger.info("P
-000458e0: 6c75 6769 6e20 6661 696c 6564 2077 6974  lugin failed wit
-000458f0: 6820 6578 6365 7074 696f 6e22 2c20 6578  h exception", ex
-00045900: 635f 696e 666f 3d54 7275 6529 0a0a 2020  c_info=True)..  
-00045910: 2020 6465 6620 5f72 6570 6f72 745f 6576    def _report_ev
-00045920: 656e 7428 7365 6c66 2c20 6e61 6d65 2c20  ent(self, name, 
-00045930: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-00045940: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
-00045950: 2020 2020 226f 7022 3a20 2265 7665 6e74      "op": "event
-00045960: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00045970: 746f 7069 6322 3a20 6e61 6d65 2c0a 2020  topic": name,.  
-00045980: 2020 2020 2020 2020 2020 2265 7665 6e74            "event
-00045990: 223a 2065 7665 6e74 2c0a 2020 2020 2020  ": event,.      
-000459a0: 2020 7d0a 2020 2020 2020 2020 636c 6965    }.        clie
-000459b0: 6e74 5f6d 7367 7320 3d20 7b63 6c69 656e  nt_msgs = {clien
-000459c0: 743a 205b 6d73 675d 2066 6f72 2063 6c69  t: [msg] for cli
-000459d0: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
-000459e0: 745f 7375 6273 6372 6962 6572 5b6e 616d  t_subscriber[nam
-000459f0: 655d 7d0a 2020 2020 2020 2020 7365 6c66  e]}.        self
-00045a00: 2e73 656e 645f 616c 6c28 636c 6965 6e74  .send_all(client
-00045a10: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-00045a20: 6773 3d7b 7d29 0a0a 2020 2020 6465 6620  gs={})..    def 
-00045a30: 7375 6273 6372 6962 655f 746f 7069 6328  subscribe_topic(
-00045a40: 7365 6c66 2c20 746f 7069 632c 2063 6c69  self, topic, cli
-00045a50: 656e 7429 3a0a 2020 2020 2020 2020 7365  ent):.        se
-00045a60: 6c66 2e65 7665 6e74 5f73 7562 7363 7269  lf.event_subscri
-00045a70: 6265 725b 746f 7069 635d 2e61 6464 2863  ber[topic].add(c
-00045a80: 6c69 656e 7429 0a0a 2020 2020 6465 6620  lient)..    def 
-00045a90: 756e 7375 6273 6372 6962 655f 746f 7069  unsubscribe_topi
-00045aa0: 6328 7365 6c66 2c20 746f 7069 632c 2063  c(self, topic, c
-00045ab0: 6c69 656e 7429 3a0a 2020 2020 2020 2020  lient):.        
-00045ac0: 7365 6c66 2e65 7665 6e74 5f73 7562 7363  self.event_subsc
-00045ad0: 7269 6265 725b 746f 7069 635d 2e64 6973  riber[topic].dis
-00045ae0: 6361 7264 2863 6c69 656e 7429 0a0a 2020  card(client)..  
-00045af0: 2020 6465 6620 6765 745f 6576 656e 7473    def get_events
-00045b00: 2873 656c 662c 2074 6f70 6963 3d4e 6f6e  (self, topic=Non
-00045b10: 6529 3a0a 2020 2020 2020 2020 6966 2074  e):.        if t
-00045b20: 6f70 6963 2069 7320 6e6f 7420 4e6f 6e65  opic is not None
-00045b30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00045b40: 7475 726e 2074 7570 6c65 2873 656c 662e  turn tuple(self.
-00045b50: 6576 656e 7473 5b74 6f70 6963 5d29 0a20  events[topic]). 
-00045b60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00045b70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00045b80: 7661 6c6d 6170 2874 7570 6c65 2c20 7365  valmap(tuple, se
-00045b90: 6c66 2e65 7665 6e74 7329 0a0a 2020 2020  lf.events)..    
-00045ba0: 6173 796e 6320 6465 6620 6765 745f 776f  async def get_wo
-00045bb0: 726b 6572 5f6d 6f6e 6974 6f72 5f69 6e66  rker_monitor_inf
-00045bc0: 6f28 7365 6c66 2c20 7265 6365 6e74 3d46  o(self, recent=F
-00045bd0: 616c 7365 2c20 7374 6172 7473 3d4e 6f6e  alse, starts=Non
-00045be0: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
-00045bf0: 7461 7274 7320 6973 204e 6f6e 653a 0a20  tarts is None:. 
-00045c00: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00045c10: 7320 3d20 7b7d 0a20 2020 2020 2020 2072  s = {}.        r
-00045c20: 6573 756c 7473 203d 2061 7761 6974 2061  esults = await a
-00045c30: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-00045c40: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
-00045c50: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00045c60: 6c66 2e72 7063 2877 292e 6765 745f 6d6f  lf.rpc(w).get_mo
-00045c70: 6e69 746f 725f 696e 666f 2872 6563 656e  nitor_info(recen
-00045c80: 743d 7265 6365 6e74 2c20 7374 6172 743d  t=recent, start=
-00045c90: 7374 6172 7473 2e67 6574 2877 2c20 3029  starts.get(w, 0)
-00045ca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00045cb0: 2020 666f 7220 7720 696e 2073 656c 662e    for w in self.
-00045cc0: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
-00045cd0: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
-00045ce0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00045cf0: 6963 7428 7a69 7028 7365 6c66 2e77 6f72  ict(zip(self.wor
-00045d00: 6b65 7273 2c20 7265 7375 6c74 7329 290a  kers, results)).
-00045d10: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-00045d20: 0a20 2020 2023 2043 6c65 616e 7570 2023  .    # Cleanup #
-00045d30: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-00045d40: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00045d50: 6368 6563 6b5f 776f 726b 6572 5f74 746c  check_worker_ttl
-00045d60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00045d70: 6e6f 7720 3d20 7469 6d65 2829 0a20 2020  now = time().   
-00045d80: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00045d90: 203d 2066 2263 6865 636b 2d77 6f72 6b65   = f"check-worke
-00045da0: 722d 7474 6c2d 7b6e 6f77 7d22 0a20 2020  r-ttl-{now}".   
-00045db0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
-00045dc0: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
-00045dd0: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00045de0: 2020 6966 2028 7773 2e6c 6173 745f 7365    if (ws.last_se
-00045df0: 656e 203c 206e 6f77 202d 2073 656c 662e  en < now - self.
-00045e00: 776f 726b 6572 5f74 746c 2920 616e 6420  worker_ttl) and 
-00045e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00045e20: 2020 7773 2e6c 6173 745f 7365 656e 203c    ws.last_seen <
-00045e30: 206e 6f77 202d 2031 3020 2a20 6865 6172   now - 10 * hear
-00045e40: 7462 6561 745f 696e 7465 7276 616c 286c  tbeat_interval(l
-00045e50: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-00045e60: 290a 2020 2020 2020 2020 2020 2020 293a  ).            ):
-00045e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045e80: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00045e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045ea0: 2020 2020 2022 576f 726b 6572 2066 6169       "Worker fai
-00045eb0: 6c65 6420 746f 2068 6561 7274 6265 6174  led to heartbeat
-00045ec0: 2077 6974 6869 6e20 2573 2073 6563 6f6e   within %s secon
-00045ed0: 6473 2e20 436c 6f73 696e 673a 2025 7322  ds. Closing: %s"
-00045ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00045ef0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-00045f00: 725f 7474 6c2c 0a20 2020 2020 2020 2020  r_ttl,.         
-00045f10: 2020 2020 2020 2020 2020 2077 732c 0a20             ws,. 
-00045f20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00045f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045f40: 2061 7761 6974 2073 656c 662e 7265 6d6f   await self.remo
-00045f50: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
-00045f60: 733d 7773 2e61 6464 7265 7373 2c20 7374  s=ws.address, st
-00045f70: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-00045f80: 7573 5f69 6429 0a0a 2020 2020 6465 6620  us_id)..    def 
-00045f90: 6368 6563 6b5f 6964 6c65 2873 656c 6629  check_idle(self)
-00045fa0: 202d 3e20 666c 6f61 7420 7c20 4e6f 6e65   -> float | None
-00045fb0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-00045fc0: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
-00045fd0: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
-00045fe0: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
-00045ff0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00046000: 4e6f 6e65 0a0a 2020 2020 2020 2020 6966  None..        if
-00046010: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00046020: 5f63 6f75 6e74 6572 2021 3d20 7365 6c66  _counter != self
-00046030: 2e5f 6964 6c65 5f74 7261 6e73 6974 696f  ._idle_transitio
-00046040: 6e5f 636f 756e 7465 723a 0a20 2020 2020  n_counter:.     
-00046050: 2020 2020 2020 2073 656c 662e 5f69 646c         self._idl
-00046060: 655f 7472 616e 7369 7469 6f6e 5f63 6f75  e_transition_cou
-00046070: 6e74 6572 203d 2073 656c 662e 7472 616e  nter = self.tran
-00046080: 7369 7469 6f6e 5f63 6f75 6e74 6572 0a20  sition_counter. 
-00046090: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000460a0: 6964 6c65 5f73 696e 6365 203d 204e 6f6e  idle_since = Non
-000460b0: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
-000460c0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
-000460d0: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
-000460e0: 2020 2020 7365 6c66 2e71 7565 7565 640a      self.queued.
-000460f0: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
-00046100: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
-00046110: 2020 2020 2020 2020 2020 206f 7220 616e             or an
-00046120: 7928 7773 2e70 726f 6365 7373 696e 6720  y(ws.processing 
-00046130: 666f 7220 7773 2069 6e20 7365 6c66 2e77  for ws in self.w
-00046140: 6f72 6b65 7273 2e76 616c 7565 7328 2929  orkers.values())
-00046150: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
-00046160: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-00046170: 655f 7369 6e63 6520 3d20 4e6f 6e65 0a20  e_since = None. 
-00046180: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00046190: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
-000461a0: 6966 206e 6f74 2073 656c 662e 6964 6c65  if not self.idle
-000461b0: 5f73 696e 6365 3a0a 2020 2020 2020 2020  _since:.        
-000461c0: 2020 2020 7365 6c66 2e69 646c 655f 7369      self.idle_si
-000461d0: 6e63 6520 3d20 7469 6d65 2829 0a20 2020  nce = time().   
-000461e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000461f0: 7365 6c66 2e69 646c 655f 7369 6e63 650a  self.idle_since.
-00046200: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00046210: 2e6a 7570 7974 6572 3a0a 2020 2020 2020  .jupyter:.      
-00046220: 2020 2020 2020 6c61 7374 5f61 6374 6976        last_activ
-00046230: 6974 7920 3d20 280a 2020 2020 2020 2020  ity = (.        
-00046240: 2020 2020 2020 2020 7365 6c66 2e5f 6a75          self._ju
-00046250: 7079 7465 725f 7365 7276 6572 5f61 7070  pyter_server_app
-00046260: 6c69 6361 7469 6f6e 2e77 6562 5f61 7070  lication.web_app
-00046270: 2e6c 6173 745f 6163 7469 7669 7479 2829  .last_activity()
-00046280: 2e74 696d 6573 7461 6d70 2829 0a20 2020  .timestamp().   
-00046290: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000462a0: 2020 2020 2020 2069 6620 6c61 7374 5f61         if last_a
-000462b0: 6374 6976 6974 7920 3e20 7365 6c66 2e69  ctivity > self.i
-000462c0: 646c 655f 7369 6e63 653a 0a20 2020 2020  dle_since:.     
-000462d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000462e0: 6964 6c65 5f73 696e 6365 203d 206c 6173  idle_since = las
-000462f0: 745f 6163 7469 7669 7479 0a20 2020 2020  t_activity.     
-00046300: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00046310: 6e20 7365 6c66 2e69 646c 655f 7369 6e63  n self.idle_sinc
-00046320: 650a 0a20 2020 2020 2020 2069 6620 7365  e..        if se
-00046330: 6c66 2e69 646c 655f 7469 6d65 6f75 743a  lf.idle_timeout:
-00046340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00046350: 7469 6d65 2829 203e 2073 656c 662e 6964  time() > self.id
-00046360: 6c65 5f73 696e 6365 202b 2073 656c 662e  le_since + self.
-00046370: 6964 6c65 5f74 696d 656f 7574 3a0a 2020  idle_timeout:.  
-00046380: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00046390: 7365 7274 2073 656c 662e 6964 6c65 5f73  sert self.idle_s
-000463a0: 696e 6365 0a20 2020 2020 2020 2020 2020  ince.           
-000463b0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-000463c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000463d0: 2020 2020 2020 2253 6368 6564 756c 6572        "Scheduler
-000463e0: 2063 6c6f 7369 6e67 2061 6674 6572 2062   closing after b
-000463f0: 6569 6e67 2069 646c 6520 666f 7220 2573  eing idle for %s
-00046400: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00046410: 2020 2020 2020 2066 6f72 6d61 745f 7469         format_ti
-00046420: 6d65 2873 656c 662e 6964 6c65 5f74 696d  me(self.idle_tim
-00046430: 656f 7574 292c 0a20 2020 2020 2020 2020  eout),.         
-00046440: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00046450: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
-00046460: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
-00046470: 645f 7461 736b 732e 6361 6c6c 5f73 6f6f  d_tasks.call_soo
-00046480: 6e28 7365 6c66 2e63 6c6f 7365 290a 2020  n(self.close).  
-00046490: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000464a0: 662e 6964 6c65 5f73 696e 6365 0a0a 2020  f.idle_since..  
-000464b0: 2020 6465 6620 6164 6170 7469 7665 5f74    def adaptive_t
-000464c0: 6172 6765 7428 7365 6c66 2c20 7461 7267  arget(self, targ
-000464d0: 6574 5f64 7572 6174 696f 6e3d 4e6f 6e65  et_duration=None
-000464e0: 293a 0a20 2020 2020 2020 2022 2222 4465  ):.        """De
-000464f0: 7369 7265 6420 6e75 6d62 6572 206f 6620  sired number of 
-00046500: 776f 726b 6572 7320 6261 7365 6420 6f6e  workers based on
-00046510: 2074 6865 2063 7572 7265 6e74 2077 6f72   the current wor
-00046520: 6b6c 6f61 640a 0a20 2020 2020 2020 2054  kload..        T
-00046530: 6869 7320 6c6f 6f6b 7320 6174 2074 6865  his looks at the
-00046540: 2063 7572 7265 6e74 2072 756e 6e69 6e67   current running
-00046550: 2074 6173 6b73 2061 6e64 206d 656d 6f72   tasks and memor
-00046560: 7920 7573 652c 2061 6e64 2072 6574 7572  y use, and retur
-00046570: 6e73 2061 0a20 2020 2020 2020 206e 756d  ns a.        num
-00046580: 6265 7220 6f66 2064 6573 6972 6564 2077  ber of desired w
-00046590: 6f72 6b65 7273 2e20 2054 6869 7320 6973  orkers.  This is
-000465a0: 206f 6674 656e 2075 7365 6420 6279 2061   often used by a
-000465b0: 6461 7074 6976 6520 7363 6865 6475 6c69  daptive scheduli
-000465c0: 6e67 2e0a 0a20 2020 2020 2020 2050 6172  ng...        Par
-000465d0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-000465e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-000465f0: 2020 2074 6172 6765 745f 6475 7261 7469     target_durati
-00046600: 6f6e 203a 2073 7472 0a20 2020 2020 2020  on : str.       
-00046610: 2020 2020 2041 2064 6573 6972 6564 2064       A desired d
-00046620: 7572 6174 696f 6e20 6f66 2074 696d 6520  uration of time 
-00046630: 666f 7220 636f 6d70 7574 6174 696f 6e73  for computations
-00046640: 2074 6f20 7461 6b65 2e20 2054 6869 7320   to take.  This 
-00046650: 6166 6665 6374 730a 2020 2020 2020 2020  affects.        
-00046660: 2020 2020 686f 7720 7261 7069 646c 7920      how rapidly 
-00046670: 7468 6520 7363 6865 6475 6c65 7220 7769  the scheduler wi
-00046680: 6c6c 2061 736b 2074 6f20 7363 616c 652e  ll ask to scale.
-00046690: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-000466a0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-000466b0: 2d2d 2d0a 2020 2020 2020 2020 6469 7374  ---.        dist
-000466c0: 7269 6275 7465 642e 6465 706c 6f79 2e41  ributed.deploy.A
-000466d0: 6461 7074 6976 650a 2020 2020 2020 2020  daptive.        
-000466e0: 2222 220a 2020 2020 2020 2020 6966 2074  """.        if t
-000466f0: 6172 6765 745f 6475 7261 7469 6f6e 2069  arget_duration i
-00046700: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00046710: 2020 2020 7461 7267 6574 5f64 7572 6174      target_durat
-00046720: 696f 6e20 3d20 6461 736b 2e63 6f6e 6669  ion = dask.confi
-00046730: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-00046740: 6564 2e61 6461 7074 6976 652e 7461 7267  ed.adaptive.targ
-00046750: 6574 2d64 7572 6174 696f 6e22 290a 2020  et-duration").  
-00046760: 2020 2020 2020 7461 7267 6574 5f64 7572        target_dur
-00046770: 6174 696f 6e20 3d20 7061 7273 655f 7469  ation = parse_ti
-00046780: 6d65 6465 6c74 6128 7461 7267 6574 5f64  medelta(target_d
-00046790: 7572 6174 696f 6e29 0a0a 2020 2020 2020  uration)..      
-000467a0: 2020 2320 4350 550a 0a20 2020 2020 2020    # CPU..       
-000467b0: 2023 2054 4f44 4f20 636f 6e73 6964 6572   # TODO consider
-000467c0: 2061 6e79 2075 7365 722d 7370 6563 6966   any user-specif
-000467d0: 6965 6420 6465 6661 756c 7420 7461 736b  ied default task
-000467e0: 2064 7572 6174 696f 6e73 2066 6f72 2071   durations for q
-000467f0: 7565 7565 6420 7461 736b 730a 2020 2020  ueued tasks.    
-00046800: 2020 2020 7175 6575 6564 5f6f 6363 7570      queued_occup
-00046810: 616e 6379 203d 206c 656e 2873 656c 662e  ancy = len(self.
-00046820: 7175 6575 6564 2920 2a20 7365 6c66 2e55  queued) * self.U
-00046830: 4e4b 4e4f 574e 5f54 4153 4b5f 4455 5241  NKNOWN_TASK_DURA
-00046840: 5449 4f4e 0a20 2020 2020 2020 2063 7075  TION.        cpu
-00046850: 203d 206d 6174 682e 6365 696c 280a 2020   = math.ceil(.  
-00046860: 2020 2020 2020 2020 2020 2873 656c 662e            (self.
-00046870: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
-00046880: 2b20 7175 6575 6564 5f6f 6363 7570 616e  + queued_occupan
-00046890: 6379 2920 2f20 7461 7267 6574 5f64 7572  cy) / target_dur
-000468a0: 6174 696f 6e0a 2020 2020 2020 2020 2920  ation.        ) 
-000468b0: 2023 2054 4f44 4f3a 2074 6872 6561 6473   # TODO: threads
-000468c0: 2070 6572 2077 6f72 6b65 720a 0a20 2020   per worker..   
-000468d0: 2020 2020 2023 2041 766f 6964 2061 2066       # Avoid a f
-000468e0: 6577 206c 6f6e 6720 7461 736b 7320 6672  ew long tasks fr
-000468f0: 6f6d 2061 736b 696e 6720 666f 7220 6d61  om asking for ma
-00046900: 6e79 2063 6f72 6573 0a20 2020 2020 2020  ny cores.       
-00046910: 2074 6173 6b73 5f72 6561 6479 203d 206c   tasks_ready = l
-00046920: 656e 2873 656c 662e 7175 6575 6564 290a  en(self.queued).
-00046930: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-00046940: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-00046950: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-00046960: 2020 2020 2074 6173 6b73 5f72 6561 6479       tasks_ready
-00046970: 202b 3d20 6c65 6e28 7773 2e70 726f 6365   += len(ws.proce
-00046980: 7373 696e 6729 0a0a 2020 2020 2020 2020  ssing)..        
-00046990: 2020 2020 6966 2074 6173 6b73 5f72 6561      if tasks_rea
-000469a0: 6479 203e 2063 7075 3a0a 2020 2020 2020  dy > cpu:.      
-000469b0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-000469c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000469d0: 2020 2020 2020 2020 2020 6370 7520 3d20            cpu = 
-000469e0: 6d69 6e28 7461 736b 735f 7265 6164 792c  min(tasks_ready,
-000469f0: 2063 7075 290a 0a20 2020 2020 2020 2069   cpu)..        i
-00046a00: 6620 2873 656c 662e 756e 7275 6e6e 6162  f (self.unrunnab
-00046a10: 6c65 206f 7220 7365 6c66 2e71 7565 7565  le or self.queue
-00046a20: 6429 2061 6e64 206e 6f74 2073 656c 662e  d) and not self.
-00046a30: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00046a40: 2020 2020 2063 7075 203d 206d 6178 2831       cpu = max(1
-00046a50: 2c20 6370 7529 0a0a 2020 2020 2020 2020  , cpu)..        
-00046a60: 2320 6164 6420 6d6f 7265 2077 6f72 6b65  # add more worke
-00046a70: 7273 2069 6620 6d6f 7265 2074 6861 6e20  rs if more than 
-00046a80: 3630 2520 6f66 206d 656d 6f72 7920 6973  60% of memory is
-00046a90: 2075 7365 640a 2020 2020 2020 2020 6c69   used.        li
-00046aa0: 6d69 7420 3d20 7375 6d28 7773 2e6d 656d  mit = sum(ws.mem
-00046ab0: 6f72 795f 6c69 6d69 7420 666f 7220 7773  ory_limit for ws
-00046ac0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00046ad0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-00046ae0: 2020 2075 7365 6420 3d20 7375 6d28 7773     used = sum(ws
-00046af0: 2e6e 6279 7465 7320 666f 7220 7773 2069  .nbytes for ws i
-00046b00: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-00046b10: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
-00046b20: 206d 656d 6f72 7920 3d20 300a 2020 2020   memory = 0.    
-00046b30: 2020 2020 6966 2075 7365 6420 3e20 302e      if used > 0.
-00046b40: 3620 2a20 6c69 6d69 7420 616e 6420 6c69  6 * limit and li
-00046b50: 6d69 7420 3e20 303a 0a20 2020 2020 2020  mit > 0:.       
-00046b60: 2020 2020 206d 656d 6f72 7920 3d20 3220       memory = 2 
-00046b70: 2a20 6c65 6e28 7365 6c66 2e77 6f72 6b65  * len(self.worke
-00046b80: 7273 290a 0a20 2020 2020 2020 2074 6172  rs)..        tar
-00046b90: 6765 7420 3d20 6d61 7828 6d65 6d6f 7279  get = max(memory
-00046ba0: 2c20 6370 7529 0a20 2020 2020 2020 2069  , cpu).        i
-00046bb0: 6620 7461 7267 6574 203e 3d20 6c65 6e28  f target >= len(
-00046bc0: 7365 6c66 2e77 6f72 6b65 7273 293a 0a20  self.workers):. 
-00046bd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00046be0: 6e20 7461 7267 6574 0a20 2020 2020 2020  n target.       
-00046bf0: 2065 6c73 653a 2020 2320 5363 616c 6520   else:  # Scale 
-00046c00: 646f 776e 3f0a 2020 2020 2020 2020 2020  down?.          
-00046c10: 2020 746f 5f63 6c6f 7365 203d 2073 656c    to_close = sel
-00046c20: 662e 776f 726b 6572 735f 746f 5f63 6c6f  f.workers_to_clo
-00046c30: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
-00046c40: 2072 6574 7572 6e20 6c65 6e28 7365 6c66   return len(self
-00046c50: 2e77 6f72 6b65 7273 2920 2d20 6c65 6e28  .workers) - len(
-00046c60: 746f 5f63 6c6f 7365 290a 0a20 2020 2064  to_close)..    d
-00046c70: 6566 2072 6571 7565 7374 5f61 6371 7569  ef request_acqui
-00046c80: 7265 5f72 6570 6c69 6361 7328 0a20 2020  re_replicas(.   
-00046c90: 2020 2020 2073 656c 662c 2061 6464 723a       self, addr:
-00046ca0: 2073 7472 2c20 6b65 7973 3a20 4974 6572   str, keys: Iter
-00046cb0: 6162 6c65 5b73 7472 5d2c 202a 2c20 7374  able[str], *, st
-00046cc0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
-00046cd0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00046ce0: 2020 2020 2020 2222 2241 7379 6e63 6872        """Asynchr
-00046cf0: 6f6e 6f75 736c 7920 6173 6b20 6120 776f  onously ask a wo
-00046d00: 726b 6572 2074 6f20 6163 7175 6972 6520  rker to acquire 
-00046d10: 6120 7265 706c 6963 6120 6f66 2074 6865  a replica of the
-00046d20: 206c 6973 7465 6420 6b65 7973 2066 726f   listed keys fro
-00046d30: 6d0a 2020 2020 2020 2020 6f74 6865 7220  m.        other 
-00046d40: 776f 726b 6572 732e 2054 6869 7320 6973  workers. This is
-00046d50: 2061 2066 6972 652d 616e 642d 666f 7267   a fire-and-forg
-00046d60: 6574 206f 7065 7261 7469 6f6e 2077 6869  et operation whi
-00046d70: 6368 206f 6666 6572 7320 6e6f 2066 6565  ch offers no fee
-00046d80: 6462 6163 6b20 666f 720a 2020 2020 2020  dback for.      
-00046d90: 2020 7375 6363 6573 7320 6f72 2066 6169    success or fai
-00046da0: 6c75 7265 2c20 616e 6420 6973 2069 6e74  lure, and is int
-00046db0: 656e 6465 6420 666f 7220 686f 7573 656b  ended for housek
-00046dc0: 6565 7069 6e67 2061 6e64 206e 6f74 2066  eeping and not f
-00046dd0: 6f72 2063 6f6d 7075 7461 7469 6f6e 2e0a  or computation..
-00046de0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00046df0: 2020 2020 7768 6f5f 6861 7320 3d20 7b7d      who_has = {}
-00046e00: 0a20 2020 2020 2020 206e 6279 7465 7320  .        nbytes 
-00046e10: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
-00046e20: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
-00046e30: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00046e40: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00046e50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00046e60: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-00046e70: 2020 2020 2020 2020 2077 686f 5f68 6173           who_has
-00046e80: 5b6b 6579 5d20 3d20 5b77 732e 6164 6472  [key] = [ws.addr
-00046e90: 6573 7320 666f 7220 7773 2069 6e20 7473  ess for ws in ts
-00046ea0: 2e77 686f 5f68 6173 5d0a 2020 2020 2020  .who_has].      
-00046eb0: 2020 2020 2020 6e62 7974 6573 5b6b 6579        nbytes[key
-00046ec0: 5d20 3d20 7473 2e6e 6279 7465 730a 0a20  ] = ts.nbytes.. 
-00046ed0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-00046ee0: 616d 5f63 6f6d 6d73 5b61 6464 725d 2e73  am_comms[addr].s
-00046ef0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00046f00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00046f10: 2020 2022 6f70 223a 2022 6163 7175 6972     "op": "acquir
-00046f20: 652d 7265 706c 6963 6173 222c 0a20 2020  e-replicas",.   
-00046f30: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
-00046f40: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
-00046f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046f60: 2022 6e62 7974 6573 223a 206e 6279 7465   "nbytes": nbyte
-00046f70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00046f80: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-00046f90: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-00046fa0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00046fb0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00046fc0: 2072 6571 7565 7374 5f72 656d 6f76 655f   request_remove_
-00046fd0: 7265 706c 6963 6173 280a 2020 2020 2020  replicas(.      
-00046fe0: 2020 7365 6c66 2c20 6164 6472 3a20 7374    self, addr: st
-00046ff0: 722c 206b 6579 733a 206c 6973 745b 7374  r, keys: list[st
-00047000: 725d 2c20 2a2c 2073 7469 6d75 6c75 735f  r], *, stimulus_
-00047010: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-00047020: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00047030: 2222 4173 796e 6368 726f 6e6f 7573 6c79  ""Asynchronously
-00047040: 2061 736b 2061 2077 6f72 6b65 7220 746f   ask a worker to
-00047050: 2064 6973 6361 7264 2069 7473 2072 6570   discard its rep
-00047060: 6c69 6361 206f 6620 7468 6520 6c69 7374  lica of the list
-00047070: 6564 206b 6579 732e 0a20 2020 2020 2020  ed keys..       
-00047080: 2054 6869 7320 6d75 7374 206e 6576 6572   This must never
-00047090: 2062 6520 7573 6564 2074 6f20 6465 7374   be used to dest
-000470a0: 726f 7920 7468 6520 6c61 7374 2072 6570  roy the last rep
-000470b0: 6c69 6361 206f 6620 6120 6b65 792e 2054  lica of a key. T
-000470c0: 6869 7320 6973 2061 0a20 2020 2020 2020  his is a.       
-000470d0: 2066 6972 652d 616e 642d 666f 7267 6574   fire-and-forget
-000470e0: 206f 7065 7261 7469 6f6e 2c20 696e 7465   operation, inte
-000470f0: 6e64 6564 2066 6f72 2068 6f75 7365 6b65  nded for houseke
-00047100: 6570 696e 6720 616e 6420 6e6f 7420 666f  eping and not fo
-00047110: 7220 636f 6d70 7574 6174 696f 6e2e 0a0a  r computation...
-00047120: 2020 2020 2020 2020 5468 6520 7265 706c          The repl
-00047130: 6963 6120 6469 7361 7070 6561 7273 2069  ica disappears i
-00047140: 6d6d 6564 6961 7465 6c79 2066 726f 6d20  mmediately from 
-00047150: 5461 736b 5374 6174 652e 7768 6f5f 6861  TaskState.who_ha
-00047160: 7320 6f6e 2074 6865 2053 6368 6564 756c  s on the Schedul
-00047170: 6572 2073 6964 653b 0a20 2020 2020 2020  er side;.       
-00047180: 2069 6620 7468 6520 776f 726b 6572 2072   if the worker r
-00047190: 6566 7573 6573 2074 6f20 6465 6c65 7465  efuses to delete
-000471a0: 2c20 652e 672e 2062 6563 6175 7365 2074  , e.g. because t
-000471b0: 6865 2074 6173 6b20 6973 2061 2064 6570  he task is a dep
-000471c0: 656e 6465 6e63 7920 6f66 0a20 2020 2020  endency of.     
-000471d0: 2020 2061 6e6f 7468 6572 2074 6173 6b20     another task 
-000471e0: 7275 6e6e 696e 6720 6f6e 2069 742c 2069  running on it, i
-000471f0: 7420 7769 6c6c 2028 616c 736f 2061 7379  t will (also asy
-00047200: 6e63 6872 6f6e 6f75 736c 7929 2069 6e66  nchronously) inf
-00047210: 6f72 6d20 7468 6520 7363 6865 6475 6c65  orm the schedule
-00047220: 720a 2020 2020 2020 2020 746f 2072 652d  r.        to re-
-00047230: 6164 6420 6974 7365 6c66 2074 6f20 7768  add itself to wh
-00047240: 6f5f 6861 732e 2049 6620 7468 6520 776f  o_has. If the wo
-00047250: 726b 6572 2061 6772 6565 7320 746f 2064  rker agrees to d
-00047260: 6973 6361 7264 2074 6865 2074 6173 6b2c  iscard the task,
-00047270: 2074 6865 7265 2069 730a 2020 2020 2020   there is.      
-00047280: 2020 6e6f 2066 6565 6462 6163 6b2e 0a20    no feedback.. 
-00047290: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000472a0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-000472b0: 6b65 7273 5b61 6464 725d 0a0a 2020 2020  kers[addr]..    
-000472c0: 2020 2020 2320 5468 6520 7363 6865 6475      # The schedu
-000472d0: 6c65 7220 696d 6d65 6469 6174 656c 7920  ler immediately 
-000472e0: 666f 7267 6574 7320 6162 6f75 7420 7468  forgets about th
-000472f0: 6520 7265 706c 6963 6120 616e 6420 7375  e replica and su
-00047300: 6767 6573 7473 2074 6865 2077 6f72 6b65  ggests the worke
-00047310: 7220 746f 0a20 2020 2020 2020 2023 2064  r to.        # d
-00047320: 726f 7020 6974 2e20 5468 6520 776f 726b  rop it. The work
-00047330: 6572 206d 6179 2072 6566 7573 652c 2061  er may refuse, a
-00047340: 7420 7768 6963 6820 706f 696e 7420 6974  t which point it
-00047350: 2077 696c 6c20 7365 6e64 2062 6163 6b20   will send back 
-00047360: 616e 2061 6464 2d6b 6579 730a 2020 2020  an add-keys.    
-00047370: 2020 2020 2320 6d65 7373 6167 6520 746f      # message to
-00047380: 2072 6569 6e73 7461 7465 2069 742e 0a20   reinstate it.. 
-00047390: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-000473a0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-000473b0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000473c0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-000473d0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-000473e0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-000473f0: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
-00047400: 6465 7374 726f 7920 7468 6520 6c61 7374  destroy the last
-00047410: 2063 6f70 790a 2020 2020 2020 2020 2020   copy.          
-00047420: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
-00047430: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
-00047440: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00047450: 662e 7265 6d6f 7665 5f72 6570 6c69 6361  f.remove_replica
-00047460: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
-00047470: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
-00047480: 6d6d 735b 6164 6472 5d2e 7365 6e64 280a  mms[addr].send(.
-00047490: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000474a0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-000474b0: 7022 3a20 2272 656d 6f76 652d 7265 706c  p": "remove-repl
-000474c0: 6963 6173 222c 0a20 2020 2020 2020 2020  icas",.         
-000474d0: 2020 2020 2020 2022 6b65 7973 223a 206b         "keys": k
-000474e0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-000474f0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
-00047500: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
-00047510: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00047520: 2020 2020 2020 2029 0a0a 0a64 6566 205f         )...def _
-00047530: 7461 736b 5f74 6f5f 7265 706f 7274 5f6d  task_to_report_m
-00047540: 7367 2874 733a 2054 6173 6b53 7461 7465  sg(ts: TaskState
-00047550: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
-00047560: 6e79 5d20 7c20 4e6f 6e65 3a0a 2020 2020  ny] | None:.    
-00047570: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-00047580: 666f 7267 6f74 7465 6e22 3a0a 2020 2020  forgotten":.    
-00047590: 2020 2020 7265 7475 726e 207b 226f 7022      return {"op"
-000475a0: 3a20 2263 616e 6365 6c6c 6564 2d6b 6579  : "cancelled-key
-000475b0: 7322 2c20 226b 6579 7322 3a20 5b74 732e  s", "keys": [ts.
-000475c0: 6b65 795d 7d0a 2020 2020 656c 6966 2074  key]}.    elif t
-000475d0: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-000475e0: 7279 223a 0a20 2020 2020 2020 2072 6574  ry":.        ret
-000475f0: 7572 6e20 7b22 6f70 223a 2022 6b65 792d  urn {"op": "key-
-00047600: 696e 2d6d 656d 6f72 7922 2c20 226b 6579  in-memory", "key
-00047610: 223a 2074 732e 6b65 797d 0a20 2020 2065  ": ts.key}.    e
-00047620: 6c69 6620 7473 2e73 7461 7465 203d 3d20  lif ts.state == 
-00047630: 2265 7272 6564 223a 0a20 2020 2020 2020  "erred":.       
-00047640: 2066 6169 6c69 6e67 5f74 7320 3d20 7473   failing_ts = ts
-00047650: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00047660: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00047670: 6661 696c 696e 675f 7473 0a20 2020 2020  failing_ts.     
-00047680: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-00047690: 2020 2020 2020 2020 226f 7022 3a20 2274          "op": "t
-000476a0: 6173 6b2d 6572 7265 6422 2c0a 2020 2020  ask-erred",.    
-000476b0: 2020 2020 2020 2020 226b 6579 223a 2074          "key": t
-000476c0: 732e 6b65 792c 0a20 2020 2020 2020 2020  s.key,.         
-000476d0: 2020 2022 6578 6365 7074 696f 6e22 3a20     "exception": 
-000476e0: 6661 696c 696e 675f 7473 2e65 7863 6570  failing_ts.excep
-000476f0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-00047700: 2020 2274 7261 6365 6261 636b 223a 2066    "traceback": f
-00047710: 6169 6c69 6e67 5f74 732e 7472 6163 6562  ailing_ts.traceb
-00047720: 6163 6b2c 0a20 2020 2020 2020 207d 0a20  ack,.        }. 
-00047730: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00047740: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
-00047750: 6566 205f 7461 736b 5f74 6f5f 636c 6965  ef _task_to_clie
-00047760: 6e74 5f6d 7367 7328 7473 3a20 5461 736b  nt_msgs(ts: Task
-00047770: 5374 6174 6529 202d 3e20 6469 6374 5b73  State) -> dict[s
-00047780: 7472 2c20 6c69 7374 5b64 6963 745b 7374  tr, list[dict[st
-00047790: 722c 2041 6e79 5d5d 5d3a 0a20 2020 2069  r, Any]]]:.    i
-000477a0: 6620 7473 2e77 686f 5f77 616e 7473 3a0a  f ts.who_wants:.
-000477b0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
-000477c0: 7367 203d 205f 7461 736b 5f74 6f5f 7265  sg = _task_to_re
-000477d0: 706f 7274 5f6d 7367 2874 7329 0a20 2020  port_msg(ts).   
-000477e0: 2020 2020 2069 6620 7265 706f 7274 5f6d       if report_m
-000477f0: 7367 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sg is not None:.
-00047800: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00047810: 726e 207b 6373 2e63 6c69 656e 745f 6b65  rn {cs.client_ke
-00047820: 793a 205b 7265 706f 7274 5f6d 7367 5d20  y: [report_msg] 
-00047830: 666f 7220 6373 2069 6e20 7473 2e77 686f  for cs in ts.who
-00047840: 5f77 616e 7473 7d0a 2020 2020 7265 7475  _wants}.    retu
-00047850: 726e 207b 7d0a 0a0a 6465 6620 6465 6369  rn {}...def deci
-00047860: 6465 5f77 6f72 6b65 7228 0a20 2020 2074  de_worker(.    t
-00047870: 733a 2054 6173 6b53 7461 7465 2c0a 2020  s: TaskState,.  
-00047880: 2020 616c 6c5f 776f 726b 6572 733a 2049    all_workers: I
-00047890: 7465 7261 626c 655b 576f 726b 6572 5374  terable[WorkerSt
-000478a0: 6174 655d 2c0a 2020 2020 7661 6c69 645f  ate],.    valid_
-000478b0: 776f 726b 6572 733a 2073 6574 5b57 6f72  workers: set[Wor
-000478c0: 6b65 7253 7461 7465 5d20 7c20 4e6f 6e65  kerState] | None
-000478d0: 2c0a 2020 2020 6f62 6a65 6374 6976 653a  ,.    objective:
-000478e0: 2043 616c 6c61 626c 655b 5b57 6f72 6b65   Callable[[Worke
-000478f0: 7253 7461 7465 5d2c 2041 6e79 5d2c 0a29  rState], Any],.)
-00047900: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
-00047910: 7c20 4e6f 6e65 3a0a 2020 2020 2222 220a  | None:.    """.
-00047920: 2020 2020 4465 6369 6465 2077 6869 6368      Decide which
-00047930: 2077 6f72 6b65 7220 7368 6f75 6c64 2074   worker should t
-00047940: 616b 6520 7461 736b 202a 7473 2a2e 0a0a  ake task *ts*...
-00047950: 2020 2020 5765 2063 686f 6f73 6520 7468      We choose th
-00047960: 6520 776f 726b 6572 2074 6861 7420 6861  e worker that ha
-00047970: 7320 7468 6520 6461 7461 206f 6e20 7768  s the data on wh
-00047980: 6963 6820 2a74 732a 2064 6570 656e 6473  ich *ts* depends
-00047990: 2e0a 0a20 2020 2049 6620 7365 7665 7261  ...    If severa
-000479a0: 6c20 776f 726b 6572 7320 6861 7665 2064  l workers have d
-000479b0: 6570 656e 6465 6e63 6965 7320 7468 656e  ependencies then
-000479c0: 2077 6520 6368 6f6f 7365 2074 6865 206c   we choose the l
-000479d0: 6573 732d 6275 7379 2077 6f72 6b65 722e  ess-busy worker.
-000479e0: 0a0a 2020 2020 4f70 7469 6f6e 616c 6c79  ..    Optionally
-000479f0: 2070 726f 7669 6465 202a 7661 6c69 645f   provide *valid_
-00047a00: 776f 726b 6572 732a 206f 6620 7768 6572  workers* of wher
-00047a10: 6520 6a6f 6273 2061 7265 2061 6c6c 6f77  e jobs are allow
-00047a20: 6564 2074 6f20 6f63 6375 720a 2020 2020  ed to occur.    
-00047a30: 2869 6620 616c 6c20 776f 726b 6572 7320  (if all workers 
-00047a40: 6172 6520 616c 6c6f 7765 6420 746f 2074  are allowed to t
-00047a50: 616b 6520 7468 6520 7461 736b 2c20 7061  ake the task, pa
-00047a60: 7373 204e 6f6e 6520 696e 7374 6561 6429  ss None instead)
-00047a70: 2e0a 0a20 2020 2049 6620 7468 6520 7461  ...    If the ta
-00047a80: 736b 2072 6571 7569 7265 7320 6461 7461  sk requires data
-00047a90: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2062   communication b
-00047aa0: 6563 6175 7365 206e 6f20 656c 6967 6962  ecause no eligib
-00047ab0: 6c65 2077 6f72 6b65 7220 6861 730a 2020  le worker has.  
-00047ac0: 2020 616c 6c20 7468 6520 6465 7065 6e64    all the depend
-00047ad0: 656e 6369 6573 2061 6c72 6561 6479 2c20  encies already, 
-00047ae0: 7468 656e 2077 6520 6368 6f6f 7365 2074  then we choose t
-00047af0: 6f20 6d69 6e69 6d69 7a65 2074 6865 206e  o minimize the n
-00047b00: 756d 6265 720a 2020 2020 6f66 2062 7974  umber.    of byt
-00047b10: 6573 2073 656e 7420 6265 7477 6565 6e20  es sent between 
-00047b20: 776f 726b 6572 732e 2020 5468 6973 2069  workers.  This i
-00047b30: 7320 6465 7465 726d 696e 6564 2062 7920  s determined by 
-00047b40: 6361 6c6c 696e 6720 7468 650a 2020 2020  calling the.    
-00047b50: 2a6f 626a 6563 7469 7665 2a20 6675 6e63  *objective* func
-00047b60: 7469 6f6e 2e0a 2020 2020 2222 220a 2020  tion..    """.  
-00047b70: 2020 6173 7365 7274 2061 6c6c 2864 7473    assert all(dts
-00047b80: 2e77 686f 5f68 6173 2066 6f72 2064 7473  .who_has for dts
-00047b90: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-00047ba0: 6965 7329 0a20 2020 2069 6620 7473 2e61  ies).    if ts.a
-00047bb0: 6374 6f72 3a0a 2020 2020 2020 2020 6361  ctor:.        ca
-00047bc0: 6e64 6964 6174 6573 203d 2073 6574 2861  ndidates = set(a
-00047bd0: 6c6c 5f77 6f72 6b65 7273 290a 2020 2020  ll_workers).    
-00047be0: 656c 7365 3a0a 2020 2020 2020 2020 6361  else:.        ca
-00047bf0: 6e64 6964 6174 6573 203d 207b 7777 7320  ndidates = {wws 
-00047c00: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00047c10: 7065 6e64 656e 6369 6573 2066 6f72 2077  pendencies for w
-00047c20: 7773 2069 6e20 6474 732e 7768 6f5f 6861  ws in dts.who_ha
-00047c30: 737d 0a20 2020 2069 6620 7661 6c69 645f  s}.    if valid_
-00047c40: 776f 726b 6572 7320 6973 204e 6f6e 653a  workers is None:
-00047c50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00047c60: 6361 6e64 6964 6174 6573 3a0a 2020 2020  candidates:.    
-00047c70: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
-00047c80: 6573 203d 2073 6574 2861 6c6c 5f77 6f72  es = set(all_wor
-00047c90: 6b65 7273 290a 2020 2020 656c 7365 3a0a  kers).    else:.
-00047ca0: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
-00047cb0: 6573 2026 3d20 7661 6c69 645f 776f 726b  es &= valid_work
-00047cc0: 6572 730a 2020 2020 2020 2020 6966 206e  ers.        if n
-00047cd0: 6f74 2063 616e 6469 6461 7465 733a 0a20  ot candidates:. 
-00047ce0: 2020 2020 2020 2020 2020 2063 616e 6469             candi
-00047cf0: 6461 7465 7320 3d20 7661 6c69 645f 776f  dates = valid_wo
-00047d00: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-00047d10: 2020 6966 206e 6f74 2063 616e 6469 6461    if not candida
-00047d20: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-00047d30: 2020 2020 2069 6620 7473 2e6c 6f6f 7365       if ts.loose
-00047d40: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
-00047d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047d60: 2020 2072 6574 7572 6e20 6465 6369 6465     return decide
-00047d70: 5f77 6f72 6b65 7228 7473 2c20 616c 6c5f  _worker(ts, all_
-00047d80: 776f 726b 6572 732c 204e 6f6e 652c 206f  workers, None, o
-00047d90: 626a 6563 7469 7665 290a 0a20 2020 2069  bjective)..    i
-00047da0: 6620 6e6f 7420 6361 6e64 6964 6174 6573  f not candidates
-00047db0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00047dc0: 204e 6f6e 650a 2020 2020 656c 6966 206c   None.    elif l
-00047dd0: 656e 2863 616e 6469 6461 7465 7329 203d  en(candidates) =
-00047de0: 3d20 313a 0a20 2020 2020 2020 2072 6574  = 1:.        ret
-00047df0: 7572 6e20 6e65 7874 2869 7465 7228 6361  urn next(iter(ca
-00047e00: 6e64 6964 6174 6573 2929 0a20 2020 2065  ndidates)).    e
-00047e10: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
-00047e20: 7572 6e20 6d69 6e28 6361 6e64 6964 6174  urn min(candidat
-00047e30: 6573 2c20 6b65 793d 6f62 6a65 6374 6976  es, key=objectiv
-00047e40: 6529 0a0a 0a64 6566 2076 616c 6964 6174  e)...def validat
-00047e50: 655f 7461 736b 5f73 7461 7465 2874 733a  e_task_state(ts:
-00047e60: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-00047e70: 6f6e 653a 0a20 2020 2022 2222 5661 6c69  one:.    """Vali
-00047e80: 6461 7465 2074 6865 2067 6976 656e 2054  date the given T
-00047e90: 6173 6b53 7461 7465 2222 220a 2020 2020  askState""".    
-00047ea0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-00047eb0: 696e 2041 4c4c 5f54 4153 4b5f 5354 4154  in ALL_TASK_STAT
-00047ec0: 4553 2c20 7473 0a0a 2020 2020 6966 2074  ES, ts..    if t
-00047ed0: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
-00047ee0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00047ef0: 7761 6974 696e 675f 6f6e 2e69 7373 7562  waiting_on.issub
-00047f00: 7365 7428 7473 2e64 6570 656e 6465 6e63  set(ts.dependenc
-00047f10: 6965 7329 2c20 280a 2020 2020 2020 2020  ies), (.        
-00047f20: 2020 2020 2277 6169 7469 6e67 206e 6f74      "waiting not
-00047f30: 2073 7562 7365 7420 6f66 2064 6570 656e   subset of depen
-00047f40: 6465 6e63 6965 7322 2c0a 2020 2020 2020  dencies",.      
-00047f50: 2020 2020 2020 7374 7228 7473 2e77 6169        str(ts.wai
-00047f60: 7469 6e67 5f6f 6e29 2c0a 2020 2020 2020  ting_on),.      
-00047f70: 2020 2020 2020 7374 7228 7473 2e64 6570        str(ts.dep
-00047f80: 656e 6465 6e63 6965 7329 2c0a 2020 2020  endencies),.    
-00047f90: 2020 2020 290a 2020 2020 6966 2074 732e      ).    if ts.
-00047fa0: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
-00047fb0: 2061 7373 6572 7420 7473 2e77 6169 7465   assert ts.waite
-00047fc0: 7273 2e69 7373 7562 7365 7428 7473 2e64  rs.issubset(ts.d
-00047fd0: 6570 656e 6465 6e74 7329 2c20 280a 2020  ependents), (.  
-00047fe0: 2020 2020 2020 2020 2020 2277 6169 7465            "waite
-00047ff0: 7273 206e 6f74 2073 7562 7365 7420 6f66  rs not subset of
-00048000: 2064 6570 656e 6465 6e74 7322 2c0a 2020   dependents",.  
-00048010: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-00048020: 2e77 6169 7465 7273 292c 0a20 2020 2020  .waiters),.     
-00048030: 2020 2020 2020 2073 7472 2874 732e 6465         str(ts.de
-00048040: 7065 6e64 656e 7473 292c 0a20 2020 2020  pendents),.     
-00048050: 2020 2029 0a0a 2020 2020 666f 7220 6474     )..    for dt
-00048060: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
-00048070: 6f6e 3a0a 2020 2020 2020 2020 6173 7365  on:.        asse
-00048080: 7274 206e 6f74 2064 7473 2e77 686f 5f68  rt not dts.who_h
-00048090: 6173 2c20 2822 7761 6974 696e 6720 6f6e  as, ("waiting on
-000480a0: 2069 6e2d 6d65 6d6f 7279 2064 6570 222c   in-memory dep",
-000480b0: 2073 7472 2874 7329 2c20 7374 7228 6474   str(ts), str(dt
-000480c0: 7329 290a 2020 2020 2020 2020 6173 7365  s)).        asse
-000480d0: 7274 2064 7473 2e73 7461 7465 2021 3d20  rt dts.state != 
-000480e0: 2272 656c 6561 7365 6422 2c20 2822 7761  "released", ("wa
-000480f0: 6974 696e 6720 6f6e 2072 656c 6561 7365  iting on release
-00048100: 6420 6465 7022 2c20 7374 7228 7473 292c  d dep", str(ts),
-00048110: 2073 7472 2864 7473 2929 0a20 2020 2066   str(dts)).    f
-00048120: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00048130: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00048140: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00048150: 6474 732e 6465 7065 6e64 656e 7473 2c20  dts.dependents, 
-00048160: 280a 2020 2020 2020 2020 2020 2020 226e  (.            "n
-00048170: 6f74 2069 6e20 6465 7065 6e64 656e 6379  ot in dependency
-00048180: 2773 2064 6570 656e 6465 6e74 7322 2c0a  's dependents",.
-00048190: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-000481a0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-000481b0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
-000481c0: 2020 2020 2020 2073 7472 2864 7473 2e64         str(dts.d
-000481d0: 6570 656e 6465 6e74 7329 2c0a 2020 2020  ependents),.    
-000481e0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-000481f0: 2074 732e 7374 6174 6520 696e 2028 2277   ts.state in ("w
-00048200: 6169 7469 6e67 222c 2022 7175 6575 6564  aiting", "queued
-00048210: 222c 2022 7072 6f63 6573 7369 6e67 222c  ", "processing",
-00048220: 2022 6e6f 2d77 6f72 6b65 7222 293a 0a20   "no-worker"):. 
-00048230: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00048240: 7420 6474 7320 696e 2074 732e 7761 6974  t dts in ts.wait
-00048250: 696e 675f 6f6e 206f 7220 6474 732e 7768  ing_on or dts.wh
-00048260: 6f5f 6861 732c 2028 0a20 2020 2020 2020  o_has, (.       
-00048270: 2020 2020 2020 2020 2022 6465 7020 6d69           "dep mi
-00048280: 7373 696e 6722 2c0a 2020 2020 2020 2020  ssing",.        
-00048290: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-000482a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000482b0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
-000482c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000482d0: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
-000482e0: 6520 213d 2022 666f 7267 6f74 7465 6e22  e != "forgotten"
-000482f0: 0a0a 2020 2020 666f 7220 6474 7320 696e  ..    for dts in
-00048300: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
-00048310: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
-00048320: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
-00048330: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
-00048340: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
-00048350: 2d77 6f72 6b65 7222 292c 2028 0a20 2020  -worker"), (.   
-00048360: 2020 2020 2020 2020 2022 7761 6974 6572           "waiter
-00048370: 206e 6f74 2069 6e20 706c 6179 222c 0a20   not in play",. 
-00048380: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-00048390: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000483a0: 7374 7228 6474 7329 2c0a 2020 2020 2020  str(dts),.      
-000483b0: 2020 290a 2020 2020 666f 7220 6474 7320    ).    for dts 
-000483c0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-000483d0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-000483e0: 2074 7320 696e 2064 7473 2e64 6570 656e   ts in dts.depen
-000483f0: 6465 6e63 6965 732c 2028 0a20 2020 2020  dencies, (.     
-00048400: 2020 2020 2020 2022 6e6f 7420 696e 2064         "not in d
-00048410: 6570 656e 6465 6e74 2773 2064 6570 656e  ependent's depen
-00048420: 6465 6e63 6965 7322 2c0a 2020 2020 2020  dencies",.      
-00048430: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
-00048440: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
-00048450: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048460: 2073 7472 2864 7473 2e64 6570 656e 6465   str(dts.depende
-00048470: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
-00048480: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00048490: 2064 7473 2e73 7461 7465 2021 3d20 2266   dts.state != "f
-000484a0: 6f72 676f 7474 656e 220a 0a20 2020 2061  orgotten"..    a
-000484b0: 7373 6572 7420 2874 732e 7072 6f63 6573  ssert (ts.proces
-000484c0: 7369 6e67 5f6f 6e20 6973 206e 6f74 204e  sing_on is not N
-000484d0: 6f6e 6529 203d 3d20 2874 732e 7374 6174  one) == (ts.stat
-000484e0: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
-000484f0: 2229 0a20 2020 2061 7373 6572 7420 626f  ").    assert bo
-00048500: 6f6c 2874 732e 7768 6f5f 6861 7329 203d  ol(ts.who_has) =
-00048510: 3d20 2874 732e 7374 6174 6520 3d3d 2022  = (ts.state == "
-00048520: 6d65 6d6f 7279 2229 2c20 2874 732c 2074  memory"), (ts, t
-00048530: 732e 7768 6f5f 6861 732c 2074 732e 7374  s.who_has, ts.st
-00048540: 6174 6529 0a0a 2020 2020 6966 2074 732e  ate)..    if ts.
-00048550: 7374 6174 6520 3d3d 2022 7175 6575 6564  state == "queued
-00048560: 223a 0a20 2020 2020 2020 2061 7373 6572  ":.        asser
-00048570: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00048580: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-00048590: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-000485a0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-000485b0: 6572 7420 616c 6c28 6474 732e 7768 6f5f  ert all(dts.who_
-000485c0: 6861 7320 666f 7220 6474 7320 696e 2074  has for dts in t
-000485d0: 732e 6465 7065 6e64 656e 6369 6573 292c  s.dependencies),
-000485e0: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-000485f0: 7461 736b 2071 7565 7565 6420 7769 7468  task queued with
-00048600: 6f75 7420 616c 6c20 6465 7073 222c 0a20  out all deps",. 
-00048610: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-00048620: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00048630: 7374 7228 7473 2e64 6570 656e 6465 6e63  str(ts.dependenc
-00048640: 6965 7329 2c0a 2020 2020 2020 2020 290a  ies),.        ).
-00048650: 0a20 2020 2069 6620 7473 2e73 7461 7465  .    if ts.state
-00048660: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
-00048670: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00048680: 2061 6c6c 2864 7473 2e77 686f 5f68 6173   all(dts.who_has
-00048690: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-000486a0: 6570 656e 6465 6e63 6965 7329 2c20 280a  ependencies), (.
-000486b0: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
-000486c0: 6b20 7072 6f63 6573 7369 6e67 2077 6974  k processing wit
-000486d0: 686f 7574 2061 6c6c 2064 6570 7322 2c0a  hout all deps",.
-000486e0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-000486f0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048700: 2073 7472 2874 732e 6465 7065 6e64 656e   str(ts.dependen
-00048710: 6369 6573 292c 0a20 2020 2020 2020 2029  cies),.        )
-00048720: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00048730: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00048740: 6e0a 0a20 2020 2069 6620 7473 2e77 686f  n..    if ts.who
-00048750: 5f68 6173 3a0a 2020 2020 2020 2020 6173  _has:.        as
-00048760: 7365 7274 2074 732e 7761 6974 6572 7320  sert ts.waiters 
-00048770: 6f72 2074 732e 7768 6f5f 7761 6e74 732c  or ts.who_wants,
-00048780: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-00048790: 756e 6e65 6564 6564 2074 6173 6b20 696e  unneeded task in
-000487a0: 206d 656d 6f72 7922 2c0a 2020 2020 2020   memory",.      
-000487b0: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
-000487c0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-000487d0: 732e 7768 6f5f 6861 7329 2c0a 2020 2020  s.who_has),.    
-000487e0: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-000487f0: 2074 732e 7275 6e5f 7370 6563 3a20 2023   ts.run_spec:  #
-00048800: 2077 6173 2063 6f6d 7075 7465 640a 2020   was computed.  
-00048810: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00048820: 2074 732e 7479 7065 0a20 2020 2020 2020   ts.type.       
-00048830: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00048840: 7374 616e 6365 2874 732e 7479 7065 2c20  stance(ts.type, 
-00048850: 7374 7229 0a20 2020 2020 2020 2061 7373  str).        ass
-00048860: 6572 7420 6e6f 7420 616e 7928 5b74 7320  ert not any([ts 
-00048870: 696e 2064 7473 2e77 6169 7469 6e67 5f6f  in dts.waiting_o
-00048880: 6e20 666f 7220 6474 7320 696e 2074 732e  n for dts in ts.
-00048890: 6465 7065 6e64 656e 7473 5d29 0a20 2020  dependents]).   
-000488a0: 2020 2020 2066 6f72 2077 7320 696e 2074       for ws in t
-000488b0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
-000488c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000488d0: 2069 6e20 7773 2e68 6173 5f77 6861 742c   in ws.has_what,
-000488e0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-000488f0: 2020 2022 6e6f 7420 696e 2077 686f 5f68     "not in who_h
-00048900: 6173 2720 6861 735f 7768 6174 222c 0a20  as' has_what",. 
-00048910: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00048920: 7472 2874 7329 2c0a 2020 2020 2020 2020  tr(ts),.        
-00048930: 2020 2020 2020 2020 7374 7228 7773 292c          str(ws),
-00048940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048950: 2073 7472 2877 732e 6861 735f 7768 6174   str(ws.has_what
-00048960: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-00048970: 0a0a 2020 2020 666f 7220 6373 2069 6e20  ..    for cs in 
-00048980: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-00048990: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-000489a0: 696e 2063 732e 7761 6e74 735f 7768 6174  in cs.wants_what
-000489b0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-000489c0: 226e 6f74 2069 6e20 7768 6f5f 7761 6e74  "not in who_want
-000489d0: 7327 2077 616e 7473 5f77 6861 7422 2c0a  s' wants_what",.
-000489e0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-000489f0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048a00: 2073 7472 2863 7329 2c0a 2020 2020 2020   str(cs),.      
-00048a10: 2020 2020 2020 7374 7228 6373 2e77 616e        str(cs.wan
-00048a20: 7473 5f77 6861 7429 2c0a 2020 2020 2020  ts_what),.      
-00048a30: 2020 290a 0a20 2020 2069 6620 7473 2e61    )..    if ts.a
-00048a40: 6374 6f72 3a0a 2020 2020 2020 2020 6966  ctor:.        if
-00048a50: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
-00048a60: 6d6f 7279 223a 0a20 2020 2020 2020 2020  mory":.         
-00048a70: 2020 2061 7373 6572 7420 7375 6d28 7473     assert sum(ts
-00048a80: 2069 6e20 7773 2e61 6374 6f72 7320 666f   in ws.actors fo
-00048a90: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
-00048aa0: 6173 2920 3d3d 2031 0a20 2020 2020 2020  as) == 1.       
-00048ab0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
-00048ac0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
-00048ad0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00048ae0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00048af0: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00048b00: 7365 7274 2074 7320 696e 2074 732e 7072  sert ts in ts.pr
-00048b10: 6f63 6573 7369 6e67 5f6f 6e2e 6163 746f  ocessing_on.acto
-00048b20: 7273 0a20 2020 2020 2020 2061 7373 6572  rs.        asser
-00048b30: 7420 7473 2e73 7461 7465 2021 3d20 2271  t ts.state != "q
-00048b40: 7565 7565 6422 0a0a 0a64 6566 2076 616c  ueued"...def val
-00048b50: 6964 6174 655f 776f 726b 6572 5f73 7461  idate_worker_sta
-00048b60: 7465 2877 733a 2057 6f72 6b65 7253 7461  te(ws: WorkerSta
-00048b70: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-00048b80: 2066 6f72 2074 7320 696e 2077 732e 6861   for ts in ws.ha
-00048b90: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
-00048ba0: 6173 7365 7274 2077 7320 696e 2074 732e  assert ws in ts.
-00048bb0: 7768 6f5f 6861 732c 2028 0a20 2020 2020  who_has, (.     
-00048bc0: 2020 2020 2020 2022 6e6f 7420 696e 2068         "not in h
-00048bd0: 6173 5f77 6861 7427 2077 686f 5f68 6173  as_what' who_has
-00048be0: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00048bf0: 7472 2877 7329 2c0a 2020 2020 2020 2020  tr(ws),.        
-00048c00: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
-00048c10: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
-00048c20: 7768 6f5f 6861 7329 2c0a 2020 2020 2020  who_has),.      
-00048c30: 2020 290a 0a20 2020 2066 6f72 2074 7320    )..    for ts 
-00048c40: 696e 2077 732e 6163 746f 7273 3a0a 2020  in ws.actors:.  
-00048c50: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00048c60: 7374 6174 6520 696e 2028 226d 656d 6f72  state in ("memor
-00048c70: 7922 2c20 2270 726f 6365 7373 696e 6722  y", "processing"
-00048c80: 290a 0a0a 6465 6620 7661 6c69 6461 7465  )...def validate
-00048c90: 5f73 7461 7465 280a 2020 2020 7461 736b  _state(.    task
-00048ca0: 733a 2064 6963 745b 7374 722c 2054 6173  s: dict[str, Tas
-00048cb0: 6b53 7461 7465 5d2c 0a20 2020 2077 6f72  kState],.    wor
-00048cc0: 6b65 7273 3a20 6469 6374 5b73 7472 2c20  kers: dict[str, 
-00048cd0: 576f 726b 6572 5374 6174 655d 2c0a 2020  WorkerState],.  
-00048ce0: 2020 636c 6965 6e74 733a 2064 6963 745b    clients: dict[
-00048cf0: 7374 722c 2043 6c69 656e 7453 7461 7465  str, ClientState
-00048d00: 5d2c 0a29 202d 3e20 4e6f 6e65 3a0a 2020  ],.) -> None:.  
-00048d10: 2020 2222 2256 616c 6964 6174 6520 6120    """Validate a 
-00048d20: 6375 7272 656e 7420 7275 6e74 696d 6520  current runtime 
-00048d30: 7374 6174 652e 0a0a 2020 2020 5468 6973  state...    This
-00048d40: 2070 6572 666f 726d 7320 6120 7365 7175   performs a sequ
-00048d50: 656e 6365 206f 6620 6368 6563 6b73 206f  ence of checks o
-00048d60: 6e20 7468 6520 656e 7469 7265 2067 7261  n the entire gra
-00048d70: 7068 2c20 7275 6e6e 696e 6720 696e 2061  ph, running in a
-00048d80: 626f 7574 206c 696e 6561 720a 2020 2020  bout linear.    
-00048d90: 7469 6d65 2e20 5468 6973 2072 6169 7365  time. This raise
-00048da0: 7320 6173 7365 7274 2065 7272 6f72 7320  s assert errors 
-00048db0: 6966 2061 6e79 7468 696e 6720 646f 6573  if anything does
-00048dc0: 6e27 7420 6368 6563 6b20 6f75 742e 0a20  n't check out.. 
-00048dd0: 2020 2022 2222 0a20 2020 2066 6f72 2074     """.    for t
-00048de0: 7320 696e 2074 6173 6b73 2e76 616c 7565  s in tasks.value
-00048df0: 7328 293a 0a20 2020 2020 2020 2076 616c  s():.        val
-00048e00: 6964 6174 655f 7461 736b 5f73 7461 7465  idate_task_state
-00048e10: 2874 7329 0a0a 2020 2020 666f 7220 7773  (ts)..    for ws
-00048e20: 2069 6e20 776f 726b 6572 732e 7661 6c75   in workers.valu
-00048e30: 6573 2829 3a0a 2020 2020 2020 2020 7661  es():.        va
-00048e40: 6c69 6461 7465 5f77 6f72 6b65 725f 7374  lidate_worker_st
-00048e50: 6174 6528 7773 290a 0a20 2020 2066 6f72  ate(ws)..    for
-00048e60: 2063 7320 696e 2063 6c69 656e 7473 2e76   cs in clients.v
-00048e70: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-00048e80: 2066 6f72 2074 7320 696e 2063 732e 7761   for ts in cs.wa
-00048e90: 6e74 735f 7768 6174 3a0a 2020 2020 2020  nts_what:.      
-00048ea0: 2020 2020 2020 6173 7365 7274 2063 7320        assert cs 
-00048eb0: 696e 2074 732e 7768 6f5f 7761 6e74 732c  in ts.who_wants,
-00048ec0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00048ed0: 2020 2022 6e6f 7420 696e 2077 616e 7473     "not in wants
-00048ee0: 5f77 6861 7427 2077 686f 5f77 616e 7473  _what' who_wants
-00048ef0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00048f00: 2020 2073 7472 2863 7329 2c0a 2020 2020     str(cs),.    
-00048f10: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048f20: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048f30: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
-00048f40: 7761 6e74 7329 2c0a 2020 2020 2020 2020  wants),.        
-00048f50: 2020 2020 290a 0a0a 6465 6620 6865 6172      )...def hear
-00048f60: 7462 6561 745f 696e 7465 7276 616c 286e  tbeat_interval(n
-00048f70: 3a20 696e 7429 202d 3e20 666c 6f61 743a  : int) -> float:
-00048f80: 0a20 2020 2022 2222 496e 7465 7276 616c  .    """Interval
-00048f90: 2069 6e20 7365 636f 6e64 7320 7468 6174   in seconds that
-00048fa0: 2077 6520 6465 7369 7265 2068 6561 7274   we desire heart
-00048fb0: 6265 6174 7320 6261 7365 6420 6f6e 206e  beats based on n
-00048fc0: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-00048fd0: 2222 220a 2020 2020 6966 206e 203c 3d20  """.    if n <= 
-00048fe0: 3130 3a0a 2020 2020 2020 2020 7265 7475  10:.        retu
-00048ff0: 726e 2030 2e35 0a20 2020 2065 6c69 6620  rn 0.5.    elif 
-00049000: 6e20 3c20 3530 3a0a 2020 2020 2020 2020  n < 50:.        
-00049010: 7265 7475 726e 2031 0a20 2020 2065 6c69  return 1.    eli
-00049020: 6620 6e20 3c20 3230 303a 0a20 2020 2020  f n < 200:.     
-00049030: 2020 2072 6574 7572 6e20 320a 2020 2020     return 2.    
-00049040: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00049050: 4e6f 206d 6f72 6520 7468 616e 2032 3030  No more than 200
-00049060: 2068 6561 7274 6265 6174 7320 6120 7365   heartbeats a se
-00049070: 636f 6e64 2073 6361 6c65 6420 6279 2077  cond scaled by w
-00049080: 6f72 6b65 7273 0a20 2020 2020 2020 2072  orkers.        r
-00049090: 6574 7572 6e20 6e20 2f20 3230 3020 2b20  eturn n / 200 + 
-000490a0: 310a 0a0a 6465 6620 5f74 6173 6b5f 736c  1...def _task_sl
-000490b0: 6f74 735f 6176 6169 6c61 626c 6528 7773  ots_available(ws
-000490c0: 3a20 576f 726b 6572 5374 6174 652c 2073  : WorkerState, s
-000490d0: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
-000490e0: 3a20 666c 6f61 7429 202d 3e20 696e 743a  : float) -> int:
-000490f0: 0a20 2020 2022 2222 4e75 6d62 6572 206f  .    """Number o
-00049100: 6620 7461 736b 7320 7468 6174 2063 616e  f tasks that can
-00049110: 2062 6520 7365 6e74 2074 6f20 7468 6973   be sent to this
-00049120: 2077 6f72 6b65 7220 7769 7468 6f75 7420   worker without 
-00049130: 6f76 6572 7361 7475 7261 7469 6e67 2069  oversaturating i
-00049140: 7422 2222 0a20 2020 2061 7373 6572 7420  t""".    assert 
-00049150: 6e6f 7420 6d61 7468 2e69 7369 6e66 2873  not math.isinf(s
-00049160: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
-00049170: 290a 2020 2020 7265 7475 726e 206d 6178  ).    return max
-00049180: 286d 6174 682e 6365 696c 2873 6174 7572  (math.ceil(satur
-00049190: 6174 696f 6e5f 6661 6374 6f72 202a 2077  ation_factor * w
-000491a0: 732e 6e74 6872 6561 6473 292c 2031 2920  s.nthreads), 1) 
-000491b0: 2d20 280a 2020 2020 2020 2020 6c65 6e28  - (.        len(
-000491c0: 7773 2e70 726f 6365 7373 696e 6729 202d  ws.processing) -
-000491d0: 206c 656e 2877 732e 6c6f 6e67 5f72 756e   len(ws.long_run
-000491e0: 6e69 6e67 290a 2020 2020 290a 0a0a 6465  ning).    )...de
-000491f0: 6620 5f77 6f72 6b65 725f 6675 6c6c 2877  f _worker_full(w
-00049200: 733a 2057 6f72 6b65 7253 7461 7465 2c20  s: WorkerState, 
-00049210: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
-00049220: 723a 2066 6c6f 6174 2920 2d3e 2062 6f6f  r: float) -> boo
-00049230: 6c3a 0a20 2020 2069 6620 6d61 7468 2e69  l:.    if math.i
-00049240: 7369 6e66 2873 6174 7572 6174 696f 6e5f  sinf(saturation_
-00049250: 6661 6374 6f72 293a 0a20 2020 2020 2020  factor):.       
-00049260: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-00049270: 2020 7265 7475 726e 205f 7461 736b 5f73    return _task_s
-00049280: 6c6f 7473 5f61 7661 696c 6162 6c65 2877  lots_available(w
-00049290: 732c 2073 6174 7572 6174 696f 6e5f 6661  s, saturation_fa
-000492a0: 6374 6f72 2920 3c3d 2030 0a0a 0a63 6c61  ctor) <= 0...cla
-000492b0: 7373 204b 696c 6c65 6457 6f72 6b65 7228  ss KilledWorker(
-000492c0: 4578 6365 7074 696f 6e29 3a0a 2020 2020  Exception):.    
-000492d0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-000492e0: 662c 2074 6173 6b3a 2073 7472 2c20 6c61  f, task: str, la
-000492f0: 7374 5f77 6f72 6b65 723a 2057 6f72 6b65  st_worker: Worke
-00049300: 7253 7461 7465 2c20 616c 6c6f 7765 645f  rState, allowed_
-00049310: 6661 696c 7572 6573 3a20 696e 7429 3a0a  failures: int):.
-00049320: 2020 2020 2020 2020 7375 7065 7228 292e          super().
-00049330: 5f5f 696e 6974 5f5f 2874 6173 6b2c 206c  __init__(task, l
-00049340: 6173 745f 776f 726b 6572 2c20 616c 6c6f  ast_worker, allo
-00049350: 7765 645f 6661 696c 7572 6573 290a 0a20  wed_failures).. 
-00049360: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00049370: 2064 6566 2074 6173 6b28 7365 6c66 2920   def task(self) 
-00049380: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-00049390: 7265 7475 726e 2073 656c 662e 6172 6773  return self.args
-000493a0: 5b30 5d0a 0a20 2020 2040 7072 6f70 6572  [0]..    @proper
-000493b0: 7479 0a20 2020 2064 6566 206c 6173 745f  ty.    def last_
-000493c0: 776f 726b 6572 2873 656c 6629 202d 3e20  worker(self) -> 
-000493d0: 576f 726b 6572 5374 6174 653a 0a20 2020  WorkerState:.   
-000493e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000493f0: 2e61 7267 735b 315d 0a0a 2020 2020 4070  .args[1]..    @p
-00049400: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00049410: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-00049420: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
-00049430: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00049440: 6c66 2e61 7267 735b 325d 0a0a 2020 2020  lf.args[2]..    
-00049450: 6465 6620 5f5f 7374 725f 5f28 7365 6c66  def __str__(self
-00049460: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00049470: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-00049480: 2020 2020 2020 2066 2241 7474 656d 7074         f"Attempt
-00049490: 6564 2074 6f20 7275 6e20 7461 736b 207b  ed to run task {
-000494a0: 7365 6c66 2e74 6173 6b7d 206f 6e20 7b73  self.task} on {s
-000494b0: 656c 662e 616c 6c6f 7765 645f 6661 696c  elf.allowed_fail
-000494c0: 7572 6573 7d20 6469 6666 6572 656e 7420  ures} different 
-000494d0: 220a 2020 2020 2020 2020 2020 2020 2277  ".            "w
-000494e0: 6f72 6b65 7273 2c20 6275 7420 616c 6c20  orkers, but all 
-000494f0: 7468 6f73 6520 776f 726b 6572 7320 6469  those workers di
-00049500: 6564 2077 6869 6c65 2072 756e 6e69 6e67  ed while running
-00049510: 2069 742e 2022 0a20 2020 2020 2020 2020   it. ".         
-00049520: 2020 2066 2254 6865 206c 6173 7420 776f     f"The last wo
-00049530: 726b 6572 2074 6861 7420 6174 7465 6d70  rker that attemp
-00049540: 7420 746f 2072 756e 2074 6865 2074 6173  t to run the tas
-00049550: 6b20 7761 7320 7b73 656c 662e 6c61 7374  k was {self.last
-00049560: 5f77 6f72 6b65 722e 6164 6472 6573 737d  _worker.address}
-00049570: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-00049580: 2249 6e73 7065 6374 696e 6720 776f 726b  "Inspecting work
-00049590: 6572 206c 6f67 7320 6973 206f 6674 656e  er logs is often
-000495a0: 2061 2067 6f6f 6420 6e65 7874 2073 7465   a good next ste
-000495b0: 7020 746f 2064 6961 676e 6f73 6520 7768  p to diagnose wh
-000495c0: 6174 2077 656e 7420 7772 6f6e 672e 2022  at went wrong. "
-000495d0: 0a20 2020 2020 2020 2020 2020 2022 466f  .            "Fo
-000495e0: 7220 6d6f 7265 2069 6e66 6f72 6d61 7469  r more informati
-000495f0: 6f6e 2073 6565 2068 7474 7073 3a2f 2f64  on see https://d
-00049600: 6973 7472 6962 7574 6564 2e64 6173 6b2e  istributed.dask.
-00049610: 6f72 672f 656e 2f73 7461 626c 652f 6b69  org/en/stable/ki
-00049620: 6c6c 6564 2e68 746d 6c2e 220a 2020 2020  lled.html.".    
-00049630: 2020 2020 290a 0a0a 636c 6173 7320 576f      )...class Wo
-00049640: 726b 6572 5374 6174 7573 506c 7567 696e  rkerStatusPlugin
-00049650: 2853 6368 6564 756c 6572 506c 7567 696e  (SchedulerPlugin
-00049660: 293a 0a20 2020 2022 2222 4120 706c 7567  ):.    """A plug
-00049670: 696e 2074 6f20 7368 6172 6520 776f 726b  in to share work
-00049680: 6572 2073 7461 7475 7320 7769 7468 2061  er status with a
-00049690: 2072 656d 6f74 6520 6f62 7365 7276 6572   remote observer
-000496a0: 0a0a 2020 2020 5468 6973 2069 7320 7573  ..    This is us
-000496b0: 6564 2069 6e20 636c 7573 7465 7220 6d61  ed in cluster ma
-000496c0: 6e61 6765 7273 2074 6f20 6b65 6570 2075  nagers to keep u
-000496d0: 7064 6174 6564 2061 626f 7574 2074 6865  pdated about the
-000496e0: 2073 7461 7475 7320 6f66 2074 6865 2073   status of the s
-000496f0: 6368 6564 756c 6572 2e0a 2020 2020 2222  cheduler..    ""
-00049700: 220a 0a20 2020 206e 616d 653a 2043 6c61  "..    name: Cla
-00049710: 7373 5661 725b 7374 725d 203d 2022 776f  ssVar[str] = "wo
-00049720: 726b 6572 2d73 7461 7475 7322 0a20 2020  rker-status".   
-00049730: 2062 636f 6d6d 3a20 4261 7463 6865 6453   bcomm: BatchedS
-00049740: 656e 640a 0a20 2020 2064 6566 205f 5f69  end..    def __i
-00049750: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-00049760: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
-00049770: 2c20 636f 6d6d 3a20 436f 6d6d 293a 0a20  , comm: Comm):. 
-00049780: 2020 2020 2020 2073 656c 662e 6263 6f6d         self.bcom
-00049790: 6d20 3d20 4261 7463 6865 6453 656e 6428  m = BatchedSend(
-000497a0: 696e 7465 7276 616c 3d22 356d 7322 290a  interval="5ms").
-000497b0: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
-000497c0: 6d6d 2e73 7461 7274 2863 6f6d 6d29 0a20  mm.start(comm). 
-000497d0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-000497e0: 2e61 6464 5f70 6c75 6769 6e28 7365 6c66  .add_plugin(self
-000497f0: 290a 0a20 2020 2064 6566 2061 6464 5f77  )..    def add_w
-00049800: 6f72 6b65 7228 7365 6c66 2c20 7363 6865  orker(self, sche
-00049810: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
-00049820: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
-00049830: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00049840: 6964 656e 7420 3d20 7363 6865 6475 6c65  ident = schedule
-00049850: 722e 776f 726b 6572 735b 776f 726b 6572  r.workers[worker
-00049860: 5d2e 6964 656e 7469 7479 2829 0a20 2020  ].identity().   
-00049870: 2020 2020 2064 656c 2069 6465 6e74 5b22       del ident["
-00049880: 6d65 7472 6963 7322 5d0a 2020 2020 2020  metrics"].      
-00049890: 2020 6465 6c20 6964 656e 745b 226c 6173    del ident["las
-000498a0: 745f 7365 656e 225d 0a20 2020 2020 2020  t_seen"].       
-000498b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000498c0: 2020 7365 6c66 2e62 636f 6d6d 2e73 656e    self.bcomm.sen
-000498d0: 6428 5b22 6164 6422 2c20 7b22 776f 726b  d(["add", {"work
-000498e0: 6572 7322 3a20 7b77 6f72 6b65 723a 2069  ers": {worker: i
-000498f0: 6465 6e74 7d7d 5d29 0a20 2020 2020 2020  dent}}]).       
-00049900: 2065 7863 6570 7420 436f 6d6d 436c 6f73   except CommClos
-00049910: 6564 4572 726f 723a 0a20 2020 2020 2020  edError:.       
-00049920: 2020 2020 2073 6368 6564 756c 6572 2e72       scheduler.r
-00049930: 656d 6f76 655f 706c 7567 696e 286e 616d  emove_plugin(nam
-00049940: 653d 7365 6c66 2e6e 616d 6529 0a0a 2020  e=self.name)..  
-00049950: 2020 6465 6620 7265 6d6f 7665 5f77 6f72    def remove_wor
-00049960: 6b65 7228 7365 6c66 2c20 7363 6865 6475  ker(self, schedu
-00049970: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
-00049980: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-00049990: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
-000499a0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-000499b0: 656c 662e 6263 6f6d 6d2e 7365 6e64 285b  elf.bcomm.send([
-000499c0: 2272 656d 6f76 6522 2c20 776f 726b 6572  "remove", worker
-000499d0: 5d29 0a20 2020 2020 2020 2065 7863 6570  ]).        excep
-000499e0: 7420 436f 6d6d 436c 6f73 6564 4572 726f  t CommClosedErro
-000499f0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
-00049a00: 6368 6564 756c 6572 2e72 656d 6f76 655f  cheduler.remove_
-00049a10: 706c 7567 696e 286e 616d 653d 7365 6c66  plugin(name=self
-00049a20: 2e6e 616d 6529 0a0a 2020 2020 6465 6620  .name)..    def 
-00049a30: 7465 6172 646f 776e 2873 656c 6629 202d  teardown(self) -
-00049a40: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00049a50: 7365 6c66 2e62 636f 6d6d 2e63 6c6f 7365  self.bcomm.close
-00049a60: 2829 0a0a 0a63 6c61 7373 2043 6f6c 6c65  ()...class Colle
-00049a70: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
-00049a80: 7567 696e 2853 6368 6564 756c 6572 506c  ugin(SchedulerPl
-00049a90: 7567 696e 293a 0a20 2020 2073 6368 6564  ugin):.    sched
-00049aa0: 756c 6572 3a20 5363 6865 6475 6c65 720a  uler: Scheduler.
-00049ab0: 2020 2020 6e61 6d65 3a20 7374 720a 2020      name: str.  
-00049ac0: 2020 6b65 7973 3a20 7365 745b 7374 725d    keys: set[str]
-00049ad0: 0a20 2020 206d 6574 6164 6174 613a 2064  .    metadata: d
-00049ae0: 6963 745b 7374 722c 2041 6e79 5d0a 2020  ict[str, Any].  
-00049af0: 2020 7374 6174 653a 2064 6963 745b 7374    state: dict[st
-00049b00: 722c 2073 7472 5d0a 0a20 2020 2064 6566  r, str]..    def
-00049b10: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00049b20: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
-00049b30: 756c 6572 2c20 6e61 6d65 3a20 7374 7229  uler, name: str)
-00049b40: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00049b50: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00049b60: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
-00049b70: 662e 6e61 6d65 203d 206e 616d 650a 2020  f.name = name.  
-00049b80: 2020 2020 2020 7365 6c66 2e6b 6579 7320        self.keys 
-00049b90: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00049ba0: 7365 6c66 2e6d 6574 6164 6174 6120 3d20  self.metadata = 
-00049bb0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00049bc0: 7374 6174 6520 3d20 7b7d 0a0a 2020 2020  state = {}..    
-00049bd0: 6465 6620 7570 6461 7465 5f67 7261 7068  def update_graph
-00049be0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00049bf0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00049c00: 723a 2053 6368 6564 756c 6572 2c0a 2020  r: Scheduler,.  
-00049c10: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00049c20: 206b 6579 733a 2073 6574 5b73 7472 5d2c   keys: set[str],
-00049c30: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00049c40: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-00049c50: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
-00049c60: 656c 662e 6b65 7973 2e75 7064 6174 6528  elf.keys.update(
-00049c70: 6b65 7973 290a 0a20 2020 2064 6566 2074  keys)..    def t
-00049c80: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
-00049c90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00049ca0: 206b 6579 3a20 7374 722c 0a20 2020 2020   key: str,.     
-00049cb0: 2020 2073 7461 7274 3a20 5461 736b 5374     start: TaskSt
-00049cc0: 6174 6553 7461 7465 2c0a 2020 2020 2020  ateState,.      
-00049cd0: 2020 6669 6e69 7368 3a20 5461 736b 5374    finish: TaskSt
-00049ce0: 6174 6553 7461 7465 2c0a 2020 2020 2020  ateState,.      
-00049cf0: 2020 2a61 7267 733a 2041 6e79 2c0a 2020    *args: Any,.  
-00049d00: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-00049d10: 416e 792c 0a20 2020 2029 202d 3e20 4e6f  Any,.    ) -> No
-00049d20: 6e65 3a0a 2020 2020 2020 2020 6966 2066  ne:.        if f
-00049d30: 696e 6973 6820 696e 2028 226d 656d 6f72  inish in ("memor
-00049d40: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
-00049d50: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00049d60: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-00049d70: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-00049d80: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-00049d90: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
-00049da0: 732e 6b65 7920 696e 2073 656c 662e 6b65  s.key in self.ke
-00049db0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00049dc0: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
-00049dd0: 615b 6b65 795d 203d 2074 732e 6d65 7461  a[key] = ts.meta
-00049de0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-00049df0: 2020 2020 2073 656c 662e 7374 6174 655b       self.state[
-00049e00: 6b65 795d 203d 2066 696e 6973 680a 2020  key] = finish.  
-00049e10: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00049e20: 6c66 2e6b 6579 732e 6469 7363 6172 6428  lf.keys.discard(
-00049e30: 6b65 7929 0a                             key).
+00034f40: 2022 646f 776e 2069 6e73 7465 6164 206f   "down instead o
+00034f50: 6620 7265 7374 6172 7465 6420 2872 6573  f restarted (res
+00034f60: 7461 7274 2069 7320 6f6e 6c79 2070 6f73  tart is only pos
+00034f70: 7369 626c 6520 7769 7468 204e 616e 6e69  sible with Nanni
+00034f80: 6573 292e 2049 6620 220a 2020 2020 2020  es). If ".      
+00034f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034fa0: 2020 2020 2020 2279 6f75 7220 6465 706c        "your depl
+00034fb0: 6f79 6d65 6e74 2073 7973 7465 6d20 646f  oyment system do
+00034fc0: 6573 206e 6f74 2061 7574 6f6d 6174 6963  es not automatic
+00034fd0: 616c 6c79 2072 652d 6c61 756e 6368 2074  ally re-launch t
+00034fe0: 6572 6d69 6e61 7465 6420 220a 2020 2020  erminated ".    
+00034ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035000: 2020 2020 2020 2020 2270 726f 6365 7373          "process
+00035010: 6573 2c20 7468 656e 2074 686f 7365 2077  es, then those w
+00035020: 6f72 6b65 7273 2077 696c 6c20 6e65 7665  orkers will neve
+00035030: 7220 636f 6d65 2062 6163 6b2c 2061 6e64  r come back, and
+00035040: 2060 436c 6965 6e74 2e72 6573 7461 7274   `Client.restart
+00035050: 6020 220a 2020 2020 2020 2020 2020 2020  ` ".            
+00035060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035070: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
+00035080: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
+00035090: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
+000350a0: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
+000350b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000350c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000350d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000350e0: 7261 6973 6520 5469 6d65 6f75 7445 7272  raise TimeoutErr
+000350f0: 6f72 286d 7367 2920 6672 6f6d 204e 6f6e  or(msg) from Non
+00035100: 650a 2020 2020 2020 2020 6c6f 6767 6572  e.        logger
+00035110: 2e69 6e66 6f28 2252 6573 7461 7274 696e  .info("Restartin
+00035120: 6720 6669 6e69 7368 6564 2e22 290a 0a20  g finished.").. 
+00035130: 2020 2061 7379 6e63 2064 6566 2062 726f     async def bro
+00035140: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
+00035150: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
+00035160: 0a20 2020 2020 2020 206d 7367 3a20 6469  .        msg: di
+00035170: 6374 2c0a 2020 2020 2020 2020 776f 726b  ct,.        work
+00035180: 6572 733a 206c 6973 745b 7374 725d 207c  ers: list[str] |
+00035190: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000351a0: 2020 2020 2020 686f 7374 733a 206c 6973        hosts: lis
+000351b0: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
+000351c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
+000351d0: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
+000351e0: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
+000351f0: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
+00035200: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
+00035210: 7272 6f72 3a20 224c 6974 6572 616c 5b27  rror: "Literal['
+00035220: 7261 6973 6527 2c20 2772 6574 7572 6e27  raise', 'return'
+00035230: 2c20 2772 6574 7572 6e5f 7069 636b 6c65  , 'return_pickle
+00035240: 272c 2027 6967 6e6f 7265 275d 2220 3d20  ', 'ignore']" = 
+00035250: 2272 6169 7365 222c 0a20 2020 2029 202d  "raise",.    ) -
+00035260: 3e20 6469 6374 3a20 2023 2064 6963 745b  > dict:  # dict[
+00035270: 7374 722c 2041 6e79 5d0a 2020 2020 2020  str, Any].      
+00035280: 2020 2222 2242 726f 6164 6361 7374 206d    """Broadcast m
+00035290: 6573 7361 6765 2074 6f20 776f 726b 6572  essage to worker
+000352a0: 732c 2072 6574 7572 6e20 616c 6c20 7265  s, return all re
+000352b0: 7375 6c74 7322 2222 0a20 2020 2020 2020  sults""".       
+000352c0: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
+000352d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000352e0: 2069 6620 686f 7374 7320 6973 204e 6f6e   if hosts is Non
+000352f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00035300: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
+00035310: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
+00035320: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00035330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035340: 2020 776f 726b 6572 7320 3d20 5b5d 0a20    workers = []. 
+00035350: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
+00035360: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00035370: 2020 2020 2020 2020 2066 6f72 2068 6f73           for hos
+00035380: 7420 696e 2068 6f73 7473 3a0a 2020 2020  t in hosts:.    
+00035390: 2020 2020 2020 2020 2020 2020 6468 3a20              dh: 
+000353a0: 6469 6374 203d 2073 656c 662e 686f 7374  dict = self.host
+000353b0: 5f69 6e66 6f2e 6765 7428 686f 7374 2920  _info.get(host) 
+000353c0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+000353d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000353e0: 6966 2064 6820 6973 206e 6f74 204e 6f6e  if dh is not Non
+000353f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00035400: 2020 2020 2020 2077 6f72 6b65 7273 2e65         workers.e
+00035410: 7874 656e 6428 6468 5b22 6164 6472 6573  xtend(dh["addres
+00035420: 7365 7322 5d29 0a20 2020 2020 2020 2023  ses"]).        #
+00035430: 2054 4f44 4f20 7265 706c 6163 6520 7769   TODO replace wi
+00035440: 7468 2077 6f72 6b65 725f 6c69 7374 0a0a  th worker_list..
+00035450: 2020 2020 2020 2020 6966 206e 616e 6e79          if nanny
+00035460: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
+00035470: 6472 6573 7365 7320 3d20 5b73 656c 662e  dresses = [self.
+00035480: 776f 726b 6572 735b 775d 2e6e 616e 6e79  workers[w].nanny
+00035490: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+000354a0: 735d 0a20 2020 2020 2020 2065 6c73 653a  s].        else:
+000354b0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
+000354c0: 7265 7373 6573 203d 2077 6f72 6b65 7273  resses = workers
+000354d0: 0a0a 2020 2020 2020 2020 4552 524f 5220  ..        ERROR 
+000354e0: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
+000354f0: 2020 2020 6173 796e 6320 6465 6620 7365      async def se
+00035500: 6e64 5f6d 6573 7361 6765 2861 6464 7229  nd_message(addr)
+00035510: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00035520: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00035530: 2020 2063 6f6d 6d20 3d20 6177 6169 7420     comm = await 
+00035540: 7365 6c66 2e72 7063 2e63 6f6e 6e65 6374  self.rpc.connect
+00035550: 2861 6464 7229 0a20 2020 2020 2020 2020  (addr).         
+00035560: 2020 2020 2020 2063 6f6d 6d2e 6e61 6d65         comm.name
+00035570: 203d 2022 5363 6865 6475 6c65 7220 4272   = "Scheduler Br
+00035580: 6f61 6463 6173 7422 0a20 2020 2020 2020  oadcast".       
+00035590: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+000355a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355b0: 2020 7265 7370 203d 2061 7761 6974 2073    resp = await s
+000355c0: 656e 645f 7265 6376 280a 2020 2020 2020  end_recv(.      
+000355d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355e0: 2020 636f 6d6d 2c20 636c 6f73 653d 5472    comm, close=Tr
+000355f0: 7565 2c20 7365 7269 616c 697a 6572 733d  ue, serializers=
+00035600: 7365 7269 616c 697a 6572 732c 202a 2a6d  serializers, **m
+00035610: 7367 0a20 2020 2020 2020 2020 2020 2020  sg.             
+00035620: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00035630: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
+00035640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035650: 2020 2020 2020 7365 6c66 2e72 7063 2e72        self.rpc.r
+00035660: 6575 7365 2861 6464 722c 2063 6f6d 6d29  euse(addr, comm)
+00035670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035680: 2072 6574 7572 6e20 7265 7370 0a20 2020   return resp.   
+00035690: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+000356a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+000356b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000356c0: 6c6f 6767 6572 2e65 7272 6f72 2866 2262  logger.error(f"b
+000356d0: 726f 6164 6361 7374 2074 6f20 7b61 6464  roadcast to {add
+000356e0: 727d 2066 6169 6c65 643a 207b 652e 5f5f  r} failed: {e.__
+000356f0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+00035700: 7d3a 207b 657d 2229 0a20 2020 2020 2020  }: {e}").       
+00035710: 2020 2020 2020 2020 2069 6620 6f6e 5f65           if on_e
+00035720: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
+00035730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035740: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+00035750: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00035760: 6f6e 5f65 7272 6f72 203d 3d20 2272 6574  on_error == "ret
+00035770: 7572 6e22 3a0a 2020 2020 2020 2020 2020  urn":.          
+00035780: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00035790: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
+000357a0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
+000357b0: 203d 3d20 2272 6574 7572 6e5f 7069 636b   == "return_pick
+000357c0: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
+000357d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000357e0: 6475 6d70 7328 6529 0a20 2020 2020 2020  dumps(e).       
+000357f0: 2020 2020 2020 2020 2065 6c69 6620 6f6e           elif on
+00035800: 5f65 7272 6f72 203d 3d20 2269 676e 6f72  _error == "ignor
+00035810: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00035820: 2020 2020 2020 2020 7265 7475 726e 2045          return E
+00035830: 5252 4f52 0a20 2020 2020 2020 2020 2020  RROR.           
+00035840: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00035850: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00035860: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00035870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035880: 2020 2020 2020 2020 2022 6f6e 5f65 7272           "on_err
+00035890: 6f72 206d 7573 7420 6265 2027 7261 6973  or must be 'rais
+000358a0: 6527 2c20 2772 6574 7572 6e27 2c20 2772  e', 'return', 'r
+000358b0: 6574 7572 6e5f 7069 636b 6c65 272c 2022  eturn_pickle', "
+000358c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000358d0: 2020 2020 2020 2020 2066 226f 7220 2769           f"or 'i
+000358e0: 676e 6f72 6527 3b20 676f 7420 7b6f 6e5f  gnore'; got {on_
+000358f0: 6572 726f 7221 727d 220a 2020 2020 2020  error!r}".      
+00035900: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00035910: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
+00035920: 203d 2061 7761 6974 2041 6c6c 280a 2020   = await All(.  
+00035930: 2020 2020 2020 2020 2020 5b73 656e 645f            [send_
+00035940: 6d65 7373 6167 6528 6164 6472 6573 7329  message(address)
+00035950: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
+00035960: 6164 6472 6573 7365 7320 6966 2061 6464  addresses if add
+00035970: 7265 7373 2069 7320 6e6f 7420 4e6f 6e65  ress is not None
+00035980: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
+00035990: 2020 2020 2072 6574 7572 6e20 7b6b 3a20       return {k: 
+000359a0: 7620 666f 7220 6b2c 2076 2069 6e20 7a69  v for k, v in zi
+000359b0: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
+000359c0: 7473 2920 6966 2076 2069 7320 6e6f 7420  ts) if v is not 
+000359d0: 4552 524f 527d 0a0a 2020 2020 6173 796e  ERROR}..    asyn
+000359e0: 6320 6465 6620 7072 6f78 7928 0a20 2020  c def proxy(.   
+000359f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00035a00: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
+00035a10: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
+00035a20: 722c 0a20 2020 2020 2020 2073 6572 6961  r,.        seria
+00035a30: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
+00035a40: 6e65 2c0a 2020 2020 2920 2d3e 2041 6e79  ne,.    ) -> Any
+00035a50: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
+00035a60: 7879 2061 2063 6f6d 6d75 6e69 6361 7469  xy a communicati
+00035a70: 6f6e 2074 6872 6f75 6768 2074 6865 2073  on through the s
+00035a80: 6368 6564 756c 6572 2074 6f20 736f 6d65  cheduler to some
+00035a90: 206f 7468 6572 2077 6f72 6b65 7222 2222   other worker"""
+00035aa0: 0a20 2020 2020 2020 2064 203d 2061 7761  .        d = awa
+00035ab0: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+00035ac0: 7428 6d73 673d 6d73 672c 2077 6f72 6b65  t(msg=msg, worke
+00035ad0: 7273 3d5b 776f 726b 6572 5d2c 2073 6572  rs=[worker], ser
+00035ae0: 6961 6c69 7a65 7273 3d73 6572 6961 6c69  ializers=seriali
+00035af0: 7a65 7273 290a 2020 2020 2020 2020 7265  zers).        re
+00035b00: 7475 726e 2064 5b77 6f72 6b65 725d 0a0a  turn d[worker]..
+00035b10: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
+00035b20: 7468 6572 5f6f 6e5f 776f 726b 6572 280a  ther_on_worker(.
+00035b30: 2020 2020 2020 2020 7365 6c66 2c20 776f          self, wo
+00035b40: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
+00035b50: 722c 2077 686f 5f68 6173 3a20 2264 6963  r, who_has: "dic
+00035b60: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
+00035b70: 5d22 0a20 2020 2029 202d 3e20 7365 743a  ]".    ) -> set:
+00035b80: 0a20 2020 2020 2020 2022 2222 5065 6572  .        """Peer
+00035b90: 2d74 6f2d 7065 6572 2063 6f70 7920 6f66  -to-peer copy of
+00035ba0: 206b 6579 7320 6672 6f6d 206d 756c 7469   keys from multi
+00035bb0: 706c 6520 776f 726b 6572 7320 746f 2061  ple workers to a
+00035bc0: 2073 696e 676c 6520 776f 726b 6572 0a0a   single worker..
+00035bd0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00035be0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00035bf0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
+00035c00: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
+00035c10: 720a 2020 2020 2020 2020 2020 2020 5265  r.            Re
+00035c20: 6369 7069 656e 7420 776f 726b 6572 2061  cipient worker a
+00035c30: 6464 7265 7373 2074 6f20 636f 7079 206b  ddress to copy k
+00035c40: 6579 7320 746f 0a20 2020 2020 2020 2077  eys to.        w
+00035c50: 686f 5f68 6173 3a20 6469 6374 5b48 6173  ho_has: dict[Has
+00035c60: 6861 626c 652c 206c 6973 745b 7374 725d  hable, list[str]
+00035c70: 5d0a 2020 2020 2020 2020 2020 2020 7b6b  ].            {k
+00035c80: 6579 3a20 5b73 656e 6465 7220 6164 6472  ey: [sender addr
+00035c90: 6573 732c 2073 656e 6465 7220 6164 6472  ess, sender addr
+00035ca0: 6573 732c 202e 2e2e 5d2c 206b 6579 3a20  ess, ...], key: 
+00035cb0: 2e2e 2e7d 0a0a 2020 2020 2020 2020 5265  ...}..        Re
+00035cc0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
+00035cd0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7265  -----.        re
+00035ce0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+00035cf0: 2020 2073 6574 206f 6620 6b65 7973 2074     set of keys t
+00035d00: 6861 7420 6661 696c 6564 2074 6f20 6265  hat failed to be
+00035d10: 2063 6f70 6965 640a 2020 2020 2020 2020   copied.        
+00035d20: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+00035d30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00035d40: 756c 7420 3d20 6177 6169 7420 7265 7472  ult = await retr
+00035d50: 795f 6f70 6572 6174 696f 6e28 0a20 2020  y_operation(.   
+00035d60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00035d70: 662e 7270 6328 6164 6472 3d77 6f72 6b65  f.rpc(addr=worke
+00035d80: 725f 6164 6472 6573 7329 2e67 6174 6865  r_address).gathe
+00035d90: 722c 2077 686f 5f68 6173 3d77 686f 5f68  r, who_has=who_h
+00035da0: 6173 0a20 2020 2020 2020 2020 2020 2029  as.            )
+00035db0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00035dc0: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
+00035dd0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+00035de0: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
+00035df0: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
+00035e00: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
+00035e10: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
+00035e20: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
+00035e30: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
+00035e40: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
+00035e50: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
+00035e60: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
+00035e70: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00035e80: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00035e90: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+00035ea0: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
+00035eb0: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
+00035ec0: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
+00035ed0: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
+00035ee0: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
+00035ef0: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
+00035f00: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
+00035f10: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
+00035f20: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00035f30: 7265 7475 726e 2073 6574 2877 686f 5f68  return set(who_h
+00035f40: 6173 290a 0a20 2020 2020 2020 2077 7320  as)..        ws 
+00035f50: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+00035f60: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
+00035f70: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
+00035f80: 6f74 2077 733a 0a20 2020 2020 2020 2020  ot ws:.         
+00035f90: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00035fa0: 6728 6622 576f 726b 6572 207b 776f 726b  g(f"Worker {work
+00035fb0: 6572 5f61 6464 7265 7373 7d20 6c6f 7374  er_address} lost
+00035fc0: 2064 7572 696e 6720 7265 706c 6963 6174   during replicat
+00035fd0: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
+00035fe0: 2020 7265 7475 726e 2073 6574 2877 686f    return set(who
+00035ff0: 5f68 6173 290a 2020 2020 2020 2020 656c  _has).        el
+00036000: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
+00036010: 7322 5d20 3d3d 2022 4f4b 223a 0a20 2020  s"] == "OK":.   
+00036020: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
+00036030: 696c 6564 203d 2073 6574 2829 0a20 2020  iled = set().   
+00036040: 2020 2020 2020 2020 206b 6579 735f 6f6b           keys_ok
+00036050: 3a20 5365 7420 3d20 7768 6f5f 6861 732e  : Set = who_has.
+00036060: 6b65 7973 2829 0a20 2020 2020 2020 2065  keys().        e
+00036070: 6c69 6620 7265 7375 6c74 5b22 7374 6174  lif result["stat
+00036080: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
+00036090: 2d66 6169 6c22 3a0a 2020 2020 2020 2020  -fail":.        
+000360a0: 2020 2020 6b65 7973 5f66 6169 6c65 6420      keys_failed 
+000360b0: 3d20 7365 7428 7265 7375 6c74 5b22 6b65  = set(result["ke
+000360c0: 7973 225d 290a 2020 2020 2020 2020 2020  ys"]).          
+000360d0: 2020 6b65 7973 5f6f 6b20 3d20 7768 6f5f    keys_ok = who_
+000360e0: 6861 732e 6b65 7973 2829 202d 206b 6579  has.keys() - key
+000360f0: 735f 6661 696c 6564 0a20 2020 2020 2020  s_failed.       
+00036100: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00036110: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00036120: 2020 2020 2066 2257 6f72 6b65 7220 7b77       f"Worker {w
+00036130: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
+00036140: 6169 6c65 6420 746f 2061 6371 7569 7265  ailed to acquire
+00036150: 206b 6579 733a 207b 7265 7375 6c74 5b27   keys: {result['
+00036160: 6b65 7973 275d 7d22 0a20 2020 2020 2020  keys']}".       
+00036170: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00036180: 6c73 653a 2020 2320 7072 6167 6d61 3a20  lse:  # pragma: 
+00036190: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
+000361a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000361b0: 7272 6f72 2866 2255 6e65 7870 6563 7465  rror(f"Unexpecte
+000361c0: 6420 6d65 7373 6167 6520 6672 6f6d 207b  d message from {
+000361d0: 776f 726b 6572 5f61 6464 7265 7373 7d3a  worker_address}:
+000361e0: 207b 7265 7375 6c74 7d22 290a 0a20 2020   {result}")..   
+000361f0: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00036200: 6b65 7973 5f6f 6b3a 0a20 2020 2020 2020  keys_ok:.       
+00036210: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+00036220: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
+00036230: 6765 7428 6b65 7929 2020 2320 7479 7065  get(key)  # type
+00036240: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00036250: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+00036260: 6e65 206f 7220 7473 2e73 7461 7465 2021  ne or ts.state !
+00036270: 3d20 226d 656d 6f72 7922 3a0a 2020 2020  = "memory":.    
+00036280: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00036290: 6572 2e77 6172 6e69 6e67 2866 224b 6579  er.warning(f"Key
+000362a0: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
+000362b0: 6c69 6361 7469 6f6e 3a20 7b6b 6579 7d22  lication: {key}"
+000362c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000362d0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+000362e0: 2020 2020 2020 2069 6620 7773 206e 6f74         if ws not
+000362f0: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
+00036300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036310: 7365 6c66 2e61 6464 5f72 6570 6c69 6361  self.add_replica
+00036320: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
+00036330: 2020 7265 7475 726e 206b 6579 735f 6661    return keys_fa
+00036340: 696c 6564 0a0a 2020 2020 6173 796e 6320  iled..    async 
+00036350: 6465 6620 6465 6c65 7465 5f77 6f72 6b65  def delete_worke
+00036360: 725f 6461 7461 280a 2020 2020 2020 2020  r_data(.        
+00036370: 7365 6c66 2c20 776f 726b 6572 5f61 6464  self, worker_add
+00036380: 7265 7373 3a20 7374 722c 206b 6579 733a  ress: str, keys:
+00036390: 2022 436f 6c6c 6563 7469 6f6e 5b73 7472   "Collection[str
+000363a0: 5d22 2c20 7374 696d 756c 7573 5f69 643a  ]", stimulus_id:
+000363b0: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
+000363c0: 6e65 3a0a 2020 2020 2020 2020 2222 2244  ne:.        """D
+000363d0: 656c 6574 6520 6461 7461 2066 726f 6d20  elete data from 
+000363e0: 6120 776f 726b 6572 2061 6e64 2075 7064  a worker and upd
+000363f0: 6174 6520 7468 6520 636f 7272 6573 706f  ate the correspo
+00036400: 6e64 696e 6720 776f 726b 6572 2f74 6173  nding worker/tas
+00036410: 6b20 7374 6174 6573 0a0a 2020 2020 2020  k states..      
+00036420: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00036430: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+00036440: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
+00036450: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
+00036460: 2020 2020 2020 2020 576f 726b 6572 2061          Worker a
+00036470: 6464 7265 7373 2074 6f20 6465 6c65 7465  ddress to delete
+00036480: 206b 6579 7320 6672 6f6d 0a20 2020 2020   keys from.     
+00036490: 2020 206b 6579 733a 206c 6973 745b 7374     keys: list[st
+000364a0: 725d 0a20 2020 2020 2020 2020 2020 204c  r].            L
+000364b0: 6973 7420 6f66 206b 6579 7320 746f 2064  ist of keys to d
+000364c0: 656c 6574 6520 6f6e 2074 6865 2073 7065  elete on the spe
+000364d0: 6369 6669 6564 2077 6f72 6b65 720a 2020  cified worker.  
+000364e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000364f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00036500: 2020 2061 7761 6974 2072 6574 7279 5f6f     await retry_o
+00036510: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
+00036520: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00036530: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
+00036540: 6464 7265 7373 292e 6672 6565 5f6b 6579  ddress).free_key
+00036550: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00036560: 2020 206b 6579 733d 6c69 7374 286b 6579     keys=list(key
+00036570: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00036580: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
+00036590: 6622 6465 6c65 7465 2d64 6174 612d 7b74  f"delete-data-{t
+000365a0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
+000365b0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+000365c0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+000365d0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+000365e0: 2320 5468 6973 2063 616e 2068 6170 7065  # This can happe
+000365f0: 6e20 652e 672e 2069 6620 7468 6520 776f  n e.g. if the wo
+00036600: 726b 6572 2069 7320 676f 696e 6720 7468  rker is going th
+00036610: 726f 7567 6820 636f 6e74 726f 6c6c 6564  rough controlled
+00036620: 2073 6875 7464 6f77 6e3b 0a20 2020 2020   shutdown;.     
+00036630: 2020 2020 2020 2023 2069 7420 646f 6573         # it does
+00036640: 6e27 7420 6e65 6365 7373 6172 696c 7920  n't necessarily 
+00036650: 6d65 616e 2074 6861 7420 6974 2077 656e  mean that it wen
+00036660: 7420 756e 6578 7065 6374 6564 6c79 206d  t unexpectedly m
+00036670: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
+00036680: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00036690: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+000366a0: 2020 2066 2243 6f6d 6d75 6e69 6361 7469     f"Communicati
+000366b0: 6f6e 2077 6974 6820 776f 726b 6572 207b  on with worker {
+000366c0: 776f 726b 6572 5f61 6464 7265 7373 7d20  worker_address} 
+000366d0: 6661 696c 6564 2064 7572 696e 6720 220a  failed during ".
+000366e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000366f0: 6622 7265 706c 6963 6174 696f 6e3a 207b  f"replication: {
+00036700: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+00036710: 6d65 5f5f 7d3a 207b 657d 220a 2020 2020  me__}: {e}".    
+00036720: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00036730: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00036740: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+00036750: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
+00036760: 6572 5f61 6464 7265 7373 290a 2020 2020  er_address).    
+00036770: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
+00036780: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00036790: 6e0a 0a20 2020 2020 2020 2066 6f72 206b  n..        for k
+000367a0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
+000367b0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+000367c0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
+000367d0: 6b73 2e67 6574 286b 6579 2920 2023 2074  ks.get(key)  # t
+000367e0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+000367f0: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+00036800: 206e 6f74 204e 6f6e 6520 616e 6420 7773   not None and ws
+00036810: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
+00036820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036830: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+00036840: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
+00036850: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00036860: 2e72 656d 6f76 655f 7265 706c 6963 6128  .remove_replica(
+00036870: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
+00036880: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+00036890: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+000368a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000368b0: 204c 6173 7420 636f 7079 2064 656c 6574   Last copy delet
+000368c0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+000368d0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+000368e0: 7369 7469 6f6e 7328 7b6b 6579 3a20 2272  sitions({key: "r
+000368f0: 656c 6561 7365 6422 7d2c 2073 7469 6d75  eleased"}, stimu
+00036900: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
+00036910: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00036920: 7773 2e61 6464 7265 7373 2c20 7b22 6163  ws.address, {"ac
+00036930: 7469 6f6e 223a 2022 7265 6d6f 7665 2d77  tion": "remove-w
+00036940: 6f72 6b65 722d 6461 7461 222c 2022 6b65  orker-data", "ke
+00036950: 7973 223a 206b 6579 737d 290a 0a20 2020  ys": keys})..   
+00036960: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00036970: 2061 7379 6e63 2064 6566 2072 6562 616c   async def rebal
+00036980: 616e 6365 280a 2020 2020 2020 2020 7365  ance(.        se
+00036990: 6c66 2c0a 2020 2020 2020 2020 6b65 7973  lf,.        keys
+000369a0: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
+000369b0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000369c0: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
+000369d0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+000369e0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+000369f0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00036a00: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00036a10: 6f6e 652c 0a20 2020 2029 202d 3e20 6469  one,.    ) -> di
+00036a20: 6374 3a0a 2020 2020 2020 2020 2222 2252  ct:.        """R
+00036a30: 6562 616c 616e 6365 206b 6579 7320 736f  ebalance keys so
+00036a40: 2074 6861 7420 6561 6368 2077 6f72 6b65   that each worke
+00036a50: 7220 656e 6473 2075 7020 7769 7468 2072  r ends up with r
+00036a60: 6f75 6768 6c79 2074 6865 2073 616d 6520  oughly the same 
+00036a70: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+00036a80: 6d65 6d6f 7279 2028 6d61 6e61 6765 642b  memory (managed+
+00036a90: 756e 6d61 6e61 6765 6429 2e0a 0a20 2020  unmanaged)...   
+00036aa0: 2020 2020 202e 2e20 7761 726e 696e 673a       .. warning:
+00036ab0: 3a0a 2020 2020 2020 2020 2020 2054 6869  :.           Thi
+00036ac0: 7320 6f70 6572 6174 696f 6e20 6973 2067  s operation is g
+00036ad0: 656e 6572 616c 6c79 206e 6f74 2077 656c  enerally not wel
+00036ae0: 6c20 7465 7374 6564 2061 6761 696e 7374  l tested against
+00036af0: 206e 6f72 6d61 6c20 6f70 6572 6174 696f   normal operatio
+00036b00: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
+00036b10: 2020 2020 7363 6865 6475 6c65 722e 2049      scheduler. I
+00036b20: 7420 6973 206e 6f74 2072 6563 6f6d 6d65  t is not recomme
+00036b30: 6e64 6564 2074 6f20 7573 6520 6974 2077  nded to use it w
+00036b40: 6869 6c65 2077 6169 7469 6e67 206f 6e20  hile waiting on 
+00036b50: 636f 6d70 7574 6174 696f 6e73 2e0a 0a20  computations... 
+00036b60: 2020 2020 2020 202a 2a41 6c67 6f72 6974         **Algorit
+00036b70: 686d 2a2a 0a0a 2020 2020 2020 2020 232e  hm**..        #.
+00036b80: 2046 696e 6420 7468 6520 6d65 616e 206f   Find the mean o
+00036b90: 6363 7570 616e 6379 206f 6620 7468 6520  ccupancy of the 
+00036ba0: 636c 7573 7465 722c 2064 6566 696e 6564  cluster, defined
+00036bb0: 2061 7320 6461 7461 206d 616e 6167 6564   as data managed
+00036bc0: 2062 7920 6461 736b 202b 0a20 2020 2020   by dask +.     
+00036bd0: 2020 2020 2020 756e 6d61 6e61 6765 6420        unmanaged 
+00036be0: 7072 6f63 6573 7320 6d65 6d6f 7279 2074  process memory t
+00036bf0: 6861 7420 6861 7320 6265 656e 2074 6865  hat has been the
+00036c00: 7265 2066 6f72 2061 7420 6c65 6173 7420  re for at least 
+00036c10: 3330 2073 6563 6f6e 6473 0a20 2020 2020  30 seconds.     
+00036c20: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
+00036c30: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
+00036c40: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
+00036c50: 2d74 696d 6560 6029 2e0a 2020 2020 2020  -time``)..      
+00036c60: 2020 2020 2054 6869 7320 6c65 7473 2075       This lets u
+00036c70: 7320 6967 6e6f 7265 2074 656d 706f 7261  s ignore tempora
+00036c80: 7279 2073 7069 6b65 7320 6361 7573 6564  ry spikes caused
+00036c90: 2062 7920 7461 736b 2068 6561 7020 7573   by task heap us
+00036ca0: 6167 652e 0a0a 2020 2020 2020 2020 2020  age...          
+00036cb0: 2041 6c74 6572 6e61 7469 7665 6c79 2c20   Alternatively, 
+00036cc0: 796f 7520 6d61 7920 6368 616e 6765 2068  you may change h
+00036cd0: 6f77 206d 656d 6f72 7920 6973 206d 6561  ow memory is mea
+00036ce0: 7375 7265 6420 626f 7468 2066 6f72 2074  sured both for t
+00036cf0: 6865 2069 6e64 6976 6964 7561 6c0a 2020  he individual.  
+00036d00: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00036d10: 2061 7320 7765 6c6c 2061 7320 746f 2063   as well as to c
+00036d20: 616c 6375 6c61 7465 2074 6865 206d 6561  alculate the mea
+00036d30: 6e20 7468 726f 7567 680a 2020 2020 2020  n through.      
+00036d40: 2020 2020 2060 6064 6973 7472 6962 7574       ``distribut
+00036d50: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+00036d60: 2e72 6562 616c 616e 6365 2e6d 6561 7375  .rebalance.measu
+00036d70: 7265 6060 2e20 4e61 6d65 6c79 2c20 7468  re``. Namely, th
+00036d80: 6973 2063 616e 2062 6520 7573 6566 756c  is can be useful
+00036d90: 0a20 2020 2020 2020 2020 2020 746f 2064  .           to d
+00036da0: 6973 7265 6761 7264 2069 6e61 6363 7572  isregard inaccur
+00036db0: 6174 6520 4f53 206d 656d 6f72 7920 6d65  ate OS memory me
+00036dc0: 6173 7572 656d 656e 7473 2e0a 0a20 2020  asurements...   
+00036dd0: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
+00036de0: 776f 726b 6572 7320 7768 6f73 6520 6f63  workers whose oc
+00036df0: 6375 7061 6e63 7920 6973 2077 6974 6869  cupancy is withi
+00036e00: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
+00036e10: 2063 6c75 7374 6572 206f 6363 7570 616e   cluster occupan
+00036e20: 6379 0a20 2020 2020 2020 2020 2020 2860  cy.           (`
+00036e30: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
+00036e40: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+00036e50: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
+00036e60: 7069 656e 742d 6761 7060 6020 2f20 3229  pient-gap`` / 2)
+00036e70: 2e0a 2020 2020 2020 2020 2020 2054 6869  ..           Thi
+00036e80: 7320 6865 6c70 7320 6176 6f69 6420 6461  s helps avoid da
+00036e90: 7461 2066 726f 6d20 626f 756e 6369 6e67  ta from bouncing
+00036ea0: 2061 726f 756e 6420 7468 6520 636c 7573   around the clus
+00036eb0: 7465 7220 7265 7065 6174 6564 6c79 2e0a  ter repeatedly..
+00036ec0: 2020 2020 2020 2020 232e 2057 6f72 6b65          #. Worke
+00036ed0: 7273 2061 626f 7665 2074 6865 206d 6561  rs above the mea
+00036ee0: 6e20 6172 6520 7365 6e64 6572 733b 2074  n are senders; t
+00036ef0: 686f 7365 2062 656c 6f77 2061 7265 2072  hose below are r
+00036f00: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
+00036f10: 2020 2023 2e20 4469 7363 6172 6420 7365     #. Discard se
+00036f20: 6e64 6572 7320 7768 6f73 6520 6162 736f  nders whose abso
+00036f30: 6c75 7465 206f 6363 7570 616e 6379 2069  lute occupancy i
+00036f40: 7320 6265 6c6f 7720 3330 250a 2020 2020  s below 30%.    
+00036f50: 2020 2020 2020 2028 6060 6469 7374 7269         (``distri
+00036f60: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+00036f70: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+00036f80: 6e64 6572 2d6d 696e 6060 292e 2049 6e20  nder-min``). In 
+00036f90: 6f74 6865 7220 776f 7264 732c 206e 6f20  other words, no 
+00036fa0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+00036fb0: 6973 206d 6f76 6564 2072 6567 6172 646c  is moved regardl
+00036fc0: 6573 7320 6f66 2069 6d62 616c 616e 6369  ess of imbalanci
+00036fd0: 6e67 2061 7320 6c6f 6e67 2061 7320 616c  ng as long as al
+00036fe0: 6c20 776f 726b 6572 7320 6172 6520 6265  l workers are be
+00036ff0: 6c6f 7720 3330 252e 0a20 2020 2020 2020  low 30%..       
+00037000: 2023 2e20 4469 7363 6172 6420 7265 6369   #. Discard reci
+00037010: 7069 656e 7473 2077 686f 7365 2061 6273  pients whose abs
+00037020: 6f6c 7574 6520 6f63 6375 7061 6e63 7920  olute occupancy 
+00037030: 6973 2061 626f 7665 2036 3025 0a20 2020  is above 60%.   
+00037040: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
+00037050: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+00037060: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
+00037070: 6563 6970 6965 6e74 2d6d 6178 6060 292e  ecipient-max``).
+00037080: 0a20 2020 2020 2020 2020 2020 4e6f 7465  .           Note
+00037090: 2074 6861 7420 7468 6973 2074 6872 6573   that this thres
+000370a0: 686f 6c64 2062 7920 6465 6661 756c 7420  hold by default 
+000370b0: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
+000370c0: 2020 2020 2020 2020 2020 6060 6469 7374            ``dist
+000370d0: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+000370e0: 656d 6f72 792e 7461 7267 6574 6060 2074  emory.target`` t
+000370f0: 6f20 7072 6576 656e 7420 776f 726b 6572  o prevent worker
+00037100: 7320 6672 6f6d 2061 6363 6570 7469 6e67  s from accepting
+00037110: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+00037120: 2061 6e64 2069 6d6d 6564 6961 7465 6c79   and immediately
+00037130: 2073 7069 6c6c 696e 6720 6974 206f 7574   spilling it out
+00037140: 2074 6f20 6469 736b 2e0a 2020 2020 2020   to disk..      
+00037150: 2020 232e 2049 7465 7261 7469 7665 6c79    #. Iteratively
+00037160: 2070 6963 6b20 7468 6520 7365 6e64 6572   pick the sender
+00037170: 2061 6e64 2072 6563 6970 6965 6e74 2074   and recipient t
+00037180: 6861 7420 6172 6520 6661 7274 6865 7374  hat are farthest
+00037190: 2066 726f 6d20 7468 6520 6d65 616e 2061   from the mean a
+000371a0: 6e64 0a20 2020 2020 2020 2020 2020 6d6f  nd.           mo
+000371b0: 7665 2074 6865 202a 6c65 6173 7420 7265  ve the *least re
+000371c0: 6365 6e74 6c79 2069 6e73 6572 7465 642a  cently inserted*
+000371d0: 206b 6579 2062 6574 7765 656e 2074 6865   key between the
+000371e0: 2074 776f 2c20 756e 7469 6c20 6569 7468   two, until eith
+000371f0: 6572 2061 6c6c 0a20 2020 2020 2020 2020  er all.         
+00037200: 2020 7365 6e64 6572 7320 6f72 2061 6c6c    senders or all
+00037210: 2072 6563 6970 6965 6e74 7320 6661 6c6c   recipients fall
+00037220: 2077 6974 6869 6e20 3525 206f 6620 7468   within 5% of th
+00037230: 6520 6d65 616e 2e0a 0a20 2020 2020 2020  e mean...       
+00037240: 2020 2020 4120 7265 6369 7069 656e 7420      A recipient 
+00037250: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
+00037260: 6966 2069 7420 616c 7265 6164 7920 6861  if it already ha
+00037270: 7320 6120 636f 7079 206f 6620 7468 6520  s a copy of the 
+00037280: 6461 7461 2e20 496e 206f 7468 6572 0a20  data. In other. 
+00037290: 2020 2020 2020 2020 2020 776f 7264 732c            words,
+000372a0: 2074 6869 7320 6d65 7468 6f64 2064 6f65   this method doe
+000372b0: 7320 6e6f 7420 6465 6772 6164 6520 7265  s not degrade re
+000372c0: 706c 6963 6174 696f 6e2e 0a20 2020 2020  plication..     
+000372d0: 2020 2020 2020 4120 6b65 7920 7769 6c6c        A key will
+000372e0: 2062 6520 736b 6970 7065 6420 6966 2074   be skipped if t
+000372f0: 6865 7265 2061 7265 206e 6f20 7265 6369  here are no reci
+00037300: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
+00037310: 2077 6974 6820 656e 6f75 6768 206d 656d   with enough mem
+00037320: 6f72 790a 2020 2020 2020 2020 2020 2074  ory.           t
+00037330: 6f20 6163 6365 7074 2074 6865 206b 6579  o accept the key
+00037340: 2061 6e64 2074 6861 7420 646f 6e27 7420   and that don't 
+00037350: 616c 7265 6164 7920 686f 6c64 2061 2063  already hold a c
+00037360: 6f70 792e 0a0a 2020 2020 2020 2020 5468  opy...        Th
+00037370: 6520 6c65 6173 7420 7265 6365 6e74 6c79  e least recently
+00037380: 2069 6e73 6572 7464 2028 4c52 4929 2070   insertd (LRI) p
+00037390: 6f6c 6963 7920 6973 2061 2067 7265 6564  olicy is a greed
+000373a0: 7920 6368 6f69 6365 2077 6974 6820 7468  y choice with th
+000373b0: 6520 6164 7661 6e74 6167 6520 6f66 0a20  e advantage of. 
+000373c0: 2020 2020 2020 2062 6569 6e67 204f 2831         being O(1
+000373d0: 292c 2074 7269 7669 616c 2074 6f20 696d  ), trivial to im
+000373e0: 706c 656d 656e 7420 2869 7420 7265 6c69  plement (it reli
+000373f0: 6573 206f 6e20 7079 7468 6f6e 2064 6963  es on python dic
+00037400: 7420 696e 7365 7274 696f 6e2d 736f 7274  t insertion-sort
+00037410: 696e 6729 0a20 2020 2020 2020 2061 6e64  ing).        and
+00037420: 2068 6f70 6566 756c 6c79 2067 6f6f 6420   hopefully good 
+00037430: 656e 6f75 6768 2069 6e20 6d6f 7374 2063  enough in most c
+00037440: 6173 6573 2e20 4469 7363 6172 6465 6420  ases. Discarded 
+00037450: 616c 7465 726e 6174 6976 6520 706f 6c69  alternative poli
+00037460: 6369 6573 2077 6572 653a 0a0a 2020 2020  cies were:..    
+00037470: 2020 2020 2d20 4c61 7267 6573 7420 6669      - Largest fi
+00037480: 7273 742e 204f 286e 2a6c 6f67 286e 2929  rst. O(n*log(n))
+00037490: 2073 6176 6520 666f 7220 6e6f 6e2d 7472   save for non-tr
+000374a0: 6976 6961 6c20 6164 6469 7469 6f6e 616c  ivial additional
+000374b0: 2064 6174 6120 7374 7275 6374 7572 6573   data structures
+000374c0: 2061 6e64 0a20 2020 2020 2020 2020 2072   and.          r
+000374d0: 6973 6b73 2063 6175 7369 6e67 2074 6865  isks causing the
+000374e0: 206c 6172 6765 7374 2063 6875 6e6b 7320   largest chunks 
+000374f0: 6f66 2064 6174 6120 746f 2072 6570 6561  of data to repea
+00037500: 7465 646c 7920 6d6f 7665 2061 726f 756e  tedly move aroun
+00037510: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
+00037520: 636c 7573 7465 7220 6c69 6b65 2070 696e  cluster like pin
+00037530: 6261 6c6c 732e 0a20 2020 2020 2020 202d  balls..        -
+00037540: 204c 6561 7374 2072 6563 656e 746c 7920   Least recently 
+00037550: 7573 6564 2028 4c52 5529 2e20 5468 6973  used (LRU). This
+00037560: 2069 6e66 6f72 6d61 7469 6f6e 2069 7320   information is 
+00037570: 6375 7272 656e 746c 7920 6176 6169 6c61  currently availa
+00037580: 626c 6520 6f6e 2074 6865 0a20 2020 2020  ble on the.     
+00037590: 2020 2020 2077 6f72 6b65 7273 206f 6e6c       workers onl
+000375a0: 7920 616e 6420 6e6f 7420 7472 6976 6961  y and not trivia
+000375b0: 6c20 746f 2072 6570 6c69 6361 7465 206f  l to replicate o
+000375c0: 6e20 7468 6520 7363 6865 6475 6c65 723b  n the scheduler;
+000375d0: 2074 7261 6e73 6d69 7474 696e 6720 6974   transmitting it
+000375e0: 0a20 2020 2020 2020 2020 206f 7665 7220  .          over 
+000375f0: 7468 6520 6e65 7477 6f72 6b20 776f 756c  the network woul
+00037600: 6420 6265 2076 6572 7920 6578 7065 6e73  d be very expens
+00037610: 6976 652e 2041 6c73 6f2c 206e 6f74 6520  ive. Also, note 
+00037620: 7468 6174 2064 6173 6b20 7769 6c6c 2067  that dask will g
+00037630: 6f20 6f75 7420 6f66 0a20 2020 2020 2020  o out of.       
+00037640: 2020 2069 7473 2077 6179 2074 6f20 6d69     its way to mi
+00037650: 6e69 6d69 7365 2074 6865 2061 6d6f 756e  nimise the amoun
+00037660: 7420 6f66 2074 696d 6520 696e 7465 726d  t of time interm
+00037670: 6564 6961 7465 206b 6579 7320 6172 6520  ediate keys are 
+00037680: 6865 6c64 2069 6e20 6d65 6d6f 7279 2c0a  held in memory,.
+00037690: 2020 2020 2020 2020 2020 736f 2069 6e20            so in 
+000376a0: 7375 6368 2061 2063 6173 6520 4c52 4920  such a case LRI 
+000376b0: 6973 2061 2063 6c6f 7365 2061 7070 726f  is a close appro
+000376c0: 7869 6d61 7469 6f6e 206f 6620 4c52 552e  ximation of LRU.
+000376d0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+000376e0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+000376f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00037700: 6b65 7973 3a20 6f70 7469 6f6e 616c 0a20  keys: optional. 
+00037710: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
+00037720: 6c69 7374 206f 6620 6461 736b 206b 6579  list of dask key
+00037730: 7320 7468 6174 2073 686f 756c 6420 6265  s that should be
+00037740: 2063 6f6e 7369 6465 7265 6420 666f 7220   considered for 
+00037750: 6d6f 7669 6e67 2e20 416c 6c20 6f74 6865  moving. All othe
+00037760: 7220 6b65 7973 0a20 2020 2020 2020 2020  r keys.         
+00037770: 2020 2077 696c 6c20 6265 2069 676e 6f72     will be ignor
+00037780: 6564 2e20 4e6f 7465 2074 6861 7420 7468  ed. Note that th
+00037790: 6973 206f 6666 6572 7320 6e6f 2067 7561  is offers no gua
+000377a0: 7261 6e74 6565 2074 6861 7420 6120 6b65  rantee that a ke
+000377b0: 7920 7769 6c6c 2061 6374 7561 6c6c 790a  y will actually.
+000377c0: 2020 2020 2020 2020 2020 2020 6265 206d              be m
+000377d0: 6f76 6564 2028 652e 672e 2062 6563 6175  oved (e.g. becau
+000377e0: 7365 2069 7420 6973 2075 6e6e 6563 6573  se it is unneces
+000377f0: 7361 7279 206f 7220 6265 6361 7573 6520  sary or because 
+00037800: 7468 6572 6520 6172 6520 6e6f 2076 6961  there are no via
+00037810: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+00037820: 7265 6369 7069 656e 7420 776f 726b 6572  recipient worker
+00037830: 7320 666f 7220 6974 292e 0a20 2020 2020  s for it)..     
+00037840: 2020 2077 6f72 6b65 7273 3a20 6f70 7469     workers: opti
+00037850: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
+00037860: 2061 6c6c 6f77 6c69 7374 206f 6620 776f   allowlist of wo
+00037870: 726b 6572 7320 6164 6472 6573 7365 7320  rkers addresses 
+00037880: 746f 2062 6520 636f 6e73 6964 6572 6564  to be considered
+00037890: 2061 7320 7365 6e64 6572 7320 6f72 2072   as senders or r
+000378a0: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
+000378b0: 2020 2020 2020 2041 6c6c 206f 7468 6572         All other
+000378c0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
+000378d0: 2069 676e 6f72 6564 2e20 5468 6520 6d65   ignored. The me
+000378e0: 616e 2063 6c75 7374 6572 206f 6363 7570  an cluster occup
+000378f0: 616e 6379 2077 696c 6c20 6265 0a20 2020  ancy will be.   
+00037900: 2020 2020 2020 2020 2063 616c 6375 6c61           calcula
+00037910: 7465 6420 6f6e 6c79 2075 7369 6e67 2074  ted only using t
+00037920: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
+00037930: 7273 2e0a 2020 2020 2020 2020 2222 220a  rs..        """.
+00037940: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00037950: 5f69 6420 3d20 7374 696d 756c 7573 5f69  _id = stimulus_i
+00037960: 6420 6f72 2066 2272 6562 616c 616e 6365  d or f"rebalance
+00037970: 2d7b 7469 6d65 2829 7d22 0a0a 2020 2020  -{time()}"..    
+00037980: 2020 2020 7773 733a 2043 6f6c 6c65 6374      wss: Collect
+00037990: 696f 6e5b 576f 726b 6572 5374 6174 655d  ion[WorkerState]
+000379a0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+000379b0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+000379c0: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
+000379d0: 203d 205b 7365 6c66 2e77 6f72 6b65 7273   = [self.workers
+000379e0: 5b77 5d20 666f 7220 7720 696e 2077 6f72  [w] for w in wor
+000379f0: 6b65 7273 5d0a 2020 2020 2020 2020 656c  kers].        el
+00037a00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00037a10: 7773 7320 3d20 7365 6c66 2e77 6f72 6b65  wss = self.worke
+00037a20: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+00037a30: 2020 2020 6966 206e 6f74 2077 7373 3a0a      if not wss:.
+00037a40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00037a50: 726e 207b 2273 7461 7475 7322 3a20 224f  rn {"status": "O
+00037a60: 4b22 7d0a 0a20 2020 2020 2020 2069 6620  K"}..        if 
+00037a70: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
+00037a80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00037a90: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00037aa0: 6b65 7973 2c20 5365 7429 3a0a 2020 2020  keys, Set):.    
+00037ab0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+00037ac0: 203d 2073 6574 286b 6579 7329 2020 2320   = set(keys)  # 
+00037ad0: 756e 6c65 7373 2061 6c72 6561 6479 2061  unless already a
+00037ae0: 2073 6574 2d6c 696b 650a 2020 2020 2020   set-like.      
+00037af0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
+00037b00: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00037b10: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
+00037b20: 7573 223a 2022 4f4b 227d 0a20 2020 2020  us": "OK"}.     
+00037b30: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
+00037b40: 6174 6120 3d20 5b0a 2020 2020 2020 2020  ata = [.        
+00037b50: 2020 2020 2020 2020 6b20 666f 7220 6b20          k for k 
+00037b60: 696e 206b 6579 7320 6966 206b 206e 6f74  in keys if k not
+00037b70: 2069 6e20 7365 6c66 2e74 6173 6b73 206f   in self.tasks o
+00037b80: 7220 6e6f 7420 7365 6c66 2e74 6173 6b73  r not self.tasks
+00037b90: 5b6b 5d2e 7768 6f5f 6861 730a 2020 2020  [k].who_has.    
+00037ba0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00037bb0: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
+00037bc0: 5f64 6174 613a 0a20 2020 2020 2020 2020  _data:.         
+00037bd0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00037be0: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
+00037bf0: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
+00037c00: 206d 6973 7369 6e67 5f64 6174 617d 0a0a   missing_data}..
+00037c10: 2020 2020 2020 2020 6d73 6773 203d 2073          msgs = s
+00037c20: 656c 662e 5f72 6562 616c 616e 6365 5f66  elf._rebalance_f
+00037c30: 696e 645f 6d73 6773 286b 6579 732c 2077  ind_msgs(keys, w
+00037c40: 7373 290a 2020 2020 2020 2020 6966 206e  ss).        if n
+00037c50: 6f74 206d 7367 733a 0a20 2020 2020 2020  ot msgs:.       
+00037c60: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
+00037c70: 6174 7573 223a 2022 4f4b 227d 0a0a 2020  atus": "OK"}..  
+00037c80: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+00037c90: 2073 656c 662e 5f6c 6f63 6b3a 0a20 2020   self._lock:.   
+00037ca0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00037cb0: 3d20 6177 6169 7420 7365 6c66 2e5f 7265  = await self._re
+00037cc0: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
+00037cd0: 6128 6d73 6773 2c20 7374 696d 756c 7573  a(msgs, stimulus
+00037ce0: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
+00037cf0: 2069 6620 7265 7375 6c74 5b22 7374 6174   if result["stat
+00037d00: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
+00037d10: 2d66 6169 6c22 2061 6e64 206b 6579 7320  -fail" and keys 
+00037d20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00037d30: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
+00037d40: 7265 7475 726e 2066 6169 6c65 6420 6b65  return failed ke
+00037d50: 7973 2069 6620 7468 6520 636c 6965 6e74  ys if the client
+00037d60: 2065 7870 6c69 6369 746c 7920 6173 6b65   explicitly aske
+00037d70: 6420 666f 7220 7468 656d 0a20 2020 2020  d for them.     
+00037d80: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00037d90: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
+00037da0: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
+00037db0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00037dc0: 2020 2020 6465 6620 5f72 6562 616c 616e      def _rebalan
+00037dd0: 6365 5f66 696e 645f 6d73 6773 280a 2020  ce_find_msgs(.  
+00037de0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00037df0: 2020 2020 6b65 7973 3a20 5365 745b 4861      keys: Set[Ha
+00037e00: 7368 6162 6c65 5d20 7c20 4e6f 6e65 2c0a  shable] | None,.
+00037e10: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+00037e20: 2049 7465 7261 626c 655b 576f 726b 6572   Iterable[Worker
+00037e30: 5374 6174 655d 2c0a 2020 2020 2920 2d3e  State],.    ) ->
+00037e40: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
+00037e50: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
+00037e60: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
+00037e70: 5d3a 0a20 2020 2020 2020 2022 2222 4964  ]:.        """Id
+00037e80: 656e 7469 6679 2077 6f72 6b65 7273 2074  entify workers t
+00037e90: 6861 7420 6e65 6564 2074 6f20 6c6f 7365  hat need to lose
+00037ea0: 206b 6579 7320 616e 6420 7468 6f73 6520   keys and those 
+00037eb0: 7468 6174 2063 616e 2072 6563 6569 7665  that can receive
+00037ec0: 2074 6865 6d2c 0a20 2020 2020 2020 2074   them,.        t
+00037ed0: 6f67 6574 6865 7220 7769 7468 2068 6f77  ogether with how
+00037ee0: 206d 616e 7920 6279 7465 7320 6561 6368   many bytes each
+00037ef0: 206e 6565 6473 2074 6f20 6c6f 7365 2f72   needs to lose/r
+00037f00: 6563 6569 7665 2e20 5468 656e 2c20 7061  eceive. Then, pa
+00037f10: 6972 2061 2073 656e 6465 720a 2020 2020  ir a sender.    
+00037f20: 2020 2020 776f 726b 6572 2077 6974 6820      worker with 
+00037f30: 6120 7265 6369 7069 656e 7420 776f 726b  a recipient work
+00037f40: 6572 2066 6f72 2065 6163 6820 6b65 792c  er for each key,
+00037f50: 2075 6e74 696c 2074 6865 2063 6c75 7374   until the clust
+00037f60: 6572 2069 7320 7265 6261 6c61 6e63 6564  er is rebalanced
+00037f70: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
+00037f80: 6d65 7468 6f64 206f 6e6c 7920 6465 6669  method only defi
+00037f90: 6e65 7320 7468 6520 776f 726b 2074 6f20  nes the work to 
+00037fa0: 6265 2070 6572 666f 726d 6564 3b20 6974  be performed; it
+00037fb0: 2064 6f65 7320 6e6f 7420 7374 6172 7420   does not start 
+00037fc0: 616e 7920 6e65 7477 6f72 6b0a 2020 2020  any network.    
+00037fd0: 2020 2020 7472 616e 7366 6572 7320 6974      transfers it
+00037fe0: 7365 6c66 2e0a 0a20 2020 2020 2020 2054  self...        T
+00037ff0: 6865 2062 6967 2d4f 2063 6f6d 706c 6578  he big-O complex
+00038000: 6974 7920 6973 204f 2877 7420 2b20 6b65  ity is O(wt + ke
+00038010: 2a6c 6f67 2877 6529 292c 2077 6865 7265  *log(we)), where
+00038020: 0a0a 2020 2020 2020 2020 2d20 7774 2069  ..        - wt i
+00038030: 7320 7468 6520 746f 7461 6c20 6e75 6d62  s the total numb
+00038040: 6572 206f 6620 776f 726b 6572 7320 6f6e  er of workers on
+00038050: 2074 6865 2063 6c75 7374 6572 2028 6f72   the cluster (or
+00038060: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
+00038070: 6c6c 6f77 6564 0a20 2020 2020 2020 2020  llowed.         
+00038080: 2077 6f72 6b65 7273 2c20 6966 2065 7870   workers, if exp
+00038090: 6c69 6369 746c 7920 7374 6174 6564 2062  licitly stated b
+000380a0: 7920 7468 6520 7573 6572 290a 2020 2020  y the user).    
+000380b0: 2020 2020 2d20 7765 2069 7320 7468 6520      - we is the 
+000380c0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
+000380d0: 7320 7468 6174 2061 7265 2065 6c69 6769  s that are eligi
+000380e0: 626c 6520 746f 2062 6520 7365 6e64 6572  ble to be sender
+000380f0: 7320 6f72 2072 6563 6970 6965 6e74 730a  s or recipients.
+00038100: 2020 2020 2020 2020 2d20 6b74 2069 7320          - kt is 
+00038110: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
+00038120: 206f 6620 6b65 7973 206f 6e20 7468 6520   of keys on the 
+00038130: 636c 7573 7465 7220 286f 7220 6f6e 2074  cluster (or on t
+00038140: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
+00038150: 7273 290a 2020 2020 2020 2020 2d20 6b65  rs).        - ke
+00038160: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
+00038170: 6620 6b65 7973 2074 6861 7420 6e65 6564  f keys that need
+00038180: 2074 6f20 6265 206d 6f76 6564 2069 6e20   to be moved in 
+00038190: 6f72 6465 7220 746f 2061 6368 6965 7665  order to achieve
+000381a0: 2061 2062 616c 616e 6365 640a 2020 2020   a balanced.    
+000381b0: 2020 2020 2020 636c 7573 7465 720a 0a20        cluster.. 
+000381c0: 2020 2020 2020 2054 6865 7265 2069 7320         There is 
+000381d0: 6120 6465 6765 6e65 7261 7465 2065 6467  a degenerate edg
+000381e0: 6520 6361 7365 204f 2877 7420 2b20 6b74  e case O(wt + kt
+000381f0: 2a6c 6f67 2877 6529 2920 7768 656e 206b  *log(we)) when k
+00038200: 7420 6973 206d 7563 6820 6772 6561 7465  t is much greate
+00038210: 7220 7468 616e 0a20 2020 2020 2020 2074  r than.        t
+00038220: 6865 206e 756d 6265 7220 6f66 2061 6c6c  he number of all
+00038230: 6f77 6564 206b 6579 732c 206f 7220 7768  owed keys, or wh
+00038240: 656e 206d 6f73 7420 6b65 7973 2061 7265  en most keys are
+00038250: 2072 6570 6c69 6361 7465 6420 6f72 2063   replicated or c
+00038260: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
+00038270: 206d 6f76 6564 2066 6f72 2073 6f6d 6520   moved for some 
+00038280: 6f74 6865 7220 7265 6173 6f6e 2e0a 0a20  other reason... 
+00038290: 2020 2020 2020 2052 6574 7572 6e73 206c         Returns l
+000382a0: 6973 7420 6f66 2074 7570 6c65 7320 746f  ist of tuples to
+000382b0: 2066 6565 6420 696e 746f 205f 7265 6261   feed into _reba
+000382c0: 6c61 6e63 655f 6d6f 7665 5f64 6174 613a  lance_move_data:
+000382d0: 0a0a 2020 2020 2020 2020 2d20 7365 6e64  ..        - send
+000382e0: 6572 2077 6f72 6b65 720a 2020 2020 2020  er worker.      
+000382f0: 2020 2d20 7265 6369 7069 656e 7420 776f    - recipient wo
+00038300: 726b 6572 0a20 2020 2020 2020 202d 2074  rker.        - t
+00038310: 6173 6b20 746f 2062 6520 7472 616e 7366  ask to be transf
+00038320: 6572 7265 640a 2020 2020 2020 2020 2222  erred.        ""
+00038330: 220a 2020 2020 2020 2020 2320 4865 6170  ".        # Heap
+00038340: 7320 6f66 2077 6f72 6b65 7273 2c20 6d61  s of workers, ma
+00038350: 6e61 6765 6420 6279 2074 6865 2068 6561  naged by the hea
+00038360: 7071 206d 6f64 756c 652c 2074 6861 7420  pq module, that 
+00038370: 6e65 6564 2074 6f20 7365 6e64 2f72 6563  need to send/rec
+00038380: 6569 7665 2064 6174 612c 0a20 2020 2020  eive data,.     
+00038390: 2020 2023 2077 6974 6820 686f 7720 6d61     # with how ma
+000383a0: 6e79 2062 7974 6573 2065 6163 6820 6e65  ny bytes each ne
+000383b0: 6564 7320 746f 2073 656e 642f 7265 6365  eds to send/rece
+000383c0: 6976 652e 0a20 2020 2020 2020 2023 0a20  ive..        #. 
+000383d0: 2020 2020 2020 2023 2045 6163 6820 656c         # Each el
+000383e0: 656d 656e 7420 6f66 2074 6865 2068 6561  ement of the hea
+000383f0: 7020 6973 2061 2074 7570 6c65 2063 6f6e  p is a tuple con
+00038400: 7374 7275 6374 6564 2061 7320 666f 6c6c  structed as foll
+00038410: 6f77 733a 0a20 2020 2020 2020 2023 202d  ows:.        # -
+00038420: 2073 6e64 5f62 7974 6573 5f6d 6178 2f72   snd_bytes_max/r
+00038430: 6563 5f62 7974 6573 5f6d 6178 3a20 6d61  ec_bytes_max: ma
+00038440: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
+00038450: 6279 7465 7320 746f 2073 656e 6420 6f72  bytes to send or
+00038460: 2072 6563 6569 7665 2e0a 2020 2020 2020   receive..      
+00038470: 2020 2320 2020 5468 6973 206e 756d 6265    #   This numbe
+00038480: 7220 6973 206e 6567 6174 6976 652c 2073  r is negative, s
+00038490: 6f20 7468 6174 2074 6865 2077 6f72 6b65  o that the worke
+000384a0: 7273 2066 6172 7468 6573 7420 6672 6f6d  rs farthest from
+000384b0: 2074 6865 2063 6c75 7374 6572 206d 6561   the cluster mea
+000384c0: 6e0a 2020 2020 2020 2020 2320 2020 6172  n.        #   ar
+000384d0: 6520 6174 2074 6865 2074 6f70 206f 6620  e at the top of 
+000384e0: 7468 6520 736d 616c 6c65 7374 2d66 6972  the smallest-fir
+000384f0: 7374 2068 6561 7073 2e0a 2020 2020 2020  st heaps..      
+00038500: 2020 2320 2d20 736e 645f 6279 7465 735f    # - snd_bytes_
+00038510: 6d69 6e2f 7265 635f 6279 7465 735f 6d69  min/rec_bytes_mi
+00038520: 6e3a 206d 696e 696d 756d 206e 756d 6265  n: minimum numbe
+00038530: 7220 6f66 2062 7974 6573 2061 6674 6572  r of bytes after
+00038540: 2073 656e 6469 6e67 2f72 6563 6569 7669   sending/receivi
+00038550: 6e67 0a20 2020 2020 2020 2023 2020 2077  ng.        #   w
+00038560: 6869 6368 2074 6865 2077 6f72 6b65 7220  hich the worker 
+00038570: 7368 6f75 6c64 206e 6f74 2062 6520 636f  should not be co
+00038580: 6e73 6964 6572 6564 2061 6e79 6d6f 7265  nsidered anymore
+00038590: 2e20 5468 6973 2069 7320 616c 736f 206e  . This is also n
+000385a0: 6567 6174 6976 652e 0a20 2020 2020 2020  egative..       
+000385b0: 2023 202d 2061 7262 6974 7261 7279 2075   # - arbitrary u
+000385c0: 6e69 7175 6520 6e75 6d62 6572 2c20 7468  nique number, th
+000385d0: 6572 6520 6a75 7374 2074 6f20 746f 206d  ere just to to m
+000385e0: 616b 6520 7375 7265 2074 6861 7420 576f  ake sure that Wo
+000385f0: 726b 6572 5374 6174 6520 6f62 6a65 6374  rkerState object
+00038600: 730a 2020 2020 2020 2020 2320 2020 6172  s.        #   ar
+00038610: 6520 6e65 7665 7220 7573 6564 2066 6f72  e never used for
+00038620: 2073 6f72 7469 6e67 2069 6e20 7468 6520   sorting in the 
+00038630: 756e 6c69 6b65 6c79 2065 7665 6e74 2074  unlikely event t
+00038640: 6861 7420 7477 6f20 7072 6f63 6573 7365  hat two processe
+00038650: 7320 6861 7665 0a20 2020 2020 2020 2023  s have.        #
+00038660: 2020 2065 7861 6374 6c79 2074 6865 2073     exactly the s
+00038670: 616d 6520 6e75 6d62 6572 206f 6620 6279  ame number of by
+00038680: 7465 7320 616c 6c6f 6361 7465 642e 0a20  tes allocated.. 
+00038690: 2020 2020 2020 2023 202d 2057 6f72 6b65         # - Worke
+000386a0: 7253 7461 7465 0a20 2020 2020 2020 2023  rState.        #
+000386b0: 202d 2069 7465 7261 746f 7220 6f66 2061   - iterator of a
+000386c0: 6c6c 2074 6173 6b73 2069 6e20 6d65 6d6f  ll tasks in memo
+000386d0: 7279 206f 6e20 7468 6520 776f 726b 6572  ry on the worker
+000386e0: 2028 7365 6e64 6572 7320 6f6e 6c79 292c   (senders only),
+000386f0: 2069 6e73 6572 7469 6f6e 0a20 2020 2020   insertion.     
+00038700: 2020 2023 2020 2073 6f72 7465 6420 286c     #   sorted (l
+00038710: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
+00038720: 7365 7274 6564 2066 6972 7374 292e 0a20  serted first).. 
+00038730: 2020 2020 2020 2023 2020 204e 6f74 6520         #   Note 
+00038740: 7468 6174 2074 6869 7320 6974 6572 6174  that this iterat
+00038750: 6f72 2077 696c 6c20 7479 7069 6361 6c6c  or will typicall
+00038760: 7920 2a6e 6f74 2a20 6265 2065 7868 6175  y *not* be exhau
+00038770: 7374 6564 2e20 4974 2077 696c 6c20 6f6e  sted. It will on
+00038780: 6c79 2062 650a 2020 2020 2020 2020 2320  ly be.        # 
+00038790: 2020 6578 6861 7573 7465 6420 6966 2c20    exhausted if, 
+000387a0: 6166 7465 7220 6d6f 7669 6e67 2061 7761  after moving awa
+000387b0: 7920 6672 6f6d 2074 6865 2077 6f72 6b65  y from the worke
+000387c0: 7220 616c 6c20 6b65 7973 2074 6861 7420  r all keys that 
+000387d0: 6361 6e20 6265 206d 6f76 6564 2c0a 2020  can be moved,.  
+000387e0: 2020 2020 2020 2320 2020 6973 2069 6e73        #   is ins
+000387f0: 7566 6669 6369 656e 7420 746f 2064 726f  ufficient to dro
+00038800: 7020 736e 645f 6279 7465 735f 6d69 6e20  p snd_bytes_min 
+00038810: 6162 6f76 6520 302e 0a20 2020 2020 2020  above 0..       
+00038820: 2073 656e 6465 7273 3a20 6c69 7374 5b74   senders: list[t
+00038830: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
+00038840: 6e74 2c20 576f 726b 6572 5374 6174 652c  nt, WorkerState,
+00038850: 2049 7465 7261 746f 725b 5461 736b 5374   Iterator[TaskSt
+00038860: 6174 655d 5d5d 203d 205b 5d0a 2020 2020  ate]]] = [].    
+00038870: 2020 2020 7265 6369 7069 656e 7473 3a20      recipients: 
+00038880: 6c69 7374 5b74 7570 6c65 5b69 6e74 2c20  list[tuple[int, 
+00038890: 696e 742c 2069 6e74 2c20 576f 726b 6572  int, int, Worker
+000388a0: 5374 6174 655d 5d20 3d20 5b5d 0a0a 2020  State]] = []..  
+000388b0: 2020 2020 2020 2320 4f75 7470 7574 3a20        # Output: 
+000388c0: 5b28 7365 6e64 6572 2c20 7265 6369 7069  [(sender, recipi
+000388d0: 656e 742c 2074 6173 6b29 2c20 2e2e 2e5d  ent, task), ...]
+000388e0: 0a20 2020 2020 2020 206d 7367 733a 206c  .        msgs: l
+000388f0: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
+00038900: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
+00038910: 7465 2c20 5461 736b 5374 6174 655d 5d20  te, TaskState]] 
+00038920: 3d20 5b5d 0a0a 2020 2020 2020 2020 2320  = []..        # 
+00038930: 4279 2064 6566 6175 6c74 2c20 7468 6973  By default, this
+00038940: 2069 7320 7468 6520 6f70 7469 6d69 7374   is the optimist
+00038950: 6963 206d 656d 6f72 792c 206d 6561 6e69  ic memory, meani
+00038960: 6e67 2074 6f74 616c 2070 726f 6365 7373  ng total process
+00038970: 206d 656d 6f72 7920 6d69 6e75 730a 2020   memory minus.  
+00038980: 2020 2020 2020 2320 756e 6d61 6e61 6765        # unmanage
+00038990: 6420 6d65 6d6f 7279 2074 6861 7420 6170  d memory that ap
+000389a0: 7065 6172 6564 206f 7665 7220 7468 6520  peared over the 
+000389b0: 6c61 7374 2033 3020 7365 636f 6e64 730a  last 30 seconds.
+000389c0: 2020 2020 2020 2020 2320 2864 6973 7472          # (distr
+000389d0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+000389e0: 6d6f 7279 2e72 6563 656e 742d 746f 2d6f  mory.recent-to-o
+000389f0: 6c64 2d74 696d 6529 2e0a 2020 2020 2020  ld-time)..      
+00038a00: 2020 2320 5468 6973 206c 6574 7320 7573    # This lets us
+00038a10: 2069 676e 6f72 6520 7465 6d70 6f72 6172   ignore temporar
+00038a20: 7920 7370 696b 6573 2063 6175 7365 6420  y spikes caused 
+00038a30: 6279 2074 6173 6b20 6865 6170 2075 7361  by task heap usa
+00038a40: 6765 2e0a 2020 2020 2020 2020 6d65 6d6f  ge..        memo
+00038a50: 7279 5f62 795f 776f 726b 6572 203d 205b  ry_by_worker = [
+00038a60: 0a20 2020 2020 2020 2020 2020 2028 7773  .            (ws
+00038a70: 2c20 6765 7461 7474 7228 7773 2e6d 656d  , getattr(ws.mem
+00038a80: 6f72 792c 2073 656c 662e 4d45 4d4f 5259  ory, self.MEMORY
+00038a90: 5f52 4542 414c 414e 4345 5f4d 4541 5355  _REBALANCE_MEASU
+00038aa0: 5245 2929 2066 6f72 2077 7320 696e 2077  RE)) for ws in w
+00038ab0: 6f72 6b65 7273 0a20 2020 2020 2020 205d  orkers.        ]
+00038ac0: 0a20 2020 2020 2020 206d 6561 6e5f 6d65  .        mean_me
+00038ad0: 6d6f 7279 203d 2073 756d 286d 2066 6f72  mory = sum(m for
+00038ae0: 205f 2c20 6d20 696e 206d 656d 6f72 795f   _, m in memory_
+00038af0: 6279 5f77 6f72 6b65 7229 202f 2f20 6c65  by_worker) // le
+00038b00: 6e28 6d65 6d6f 7279 5f62 795f 776f 726b  n(memory_by_work
+00038b10: 6572 290a 0a20 2020 2020 2020 2066 6f72  er)..        for
+00038b20: 2077 732c 2077 735f 6d65 6d6f 7279 2069   ws, ws_memory i
+00038b30: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
+00038b40: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00038b50: 6966 2077 732e 6d65 6d6f 7279 5f6c 696d  if ws.memory_lim
+00038b60: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
+00038b70: 2020 2020 6861 6c66 5f67 6170 203d 2069      half_gap = i
+00038b80: 6e74 2873 656c 662e 4d45 4d4f 5259 5f52  nt(self.MEMORY_R
+00038b90: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
+00038ba0: 5020 2a20 7773 2e6d 656d 6f72 795f 6c69  P * ws.memory_li
+00038bb0: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
+00038bc0: 2020 2020 2073 656e 6465 725f 6d69 6e20       sender_min 
+00038bd0: 3d20 7365 6c66 2e4d 454d 4f52 595f 5245  = self.MEMORY_RE
+00038be0: 4241 4c41 4e43 455f 5345 4e44 4552 5f4d  BALANCE_SENDER_M
+00038bf0: 494e 202a 2077 732e 6d65 6d6f 7279 5f6c  IN * ws.memory_l
+00038c00: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
+00038c10: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
+00038c20: 6178 203d 2073 656c 662e 4d45 4d4f 5259  ax = self.MEMORY
+00038c30: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
+00038c40: 4945 4e54 5f4d 4158 202a 2077 732e 6d65  IENT_MAX * ws.me
+00038c50: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
+00038c60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00038c70: 2020 2020 2020 2020 2020 2020 2068 616c               hal
+00038c80: 665f 6761 7020 3d20 300a 2020 2020 2020  f_gap = 0.      
+00038c90: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+00038ca0: 5f6d 696e 203d 2030 2e30 0a20 2020 2020  _min = 0.0.     
+00038cb0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+00038cc0: 6965 6e74 5f6d 6178 203d 206d 6174 682e  ient_max = math.
+00038cd0: 696e 660a 0a20 2020 2020 2020 2020 2020  inf..           
+00038ce0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+00038cf0: 2020 2020 2020 7773 2e5f 6861 735f 7768        ws._has_wh
+00038d00: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
+00038d10: 2020 2061 6e64 2077 735f 6d65 6d6f 7279     and ws_memory
+00038d20: 203e 3d20 6d65 616e 5f6d 656d 6f72 7920   >= mean_memory 
+00038d30: 2b20 6861 6c66 5f67 6170 0a20 2020 2020  + half_gap.     
+00038d40: 2020 2020 2020 2020 2020 2061 6e64 2077             and w
+00038d50: 735f 6d65 6d6f 7279 203e 3d20 7365 6e64  s_memory >= send
+00038d60: 6572 5f6d 696e 0a20 2020 2020 2020 2020  er_min.         
+00038d70: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00038d80: 2020 2020 2020 2320 5468 6973 206d 6179        # This may
+00038d90: 2073 656e 6420 7468 6520 776f 726b 6572   send the worker
+00038da0: 2062 656c 6f77 2073 656e 6465 725f 6d69   below sender_mi
+00038db0: 6e20 2862 7920 6465 7369 676e 290a 2020  n (by design).  
+00038dc0: 2020 2020 2020 2020 2020 2020 2020 736e                sn
+00038dd0: 645f 6279 7465 735f 6d61 7820 3d20 6d65  d_bytes_max = me
+00038de0: 616e 5f6d 656d 6f72 7920 2d20 7773 5f6d  an_memory - ws_m
+00038df0: 656d 6f72 7920 2023 206e 6567 6174 6976  emory  # negativ
+00038e00: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00038e10: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
+00038e20: 3d20 736e 645f 6279 7465 735f 6d61 7820  = snd_bytes_max 
+00038e30: 2b20 6861 6c66 5f67 6170 2020 2320 6e65  + half_gap  # ne
+00038e40: 6761 7469 7665 0a20 2020 2020 2020 2020  gative.         
+00038e50: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
+00038e60: 696e 6974 696f 6e20 6f66 2073 656e 6465  inition of sende
+00038e70: 7273 2061 626f 7665 0a20 2020 2020 2020  rs above.       
+00038e80: 2020 2020 2020 2020 2073 656e 6465 7273           senders
+00038e90: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+00038ea0: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
+00038eb0: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
+00038ec0: 5f62 7974 6573 5f6d 696e 2c20 6964 2877  _bytes_min, id(w
+00038ed0: 7329 2c20 7773 2c20 6974 6572 2877 732e  s), ws, iter(ws.
+00038ee0: 5f68 6173 5f77 6861 7429 290a 2020 2020  _has_what)).    
+00038ef0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00038f00: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
+00038f10: 735f 6d65 6d6f 7279 203c 206d 6561 6e5f  s_memory < mean_
+00038f20: 6d65 6d6f 7279 202d 2068 616c 665f 6761  memory - half_ga
+00038f30: 7020 616e 6420 7773 5f6d 656d 6f72 7920  p and ws_memory 
+00038f40: 3c20 7265 6369 7069 656e 745f 6d61 783a  < recipient_max:
+00038f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038f60: 2023 2054 6869 7320 6d61 7920 7365 6e64   # This may send
+00038f70: 2074 6865 2077 6f72 6b65 7220 6162 6f76   the worker abov
+00038f80: 6520 7265 6369 7069 656e 745f 6d61 7820  e recipient_max 
+00038f90: 2862 7920 6465 7369 676e 290a 2020 2020  (by design).    
+00038fa0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
+00038fb0: 6279 7465 735f 6d61 7820 3d20 7773 5f6d  bytes_max = ws_m
+00038fc0: 656d 6f72 7920 2d20 6d65 616e 5f6d 656d  emory - mean_mem
+00038fd0: 6f72 7920 2023 206e 6567 6174 6976 650a  ory  # negative.
+00038fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ff0: 7265 635f 6279 7465 735f 6d69 6e20 3d20  rec_bytes_min = 
+00039000: 7265 635f 6279 7465 735f 6d61 7820 2b20  rec_bytes_max + 
+00039010: 6861 6c66 5f67 6170 2020 2320 6e65 6761  half_gap  # nega
+00039020: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
+00039030: 2020 2020 2023 2053 6565 2064 6566 696e       # See defin
+00039040: 6974 696f 6e20 6f66 2072 6563 6970 6965  ition of recipie
+00039050: 6e74 7320 6162 6f76 650a 2020 2020 2020  nts above.      
+00039060: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
+00039070: 656e 7473 2e61 7070 656e 6428 2872 6563  ents.append((rec
+00039080: 5f62 7974 6573 5f6d 6178 2c20 7265 635f  _bytes_max, rec_
+00039090: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
+000390a0: 292c 2077 7329 290a 0a20 2020 2020 2020  ), ws))..       
+000390b0: 2023 2046 6173 7420 6578 6974 2069 6e20   # Fast exit in 
+000390c0: 6361 7365 206e 6f20 7472 616e 7366 6572  case no transfer
+000390d0: 7320 6172 6520 6e65 6365 7373 6172 7920  s are necessary 
+000390e0: 6f72 2070 6f73 7369 626c 650a 2020 2020  or possible.    
+000390f0: 2020 2020 6966 206e 6f74 2073 656e 6465      if not sende
+00039100: 7273 206f 7220 6e6f 7420 7265 6369 7069  rs or not recipi
+00039110: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+00039120: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00039130: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039140: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
+00039150: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00039160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00039170: 6163 7469 6f6e 223a 2022 7265 6261 6c61  action": "rebala
+00039180: 6e63 6522 2c0a 2020 2020 2020 2020 2020  nce",.          
+00039190: 2020 2020 2020 2020 2020 2273 656e 6465            "sende
+000391a0: 7273 223a 206c 656e 2873 656e 6465 7273  rs": len(senders
+000391b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000391c0: 2020 2020 2020 2022 7265 6369 7069 656e         "recipien
+000391d0: 7473 223a 206c 656e 2872 6563 6970 6965  ts": len(recipie
+000391e0: 6e74 7329 2c0a 2020 2020 2020 2020 2020  nts),.          
+000391f0: 2020 2020 2020 2020 2020 226d 6f76 6564            "moved
+00039200: 5f6b 6579 7322 3a20 302c 0a20 2020 2020  _keys": 0,.     
+00039210: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00039220: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00039230: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+00039240: 5d0a 0a20 2020 2020 2020 2068 6561 7071  ]..        heapq
+00039250: 2e68 6561 7069 6679 2873 656e 6465 7273  .heapify(senders
+00039260: 290a 2020 2020 2020 2020 6865 6170 712e  ).        heapq.
+00039270: 6865 6170 6966 7928 7265 6369 7069 656e  heapify(recipien
+00039280: 7473 290a 0a20 2020 2020 2020 2077 6869  ts)..        whi
+00039290: 6c65 2073 656e 6465 7273 2061 6e64 2072  le senders and r
+000392a0: 6563 6970 6965 6e74 733a 0a20 2020 2020  ecipients:.     
+000392b0: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
+000392c0: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
+000392d0: 6d69 6e2c 205f 2c20 736e 645f 7773 2c20  min, _, snd_ws, 
+000392e0: 7473 5f69 7465 7220 3d20 7365 6e64 6572  ts_iter = sender
+000392f0: 735b 305d 0a0a 2020 2020 2020 2020 2020  s[0]..          
+00039300: 2020 2320 4974 6572 6174 6520 7468 726f    # Iterate thro
+00039310: 7567 6820 7461 736b 7320 696e 206d 656d  ugh tasks in mem
+00039320: 6f72 792c 206c 6561 7374 2072 6563 656e  ory, least recen
+00039330: 746c 7920 696e 7365 7274 6564 2066 6972  tly inserted fir
+00039340: 7374 0a20 2020 2020 2020 2020 2020 2066  st.            f
+00039350: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
+00039360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039370: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
+00039380: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
+00039390: 206e 6f74 2069 6e20 6b65 7973 3a0a 2020   not in keys:.  
+000393a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000393b0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+000393c0: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+000393d0: 7320 3d20 7473 2e6e 6279 7465 730a 2020  s = ts.nbytes.  
+000393e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000393f0: 206e 6279 7465 7320 2b20 736e 645f 6279   nbytes + snd_by
+00039400: 7465 735f 6d61 7820 3e20 303a 0a20 2020  tes_max > 0:.   
+00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039420: 2023 204d 6f76 696e 6720 7468 6973 2074   # Moving this t
+00039430: 6173 6b20 776f 756c 6420 6361 7573 6520  ask would cause 
+00039440: 7468 6520 7365 6e64 6572 2074 6f20 676f  the sender to go
+00039450: 2062 656c 6f77 206d 6561 6e20 616e 640a   below mean and.
+00039460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039470: 2020 2020 2320 706f 7465 6e74 6961 6c6c      # potentiall
+00039480: 7920 7269 736b 2062 6563 6f6d 696e 6720  y risk becoming 
+00039490: 6120 7265 6369 7069 656e 742c 2077 6869  a recipient, whi
+000394a0: 6368 2077 6f75 6c64 2063 6175 7365 2074  ch would cause t
+000394b0: 6173 6b73 2074 6f0a 2020 2020 2020 2020  asks to.        
+000394c0: 2020 2020 2020 2020 2020 2020 2320 626f              # bo
+000394d0: 756e 6365 2061 726f 756e 642e 204d 6f76  unce around. Mov
+000394e0: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
+000394f0: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
+00039500: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
+00039510: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00039520: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+00039530: 2020 2020 2020 2020 2320 4669 6e64 2074          # Find t
+00039540: 6865 2072 6563 6970 6965 6e74 2c20 6661  he recipient, fa
+00039550: 7274 6865 7374 2066 726f 6d20 7468 6520  rthest from the 
+00039560: 6d65 616e 2c20 7768 6963 680a 2020 2020  mean, which.    
+00039570: 2020 2020 2020 2020 2020 2020 2320 312e              # 1.
+00039580: 2068 6173 2065 6e6f 7567 6820 6176 6169   has enough avai
+00039590: 6c61 626c 6520 5241 4d20 666f 7220 7468  lable RAM for th
+000395a0: 6973 2074 6173 6b2c 2061 6e64 0a20 2020  is task, and.   
+000395b0: 2020 2020 2020 2020 2020 2020 2023 2032               # 2
+000395c0: 2e20 646f 6573 6e27 7420 686f 6c64 2061  . doesn't hold a
+000395d0: 2063 6f70 7920 6f66 2074 6869 7320 7461   copy of this ta
+000395e0: 736b 2061 6c72 6561 6479 0a20 2020 2020  sk already.     
+000395f0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00039600: 7265 206d 6179 206e 6f74 2062 6520 616e  re may not be an
+00039610: 7920 7468 6174 2073 6174 6973 6669 6573  y that satisfies
+00039620: 2074 6865 7365 2063 6f6e 6469 7469 6f6e   these condition
+00039630: 733b 2069 6e20 7468 6973 2063 6173 650a  s; in this case.
+00039640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039650: 2320 7468 6973 2074 6173 6b20 776f 6e27  # this task won'
+00039660: 7420 6265 206d 6f76 6564 2e0a 2020 2020  t be moved..    
+00039670: 2020 2020 2020 2020 2020 2020 736b 6970              skip
+00039680: 7065 645f 7265 6369 7069 656e 7473 203d  ped_recipients =
+00039690: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000396a0: 2020 2020 7573 655f 7265 6369 7069 656e      use_recipien
+000396b0: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
+000396c0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+000396d0: 7265 6369 7069 656e 7473 2061 6e64 206e  recipients and n
+000396e0: 6f74 2075 7365 5f72 6563 6970 6965 6e74  ot use_recipient
+000396f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039700: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
+00039710: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
+00039720: 696e 2c20 5f2c 2072 6563 5f77 7320 3d20  in, _, rec_ws = 
+00039730: 7265 6369 7069 656e 7473 5b30 5d0a 2020  recipients[0].  
+00039740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039750: 2020 6966 206e 6279 7465 7320 2b20 7265    if nbytes + re
+00039760: 635f 6279 7465 735f 6d61 7820 3e20 303a  c_bytes_max > 0:
+00039770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039780: 2020 2020 2020 2020 2023 2072 6563 6970           # recip
+00039790: 6965 6e74 7320 6172 6520 736f 7274 6564  ients are sorted
+000397a0: 2062 7920 7265 635f 6279 7465 735f 6d61   by rec_bytes_ma
+000397b0: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
+000397c0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+000397d0: 206e 6578 7420 6f6e 6573 2077 696c 6c20   next ones will 
+000397e0: 6265 2077 6f72 7365 3b20 6e6f 2072 6561  be worse; no rea
+000397f0: 736f 6e20 746f 2063 6f6e 7469 6e75 6520  son to continue 
+00039800: 6974 6572 6174 696e 670a 2020 2020 2020  iterating.      
+00039810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039820: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00039830: 2020 2020 2020 2020 2020 2020 7573 655f              use_
+00039840: 7265 6369 7069 656e 7420 3d20 7473 206e  recipient = ts n
+00039850: 6f74 2069 6e20 7265 635f 7773 2e5f 6861  ot in rec_ws._ha
+00039860: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
+00039870: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00039880: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
+00039890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000398a0: 2020 2020 2020 2020 2073 6b69 7070 6564           skipped
+000398b0: 5f72 6563 6970 6965 6e74 732e 6170 7065  _recipients.appe
+000398c0: 6e64 2868 6561 7071 2e68 6561 7070 6f70  nd(heapq.heappop
+000398d0: 2872 6563 6970 6965 6e74 7329 290a 0a20  (recipients)).. 
+000398e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000398f0: 6f72 2072 6563 6970 6965 6e74 2069 6e20  or recipient in 
+00039900: 736b 6970 7065 645f 7265 6369 7069 656e  skipped_recipien
+00039910: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00039920: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
+00039930: 6170 7075 7368 2872 6563 6970 6965 6e74  appush(recipient
+00039940: 732c 2072 6563 6970 6965 6e74 290a 0a20  s, recipient).. 
+00039950: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00039960: 6620 6e6f 7420 7573 655f 7265 6369 7069  f not use_recipi
+00039970: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+00039980: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00039990: 7461 736b 2068 6173 206e 6f20 7265 6369  task has no reci
+000399a0: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
+000399b0: 2e20 4c65 6176 6520 6974 206f 6e20 7468  . Leave it on th
+000399c0: 6520 7365 6e64 6572 2061 6e64 0a20 2020  e sender and.   
+000399d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000399e0: 2023 206d 6f76 6520 6f6e 2074 6f20 7468   # move on to th
+000399f0: 6520 6e65 7874 2074 6173 6b20 6f66 2074  e next task of t
+00039a00: 6865 2073 616d 6520 7365 6e64 6572 2e0a  he same sender..
+00039a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a20: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00039a30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00039a40: 5363 6865 6475 6c65 2074 6173 6b20 666f  Schedule task fo
+00039a50: 7220 7472 616e 7366 6572 2066 726f 6d20  r transfer from 
+00039a60: 7365 6e64 6572 2074 6f20 7265 6369 7069  sender to recipi
+00039a70: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+00039a80: 2020 2020 6d73 6773 2e61 7070 656e 6428      msgs.append(
+00039a90: 2873 6e64 5f77 732c 2072 6563 5f77 732c  (snd_ws, rec_ws,
+00039aa0: 2074 7329 290a 0a20 2020 2020 2020 2020   ts))..         
+00039ab0: 2020 2020 2020 2023 202a 5f62 7974 6573         # *_bytes
+00039ac0: 5f6d 6178 2f6d 696e 2061 7265 2061 6c6c  _max/min are all
+00039ad0: 206e 6567 6174 6976 6520 666f 7220 6865   negative for he
+00039ae0: 6170 2073 6f72 7469 6e67 0a20 2020 2020  ap sorting.     
+00039af0: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
+00039b00: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
+00039b10: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00039b20: 2020 2073 6e64 5f62 7974 6573 5f6d 696e     snd_bytes_min
+00039b30: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
+00039b40: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
+00039b50: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
+00039b60: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00039b70: 2020 2072 6563 5f62 7974 6573 5f6d 696e     rec_bytes_min
+00039b80: 202b 3d20 6e62 7974 6573 0a0a 2020 2020   += nbytes..    
+00039b90: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+00039ba0: 6f70 2069 7465 7261 7469 6e67 206f 6e20  op iterating on 
+00039bb0: 7468 6520 7461 736b 7320 6f66 2074 6869  the tasks of thi
+00039bc0: 7320 7365 6e64 6572 2066 6f72 206e 6f77  s sender for now
+00039bd0: 2061 6e64 2c20 6966 2069 7420 7374 696c   and, if it stil
+00039be0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00039bf0: 2020 2320 6861 7320 6279 7465 7320 746f    # has bytes to
+00039c00: 206c 6f73 652c 2070 7573 6820 6974 2062   lose, push it b
+00039c10: 6163 6b20 696e 746f 2074 6865 2073 656e  ack into the sen
+00039c20: 6465 7273 2068 6561 703b 2069 7420 6d61  ders heap; it ma
+00039c30: 7920 6f72 206d 6179 0a20 2020 2020 2020  y or may.       
+00039c40: 2020 2020 2020 2020 2023 206e 6f74 2063           # not c
+00039c50: 6f6d 6520 6261 636b 206f 6e20 746f 7020  ome back on top 
+00039c60: 6167 6169 6e2e 0a20 2020 2020 2020 2020  again..         
+00039c70: 2020 2020 2020 2069 6620 736e 645f 6279         if snd_by
+00039c80: 7465 735f 6d69 6e20 3c20 303a 0a20 2020  tes_min < 0:.   
+00039c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ca0: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
+00039cb0: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
+00039cc0: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+00039cd0: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
+00039ce0: 7072 6570 6c61 6365 280a 2020 2020 2020  preplace(.      
+00039cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d00: 2020 7365 6e64 6572 732c 0a20 2020 2020    senders,.     
+00039d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d20: 2020 2028 736e 645f 6279 7465 735f 6d61     (snd_bytes_ma
+00039d30: 782c 2073 6e64 5f62 7974 6573 5f6d 696e  x, snd_bytes_min
+00039d40: 2c20 6964 2873 6e64 5f77 7329 2c20 736e  , id(snd_ws), sn
+00039d50: 645f 7773 2c20 7473 5f69 7465 7229 2c0a  d_ws, ts_iter),.
+00039d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d70: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00039d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00039d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039da0: 6865 6170 712e 6865 6170 706f 7028 7365  heapq.heappop(se
+00039db0: 6e64 6572 7329 0a0a 2020 2020 2020 2020  nders)..        
+00039dc0: 2020 2020 2020 2020 2320 4966 2072 6563          # If rec
+00039dd0: 6970 6965 6e74 2073 7469 6c6c 2068 6173  ipient still has
+00039de0: 2062 7974 6573 2074 6f20 6761 696e 2c20   bytes to gain, 
+00039df0: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
+00039e00: 6f20 7468 6520 7265 6369 7069 656e 7473  o the recipients
+00039e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039e20: 2023 2068 6561 703b 2069 7420 6d61 7920   # heap; it may 
+00039e30: 6f72 206d 6179 206e 6f74 2063 6f6d 6520  or may not come 
+00039e40: 6261 636b 206f 6e20 746f 7020 6167 6169  back on top agai
+00039e50: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+00039e60: 2020 2069 6620 7265 635f 6279 7465 735f     if rec_bytes_
+00039e70: 6d69 6e20 3c20 303a 0a20 2020 2020 2020  min < 0:.       
+00039e80: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+00039e90: 6565 2064 6566 696e 6974 696f 6e20 6f66  ee definition of
+00039ea0: 2072 6563 6970 6965 6e74 7320 6162 6f76   recipients abov
+00039eb0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00039ec0: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
+00039ed0: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
+00039ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039ef0: 2072 6563 6970 6965 6e74 732c 0a20 2020   recipients,.   
+00039f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039f10: 2020 2020 2028 7265 635f 6279 7465 735f       (rec_bytes_
+00039f20: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
+00039f30: 696e 2c20 6964 2872 6563 5f77 7329 2c20  in, id(rec_ws), 
+00039f40: 7265 635f 7773 292c 0a20 2020 2020 2020  rec_ws),.       
+00039f50: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00039f60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00039f70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00039f80: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
+00039f90: 6561 7070 6f70 2872 6563 6970 6965 6e74  eappop(recipient
+00039fa0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00039fb0: 2020 2020 2320 4d6f 7665 2074 6f20 6e65      # Move to ne
+00039fc0: 7874 2073 656e 6465 7220 7769 7468 2074  xt sender with t
+00039fd0: 6865 206d 6f73 7420 6461 7461 2074 6f20  he most data to 
+00039fe0: 6c6f 7365 2e0a 2020 2020 2020 2020 2020  lose..          
+00039ff0: 2020 2020 2020 2320 4974 206d 6179 206f        # It may o
+0003a000: 7220 6d61 7920 6e6f 7420 6265 2074 6865  r may not be the
+0003a010: 2073 616d 6520 7365 6e64 6572 2061 6761   same sender aga
+0003a020: 696e 2e0a 2020 2020 2020 2020 2020 2020  in..            
+0003a030: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0003a040: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
+0003a050: 666f 7220 7473 2069 6e20 7473 5f69 7465  for ts in ts_ite
+0003a060: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0003a070: 2020 2320 4578 6861 7573 7465 6420 7461    # Exhausted ta
+0003a080: 736b 7320 6f6e 2074 6869 7320 7365 6e64  sks on this send
+0003a090: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0003a0a0: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
+0003a0b0: 2873 656e 6465 7273 290a 0a20 2020 2020  (senders)..     
+0003a0c0: 2020 2072 6574 7572 6e20 6d73 6773 0a0a     return msgs..
+0003a0d0: 2020 2020 6173 796e 6320 6465 6620 5f72      async def _r
+0003a0e0: 6562 616c 616e 6365 5f6d 6f76 655f 6461  ebalance_move_da
+0003a0f0: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
+0003a100: 2c20 6d73 6773 3a20 226c 6973 745b 7475  , msgs: "list[tu
+0003a110: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
+0003a120: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
+0003a130: 736b 5374 6174 655d 5d22 2c20 7374 696d  skState]]", stim
+0003a140: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
+0003a150: 2029 202d 3e20 6469 6374 3a0a 2020 2020   ) -> dict:.    
+0003a160: 2020 2020 2222 2250 6572 666f 726d 2074      """Perform t
+0003a170: 6865 2061 6374 7561 6c20 7472 616e 7366  he actual transf
+0003a180: 6572 206f 6620 6461 7461 2061 6372 6f73  er of data acros
+0003a190: 7320 7468 6520 6e65 7477 6f72 6b20 696e  s the network in
+0003a1a0: 2072 6562 616c 616e 6365 2829 2e0a 2020   rebalance()..  
+0003a1b0: 2020 2020 2020 5461 6b65 7320 696e 2069        Takes in i
+0003a1c0: 6e70 7574 2074 6865 206f 7574 7075 7420  nput the output 
+0003a1d0: 6f66 205f 7265 6261 6c61 6e63 655f 6669  of _rebalance_fi
+0003a1e0: 6e64 5f6d 7367 7328 292c 2074 6861 7420  nd_msgs(), that 
+0003a1f0: 6973 2061 206c 6973 7420 6f66 2074 7570  is a list of tup
+0003a200: 6c65 733a 0a0a 2020 2020 2020 2020 2d20  les:..        - 
+0003a210: 7365 6e64 6572 2077 6f72 6b65 720a 2020  sender worker.  
+0003a220: 2020 2020 2020 2d20 7265 6369 7069 656e        - recipien
+0003a230: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
+0003a240: 202d 2074 6173 6b20 746f 2062 6520 7472   - task to be tr
+0003a250: 616e 7366 6572 7265 640a 0a20 2020 2020  ansferred..     
+0003a260: 2020 2046 4958 4d45 2074 6869 7320 6d65     FIXME this me
+0003a270: 7468 6f64 2069 7320 6e6f 7420 726f 6275  thod is not robu
+0003a280: 7374 2077 6865 6e20 7468 6520 636c 7573  st when the clus
+0003a290: 7465 7220 6973 206e 6f74 2069 646c 652e  ter is not idle.
+0003a2a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0003a2b0: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
+0003a2c0: 7473 3a20 6465 6661 756c 7464 6963 745b  ts: defaultdict[
+0003a2d0: 7374 722c 2064 6566 6175 6c74 6469 6374  str, defaultdict
+0003a2e0: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
+0003a2f0: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
+0003a300: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+0003a310: 6264 613a 2064 6566 6175 6c74 6469 6374  bda: defaultdict
+0003a320: 286c 6973 7429 0a20 2020 2020 2020 2029  (list).        )
+0003a330: 0a20 2020 2020 2020 2066 6f72 2073 6e64  .        for snd
+0003a340: 5f77 732c 2072 6563 5f77 732c 2074 7320  _ws, rec_ws, ts 
+0003a350: 696e 206d 7367 733a 0a20 2020 2020 2020  in msgs:.       
+0003a360: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
+0003a370: 7473 5b72 6563 5f77 732e 6164 6472 6573  ts[rec_ws.addres
+0003a380: 735d 5b74 732e 6b65 795d 2e61 7070 656e  s][ts.key].appen
+0003a390: 6428 736e 645f 7773 2e61 6464 7265 7373  d(snd_ws.address
+0003a3a0: 290a 2020 2020 2020 2020 6661 696c 6564  ).        failed
+0003a3b0: 5f6b 6579 735f 6279 5f72 6563 6970 6965  _keys_by_recipie
+0003a3c0: 6e74 203d 2064 6963 7428 0a20 2020 2020  nt = dict(.     
+0003a3d0: 2020 2020 2020 207a 6970 280a 2020 2020         zip(.    
+0003a3e0: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
+0003a3f0: 6563 6970 6965 6e74 732c 0a20 2020 2020  ecipients,.     
+0003a400: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0003a410: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+0003a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a430: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
+0003a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a450: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
+0003a460: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
+0003a470: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+0003a480: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003a490: 662e 6761 7468 6572 5f6f 6e5f 776f 726b  f.gather_on_work
+0003a4a0: 6572 2877 2c20 7768 6f5f 6861 7329 0a20  er(w, who_has). 
+0003a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a4c0: 2020 2020 2020 2066 6f72 2077 2c20 7768         for w, wh
+0003a4d0: 6f5f 6861 7320 696e 2074 6f5f 7265 6369  o_has in to_reci
+0003a4e0: 7069 656e 7473 2e69 7465 6d73 2829 0a20  pients.items(). 
+0003a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a500: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003a510: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0003a520: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+0003a530: 0a20 2020 2020 2020 2074 6f5f 7365 6e64  .        to_send
+0003a540: 6572 7320 3d20 6465 6661 756c 7464 6963  ers = defaultdic
+0003a550: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
+0003a560: 666f 7220 736e 645f 7773 2c20 7265 635f  for snd_ws, rec_
+0003a570: 7773 2c20 7473 2069 6e20 6d73 6773 3a0a  ws, ts in msgs:.
+0003a580: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0003a590: 732e 6b65 7920 6e6f 7420 696e 2066 6169  s.key not in fai
+0003a5a0: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
+0003a5b0: 7069 656e 745b 7265 635f 7773 2e61 6464  pient[rec_ws.add
+0003a5c0: 7265 7373 5d3a 0a20 2020 2020 2020 2020  ress]:.         
+0003a5d0: 2020 2020 2020 2074 6f5f 7365 6e64 6572         to_sender
+0003a5e0: 735b 736e 645f 7773 2e61 6464 7265 7373  s[snd_ws.address
+0003a5f0: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
+0003a600: 0a0a 2020 2020 2020 2020 2320 4e6f 7465  ..        # Note
+0003a610: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
+0003a620: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
+0003a630: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+0003a640: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+0003a650: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
+0003a660: 6465 6c65 7465 5f77 6f72 6b65 725f 6461  delete_worker_da
+0003a670: 7461 2872 2c20 762c 2073 7469 6d75 6c75  ta(r, v, stimulu
+0003a680: 735f 6964 2920 666f 7220 722c 2076 2069  s_id) for r, v i
+0003a690: 6e20 746f 5f73 656e 6465 7273 2e69 7465  n to_senders.ite
+0003a6a0: 6d73 2829 290a 2020 2020 2020 2020 290a  ms()).        ).
+0003a6b0: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
+0003a6c0: 7620 696e 2074 6f5f 7265 6369 7069 656e  v in to_recipien
+0003a6d0: 7473 2e69 7465 6d73 2829 3a0a 2020 2020  ts.items():.    
+0003a6e0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0003a6f0: 5f65 7665 6e74 2872 2c20 7b22 6163 7469  _event(r, {"acti
+0003a700: 6f6e 223a 2022 7265 6261 6c61 6e63 6522  on": "rebalance"
+0003a710: 2c20 2277 686f 5f68 6173 223a 2076 7d29  , "who_has": v})
+0003a720: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0003a730: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
+0003a740: 2020 2020 2022 616c 6c22 2c0a 2020 2020       "all",.    
+0003a750: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003a760: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+0003a770: 6e22 3a20 2272 6562 616c 616e 6365 222c  n": "rebalance",
+0003a780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a790: 2022 7365 6e64 6572 7322 3a20 7661 6c6d   "senders": valm
+0003a7a0: 6170 286c 656e 2c20 746f 5f73 656e 6465  ap(len, to_sende
+0003a7b0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+0003a7c0: 2020 2020 2022 7265 6369 7069 656e 7473       "recipients
+0003a7d0: 223a 2076 616c 6d61 7028 6c65 6e2c 2074  ": valmap(len, t
+0003a7e0: 6f5f 7265 6369 7069 656e 7473 292c 0a20  o_recipients),. 
+0003a7f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003a800: 6d6f 7665 645f 6b65 7973 223a 206c 656e  moved_keys": len
+0003a810: 286d 7367 7329 2c0a 2020 2020 2020 2020  (msgs),.        
+0003a820: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
+0003a830: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
+0003a840: 675f 6b65 7973 203d 207b 6b20 666f 7220  g_keys = {k for 
+0003a850: 7220 696e 2066 6169 6c65 645f 6b65 7973  r in failed_keys
+0003a860: 5f62 795f 7265 6369 7069 656e 742e 7661  _by_recipient.va
+0003a870: 6c75 6573 2829 2066 6f72 206b 2069 6e20  lues() for k in 
+0003a880: 727d 0a20 2020 2020 2020 2069 6620 6d69  r}.        if mi
+0003a890: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
+0003a8a0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003a8b0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
+0003a8c0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
+0003a8d0: 3a20 6c69 7374 286d 6973 7369 6e67 5f6b  : list(missing_k
+0003a8e0: 6579 7329 7d0a 2020 2020 2020 2020 656c  eys)}.        el
+0003a8f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003a900: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
+0003a910: 3a20 224f 4b22 7d0a 0a20 2020 2061 7379  : "OK"}..    asy
+0003a920: 6e63 2064 6566 2072 6570 6c69 6361 7465  nc def replicate
+0003a930: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0003a940: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
+0003a950: 652c 0a20 2020 2020 2020 206b 6579 733d  e,.        keys=
+0003a960: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e3d  None,.        n=
+0003a970: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+0003a980: 726b 6572 733d 4e6f 6e65 2c0a 2020 2020  rkers=None,.    
+0003a990: 2020 2020 6272 616e 6368 696e 675f 6661      branching_fa
+0003a9a0: 6374 6f72 3d32 2c0a 2020 2020 2020 2020  ctor=2,.        
+0003a9b0: 6465 6c65 7465 3d54 7275 652c 0a20 2020  delete=True,.   
+0003a9c0: 2020 2020 206c 6f63 6b3d 5472 7565 2c0a       lock=True,.
+0003a9d0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0003a9e0: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
+0003a9f0: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
+0003aa00: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
+0003aa10: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
+0003aa20: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
+0003aa30: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
+0003aa40: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
+0003aa50: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
+0003aa60: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
+0003aa70: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
+0003aa80: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
+0003aa90: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0003aaa0: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+0003aab0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
+0003aac0: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
+0003aad0: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
+0003aae0: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
+0003aaf0: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
+0003ab00: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
+0003ab10: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
+0003ab20: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
+0003ab30: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
+0003ab40: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
+0003ab50: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
+0003ab60: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
+0003ab70: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
+0003ab80: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
+0003ab90: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
+0003aba0: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
+0003abb0: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
+0003abc0: 2020 2020 2020 2054 6865 206c 6172 6765         The large
+0003abd0: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
+0003abe0: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
+0003abf0: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
+0003ac00: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
+0003ac10: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
+0003ac20: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
+0003ac30: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
+0003ac40: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0003ac50: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
+0003ac60: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
+0003ac70: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+0003ac80: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0003ac90: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
+0003aca0: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
+0003acb0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
+0003acc0: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
+0003acd0: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
+0003ace0: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
+0003acf0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0003ad00: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
+0003ad10: 3e20 300a 2020 2020 2020 2020 6173 796e  > 0.        asyn
+0003ad20: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
+0003ad30: 6b20 6966 206c 6f63 6b20 656c 7365 2065  k if lock else e
+0003ad40: 6d70 7479 5f63 6f6e 7465 7874 3a0a 2020  mpty_context:.  
+0003ad50: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
+0003ad60: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
+0003ad70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ad80: 2020 776f 726b 6572 7320 3d20 7b73 656c    workers = {sel
+0003ad90: 662e 776f 726b 6572 735b 775d 2066 6f72  f.workers[w] for
+0003ada0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
+0003adb0: 7273 5f6c 6973 7428 776f 726b 6572 7329  rs_list(workers)
+0003adc0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003add0: 2020 776f 726b 6572 7320 3d20 7b77 7320    workers = {ws 
+0003ade0: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
+0003adf0: 7320 6966 2077 732e 7374 6174 7573 203d  s if ws.status =
+0003ae00: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
+0003ae10: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
+0003ae20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003ae30: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+0003ae40: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
+0003ae50: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
+0003ae60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003ae70: 2020 2020 2020 6e20 3d20 6c65 6e28 776f        n = len(wo
+0003ae80: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
+0003ae90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003aea0: 2020 2020 2020 2020 206e 203d 206d 696e           n = min
+0003aeb0: 286e 2c20 6c65 6e28 776f 726b 6572 7329  (n, len(workers)
+0003aec0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0003aed0: 206e 203d 3d20 303a 0a20 2020 2020 2020   n == 0:.       
+0003aee0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0003aef0: 616c 7565 4572 726f 7228 2243 616e 206e  alueError("Can n
+0003af00: 6f74 2075 7365 2072 6570 6c69 6361 7465  ot use replicate
+0003af10: 2074 6f20 6465 6c65 7465 2064 6174 6122   to delete data"
+0003af20: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
+0003af30: 6173 6b73 203d 207b 7365 6c66 2e74 6173  asks = {self.tas
+0003af40: 6b73 5b6b 5d20 666f 7220 6b20 696e 206b  ks[k] for k in k
+0003af50: 6579 737d 0a20 2020 2020 2020 2020 2020  eys}.           
+0003af60: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
+0003af70: 5b74 732e 6b65 7920 666f 7220 7473 2069  [ts.key for ts i
+0003af80: 6e20 7461 736b 7320 6966 206e 6f74 2074  n tasks if not t
+0003af90: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
+0003afa0: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
+0003afb0: 675f 6461 7461 3a0a 2020 2020 2020 2020  g_data:.        
+0003afc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003afd0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
+0003afe0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
+0003aff0: 3a20 6d69 7373 696e 675f 6461 7461 7d0a  : missing_data}.
+0003b000: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
+0003b010: 656c 6574 6520 6578 7472 616e 656f 7573  elete extraneous
+0003b020: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+0003b030: 2020 6966 2064 656c 6574 653a 0a20 2020    if delete:.   
+0003b040: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0003b050: 5f77 6f72 6b65 725f 7461 736b 7320 3d20  _worker_tasks = 
+0003b060: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
+0003b070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b080: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
+0003b090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b0a0: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
+0003b0b0: 6174 6573 203d 2074 7570 6c65 2874 732e  ates = tuple(ts.
+0003b0c0: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
+0003b0d0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0003b0e0: 2020 2020 2020 2069 6620 6c65 6e28 6465         if len(de
+0003b0f0: 6c5f 6361 6e64 6964 6174 6573 2920 3e20  l_candidates) > 
+0003b100: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0003b110: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+0003b120: 7320 696e 2072 616e 646f 6d2e 7361 6d70  s in random.samp
+0003b130: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+0003b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b150: 6465 6c5f 6361 6e64 6964 6174 6573 2c20  del_candidates, 
+0003b160: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
+0003b170: 6573 2920 2d20 6e0a 2020 2020 2020 2020  es) - n.        
+0003b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003b1a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003b1b0: 656c 5f77 6f72 6b65 725f 7461 736b 735b  el_worker_tasks[
+0003b1c0: 7773 5d2e 6164 6428 7473 290a 0a20 2020  ws].add(ts)..   
+0003b1d0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+0003b1e0: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
+0003b1f0: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
+0003b200: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003b210: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0003b220: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+0003b230: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+0003b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b250: 2020 2020 2020 2073 656c 662e 6465 6c65         self.dele
+0003b260: 7465 5f77 6f72 6b65 725f 6461 7461 280a  te_worker_data(.
+0003b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b280: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
+0003b290: 6464 7265 7373 2c20 5b74 2e6b 6579 2066  ddress, [t.key f
+0003b2a0: 6f72 2074 2069 6e20 7461 736b 735d 2c20  or t in tasks], 
+0003b2b0: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
+0003b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b2d0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0003b2e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003b2f0: 7220 7773 2c20 7461 736b 7320 696e 2064  r ws, tasks in d
+0003b300: 656c 5f77 6f72 6b65 725f 7461 736b 732e  el_worker_tasks.
+0003b310: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+0003b320: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0003b330: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003b340: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0003b350: 6f70 7920 6e6f 742d 7965 742d 6669 6c6c  opy not-yet-fill
+0003b360: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+0003b370: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
+0003b380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b390: 2067 6174 6865 7273 203d 2064 6566 6175   gathers = defau
+0003b3a0: 6c74 6469 6374 2864 6963 7429 0a20 2020  ltdict(dict).   
+0003b3b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003b3c0: 2074 7320 696e 206c 6973 7428 7461 736b   ts in list(task
+0003b3d0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0003b3e0: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+0003b3f0: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
+0003b400: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+0003b410: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
+0003b420: 736b 2069 7320 6e6f 206c 6f6e 6765 7220  sk is no longer 
+0003b430: 6e65 6564 6564 2062 7920 616e 7920 636c  needed by any cl
+0003b440: 6965 6e74 206f 7220 6465 7065 6e64 656e  ient or dependen
+0003b450: 7420 7461 736b 0a20 2020 2020 2020 2020  t task.         
+0003b460: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0003b470: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
+0003b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b490: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0003b4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b4b0: 2020 2020 206e 5f6d 6973 7369 6e67 203d       n_missing =
+0003b4c0: 206e 202d 206c 656e 2874 732e 7768 6f5f   n - len(ts.who_
+0003b4d0: 6861 7320 2620 776f 726b 6572 7329 0a20  has & workers). 
+0003b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b4f0: 2020 2069 6620 6e5f 6d69 7373 696e 6720     if n_missing 
+0003b500: 3c3d 2030 3a0a 2020 2020 2020 2020 2020  <= 0:.          
+0003b510: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003b520: 416c 7265 6164 7920 7265 706c 6963 6174  Already replicat
+0003b530: 6564 2065 6e6f 7567 680a 2020 2020 2020  ed enough.      
+0003b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b550: 2020 7461 736b 732e 7265 6d6f 7665 2874    tasks.remove(t
+0003b560: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0003b570: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003b580: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0003b590: 2020 2020 2020 2020 2063 6f75 6e74 203d           count =
+0003b5a0: 206d 696e 286e 5f6d 6973 7369 6e67 2c20   min(n_missing, 
+0003b5b0: 6272 616e 6368 696e 675f 6661 6374 6f72  branching_factor
+0003b5c0: 202a 206c 656e 2874 732e 7768 6f5f 6861   * len(ts.who_ha
+0003b5d0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0003b5e0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+0003b5f0: 6f75 6e74 203e 2030 0a0a 2020 2020 2020  ount > 0..      
+0003b600: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003b610: 7220 7773 2069 6e20 7261 6e64 6f6d 2e73  r ws in random.s
+0003b620: 616d 706c 6528 7475 706c 6528 776f 726b  ample(tuple(work
+0003b630: 6572 7320 2d20 7473 2e77 686f 5f68 6173  ers - ts.who_has
+0003b640: 292c 2063 6f75 6e74 293a 0a20 2020 2020  ), count):.     
+0003b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b660: 2020 2067 6174 6865 7273 5b77 732e 6164     gathers[ws.ad
+0003b670: 6472 6573 735d 5b74 732e 6b65 795d 203d  dress][ts.key] =
+0003b680: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0003b690: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003b6a0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
+0003b6b0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+0003b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b6d0: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+0003b6e0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0003b6f0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0003b700: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003b710: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+0003b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b730: 2023 204e 6f74 653a 2074 6869 7320 6e65   # Note: this ne
+0003b740: 7665 7220 7261 6973 6573 2065 7863 6570  ver raises excep
+0003b750: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+0003b760: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003b770: 6c66 2e67 6174 6865 725f 6f6e 5f77 6f72  lf.gather_on_wor
+0003b780: 6b65 7228 772c 2077 686f 5f68 6173 290a  ker(w, who_has).
+0003b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b7a0: 2020 2020 2020 2020 666f 7220 772c 2077          for w, w
+0003b7b0: 686f 5f68 6173 2069 6e20 6761 7468 6572  ho_has in gather
+0003b7c0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+0003b7d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b7f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003b800: 2020 666f 7220 722c 2076 2069 6e20 6761    for r, v in ga
+0003b810: 7468 6572 732e 6974 656d 7328 293a 0a20  thers.items():. 
+0003b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b830: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0003b840: 7428 722c 207b 2261 6374 696f 6e22 3a20  t(r, {"action": 
+0003b850: 2272 6570 6c69 6361 7465 2d61 6464 222c  "replicate-add",
+0003b860: 2022 7768 6f5f 6861 7322 3a20 767d 290a   "who_has": v}).
+0003b870: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0003b880: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
+0003b890: 2020 2020 2020 2020 2020 2020 2022 616c               "al
+0003b8a0: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
+0003b8b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003b8c0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+0003b8d0: 6e22 3a20 2272 6570 6c69 6361 7465 222c  n": "replicate",
+0003b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b8f0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
+0003b900: 6c69 7374 2877 6f72 6b65 7273 292c 0a20  list(workers),. 
+0003b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b920: 2020 2022 6b65 792d 636f 756e 7422 3a20     "key-count": 
+0003b930: 6c65 6e28 6b65 7973 292c 0a20 2020 2020  len(keys),.     
+0003b940: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003b950: 6272 616e 6368 696e 672d 6661 6374 6f72  branching-factor
+0003b960: 223a 2062 7261 6e63 6869 6e67 5f66 6163  ": branching_fac
+0003b970: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+0003b980: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0003b990: 2020 2020 290a 0a20 2020 2064 6566 2077      )..    def w
+0003b9a0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003b9b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0003b9c0: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
+0003b9d0: 7469 6f3a 2069 6e74 207c 2066 6c6f 6174  tio: int | float
+0003b9e0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+0003b9f0: 2020 2020 2020 2020 6e3a 2069 6e74 207c          n: int |
+0003ba00: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0003ba10: 2020 2020 2020 6b65 793a 2043 616c 6c61        key: Calla
+0003ba20: 626c 655b 5b57 6f72 6b65 7253 7461 7465  ble[[WorkerState
+0003ba30: 5d2c 2048 6173 6861 626c 655d 207c 2062  ], Hashable] | b
+0003ba40: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
+0003ba50: 6e65 2c0a 2020 2020 2020 2020 6d69 6e69  ne,.        mini
+0003ba60: 6d75 6d3a 2069 6e74 207c 204e 6f6e 6520  mum: int | None 
+0003ba70: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0003ba80: 7461 7267 6574 3a20 696e 7420 7c20 4e6f  target: int | No
+0003ba90: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003baa0: 2020 2061 7474 7269 6275 7465 3a20 7374     attribute: st
+0003bab0: 7220 3d20 2261 6464 7265 7373 222c 0a20  r = "address",. 
+0003bac0: 2020 2029 202d 3e20 6c69 7374 5b73 7472     ) -> list[str
+0003bad0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0003bae0: 2020 2020 2020 2046 696e 6420 776f 726b         Find work
+0003baf0: 6572 7320 7468 6174 2077 6520 6361 6e20  ers that we can 
+0003bb00: 636c 6f73 6520 7769 7468 206c 6f77 2063  close with low c
+0003bb10: 6f73 740a 0a20 2020 2020 2020 2054 6869  ost..        Thi
+0003bb20: 7320 7265 7475 726e 7320 6120 6c69 7374  s returns a list
+0003bb30: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
+0003bb40: 2061 7265 2067 6f6f 6420 6361 6e64 6964   are good candid
+0003bb50: 6174 6573 2074 6f20 7265 7469 7265 2e0a  ates to retire..
+0003bb60: 2020 2020 2020 2020 5468 6573 6520 776f          These wo
+0003bb70: 726b 6572 7320 6172 6520 6e6f 7420 7275  rkers are not ru
+0003bb80: 6e6e 696e 6720 616e 7974 6869 6e67 2061  nning anything a
+0003bb90: 6e64 2061 7265 2073 746f 7269 6e67 0a20  nd are storing. 
+0003bba0: 2020 2020 2020 2072 656c 6174 6976 656c         relativel
+0003bbb0: 7920 6c69 7474 6c65 2064 6174 6120 7265  y little data re
+0003bbc0: 6c61 7469 7665 2074 6f20 7468 6569 7220  lative to their 
+0003bbd0: 7065 6572 732e 2020 4966 2061 6c6c 2077  peers.  If all w
+0003bbe0: 6f72 6b65 7273 2061 7265 0a20 2020 2020  orkers are.     
+0003bbf0: 2020 2069 646c 6520 7468 656e 2077 6520     idle then we 
+0003bc00: 7374 696c 6c20 6d61 696e 7461 696e 2065  still maintain e
+0003bc10: 6e6f 7567 6820 776f 726b 6572 7320 746f  nough workers to
+0003bc20: 2068 6176 6520 656e 6f75 6768 2052 414d   have enough RAM
+0003bc30: 2074 6f20 7374 6f72 650a 2020 2020 2020   to store.      
+0003bc40: 2020 6f75 7220 6461 7461 2c20 7769 7468    our data, with
+0003bc50: 2061 2063 6f6d 666f 7274 6162 6c65 2062   a comfortable b
+0003bc60: 7566 6665 722e 0a0a 2020 2020 2020 2020  uffer...        
+0003bc70: 5468 6973 2069 7320 666f 7220 7573 6520  This is for use 
+0003bc80: 7769 7468 2073 7973 7465 6d73 206c 696b  with systems lik
+0003bc90: 6520 6060 6469 7374 7269 6275 7465 642e  e ``distributed.
+0003bca0: 6465 706c 6f79 2e61 6461 7074 6976 6560  deploy.adaptive`
+0003bcb0: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
+0003bcc0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+0003bcd0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+0003bce0: 2020 6d65 6d6f 7279 5f72 6174 696f 203a    memory_ratio :
+0003bcf0: 204e 756d 6265 720a 2020 2020 2020 2020   Number.        
+0003bd00: 2020 2020 416d 6f75 6e74 206f 6620 6578      Amount of ex
+0003bd10: 7472 6120 7370 6163 6520 7765 2077 616e  tra space we wan
+0003bd20: 7420 746f 2068 6176 6520 666f 7220 6f75  t to have for ou
+0003bd30: 7220 7374 6f72 6564 2064 6174 612e 0a20  r stored data.. 
+0003bd40: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
+0003bd50: 6c74 7320 746f 2032 2c20 6f72 2074 6861  lts to 2, or tha
+0003bd60: 7420 7765 2077 616e 7420 746f 2068 6176  t we want to hav
+0003bd70: 6520 7477 6963 6520 6173 206d 7563 6820  e twice as much 
+0003bd80: 6d65 6d6f 7279 2061 7320 7765 0a20 2020  memory as we.   
+0003bd90: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+0003bda0: 6c79 2068 6176 6520 6461 7461 2e0a 2020  ly have data..  
+0003bdb0: 2020 2020 2020 6e20 3a20 696e 740a 2020        n : int.  
+0003bdc0: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
+0003bdd0: 206f 6620 776f 726b 6572 7320 746f 2063   of workers to c
+0003bde0: 6c6f 7365 0a20 2020 2020 2020 206d 696e  lose.        min
+0003bdf0: 696d 756d 203a 2069 6e74 0a20 2020 2020  imum : int.     
+0003be00: 2020 2020 2020 204d 696e 696d 756d 206e         Minimum n
+0003be10: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
+0003be20: 2074 6f20 6b65 6570 2061 726f 756e 640a   to keep around.
+0003be30: 2020 2020 2020 2020 6b65 7920 3a20 4361          key : Ca
+0003be40: 6c6c 6162 6c65 2857 6f72 6b65 7253 7461  llable(WorkerSta
+0003be50: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
+0003be60: 416e 206f 7074 696f 6e61 6c20 6361 6c6c  An optional call
+0003be70: 6162 6c65 206d 6170 7069 6e67 2061 2057  able mapping a W
+0003be80: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
+0003be90: 7420 746f 2061 2067 726f 7570 0a20 2020  t to a group.   
+0003bea0: 2020 2020 2020 2020 2061 6666 696c 6961           affilia
+0003beb0: 7469 6f6e 2e20 4772 6f75 7073 2077 696c  tion. Groups wil
+0003bec0: 6c20 6265 2063 6c6f 7365 6420 746f 6765  l be closed toge
+0003bed0: 7468 6572 2e20 5468 6973 2069 7320 7573  ther. This is us
+0003bee0: 6566 756c 2077 6865 6e0a 2020 2020 2020  eful when.      
+0003bef0: 2020 2020 2020 636c 6f73 696e 6720 776f        closing wo
+0003bf00: 726b 6572 7320 6d75 7374 2062 6520 646f  rkers must be do
+0003bf10: 6e65 2063 6f6c 6c65 6374 6976 656c 792c  ne collectively,
+0003bf20: 2073 7563 6820 6173 2062 7920 686f 7374   such as by host
+0003bf30: 6e61 6d65 2e0a 2020 2020 2020 2020 7461  name..        ta
+0003bf40: 7267 6574 203a 2069 6e74 0a20 2020 2020  rget : int.     
+0003bf50: 2020 2020 2020 2054 6172 6765 7420 6e75         Target nu
+0003bf60: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
+0003bf70: 746f 2068 6176 6520 6166 7465 7220 7765  to have after we
+0003bf80: 2063 6c6f 7365 0a20 2020 2020 2020 2061   close.        a
+0003bf90: 7474 7269 6275 7465 203a 2073 7472 0a20  ttribute : str. 
+0003bfa0: 2020 2020 2020 2020 2020 2054 6865 2061             The a
+0003bfb0: 7474 7269 6275 7465 206f 6620 7468 6520  ttribute of the 
+0003bfc0: 576f 726b 6572 5374 6174 6520 6f62 6a65  WorkerState obje
+0003bfd0: 6374 2074 6f20 7265 7475 726e 2c20 6c69  ct to return, li
+0003bfe0: 6b65 2022 6164 6472 6573 7322 0a20 2020  ke "address".   
+0003bff0: 2020 2020 2020 2020 206f 7220 226e 616d           or "nam
+0003c000: 6522 2e20 2044 6566 6175 6c74 7320 746f  e".  Defaults to
+0003c010: 2022 6164 6472 6573 7322 2e0a 0a20 2020   "address"...   
+0003c020: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
+0003c030: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+0003c040: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
+0003c050: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
+0003c060: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
+0003c070: 5b27 7463 703a 2f2f 3139 322e 3136 382e  ['tcp://192.168.
+0003c080: 302e 313a 3132 3334 272c 2027 7463 703a  0.1:1234', 'tcp:
+0003c090: 2f2f 3139 322e 3136 382e 302e 323a 3132  //192.168.0.2:12
+0003c0a0: 3334 275d 0a0a 2020 2020 2020 2020 4772  34']..        Gr
+0003c0b0: 6f75 7020 776f 726b 6572 7320 6279 2068  oup workers by h
+0003c0c0: 6f73 746e 616d 6520 7072 696f 7220 746f  ostname prior to
+0003c0d0: 2063 6c6f 7369 6e67 0a0a 2020 2020 2020   closing..      
+0003c0e0: 2020 3e3e 3e20 7363 6865 6475 6c65 722e    >>> scheduler.
+0003c0f0: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
+0003c100: 286b 6579 3d6c 616d 6264 6120 7773 3a20  (key=lambda ws: 
+0003c110: 7773 2e68 6f73 7429 0a20 2020 2020 2020  ws.host).       
+0003c120: 205b 2774 6370 3a2f 2f31 3932 2e31 3638   ['tcp://192.168
+0003c130: 2e30 2e31 3a31 3233 3427 2c20 2774 6370  .0.1:1234', 'tcp
+0003c140: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a34  ://192.168.0.1:4
+0003c150: 3536 3727 5d0a 0a20 2020 2020 2020 2052  567']..        R
+0003c160: 656d 6f76 6520 7477 6f20 776f 726b 6572  emove two worker
+0003c170: 730a 0a20 2020 2020 2020 203e 3e3e 2073  s..        >>> s
+0003c180: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0003c190: 5f74 6f5f 636c 6f73 6528 6e3d 3229 0a0a  _to_close(n=2)..
+0003c1a0: 2020 2020 2020 2020 4b65 6570 2065 6e6f          Keep eno
+0003c1b0: 7567 6820 776f 726b 6572 7320 746f 2068  ugh workers to h
+0003c1c0: 6176 6520 7477 6963 6520 6173 206d 7563  ave twice as muc
+0003c1d0: 6820 6d65 6d6f 7279 2061 7320 7765 2077  h memory as we w
+0003c1e0: 6520 6e65 6564 2e0a 0a20 2020 2020 2020  e need...       
+0003c1f0: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
+0003c200: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003c210: 6d65 6d6f 7279 5f72 6174 696f 3d32 290a  memory_ratio=2).
+0003c220: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0003c230: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0003c240: 0a20 2020 2020 2020 2074 6f5f 636c 6f73  .        to_clos
+0003c250: 653a 206c 6973 7420 6f66 2077 6f72 6b65  e: list of worke
+0003c260: 7220 6164 6472 6573 7365 7320 7468 6174  r addresses that
+0003c270: 2061 7265 204f 4b20 746f 2063 6c6f 7365   are OK to close
+0003c280: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+0003c290: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+0003c2a0: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
+0003c2b0: 6475 6c65 722e 7265 7469 7265 5f77 6f72  duler.retire_wor
+0003c2c0: 6b65 7273 0a20 2020 2020 2020 2022 2222  kers.        """
+0003c2d0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
+0003c2e0: 6574 2069 7320 6e6f 7420 4e6f 6e65 2061  et is not None a
+0003c2f0: 6e64 206e 2069 7320 4e6f 6e65 3a0a 2020  nd n is None:.  
+0003c300: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
+0003c310: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+0003c320: 2d20 7461 7267 6574 0a20 2020 2020 2020  - target.       
+0003c330: 2069 6620 6e20 6973 206e 6f74 204e 6f6e   if n is not Non
+0003c340: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0003c350: 6620 6e20 3c20 303a 0a20 2020 2020 2020  f n < 0:.       
+0003c360: 2020 2020 2020 2020 206e 203d 2030 0a20           n = 0. 
+0003c370: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0003c380: 7420 3d20 6c65 6e28 7365 6c66 2e77 6f72  t = len(self.wor
+0003c390: 6b65 7273 2920 2d20 6e0a 0a20 2020 2020  kers) - n..     
+0003c3a0: 2020 2069 6620 6e20 6973 204e 6f6e 6520     if n is None 
+0003c3b0: 616e 6420 6d65 6d6f 7279 5f72 6174 696f  and memory_ratio
+0003c3c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003c3d0: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
+0003c3e0: 696f 203d 2032 0a0a 2020 2020 2020 2020  io = 2..        
+0003c3f0: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
+0003c400: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0003c410: 6620 6e6f 7420 6e20 616e 6420 616c 6c28  f not n and all(
+0003c420: 5b77 732e 7072 6f63 6573 7369 6e67 2066  [ws.processing f
+0003c430: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
+0003c440: 726b 6572 732e 7661 6c75 6573 2829 5d29  rkers.values()])
+0003c450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003c460: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
+0003c470: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+0003c480: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003c490: 2020 2020 2020 2020 206b 6579 203d 206f           key = o
+0003c4a0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+0003c4b0: 6572 2822 6164 6472 6573 7322 290a 2020  er("address").  
+0003c4c0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0003c4d0: 6e73 7461 6e63 6528 6b65 792c 2062 7974  nstance(key, byt
+0003c4e0: 6573 2920 616e 6420 6461 736b 2e63 6f6e  es) and dask.con
+0003c4f0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+0003c500: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
+0003c510: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0003c520: 7069 636b 6c65 220a 2020 2020 2020 2020  pickle".        
+0003c530: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0003c540: 2020 2020 2020 206b 6579 203d 2070 6963         key = pic
+0003c550: 6b6c 652e 6c6f 6164 7328 6b65 7929 0a0a  kle.loads(key)..
+0003c560: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0003c570: 7073 203d 2067 726f 7570 6279 286b 6579  ps = groupby(key
+0003c580: 2c20 7365 6c66 2e77 6f72 6b65 7273 2e76  , self.workers.v
+0003c590: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
+0003c5a0: 2020 2020 2020 6c69 6d69 745f 6279 7465        limit_byte
+0003c5b0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+0003c5c0: 2020 2020 2020 6b3a 2073 756d 2877 732e        k: sum(ws.
+0003c5d0: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
+0003c5e0: 2077 7320 696e 2076 2920 666f 7220 6b2c   ws in v) for k,
+0003c5f0: 2076 2069 6e20 6772 6f75 7073 2e69 7465   v in groups.ite
+0003c600: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
+0003c610: 207d 0a20 2020 2020 2020 2020 2020 2067   }.            g
+0003c620: 726f 7570 5f62 7974 6573 203d 207b 6b3a  roup_bytes = {k:
+0003c630: 2073 756d 2877 732e 6e62 7974 6573 2066   sum(ws.nbytes f
+0003c640: 6f72 2077 7320 696e 2076 2920 666f 7220  or ws in v) for 
+0003c650: 6b2c 2076 2069 6e20 6772 6f75 7073 2e69  k, v in groups.i
+0003c660: 7465 6d73 2829 7d0a 0a20 2020 2020 2020  tems()}..       
+0003c670: 2020 2020 206c 696d 6974 203d 2073 756d       limit = sum
+0003c680: 286c 696d 6974 5f62 7974 6573 2e76 616c  (limit_bytes.val
+0003c690: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+0003c6a0: 2020 2074 6f74 616c 203d 2073 756d 2867     total = sum(g
+0003c6b0: 726f 7570 5f62 7974 6573 2e76 616c 7565  roup_bytes.value
+0003c6c0: 7328 2929 0a0a 2020 2020 2020 2020 2020  s())..          
+0003c6d0: 2020 6465 6620 5f6b 6579 2867 726f 7570    def _key(group
+0003c6e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003c6f0: 2020 2069 735f 6964 6c65 203d 206e 6f74     is_idle = not
+0003c700: 2061 6e79 285b 7777 732e 7072 6f63 6573   any([wws.proces
+0003c710: 7369 6e67 2066 6f72 2077 7773 2069 6e20  sing for wws in 
+0003c720: 6772 6f75 7073 5b67 726f 7570 5d5d 290a  groups[group]]).
+0003c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c740: 6279 7465 7320 3d20 2d67 726f 7570 5f62  bytes = -group_b
+0003c750: 7974 6573 5b67 726f 7570 5d0a 2020 2020  ytes[group].    
+0003c760: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003c770: 726e 2069 735f 6964 6c65 2c20 6279 7465  rn is_idle, byte
+0003c780: 730a 0a20 2020 2020 2020 2020 2020 2069  s..            i
+0003c790: 646c 6520 3d20 736f 7274 6564 2867 726f  dle = sorted(gro
+0003c7a0: 7570 732c 206b 6579 3d5f 6b65 7929 0a0a  ups, key=_key)..
+0003c7b0: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
+0003c7c0: 6c6f 7365 203d 205b 5d0a 2020 2020 2020  lose = [].      
+0003c7d0: 2020 2020 2020 6e5f 7265 6d61 696e 203d        n_remain =
+0003c7e0: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+0003c7f0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0003c800: 7768 696c 6520 6964 6c65 3a0a 2020 2020  while idle:.    
+0003c810: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0003c820: 7020 3d20 6964 6c65 2e70 6f70 2829 0a20  p = idle.pop(). 
+0003c830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003c840: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
+0003c850: 616e 7928 5b77 732e 7072 6f63 6573 7369  any([ws.processi
+0003c860: 6e67 2066 6f72 2077 7320 696e 2067 726f  ng for ws in gro
+0003c870: 7570 735b 6772 6f75 705d 5d29 3a0a 2020  ups[group]]):.  
+0003c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c890: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0003c8a0: 2020 2020 2020 2020 2069 6620 6d69 6e69           if mini
+0003c8b0: 6d75 6d20 616e 6420 6e5f 7265 6d61 696e  mum and n_remain
+0003c8c0: 202d 206c 656e 2867 726f 7570 735b 6772   - len(groups[gr
+0003c8d0: 6f75 705d 2920 3c20 6d69 6e69 6d75 6d3a  oup]) < minimum:
+0003c8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003c8f0: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003c900: 2020 2020 2020 2020 2020 2020 6c69 6d69              limi
+0003c910: 7420 2d3d 206c 696d 6974 5f62 7974 6573  t -= limit_bytes
+0003c920: 5b67 726f 7570 5d0a 0a20 2020 2020 2020  [group]..       
+0003c930: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
+0003c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c950: 2020 6e20 6973 206e 6f74 204e 6f6e 6520    n is not None 
+0003c960: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
+0003c970: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
+0003c980: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
+0003c990: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0003c9a0: 2020 2029 206f 7220 286d 656d 6f72 795f     ) or (memory_
+0003c9b0: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
+0003c9c0: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
+0003c9d0: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
+0003c9e0: 7461 6c29 3a0a 2020 2020 2020 2020 2020  tal):.          
+0003c9f0: 2020 2020 2020 2020 2020 746f 5f63 6c6f            to_clo
+0003ca00: 7365 2e61 7070 656e 6428 6772 6f75 7029  se.append(group)
+0003ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ca20: 2020 2020 206e 5f72 656d 6169 6e20 2d3d       n_remain -=
+0003ca30: 206c 656e 2867 726f 7570 735b 6772 6f75   len(groups[grou
+0003ca40: 705d 290a 0a20 2020 2020 2020 2020 2020  p])..           
+0003ca50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003ca60: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003ca70: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
+0003ca80: 2020 7265 7375 6c74 203d 205b 6765 7461    result = [geta
+0003ca90: 7474 7228 7773 2c20 6174 7472 6962 7574  ttr(ws, attribut
+0003caa0: 6529 2066 6f72 2067 2069 6e20 746f 5f63  e) for g in to_c
+0003cab0: 6c6f 7365 2066 6f72 2077 7320 696e 2067  lose for ws in g
+0003cac0: 726f 7570 735b 675d 5d0a 2020 2020 2020  roups[g]].      
+0003cad0: 2020 2020 2020 6966 2072 6573 756c 743a        if result:
+0003cae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003caf0: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
+0003cb00: 7567 6765 7374 2063 6c6f 7369 6e67 2077  uggest closing w
+0003cb10: 6f72 6b65 7273 3a20 2573 222c 2072 6573  orkers: %s", res
+0003cb20: 756c 7429 0a0a 2020 2020 2020 2020 2020  ult)..          
+0003cb30: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+0003cb40: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0003cb50: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+0003cb60: 6574 6972 655f 776f 726b 6572 7328 0a20  etire_workers(. 
+0003cb70: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0003cb80: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
+0003cb90: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
+0003cba0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+0003cbb0: 2c0a 2020 2020 2020 2020 6e61 6d65 733a  ,.        names:
+0003cbc0: 206c 6973 7420 7c20 4e6f 6e65 203d 204e   list | None = N
+0003cbd0: 6f6e 652c 0a20 2020 2020 2020 2063 6c6f  one,.        clo
+0003cbe0: 7365 5f77 6f72 6b65 7273 3a20 626f 6f6c  se_workers: bool
+0003cbf0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+0003cc00: 2020 7265 6d6f 7665 3a20 626f 6f6c 203d    remove: bool =
+0003cc10: 2054 7275 652c 0a20 2020 2020 2020 2073   True,.        s
+0003cc20: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
+0003cc30: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003cc40: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+0003cc50: 2041 6e79 2c0a 2020 2020 2920 2d3e 2064   Any,.    ) -> d
+0003cc60: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0003cc70: 2020 2020 2020 2022 2222 4772 6163 6566         """Gracef
+0003cc80: 756c 6c79 2072 6574 6972 6520 776f 726b  ully retire work
+0003cc90: 6572 7320 6672 6f6d 2063 6c75 7374 6572  ers from cluster
+0003cca0: 2e20 416e 7920 6b65 7920 7468 6174 2069  . Any key that i
+0003ccb0: 7320 696e 206d 656d 6f72 7920 6578 636c  s in memory excl
+0003ccc0: 7573 6976 656c 790a 2020 2020 2020 2020  usively.        
+0003ccd0: 6f6e 2074 6865 2072 6574 6972 6564 2077  on the retired w
+0003cce0: 6f72 6b65 7273 2069 7320 7265 706c 6963  orkers is replic
+0003ccf0: 6174 6564 2073 6f6d 6577 6865 7265 2065  ated somewhere e
+0003cd00: 6c73 652e 0a0a 2020 2020 2020 2020 5061  lse...        Pa
+0003cd10: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+0003cd20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0003cd30: 2020 2020 776f 726b 6572 733a 206c 6973      workers: lis
+0003cd40: 745b 7374 725d 2028 6f70 7469 6f6e 616c  t[str] (optional
+0003cd50: 290a 2020 2020 2020 2020 2020 2020 4c69  ).            Li
+0003cd60: 7374 206f 6620 776f 726b 6572 2061 6464  st of worker add
+0003cd70: 7265 7373 6573 2074 6f20 7265 7469 7265  resses to retire
+0003cd80: 2e0a 2020 2020 2020 2020 6e61 6d65 733a  ..        names:
+0003cd90: 206c 6973 7420 286f 7074 696f 6e61 6c29   list (optional)
+0003cda0: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
+0003cdb0: 7420 6f66 2077 6f72 6b65 7220 6e61 6d65  t of worker name
+0003cdc0: 7320 746f 2072 6574 6972 652e 0a20 2020  s to retire..   
+0003cdd0: 2020 2020 2020 2020 204d 7574 7561 6c6c           Mutuall
+0003cde0: 7920 6578 636c 7573 6976 6520 7769 7468  y exclusive with
+0003cdf0: 2060 6077 6f72 6b65 7273 6060 2e0a 2020   ``workers``..  
+0003ce00: 2020 2020 2020 2020 2020 4966 206e 6569            If nei
+0003ce10: 7468 6572 2060 6077 6f72 6b65 7273 6060  ther ``workers``
+0003ce20: 206e 6f72 2060 606e 616d 6573 6060 2061   nor ``names`` a
+0003ce30: 7265 2070 726f 7669 6465 642c 2077 6520  re provided, we 
+0003ce40: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
+0003ce50: 2060 6077 6f72 6b65 7273 5f74 6f5f 636c   ``workers_to_cl
+0003ce60: 6f73 6560 6020 7768 6963 6820 6669 6e64  ose`` which find
+0003ce70: 7320 6120 676f 6f64 2073 6574 2e0a 2020  s a good set..  
+0003ce80: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
+0003ce90: 6572 733a 2062 6f6f 6c20 2864 6566 6175  ers: bool (defau
+0003cea0: 6c74 7320 746f 2046 616c 7365 290a 2020  lts to False).  
+0003ceb0: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
+0003cec0: 7220 6f72 206e 6f74 2074 6f20 6163 7475  r or not to actu
+0003ced0: 616c 6c79 2063 6c6f 7365 2074 6865 2077  ally close the w
+0003cee0: 6f72 6b65 7220 6578 706c 6963 6974 6c79  orker explicitly
+0003cef0: 2066 726f 6d20 6865 7265 2e0a 2020 2020   from here..    
+0003cf00: 2020 2020 2020 2020 4f74 6865 7277 6973          Otherwis
+0003cf10: 6520 7765 2065 7870 6563 7420 736f 6d65  e we expect some
+0003cf20: 2065 7874 6572 6e61 6c20 6a6f 6220 7363   external job sc
+0003cf30: 6865 6475 6c65 7220 746f 2066 696e 6973  heduler to finis
+0003cf40: 6820 6f66 6620 7468 650a 2020 2020 2020  h off the.      
+0003cf50: 2020 2020 2020 776f 726b 6572 2e0a 2020        worker..  
+0003cf60: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
+0003cf70: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
+0003cf80: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0003cf90: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
+0003cfa0: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
+0003cfb0: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
+0003cfc0: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
+0003cfd0: 7365 0a20 2020 2020 2020 2020 2020 2077  se.            w
+0003cfe0: 6169 7420 666f 7220 7468 6520 776f 726b  ait for the work
+0003cff0: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
+0003d000: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
+0003d010: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
+0003d020: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
+0003d030: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
+0003d040: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
+0003d050: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
+0003d060: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
+0003d070: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
+0003d080: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
+0003d090: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
+0003d0a0: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
+0003d0b0: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
+0003d0c0: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
+0003d0d0: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
+0003d0e0: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
+0003d0f0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+0003d100: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
+0003d110: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
+0003d120: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
+0003d130: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
+0003d140: 2020 2020 2020 2020 2020 2020 4966 2063              If c
+0003d150: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
+0003d160: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
+0003d170: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
+0003d180: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
+0003d190: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
+0003d1a0: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
+0003d1b0: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
+0003d1c0: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
+0003d1d0: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
+0003d1e0: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
+0003d1f0: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
+0003d200: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
+0003d210: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
+0003d220: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
+0003d230: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
+0003d240: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
+0003d250: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
+0003d260: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
+0003d270: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
+0003d280: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
+0003d290: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
+0003d2a0: 686f 756c 6420 6472 6f70 0a0a 2020 2020  hould drop..    
+0003d2b0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0003d2c0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0003d2d0: 2020 2020 4469 6374 696f 6e61 7279 206d      Dictionary m
+0003d2e0: 6170 7069 6e67 2077 6f72 6b65 7220 4944  apping worker ID
+0003d2f0: 2f61 6464 7265 7373 2074 6f20 6469 6374  /address to dict
+0003d300: 696f 6e61 7279 206f 6620 696e 666f 726d  ionary of inform
+0003d310: 6174 696f 6e20 6162 6f75 740a 2020 2020  ation about.    
+0003d320: 2020 2020 7468 6174 2077 6f72 6b65 7220      that worker 
+0003d330: 666f 7220 6561 6368 2072 6574 6972 6564  for each retired
+0003d340: 2077 6f72 6b65 722e 0a0a 2020 2020 2020   worker...      
+0003d350: 2020 4966 2074 6865 7265 2061 7265 206b    If there are k
+0003d360: 6579 7320 7468 6174 2065 7869 7374 2069  eys that exist i
+0003d370: 6e20 6d65 6d6f 7279 206f 6e6c 7920 6f6e  n memory only on
+0003d380: 2074 6865 2077 6f72 6b65 7273 2062 6569   the workers bei
+0003d390: 6e67 2072 6574 6972 6564 2061 6e64 2069  ng retired and i
+0003d3a0: 740a 2020 2020 2020 2020 7761 7320 696d  t.        was im
+0003d3b0: 706f 7373 6962 6c65 2074 6f20 7265 706c  possible to repl
+0003d3c0: 6963 6174 6520 7468 656d 2073 6f6d 6577  icate them somew
+0003d3d0: 6865 7265 2065 6c73 6520 2865 2e67 2e20  here else (e.g. 
+0003d3e0: 6265 6361 7573 6520 7468 6572 6520 6172  because there ar
+0003d3f0: 656e 2774 0a20 2020 2020 2020 2061 6e79  en't.        any
+0003d400: 206f 7468 6572 2072 756e 6e69 6e67 2077   other running w
+0003d410: 6f72 6b65 7273 292c 2074 6865 2077 6f72  orkers), the wor
+0003d420: 6b65 7273 2068 6f6c 6469 6e67 2073 7563  kers holding suc
+0003d430: 6820 6b65 7973 2077 6f6e 2774 2062 6520  h keys won't be 
+0003d440: 7265 7469 7265 6420 616e 640a 2020 2020  retired and.    
+0003d450: 2020 2020 776f 6e27 7420 6170 7065 6172      won't appear
+0003d460: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
+0003d470: 2064 6963 742e 0a0a 2020 2020 2020 2020   dict...        
+0003d480: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+0003d490: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0003d4a0: 2020 5363 6865 6475 6c65 722e 776f 726b    Scheduler.work
+0003d4b0: 6572 735f 746f 5f63 6c6f 7365 0a20 2020  ers_to_close.   
+0003d4c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003d4d0: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
+0003d4e0: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
+0003d4f0: 7265 7469 7265 2d77 6f72 6b65 7273 2d7b  retire-workers-{
+0003d500: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+0003d510: 2023 2054 6869 7320 6c6f 636b 206d 616b   # This lock mak
+0003d520: 6573 2072 6574 6972 655f 776f 726b 6572  es retire_worker
+0003d530: 732c 2072 6562 616c 616e 6365 2c20 616e  s, rebalance, an
+0003d540: 6420 7265 706c 6963 6174 6520 6d75 7475  d replicate mutu
+0003d550: 616c 6c79 0a20 2020 2020 2020 2023 2065  ally.        # e
+0003d560: 7863 6c75 7369 7665 2061 6e64 2077 696c  xclusive and wil
+0003d570: 6c20 6e6f 206c 6f6e 6765 7220 6265 206e  l no longer be n
+0003d580: 6563 6573 7361 7279 206f 6e63 6520 7265  ecessary once re
+0003d590: 6261 6c61 6e63 6520 616e 6420 7265 706c  balance and repl
+0003d5a0: 6963 6174 6520 6172 650a 2020 2020 2020  icate are.      
+0003d5b0: 2020 2320 6d69 6772 6174 6564 2074 6f20    # migrated to 
+0003d5c0: 7468 6520 4163 7469 7665 204d 656d 6f72  the Active Memor
+0003d5d0: 7920 4d61 6e61 6765 722e 0a20 2020 2020  y Manager..     
+0003d5e0: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
+0003d5f0: 696e 6369 6465 6e74 616c 6c79 2c20 6974  incidentally, it
+0003d600: 2061 6c73 6f20 7072 6576 656e 7473 206d   also prevents m
+0003d610: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
+0003d620: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
+0003d630: 2020 2020 2020 2020 2320 6672 6f6d 2072          # from r
+0003d640: 756e 6e69 6e67 2069 6e20 7061 7261 6c6c  unning in parall
+0003d650: 656c 202d 2074 6869 7320 6973 2075 6e6e  el - this is unn
+0003d660: 6563 6573 7361 7279 2e0a 2020 2020 2020  ecessary..      
+0003d670: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
+0003d680: 662e 5f6c 6f63 6b3a 0a20 2020 2020 2020  f._lock:.       
+0003d690: 2020 2020 2069 6620 6e61 6d65 7320 6973       if names is
+0003d6a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0003d6b0: 2020 2020 2020 2020 2020 2069 6620 776f             if wo
+0003d6c0: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+0003d6d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003d6e0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+0003d6f0: 6545 7272 6f72 2822 6e61 6d65 7320 616e  eError("names an
+0003d700: 6420 776f 726b 6572 7320 6172 6520 6d75  d workers are mu
+0003d710: 7475 616c 6c79 2065 7863 6c75 7369 7665  tually exclusive
+0003d720: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0003d730: 2020 2069 6620 6e61 6d65 733a 0a20 2020     if names:.   
+0003d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d750: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+0003d760: 7469 7265 2077 6f72 6b65 7220 6e61 6d65  tire worker name
+0003d770: 7320 2573 222c 206e 616d 6573 290a 2020  s %s", names).  
+0003d780: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d790: 5375 7070 6f72 7420 6361 7365 7320 7768  Support cases wh
+0003d7a0: 6572 6520 6e61 6d65 7320 6172 6520 7061  ere names are pa
+0003d7b0: 7373 6564 2074 6872 6f75 6768 2061 2043  ssed through a C
+0003d7c0: 4c49 2061 6e64 2062 6563 6f6d 650a 2020  LI and become.  
+0003d7d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d7e0: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
+0003d7f0: 2020 2020 2020 2020 6e61 6d65 735f 7365          names_se
+0003d800: 7420 3d20 7b73 7472 286e 616d 6529 2066  t = {str(name) f
+0003d810: 6f72 206e 616d 6520 696e 206e 616d 6573  or name in names
+0003d820: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003d830: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
+0003d840: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+0003d850: 7273 2e76 616c 7565 7328 2920 6966 2073  rs.values() if s
+0003d860: 7472 2877 732e 6e61 6d65 2920 696e 206e  tr(ws.name) in n
+0003d870: 616d 6573 5f73 6574 7d0a 2020 2020 2020  ames_set}.      
+0003d880: 2020 2020 2020 656c 6966 2077 6f72 6b65        elif worke
+0003d890: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
+0003d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d8b0: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
+0003d8c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003d8d0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
+0003d8e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0003d8f0: 2020 2020 2020 666f 7220 6164 6472 6573        for addres
+0003d900: 7320 696e 2077 6f72 6b65 7273 0a20 2020  s in workers.   
+0003d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d920: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
+0003d930: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
+0003d940: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0003d950: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0003d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d970: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
+0003d980: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003d990: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
+0003d9a0: 5d20 666f 7220 6164 6472 6573 7320 696e  ] for address in
+0003d9b0: 2073 656c 662e 776f 726b 6572 735f 746f   self.workers_to
+0003d9c0: 5f63 6c6f 7365 282a 2a6b 7761 7267 7329  _close(**kwargs)
+0003d9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d9e0: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
+0003d9f0: 6620 6e6f 7420 7773 733a 0a20 2020 2020  f not wss:.     
+0003da00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003da10: 6e20 7b7d 0a0a 2020 2020 2020 2020 2020  n {}..          
+0003da20: 2020 7374 6f70 5f61 6d6d 203d 2046 616c    stop_amm = Fal
+0003da30: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
+0003da40: 6d6d 3a20 4163 7469 7665 4d65 6d6f 7279  mm: ActiveMemory
+0003da50: 4d61 6e61 6765 7245 7874 656e 7369 6f6e  ManagerExtension
+0003da60: 207c 204e 6f6e 6520 3d20 7365 6c66 2e65   | None = self.e
+0003da70: 7874 656e 7369 6f6e 732e 6765 7428 2261  xtensions.get("a
+0003da80: 6d6d 2229 0a20 2020 2020 2020 2020 2020  mm").           
+0003da90: 2069 6620 6e6f 7420 616d 6d20 6f72 206e   if not amm or n
+0003daa0: 6f74 2061 6d6d 2e72 756e 6e69 6e67 3a0a  ot amm.running:.
+0003dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dac0: 616d 6d20 3d20 4163 7469 7665 4d65 6d6f  amm = ActiveMemo
+0003dad0: 7279 4d61 6e61 6765 7245 7874 656e 7369  ryManagerExtensi
+0003dae0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0003daf0: 2020 2020 2020 2020 7365 6c66 2c20 706f          self, po
+0003db00: 6c69 6369 6573 3d73 6574 2829 2c20 7265  licies=set(), re
+0003db10: 6769 7374 6572 3d46 616c 7365 2c20 7374  gister=False, st
+0003db20: 6172 743d 5472 7565 2c20 696e 7465 7276  art=True, interv
+0003db30: 616c 3d32 2e30 0a20 2020 2020 2020 2020  al=2.0.         
+0003db40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0003db50: 2020 2020 2020 2020 2073 746f 705f 616d           stop_am
+0003db60: 6d20 3d20 5472 7565 0a0a 2020 2020 2020  m = True..      
+0003db70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0003db80: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
+0003db90: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0003dba0: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0003dbb0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
+0003dbc0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0003dbd0: 696e 666f 2822 5265 7469 7269 6e67 2077  info("Retiring w
+0003dbe0: 6f72 6b65 7220 2573 222c 2077 732e 6164  orker %s", ws.ad
+0003dbf0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
+0003dc00: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
+0003dc10: 6379 203d 2052 6574 6972 6557 6f72 6b65  cy = RetireWorke
+0003dc20: 7228 7773 2e61 6464 7265 7373 290a 2020  r(ws.address).  
+0003dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dc40: 2020 616d 6d2e 6164 645f 706f 6c69 6379    amm.add_policy
+0003dc50: 2870 6f6c 6963 7929 0a0a 2020 2020 2020  (policy)..      
+0003dc60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003dc70: 4368 616e 6765 2057 6f72 6b65 722e 7374  Change Worker.st
+0003dc80: 6174 7573 2074 6f20 636c 6f73 696e 675f  atus to closing_
+0003dc90: 6772 6163 6566 756c 6c79 2e20 496d 6d65  gracefully. Imme
+0003dca0: 6469 6174 656c 7920 7365 740a 2020 2020  diately set.    
+0003dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dcc0: 2320 7468 6520 7361 6d65 206f 6e20 7468  # the same on th
+0003dcd0: 6520 7363 6865 6475 6c65 7220 746f 2070  e scheduler to p
+0003dce0: 7265 7665 6e74 2072 6163 6520 636f 6e64  revent race cond
+0003dcf0: 6974 696f 6e73 2e0a 2020 2020 2020 2020  itions..        
+0003dd00: 2020 2020 2020 2020 2020 2020 7072 6576              prev
+0003dd10: 5f73 7461 7475 7320 3d20 7773 2e73 7461  _status = ws.sta
+0003dd20: 7475 730a 2020 2020 2020 2020 2020 2020  tus.            
+0003dd30: 2020 2020 2020 2020 7365 6c66 2e68 616e          self.han
+0003dd40: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
+0003dd50: 735f 6368 616e 6765 280a 2020 2020 2020  s_change(.      
+0003dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dd70: 2020 5374 6174 7573 2e63 6c6f 7369 6e67    Status.closing
+0003dd80: 5f67 7261 6365 6675 6c6c 792c 2077 732c  _gracefully, ws,
+0003dd90: 2073 7469 6d75 6c75 735f 6964 0a20 2020   stimulus_id.   
+0003dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ddb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0003ddc0: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
+0003ddd0: 5765 2073 686f 756c 6420 7365 6e64 2061  We should send a
+0003dde0: 206d 6573 7361 6765 2074 6f20 7468 6520   message to the 
+0003ddf0: 6e61 6e6e 7920 6669 7273 743b 0a20 2020  nanny first;.   
+0003de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de10: 2023 2065 7665 6e74 7561 6c6c 7920 776f   # eventually wo
+0003de20: 726b 6572 7320 776f 6e27 7420 6265 2061  rkers won't be a
+0003de30: 626c 6520 746f 2063 6c6f 7365 2074 6865  ble to close the
+0003de40: 6972 206f 776e 206e 616e 6e69 6573 2e0a  ir own nannies..
+0003de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de60: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+0003de70: 636f 6d6d 735b 7773 2e61 6464 7265 7373  comms[ws.address
+0003de80: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
+0003de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dea0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003deb0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+0003dec0: 7022 3a20 2277 6f72 6b65 722d 7374 6174  p": "worker-stat
+0003ded0: 7573 2d63 6861 6e67 6522 2c0a 2020 2020  us-change",.    
+0003dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003def0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0003df00: 3a20 7773 2e73 7461 7475 732e 6e61 6d65  : ws.status.name
+0003df10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003df20: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0003df30: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0003df40: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0003df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003df60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003df70: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003df80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003df90: 6f72 6f73 2e61 7070 656e 6428 0a20 2020  oros.append(.   
+0003dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dfb0: 2020 2020 2073 656c 662e 5f74 7261 636b       self._track
+0003dfc0: 5f72 6574 6972 655f 776f 726b 6572 280a  _retire_worker(.
+0003dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dfe0: 2020 2020 2020 2020 2020 2020 7773 2c0a              ws,.
+0003dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e000: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
+0003e010: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
+0003e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e030: 7072 6576 5f73 7461 7475 733d 7072 6576  prev_status=prev
+0003e040: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
+0003e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e060: 2020 2020 2063 6c6f 7365 3d63 6c6f 7365       close=close
+0003e070: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
+0003e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e090: 2020 2020 2020 7265 6d6f 7665 3d72 656d        remove=rem
+0003e0a0: 6f76 652c 0a20 2020 2020 2020 2020 2020  ove,.           
+0003e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0c0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+0003e0d0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0003e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003e100: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003e110: 2020 2020 2020 2020 2020 2023 2047 6976             # Giv
+0003e120: 6520 7468 6520 414d 4d20 6120 6b69 636b  e the AMM a kick
+0003e130: 2c20 696e 2061 6464 6974 696f 6e20 746f  , in addition to
+0003e140: 2069 7473 2070 6572 696f 6469 6320 7275   its periodic ru
+0003e150: 6e6e 696e 672e 2054 6869 7320 6973 0a20  nning. This is. 
+0003e160: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003e170: 2074 6f20 6176 6f69 6420 756e 6e65 6365   to avoid unnece
+0003e180: 7373 6172 696c 7920 7761 6974 696e 6720  ssarily waiting 
+0003e190: 666f 7220 6120 706f 7465 6e74 6961 6c6c  for a potentiall
+0003e1a0: 7920 6172 6269 7472 6172 696c 7920 6c6f  y arbitrarily lo
+0003e1b0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0003e1c0: 2020 2023 2074 696d 6520 2864 6570 656e     # time (depen
+0003e1d0: 6469 6e67 206f 6e20 696e 7465 7276 616c  ding on interval
+0003e1e0: 2073 6574 7469 6e67 7329 0a20 2020 2020   settings).     
+0003e1f0: 2020 2020 2020 2020 2020 2061 6d6d 2e72             amm.r
+0003e200: 756e 5f6f 6e63 6528 290a 0a20 2020 2020  un_once()..     
+0003e210: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0003e220: 7273 5f69 6e66 6f20 3d20 6469 6374 2861  rs_info = dict(a
+0003e230: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+0003e240: 6865 7228 2a63 6f72 6f73 2929 0a20 2020  her(*coros)).   
+0003e250: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0003e260: 6b65 7273 5f69 6e66 6f2e 706f 7028 4e6f  kers_info.pop(No
+0003e270: 6e65 2c20 4e6f 6e65 290a 2020 2020 2020  ne, None).      
+0003e280: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+0003e290: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003e2a0: 6620 7374 6f70 5f61 6d6d 3a0a 2020 2020  f stop_amm:.    
+0003e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e2c0: 616d 6d2e 7374 6f70 2829 0a0a 2020 2020  amm.stop()..    
+0003e2d0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0003e2e0: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
+0003e2f0: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
+0003e300: 6b65 7273 222c 2022 776f 726b 6572 7322  kers", "workers"
+0003e310: 3a20 776f 726b 6572 735f 696e 666f 7d29  : workers_info})
+0003e320: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0003e330: 675f 6576 656e 7428 6c69 7374 2877 6f72  g_event(list(wor
+0003e340: 6b65 7273 5f69 6e66 6f29 2c20 7b22 6163  kers_info), {"ac
+0003e350: 7469 6f6e 223a 2022 7265 7469 7265 6422  tion": "retired"
+0003e360: 7d29 0a0a 2020 2020 2020 2020 7265 7475  })..        retu
+0003e370: 726e 2077 6f72 6b65 7273 5f69 6e66 6f0a  rn workers_info.
+0003e380: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+0003e390: 7472 6163 6b5f 7265 7469 7265 5f77 6f72  track_retire_wor
+0003e3a0: 6b65 7228 0a20 2020 2020 2020 2073 656c  ker(.        sel
+0003e3b0: 662c 0a20 2020 2020 2020 2077 733a 2057  f,.        ws: W
+0003e3c0: 6f72 6b65 7253 7461 7465 2c0a 2020 2020  orkerState,.    
+0003e3d0: 2020 2020 706f 6c69 6379 3a20 5265 7469      policy: Reti
+0003e3e0: 7265 576f 726b 6572 2c0a 2020 2020 2020  reWorker,.      
+0003e3f0: 2020 7072 6576 5f73 7461 7475 733a 2053    prev_status: S
+0003e400: 7461 7475 732c 0a20 2020 2020 2020 2063  tatus,.        c
+0003e410: 6c6f 7365 3a20 626f 6f6c 2c0a 2020 2020  lose: bool,.    
+0003e420: 2020 2020 7265 6d6f 7665 3a20 626f 6f6c      remove: bool
+0003e430: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+0003e440: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+0003e450: 2920 2d3e 2074 7570 6c65 3a20 2023 2074  ) -> tuple:  # t
+0003e460: 7570 6c65 5b73 7472 207c 204e 6f6e 652c  uple[str | None,
+0003e470: 2064 6963 745d 0a20 2020 2020 2020 2077   dict].        w
+0003e480: 6869 6c65 206e 6f74 2070 6f6c 6963 792e  hile not policy.
+0003e490: 646f 6e65 2829 3a0a 2020 2020 2020 2020  done():.        
+0003e4a0: 2020 2020 2320 536c 6565 7020 302e 3031      # Sleep 0.01
+0003e4b0: 7320 7768 656e 2074 6865 7265 2061 7265  s when there are
+0003e4c0: 2034 2074 6173 6b73 206f 7220 6c65 7373   4 tasks or less
+0003e4d0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0003e4e0: 6c65 6570 2030 2e35 7320 7768 656e 2074  leep 0.5s when t
+0003e4f0: 6865 7265 2061 7265 2032 3030 206f 7220  here are 200 or 
+0003e500: 6d6f 7265 0a20 2020 2020 2020 2020 2020  more.           
+0003e510: 2070 6f6c 6c5f 696e 7465 7276 616c 203d   poll_interval =
+0003e520: 206d 6178 2830 2e30 312c 206d 696e 2830   max(0.01, min(0
+0003e530: 2e35 2c20 6c65 6e28 7773 2e68 6173 5f77  .5, len(ws.has_w
+0003e540: 6861 7429 202f 2034 3030 2929 0a20 2020  hat) / 400)).   
+0003e550: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+0003e560: 7379 6e63 696f 2e73 6c65 6570 2870 6f6c  syncio.sleep(pol
+0003e570: 6c5f 696e 7465 7276 616c 290a 0a20 2020  l_interval)..   
+0003e580: 2020 2020 2069 6620 706f 6c69 6379 2e6e       if policy.n
+0003e590: 6f5f 7265 6369 7069 656e 7473 3a0a 2020  o_recipients:.  
+0003e5a0: 2020 2020 2020 2020 2020 2320 4162 6f72            # Abor
+0003e5b0: 7420 7265 7469 7265 6d65 6e74 2e20 5468  t retirement. Th
+0003e5c0: 6973 2074 696d 6520 7765 2064 6f6e 2774  is time we don't
+0003e5d0: 206e 6565 6420 746f 2077 6f72 7279 2061   need to worry a
+0003e5e0: 626f 7574 2072 6163 650a 2020 2020 2020  bout race.      
+0003e5f0: 2020 2020 2020 2320 636f 6e64 6974 696f        # conditio
+0003e600: 6e73 2061 6e64 2077 6520 6361 6e20 7761  ns and we can wa
+0003e610: 6974 2066 6f72 2061 2073 6368 6564 756c  it for a schedul
+0003e620: 6572 2d3e 776f 726b 6572 2d3e 7363 6865  er->worker->sche
+0003e630: 6475 6c65 720a 2020 2020 2020 2020 2020  duler.          
+0003e640: 2020 2320 726f 756e 642d 7472 6970 2e0a    # round-trip..
+0003e650: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003e660: 2e73 7472 6561 6d5f 636f 6d6d 735b 7773  .stream_comms[ws
+0003e670: 2e61 6464 7265 7373 5d2e 7365 6e64 280a  .address].send(.
+0003e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e690: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003e6a0: 2020 2020 2020 226f 7022 3a20 2277 6f72        "op": "wor
+0003e6b0: 6b65 722d 7374 6174 7573 2d63 6861 6e67  ker-status-chang
+0003e6c0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0003e6d0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0003e6e0: 3a20 7072 6576 5f73 7461 7475 732e 6e61  : prev_status.na
+0003e6f0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0003e700: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0003e710: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+0003e720: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0003e730: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0003e740: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003e750: 7265 7475 726e 204e 6f6e 652c 207b 7d0a  return None, {}.
+0003e760: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0003e770: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0003e780: 2020 2022 416c 6c20 756e 6971 7565 206b     "All unique k
+0003e790: 6579 7320 6f6e 2077 6f72 6b65 7220 2573  eys on worker %s
+0003e7a0: 2068 6176 6520 6265 656e 2072 6570 6c69   have been repli
+0003e7b0: 6361 7465 6420 656c 7365 7768 6572 6522  cated elsewhere"
+0003e7c0: 2c20 7773 2e61 6464 7265 7373 0a20 2020  , ws.address.   
+0003e7d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0003e7e0: 6966 2072 656d 6f76 653a 0a20 2020 2020  if remove:.     
+0003e7f0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+0003e800: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
+0003e810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e820: 2077 732e 6164 6472 6573 732c 2073 6166   ws.address, saf
+0003e830: 653d 5472 7565 2c20 636c 6f73 653d 636c  e=True, close=cl
+0003e840: 6f73 652c 2073 7469 6d75 6c75 735f 6964  ose, stimulus_id
+0003e850: 3d73 7469 6d75 6c75 735f 6964 0a20 2020  =stimulus_id.   
+0003e860: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003e870: 2020 2065 6c69 6620 636c 6f73 653a 0a20     elif close:. 
+0003e880: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e890: 636c 6f73 655f 776f 726b 6572 2877 732e  close_worker(ws.
+0003e8a0: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
+0003e8b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
+0003e8c0: 6574 6972 6564 2077 6f72 6b65 7220 2573  etired worker %s
+0003e8d0: 222c 2077 732e 6164 6472 6573 7329 0a20  ", ws.address). 
+0003e8e0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+0003e8f0: 2e61 6464 7265 7373 2c20 7773 2e69 6465  .address, ws.ide
+0003e900: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
+0003e910: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
+0003e920: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
+0003e930: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
+0003e940: 6563 7469 6f6e 5b73 7472 5d20 3d20 2829  ection[str] = ()
+0003e950: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0003e960: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+0003e970: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
+0003e980: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
+0003e990: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
+0003e9a0: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
+0003e9b0: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
+0003e9c0: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
+0003e9d0: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
+0003e9e0: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
+0003e9f0: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
+0003ea00: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
+0003ea10: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
+0003ea20: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
+0003ea30: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
+0003ea40: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
+0003ea50: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
+0003ea60: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003ea70: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
+0003ea80: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
+0003ea90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003eaa0: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
+0003eab0: 2020 2020 2020 2020 7773 3a20 576f 726b          ws: Work
+0003eac0: 6572 5374 6174 6520 3d20 7365 6c66 2e77  erState = self.w
+0003ead0: 6f72 6b65 7273 5b77 6f72 6b65 725d 0a20  orkers[worker]. 
+0003eae0: 2020 2020 2020 2072 6564 756e 6461 6e74         redundant
+0003eaf0: 5f72 6570 6c69 6361 7320 3d20 5b5d 0a20  _replicas = []. 
+0003eb00: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0003eb10: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0003eb20: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0003eb30: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0003eb40: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+0003eb50: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
+0003eb60: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+0003eb70: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
+0003eb80: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
+0003eb90: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0003eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ebb0: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
+0003ebc0: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0003ebd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003ebe0: 2020 2020 2020 2020 2020 2020 2072 6564               red
+0003ebf0: 756e 6461 6e74 5f72 6570 6c69 6361 732e  undant_replicas.
+0003ec00: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
+0003ec10: 2020 2020 2069 6620 7265 6475 6e64 616e       if redundan
+0003ec20: 745f 7265 706c 6963 6173 3a0a 2020 2020  t_replicas:.    
+0003ec30: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0003ec40: 7469 6d75 6c75 735f 6964 3a0a 2020 2020  timulus_id:.    
+0003ec50: 2020 2020 2020 2020 2020 2020 7374 696d              stim
+0003ec60: 756c 7573 5f69 6420 3d20 6622 7265 6475  ulus_id = f"redu
+0003ec70: 6e64 616e 742d 7265 706c 6963 6173 2d7b  ndant-replicas-{
+0003ec80: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+0003ec90: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
+0003eca0: 5f73 656e 6428 0a20 2020 2020 2020 2020  _send(.         
+0003ecb0: 2020 2020 2020 2077 6f72 6b65 722c 0a20         worker,. 
+0003ecc0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0003ecd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ece0: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
+0003ecf0: 7665 2d72 6570 6c69 6361 7322 2c0a 2020  ve-replicas",.  
+0003ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed10: 2020 226b 6579 7322 3a20 7265 6475 6e64    "keys": redund
+0003ed20: 616e 745f 7265 706c 6963 6173 2c0a 2020  ant_replicas,.  
+0003ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed40: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0003ed50: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0003ed60: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+0003ed70: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0003ed80: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+0003ed90: 4f4b 220a 0a20 2020 2040 6c6f 675f 6572  OK"..    @log_er
+0003eda0: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
+0003edb0: 6174 655f 6461 7461 280a 2020 2020 2020  ate_data(.      
+0003edc0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0003edd0: 2a2c 0a20 2020 2020 2020 2077 686f 5f68  *,.        who_h
+0003ede0: 6173 3a20 6469 6374 5b73 7472 2c20 6c69  as: dict[str, li
+0003edf0: 7374 5b73 7472 5d5d 2c0a 2020 2020 2020  st[str]],.      
+0003ee00: 2020 6e62 7974 6573 3a20 6469 6374 5b73    nbytes: dict[s
+0003ee10: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
+0003ee20: 2020 636c 6965 6e74 3a20 7374 7220 7c20    client: str | 
+0003ee30: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0003ee40: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0003ee50: 2020 2020 2222 224c 6561 726e 2074 6861      """Learn tha
+0003ee60: 7420 6e65 7720 6461 7461 2068 6173 2065  t new data has e
+0003ee70: 6e74 6572 6564 2074 6865 206e 6574 776f  ntered the netwo
+0003ee80: 726b 2066 726f 6d20 616e 2065 7874 6572  rk from an exter
+0003ee90: 6e61 6c20 736f 7572 6365 2222 220a 2020  nal source""".  
+0003eea0: 2020 2020 2020 7768 6f5f 6861 7320 3d20        who_has = 
+0003eeb0: 7b6b 3a20 5b73 656c 662e 636f 6572 6365  {k: [self.coerce
+0003eec0: 5f61 6464 7265 7373 2876 7629 2066 6f72  _address(vv) for
+0003eed0: 2076 7620 696e 2076 5d20 666f 7220 6b2c   vv in v] for k,
+0003eee0: 2076 2069 6e20 7768 6f5f 6861 732e 6974   v in who_has.it
+0003eef0: 656d 7328 297d 0a20 2020 2020 2020 206c  ems()}.        l
+0003ef00: 6f67 6765 722e 6465 6275 6728 2255 7064  ogger.debug("Upd
+0003ef10: 6174 6520 6461 7461 2025 7322 2c20 7768  ate data %s", wh
+0003ef20: 6f5f 6861 7329 0a0a 2020 2020 2020 2020  o_has)..        
+0003ef30: 666f 7220 6b65 792c 2077 6f72 6b65 7273  for key, workers
+0003ef40: 2069 6e20 7768 6f5f 6861 732e 6974 656d   in who_has.item
+0003ef50: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0003ef60: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+0003ef70: 2e67 6574 286b 6579 290a 2020 2020 2020  .get(key).      
+0003ef80: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0003ef90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003efa0: 2020 2020 2074 7320 3d20 7365 6c66 2e6e       ts = self.n
+0003efb0: 6577 5f74 6173 6b28 6b65 792c 204e 6f6e  ew_task(key, Non
+0003efc0: 652c 2022 6d65 6d6f 7279 2229 0a20 2020  e, "memory").   
+0003efd0: 2020 2020 2020 2020 2074 732e 7374 6174           ts.stat
+0003efe0: 6520 3d20 226d 656d 6f72 7922 0a20 2020  e = "memory".   
+0003eff0: 2020 2020 2020 2020 2074 735f 6e62 7974           ts_nbyt
+0003f000: 6573 203d 206e 6279 7465 732e 6765 7428  es = nbytes.get(
+0003f010: 6b65 792c 202d 3129 0a20 2020 2020 2020  key, -1).       
+0003f020: 2020 2020 2069 6620 7473 5f6e 6279 7465       if ts_nbyte
+0003f030: 7320 3e3d 2030 3a0a 2020 2020 2020 2020  s >= 0:.        
+0003f040: 2020 2020 2020 2020 7473 2e73 6574 5f6e          ts.set_n
+0003f050: 6279 7465 7328 7473 5f6e 6279 7465 7329  bytes(ts_nbytes)
+0003f060: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0003f070: 7220 7720 696e 2077 6f72 6b65 7273 3a0a  r w in workers:.
+0003f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f090: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+0003f0a0: 735b 775d 0a20 2020 2020 2020 2020 2020  s[w].           
+0003f0b0: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
+0003f0c0: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0003f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f0e0: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
+0003f0f0: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0003f100: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
+0003f110: 7274 287b 226f 7022 3a20 226b 6579 2d69  rt({"op": "key-i
+0003f120: 6e2d 6d65 6d6f 7279 222c 2022 6b65 7922  n-memory", "key"
+0003f130: 3a20 6b65 792c 2022 776f 726b 6572 7322  : key, "workers"
+0003f140: 3a20 6c69 7374 2877 6f72 6b65 7273 297d  : list(workers)}
+0003f150: 290a 0a20 2020 2020 2020 2069 6620 636c  )..        if cl
+0003f160: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
+0003f170: 2020 7365 6c66 2e63 6c69 656e 745f 6465    self.client_de
+0003f180: 7369 7265 735f 6b65 7973 286b 6579 733d  sires_keys(keys=
+0003f190: 6c69 7374 2877 686f 5f68 6173 292c 2063  list(who_has), c
+0003f1a0: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+0003f1b0: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
+0003f1c0: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
+0003f1d0: 6579 2873 656c 662c 206b 6579 3a20 7374  ey(self, key: st
+0003f1e0: 722c 202a 2c20 636c 6965 6e74 3a20 7374  r, *, client: st
+0003f1f0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 6529  r | None = None)
+0003f200: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0003f210: 2020 2e2e 2e0a 0a20 2020 2040 6f76 6572    .....    @over
+0003f220: 6c6f 6164 0a20 2020 2064 6566 2072 6570  load.    def rep
+0003f230: 6f72 745f 6f6e 5f6b 6579 2873 656c 662c  ort_on_key(self,
+0003f240: 202a 2c20 7473 3a20 5461 736b 5374 6174   *, ts: TaskStat
+0003f250: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
+0003f260: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
+0003f270: 204e 6f6e 653a 0a20 2020 2020 2020 202e   None:.        .
+0003f280: 2e2e 0a0a 2020 2020 6465 6620 7265 706f  ....    def repo
+0003f290: 7274 5f6f 6e5f 6b65 7928 7365 6c66 2c20  rt_on_key(self, 
+0003f2a0: 6b65 793d 4e6f 6e65 2c20 2a2c 2074 733d  key=None, *, ts=
+0003f2b0: 4e6f 6e65 2c20 636c 6965 6e74 3d4e 6f6e  None, client=Non
+0003f2c0: 6529 3a0a 2020 2020 2020 2020 6966 2028  e):.        if (
+0003f2d0: 7473 2069 7320 4e6f 6e65 2920 3d3d 2028  ts is None) == (
+0003f2e0: 6b65 7920 6973 204e 6f6e 6529 3a0a 2020  key is None):.  
+0003f2f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003f300: 5661 6c75 6545 7272 6f72 2820 2023 2070  ValueError(  # p
+0003f310: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
+0003f320: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003f330: 2274 7320 616e 6420 6b65 7920 6172 6520  "ts and key are 
+0003f340: 6d75 7475 616c 6c79 2065 7863 6c75 7369  mutually exclusi
+0003f350: 7665 3b20 7265 6365 6976 6564 207b 6b65  ve; received {ke
+0003f360: 793d 2172 7d2c 207b 7473 3d21 727d 220a  y=!r}, {ts=!r}".
+0003f370: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0003f380: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0003f390: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003f3a0: 2061 7373 6572 7420 6b65 7920 6973 206e   assert key is n
+0003f3b0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+0003f3c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0003f3d0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0003f3e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003f3f0: 2020 2020 2020 206b 6579 203d 2074 732e         key = ts.
+0003f400: 6b65 790a 0a20 2020 2020 2020 2069 6620  key..        if 
+0003f410: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
+0003f420: 2020 2020 2020 2020 2020 2020 7265 706f              repo
+0003f430: 7274 5f6d 7367 203d 205f 7461 736b 5f74  rt_msg = _task_t
+0003f440: 6f5f 7265 706f 7274 5f6d 7367 2874 7329  o_report_msg(ts)
+0003f450: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0003f460: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
+0003f470: 745f 6d73 6720 3d20 7b22 6f70 223a 2022  t_msg = {"op": "
+0003f480: 6361 6e63 656c 6c65 642d 6b65 7973 222c  cancelled-keys",
+0003f490: 2022 6b65 7973 223a 205b 6b65 795d 7d0a   "keys": [key]}.
+0003f4a0: 2020 2020 2020 2020 6966 2072 6570 6f72          if repor
+0003f4b0: 745f 6d73 6720 6973 206e 6f74 204e 6f6e  t_msg is not Non
+0003f4c0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0003f4d0: 656c 662e 7265 706f 7274 2872 6570 6f72  elf.report(repor
+0003f4e0: 745f 6d73 672c 2074 733d 7473 2c20 636c  t_msg, ts=ts, cl
+0003f4f0: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+0003f500: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+0003f510: 2020 6173 796e 6320 6465 6620 6665 6564    async def feed
+0003f520: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0003f530: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
+0003f540: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
+0003f550: 7469 6f6e 3a20 6279 7465 7320 7c20 4e6f  tion: bytes | No
+0003f560: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003f570: 2020 2073 6574 7570 3a20 6279 7465 7320     setup: bytes 
+0003f580: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003f590: 2020 2020 2020 2074 6561 7264 6f77 6e3a         teardown:
+0003f5a0: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
+0003f5b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 696e  None,.        in
+0003f5c0: 7465 7276 616c 3a20 7374 7220 7c20 666c  terval: str | fl
+0003f5d0: 6f61 7420 3d20 2231 7322 2c0a 2020 2020  oat = "1s",.    
+0003f5e0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+0003f5f0: 792c 0a20 2020 2029 202d 3e20 4e6f 6e65  y,.    ) -> None
+0003f600: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0003f610: 2020 2020 2020 5072 6f76 6964 6573 2061        Provides a
+0003f620: 2064 6174 6120 436f 6d6d 2074 6f20 6578   data Comm to ex
+0003f630: 7465 726e 616c 2072 6571 7565 7374 6572  ternal requester
+0003f640: 0a0a 2020 2020 2020 2020 4361 7574 696f  ..        Cautio
+0003f650: 6e3a 2074 6869 7320 7275 6e73 2061 7262  n: this runs arb
+0003f660: 6974 7261 7279 2050 7974 686f 6e20 636f  itrary Python co
+0003f670: 6465 206f 6e20 7468 6520 7363 6865 6475  de on the schedu
+0003f680: 6c65 722e 2020 5468 6973 2073 686f 756c  ler.  This shoul
+0003f690: 640a 2020 2020 2020 2020 6576 656e 7475  d.        eventu
+0003f6a0: 616c 6c79 2062 6520 7068 6173 6564 206f  ally be phased o
+0003f6b0: 7574 2e20 2049 7420 6973 206d 6f73 746c  ut.  It is mostl
+0003f6c0: 7920 7573 6564 2062 7920 6469 6167 6e6f  y used by diagno
+0003f6d0: 7374 6963 732e 0a20 2020 2020 2020 2022  stics..        "
+0003f6e0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0003f6f0: 7420 6461 736b 2e63 6f6e 6669 672e 6765  t dask.config.ge
+0003f700: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0003f710: 6368 6564 756c 6572 2e70 6963 6b6c 6522  cheduler.pickle"
+0003f720: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+0003f730: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+0003f740: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003f750: 5472 6965 6420 746f 2063 616c 6c20 2766  Tried to call 'f
+0003f760: 6565 6427 2072 6f75 7465 2077 6974 6820  eed' route with 
+0003f770: 6375 7374 6f6d 2066 756e 6374 696f 6e73  custom functions
+0003f780: 2c20 6275 7420 220a 2020 2020 2020 2020  , but ".        
+0003f790: 2020 2020 2020 2020 2270 6963 6b6c 6520          "pickle 
+0003f7a0: 6973 2064 6973 616c 6c6f 7765 642e 2020  is disallowed.  
+0003f7b0: 5365 7420 7468 6520 2764 6973 7472 6962  Set the 'distrib
+0003f7c0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0003f7d0: 6963 6b6c 6527 220a 2020 2020 2020 2020  ickle'".        
+0003f7e0: 2020 2020 2020 2020 2263 6f6e 6669 6720          "config 
+0003f7f0: 7661 6c75 6520 746f 2054 7275 6520 746f  value to True to
+0003f800: 2075 7365 2074 6865 2027 6665 6564 2720   use the 'feed' 
+0003f810: 726f 7574 6520 2874 6869 7320 6973 206d  route (this is m
+0003f820: 6f73 746c 7920 220a 2020 2020 2020 2020  ostly ".        
+0003f830: 2020 2020 2020 2020 2263 6f6d 6d6f 6e6c          "commonl
+0003f840: 7920 7573 6564 2077 6974 6820 7072 6f67  y used with prog
+0003f850: 7265 7373 2062 6172 7329 220a 2020 2020  ress bars)".    
+0003f860: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0003f870: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0003f880: 2020 2020 2020 696e 7465 7276 616c 203d        interval =
+0003f890: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+0003f8a0: 2869 6e74 6572 7661 6c29 0a20 2020 2020  (interval).     
+0003f8b0: 2020 2069 6620 6675 6e63 7469 6f6e 3a0a     if function:.
+0003f8c0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+0003f8d0: 7469 6f6e 203d 2070 6963 6b6c 652e 6c6f  tion = pickle.lo
+0003f8e0: 6164 7328 6675 6e63 7469 6f6e 290a 2020  ads(function).  
+0003f8f0: 2020 2020 2020 6966 2073 6574 7570 3a0a        if setup:.
+0003f900: 2020 2020 2020 2020 2020 2020 7365 7475              setu
+0003f910: 7020 3d20 7069 636b 6c65 2e6c 6f61 6473  p = pickle.loads
+0003f920: 2873 6574 7570 290a 0a20 2020 2020 2020  (setup)..       
+0003f930: 2069 6620 7465 6172 646f 776e 3a0a 2020   if teardown:.  
+0003f940: 2020 2020 2020 2020 2020 7465 6172 646f            teardo
+0003f950: 776e 203d 2070 6963 6b6c 652e 6c6f 6164  wn = pickle.load
+0003f960: 7328 7465 6172 646f 776e 290a 2020 2020  s(teardown).    
+0003f970: 2020 2020 7374 6174 6520 3d20 7365 7475      state = setu
+0003f980: 7028 7365 6c66 2920 6966 2073 6574 7570  p(self) if setup
+0003f990: 2065 6c73 6520 4e6f 6e65 2020 2320 7479   else None  # ty
+0003f9a0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+0003f9b0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
+0003f9c0: 6177 6169 7461 626c 6528 7374 6174 6529  awaitable(state)
+0003f9d0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0003f9e0: 6174 6520 3d20 6177 6169 7420 7374 6174  ate = await stat
+0003f9f0: 650a 2020 2020 2020 2020 7472 793a 0a20  e.        try:. 
+0003fa00: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+0003fa10: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
+0003fa20: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+0003fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fa40: 6966 2073 7461 7465 2069 7320 4e6f 6e65  if state is None
+0003fa50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003fa60: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+0003fa70: 2066 756e 6374 696f 6e28 7365 6c66 2920   function(self) 
+0003fa80: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+0003fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003faa0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003fab0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0003fac0: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
+0003fad0: 6c66 2c20 7374 6174 6529 2020 2320 7479  lf, state)  # ty
+0003fae0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+0003faf0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0003fb00: 2063 6f6d 6d2e 7772 6974 6528 7265 7370   comm.write(resp
+0003fb10: 6f6e 7365 290a 2020 2020 2020 2020 2020  onse).          
+0003fb20: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+0003fb30: 6369 6f2e 736c 6565 7028 696e 7465 7276  cio.sleep(interv
+0003fb40: 616c 290a 2020 2020 2020 2020 6578 6365  al).        exce
+0003fb50: 7074 204f 5345 7272 6f72 3a0a 2020 2020  pt OSError:.    
+0003fb60: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+0003fb70: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
+0003fb80: 2020 2020 2020 2020 2020 6966 2074 6561            if tea
+0003fb90: 7264 6f77 6e3a 0a20 2020 2020 2020 2020  rdown:.         
+0003fba0: 2020 2020 2020 2074 6561 7264 6f77 6e28         teardown(
+0003fbb0: 7365 6c66 2c20 7374 6174 6529 2020 2320  self, state)  # 
+0003fbc0: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
+0003fbd0: 2020 6465 6620 6c6f 675f 776f 726b 6572    def log_worker
+0003fbe0: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+0003fbf0: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
+0003fc00: 722c 2074 6f70 6963 3a20 7374 7220 7c20  r, topic: str | 
+0003fc10: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
+0003fc20: 206d 7367 3a20 416e 790a 2020 2020 2920   msg: Any.    ) 
+0003fc30: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0003fc40: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+0003fc50: 7367 2c20 6469 6374 293a 0a20 2020 2020  sg, dict):.     
+0003fc60: 2020 2020 2020 206d 7367 5b22 776f 726b         msg["work
+0003fc70: 6572 225d 203d 2077 6f72 6b65 720a 2020  er"] = worker.  
+0003fc80: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+0003fc90: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
+0003fca0: 0a0a 2020 2020 6465 6620 7375 6273 6372  ..    def subscr
+0003fcb0: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
+0003fcc0: 7328 7365 6c66 2c20 636f 6d6d 3a20 436f  s(self, comm: Co
+0003fcd0: 6d6d 2920 2d3e 2073 7472 3a0a 2020 2020  mm) -> str:.    
+0003fce0: 2020 2020 576f 726b 6572 5374 6174 7573      WorkerStatus
+0003fcf0: 506c 7567 696e 2873 656c 662c 2063 6f6d  Plugin(self, com
+0003fd00: 6d29 0a20 2020 2020 2020 2069 6465 6e74  m).        ident
+0003fd10: 203d 2073 656c 662e 6964 656e 7469 7479   = self.identity
+0003fd20: 2829 0a20 2020 2020 2020 2066 6f72 2076  ().        for v
+0003fd30: 2069 6e20 6964 656e 745b 2277 6f72 6b65   in ident["worke
+0003fd40: 7273 225d 2e76 616c 7565 7328 293a 0a20  rs"].values():. 
+0003fd50: 2020 2020 2020 2020 2020 2064 656c 2076             del v
+0003fd60: 5b22 6d65 7472 6963 7322 5d0a 2020 2020  ["metrics"].    
+0003fd70: 2020 2020 2020 2020 6465 6c20 765b 226c          del v["l
+0003fd80: 6173 745f 7365 656e 225d 0a20 2020 2020  ast_seen"].     
+0003fd90: 2020 2072 6574 7572 6e20 6964 656e 740a     return ident.
+0003fda0: 0a20 2020 2064 6566 2067 6574 5f70 726f  .    def get_pro
+0003fdb0: 6365 7373 696e 6728 0a20 2020 2020 2020  cessing(.       
+0003fdc0: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
+0003fdd0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+0003fde0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+0003fdf0: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
+0003fe00: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
+0003fe10: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+0003fe20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0003fe30: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+0003fe40: 2073 6574 286d 6170 2873 656c 662e 636f   set(map(self.co
+0003fe50: 6572 6365 5f61 6464 7265 7373 2c20 776f  erce_address, wo
+0003fe60: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
+0003fe70: 2020 2020 7265 7475 726e 207b 773a 205b      return {w: [
+0003fe80: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+0003fe90: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+0003fea0: 2e70 726f 6365 7373 696e 675d 2066 6f72  .processing] for
+0003feb0: 2077 2069 6e20 776f 726b 6572 737d 0a20   w in workers}. 
+0003fec0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003fed0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003fee0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003fef0: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
+0003ff00: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
+0003ff10: 7369 6e67 5d20 666f 7220 772c 2077 7320  sing] for w, ws 
+0003ff20: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0003ff30: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+0003ff40: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+0003ff50: 6574 5f77 686f 5f68 6173 2873 656c 662c  et_who_has(self,
+0003ff60: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
+0003ff70: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+0003ff80: 6e65 2920 2d3e 2064 6963 745b 7374 722c  ne) -> dict[str,
+0003ff90: 206c 6973 745b 7374 725d 5d3a 0a20 2020   list[str]]:.   
+0003ffa0: 2020 2020 2069 6620 6b65 7973 2069 7320       if keys is 
+0003ffb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0003ffc0: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+0003ffd0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0003ffe0: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
+0003fff0: 666f 7220 7773 2069 6e20 7365 6c66 2e74  for ws in self.t
+00040000: 6173 6b73 5b6b 6579 5d2e 7768 6f5f 6861  asks[key].who_ha
+00040010: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00040020: 2020 2069 6620 6b65 7920 696e 2073 656c     if key in sel
+00040030: 662e 7461 736b 730a 2020 2020 2020 2020  f.tasks.        
+00040040: 2020 2020 2020 2020 656c 7365 205b 5d0a          else [].
+00040050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040060: 666f 7220 6b65 7920 696e 206b 6579 730a  for key in keys.
+00040070: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00040080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00040090: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000400a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000400b0: 206b 6579 3a20 5b77 732e 6164 6472 6573   key: [ws.addres
+000400c0: 7320 666f 7220 7773 2069 6e20 7473 2e77  s for ws in ts.w
+000400d0: 686f 5f68 6173 5d20 666f 7220 6b65 792c  ho_has] for key,
+000400e0: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
+000400f0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+00040100: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
+00040110: 2067 6574 5f68 6173 5f77 6861 7428 0a20   get_has_what(. 
+00040120: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+00040130: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
+00040140: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+00040150: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
+00040160: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
+00040170: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+00040180: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+00040190: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+000401a0: 6b65 7273 203d 206d 6170 2873 656c 662e  kers = map(self.
+000401b0: 636f 6572 6365 5f61 6464 7265 7373 2c20  coerce_address, 
+000401c0: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+000401d0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+000401e0: 2020 2020 2020 2020 2020 2020 2020 773a                w:
+000401f0: 205b 7473 2e6b 6579 2066 6f72 2074 7320   [ts.key for ts 
+00040200: 696e 2073 656c 662e 776f 726b 6572 735b  in self.workers[
+00040210: 775d 2e68 6173 5f77 6861 745d 0a20 2020  w].has_what].   
+00040220: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00040230: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
+00040240: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00040250: 2020 656c 7365 205b 5d0a 2020 2020 2020    else [].      
+00040260: 2020 2020 2020 2020 2020 666f 7220 7720            for w 
+00040270: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
+00040280: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00040290: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000402a0: 2020 2072 6574 7572 6e20 7b77 3a20 5b74     return {w: [t
+000402b0: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
+000402c0: 7773 2e68 6173 5f77 6861 745d 2066 6f72  ws.has_what] for
+000402d0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+000402e0: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
+000402f0: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
+00040300: 7265 7328 7365 6c66 2c20 776f 726b 6572  res(self, worker
+00040310: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+00040320: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00040330: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
+00040340: 5d3a 0a20 2020 2020 2020 2069 6620 776f  ]:.        if wo
+00040350: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+00040360: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00040370: 6f72 6b65 7273 203d 206d 6170 2873 656c  orkers = map(sel
+00040380: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+00040390: 2c20 776f 726b 6572 7329 0a20 2020 2020  , workers).     
+000403a0: 2020 2020 2020 2072 6574 7572 6e20 7b77         return {w
+000403b0: 3a20 7365 6c66 2e77 6f72 6b65 7273 5b77  : self.workers[w
+000403c0: 5d2e 6e74 6872 6561 6473 2066 6f72 2077  ].nthreads for w
+000403d0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
+000403e0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+000403f0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+00040400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00040410: 726e 207b 773a 2077 732e 6e74 6872 6561  rn {w: ws.nthrea
+00040420: 6473 2066 6f72 2077 2c20 7773 2069 6e20  ds for w, ws in 
+00040430: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
+00040440: 6d73 2829 7d0a 0a20 2020 2064 6566 2067  ms()}..    def g
+00040450: 6574 5f6e 636f 7265 735f 7275 6e6e 696e  et_ncores_runnin
+00040460: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
+00040470: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
+00040480: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
+00040490: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
+000404a0: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+000404b0: 2020 2020 2020 206e 636f 7265 7320 3d20         ncores = 
+000404c0: 7365 6c66 2e67 6574 5f6e 636f 7265 7328  self.get_ncores(
+000404d0: 776f 726b 6572 733d 776f 726b 6572 7329  workers=workers)
+000404e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000404f0: 7b0a 2020 2020 2020 2020 2020 2020 773a  {.            w:
+00040500: 206e 2066 6f72 2077 2c20 6e20 696e 206e   n for w, n in n
+00040510: 636f 7265 732e 6974 656d 7328 2920 6966  cores.items() if
+00040520: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+00040530: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00040540: 732e 7275 6e6e 696e 670a 2020 2020 2020  s.running.      
+00040550: 2020 7d0a 0a20 2020 2061 7379 6e63 2064    }..    async d
+00040560: 6566 2067 6574 5f63 616c 6c5f 7374 6163  ef get_call_stac
+00040570: 6b28 7365 6c66 2c20 6b65 7973 3a20 4974  k(self, keys: It
+00040580: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00040590: 6e65 203d 204e 6f6e 6529 202d 3e20 6469  ne = None) -> di
+000405a0: 6374 3a0a 2020 2020 2020 2020 776f 726b  ct:.        work
+000405b0: 6572 733a 2064 6963 745b 7374 722c 206c  ers: dict[str, l
+000405c0: 6973 745b 7374 725d 207c 204e 6f6e 655d  ist[str] | None]
+000405d0: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
+000405e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000405f0: 2020 2020 2020 2020 2020 7374 6163 6b20            stack 
+00040600: 3d20 6c69 7374 286b 6579 7329 0a20 2020  = list(keys).   
+00040610: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00040620: 696e 6720 3d20 7365 7428 290a 2020 2020  ing = set().    
+00040630: 2020 2020 2020 2020 7768 696c 6520 7374          while st
+00040640: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
+00040650: 2020 2020 206b 6579 203d 2073 7461 636b       key = stack
+00040660: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
+00040670: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00040680: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00040690: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+000406a0: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
+000406b0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
+000406c0: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
+000406d0: 6578 7465 6e64 285b 6474 732e 6b65 7920  extend([dts.key 
+000406e0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+000406f0: 7065 6e64 656e 6369 6573 5d29 0a20 2020  pendencies]).   
+00040700: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00040710: 6620 7473 2e73 7461 7465 203d 3d20 2270  f ts.state == "p
+00040720: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
+00040730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040740: 7072 6f63 6573 7369 6e67 2e61 6464 2874  processing.add(t
+00040750: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00040760: 776f 726b 6572 7320 3d20 6465 6661 756c  workers = defaul
+00040770: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
+00040780: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+00040790: 6e20 7072 6f63 6573 7369 6e67 3a0a 2020  n processing:.  
+000407a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000407b0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+000407c0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000407d0: 2020 2020 2020 2077 6b65 7973 203d 2077         wkeys = w
+000407e0: 6f72 6b65 7273 5b74 732e 7072 6f63 6573  orkers[ts.proces
+000407f0: 7369 6e67 5f6f 6e2e 6164 6472 6573 735d  sing_on.address]
+00040800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040810: 2020 2020 2061 7373 6572 7420 776b 6579       assert wkey
+00040820: 7320 6973 206e 6f74 204e 6f6e 650a 2020  s is not None.  
+00040830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040840: 2020 776b 6579 732e 6170 7065 6e64 2874    wkeys.append(t
+00040850: 732e 6b65 7929 0a20 2020 2020 2020 2065  s.key).        e
+00040860: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00040870: 2077 6f72 6b65 7273 203d 207b 773a 204e   workers = {w: N
+00040880: 6f6e 6520 666f 7220 7720 696e 2073 656c  one for w in sel
+00040890: 662e 776f 726b 6572 737d 0a0a 2020 2020  f.workers}..    
+000408a0: 2020 2020 6966 206e 6f74 2077 6f72 6b65      if not worke
+000408b0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+000408c0: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
+000408d0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+000408e0: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+000408f0: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00040900: 2873 656c 662e 7270 6328 7729 2e63 616c  (self.rpc(w).cal
+00040910: 6c5f 7374 6163 6b28 6b65 7973 3d76 2920  l_stack(keys=v) 
+00040920: 666f 7220 772c 2076 2069 6e20 776f 726b  for w, v in work
+00040930: 6572 732e 6974 656d 7328 2929 0a20 2020  ers.items()).   
+00040940: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00040950: 6573 706f 6e73 6520 3d20 7b77 3a20 7220  esponse = {w: r 
+00040960: 666f 7220 772c 2072 2069 6e20 7a69 7028  for w, r in zip(
+00040970: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
+00040980: 2920 6966 2072 7d0a 2020 2020 2020 2020  ) if r}.        
+00040990: 7265 7475 726e 2072 6573 706f 6e73 650a  return response.
+000409a0: 0a20 2020 2061 7379 6e63 2064 6566 2062  .    async def b
+000409b0: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
+000409c0: 6528 7365 6c66 2920 2d3e 2022 6469 6374  e(self) -> "dict
+000409d0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
+000409e0: 666c 6f61 745d 5d22 3a0a 2020 2020 2020  float]]":.      
+000409f0: 2020 2222 220a 2020 2020 2020 2020 5275    """.        Ru
+00040a00: 6e20 6120 6265 6e63 686d 6172 6b20 6f6e  n a benchmark on
+00040a10: 2074 6865 2077 6f72 6b65 7273 2066 6f72   the workers for
+00040a20: 206d 656d 6f72 792c 2064 6973 6b2c 2061   memory, disk, a
+00040a30: 6e64 206e 6574 776f 726b 2062 616e 6477  nd network bandw
+00040a40: 6964 7468 730a 0a20 2020 2020 2020 2052  idths..        R
+00040a50: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00040a60: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
+00040a70: 6573 756c 743a 2064 6963 740a 2020 2020  esult: dict.    
+00040a80: 2020 2020 2020 2020 4120 6469 6374 696f          A dictio
+00040a90: 6e61 7279 206d 6170 7069 6e67 2074 6865  nary mapping the
+00040aa0: 206e 616d 6573 2022 6469 736b 222c 2022   names "disk", "
+00040ab0: 6d65 6d6f 7279 222c 2061 6e64 2022 6e65  memory", and "ne
+00040ac0: 7477 6f72 6b22 2074 6f0a 2020 2020 2020  twork" to.      
+00040ad0: 2020 2020 2020 6469 6374 696f 6e61 7269        dictionari
+00040ae0: 6573 206d 6170 7069 6e67 2073 697a 6573  es mapping sizes
+00040af0: 2074 6f20 6261 6e64 7769 6474 6873 2e20   to bandwidths. 
+00040b00: 2054 6865 7365 2062 616e 6477 6964 7468   These bandwidth
+00040b10: 7320 6172 650a 2020 2020 2020 2020 2020  s are.          
+00040b20: 2020 6176 6572 6167 6564 206f 7665 7220    averaged over 
+00040b30: 6d61 6e79 2077 6f72 6b65 7273 2072 756e  many workers run
+00040b40: 6e69 6e67 2063 6f6d 7075 7461 7469 6f6e  ning computation
+00040b50: 7320 6163 726f 7373 2074 6865 2063 6c75  s across the clu
+00040b60: 7374 6572 2e0a 2020 2020 2020 2020 2222  ster..        ""
+00040b70: 220a 2020 2020 2020 2020 6f75 743a 2064  ".        out: d
+00040b80: 6963 745b 7374 722c 2064 6566 6175 6c74  ict[str, default
+00040b90: 6469 6374 5b73 7472 2c20 6c69 7374 5b66  dict[str, list[f
+00040ba0: 6c6f 6174 5d5d 5d20 3d20 7b0a 2020 2020  loat]]] = {.    
+00040bb0: 2020 2020 2020 2020 6e61 6d65 3a20 6465          name: de
+00040bc0: 6661 756c 7464 6963 7428 6c69 7374 2920  faultdict(list) 
+00040bd0: 666f 7220 6e61 6d65 2069 6e20 5b22 6469  for name in ["di
+00040be0: 736b 222c 2022 6d65 6d6f 7279 222c 2022  sk", "memory", "
+00040bf0: 6e65 7477 6f72 6b22 5d0a 2020 2020 2020  network"].      
+00040c00: 2020 7d0a 0a20 2020 2020 2020 2023 2064    }..        # d
+00040c10: 6973 6b0a 2020 2020 2020 2020 7265 7375  isk.        resu
+00040c20: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
+00040c30: 6272 6f61 6463 6173 7428 6d73 673d 7b22  broadcast(msg={"
+00040c40: 6f70 223a 2022 6265 6e63 686d 6172 6b5f  op": "benchmark_
+00040c50: 6469 736b 227d 290a 2020 2020 2020 2020  disk"}).        
+00040c60: 666f 7220 6420 696e 2072 6573 756c 742e  for d in result.
+00040c70: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+00040c80: 2020 2020 2020 666f 7220 7369 7a65 2c20        for size, 
+00040c90: 6475 7261 7469 6f6e 2069 6e20 642e 6974  duration in d.it
+00040ca0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00040cb0: 2020 2020 2020 206f 7574 5b22 6469 736b         out["disk
+00040cc0: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
+00040cd0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
+00040ce0: 2020 2023 206d 656d 6f72 790a 2020 2020     # memory.    
+00040cf0: 2020 2020 7265 7375 6c74 203d 2061 7761      result = awa
+00040d00: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+00040d10: 7428 6d73 673d 7b22 6f70 223a 2022 6265  t(msg={"op": "be
+00040d20: 6e63 686d 6172 6b5f 6d65 6d6f 7279 227d  nchmark_memory"}
+00040d30: 290a 2020 2020 2020 2020 666f 7220 6420  ).        for d 
+00040d40: 696e 2072 6573 756c 742e 7661 6c75 6573  in result.values
+00040d50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00040d60: 666f 7220 7369 7a65 2c20 6475 7261 7469  for size, durati
+00040d70: 6f6e 2069 6e20 642e 6974 656d 7328 293a  on in d.items():
+00040d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040d90: 206f 7574 5b22 6d65 6d6f 7279 225d 5b73   out["memory"][s
+00040da0: 697a 655d 2e61 7070 656e 6428 6475 7261  ize].append(dura
+00040db0: 7469 6f6e 290a 0a20 2020 2020 2020 2023  tion)..        #
+00040dc0: 206e 6574 776f 726b 0a20 2020 2020 2020   network.       
+00040dd0: 2077 6f72 6b65 7273 203d 206c 6973 7428   workers = list(
+00040de0: 7365 6c66 2e77 6f72 6b65 7273 290a 2020  self.workers).  
+00040df0: 2020 2020 2020 2320 4f6e 2061 6e20 6164        # On an ad
+00040e00: 6170 7469 7665 2063 6c75 7374 6572 2c20  aptive cluster, 
+00040e10: 6966 206d 756c 7469 706c 6520 776f 726b  if multiple work
+00040e20: 6572 7320 6172 6520 7374 6172 7465 6420  ers are started 
+00040e30: 6f6e 2074 6865 2073 616d 6520 7068 7973  on the same phys
+00040e40: 6963 616c 2068 6f73 742c 0a20 2020 2020  ical host,.     
+00040e50: 2020 2023 2074 6865 7920 6172 6520 6d6f     # they are mo
+00040e60: 7265 206c 696b 656c 7920 746f 2063 6f6e  re likely to con
+00040e70: 6e65 6374 2074 6f20 7468 6520 5363 6865  nect to the Sche
+00040e80: 6475 6c65 7220 696e 2073 6571 7565 6e63  duler in sequenc
+00040e90: 652c 2065 6e64 696e 6720 7570 206e 6578  e, ending up nex
+00040ea0: 7420 746f 0a20 2020 2020 2020 2023 2065  t to.        # e
+00040eb0: 6163 6820 6f74 6865 7220 696e 2074 6869  ach other in thi
+00040ec0: 7320 6c69 7374 2e0a 2020 2020 2020 2020  s list..        
+00040ed0: 2320 5468 6520 7472 616e 7366 6572 2073  # The transfer s
+00040ee0: 7065 6564 2077 6974 6869 6e20 7375 6368  peed within such
+00040ef0: 2063 6c75 7374 6572 7320 6f66 2077 6f72   clusters of wor
+00040f00: 6b65 7273 2077 696c 6c20 6265 2065 6666  kers will be eff
+00040f10: 6563 7469 7665 6c79 2074 6861 7420 6f66  ectively that of
+00040f20: 0a20 2020 2020 2020 2023 206c 6f63 616c  .        # local
+00040f30: 686f 7374 2e20 5468 6973 2063 6f75 6c64  host. This could
+00040f40: 2068 6170 7065 6e20 6163 726f 7373 2064   happen across d
+00040f50: 6966 6665 7265 6e74 2056 4d73 2061 6e64  ifferent VMs and
+00040f60: 2f6f 7220 646f 636b 6572 2069 6d61 6765  /or docker image
+00040f70: 732c 2073 6f0a 2020 2020 2020 2020 2320  s, so.        # 
+00040f80: 696d 706c 656d 656e 7469 6e67 206c 6f67  implementing log
+00040f90: 6963 2062 6173 6564 206f 6e20 4950 2061  ic based on IP a
+00040fa0: 6464 7265 7373 6573 2077 6f75 6c64 206e  ddresses would n
+00040fb0: 6f74 206e 6563 6573 7361 7269 6c79 2068  ot necessarily h
+00040fc0: 656c 702e 0a20 2020 2020 2020 2023 2052  elp..        # R
+00040fd0: 616e 646f 6d69 7a65 2074 6865 2063 6f6e  andomize the con
+00040fe0: 6e65 6374 696f 6e73 2074 6f20 6576 656e  nections to even
+00040ff0: 206f 7574 2074 6865 206d 6561 6e20 6d65   out the mean me
+00041000: 6173 7572 6573 2e0a 2020 2020 2020 2020  asures..        
+00041010: 7261 6e64 6f6d 2e73 6875 6666 6c65 2877  random.shuffle(w
+00041020: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
+00041030: 6675 7475 7265 7320 3d20 5b0a 2020 2020  futures = [.    
+00041040: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
+00041050: 2861 292e 6265 6e63 686d 6172 6b5f 6e65  (a).benchmark_ne
+00041060: 7477 6f72 6b28 6164 6472 6573 733d 6229  twork(address=b)
+00041070: 2066 6f72 2061 2c20 6220 696e 2070 6172   for a, b in par
+00041080: 7469 7469 6f6e 2832 2c20 776f 726b 6572  tition(2, worker
+00041090: 7329 0a20 2020 2020 2020 205d 0a20 2020  s).        ].   
+000410a0: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
+000410b0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+000410c0: 6174 6865 7228 2a66 7574 7572 6573 290a  ather(*futures).
+000410d0: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
+000410e0: 6e20 7265 7370 6f6e 7365 733a 0a20 2020  n responses:.   
+000410f0: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
+00041100: 652c 2064 7572 6174 696f 6e20 696e 2064  e, duration in d
+00041110: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00041120: 2020 2020 2020 2020 2020 6f75 745b 226e            out["n
+00041130: 6574 776f 726b 225d 5b73 697a 655d 2e61  etwork"][size].a
+00041140: 7070 656e 6428 6475 7261 7469 6f6e 290a  ppend(duration).
+00041150: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+00041160: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+00041170: 206d 6f64 6520 696e 206f 7574 3a0a 2020   mode in out:.  
+00041180: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00041190: 5b6d 6f64 655d 203d 207b 0a20 2020 2020  [mode] = {.     
+000411a0: 2020 2020 2020 2020 2020 2073 697a 653a             size:
+000411b0: 2073 756d 2864 7572 6174 696f 6e73 2920   sum(durations) 
+000411c0: 2f20 6c65 6e28 6475 7261 7469 6f6e 7329  / len(durations)
+000411d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000411e0: 2066 6f72 2073 697a 652c 2064 7572 6174   for size, durat
+000411f0: 696f 6e73 2069 6e20 6f75 745b 6d6f 6465  ions in out[mode
+00041200: 5d2e 6974 656d 7328 290a 2020 2020 2020  ].items().      
+00041210: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00041220: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00041230: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00041240: 2020 2020 6465 6620 6765 745f 6e62 7974      def get_nbyt
+00041250: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
+00041260: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+00041270: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
+00041280: 6f6e 652c 2073 756d 6d61 7279 3a20 626f  one, summary: bo
+00041290: 6f6c 203d 2054 7275 650a 2020 2020 2920  ol = True.    ) 
+000412a0: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
+000412b0: 5d3a 0a20 2020 2020 2020 2069 6620 6b65  ]:.        if ke
+000412c0: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ys is not None:.
+000412d0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+000412e0: 6c74 203d 207b 6b3a 2073 656c 662e 7461  lt = {k: self.ta
+000412f0: 736b 735b 6b5d 2e6e 6279 7465 7320 666f  sks[k].nbytes fo
+00041300: 7220 6b20 696e 206b 6579 737d 0a20 2020  r k in keys}.   
+00041310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00041320: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00041330: 7b6b 3a20 7473 2e6e 6279 7465 7320 666f  {k: ts.nbytes fo
+00041340: 7220 6b2c 2074 7320 696e 2073 656c 662e  r k, ts in self.
+00041350: 7461 736b 732e 6974 656d 7328 2920 6966  tasks.items() if
+00041360: 2074 732e 6e62 7974 6573 203e 3d20 307d   ts.nbytes >= 0}
+00041370: 0a0a 2020 2020 2020 2020 6966 2073 756d  ..        if sum
+00041380: 6d61 7279 3a0a 2020 2020 2020 2020 2020  mary:.          
+00041390: 2020 6f75 743a 2064 6566 6175 6c74 6469    out: defaultdi
+000413a0: 6374 5b73 7472 2c20 696e 745d 203d 2064  ct[str, int] = d
+000413b0: 6566 6175 6c74 6469 6374 286c 616d 6264  efaultdict(lambd
+000413c0: 613a 2030 290a 2020 2020 2020 2020 2020  a: 0).          
+000413d0: 2020 666f 7220 6b2c 2076 2069 6e20 7265    for k, v in re
+000413e0: 7375 6c74 2e69 7465 6d73 2829 3a0a 2020  sult.items():.  
+000413f0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00041400: 745b 6b65 795f 7370 6c69 7428 6b29 5d20  t[key_split(k)] 
+00041410: 2b3d 2076 0a20 2020 2020 2020 2020 2020  += v.           
+00041420: 2072 6573 756c 7420 3d20 6469 6374 286f   result = dict(o
+00041430: 7574 290a 0a20 2020 2020 2020 2072 6574  ut)..        ret
+00041440: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
+00041450: 6465 6620 7275 6e5f 6675 6e63 7469 6f6e  def run_function
+00041460: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00041470: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
+00041480: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
+00041490: 7469 6f6e 3a20 4361 6c6c 6162 6c65 2c0a  tion: Callable,.
+000414a0: 2020 2020 2020 2020 6172 6773 3a20 7475          args: tu
+000414b0: 706c 6520 3d20 2829 2c0a 2020 2020 2020  ple = (),.      
+000414c0: 2020 6b77 6172 6773 3a20 6469 6374 207c    kwargs: dict |
+000414d0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000414e0: 2020 2020 2020 7761 6974 3a20 626f 6f6c        wait: bool
+000414f0: 203d 2054 7275 652c 0a20 2020 2029 202d   = True,.    ) -
+00041500: 3e20 416e 793a 0a20 2020 2020 2020 2022  > Any:.        "
+00041510: 2222 5275 6e20 6120 6675 6e63 7469 6f6e  ""Run a function
+00041520: 2077 6974 6869 6e20 7468 6973 2070 726f   within this pro
+00041530: 6365 7373 0a0a 2020 2020 2020 2020 5365  cess..        Se
+00041540: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+00041550: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00041560: 436c 6965 6e74 2e72 756e 5f6f 6e5f 7363  Client.run_on_sc
+00041570: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+00041580: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
+00041590: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
+000415a0: 6b65 7220 696d 706f 7274 2072 756e 0a0a  ker import run..
+000415b0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+000415c0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+000415d0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+000415e0: 6475 6c65 722e 7069 636b 6c65 2229 3a0a  duler.pickle"):.
+000415f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00041600: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00041610: 2020 2020 2020 2020 2020 2020 2020 2243                "C
+00041620: 616e 6e6f 7420 7275 6e20 6675 6e63 7469  annot run functi
+00041630: 6f6e 2061 7320 7468 6520 7363 6865 6475  on as the schedu
+00041640: 6c65 7220 6861 7320 6265 656e 2065 7870  ler has been exp
+00041650: 6c69 6369 746c 7920 6469 7361 6c6c 6f77  licitly disallow
+00041660: 6564 2066 726f 6d20 220a 2020 2020 2020  ed from ".      
+00041670: 2020 2020 2020 2020 2020 2264 6573 6572            "deser
+00041680: 6961 6c69 7a69 6e67 2061 7262 6974 7261  ializing arbitra
+00041690: 7279 2062 7974 6573 7472 696e 6773 2075  ry bytestrings u
+000416a0: 7369 6e67 2070 6963 6b6c 6520 7669 6120  sing pickle via 
+000416b0: 7468 6520 220a 2020 2020 2020 2020 2020  the ".          
+000416c0: 2020 2020 2020 2227 6469 7374 7269 6275        "'distribu
+000416d0: 7465 642e 7363 6865 6475 6c65 722e 7069  ted.scheduler.pi
+000416e0: 636b 6c65 2720 636f 6e66 6967 7572 6174  ckle' configurat
+000416f0: 696f 6e20 7365 7474 696e 672e 220a 2020  ion setting.".  
+00041700: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00041710: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
+00041720: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
+00041730: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00041740: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
+00041750: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
+00041760: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
+00041770: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
+00041780: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
+00041790: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
+000417a0: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
+000417b0: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
+000417c0: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
+000417d0: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
+000417e0: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
+000417f0: 733a 206c 6973 745b 7374 725d 2c20 7661  s: list[str], va
+00041800: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
+00041810: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+00041820: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00041830: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
+00041840: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
+00041850: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
+00041860: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00041870: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
+00041880: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
+00041890: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
+000418a0: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
+000418b0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+000418c0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+000418d0: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
+000418e0: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
+000418f0: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
+00041900: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+00041910: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
+00041920: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
+00041930: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
+00041940: 206c 6973 745b 7374 725d 2c20 6465 6661   list[str], defa
+00041950: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
+00041960: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
+00041970: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00041980: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
+00041990: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
+000419a0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+000419b0: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
+000419c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000419d0: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
+000419e0: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
+000419f0: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
+00041a00: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
+00041a10: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00041a20: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
+00041a30: 756c 7420 213d 206e 6f5f 6465 6661 756c  ult != no_defaul
+00041a40: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00041a50: 2020 2072 6574 7572 6e20 6465 6661 756c     return defaul
+00041a60: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00041a70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00041a80: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
+00041a90: 6566 2073 6574 5f72 6573 7472 6963 7469  ef set_restricti
+00041aa0: 6f6e 7328 7365 6c66 2c20 776f 726b 6572  ons(self, worker
+00041ab0: 3a20 6469 6374 5b73 7472 2c20 436f 6c6c  : dict[str, Coll
+00041ac0: 6563 7469 6f6e 5b73 7472 5d20 7c20 7374  ection[str] | st
+00041ad0: 725d 2920 2d3e 204e 6f6e 653a 0a20 2020  r]) -> None:.   
+00041ae0: 2020 2020 2066 6f72 206b 6579 2c20 7265       for key, re
+00041af0: 7374 7269 6374 696f 6e73 2069 6e20 776f  strictions in wo
+00041b00: 726b 6572 2e69 7465 6d73 2829 3a0a 2020  rker.items():.  
+00041b10: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00041b20: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00041b30: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00041b40: 696e 7374 616e 6365 2872 6573 7472 6963  instance(restric
+00041b50: 7469 6f6e 732c 2073 7472 293a 0a20 2020  tions, str):.   
+00041b60: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00041b70: 7472 6963 7469 6f6e 7320 3d20 7b72 6573  trictions = {res
+00041b80: 7472 6963 7469 6f6e 737d 0a20 2020 2020  trictions}.     
+00041b90: 2020 2020 2020 2074 732e 776f 726b 6572         ts.worker
+00041ba0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+00041bb0: 7365 7428 7265 7374 7269 6374 696f 6e73  set(restrictions
+00041bc0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
+00041bd0: 7273 0a20 2020 2064 6566 2067 6574 5f74  rs.    def get_t
+00041be0: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
+00041bf0: 7328 7365 6c66 2920 2d3e 2064 6963 745b  s(self) -> dict[
+00041c00: 7374 722c 2064 6963 745b 7374 722c 2069  str, dict[str, i
+00041c10: 6e74 5d5d 3a0a 2020 2020 2020 2020 7374  nt]]:.        st
+00041c20: 6174 6520 3d20 7b7d 0a0a 2020 2020 2020  ate = {}..      
+00041c30: 2020 666f 7220 7470 2069 6e20 7365 6c66    for tp in self
+00041c40: 2e74 6173 6b5f 7072 6566 6978 6573 2e76  .task_prefixes.v
+00041c50: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00041c60: 2020 2020 2061 6374 6976 655f 7374 6174       active_stat
+00041c70: 6573 203d 2074 702e 6163 7469 7665 5f73  es = tp.active_s
+00041c80: 7461 7465 730a 2020 2020 2020 2020 2020  tates.          
+00041c90: 2020 6966 2061 6e79 280a 2020 2020 2020    if any(.      
+00041ca0: 2020 2020 2020 2020 2020 6163 7469 7665            active
+00041cb0: 5f73 7461 7465 732e 6765 7428 7329 0a20  _states.get(s). 
+00041cc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00041cd0: 6f72 2073 2069 6e20 7b22 6d65 6d6f 7279  or s in {"memory
+00041ce0: 222c 2022 6572 7265 6422 2c20 2272 656c  ", "erred", "rel
+00041cf0: 6561 7365 6422 2c20 2270 726f 6365 7373  eased", "process
+00041d00: 696e 6722 2c20 2277 6169 7469 6e67 227d  ing", "waiting"}
+00041d10: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
+00041d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041d30: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
+00041d40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00041d50: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+00041d60: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+00041d70: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
+00041d80: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+00041d90: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
+00041da0: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
+00041db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041dc0: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
+00041dd0: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
+00041de0: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
+00041df0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+00041e00: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
+00041e10: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
+00041e20: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
+00041e30: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
+00041e40: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
+00041e50: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
+00041e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00041e70: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
+00041e80: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
+00041e90: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
+00041ea0: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
+00041eb0: 7465 7261 626c 655b 7374 725d 2920 2d3e  terable[str]) ->
+00041ec0: 2064 6963 745b 7374 722c 2054 6173 6b53   dict[str, TaskS
+00041ed0: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
+00041ee0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00041ef0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+00041f00: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
+00041f10: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
+00041f20: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+00041f30: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
+00041f40: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
+00041f50: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+00041f60: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
+00041f70: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00041f80: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
+00041f90: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
+00041fa0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00041fb0: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
+00041fc0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+00041fd0: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
+00041fe0: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
+00041ff0: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
+00042000: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
+00042010: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
+00042020: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
+00042030: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
+00042040: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
+00042050: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
+00042060: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
+00042070: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
+00042080: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00042090: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
+000420a0: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
+000420b0: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
+000420c0: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
+000420d0: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
+000420e0: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
+000420f0: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+00042100: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
+00042110: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
+00042120: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
+00042130: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
+00042140: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
+00042150: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
+00042160: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
+00042170: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+00042180: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
+00042190: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
+000421a0: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
+000421b0: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
+000421c0: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
+000421d0: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
+000421e0: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
+000421f0: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
+00042200: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
+00042210: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00042220: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+00042230: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
+00042240: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
+00042250: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
+00042260: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00042270: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
+00042280: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00042290: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
+000422a0: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
+000422b0: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
+000422c0: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
+000422d0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+000422e0: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
+000422f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00042300: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00042310: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
+00042320: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
+00042330: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
+00042340: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
+00042350: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
+00042360: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
+00042370: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
+00042380: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
+00042390: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
+000423a0: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
+000423b0: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
+000423c0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+000423d0: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
+000423e0: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
+000423f0: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
+00042400: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
+00042410: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
+00042420: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
+00042430: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00042440: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
+00042450: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
+00042460: 6d2c 2070 6c75 6769 6e2c 206e 616d 653d  m, plugin, name=
+00042470: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
+00042480: 2222 5265 6769 7374 6572 7320 6120 776f  ""Registers a wo
+00042490: 726b 6572 2070 6c75 6769 6e20 6f6e 2061  rker plugin on a
+000424a0: 6c6c 2072 756e 6e69 6e67 2061 6e64 2066  ll running and f
+000424b0: 7574 7572 6520 776f 726b 6572 7322 2222  uture workers"""
+000424c0: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+000424d0: 726b 6572 5f70 6c75 6769 6e73 5b6e 616d  rker_plugins[nam
+000424e0: 655d 203d 2070 6c75 6769 6e0a 0a20 2020  e] = plugin..   
+000424f0: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
+00042500: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+00042510: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
+00042520: 2020 206d 7367 3d64 6963 7428 6f70 3d22     msg=dict(op="
+00042530: 706c 7567 696e 2d61 6464 222c 2070 6c75  plugin-add", plu
+00042540: 6769 6e3d 706c 7567 696e 2c20 6e61 6d65  gin=plugin, name
+00042550: 3d6e 616d 6529 0a20 2020 2020 2020 2029  =name).        )
+00042560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00042570: 7265 7370 6f6e 7365 730a 0a20 2020 2061  responses..    a
+00042580: 7379 6e63 2064 6566 2075 6e72 6567 6973  sync def unregis
+00042590: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
+000425a0: 6e28 7365 6c66 2c20 636f 6d6d 2c20 6e61  n(self, comm, na
+000425b0: 6d65 293a 0a20 2020 2020 2020 2022 2222  me):.        """
+000425c0: 556e 7265 6769 7374 6572 7320 6120 776f  Unregisters a wo
+000425d0: 726b 6572 2070 6c75 6769 6e22 2222 0a20  rker plugin""". 
+000425e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000425f0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00042600: 6b65 725f 706c 7567 696e 732e 706f 7028  ker_plugins.pop(
+00042610: 6e61 6d65 290a 2020 2020 2020 2020 6578  name).        ex
+00042620: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00042630: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00042640: 2056 616c 7565 4572 726f 7228 6622 5468   ValueError(f"Th
+00042650: 6520 776f 726b 6572 2070 6c75 6769 6e20  e worker plugin 
+00042660: 7b6e 616d 657d 2064 6f65 7320 6e6f 7420  {name} does not 
+00042670: 6578 6973 7422 290a 0a20 2020 2020 2020  exist")..       
+00042680: 2072 6573 706f 6e73 6573 203d 2061 7761   responses = awa
+00042690: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+000426a0: 7428 6d73 673d 6469 6374 286f 703d 2270  t(msg=dict(op="p
+000426b0: 6c75 6769 6e2d 7265 6d6f 7665 222c 206e  lugin-remove", n
+000426c0: 616d 653d 6e61 6d65 2929 0a20 2020 2020  ame=name)).     
+000426d0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
+000426e0: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
+000426f0: 6566 2072 6567 6973 7465 725f 6e61 6e6e  ef register_nann
+00042700: 795f 706c 7567 696e 2873 656c 662c 2063  y_plugin(self, c
+00042710: 6f6d 6d2c 2070 6c75 6769 6e2c 206e 616d  omm, plugin, nam
+00042720: 653d 4e6f 6e65 293a 0a20 2020 2020 2020  e=None):.       
+00042730: 2022 2222 5265 6769 7374 6572 7320 6120   """Registers a 
+00042740: 7365 7475 7020 6675 6e63 7469 6f6e 2c20  setup function, 
+00042750: 616e 6420 6361 6c6c 2069 7420 6f6e 2065  and call it on e
+00042760: 7665 7279 2077 6f72 6b65 7222 2222 0a20  very worker""". 
+00042770: 2020 2020 2020 2073 656c 662e 6e61 6e6e         self.nann
+00042780: 795f 706c 7567 696e 735b 6e61 6d65 5d20  y_plugins[name] 
+00042790: 3d20 706c 7567 696e 0a0a 2020 2020 2020  = plugin..      
+000427a0: 2020 7265 7370 6f6e 7365 7320 3d20 6177    responses = aw
+000427b0: 6169 7420 7365 6c66 2e62 726f 6164 6361  ait self.broadca
+000427c0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+000427d0: 6d73 673d 6469 6374 286f 703d 2270 6c75  msg=dict(op="plu
+000427e0: 6769 6e5f 6164 6422 2c20 706c 7567 696e  gin_add", plugin
+000427f0: 3d70 6c75 6769 6e2c 206e 616d 653d 6e61  =plugin, name=na
+00042800: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+00042810: 206e 616e 6e79 3d54 7275 652c 0a20 2020   nanny=True,.   
+00042820: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00042830: 6574 7572 6e20 7265 7370 6f6e 7365 730a  eturn responses.
+00042840: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
+00042850: 6e72 6567 6973 7465 725f 6e61 6e6e 795f  nregister_nanny_
+00042860: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
+00042870: 6d2c 206e 616d 6529 3a0a 2020 2020 2020  m, name):.      
+00042880: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
+00042890: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
+000428a0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+000428b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000428c0: 662e 6e61 6e6e 795f 706c 7567 696e 732e  f.nanny_plugins.
+000428d0: 706f 7028 6e61 6d65 290a 2020 2020 2020  pop(name).      
+000428e0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+000428f0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00042900: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00042910: 6622 5468 6520 6e61 6e6e 7920 706c 7567  f"The nanny plug
+00042920: 696e 207b 6e61 6d65 7d20 646f 6573 206e  in {name} does n
+00042930: 6f74 2065 7869 7374 2229 0a0a 2020 2020  ot exist")..    
+00042940: 2020 2020 7265 7370 6f6e 7365 7320 3d20      responses = 
+00042950: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
+00042960: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
+00042970: 2020 6d73 673d 6469 6374 286f 703d 2270    msg=dict(op="p
+00042980: 6c75 6769 6e5f 7265 6d6f 7665 222c 206e  lugin_remove", n
+00042990: 616d 653d 6e61 6d65 292c 206e 616e 6e79  ame=name), nanny
+000429a0: 3d54 7275 650a 2020 2020 2020 2020 290a  =True.        ).
+000429b0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000429c0: 6573 706f 6e73 6573 0a0a 2020 2020 6465  esponses..    de
+000429d0: 6620 7472 616e 7369 7469 6f6e 280a 2020  f transition(.  
+000429e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000429f0: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
+00042a00: 2020 2020 2020 6669 6e69 7368 3a20 5461        finish: Ta
+00042a10: 736b 5374 6174 6553 7461 7465 2c0a 2020  skStateState,.  
+00042a20: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00042a30: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00042a40: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+00042a50: 2020 2029 202d 3e20 5265 6373 3a0a 2020     ) -> Recs:.  
+00042a60: 2020 2020 2020 2222 2254 7261 6e73 6974        """Transit
+00042a70: 696f 6e20 6120 6b65 7920 6672 6f6d 2069  ion a key from i
+00042a80: 7473 2063 7572 7265 6e74 2073 7461 7465  ts current state
+00042a90: 2074 6f20 7468 6520 6669 6e69 7368 2073   to the finish s
+00042aa0: 7461 7465 0a0a 2020 2020 2020 2020 4578  tate..        Ex
+00042ab0: 616d 706c 6573 0a20 2020 2020 2020 202d  amples.        -
+00042ac0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00042ad0: 3e3e 3e20 7365 6c66 2e74 7261 6e73 6974  >>> self.transit
+00042ae0: 696f 6e28 2778 272c 2027 7761 6974 696e  ion('x', 'waitin
+00042af0: 6727 290a 2020 2020 2020 2020 7b27 7827  g').        {'x'
+00042b00: 3a20 2770 726f 6365 7373 696e 6727 7d0a  : 'processing'}.
+00042b10: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00042b20: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00042b30: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
+00042b40: 6172 7920 6f66 2072 6563 6f6d 6d65 6e64  ary of recommend
+00042b50: 6174 696f 6e73 2066 6f72 2066 7574 7572  ations for futur
+00042b60: 6520 7472 616e 7369 7469 6f6e 730a 0a20  e transitions.. 
+00042b70: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
+00042b80: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00042b90: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+00042ba0: 6572 2e74 7261 6e73 6974 696f 6e73 3a20  er.transitions: 
+00042bb0: 7472 616e 7369 7469 7665 2076 6572 7369  transitive versi
+00042bc0: 6f6e 206f 6620 7468 6973 2066 756e 6374  on of this funct
+00042bd0: 696f 6e0a 2020 2020 2020 2020 2222 220a  ion.        """.
+00042be0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00042bf0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00042c00: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00042c10: 7320 3d20 7365 6c66 2e5f 7472 616e 7369  s = self._transi
+00042c20: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00042c30: 2020 6b65 792c 2066 696e 6973 682c 2073    key, finish, s
+00042c40: 7469 6d75 6c75 735f 6964 2c20 2a2a 6b77  timulus_id, **kw
+00042c50: 6172 6773 0a20 2020 2020 2020 2029 0a20  args.        ). 
+00042c60: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+00042c70: 5f61 6c6c 2863 6c69 656e 745f 6d73 6773  _all(client_msgs
+00042c80: 2c20 776f 726b 6572 5f6d 7367 7329 0a20  , worker_msgs). 
+00042c90: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00042ca0: 636f 6d6d 656e 6461 7469 6f6e 730a 0a20  commendations.. 
+00042cb0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+00042cc0: 6e73 2873 656c 662c 2072 6563 6f6d 6d65  ns(self, recomme
+00042cd0: 6e64 6174 696f 6e73 3a20 5265 6373 2c20  ndations: Recs, 
+00042ce0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00042cf0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00042d00: 2020 2022 2222 5072 6f63 6573 7320 7472     """Process tr
+00042d10: 616e 7369 7469 6f6e 7320 756e 7469 6c20  ansitions until 
+00042d20: 6e6f 6e65 2061 7265 206c 6566 740a 0a20  none are left.. 
+00042d30: 2020 2020 2020 2054 6869 7320 696e 636c         This incl
+00042d40: 7564 6573 2066 6565 6462 6163 6b20 6672  udes feedback fr
+00042d50: 6f6d 2070 7265 7669 6f75 7320 7472 616e  om previous tran
+00042d60: 7369 7469 6f6e 7320 616e 6420 636f 6e74  sitions and cont
+00042d70: 696e 7565 7320 756e 7469 6c20 7765 0a20  inues until we. 
+00042d80: 2020 2020 2020 2072 6561 6368 2061 2073         reach a s
+00042d90: 7465 6164 7920 7374 6174 650a 2020 2020  teady state.    
+00042da0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00042db0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+00042dc0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00042dd0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00042de0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00042df0: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
+00042e00: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00042e10: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00042e20: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
+00042e30: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+00042e40: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
+00042e50: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00042e60: 725f 6d73 6773 290a 0a20 2020 2061 7379  r_msgs)..    asy
+00042e70: 6e63 2064 6566 2067 6574 5f73 746f 7279  nc def get_story
+00042e80: 2873 656c 662c 206b 6579 735f 6f72 5f73  (self, keys_or_s
+00042e90: 7469 6d75 6c69 3a20 4974 6572 6162 6c65  timuli: Iterable
+00042ea0: 5b73 7472 5d29 202d 3e20 6c69 7374 5b54  [str]) -> list[T
+00042eb0: 7261 6e73 6974 696f 6e5d 3a0a 2020 2020  ransition]:.    
+00042ec0: 2020 2020 2222 2252 5043 2068 6f6f 6b20      """RPC hook 
+00042ed0: 666f 7220 3a6d 6574 683a 6053 6368 6564  for :meth:`Sched
+00042ee0: 756c 6572 5374 6174 652e 7374 6f72 7960  ulerState.story`
+00042ef0: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
+00042f00: 7468 6174 2074 6865 206d 7367 7061 636b  that the msgpack
+00042f10: 2073 6572 6961 6c69 7a61 7469 6f6e 2f64   serialization/d
+00042f20: 6573 6572 6961 6c69 7a61 7469 6f6e 2072  eserialization r
+00042f30: 6f75 6e64 2d74 7269 7020 7769 6c6c 2074  ound-trip will t
+00042f40: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
+00042f50: 2074 6865 203a 636c 6173 733a 6054 7261   the :class:`Tra
+00042f60: 6e73 6974 696f 6e60 206e 616d 6564 7475  nsition` namedtu
+00042f70: 706c 6573 2069 6e74 6f20 7265 6775 6c61  ples into regula
+00042f80: 7220 7475 706c 6573 2e0a 2020 2020 2020  r tuples..      
+00042f90: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00042fa0: 7475 726e 2073 656c 662e 7374 6f72 7928  turn self.story(
+00042fb0: 2a6b 6579 735f 6f72 5f73 7469 6d75 6c69  *keys_or_stimuli
+00042fc0: 290a 0a20 2020 2064 6566 205f 7265 7363  )..    def _resc
+00042fd0: 6865 6475 6c65 280a 2020 2020 2020 2020  hedule(.        
+00042fe0: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00042ff0: 776f 726b 6572 3a20 7374 7220 7c20 4e6f  worker: str | No
+00043000: 6e65 203d 204e 6f6e 652c 202a 2c20 7374  ne = None, *, st
+00043010: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00043020: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00043030: 2020 2020 2020 2222 2252 6573 6368 6564        """Resched
+00043040: 756c 6520 6120 7461 736b 2e0a 0a20 2020  ule a task...   
+00043050: 2020 2020 2054 6869 7320 6675 6e63 7469       This functi
+00043060: 6f6e 2073 686f 756c 6420 6f6e 6c79 2062  on should only b
+00043070: 6520 7573 6564 2077 6865 6e20 7468 6520  e used when the 
+00043080: 7461 736b 2068 6173 2061 6c72 6561 6479  task has already
+00043090: 2062 6565 6e20 7265 6c65 6173 6564 2069   been released i
+000430a0: 6e0a 2020 2020 2020 2020 736f 6d65 2077  n.        some w
+000430b0: 6179 206f 6e20 7468 6520 776f 726b 6572  ay on the worker
+000430c0: 2069 7427 7320 6173 7369 676e 6564 2074   it's assigned t
+000430d0: 6f20 e280 9420 6569 7468 6572 2076 6961  o ... either via
+000430e0: 2063 616e 6365 6c6c 6174 696f 6e20 6f72   cancellation or
+000430f0: 2061 0a20 2020 2020 2020 2052 6573 6368   a.        Resch
+00043100: 6564 756c 6520 6578 6365 7074 696f 6e20  edule exception 
+00043110: e280 9420 616e 6420 796f 7520 6172 6520  ... and you are 
+00043120: 6365 7274 6169 6e20 7468 6520 776f 726b  certain the work
+00043130: 6572 2077 696c 6c20 6e6f 7420 7365 6e64  er will not send
+00043140: 2061 6e79 2066 7572 7468 6572 0a20 2020   any further.   
+00043150: 2020 2020 2075 7064 6174 6573 2061 626f       updates abo
+00043160: 7574 2074 6865 2074 6173 6b20 746f 2074  ut the task to t
+00043170: 6865 2073 6368 6564 756c 6572 2e0a 2020  he scheduler..  
+00043180: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00043190: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000431a0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000431b0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+000431c0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+000431d0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000431e0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+000431f0: 2020 2020 2020 2020 2020 2020 2066 2241               f"A
+00043200: 7474 656d 7074 696e 6720 746f 2072 6573  ttempting to res
+00043210: 6368 6564 756c 6520 7461 736b 207b 6b65  chedule task {ke
+00043220: 797d 2c20 7768 6963 6820 7761 7320 6e6f  y}, which was no
+00043230: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00043240: 2020 2020 2266 6f75 6e64 206f 6e20 7468      "found on th
+00043250: 6520 7363 6865 6475 6c65 722e 2041 626f  e scheduler. Abo
+00043260: 7274 696e 6720 7265 7363 6865 6475 6c65  rting reschedule
+00043270: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00043280: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00043290: 7572 6e0a 2020 2020 2020 2020 6966 2074  urn.        if t
+000432a0: 732e 7374 6174 6520 213d 2022 7072 6f63  s.state != "proc
+000432b0: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
+000432c0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+000432d0: 2020 2020 6966 2077 6f72 6b65 7220 616e      if worker an
+000432e0: 6420 7473 2e70 726f 6365 7373 696e 675f  d ts.processing_
+000432f0: 6f6e 2061 6e64 2074 732e 7072 6f63 6573  on and ts.proces
+00043300: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
+00043310: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
+00043320: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00043330: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00043340: 6f6e 5f70 726f 6365 7373 696e 675f 7265  on_processing_re
+00043350: 6c65 6173 6564 2077 696c 6c20 696d 6d65  leased will imme
+00043360: 6469 6174 656c 7920 7375 6767 6573 7420  diately suggest 
+00043370: 616e 2061 6464 6974 696f 6e61 6c0a 2020  an additional.  
+00043380: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00043390: 6f6e 2074 6f20 7761 6974 696e 6720 6966  on to waiting if
+000433a0: 2074 6865 2074 6173 6b20 6861 7320 616e   the task has an
+000433b0: 7920 7761 6974 6572 7320 6f72 2063 6c69  y waiters or cli
+000433c0: 656e 7473 2068 6f6c 6469 6e67 2061 2066  ents holding a f
+000433d0: 7574 7572 652e 0a20 2020 2020 2020 2073  uture..        s
+000433e0: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
+000433f0: 7b6b 6579 3a20 2272 656c 6561 7365 6422  {key: "released"
+00043400: 7d2c 2073 7469 6d75 6c75 735f 6964 3d73  }, stimulus_id=s
+00043410: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+00043420: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00043430: 2323 2323 2323 0a20 2020 2023 2055 7469  ######.    # Uti
+00043440: 6c69 7479 2066 756e 6374 696f 6e73 2023  lity functions #
+00043450: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00043460: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+00043470: 6465 6620 6164 645f 7265 736f 7572 6365  def add_resource
+00043480: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00043490: 2077 6f72 6b65 723a 2073 7472 2c20 7265   worker: str, re
+000434a0: 736f 7572 6365 733a 2064 6963 7420 7c20  sources: dict | 
+000434b0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+000434c0: 2920 2d3e 204c 6974 6572 616c 5b22 4f4b  ) -> Literal["OK
+000434d0: 225d 3a0a 2020 2020 2020 2020 7773 3a20  "]:.        ws: 
+000434e0: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
+000434f0: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
+00043500: 725d 0a20 2020 2020 2020 2069 6620 7265  r].        if re
+00043510: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
+00043520: 2020 2020 2077 732e 7265 736f 7572 6365       ws.resource
+00043530: 732e 7570 6461 7465 2872 6573 6f75 7263  s.update(resourc
+00043540: 6573 290a 2020 2020 2020 2020 7773 2e75  es).        ws.u
+00043550: 7365 645f 7265 736f 7572 6365 7320 3d20  sed_resources = 
+00043560: 7b7d 0a20 2020 2020 2020 2066 6f72 2072  {}.        for r
+00043570: 6573 6f75 7263 652c 2071 7561 6e74 6974  esource, quantit
+00043580: 7920 696e 2077 732e 7265 736f 7572 6365  y in ws.resource
+00043590: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+000435a0: 2020 2020 2020 2077 732e 7573 6564 5f72         ws.used_r
+000435b0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
+000435c0: 655d 203d 2030 0a20 2020 2020 2020 2020  e] = 0.         
+000435d0: 2020 2064 7220 3d20 7365 6c66 2e72 6573     dr = self.res
+000435e0: 6f75 7263 6573 2e67 6574 2872 6573 6f75  ources.get(resou
+000435f0: 7263 652c 204e 6f6e 6529 0a20 2020 2020  rce, None).     
+00043600: 2020 2020 2020 2069 6620 6472 2069 7320         if dr is 
+00043610: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00043620: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
+00043630: 7263 6573 5b72 6573 6f75 7263 655d 203d  rces[resource] =
+00043640: 2064 7220 3d20 7b7d 0a20 2020 2020 2020   dr = {}.       
+00043650: 2020 2020 2064 725b 776f 726b 6572 5d20       dr[worker] 
+00043660: 3d20 7175 616e 7469 7479 0a20 2020 2020  = quantity.     
+00043670: 2020 2072 6574 7572 6e20 224f 4b22 0a0a     return "OK"..
+00043680: 2020 2020 6465 6620 7265 6d6f 7665 5f72      def remove_r
+00043690: 6573 6f75 7263 6573 2873 656c 662c 2077  esources(self, w
+000436a0: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
+000436b0: 6f6e 653a 0a20 2020 2020 2020 2077 733a  one:.        ws:
+000436c0: 2057 6f72 6b65 7253 7461 7465 203d 2073   WorkerState = s
+000436d0: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
+000436e0: 6572 5d0a 2020 2020 2020 2020 666f 7220  er].        for 
+000436f0: 7265 736f 7572 6365 2069 6e20 7773 2e72  resource in ws.r
+00043700: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
+00043710: 2020 2020 2020 6472 203d 2073 656c 662e        dr = self.
+00043720: 7265 736f 7572 6365 732e 7365 7464 6566  resources.setdef
+00043730: 6175 6c74 2872 6573 6f75 7263 652c 207b  ault(resource, {
+00043740: 7d29 0a20 2020 2020 2020 2020 2020 2064  }).            d
+00043750: 656c 2064 725b 776f 726b 6572 5d0a 0a20  el dr[worker].. 
+00043760: 2020 2064 6566 2063 6f65 7263 655f 6164     def coerce_ad
+00043770: 6472 6573 7328 7365 6c66 2c20 6164 6472  dress(self, addr
+00043780: 3a20 7374 7220 7c20 7475 706c 652c 2072  : str | tuple, r
+00043790: 6573 6f6c 7665 3a20 626f 6f6c 203d 2054  esolve: bool = T
+000437a0: 7275 6529 202d 3e20 7374 723a 0a20 2020  rue) -> str:.   
+000437b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000437c0: 2043 6f65 7263 6520 706f 7373 6962 6c65   Coerce possible
+000437d0: 2069 6e70 7574 2061 6464 7265 7373 6573   input addresses
+000437e0: 2074 6f20 6361 6e6f 6e69 6361 6c20 666f   to canonical fo
+000437f0: 726d 2e0a 2020 2020 2020 2020 2a72 6573  rm..        *res
+00043800: 6f6c 7665 2a20 6361 6e20 6265 2064 6973  olve* can be dis
+00043810: 6162 6c65 6420 666f 7220 7465 7374 696e  abled for testin
+00043820: 6720 7769 7468 2066 616b 6520 686f 7374  g with fake host
+00043830: 6e61 6d65 732e 0a0a 2020 2020 2020 2020  names...        
+00043840: 4861 6e64 6c65 7320 7374 7269 6e67 732c  Handles strings,
+00043850: 2074 7570 6c65 732c 206f 7220 616c 6961   tuples, or alia
+00043860: 7365 732e 0a20 2020 2020 2020 2022 2222  ses..        """
+00043870: 0a20 2020 2020 2020 2023 2058 5858 2068  .        # XXX h
+00043880: 6f77 206d 616e 7920 6164 6472 6573 732d  ow many address-
+00043890: 7061 7273 696e 6720 726f 7574 696e 6573  parsing routines
+000438a0: 2064 6f20 7765 2068 6176 653f 0a20 2020   do we have?.   
+000438b0: 2020 2020 2069 6620 6164 6472 2069 6e20       if addr in 
+000438c0: 7365 6c66 2e61 6c69 6173 6573 3a0a 2020  self.aliases:.  
+000438d0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+000438e0: 2073 656c 662e 616c 6961 7365 735b 6164   self.aliases[ad
+000438f0: 6472 5d0a 2020 2020 2020 2020 6966 2069  dr].        if i
+00043900: 7369 6e73 7461 6e63 6528 6164 6472 2c20  sinstance(addr, 
+00043910: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
+00043920: 2020 2020 6164 6472 203d 2075 6e70 6172      addr = unpar
+00043930: 7365 5f68 6f73 745f 706f 7274 282a 6164  se_host_port(*ad
+00043940: 6472 290a 2020 2020 2020 2020 6966 206e  dr).        if n
+00043950: 6f74 2069 7369 6e73 7461 6e63 6528 6164  ot isinstance(ad
+00043960: 6472 2c20 7374 7229 3a0a 2020 2020 2020  dr, str):.      
+00043970: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00043980: 4572 726f 7228 6622 6164 6472 6573 7365  Error(f"addresse
+00043990: 7320 7368 6f75 6c64 2062 6520 7374 7269  s should be stri
+000439a0: 6e67 7320 6f72 2074 7570 6c65 732c 2067  ngs or tuples, g
+000439b0: 6f74 207b 6164 6472 2172 7d22 290a 0a20  ot {addr!r}").. 
+000439c0: 2020 2020 2020 2069 6620 7265 736f 6c76         if resolv
+000439d0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+000439e0: 6464 7220 3d20 7265 736f 6c76 655f 6164  ddr = resolve_ad
+000439f0: 6472 6573 7328 6164 6472 290a 2020 2020  dress(addr).    
+00043a00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00043a10: 2020 2020 2020 6164 6472 203d 206e 6f72        addr = nor
+00043a20: 6d61 6c69 7a65 5f61 6464 7265 7373 2861  malize_address(a
+00043a30: 6464 7229 0a0a 2020 2020 2020 2020 7265  ddr)..        re
+00043a40: 7475 726e 2061 6464 720a 0a20 2020 2064  turn addr..    d
+00043a50: 6566 2077 6f72 6b65 7273 5f6c 6973 7428  ef workers_list(
+00043a60: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
+00043a70: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
+00043a80: 6f6e 6529 202d 3e20 6c69 7374 5b73 7472  one) -> list[str
+00043a90: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+00043aa0: 2020 2020 2020 204c 6973 7420 6f66 2071         List of q
+00043ab0: 7561 6c69 6679 696e 6720 776f 726b 6572  ualifying worker
+00043ac0: 730a 0a20 2020 2020 2020 2054 616b 6573  s..        Takes
+00043ad0: 2061 206c 6973 7420 6f66 2077 6f72 6b65   a list of worke
+00043ae0: 7220 6164 6472 6573 7365 7320 6f72 2068  r addresses or h
+00043af0: 6f73 746e 616d 6573 2e0a 2020 2020 2020  ostnames..      
+00043b00: 2020 5265 7475 726e 7320 6120 6c69 7374    Returns a list
+00043b10: 206f 6620 616c 6c20 776f 726b 6572 2061   of all worker a
+00043b20: 6464 7265 7373 6573 2074 6861 7420 6d61  ddresses that ma
+00043b30: 7463 680a 2020 2020 2020 2020 2222 220a  tch.        """.
+00043b40: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00043b50: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
+00043b60: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00043b70: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
+00043b80: 290a 0a20 2020 2020 2020 206f 7574 203d  )..        out =
+00043b90: 2073 6574 2829 0a20 2020 2020 2020 2066   set().        f
+00043ba0: 6f72 2077 2069 6e20 776f 726b 6572 733a  or w in workers:
+00043bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00043bc0: 223a 2220 696e 2077 3a0a 2020 2020 2020  ":" in w:.      
+00043bd0: 2020 2020 2020 2020 2020 6f75 742e 6164            out.ad
+00043be0: 6428 7729 0a20 2020 2020 2020 2020 2020  d(w).           
+00043bf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00043c00: 2020 2020 2020 206f 7574 2e75 7064 6174         out.updat
+00043c10: 6528 7b77 7720 666f 7220 7777 2069 6e20  e({ww for ww in 
+00043c20: 7365 6c66 2e77 6f72 6b65 7273 2069 6620  self.workers if 
+00043c30: 7720 696e 2077 777d 2920 2023 2054 4f44  w in ww})  # TOD
+00043c40: 4f3a 2071 7561 6472 6174 6963 0a20 2020  O: quadratic.   
+00043c50: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
+00043c60: 286f 7574 290a 0a20 2020 2061 7379 6e63  (out)..    async
+00043c70: 2064 6566 2067 6574 5f70 726f 6669 6c65   def get_profile
+00043c80: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00043c90: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
+00043ca0: 652c 0a20 2020 2020 2020 2077 6f72 6b65  e,.        worke
+00043cb0: 7273 3d4e 6f6e 652c 0a20 2020 2020 2020  rs=None,.       
+00043cc0: 2073 6368 6564 756c 6572 3d46 616c 7365   scheduler=False
+00043cd0: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
+00043ce0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00043cf0: 6d65 7267 655f 776f 726b 6572 733d 5472  merge_workers=Tr
+00043d00: 7565 2c0a 2020 2020 2020 2020 7374 6172  ue,.        star
+00043d10: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
+00043d20: 7374 6f70 3d4e 6f6e 652c 0a20 2020 2020  stop=None,.     
+00043d30: 2020 206b 6579 3d4e 6f6e 652c 0a20 2020     key=None,.   
+00043d40: 2029 3a0a 2020 2020 2020 2020 6966 2077   ):.        if w
+00043d50: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+00043d60: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00043d70: 6572 7320 3d20 7365 6c66 2e77 6f72 6b65  ers = self.worke
+00043d80: 7273 0a20 2020 2020 2020 2065 6c73 653a  rs.        else:
+00043d90: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+00043da0: 6b65 7273 203d 2073 6574 2873 656c 662e  kers = set(self.
+00043db0: 776f 726b 6572 7329 2026 2073 6574 2877  workers) & set(w
+00043dc0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+00043dd0: 2069 6620 7363 6865 6475 6c65 723a 0a20   if scheduler:. 
+00043de0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00043df0: 6e20 7072 6f66 696c 652e 6765 745f 7072  n profile.get_pr
+00043e00: 6f66 696c 6528 7365 6c66 2e69 6f5f 6c6f  ofile(self.io_lo
+00043e10: 6f70 2e70 726f 6669 6c65 2c20 7374 6172  op.profile, star
+00043e20: 743d 7374 6172 742c 2073 746f 703d 7374  t=start, stop=st
+00043e30: 6f70 290a 0a20 2020 2020 2020 2072 6573  op)..        res
+00043e40: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
+00043e50: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+00043e60: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
+00043e70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00043e80: 2e72 7063 2877 292e 7072 6f66 696c 6528  .rpc(w).profile(
+00043e90: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
+00043ea0: 703d 7374 6f70 2c20 6b65 793d 6b65 792c  p=stop, key=key,
+00043eb0: 2073 6572 7665 723d 7365 7276 6572 290a   server=server).
+00043ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043ed0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+00043ee0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00043ef0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00043f00: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
+00043f10: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
+00043f20: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+00043f30: 205b 7220 666f 7220 7220 696e 2072 6573   [r for r in res
+00043f40: 756c 7473 2069 6620 6e6f 7420 6973 696e  ults if not isin
+00043f50: 7374 616e 6365 2872 2c20 4578 6365 7074  stance(r, Except
+00043f60: 696f 6e29 5d0a 0a20 2020 2020 2020 2069  ion)]..        i
+00043f70: 6620 6d65 7267 655f 776f 726b 6572 733a  f merge_workers:
+00043f80: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00043f90: 706f 6e73 6520 3d20 7072 6f66 696c 652e  ponse = profile.
+00043fa0: 6d65 7267 6528 2a72 6573 756c 7473 290a  merge(*results).
+00043fb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00043fc0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00043fd0: 7365 203d 2064 6963 7428 7a69 7028 776f  se = dict(zip(wo
+00043fe0: 726b 6572 732c 2072 6573 756c 7473 2929  rkers, results))
+00043ff0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00044000: 7265 7370 6f6e 7365 0a0a 2020 2020 6173  response..    as
+00044010: 796e 6320 6465 6620 6765 745f 7072 6f66  ync def get_prof
+00044020: 696c 655f 6d65 7461 6461 7461 280a 2020  ile_metadata(.  
+00044030: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00044040: 2020 2020 776f 726b 6572 733a 2022 4974      workers: "It
+00044050: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00044060: 6e65 2220 3d20 4e6f 6e65 2c0a 2020 2020  ne" = None,.    
+00044070: 2020 2020 7374 6172 743a 2066 6c6f 6174      start: float
+00044080: 203d 2030 2c0a 2020 2020 2020 2020 7374   = 0,.        st
+00044090: 6f70 3a20 2266 6c6f 6174 207c 204e 6f6e  op: "float | Non
+000440a0: 6522 203d 204e 6f6e 652c 0a20 2020 2020  e" = None,.     
+000440b0: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
+000440c0: 5f69 6e74 6572 7661 6c3a 2022 7374 7220  _interval: "str 
+000440d0: 7c20 666c 6f61 7420 7c20 4e6f 6e65 2220  | float | None" 
+000440e0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+000440f0: 2064 6963 743a 0a20 2020 2020 2020 2064   dict:.        d
+00044100: 7420 3d20 7072 6f66 696c 655f 6379 636c  t = profile_cycl
+00044110: 655f 696e 7465 7276 616c 206f 7220 6461  e_interval or da
+00044120: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+00044130: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+00044140: 7269 6275 7465 642e 776f 726b 6572 2e70  ributed.worker.p
+00044150: 726f 6669 6c65 2e63 7963 6c65 220a 2020  rofile.cycle".  
+00044160: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00044170: 6474 203d 2070 6172 7365 5f74 696d 6564  dt = parse_timed
+00044180: 656c 7461 2864 742c 2064 6566 6175 6c74  elta(dt, default
+00044190: 3d22 6d73 2229 0a0a 2020 2020 2020 2020  ="ms")..        
+000441a0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
+000441b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000441c0: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
+000441d0: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
+000441e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000441f0: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
+00044200: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
+00044210: 6574 2877 6f72 6b65 7273 290a 2020 2020  et(workers).    
+00044220: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
+00044230: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00044240: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00044250: 2a28 7365 6c66 2e72 7063 2877 292e 7072  *(self.rpc(w).pr
+00044260: 6f66 696c 655f 6d65 7461 6461 7461 2873  ofile_metadata(s
+00044270: 7461 7274 3d73 7461 7274 2c20 7374 6f70  tart=start, stop
+00044280: 3d73 746f 7029 2066 6f72 2077 2069 6e20  =stop) for w in 
+00044290: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
+000442a0: 2020 2020 2020 7265 7475 726e 5f65 7863        return_exc
+000442b0: 6570 7469 6f6e 733d 5472 7565 2c0a 2020  eptions=True,.  
+000442c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000442d0: 2072 6573 756c 7473 203d 205b 7220 666f   results = [r fo
+000442e0: 7220 7220 696e 2072 6573 756c 7473 2069  r r in results i
+000442f0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00044300: 2872 2c20 4578 6365 7074 696f 6e29 5d0a  (r, Exception)].
+00044310: 2020 2020 2020 2020 636f 756e 7473 203d          counts =
+00044320: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00044330: 7469 6d65 2c20 7375 6d28 706c 7563 6b28  time, sum(pluck(
+00044340: 312c 2067 726f 7570 2929 290a 2020 2020  1, group))).    
+00044350: 2020 2020 2020 2020 666f 7220 7469 6d65          for time
+00044360: 2c20 6772 6f75 7020 696e 2069 7465 7274  , group in itert
+00044370: 6f6f 6c73 2e67 726f 7570 6279 280a 2020  ools.groupby(.  
+00044380: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00044390: 7267 655f 736f 7274 6564 280a 2020 2020  rge_sorted(.    
+000443a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000443b0: 2a28 765b 2263 6f75 6e74 7322 5d20 666f  *(v["counts"] fo
+000443c0: 7220 7620 696e 2072 6573 756c 7473 292c  r v in results),
+000443d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000443e0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+000443f0: 2020 2020 6c61 6d62 6461 2074 3a20 745b      lambda t: t[
+00044400: 305d 202f 2f20 6474 202a 2064 742c 0a20  0] // dt * dt,. 
+00044410: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00044420: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00044430: 6b65 7973 3a20 6469 6374 5b73 7472 2c20  keys: dict[str, 
+00044440: 6c69 7374 5b6c 6973 745d 5d20 3d20 7b0a  list[list]] = {.
+00044450: 2020 2020 2020 2020 2020 2020 6b3a 205b              k: [
+00044460: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
+00044470: 7473 2066 6f72 2074 2c20 6420 696e 2076  ts for t, d in v
+00044480: 5b22 6b65 7973 225d 2066 6f72 206b 2069  ["keys"] for k i
+00044490: 6e20 640a 2020 2020 2020 2020 7d0a 0a20  n d.        }.. 
+000444a0: 2020 2020 2020 2067 726f 7570 7331 203d         groups1 =
+000444b0: 205b 765b 226b 6579 7322 5d20 666f 7220   [v["keys"] for 
+000444c0: 7620 696e 2072 6573 756c 7473 5d0a 2020  v in results].  
+000444d0: 2020 2020 2020 6772 6f75 7073 3220 3d20        groups2 = 
+000444e0: 6c69 7374 286d 6572 6765 5f73 6f72 7465  list(merge_sorte
+000444f0: 6428 2a67 726f 7570 7331 2c20 6b65 793d  d(*groups1, key=
+00044500: 6669 7273 7429 290a 0a20 2020 2020 2020  first))..       
+00044510: 206c 6173 7420 3d20 300a 2020 2020 2020   last = 0.      
+00044520: 2020 666f 7220 742c 2064 2069 6e20 6772    for t, d in gr
+00044530: 6f75 7073 323a 0a20 2020 2020 2020 2020  oups2:.         
+00044540: 2020 2074 7420 3d20 7420 2f2f 2064 7420     tt = t // dt 
+00044550: 2a20 6474 0a20 2020 2020 2020 2020 2020  * dt.           
+00044560: 2069 6620 7474 203e 206c 6173 743a 0a20   if tt > last:. 
+00044570: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00044580: 6173 7420 3d20 7474 0a20 2020 2020 2020  ast = tt.       
+00044590: 2020 2020 2020 2020 2066 6f72 2076 2069           for v i
+000445a0: 6e20 6b65 7973 2e76 616c 7565 7328 293a  n keys.values():
+000445b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000445c0: 2020 2020 2076 2e61 7070 656e 6428 5b74       v.append([t
+000445d0: 742c 2030 5d29 0a20 2020 2020 2020 2020  t, 0]).         
+000445e0: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
+000445f0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00044600: 2020 2020 2020 2020 2020 6b65 7973 5b6b            keys[k
+00044610: 5d5b 2d31 5d5b 315d 202b 3d20 760a 0a20  ][-1][1] += v.. 
+00044620: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00044630: 636f 756e 7473 223a 2063 6f75 6e74 732c  counts": counts,
+00044640: 2022 6b65 7973 223a 206b 6579 737d 0a0a   "keys": keys}..
+00044650: 2020 2020 6173 796e 6320 6465 6620 7065      async def pe
+00044660: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
+00044670: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00044680: 7374 6172 743a 2066 6c6f 6174 2c20 6c61  start: float, la
+00044690: 7374 5f63 6f75 6e74 3a20 696e 742c 2063  st_count: int, c
+000446a0: 6f64 653a 2073 7472 203d 2022 222c 206d  ode: str = "", m
+000446b0: 6f64 653a 2073 7472 207c 204e 6f6e 6520  ode: str | None 
+000446c0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+000446d0: 7374 723a 0a20 2020 2020 2020 2073 746f  str:.        sto
+000446e0: 7020 3d20 7469 6d65 2829 0a20 2020 2020  p = time().     
+000446f0: 2020 2023 2050 726f 6669 6c65 730a 2020     # Profiles.  
+00044700: 2020 2020 2020 636f 6d70 7574 652c 2073        compute, s
+00044710: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
+00044720: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00044730: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00044740: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
+00044750: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+00044760: 745f 7072 6f66 696c 6528 7374 6172 743d  t_profile(start=
+00044770: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
+00044780: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+00044790: 5f70 726f 6669 6c65 2873 6368 6564 756c  _profile(schedul
+000447a0: 6572 3d54 7275 652c 2073 7461 7274 3d73  er=True, start=s
+000447b0: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
+000447c0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
+000447d0: 7072 6f66 696c 6528 7365 7276 6572 3d54  profile(server=T
+000447e0: 7275 652c 2073 7461 7274 3d73 7461 7274  rue, start=start
+000447f0: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
+00044800: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00044810: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00044820: 7465 6420 696d 706f 7274 2070 726f 6669  ted import profi
+00044830: 6c65 0a0a 2020 2020 2020 2020 6465 6620  le..        def 
+00044840: 7072 6f66 696c 655f 746f 5f66 6967 7572  profile_to_figur
+00044850: 6528 7374 6174 6529 3a0a 2020 2020 2020  e(state):.      
+00044860: 2020 2020 2020 6461 7461 203d 2070 726f        data = pro
+00044870: 6669 6c65 2e70 6c6f 745f 6461 7461 2873  file.plot_data(s
+00044880: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
+00044890: 2020 6669 6775 7265 2c20 736f 7572 6365    figure, source
+000448a0: 203d 2070 726f 6669 6c65 2e70 6c6f 745f   = profile.plot_
+000448b0: 6669 6775 7265 2864 6174 612c 2073 697a  figure(data, siz
+000448c0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+000448d0: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
+000448e0: 2020 2020 2072 6574 7572 6e20 6669 6775       return figu
+000448f0: 7265 0a0a 2020 2020 2020 2020 636f 6d70  re..        comp
+00044900: 7574 652c 2073 6368 6564 756c 6572 2c20  ute, scheduler, 
+00044910: 776f 726b 6572 7320 3d20 6d61 7028 0a20  workers = map(. 
+00044920: 2020 2020 2020 2020 2020 2070 726f 6669             profi
+00044930: 6c65 5f74 6f5f 6669 6775 7265 2c20 2863  le_to_figure, (c
+00044940: 6f6d 7075 7465 2c20 7363 6865 6475 6c65  ompute, schedule
+00044950: 722c 2077 6f72 6b65 7273 290a 2020 2020  r, workers).    
+00044960: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00044970: 2054 6173 6b20 7374 7265 616d 0a20 2020   Task stream.   
+00044980: 2020 2020 2074 6173 6b5f 7374 7265 616d       task_stream
+00044990: 203d 2073 656c 662e 6765 745f 7461 736b   = self.get_task
+000449a0: 5f73 7472 6561 6d28 7374 6172 743d 7374  _stream(start=st
+000449b0: 6172 7429 0a20 2020 2020 2020 2074 6f74  art).        tot
+000449c0: 616c 5f74 6173 6b73 203d 206c 656e 2874  al_tasks = len(t
+000449d0: 6173 6b5f 7374 7265 616d 290a 2020 2020  ask_stream).    
+000449e0: 2020 2020 7469 6d65 7370 656e 743a 2064      timespent: d
+000449f0: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+00044a00: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
+00044a10: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+00044a20: 2020 2020 666f 7220 6420 696e 2074 6173      for d in tas
+00044a30: 6b5f 7374 7265 616d 3a0a 2020 2020 2020  k_stream:.      
+00044a40: 2020 2020 2020 666f 7220 7820 696e 2064        for x in d
+00044a50: 5b22 7374 6172 7473 746f 7073 225d 3a0a  ["startstops"]:.
+00044a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044a70: 7469 6d65 7370 656e 745b 785b 2261 6374  timespent[x["act
+00044a80: 696f 6e22 5d5d 202b 3d20 785b 2273 746f  ion"]] += x["sto
+00044a90: 7022 5d20 2d20 785b 2273 7461 7274 225d  p"] - x["start"]
+00044aa0: 0a20 2020 2020 2020 2074 6173 6b73 5f74  .        tasks_t
+00044ab0: 696d 696e 6773 203d 2022 220a 2020 2020  imings = "".    
+00044ac0: 2020 2020 666f 7220 6b20 696e 2073 6f72      for k in sor
+00044ad0: 7465 6428 7469 6d65 7370 656e 742e 6b65  ted(timespent.ke
+00044ae0: 7973 2829 293a 0a20 2020 2020 2020 2020  ys()):.         
+00044af0: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
+00044b00: 202b 3d20 6622 5c6e 3c6c 693e 207b 6b7d   += f"\n<li> {k}
+00044b10: 2074 696d 653a 207b 666f 726d 6174 5f74   time: {format_t
+00044b20: 696d 6528 7469 6d65 7370 656e 745b 6b5d  ime(timespent[k]
+00044b30: 297d 203c 2f6c 693e 220a 0a20 2020 2020  )} </li>"..     
+00044b40: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00044b50: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
+00044b60: 6d70 6f6e 656e 7473 2e73 6368 6564 756c  mponents.schedul
+00044b70: 6572 2069 6d70 6f72 7420 7461 736b 5f73  er import task_s
+00044b80: 7472 6561 6d5f 6669 6775 7265 0a20 2020  tream_figure.   
+00044b90: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
+00044ba0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
+00044bb0: 732e 7461 736b 5f73 7472 6561 6d20 696d  s.task_stream im
+00044bc0: 706f 7274 2072 6563 7461 6e67 6c65 730a  port rectangles.
+00044bd0: 0a20 2020 2020 2020 2072 6563 7473 203d  .        rects =
+00044be0: 2072 6563 7461 6e67 6c65 7328 7461 736b   rectangles(task
+00044bf0: 5f73 7472 6561 6d29 0a20 2020 2020 2020  _stream).       
+00044c00: 2073 6f75 7263 652c 2074 6173 6b5f 7374   source, task_st
+00044c10: 7265 616d 203d 2074 6173 6b5f 7374 7265  ream = task_stre
+00044c20: 616d 5f66 6967 7572 6528 7369 7a69 6e67  am_figure(sizing
+00044c30: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+00044c40: 6f74 6822 290a 2020 2020 2020 2020 736f  oth").        so
+00044c50: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
+00044c60: 2872 6563 7473 290a 0a20 2020 2020 2020  (rects)..       
+00044c70: 2023 2042 616e 6477 6964 7468 0a20 2020   # Bandwidth.   
+00044c80: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
+00044c90: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
+00044ca0: 636f 6d70 6f6e 656e 7473 2e73 6368 6564  components.sched
+00044cb0: 756c 6572 2069 6d70 6f72 7420 280a 2020  uler import (.  
+00044cc0: 2020 2020 2020 2020 2020 4261 6e64 7769            Bandwi
+00044cd0: 6474 6854 7970 6573 2c0a 2020 2020 2020  dthTypes,.      
+00044ce0: 2020 2020 2020 4261 6e64 7769 6474 6857        BandwidthW
+00044cf0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+00044d00: 290a 0a20 2020 2020 2020 2062 616e 6477  )..        bandw
+00044d10: 6964 7468 5f77 6f72 6b65 7273 203d 2042  idth_workers = B
+00044d20: 616e 6477 6964 7468 576f 726b 6572 7328  andwidthWorkers(
+00044d30: 7365 6c66 2c20 7369 7a69 6e67 5f6d 6f64  self, sizing_mod
+00044d40: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00044d50: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
+00044d60: 6474 685f 776f 726b 6572 732e 7570 6461  dth_workers.upda
+00044d70: 7465 2829 0a20 2020 2020 2020 2062 616e  te().        ban
+00044d80: 6477 6964 7468 5f74 7970 6573 203d 2042  dwidth_types = B
+00044d90: 616e 6477 6964 7468 5479 7065 7328 7365  andwidthTypes(se
+00044da0: 6c66 2c20 7369 7a69 6e67 5f6d 6f64 653d  lf, sizing_mode=
+00044db0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+00044dc0: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
+00044dd0: 685f 7479 7065 732e 7570 6461 7465 2829  h_types.update()
+00044de0: 0a0a 2020 2020 2020 2020 2320 5379 7374  ..        # Syst
+00044df0: 656d 206d 6f6e 6974 6f72 0a20 2020 2020  em monitor.     
+00044e00: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00044e10: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
+00044e20: 6d70 6f6e 656e 7473 2e73 6861 7265 6420  mponents.shared 
+00044e30: 696d 706f 7274 2053 7973 7465 6d4d 6f6e  import SystemMon
+00044e40: 6974 6f72 0a0a 2020 2020 2020 2020 7379  itor..        sy
+00044e50: 736d 6f6e 203d 2053 7973 7465 6d4d 6f6e  smon = SystemMon
+00044e60: 6974 6f72 2873 656c 662c 206c 6173 745f  itor(self, last_
+00044e70: 636f 756e 743d 6c61 7374 5f63 6f75 6e74  count=last_count
+00044e80: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+00044e90: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
+00044ea0: 2020 2020 2020 7379 736d 6f6e 2e75 7064        sysmon.upd
+00044eb0: 6174 6528 290a 0a20 2020 2020 2020 2023  ate()..        #
+00044ec0: 2053 6368 6564 756c 6572 206c 6f67 730a   Scheduler logs.
+00044ed0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
+00044ee0: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
+00044ef0: 7264 2e63 6f6d 706f 6e65 6e74 732e 7363  rd.components.sc
+00044f00: 6865 6475 6c65 7220 696d 706f 7274 2028  heduler import (
+00044f10: 0a20 2020 2020 2020 2020 2020 205f 424f  .            _BO
+00044f20: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
+00044f30: 532c 0a20 2020 2020 2020 2020 2020 2053  S,.            S
+00044f40: 6368 6564 756c 6572 4c6f 6773 2c0a 2020  chedulerLogs,.  
+00044f50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00044f60: 206c 6f67 7320 3d20 5363 6865 6475 6c65   logs = Schedule
+00044f70: 724c 6f67 7328 7365 6c66 2c20 7374 6172  rLogs(self, star
+00044f80: 743d 7374 6172 7429 0a0a 2020 2020 2020  t=start)..      
+00044f90: 2020 6672 6f6d 2062 6f6b 6568 2e6d 6f64    from bokeh.mod
+00044fa0: 656c 7320 696d 706f 7274 2044 6976 2c20  els import Div, 
+00044fb0: 5461 6273 0a0a 2020 2020 2020 2020 696d  Tabs..        im
+00044fc0: 706f 7274 2064 6973 7472 6962 7574 6564  port distributed
+00044fd0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00044fe0: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00044ff0: 6172 642e 636f 7265 2069 6d70 6f72 7420  ard.core import 
+00045000: 5461 6250 616e 656c 0a0a 2020 2020 2020  TabPanel..      
+00045010: 2020 2320 4854 4d4c 0a20 2020 2020 2020    # HTML.       
+00045020: 2068 746d 6c20 3d20 2222 220a 2020 2020   html = """.    
+00045030: 2020 2020 3c68 313e 2044 6173 6b20 5065      <h1> Dask Pe
+00045040: 7266 6f72 6d61 6e63 6520 5265 706f 7274  rformance Report
+00045050: 203c 2f68 313e 0a0a 2020 2020 2020 2020   </h1>..        
+00045060: 3c69 3e20 5365 6c65 6374 2064 6966 6665  <i> Select diffe
+00045070: 7265 6e74 2074 6162 7320 6f6e 2074 6865  rent tabs on the
+00045080: 2074 6f70 2066 6f72 2061 6464 6974 696f   top for additio
+00045090: 6e61 6c20 696e 666f 726d 6174 696f 6e20  nal information 
+000450a0: 3c2f 693e 0a0a 2020 2020 2020 2020 3c68  </i>..        <h
+000450b0: 323e 2044 7572 6174 696f 6e3a 207b 7469  2> Duration: {ti
+000450c0: 6d65 7d20 3c2f 6832 3e0a 2020 2020 2020  me} </h2>.      
+000450d0: 2020 3c68 323e 2054 6173 6b73 2049 6e66    <h2> Tasks Inf
+000450e0: 6f72 6d61 7469 6f6e 203c 2f68 323e 0a20  ormation </h2>. 
+000450f0: 2020 2020 2020 203c 756c 3e0a 2020 2020         <ul>.    
+00045100: 2020 2020 203c 6c69 3e20 6e75 6d62 6572       <li> number
+00045110: 206f 6620 7461 736b 733a 207b 6e74 6173   of tasks: {ntas
+00045120: 6b73 7d20 3c2f 6c69 3e0a 2020 2020 2020  ks} </li>.      
+00045130: 2020 207b 7461 736b 735f 7469 6d69 6e67     {tasks_timing
+00045140: 737d 0a20 2020 2020 2020 203c 2f75 6c3e  s}.        </ul>
+00045150: 0a0a 2020 2020 2020 2020 3c68 323e 2053  ..        <h2> S
+00045160: 6368 6564 756c 6572 2049 6e66 6f72 6d61  cheduler Informa
+00045170: 7469 6f6e 203c 2f68 323e 0a20 2020 2020  tion </h2>.     
+00045180: 2020 203c 756c 3e0a 2020 2020 2020 2020     <ul>.        
+00045190: 2020 3c6c 693e 2041 6464 7265 7373 3a20    <li> Address: 
+000451a0: 7b61 6464 7265 7373 7d20 3c2f 6c69 3e0a  {address} </li>.
+000451b0: 2020 2020 2020 2020 2020 3c6c 693e 2057            <li> W
+000451c0: 6f72 6b65 7273 3a20 7b6e 776f 726b 6572  orkers: {nworker
+000451d0: 737d 203c 2f6c 693e 0a20 2020 2020 2020  s} </li>.       
+000451e0: 2020 203c 6c69 3e20 5468 7265 6164 733a     <li> Threads:
+000451f0: 207b 7468 7265 6164 737d 203c 2f6c 693e   {threads} </li>
+00045200: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
+00045210: 4d65 6d6f 7279 3a20 7b6d 656d 6f72 797d  Memory: {memory}
+00045220: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
+00045230: 203c 6c69 3e20 4461 736b 2056 6572 7369   <li> Dask Versi
+00045240: 6f6e 3a20 7b64 6173 6b5f 7665 7273 696f  on: {dask_versio
+00045250: 6e7d 203c 2f6c 693e 0a20 2020 2020 2020  n} </li>.       
+00045260: 2020 203c 6c69 3e20 4461 736b 2e44 6973     <li> Dask.Dis
+00045270: 7472 6962 7574 6564 2056 6572 7369 6f6e  tributed Version
+00045280: 3a20 7b64 6973 7472 6962 7574 6564 5f76  : {distributed_v
+00045290: 6572 7369 6f6e 7d20 3c2f 6c69 3e0a 2020  ersion} </li>.  
+000452a0: 2020 2020 2020 3c2f 756c 3e0a 0a20 2020        </ul>..   
+000452b0: 2020 2020 203c 6832 3e20 4361 6c6c 696e       <h2> Callin
+000452c0: 6720 436f 6465 203c 2f68 323e 0a20 2020  g Code </h2>.   
+000452d0: 2020 2020 203c 7072 653e 0a7b 636f 6465       <pre>.{code
+000452e0: 7d0a 2020 2020 2020 2020 3c2f 7072 653e  }.        </pre>
+000452f0: 0a20 2020 2020 2020 2022 2222 2e66 6f72  .        """.for
+00045300: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00045310: 2074 696d 653d 666f 726d 6174 5f74 696d   time=format_tim
+00045320: 6528 7374 6f70 202d 2073 7461 7274 292c  e(stop - start),
+00045330: 0a20 2020 2020 2020 2020 2020 206e 7461  .            nta
+00045340: 736b 733d 746f 7461 6c5f 7461 736b 732c  sks=total_tasks,
+00045350: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+00045360: 6b73 5f74 696d 696e 6773 3d74 6173 6b73  ks_timings=tasks
+00045370: 5f74 696d 696e 6773 2c0a 2020 2020 2020  _timings,.      
+00045380: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
+00045390: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
+000453a0: 2020 2020 2020 2020 6e77 6f72 6b65 7273          nworkers
+000453b0: 3d6c 656e 2873 656c 662e 776f 726b 6572  =len(self.worker
+000453c0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000453d0: 7468 7265 6164 733d 7375 6d28 7773 2e6e  threads=sum(ws.n
+000453e0: 7468 7265 6164 7320 666f 7220 7773 2069  threads for ws i
+000453f0: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+00045400: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
+00045410: 2020 2020 2020 6d65 6d6f 7279 3d66 6f72        memory=for
+00045420: 6d61 745f 6279 7465 7328 7375 6d28 7773  mat_bytes(sum(ws
+00045430: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
+00045440: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
+00045450: 6b65 7273 2e76 616c 7565 7328 2929 292c  kers.values())),
+00045460: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
+00045470: 653d 636f 6465 2c0a 2020 2020 2020 2020  e=code,.        
+00045480: 2020 2020 6461 736b 5f76 6572 7369 6f6e      dask_version
+00045490: 3d64 6173 6b2e 5f5f 7665 7273 696f 6e5f  =dask.__version_
+000454a0: 5f2c 0a20 2020 2020 2020 2020 2020 2064  _,.            d
+000454b0: 6973 7472 6962 7574 6564 5f76 6572 7369  istributed_versi
+000454c0: 6f6e 3d64 6973 7472 6962 7574 6564 2e5f  on=distributed._
+000454d0: 5f76 6572 7369 6f6e 5f5f 2c0a 2020 2020  _version__,.    
+000454e0: 2020 2020 290a 2020 2020 2020 2020 6874      ).        ht
+000454f0: 6d6c 203d 2044 6976 2874 6578 743d 6874  ml = Div(text=ht
+00045500: 6d6c 2c20 2a2a 5f42 4f4b 4548 5f53 5459  ml, **_BOKEH_STY
+00045510: 4c45 535f 4b57 4152 4753 290a 0a20 2020  LES_KWARGS)..   
+00045520: 2020 2020 2068 746d 6c20 3d20 5461 6250       html = TabP
+00045530: 616e 656c 2863 6869 6c64 3d68 746d 6c2c  anel(child=html,
+00045540: 2074 6974 6c65 3d22 5375 6d6d 6172 7922   title="Summary"
+00045550: 290a 2020 2020 2020 2020 636f 6d70 7574  ).        comput
+00045560: 6520 3d20 5461 6250 616e 656c 2863 6869  e = TabPanel(chi
+00045570: 6c64 3d63 6f6d 7075 7465 2c20 7469 746c  ld=compute, titl
+00045580: 653d 2257 6f72 6b65 7220 5072 6f66 696c  e="Worker Profil
+00045590: 6520 2863 6f6d 7075 7465 2922 290a 2020  e (compute)").  
+000455a0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+000455b0: 5461 6250 616e 656c 2863 6869 6c64 3d77  TabPanel(child=w
+000455c0: 6f72 6b65 7273 2c20 7469 746c 653d 2257  orkers, title="W
+000455d0: 6f72 6b65 7220 5072 6f66 696c 6520 2861  orker Profile (a
+000455e0: 646d 696e 6973 7472 6174 6976 6529 2229  dministrative)")
+000455f0: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
+00045600: 6572 203d 2054 6162 5061 6e65 6c28 0a20  er = TabPanel(. 
+00045610: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+00045620: 3d73 6368 6564 756c 6572 2c20 7469 746c  =scheduler, titl
+00045630: 653d 2253 6368 6564 756c 6572 2050 726f  e="Scheduler Pro
+00045640: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
+00045650: 7469 7665 2922 0a20 2020 2020 2020 2029  tive)".        )
+00045660: 0a20 2020 2020 2020 2074 6173 6b5f 7374  .        task_st
+00045670: 7265 616d 203d 2054 6162 5061 6e65 6c28  ream = TabPanel(
+00045680: 6368 696c 643d 7461 736b 5f73 7472 6561  child=task_strea
+00045690: 6d2c 2074 6974 6c65 3d22 5461 736b 2053  m, title="Task S
+000456a0: 7472 6561 6d22 290a 2020 2020 2020 2020  tream").        
+000456b0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+000456c0: 7320 3d20 5461 6250 616e 656c 280a 2020  s = TabPanel(.  
+000456d0: 2020 2020 2020 2020 2020 6368 696c 643d            child=
+000456e0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+000456f0: 732e 726f 6f74 2c20 7469 746c 653d 2242  s.root, title="B
+00045700: 616e 6477 6964 7468 2028 576f 726b 6572  andwidth (Worker
+00045710: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
+00045720: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+00045730: 7479 7065 7320 3d20 5461 6250 616e 656c  types = TabPanel
+00045740: 280a 2020 2020 2020 2020 2020 2020 6368  (.            ch
+00045750: 696c 643d 6261 6e64 7769 6474 685f 7479  ild=bandwidth_ty
+00045760: 7065 732e 726f 6f74 2c20 7469 746c 653d  pes.root, title=
+00045770: 2242 616e 6477 6964 7468 2028 5479 7065  "Bandwidth (Type
+00045780: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
+00045790: 2020 2020 2020 7379 7374 656d 203d 2054        system = T
+000457a0: 6162 5061 6e65 6c28 6368 696c 643d 7379  abPanel(child=sy
+000457b0: 736d 6f6e 2e72 6f6f 742c 2074 6974 6c65  smon.root, title
+000457c0: 3d22 5379 7374 656d 2229 0a20 2020 2020  ="System").     
+000457d0: 2020 206c 6f67 7320 3d20 5461 6250 616e     logs = TabPan
+000457e0: 656c 2863 6869 6c64 3d6c 6f67 732e 726f  el(child=logs.ro
+000457f0: 6f74 2c20 7469 746c 653d 2253 6368 6564  ot, title="Sched
+00045800: 756c 6572 204c 6f67 7322 290a 0a20 2020  uler Logs")..   
+00045810: 2020 2020 2074 6162 7320 3d20 5461 6273       tabs = Tabs
+00045820: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
+00045830: 6273 3d5b 0a20 2020 2020 2020 2020 2020  bs=[.           
+00045840: 2020 2020 2068 746d 6c2c 0a20 2020 2020       html,.     
+00045850: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
+00045860: 7374 7265 616d 2c0a 2020 2020 2020 2020  stream,.        
+00045870: 2020 2020 2020 2020 7379 7374 656d 2c0a          system,.
+00045880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045890: 6c6f 6773 2c0a 2020 2020 2020 2020 2020  logs,.          
+000458a0: 2020 2020 2020 636f 6d70 7574 652c 0a20        compute,. 
+000458b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000458c0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+000458d0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+000458e0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+000458f0: 2020 2062 616e 6477 6964 7468 5f77 6f72     bandwidth_wor
+00045900: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+00045910: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+00045920: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
+00045930: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00045940: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
+00045950: 7472 6574 6368 5f62 6f74 6822 2c0a 2020  tretch_both",.  
+00045960: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00045970: 2066 726f 6d20 626f 6b65 682e 636f 7265   from bokeh.core
+00045980: 2e74 656d 706c 6174 6573 2069 6d70 6f72  .templates impor
+00045990: 7420 6765 745f 656e 760a 2020 2020 2020  t get_env.      
+000459a0: 2020 6672 6f6d 2062 6f6b 6568 2e70 6c6f    from bokeh.plo
+000459b0: 7474 696e 6720 696d 706f 7274 206f 7574  tting import out
+000459c0: 7075 745f 6669 6c65 2c20 7361 7665 0a0a  put_file, save..
+000459d0: 2020 2020 2020 2020 7769 7468 2074 6d70          with tmp
+000459e0: 6669 6c65 2865 7874 656e 7369 6f6e 3d22  file(extension="
+000459f0: 2e68 746d 6c22 2920 6173 2066 6e3a 0a20  .html") as fn:. 
+00045a00: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00045a10: 745f 6669 6c65 2866 696c 656e 616d 653d  t_file(filename=
+00045a20: 666e 2c20 7469 746c 653d 2244 6173 6b20  fn, title="Dask 
+00045a30: 5065 7266 6f72 6d61 6e63 6520 5265 706f  Performance Repo
+00045a40: 7274 222c 206d 6f64 653d 6d6f 6465 290a  rt", mode=mode).
+00045a50: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00045a60: 6c61 7465 5f64 6972 6563 746f 7279 203d  late_directory =
+00045a70: 206f 732e 7061 7468 2e6a 6f69 6e28 0a20   os.path.join(. 
+00045a80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00045a90: 732e 7061 7468 2e64 6972 6e61 6d65 286f  s.path.dirname(o
+00045aa0: 732e 7061 7468 2e61 6273 7061 7468 285f  s.path.abspath(_
+00045ab0: 5f66 696c 655f 5f29 292c 2022 6461 7368  _file__)), "dash
+00045ac0: 626f 6172 6422 2c20 2274 656d 706c 6174  board", "templat
+00045ad0: 6573 220a 2020 2020 2020 2020 2020 2020  es".            
+00045ae0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+00045af0: 6d70 6c61 7465 5f65 6e76 6972 6f6e 6d65  mplate_environme
+00045b00: 6e74 203d 2067 6574 5f65 6e76 2829 0a20  nt = get_env(). 
+00045b10: 2020 2020 2020 2020 2020 2074 656d 706c             templ
+00045b20: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
+00045b30: 6c6f 6164 6572 2e73 6561 7263 6870 6174  loader.searchpat
+00045b40: 682e 6170 7065 6e64 2874 656d 706c 6174  h.append(templat
+00045b50: 655f 6469 7265 6374 6f72 7929 0a20 2020  e_directory).   
+00045b60: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+00045b70: 6520 3d20 7465 6d70 6c61 7465 5f65 6e76  e = template_env
+00045b80: 6972 6f6e 6d65 6e74 2e67 6574 5f74 656d  ironment.get_tem
+00045b90: 706c 6174 6528 2270 6572 666f 726d 616e  plate("performan
+00045ba0: 6365 5f72 6570 6f72 742e 6874 6d6c 2229  ce_report.html")
+00045bb0: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
+00045bc0: 6528 7461 6273 2c20 6669 6c65 6e61 6d65  e(tabs, filename
+00045bd0: 3d66 6e2c 2074 656d 706c 6174 653d 7465  =fn, template=te
+00045be0: 6d70 6c61 7465 290a 0a20 2020 2020 2020  mplate)..       
+00045bf0: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
+00045c00: 6e29 2061 7320 663a 0a20 2020 2020 2020  n) as f:.       
+00045c10: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00045c20: 662e 7265 6164 2829 0a0a 2020 2020 2020  f.read()..      
+00045c30: 2020 7265 7475 726e 2064 6174 610a 0a20    return data.. 
+00045c40: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+00045c50: 5f77 6f72 6b65 725f 6c6f 6773 2873 656c  _worker_logs(sel
+00045c60: 662c 206e 3d4e 6f6e 652c 2077 6f72 6b65  f, n=None, worke
+00045c70: 7273 3d4e 6f6e 652c 206e 616e 6e79 3d46  rs=None, nanny=F
+00045c80: 616c 7365 293a 0a20 2020 2020 2020 2072  alse):.        r
+00045c90: 6573 756c 7473 203d 2061 7761 6974 2073  esults = await s
+00045ca0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
+00045cb0: 2020 2020 2020 2020 2020 206d 7367 3d7b             msg={
+00045cc0: 226f 7022 3a20 2267 6574 5f6c 6f67 7322  "op": "get_logs"
+00045cd0: 2c20 226e 223a 206e 7d2c 2077 6f72 6b65  , "n": n}, worke
+00045ce0: 7273 3d77 6f72 6b65 7273 2c20 6e61 6e6e  rs=workers, nann
+00045cf0: 793d 6e61 6e6e 790a 2020 2020 2020 2020  y=nanny.        
+00045d00: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00045d10: 2072 6573 756c 7473 0a0a 2020 2020 6465   results..    de
+00045d20: 6620 6c6f 675f 6576 656e 7428 7365 6c66  f log_event(self
+00045d30: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
+00045d40: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
+00045d50: 6d73 673a 2041 6e79 2920 2d3e 204e 6f6e  msg: Any) -> Non
+00045d60: 653a 0a20 2020 2020 2020 2022 2222 4c6f  e:.        """Lo
+00045d70: 6720 616e 2065 7665 6e74 2075 6e64 6572  g an event under
+00045d80: 2061 2067 6976 656e 2074 6f70 6963 0a0a   a given topic..
+00045d90: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00045da0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00045db0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 746f  -----.        to
+00045dc0: 7069 6320 3a20 7374 722c 206c 6973 745b  pic : str, list[
+00045dd0: 7374 725d 0a20 2020 2020 2020 2020 2020  str].           
+00045de0: 204e 616d 6520 6f66 2074 6865 2074 6f70   Name of the top
+00045df0: 6963 2075 6e64 6572 2077 6869 6368 2074  ic under which t
+00045e00: 6f20 6c6f 6720 616e 2065 7665 6e74 2e20  o log an event. 
+00045e10: 546f 206c 6f67 2074 6865 2073 616d 650a  To log the same.
+00045e20: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00045e30: 7420 756e 6465 7220 6d75 6c74 6970 6c65  t under multiple
+00045e40: 2074 6f70 6963 732c 2070 6173 7320 6120   topics, pass a 
+00045e50: 6c69 7374 206f 6620 746f 7069 6320 6e61  list of topic na
+00045e60: 6d65 732e 0a20 2020 2020 2020 206d 7367  mes..        msg
+00045e70: 0a20 2020 2020 2020 2020 2020 2045 7665  .            Eve
+00045e80: 6e74 206d 6573 7361 6765 2074 6f20 6c6f  nt message to lo
+00045e90: 672e 204e 6f74 6520 7468 6973 206d 7573  g. Note this mus
+00045ea0: 7420 6265 206d 7367 7061 636b 2073 6572  t be msgpack ser
+00045eb0: 6961 6c69 7a61 626c 652e 0a0a 2020 2020  ializable...    
+00045ec0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00045ed0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00045ee0: 2020 2020 2020 436c 6965 6e74 2e6c 6f67        Client.log
+00045ef0: 5f65 7665 6e74 0a20 2020 2020 2020 2022  _event.        "
+00045f00: 2222 0a20 2020 2020 2020 2065 7665 6e74  "".        event
+00045f10: 203d 2028 7469 6d65 2829 2c20 6d73 6729   = (time(), msg)
+00045f20: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00045f30: 6973 696e 7374 616e 6365 2874 6f70 6963  isinstance(topic
+00045f40: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00045f50: 2020 2020 666f 7220 7420 696e 2074 6f70      for t in top
+00045f60: 6963 3a0a 2020 2020 2020 2020 2020 2020  ic:.            
+00045f70: 2020 2020 7365 6c66 2e65 7665 6e74 735b      self.events[
+00045f80: 745d 2e61 7070 656e 6428 6576 656e 7429  t].append(event)
+00045f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045fa0: 2073 656c 662e 6576 656e 745f 636f 756e   self.event_coun
+00045fb0: 7473 5b74 5d20 2b3d 2031 0a20 2020 2020  ts[t] += 1.     
+00045fc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00045fd0: 5f72 6570 6f72 745f 6576 656e 7428 742c  _report_event(t,
+00045fe0: 2065 7665 6e74 290a 2020 2020 2020 2020   event).        
+00045ff0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00046000: 2020 7365 6c66 2e65 7665 6e74 735b 746f    self.events[to
+00046010: 7069 635d 2e61 7070 656e 6428 6576 656e  pic].append(even
+00046020: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
+00046030: 656c 662e 6576 656e 745f 636f 756e 7473  elf.event_counts
+00046040: 5b74 6f70 6963 5d20 2b3d 2031 0a20 2020  [topic] += 1.   
+00046050: 2020 2020 2020 2020 2073 656c 662e 5f72           self._r
+00046060: 6570 6f72 745f 6576 656e 7428 746f 7069  eport_event(topi
+00046070: 632c 2065 7665 6e74 290a 0a20 2020 2020  c, event)..     
+00046080: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
+00046090: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
+000460a0: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
+000460b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000460c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000460d0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+000460e0: 6e2e 6c6f 675f 6576 656e 7428 746f 7069  n.log_event(topi
+000460f0: 632c 206d 7367 290a 2020 2020 2020 2020  c, msg).        
+00046100: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00046110: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00046120: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00046130: 6767 6572 2e69 6e66 6f28 2250 6c75 6769  gger.info("Plugi
+00046140: 6e20 6661 696c 6564 2077 6974 6820 6578  n failed with ex
+00046150: 6365 7074 696f 6e22 2c20 6578 635f 696e  ception", exc_in
+00046160: 666f 3d54 7275 6529 0a0a 2020 2020 6465  fo=True)..    de
+00046170: 6620 5f72 6570 6f72 745f 6576 656e 7428  f _report_event(
+00046180: 7365 6c66 2c20 6e61 6d65 2c20 6576 656e  self, name, even
+00046190: 7429 3a0a 2020 2020 2020 2020 6d73 6720  t):.        msg 
+000461a0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000461b0: 226f 7022 3a20 2265 7665 6e74 222c 0a20  "op": "event",. 
+000461c0: 2020 2020 2020 2020 2020 2022 746f 7069             "topi
+000461d0: 6322 3a20 6e61 6d65 2c0a 2020 2020 2020  c": name,.      
+000461e0: 2020 2020 2020 2265 7665 6e74 223a 2065        "event": e
+000461f0: 7665 6e74 2c0a 2020 2020 2020 2020 7d0a  vent,.        }.
+00046200: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00046210: 7367 7320 3d20 7b63 6c69 656e 743a 205b  sgs = {client: [
+00046220: 6d73 675d 2066 6f72 2063 6c69 656e 7420  msg] for client 
+00046230: 696e 2073 656c 662e 6576 656e 745f 7375  in self.event_su
+00046240: 6273 6372 6962 6572 5b6e 616d 655d 7d0a  bscriber[name]}.
+00046250: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
+00046260: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
+00046270: 732c 2077 6f72 6b65 725f 6d73 6773 3d7b  s, worker_msgs={
+00046280: 7d29 0a0a 2020 2020 6465 6620 7375 6273  })..    def subs
+00046290: 6372 6962 655f 746f 7069 6328 7365 6c66  cribe_topic(self
+000462a0: 2c20 746f 7069 632c 2063 6c69 656e 7429  , topic, client)
+000462b0: 3a0a 2020 2020 2020 2020 7365 6c66 2e65  :.        self.e
+000462c0: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
+000462d0: 746f 7069 635d 2e61 6464 2863 6c69 656e  topic].add(clien
+000462e0: 7429 0a0a 2020 2020 6465 6620 756e 7375  t)..    def unsu
+000462f0: 6273 6372 6962 655f 746f 7069 6328 7365  bscribe_topic(se
+00046300: 6c66 2c20 746f 7069 632c 2063 6c69 656e  lf, topic, clien
+00046310: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
+00046320: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
+00046330: 725b 746f 7069 635d 2e64 6973 6361 7264  r[topic].discard
+00046340: 2863 6c69 656e 7429 0a0a 2020 2020 6465  (client)..    de
+00046350: 6620 6765 745f 6576 656e 7473 2873 656c  f get_events(sel
+00046360: 662c 2074 6f70 6963 3d4e 6f6e 6529 3a0a  f, topic=None):.
+00046370: 2020 2020 2020 2020 6966 2074 6f70 6963          if topic
+00046380: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00046390: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000463a0: 2074 7570 6c65 2873 656c 662e 6576 656e   tuple(self.even
+000463b0: 7473 5b74 6f70 6963 5d29 0a20 2020 2020  ts[topic]).     
+000463c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000463d0: 2020 2020 2072 6574 7572 6e20 7661 6c6d       return valm
+000463e0: 6170 2874 7570 6c65 2c20 7365 6c66 2e65  ap(tuple, self.e
+000463f0: 7665 6e74 7329 0a0a 2020 2020 6173 796e  vents)..    asyn
+00046400: 6320 6465 6620 6765 745f 776f 726b 6572  c def get_worker
+00046410: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7365  _monitor_info(se
+00046420: 6c66 2c20 7265 6365 6e74 3d46 616c 7365  lf, recent=False
+00046430: 2c20 7374 6172 7473 3d4e 6f6e 6529 3a0a  , starts=None):.
+00046440: 2020 2020 2020 2020 6966 2073 7461 7274          if start
+00046450: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00046460: 2020 2020 2020 2073 7461 7274 7320 3d20         starts = 
+00046470: 7b7d 0a20 2020 2020 2020 2072 6573 756c  {}.        resul
+00046480: 7473 203d 2061 7761 6974 2061 7379 6e63  ts = await async
+00046490: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+000464a0: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
+000464b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+000464c0: 7063 2877 292e 6765 745f 6d6f 6e69 746f  pc(w).get_monito
+000464d0: 725f 696e 666f 2872 6563 656e 743d 7265  r_info(recent=re
+000464e0: 6365 6e74 2c20 7374 6172 743d 7374 6172  cent, start=star
+000464f0: 7473 2e67 6574 2877 2c20 3029 290a 2020  ts.get(w, 0)).  
+00046500: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00046510: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
+00046520: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+00046530: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00046540: 2020 2020 7265 7475 726e 2064 6963 7428      return dict(
+00046550: 7a69 7028 7365 6c66 2e77 6f72 6b65 7273  zip(self.workers
+00046560: 2c20 7265 7375 6c74 7329 290a 0a20 2020  , results))..   
+00046570: 2023 2323 2323 2323 2323 2323 0a20 2020   ###########.   
+00046580: 2023 2043 6c65 616e 7570 2023 0a20 2020   # Cleanup #.   
+00046590: 2023 2323 2323 2323 2323 2323 0a0a 2020   ###########..  
+000465a0: 2020 6173 796e 6320 6465 6620 6368 6563    async def chec
+000465b0: 6b5f 776f 726b 6572 5f74 746c 2873 656c  k_worker_ttl(sel
+000465c0: 6629 3a0a 2020 2020 2020 2020 6e6f 7720  f):.        now 
+000465d0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+000465e0: 2073 7469 6d75 6c75 735f 6964 203d 2066   stimulus_id = f
+000465f0: 2263 6865 636b 2d77 6f72 6b65 722d 7474  "check-worker-tt
+00046600: 6c2d 7b6e 6f77 7d22 0a20 2020 2020 2020  l-{now}".       
+00046610: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00046620: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00046630: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00046640: 2028 7773 2e6c 6173 745f 7365 656e 203c   (ws.last_seen <
+00046650: 206e 6f77 202d 2073 656c 662e 776f 726b   now - self.work
+00046660: 6572 5f74 746c 2920 616e 6420 280a 2020  er_ttl) and (.  
+00046670: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00046680: 2e6c 6173 745f 7365 656e 203c 206e 6f77  .last_seen < now
+00046690: 202d 2031 3020 2a20 6865 6172 7462 6561   - 10 * heartbea
+000466a0: 745f 696e 7465 7276 616c 286c 656e 2873  t_interval(len(s
+000466b0: 656c 662e 776f 726b 6572 7329 290a 2020  elf.workers)).  
+000466c0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+000466d0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000466e0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+000466f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046700: 2022 576f 726b 6572 2066 6169 6c65 6420   "Worker failed 
+00046710: 746f 2068 6561 7274 6265 6174 2077 6974  to heartbeat wit
+00046720: 6869 6e20 2573 2073 6563 6f6e 6473 2e20  hin %s seconds. 
+00046730: 436c 6f73 696e 673a 2025 7322 2c0a 2020  Closing: %s",.  
+00046740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046750: 2020 7365 6c66 2e77 6f72 6b65 725f 7474    self.worker_tt
+00046760: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00046770: 2020 2020 2020 2077 732c 0a20 2020 2020         ws,.     
+00046780: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00046790: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+000467a0: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
+000467b0: 6f72 6b65 7228 6164 6472 6573 733d 7773  orker(address=ws
+000467c0: 2e61 6464 7265 7373 2c20 7374 696d 756c  .address, stimul
+000467d0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
+000467e0: 6429 0a0a 2020 2020 6465 6620 6368 6563  d)..    def chec
+000467f0: 6b5f 6964 6c65 2873 656c 6629 202d 3e20  k_idle(self) -> 
+00046800: 666c 6f61 7420 7c20 4e6f 6e65 3a0a 2020  float | None:.  
+00046810: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00046820: 6174 7573 2069 6e20 2853 7461 7475 732e  atus in (Status.
+00046830: 636c 6f73 696e 672c 2053 7461 7475 732e  closing, Status.
+00046840: 636c 6f73 6564 293a 0a20 2020 2020 2020  closed):.       
+00046850: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00046860: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00046870: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00046880: 6e74 6572 2021 3d20 7365 6c66 2e5f 6964  nter != self._id
+00046890: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
+000468a0: 756e 7465 723a 0a20 2020 2020 2020 2020  unter:.         
+000468b0: 2020 2073 656c 662e 5f69 646c 655f 7472     self._idle_tr
+000468c0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+000468d0: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
+000468e0: 6f6e 5f63 6f75 6e74 6572 0a20 2020 2020  on_counter.     
+000468f0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00046900: 5f73 696e 6365 203d 204e 6f6e 650a 2020  _since = None.  
+00046910: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00046920: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+00046930: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+00046940: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
+00046950: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
+00046960: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
+00046970: 2020 2020 2020 206f 7220 616e 7928 7773         or any(ws
+00046980: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
+00046990: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+000469a0: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
+000469b0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+000469c0: 2020 2020 7365 6c66 2e69 646c 655f 7369      self.idle_si
+000469d0: 6e63 6520 3d20 4e6f 6e65 0a20 2020 2020  nce = None.     
+000469e0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+000469f0: 6e65 0a0a 2020 2020 2020 2020 6966 206e  ne..        if n
+00046a00: 6f74 2073 656c 662e 6964 6c65 5f73 696e  ot self.idle_sin
+00046a10: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00046a20: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+00046a30: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+00046a40: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00046a50: 2e69 646c 655f 7369 6e63 650a 0a20 2020  .idle_since..   
+00046a60: 2020 2020 2069 6620 7365 6c66 2e6a 7570       if self.jup
+00046a70: 7974 6572 3a0a 2020 2020 2020 2020 2020  yter:.          
+00046a80: 2020 6c61 7374 5f61 6374 6976 6974 7920    last_activity 
+00046a90: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00046aa0: 2020 2020 7365 6c66 2e5f 6a75 7079 7465      self._jupyte
+00046ab0: 725f 7365 7276 6572 5f61 7070 6c69 6361  r_server_applica
+00046ac0: 7469 6f6e 2e77 6562 5f61 7070 2e6c 6173  tion.web_app.las
+00046ad0: 745f 6163 7469 7669 7479 2829 2e74 696d  t_activity().tim
+00046ae0: 6573 7461 6d70 2829 0a20 2020 2020 2020  estamp().       
+00046af0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00046b00: 2020 2069 6620 6c61 7374 5f61 6374 6976     if last_activ
+00046b10: 6974 7920 3e20 7365 6c66 2e69 646c 655f  ity > self.idle_
+00046b20: 7369 6e63 653a 0a20 2020 2020 2020 2020  since:.         
+00046b30: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00046b40: 5f73 696e 6365 203d 206c 6173 745f 6163  _since = last_ac
+00046b50: 7469 7669 7479 0a20 2020 2020 2020 2020  tivity.         
+00046b60: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00046b70: 6c66 2e69 646c 655f 7369 6e63 650a 0a20  lf.idle_since.. 
+00046b80: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00046b90: 646c 655f 7469 6d65 6f75 743a 0a20 2020  dle_timeout:.   
+00046ba0: 2020 2020 2020 2020 2069 6620 7469 6d65           if time
+00046bb0: 2829 203e 2073 656c 662e 6964 6c65 5f73  () > self.idle_s
+00046bc0: 696e 6365 202b 2073 656c 662e 6964 6c65  ince + self.idle
+00046bd0: 5f74 696d 656f 7574 3a0a 2020 2020 2020  _timeout:.      
+00046be0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00046bf0: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
+00046c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046c10: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
+00046c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046c30: 2020 2253 6368 6564 756c 6572 2063 6c6f    "Scheduler clo
+00046c40: 7369 6e67 2061 6674 6572 2062 6569 6e67  sing after being
+00046c50: 2069 646c 6520 666f 7220 2573 222c 0a20   idle for %s",. 
+00046c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046c70: 2020 2066 6f72 6d61 745f 7469 6d65 2873     format_time(s
+00046c80: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
+00046c90: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00046ca0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00046cb0: 2020 2020 2073 656c 662e 5f6f 6e67 6f69       self._ongoi
+00046cc0: 6e67 5f62 6163 6b67 726f 756e 645f 7461  ng_background_ta
+00046cd0: 736b 732e 6361 6c6c 5f73 6f6f 6e28 7365  sks.call_soon(se
+00046ce0: 6c66 2e63 6c6f 7365 290a 2020 2020 2020  lf.close).      
+00046cf0: 2020 7265 7475 726e 2073 656c 662e 6964    return self.id
+00046d00: 6c65 5f73 696e 6365 0a0a 2020 2020 6465  le_since..    de
+00046d10: 6620 6164 6170 7469 7665 5f74 6172 6765  f adaptive_targe
+00046d20: 7428 7365 6c66 2c20 7461 7267 6574 5f64  t(self, target_d
+00046d30: 7572 6174 696f 6e3d 4e6f 6e65 293a 0a20  uration=None):. 
+00046d40: 2020 2020 2020 2022 2222 4465 7369 7265         """Desire
+00046d50: 6420 6e75 6d62 6572 206f 6620 776f 726b  d number of work
+00046d60: 6572 7320 6261 7365 6420 6f6e 2074 6865  ers based on the
+00046d70: 2063 7572 7265 6e74 2077 6f72 6b6c 6f61   current workloa
+00046d80: 640a 0a20 2020 2020 2020 2054 6869 7320  d..        This 
+00046d90: 6c6f 6f6b 7320 6174 2074 6865 2063 7572  looks at the cur
+00046da0: 7265 6e74 2072 756e 6e69 6e67 2074 6173  rent running tas
+00046db0: 6b73 2061 6e64 206d 656d 6f72 7920 7573  ks and memory us
+00046dc0: 652c 2061 6e64 2072 6574 7572 6e73 2061  e, and returns a
+00046dd0: 0a20 2020 2020 2020 206e 756d 6265 7220  .        number 
+00046de0: 6f66 2064 6573 6972 6564 2077 6f72 6b65  of desired worke
+00046df0: 7273 2e20 2054 6869 7320 6973 206f 6674  rs.  This is oft
+00046e00: 656e 2075 7365 6420 6279 2061 6461 7074  en used by adapt
+00046e10: 6976 6520 7363 6865 6475 6c69 6e67 2e0a  ive scheduling..
+00046e20: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00046e30: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00046e40: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2074  ------.        t
+00046e50: 6172 6765 745f 6475 7261 7469 6f6e 203a  arget_duration :
+00046e60: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00046e70: 2041 2064 6573 6972 6564 2064 7572 6174   A desired durat
+00046e80: 696f 6e20 6f66 2074 696d 6520 666f 7220  ion of time for 
+00046e90: 636f 6d70 7574 6174 696f 6e73 2074 6f20  computations to 
+00046ea0: 7461 6b65 2e20 2054 6869 7320 6166 6665  take.  This affe
+00046eb0: 6374 730a 2020 2020 2020 2020 2020 2020  cts.            
+00046ec0: 686f 7720 7261 7069 646c 7920 7468 6520  how rapidly the 
+00046ed0: 7363 6865 6475 6c65 7220 7769 6c6c 2061  scheduler will a
+00046ee0: 736b 2074 6f20 7363 616c 652e 0a0a 2020  sk to scale...  
+00046ef0: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
+00046f00: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+00046f10: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+00046f20: 7465 642e 6465 706c 6f79 2e41 6461 7074  ted.deploy.Adapt
+00046f30: 6976 650a 2020 2020 2020 2020 2222 220a  ive.        """.
+00046f40: 2020 2020 2020 2020 6966 2074 6172 6765          if targe
+00046f50: 745f 6475 7261 7469 6f6e 2069 7320 4e6f  t_duration is No
+00046f60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00046f70: 7461 7267 6574 5f64 7572 6174 696f 6e20  target_duration 
+00046f80: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+00046f90: 7428 2264 6973 7472 6962 7574 6564 2e61  t("distributed.a
+00046fa0: 6461 7074 6976 652e 7461 7267 6574 2d64  daptive.target-d
+00046fb0: 7572 6174 696f 6e22 290a 2020 2020 2020  uration").      
+00046fc0: 2020 7461 7267 6574 5f64 7572 6174 696f    target_duratio
+00046fd0: 6e20 3d20 7061 7273 655f 7469 6d65 6465  n = parse_timede
+00046fe0: 6c74 6128 7461 7267 6574 5f64 7572 6174  lta(target_durat
+00046ff0: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
+00047000: 4350 550a 0a20 2020 2020 2020 2023 2054  CPU..        # T
+00047010: 4f44 4f20 636f 6e73 6964 6572 2061 6e79  ODO consider any
+00047020: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
+00047030: 6465 6661 756c 7420 7461 736b 2064 7572  default task dur
+00047040: 6174 696f 6e73 2066 6f72 2071 7565 7565  ations for queue
+00047050: 6420 7461 736b 730a 2020 2020 2020 2020  d tasks.        
+00047060: 7175 6575 6564 5f6f 6363 7570 616e 6379  queued_occupancy
+00047070: 203d 206c 656e 2873 656c 662e 7175 6575   = len(self.queu
+00047080: 6564 2920 2a20 7365 6c66 2e55 4e4b 4e4f  ed) * self.UNKNO
+00047090: 574e 5f54 4153 4b5f 4455 5241 5449 4f4e  WN_TASK_DURATION
+000470a0: 0a20 2020 2020 2020 2063 7075 203d 206d  .        cpu = m
+000470b0: 6174 682e 6365 696c 280a 2020 2020 2020  ath.ceil(.      
+000470c0: 2020 2020 2020 2873 656c 662e 746f 7461        (self.tota
+000470d0: 6c5f 6f63 6375 7061 6e63 7920 2b20 7175  l_occupancy + qu
+000470e0: 6575 6564 5f6f 6363 7570 616e 6379 2920  eued_occupancy) 
+000470f0: 2f20 7461 7267 6574 5f64 7572 6174 696f  / target_duratio
+00047100: 6e0a 2020 2020 2020 2020 2920 2023 2054  n.        )  # T
+00047110: 4f44 4f3a 2074 6872 6561 6473 2070 6572  ODO: threads per
+00047120: 2077 6f72 6b65 720a 0a20 2020 2020 2020   worker..       
+00047130: 2023 2041 766f 6964 2061 2066 6577 206c   # Avoid a few l
+00047140: 6f6e 6720 7461 736b 7320 6672 6f6d 2061  ong tasks from a
+00047150: 736b 696e 6720 666f 7220 6d61 6e79 2063  sking for many c
+00047160: 6f72 6573 0a20 2020 2020 2020 2074 6173  ores.        tas
+00047170: 6b73 5f72 6561 6479 203d 206c 656e 2873  ks_ready = len(s
+00047180: 656c 662e 7175 6575 6564 290a 2020 2020  elf.queued).    
+00047190: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
+000471a0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+000471b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000471c0: 2074 6173 6b73 5f72 6561 6479 202b 3d20   tasks_ready += 
+000471d0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
+000471e0: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
+000471f0: 6966 2074 6173 6b73 5f72 6561 6479 203e  if tasks_ready >
+00047200: 2063 7075 3a0a 2020 2020 2020 2020 2020   cpu:.          
+00047210: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+00047220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00047230: 2020 2020 2020 6370 7520 3d20 6d69 6e28        cpu = min(
+00047240: 7461 736b 735f 7265 6164 792c 2063 7075  tasks_ready, cpu
+00047250: 290a 0a20 2020 2020 2020 2069 6620 2873  )..        if (s
+00047260: 656c 662e 756e 7275 6e6e 6162 6c65 206f  elf.unrunnable o
+00047270: 7220 7365 6c66 2e71 7565 7565 6429 2061  r self.queued) a
+00047280: 6e64 206e 6f74 2073 656c 662e 776f 726b  nd not self.work
+00047290: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000472a0: 2063 7075 203d 206d 6178 2831 2c20 6370   cpu = max(1, cp
+000472b0: 7529 0a0a 2020 2020 2020 2020 2320 6164  u)..        # ad
+000472c0: 6420 6d6f 7265 2077 6f72 6b65 7273 2069  d more workers i
+000472d0: 6620 6d6f 7265 2074 6861 6e20 3630 2520  f more than 60% 
+000472e0: 6f66 206d 656d 6f72 7920 6973 2075 7365  of memory is use
+000472f0: 640a 2020 2020 2020 2020 6c69 6d69 7420  d.        limit 
+00047300: 3d20 7375 6d28 7773 2e6d 656d 6f72 795f  = sum(ws.memory_
+00047310: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
+00047320: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+00047330: 7565 7328 2929 0a20 2020 2020 2020 2075  ues()).        u
+00047340: 7365 6420 3d20 7375 6d28 7773 2e6e 6279  sed = sum(ws.nby
+00047350: 7465 7320 666f 7220 7773 2069 6e20 7365  tes for ws in se
+00047360: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+00047370: 7328 2929 0a20 2020 2020 2020 206d 656d  s()).        mem
+00047380: 6f72 7920 3d20 300a 2020 2020 2020 2020  ory = 0.        
+00047390: 6966 2075 7365 6420 3e20 302e 3620 2a20  if used > 0.6 * 
+000473a0: 6c69 6d69 7420 616e 6420 6c69 6d69 7420  limit and limit 
+000473b0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+000473c0: 206d 656d 6f72 7920 3d20 3220 2a20 6c65   memory = 2 * le
+000473d0: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
+000473e0: 0a20 2020 2020 2020 2074 6172 6765 7420  .        target 
+000473f0: 3d20 6d61 7828 6d65 6d6f 7279 2c20 6370  = max(memory, cp
+00047400: 7529 0a20 2020 2020 2020 2069 6620 7461  u).        if ta
+00047410: 7267 6574 203e 3d20 6c65 6e28 7365 6c66  rget >= len(self
+00047420: 2e77 6f72 6b65 7273 293a 0a20 2020 2020  .workers):.     
+00047430: 2020 2020 2020 2072 6574 7572 6e20 7461         return ta
+00047440: 7267 6574 0a20 2020 2020 2020 2065 6c73  rget.        els
+00047450: 653a 2020 2320 5363 616c 6520 646f 776e  e:  # Scale down
+00047460: 3f0a 2020 2020 2020 2020 2020 2020 746f  ?.            to
+00047470: 5f63 6c6f 7365 203d 2073 656c 662e 776f  _close = self.wo
+00047480: 726b 6572 735f 746f 5f63 6c6f 7365 2829  rkers_to_close()
+00047490: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000474a0: 7572 6e20 6c65 6e28 7365 6c66 2e77 6f72  urn len(self.wor
+000474b0: 6b65 7273 2920 2d20 6c65 6e28 746f 5f63  kers) - len(to_c
+000474c0: 6c6f 7365 290a 0a20 2020 2064 6566 2072  lose)..    def r
+000474d0: 6571 7565 7374 5f61 6371 7569 7265 5f72  equest_acquire_r
+000474e0: 6570 6c69 6361 7328 0a20 2020 2020 2020  eplicas(.       
+000474f0: 2073 656c 662c 2061 6464 723a 2073 7472   self, addr: str
+00047500: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+00047510: 5b73 7472 5d2c 202a 2c20 7374 696d 756c  [str], *, stimul
+00047520: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
+00047530: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00047540: 2020 2222 2241 7379 6e63 6872 6f6e 6f75    """Asynchronou
+00047550: 736c 7920 6173 6b20 6120 776f 726b 6572  sly ask a worker
+00047560: 2074 6f20 6163 7175 6972 6520 6120 7265   to acquire a re
+00047570: 706c 6963 6120 6f66 2074 6865 206c 6973  plica of the lis
+00047580: 7465 6420 6b65 7973 2066 726f 6d0a 2020  ted keys from.  
+00047590: 2020 2020 2020 6f74 6865 7220 776f 726b        other work
+000475a0: 6572 732e 2054 6869 7320 6973 2061 2066  ers. This is a f
+000475b0: 6972 652d 616e 642d 666f 7267 6574 206f  ire-and-forget o
+000475c0: 7065 7261 7469 6f6e 2077 6869 6368 206f  peration which o
+000475d0: 6666 6572 7320 6e6f 2066 6565 6462 6163  ffers no feedbac
+000475e0: 6b20 666f 720a 2020 2020 2020 2020 7375  k for.        su
+000475f0: 6363 6573 7320 6f72 2066 6169 6c75 7265  ccess or failure
+00047600: 2c20 616e 6420 6973 2069 6e74 656e 6465  , and is intende
+00047610: 6420 666f 7220 686f 7573 656b 6565 7069  d for housekeepi
+00047620: 6e67 2061 6e64 206e 6f74 2066 6f72 2063  ng and not for c
+00047630: 6f6d 7075 7461 7469 6f6e 2e0a 2020 2020  omputation..    
+00047640: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00047650: 7768 6f5f 6861 7320 3d20 7b7d 0a20 2020  who_has = {}.   
+00047660: 2020 2020 206e 6279 7465 7320 3d20 7b7d       nbytes = {}
+00047670: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00047680: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+00047690: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+000476a0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+000476b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000476c0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+000476d0: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
+000476e0: 5d20 3d20 5b77 732e 6164 6472 6573 7320  ] = [ws.address 
+000476f0: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+00047700: 5f68 6173 5d0a 2020 2020 2020 2020 2020  _has].          
+00047710: 2020 6e62 7974 6573 5b6b 6579 5d20 3d20    nbytes[key] = 
+00047720: 7473 2e6e 6279 7465 730a 0a20 2020 2020  ts.nbytes..     
+00047730: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
+00047740: 6f6d 6d73 5b61 6464 725d 2e73 656e 6428  omms[addr].send(
+00047750: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00047760: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00047770: 6f70 223a 2022 6163 7175 6972 652d 7265  op": "acquire-re
+00047780: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
+00047790: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
+000477a0: 7322 3a20 7768 6f5f 6861 732c 0a20 2020  s": who_has,.   
+000477b0: 2020 2020 2020 2020 2020 2020 2022 6e62               "nb
+000477c0: 7974 6573 223a 206e 6279 7465 732c 0a20  ytes": nbytes,. 
+000477d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000477e0: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+000477f0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00047800: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00047810: 2020 290a 0a20 2020 2064 6566 2072 6571    )..    def req
+00047820: 7565 7374 5f72 656d 6f76 655f 7265 706c  uest_remove_repl
+00047830: 6963 6173 280a 2020 2020 2020 2020 7365  icas(.        se
+00047840: 6c66 2c20 6164 6472 3a20 7374 722c 206b  lf, addr: str, k
+00047850: 6579 733a 206c 6973 745b 7374 725d 2c20  eys: list[str], 
+00047860: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
+00047870: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
+00047880: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
+00047890: 796e 6368 726f 6e6f 7573 6c79 2061 736b  ynchronously ask
+000478a0: 2061 2077 6f72 6b65 7220 746f 2064 6973   a worker to dis
+000478b0: 6361 7264 2069 7473 2072 6570 6c69 6361  card its replica
+000478c0: 206f 6620 7468 6520 6c69 7374 6564 206b   of the listed k
+000478d0: 6579 732e 0a20 2020 2020 2020 2054 6869  eys..        Thi
+000478e0: 7320 6d75 7374 206e 6576 6572 2062 6520  s must never be 
+000478f0: 7573 6564 2074 6f20 6465 7374 726f 7920  used to destroy 
+00047900: 7468 6520 6c61 7374 2072 6570 6c69 6361  the last replica
+00047910: 206f 6620 6120 6b65 792e 2054 6869 7320   of a key. This 
+00047920: 6973 2061 0a20 2020 2020 2020 2066 6972  is a.        fir
+00047930: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
+00047940: 7261 7469 6f6e 2c20 696e 7465 6e64 6564  ration, intended
+00047950: 2066 6f72 2068 6f75 7365 6b65 6570 696e   for housekeepin
+00047960: 6720 616e 6420 6e6f 7420 666f 7220 636f  g and not for co
+00047970: 6d70 7574 6174 696f 6e2e 0a0a 2020 2020  mputation...    
+00047980: 2020 2020 5468 6520 7265 706c 6963 6120      The replica 
+00047990: 6469 7361 7070 6561 7273 2069 6d6d 6564  disappears immed
+000479a0: 6961 7465 6c79 2066 726f 6d20 5461 736b  iately from Task
+000479b0: 5374 6174 652e 7768 6f5f 6861 7320 6f6e  State.who_has on
+000479c0: 2074 6865 2053 6368 6564 756c 6572 2073   the Scheduler s
+000479d0: 6964 653b 0a20 2020 2020 2020 2069 6620  ide;.        if 
+000479e0: 7468 6520 776f 726b 6572 2072 6566 7573  the worker refus
+000479f0: 6573 2074 6f20 6465 6c65 7465 2c20 652e  es to delete, e.
+00047a00: 672e 2062 6563 6175 7365 2074 6865 2074  g. because the t
+00047a10: 6173 6b20 6973 2061 2064 6570 656e 6465  ask is a depende
+00047a20: 6e63 7920 6f66 0a20 2020 2020 2020 2061  ncy of.        a
+00047a30: 6e6f 7468 6572 2074 6173 6b20 7275 6e6e  nother task runn
+00047a40: 696e 6720 6f6e 2069 742c 2069 7420 7769  ing on it, it wi
+00047a50: 6c6c 2028 616c 736f 2061 7379 6e63 6872  ll (also asynchr
+00047a60: 6f6e 6f75 736c 7929 2069 6e66 6f72 6d20  onously) inform 
+00047a70: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
+00047a80: 2020 2020 2020 746f 2072 652d 6164 6420        to re-add 
+00047a90: 6974 7365 6c66 2074 6f20 7768 6f5f 6861  itself to who_ha
+00047aa0: 732e 2049 6620 7468 6520 776f 726b 6572  s. If the worker
+00047ab0: 2061 6772 6565 7320 746f 2064 6973 6361   agrees to disca
+00047ac0: 7264 2074 6865 2074 6173 6b2c 2074 6865  rd the task, the
+00047ad0: 7265 2069 730a 2020 2020 2020 2020 6e6f  re is.        no
+00047ae0: 2066 6565 6462 6163 6b2e 0a20 2020 2020   feedback..     
+00047af0: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+00047b00: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+00047b10: 5b61 6464 725d 0a0a 2020 2020 2020 2020  [addr]..        
+00047b20: 2320 5468 6520 7363 6865 6475 6c65 7220  # The scheduler 
+00047b30: 696d 6d65 6469 6174 656c 7920 666f 7267  immediately forg
+00047b40: 6574 7320 6162 6f75 7420 7468 6520 7265  ets about the re
+00047b50: 706c 6963 6120 616e 6420 7375 6767 6573  plica and sugges
+00047b60: 7473 2074 6865 2077 6f72 6b65 7220 746f  ts the worker to
+00047b70: 0a20 2020 2020 2020 2023 2064 726f 7020  .        # drop 
+00047b80: 6974 2e20 5468 6520 776f 726b 6572 206d  it. The worker m
+00047b90: 6179 2072 6566 7573 652c 2061 7420 7768  ay refuse, at wh
+00047ba0: 6963 6820 706f 696e 7420 6974 2077 696c  ich point it wil
+00047bb0: 6c20 7365 6e64 2062 6163 6b20 616e 2061  l send back an a
+00047bc0: 6464 2d6b 6579 730a 2020 2020 2020 2020  dd-keys.        
+00047bd0: 2320 6d65 7373 6167 6520 746f 2072 6569  # message to rei
+00047be0: 6e73 7461 7465 2069 742e 0a20 2020 2020  nstate it..     
+00047bf0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+00047c00: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00047c10: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00047c20: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+00047c30: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00047c40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00047c50: 2020 2023 2044 6f20 6e6f 7420 6465 7374     # Do not dest
+00047c60: 726f 7920 7468 6520 6c61 7374 2063 6f70  roy the last cop
+00047c70: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+00047c80: 2020 6173 7365 7274 206c 656e 2874 732e    assert len(ts.
+00047c90: 7768 6f5f 6861 7329 203e 2031 0a20 2020  who_has) > 1.   
+00047ca0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00047cb0: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
+00047cc0: 2077 7329 0a0a 2020 2020 2020 2020 7365   ws)..        se
+00047cd0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+00047ce0: 6164 6472 5d2e 7365 6e64 280a 2020 2020  addr].send(.    
+00047cf0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00047d00: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+00047d10: 2272 656d 6f76 652d 7265 706c 6963 6173  "remove-replicas
+00047d20: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00047d30: 2020 2022 6b65 7973 223a 206b 6579 732c     "keys": keys,
+00047d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047d50: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+00047d60: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00047d70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00047d80: 2020 2029 0a0a 0a64 6566 205f 7461 736b     )...def _task
+00047d90: 5f74 6f5f 7265 706f 7274 5f6d 7367 2874  _to_report_msg(t
+00047da0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+00047db0: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
+00047dc0: 7c20 4e6f 6e65 3a0a 2020 2020 6966 2074  | None:.    if t
+00047dd0: 732e 7374 6174 6520 3d3d 2022 666f 7267  s.state == "forg
+00047de0: 6f74 7465 6e22 3a0a 2020 2020 2020 2020  otten":.        
+00047df0: 7265 7475 726e 207b 226f 7022 3a20 2263  return {"op": "c
+00047e00: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
+00047e10: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
+00047e20: 7d0a 2020 2020 656c 6966 2074 732e 7374  }.    elif ts.st
+00047e30: 6174 6520 3d3d 2022 6d65 6d6f 7279 223a  ate == "memory":
+00047e40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00047e50: 7b22 6f70 223a 2022 6b65 792d 696e 2d6d  {"op": "key-in-m
+00047e60: 656d 6f72 7922 2c20 226b 6579 223a 2074  emory", "key": t
+00047e70: 732e 6b65 797d 0a20 2020 2065 6c69 6620  s.key}.    elif 
+00047e80: 7473 2e73 7461 7465 203d 3d20 2265 7272  ts.state == "err
+00047e90: 6564 223a 0a20 2020 2020 2020 2066 6169  ed":.        fai
+00047ea0: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
+00047eb0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+00047ec0: 2020 2020 2061 7373 6572 7420 6661 696c       assert fail
+00047ed0: 696e 675f 7473 0a20 2020 2020 2020 2072  ing_ts.        r
+00047ee0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00047ef0: 2020 2020 226f 7022 3a20 2274 6173 6b2d      "op": "task-
+00047f00: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+00047f10: 2020 2020 226b 6579 223a 2074 732e 6b65      "key": ts.ke
+00047f20: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+00047f30: 6578 6365 7074 696f 6e22 3a20 6661 696c  exception": fail
+00047f40: 696e 675f 7473 2e65 7863 6570 7469 6f6e  ing_ts.exception
+00047f50: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00047f60: 7261 6365 6261 636b 223a 2066 6169 6c69  raceback": faili
+00047f70: 6e67 5f74 732e 7472 6163 6562 6163 6b2c  ng_ts.traceback,
+00047f80: 0a20 2020 2020 2020 207d 0a20 2020 2065  .        }.    e
+00047f90: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
+00047fa0: 7572 6e20 4e6f 6e65 0a0a 0a64 6566 205f  urn None...def _
+00047fb0: 7461 736b 5f74 6f5f 636c 6965 6e74 5f6d  task_to_client_m
+00047fc0: 7367 7328 7473 3a20 5461 736b 5374 6174  sgs(ts: TaskStat
+00047fd0: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
+00047fe0: 6c69 7374 5b64 6963 745b 7374 722c 2041  list[dict[str, A
+00047ff0: 6e79 5d5d 5d3a 0a20 2020 2069 6620 7473  ny]]]:.    if ts
+00048000: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+00048010: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
+00048020: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
+00048030: 5f6d 7367 2874 7329 0a20 2020 2020 2020  _msg(ts).       
+00048040: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
+00048050: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00048060: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00048070: 6373 2e63 6c69 656e 745f 6b65 793a 205b  cs.client_key: [
+00048080: 7265 706f 7274 5f6d 7367 5d20 666f 7220  report_msg] for 
+00048090: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+000480a0: 7473 7d0a 2020 2020 7265 7475 726e 207b  ts}.    return {
+000480b0: 7d0a 0a0a 6465 6620 6465 6369 6465 5f77  }...def decide_w
+000480c0: 6f72 6b65 7228 0a20 2020 2074 733a 2054  orker(.    ts: T
+000480d0: 6173 6b53 7461 7465 2c0a 2020 2020 616c  askState,.    al
+000480e0: 6c5f 776f 726b 6572 733a 2049 7465 7261  l_workers: Itera
+000480f0: 626c 655b 576f 726b 6572 5374 6174 655d  ble[WorkerState]
+00048100: 2c0a 2020 2020 7661 6c69 645f 776f 726b  ,.    valid_work
+00048110: 6572 733a 2073 6574 5b57 6f72 6b65 7253  ers: set[WorkerS
+00048120: 7461 7465 5d20 7c20 4e6f 6e65 2c0a 2020  tate] | None,.  
+00048130: 2020 6f62 6a65 6374 6976 653a 2043 616c    objective: Cal
+00048140: 6c61 626c 655b 5b57 6f72 6b65 7253 7461  lable[[WorkerSta
+00048150: 7465 5d2c 2041 6e79 5d2c 0a29 202d 3e20  te], Any],.) -> 
+00048160: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00048170: 6e65 3a0a 2020 2020 2222 220a 2020 2020  ne:.    """.    
+00048180: 4465 6369 6465 2077 6869 6368 2077 6f72  Decide which wor
+00048190: 6b65 7220 7368 6f75 6c64 2074 616b 6520  ker should take 
+000481a0: 7461 736b 202a 7473 2a2e 0a0a 2020 2020  task *ts*...    
+000481b0: 5765 2063 686f 6f73 6520 7468 6520 776f  We choose the wo
+000481c0: 726b 6572 2074 6861 7420 6861 7320 7468  rker that has th
+000481d0: 6520 6461 7461 206f 6e20 7768 6963 6820  e data on which 
+000481e0: 2a74 732a 2064 6570 656e 6473 2e0a 0a20  *ts* depends... 
+000481f0: 2020 2049 6620 7365 7665 7261 6c20 776f     If several wo
+00048200: 726b 6572 7320 6861 7665 2064 6570 656e  rkers have depen
+00048210: 6465 6e63 6965 7320 7468 656e 2077 6520  dencies then we 
+00048220: 6368 6f6f 7365 2074 6865 206c 6573 732d  choose the less-
+00048230: 6275 7379 2077 6f72 6b65 722e 0a0a 2020  busy worker...  
+00048240: 2020 4f70 7469 6f6e 616c 6c79 2070 726f    Optionally pro
+00048250: 7669 6465 202a 7661 6c69 645f 776f 726b  vide *valid_work
+00048260: 6572 732a 206f 6620 7768 6572 6520 6a6f  ers* of where jo
+00048270: 6273 2061 7265 2061 6c6c 6f77 6564 2074  bs are allowed t
+00048280: 6f20 6f63 6375 720a 2020 2020 2869 6620  o occur.    (if 
+00048290: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
+000482a0: 616c 6c6f 7765 6420 746f 2074 616b 6520  allowed to take 
+000482b0: 7468 6520 7461 736b 2c20 7061 7373 204e  the task, pass N
+000482c0: 6f6e 6520 696e 7374 6561 6429 2e0a 0a20  one instead)... 
+000482d0: 2020 2049 6620 7468 6520 7461 736b 2072     If the task r
+000482e0: 6571 7569 7265 7320 6461 7461 2063 6f6d  equires data com
+000482f0: 6d75 6e69 6361 7469 6f6e 2062 6563 6175  munication becau
+00048300: 7365 206e 6f20 656c 6967 6962 6c65 2077  se no eligible w
+00048310: 6f72 6b65 7220 6861 730a 2020 2020 616c  orker has.    al
+00048320: 6c20 7468 6520 6465 7065 6e64 656e 6369  l the dependenci
+00048330: 6573 2061 6c72 6561 6479 2c20 7468 656e  es already, then
+00048340: 2077 6520 6368 6f6f 7365 2074 6f20 6d69   we choose to mi
+00048350: 6e69 6d69 7a65 2074 6865 206e 756d 6265  nimize the numbe
+00048360: 720a 2020 2020 6f66 2062 7974 6573 2073  r.    of bytes s
+00048370: 656e 7420 6265 7477 6565 6e20 776f 726b  ent between work
+00048380: 6572 732e 2020 5468 6973 2069 7320 6465  ers.  This is de
+00048390: 7465 726d 696e 6564 2062 7920 6361 6c6c  termined by call
+000483a0: 696e 6720 7468 650a 2020 2020 2a6f 626a  ing the.    *obj
+000483b0: 6563 7469 7665 2a20 6675 6e63 7469 6f6e  ective* function
+000483c0: 2e0a 2020 2020 2222 220a 2020 2020 6173  ..    """.    as
+000483d0: 7365 7274 2061 6c6c 2864 7473 2e77 686f  sert all(dts.who
+000483e0: 5f68 6173 2066 6f72 2064 7473 2069 6e20  _has for dts in 
+000483f0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00048400: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
+00048410: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
+00048420: 6174 6573 203d 2073 6574 2861 6c6c 5f77  ates = set(all_w
+00048430: 6f72 6b65 7273 290a 2020 2020 656c 7365  orkers).    else
+00048440: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
+00048450: 6174 6573 203d 207b 7777 7320 666f 7220  ates = {wws for 
+00048460: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+00048470: 656e 6369 6573 2066 6f72 2077 7773 2069  encies for wws i
+00048480: 6e20 6474 732e 7768 6f5f 6861 737d 0a20  n dts.who_has}. 
+00048490: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
+000484a0: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
+000484b0: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
+000484c0: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
+000484d0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
+000484e0: 2073 6574 2861 6c6c 5f77 6f72 6b65 7273   set(all_workers
+000484f0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00048500: 2020 2020 6361 6e64 6964 6174 6573 2026      candidates &
+00048510: 3d20 7661 6c69 645f 776f 726b 6572 730a  = valid_workers.
+00048520: 2020 2020 2020 2020 6966 206e 6f74 2063          if not c
+00048530: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
+00048540: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
+00048550: 7320 3d20 7661 6c69 645f 776f 726b 6572  s = valid_worker
+00048560: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+00048570: 206e 6f74 2063 616e 6469 6461 7465 733a   not candidates:
+00048580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048590: 2069 6620 7473 2e6c 6f6f 7365 5f72 6573   if ts.loose_res
+000485a0: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
+000485b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000485c0: 6574 7572 6e20 6465 6369 6465 5f77 6f72  eturn decide_wor
+000485d0: 6b65 7228 7473 2c20 616c 6c5f 776f 726b  ker(ts, all_work
+000485e0: 6572 732c 204e 6f6e 652c 206f 626a 6563  ers, None, objec
+000485f0: 7469 7665 290a 0a20 2020 2069 6620 6e6f  tive)..    if no
+00048600: 7420 6361 6e64 6964 6174 6573 3a0a 2020  t candidates:.  
+00048610: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00048620: 650a 2020 2020 656c 6966 206c 656e 2863  e.    elif len(c
+00048630: 616e 6469 6461 7465 7329 203d 3d20 313a  andidates) == 1:
+00048640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048650: 6e65 7874 2869 7465 7228 6361 6e64 6964  next(iter(candid
+00048660: 6174 6573 2929 0a20 2020 2065 6c73 653a  ates)).    else:
+00048670: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048680: 6d69 6e28 6361 6e64 6964 6174 6573 2c20  min(candidates, 
+00048690: 6b65 793d 6f62 6a65 6374 6976 6529 0a0a  key=objective)..
+000486a0: 0a64 6566 2076 616c 6964 6174 655f 7461  .def validate_ta
+000486b0: 736b 5f73 7461 7465 2874 733a 2054 6173  sk_state(ts: Tas
+000486c0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+000486d0: 0a20 2020 2022 2222 5661 6c69 6461 7465  .    """Validate
+000486e0: 2074 6865 2067 6976 656e 2054 6173 6b53   the given TaskS
+000486f0: 7461 7465 2222 220a 2020 2020 6173 7365  tate""".    asse
+00048700: 7274 2074 732e 7374 6174 6520 696e 2041  rt ts.state in A
+00048710: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
+00048720: 7473 0a0a 2020 2020 6966 2074 732e 7761  ts..    if ts.wa
+00048730: 6974 696e 675f 6f6e 3a0a 2020 2020 2020  iting_on:.      
+00048740: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
+00048750: 696e 675f 6f6e 2e69 7373 7562 7365 7428  ing_on.issubset(
+00048760: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00048770: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00048780: 2277 6169 7469 6e67 206e 6f74 2073 7562  "waiting not sub
+00048790: 7365 7420 6f66 2064 6570 656e 6465 6e63  set of dependenc
+000487a0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+000487b0: 2020 7374 7228 7473 2e77 6169 7469 6e67    str(ts.waiting
+000487c0: 5f6f 6e29 2c0a 2020 2020 2020 2020 2020  _on),.          
+000487d0: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
+000487e0: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
+000487f0: 290a 2020 2020 6966 2074 732e 7761 6974  ).    if ts.wait
+00048800: 6572 733a 0a20 2020 2020 2020 2061 7373  ers:.        ass
+00048810: 6572 7420 7473 2e77 6169 7465 7273 2e69  ert ts.waiters.i
+00048820: 7373 7562 7365 7428 7473 2e64 6570 656e  ssubset(ts.depen
+00048830: 6465 6e74 7329 2c20 280a 2020 2020 2020  dents), (.      
+00048840: 2020 2020 2020 2277 6169 7465 7273 206e        "waiters n
+00048850: 6f74 2073 7562 7365 7420 6f66 2064 6570  ot subset of dep
+00048860: 656e 6465 6e74 7322 2c0a 2020 2020 2020  endents",.      
+00048870: 2020 2020 2020 7374 7228 7473 2e77 6169        str(ts.wai
+00048880: 7465 7273 292c 0a20 2020 2020 2020 2020  ters),.         
+00048890: 2020 2073 7472 2874 732e 6465 7065 6e64     str(ts.depend
+000488a0: 656e 7473 292c 0a20 2020 2020 2020 2029  ents),.        )
+000488b0: 0a0a 2020 2020 666f 7220 6474 7320 696e  ..    for dts in
+000488c0: 2074 732e 7761 6974 696e 675f 6f6e 3a0a   ts.waiting_on:.
+000488d0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000488e0: 6f74 2064 7473 2e77 686f 5f68 6173 2c20  ot dts.who_has, 
+000488f0: 2822 7761 6974 696e 6720 6f6e 2069 6e2d  ("waiting on in-
+00048900: 6d65 6d6f 7279 2064 6570 222c 2073 7472  memory dep", str
+00048910: 2874 7329 2c20 7374 7228 6474 7329 290a  (ts), str(dts)).
+00048920: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+00048930: 7473 2e73 7461 7465 2021 3d20 2272 656c  ts.state != "rel
+00048940: 6561 7365 6422 2c20 2822 7761 6974 696e  eased", ("waitin
+00048950: 6720 6f6e 2072 656c 6561 7365 6420 6465  g on released de
+00048960: 7022 2c20 7374 7228 7473 292c 2073 7472  p", str(ts), str
+00048970: 2864 7473 2929 0a20 2020 2066 6f72 2064  (dts)).    for d
+00048980: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00048990: 6e63 6965 733a 0a20 2020 2020 2020 2061  ncies:.        a
+000489a0: 7373 6572 7420 7473 2069 6e20 6474 732e  ssert ts in dts.
+000489b0: 6465 7065 6e64 656e 7473 2c20 280a 2020  dependents, (.  
+000489c0: 2020 2020 2020 2020 2020 226e 6f74 2069            "not i
+000489d0: 6e20 6465 7065 6e64 656e 6379 2773 2064  n dependency's d
+000489e0: 6570 656e 6465 6e74 7322 2c0a 2020 2020  ependents",.    
+000489f0: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00048a00: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00048a10: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
+00048a20: 2020 2073 7472 2864 7473 2e64 6570 656e     str(dts.depen
+00048a30: 6465 6e74 7329 2c0a 2020 2020 2020 2020  dents),.        
+00048a40: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
+00048a50: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
+00048a60: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
+00048a70: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
+00048a80: 2d77 6f72 6b65 7222 293a 0a20 2020 2020  -worker"):.     
+00048a90: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+00048aa0: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
+00048ab0: 6f6e 206f 7220 6474 732e 7768 6f5f 6861  on or dts.who_ha
+00048ac0: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+00048ad0: 2020 2020 2022 6465 7020 6d69 7373 696e       "dep missin
+00048ae0: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+00048af0: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
+00048b00: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00048b10: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
+00048b20: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+00048b30: 6572 7420 6474 732e 7374 6174 6520 213d  ert dts.state !=
+00048b40: 2022 666f 7267 6f74 7465 6e22 0a0a 2020   "forgotten"..  
+00048b50: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00048b60: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
+00048b70: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
+00048b80: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
+00048b90: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
+00048ba0: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
+00048bb0: 6b65 7222 292c 2028 0a20 2020 2020 2020  ker"), (.       
+00048bc0: 2020 2020 2022 7761 6974 6572 206e 6f74       "waiter not
+00048bd0: 2069 6e20 706c 6179 222c 0a20 2020 2020   in play",.     
+00048be0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+00048bf0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00048c00: 6474 7329 2c0a 2020 2020 2020 2020 290a  dts),.        ).
+00048c10: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+00048c20: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
+00048c30: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00048c40: 696e 2064 7473 2e64 6570 656e 6465 6e63  in dts.dependenc
+00048c50: 6965 732c 2028 0a20 2020 2020 2020 2020  ies, (.         
+00048c60: 2020 2022 6e6f 7420 696e 2064 6570 656e     "not in depen
+00048c70: 6465 6e74 2773 2064 6570 656e 6465 6e63  dent's dependenc
+00048c80: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+00048c90: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+00048ca0: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
+00048cb0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00048cc0: 2864 7473 2e64 6570 656e 6465 6e63 6965  (dts.dependencie
+00048cd0: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
+00048ce0: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+00048cf0: 2e73 7461 7465 2021 3d20 2266 6f72 676f  .state != "forgo
+00048d00: 7474 656e 220a 0a20 2020 2061 7373 6572  tten"..    asser
+00048d10: 7420 2874 732e 7072 6f63 6573 7369 6e67  t (ts.processing
+00048d20: 5f6f 6e20 6973 206e 6f74 204e 6f6e 6529  _on is not None)
+00048d30: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
+00048d40: 2022 7072 6f63 6573 7369 6e67 2229 0a20   "processing"). 
+00048d50: 2020 2061 7373 6572 7420 626f 6f6c 2874     assert bool(t
+00048d60: 732e 7768 6f5f 6861 7329 203d 3d20 2874  s.who_has) == (t
+00048d70: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+00048d80: 7279 2229 2c20 2874 732c 2074 732e 7768  ry"), (ts, ts.wh
+00048d90: 6f5f 6861 732c 2074 732e 7374 6174 6529  o_has, ts.state)
+00048da0: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
+00048db0: 6520 3d3d 2022 7175 6575 6564 223a 0a20  e == "queued":. 
+00048dc0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00048dd0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00048de0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+00048df0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+00048e00: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00048e10: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
+00048e20: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00048e30: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
+00048e40: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+00048e50: 2071 7565 7565 6420 7769 7468 6f75 7420   queued without 
+00048e60: 616c 6c20 6465 7073 222c 0a20 2020 2020  all deps",.     
+00048e70: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+00048e80: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00048e90: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00048ea0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00048eb0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
+00048ec0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
+00048ed0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+00048ee0: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
+00048ef0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00048f00: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
+00048f10: 2020 2020 2020 2020 2274 6173 6b20 7072          "task pr
+00048f20: 6f63 6573 7369 6e67 2077 6974 686f 7574  ocessing without
+00048f30: 2061 6c6c 2064 6570 7322 2c0a 2020 2020   all deps",.    
+00048f40: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00048f50: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00048f60: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
+00048f70: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+00048f80: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00048f90: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
+00048fa0: 2020 2069 6620 7473 2e77 686f 5f68 6173     if ts.who_has
+00048fb0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00048fc0: 2074 732e 7761 6974 6572 7320 6f72 2074   ts.waiters or t
+00048fd0: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
+00048fe0: 2020 2020 2020 2020 2020 2022 756e 6e65             "unne
+00048ff0: 6564 6564 2074 6173 6b20 696e 206d 656d  eded task in mem
+00049000: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
+00049010: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+00049020: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
+00049030: 6f5f 6861 7329 2c0a 2020 2020 2020 2020  o_has),.        
+00049040: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
+00049050: 7275 6e5f 7370 6563 3a20 2023 2077 6173  run_spec:  # was
+00049060: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
+00049070: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00049080: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+00049090: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+000490a0: 6365 2874 732e 7479 7065 2c20 7374 7229  ce(ts.type, str)
+000490b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000490c0: 6e6f 7420 616e 7928 5b74 7320 696e 2064  not any([ts in d
+000490d0: 7473 2e77 6169 7469 6e67 5f6f 6e20 666f  ts.waiting_on fo
+000490e0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+000490f0: 6e64 656e 7473 5d29 0a20 2020 2020 2020  ndents]).       
+00049100: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
+00049110: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+00049120: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00049130: 7773 2e68 6173 5f77 6861 742c 2028 0a20  ws.has_what, (. 
+00049140: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00049150: 6e6f 7420 696e 2077 686f 5f68 6173 2720  not in who_has' 
+00049160: 6861 735f 7768 6174 222c 0a20 2020 2020  has_what",.     
+00049170: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+00049180: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00049190: 2020 2020 7374 7228 7773 292c 0a20 2020      str(ws),.   
+000491a0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+000491b0: 2877 732e 6861 735f 7768 6174 292c 0a20  (ws.has_what),. 
+000491c0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000491d0: 2020 666f 7220 6373 2069 6e20 7473 2e77    for cs in ts.w
+000491e0: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+000491f0: 2020 6173 7365 7274 2074 7320 696e 2063    assert ts in c
+00049200: 732e 7761 6e74 735f 7768 6174 2c20 280a  s.wants_what, (.
+00049210: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
+00049220: 2069 6e20 7768 6f5f 7761 6e74 7327 2077   in who_wants' w
+00049230: 616e 7473 5f77 6861 7422 2c0a 2020 2020  ants_what",.    
+00049240: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049250: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049260: 2863 7329 2c0a 2020 2020 2020 2020 2020  (cs),.          
+00049270: 2020 7374 7228 6373 2e77 616e 7473 5f77    str(cs.wants_w
+00049280: 6861 7429 2c0a 2020 2020 2020 2020 290a  hat),.        ).
+00049290: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
+000492a0: 3a0a 2020 2020 2020 2020 6966 2074 732e  :.        if ts.
+000492b0: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
+000492c0: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
+000492d0: 7373 6572 7420 7375 6d28 7473 2069 6e20  ssert sum(ts in 
+000492e0: 7773 2e61 6374 6f72 7320 666f 7220 7773  ws.actors for ws
+000492f0: 2069 6e20 7473 2e77 686f 5f68 6173 2920   in ts.who_has) 
+00049300: 3d3d 2031 0a20 2020 2020 2020 2069 6620  == 1.        if 
+00049310: 7473 2e73 7461 7465 203d 3d20 2270 726f  ts.state == "pro
+00049320: 6365 7373 696e 6722 3a0a 2020 2020 2020  cessing":.      
+00049330: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00049340: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00049350: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00049360: 2074 7320 696e 2074 732e 7072 6f63 6573   ts in ts.proces
+00049370: 7369 6e67 5f6f 6e2e 6163 746f 7273 0a20  sing_on.actors. 
+00049380: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00049390: 2e73 7461 7465 2021 3d20 2271 7565 7565  .state != "queue
+000493a0: 6422 0a0a 0a64 6566 2076 616c 6964 6174  d"...def validat
+000493b0: 655f 776f 726b 6572 5f73 7461 7465 2877  e_worker_state(w
+000493c0: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+000493d0: 2d3e 204e 6f6e 653a 0a20 2020 2066 6f72  -> None:.    for
+000493e0: 2074 7320 696e 2077 732e 6861 735f 7768   ts in ws.has_wh
+000493f0: 6174 3a0a 2020 2020 2020 2020 6173 7365  at:.        asse
+00049400: 7274 2077 7320 696e 2074 732e 7768 6f5f  rt ws in ts.who_
+00049410: 6861 732c 2028 0a20 2020 2020 2020 2020  has, (.         
+00049420: 2020 2022 6e6f 7420 696e 2068 6173 5f77     "not in has_w
+00049430: 6861 7427 2077 686f 5f68 6173 222c 0a20  hat' who_has",. 
+00049440: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
+00049450: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00049460: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+00049470: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
+00049480: 6861 7329 2c0a 2020 2020 2020 2020 290a  has),.        ).
+00049490: 0a20 2020 2066 6f72 2074 7320 696e 2077  .    for ts in w
+000494a0: 732e 6163 746f 7273 3a0a 2020 2020 2020  s.actors:.      
+000494b0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+000494c0: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
+000494d0: 2270 726f 6365 7373 696e 6722 290a 0a0a  "processing")...
+000494e0: 6465 6620 7661 6c69 6461 7465 5f73 7461  def validate_sta
+000494f0: 7465 280a 2020 2020 7461 736b 733a 2064  te(.    tasks: d
+00049500: 6963 745b 7374 722c 2054 6173 6b53 7461  ict[str, TaskSta
+00049510: 7465 5d2c 0a20 2020 2077 6f72 6b65 7273  te],.    workers
+00049520: 3a20 6469 6374 5b73 7472 2c20 576f 726b  : dict[str, Work
+00049530: 6572 5374 6174 655d 2c0a 2020 2020 636c  erState],.    cl
+00049540: 6965 6e74 733a 2064 6963 745b 7374 722c  ients: dict[str,
+00049550: 2043 6c69 656e 7453 7461 7465 5d2c 0a29   ClientState],.)
+00049560: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00049570: 2256 616c 6964 6174 6520 6120 6375 7272  "Validate a curr
+00049580: 656e 7420 7275 6e74 696d 6520 7374 6174  ent runtime stat
+00049590: 652e 0a0a 2020 2020 5468 6973 2070 6572  e...    This per
+000495a0: 666f 726d 7320 6120 7365 7175 656e 6365  forms a sequence
+000495b0: 206f 6620 6368 6563 6b73 206f 6e20 7468   of checks on th
+000495c0: 6520 656e 7469 7265 2067 7261 7068 2c20  e entire graph, 
+000495d0: 7275 6e6e 696e 6720 696e 2061 626f 7574  running in about
+000495e0: 206c 696e 6561 720a 2020 2020 7469 6d65   linear.    time
+000495f0: 2e20 5468 6973 2072 6169 7365 7320 6173  . This raises as
+00049600: 7365 7274 2065 7272 6f72 7320 6966 2061  sert errors if a
+00049610: 6e79 7468 696e 6720 646f 6573 6e27 7420  nything doesn't 
+00049620: 6368 6563 6b20 6f75 742e 0a20 2020 2022  check out..    "
+00049630: 2222 0a20 2020 2066 6f72 2074 7320 696e  "".    for ts in
+00049640: 2074 6173 6b73 2e76 616c 7565 7328 293a   tasks.values():
+00049650: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
+00049660: 655f 7461 736b 5f73 7461 7465 2874 7329  e_task_state(ts)
+00049670: 0a0a 2020 2020 666f 7220 7773 2069 6e20  ..    for ws in 
+00049680: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00049690: 3a0a 2020 2020 2020 2020 7661 6c69 6461  :.        valida
+000496a0: 7465 5f77 6f72 6b65 725f 7374 6174 6528  te_worker_state(
+000496b0: 7773 290a 0a20 2020 2066 6f72 2063 7320  ws)..    for cs 
+000496c0: 696e 2063 6c69 656e 7473 2e76 616c 7565  in clients.value
+000496d0: 7328 293a 0a20 2020 2020 2020 2066 6f72  s():.        for
+000496e0: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
+000496f0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
+00049700: 2020 6173 7365 7274 2063 7320 696e 2074    assert cs in t
+00049710: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
+00049720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00049730: 6e6f 7420 696e 2077 616e 7473 5f77 6861  not in wants_wha
+00049740: 7427 2077 686f 5f77 616e 7473 222c 0a20  t' who_wants",. 
+00049750: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00049760: 7472 2863 7329 2c0a 2020 2020 2020 2020  tr(cs),.        
+00049770: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049790: 2073 7472 2874 732e 7768 6f5f 7761 6e74   str(ts.who_want
+000497a0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000497b0: 290a 0a0a 6465 6620 6865 6172 7462 6561  )...def heartbea
+000497c0: 745f 696e 7465 7276 616c 286e 3a20 696e  t_interval(n: in
+000497d0: 7429 202d 3e20 666c 6f61 743a 0a20 2020  t) -> float:.   
+000497e0: 2022 2222 496e 7465 7276 616c 2069 6e20   """Interval in 
+000497f0: 7365 636f 6e64 7320 7468 6174 2077 6520  seconds that we 
+00049800: 6465 7369 7265 2068 6561 7274 6265 6174  desire heartbeat
+00049810: 7320 6261 7365 6420 6f6e 206e 756d 6265  s based on numbe
+00049820: 7220 6f66 2077 6f72 6b65 7273 2222 220a  r of workers""".
+00049830: 2020 2020 6966 206e 203c 3d20 3130 3a0a      if n <= 10:.
+00049840: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
+00049850: 2e35 0a20 2020 2065 6c69 6620 6e20 3c20  .5.    elif n < 
+00049860: 3530 3a0a 2020 2020 2020 2020 7265 7475  50:.        retu
+00049870: 726e 2031 0a20 2020 2065 6c69 6620 6e20  rn 1.    elif n 
+00049880: 3c20 3230 303a 0a20 2020 2020 2020 2072  < 200:.        r
+00049890: 6574 7572 6e20 320a 2020 2020 656c 7365  eturn 2.    else
+000498a0: 3a0a 2020 2020 2020 2020 2320 4e6f 206d  :.        # No m
+000498b0: 6f72 6520 7468 616e 2032 3030 2068 6561  ore than 200 hea
+000498c0: 7274 6265 6174 7320 6120 7365 636f 6e64  rtbeats a second
+000498d0: 2073 6361 6c65 6420 6279 2077 6f72 6b65   scaled by worke
+000498e0: 7273 0a20 2020 2020 2020 2072 6574 7572  rs.        retur
+000498f0: 6e20 6e20 2f20 3230 3020 2b20 310a 0a0a  n n / 200 + 1...
+00049900: 6465 6620 5f74 6173 6b5f 736c 6f74 735f  def _task_slots_
+00049910: 6176 6169 6c61 626c 6528 7773 3a20 576f  available(ws: Wo
+00049920: 726b 6572 5374 6174 652c 2073 6174 7572  rkerState, satur
+00049930: 6174 696f 6e5f 6661 6374 6f72 3a20 666c  ation_factor: fl
+00049940: 6f61 7429 202d 3e20 696e 743a 0a20 2020  oat) -> int:.   
+00049950: 2022 2222 4e75 6d62 6572 206f 6620 7461   """Number of ta
+00049960: 736b 7320 7468 6174 2063 616e 2062 6520  sks that can be 
+00049970: 7365 6e74 2074 6f20 7468 6973 2077 6f72  sent to this wor
+00049980: 6b65 7220 7769 7468 6f75 7420 6f76 6572  ker without over
+00049990: 7361 7475 7261 7469 6e67 2069 7422 2222  saturating it"""
+000499a0: 0a20 2020 2061 7373 6572 7420 6e6f 7420  .    assert not 
+000499b0: 6d61 7468 2e69 7369 6e66 2873 6174 7572  math.isinf(satur
+000499c0: 6174 696f 6e5f 6661 6374 6f72 290a 2020  ation_factor).  
+000499d0: 2020 7265 7475 726e 206d 6178 286d 6174    return max(mat
+000499e0: 682e 6365 696c 2873 6174 7572 6174 696f  h.ceil(saturatio
+000499f0: 6e5f 6661 6374 6f72 202a 2077 732e 6e74  n_factor * ws.nt
+00049a00: 6872 6561 6473 292c 2031 2920 2d20 280a  hreads), 1) - (.
+00049a10: 2020 2020 2020 2020 6c65 6e28 7773 2e70          len(ws.p
+00049a20: 726f 6365 7373 696e 6729 202d 206c 656e  rocessing) - len
+00049a30: 2877 732e 6c6f 6e67 5f72 756e 6e69 6e67  (ws.long_running
+00049a40: 290a 2020 2020 290a 0a0a 6465 6620 5f77  ).    )...def _w
+00049a50: 6f72 6b65 725f 6675 6c6c 2877 733a 2057  orker_full(ws: W
+00049a60: 6f72 6b65 7253 7461 7465 2c20 7361 7475  orkerState, satu
+00049a70: 7261 7469 6f6e 5f66 6163 746f 723a 2066  ration_factor: f
+00049a80: 6c6f 6174 2920 2d3e 2062 6f6f 6c3a 0a20  loat) -> bool:. 
+00049a90: 2020 2069 6620 6d61 7468 2e69 7369 6e66     if math.isinf
+00049aa0: 2873 6174 7572 6174 696f 6e5f 6661 6374  (saturation_fact
+00049ab0: 6f72 293a 0a20 2020 2020 2020 2072 6574  or):.        ret
+00049ac0: 7572 6e20 4661 6c73 650a 2020 2020 7265  urn False.    re
+00049ad0: 7475 726e 205f 7461 736b 5f73 6c6f 7473  turn _task_slots
+00049ae0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
+00049af0: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
+00049b00: 2920 3c3d 2030 0a0a 0a63 6c61 7373 204b  ) <= 0...class K
+00049b10: 696c 6c65 6457 6f72 6b65 7228 4578 6365  illedWorker(Exce
+00049b20: 7074 696f 6e29 3a0a 2020 2020 6465 6620  ption):.    def 
+00049b30: 5f5f 696e 6974 5f5f 2873 656c 662c 2074  __init__(self, t
+00049b40: 6173 6b3a 2073 7472 2c20 6c61 7374 5f77  ask: str, last_w
+00049b50: 6f72 6b65 723a 2057 6f72 6b65 7253 7461  orker: WorkerSta
+00049b60: 7465 2c20 616c 6c6f 7765 645f 6661 696c  te, allowed_fail
+00049b70: 7572 6573 3a20 696e 7429 3a0a 2020 2020  ures: int):.    
+00049b80: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+00049b90: 6974 5f5f 2874 6173 6b2c 206c 6173 745f  it__(task, last_
+00049ba0: 776f 726b 6572 2c20 616c 6c6f 7765 645f  worker, allowed_
+00049bb0: 6661 696c 7572 6573 290a 0a20 2020 2040  failures)..    @
+00049bc0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00049bd0: 2074 6173 6b28 7365 6c66 2920 2d3e 2073   task(self) -> s
+00049be0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+00049bf0: 726e 2073 656c 662e 6172 6773 5b30 5d0a  rn self.args[0].
+00049c00: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00049c10: 2020 2064 6566 206c 6173 745f 776f 726b     def last_work
+00049c20: 6572 2873 656c 6629 202d 3e20 576f 726b  er(self) -> Work
+00049c30: 6572 5374 6174 653a 0a20 2020 2020 2020  erState:.       
+00049c40: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
+00049c50: 735b 315d 0a0a 2020 2020 4070 726f 7065  s[1]..    @prope
+00049c60: 7274 790a 2020 2020 6465 6620 616c 6c6f  rty.    def allo
+00049c70: 7765 645f 6661 696c 7572 6573 2873 656c  wed_failures(sel
+00049c80: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00049c90: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
+00049ca0: 7267 735b 325d 0a0a 2020 2020 6465 6620  rgs[2]..    def 
+00049cb0: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
+00049cc0: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00049cd0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00049ce0: 2020 2066 2241 7474 656d 7074 6564 2074     f"Attempted t
+00049cf0: 6f20 7275 6e20 7461 736b 207b 7365 6c66  o run task {self
+00049d00: 2e74 6173 6b7d 206f 6e20 7b73 656c 662e  .task} on {self.
+00049d10: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+00049d20: 7d20 6469 6666 6572 656e 7420 220a 2020  } different ".  
+00049d30: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+00049d40: 7273 2c20 6275 7420 616c 6c20 7468 6f73  rs, but all thos
+00049d50: 6520 776f 726b 6572 7320 6469 6564 2077  e workers died w
+00049d60: 6869 6c65 2072 756e 6e69 6e67 2069 742e  hile running it.
+00049d70: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00049d80: 2254 6865 206c 6173 7420 776f 726b 6572  "The last worker
+00049d90: 2074 6861 7420 6174 7465 6d70 7420 746f   that attempt to
+00049da0: 2072 756e 2074 6865 2074 6173 6b20 7761   run the task wa
+00049db0: 7320 7b73 656c 662e 6c61 7374 5f77 6f72  s {self.last_wor
+00049dc0: 6b65 722e 6164 6472 6573 737d 2e20 220a  ker.address}. ".
+00049dd0: 2020 2020 2020 2020 2020 2020 2249 6e73              "Ins
+00049de0: 7065 6374 696e 6720 776f 726b 6572 206c  pecting worker l
+00049df0: 6f67 7320 6973 206f 6674 656e 2061 2067  ogs is often a g
+00049e00: 6f6f 6420 6e65 7874 2073 7465 7020 746f  ood next step to
+00049e10: 2064 6961 676e 6f73 6520 7768 6174 2077   diagnose what w
+00049e20: 656e 7420 7772 6f6e 672e 2022 0a20 2020  ent wrong. ".   
+00049e30: 2020 2020 2020 2020 2022 466f 7220 6d6f           "For mo
+00049e40: 7265 2069 6e66 6f72 6d61 7469 6f6e 2073  re information s
+00049e50: 6565 2068 7474 7073 3a2f 2f64 6973 7472  ee https://distr
+00049e60: 6962 7574 6564 2e64 6173 6b2e 6f72 672f  ibuted.dask.org/
+00049e70: 656e 2f73 7461 626c 652f 6b69 6c6c 6564  en/stable/killed
+00049e80: 2e68 746d 6c2e 220a 2020 2020 2020 2020  .html.".        
+00049e90: 290a 0a0a 636c 6173 7320 576f 726b 6572  )...class Worker
+00049ea0: 5374 6174 7573 506c 7567 696e 2853 6368  StatusPlugin(Sch
+00049eb0: 6564 756c 6572 506c 7567 696e 293a 0a20  edulerPlugin):. 
+00049ec0: 2020 2022 2222 4120 706c 7567 696e 2074     """A plugin t
+00049ed0: 6f20 7368 6172 6520 776f 726b 6572 2073  o share worker s
+00049ee0: 7461 7475 7320 7769 7468 2061 2072 656d  tatus with a rem
+00049ef0: 6f74 6520 6f62 7365 7276 6572 0a0a 2020  ote observer..  
+00049f00: 2020 5468 6973 2069 7320 7573 6564 2069    This is used i
+00049f10: 6e20 636c 7573 7465 7220 6d61 6e61 6765  n cluster manage
+00049f20: 7273 2074 6f20 6b65 6570 2075 7064 6174  rs to keep updat
+00049f30: 6564 2061 626f 7574 2074 6865 2073 7461  ed about the sta
+00049f40: 7475 7320 6f66 2074 6865 2073 6368 6564  tus of the sched
+00049f50: 756c 6572 2e0a 2020 2020 2222 220a 0a20  uler..    """.. 
+00049f60: 2020 206e 616d 653a 2043 6c61 7373 5661     name: ClassVa
+00049f70: 725b 7374 725d 203d 2022 776f 726b 6572  r[str] = "worker
+00049f80: 2d73 7461 7475 7322 0a20 2020 2062 636f  -status".    bco
+00049f90: 6d6d 3a20 4261 7463 6865 6453 656e 640a  mm: BatchedSend.
+00049fa0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00049fb0: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+00049fc0: 723a 2053 6368 6564 756c 6572 2c20 636f  r: Scheduler, co
+00049fd0: 6d6d 3a20 436f 6d6d 293a 0a20 2020 2020  mm: Comm):.     
+00049fe0: 2020 2073 656c 662e 6263 6f6d 6d20 3d20     self.bcomm = 
+00049ff0: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
+0004a000: 7276 616c 3d22 356d 7322 290a 2020 2020  rval="5ms").    
+0004a010: 2020 2020 7365 6c66 2e62 636f 6d6d 2e73      self.bcomm.s
+0004a020: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
+0004a030: 2020 2073 6368 6564 756c 6572 2e61 6464     scheduler.add
+0004a040: 5f70 6c75 6769 6e28 7365 6c66 290a 0a20  _plugin(self).. 
+0004a050: 2020 2064 6566 2061 6464 5f77 6f72 6b65     def add_worke
+0004a060: 7228 7365 6c66 2c20 7363 6865 6475 6c65  r(self, schedule
+0004a070: 723a 2053 6368 6564 756c 6572 2c20 776f  r: Scheduler, wo
+0004a080: 726b 6572 3a20 7374 7229 202d 3e20 4e6f  rker: str) -> No
+0004a090: 6e65 3a0a 2020 2020 2020 2020 6964 656e  ne:.        iden
+0004a0a0: 7420 3d20 7363 6865 6475 6c65 722e 776f  t = scheduler.wo
+0004a0b0: 726b 6572 735b 776f 726b 6572 5d2e 6964  rkers[worker].id
+0004a0c0: 656e 7469 7479 2829 0a20 2020 2020 2020  entity().       
+0004a0d0: 2064 656c 2069 6465 6e74 5b22 6d65 7472   del ident["metr
+0004a0e0: 6963 7322 5d0a 2020 2020 2020 2020 6465  ics"].        de
+0004a0f0: 6c20 6964 656e 745b 226c 6173 745f 7365  l ident["last_se
+0004a100: 656e 225d 0a20 2020 2020 2020 2074 7279  en"].        try
+0004a110: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0004a120: 6c66 2e62 636f 6d6d 2e73 656e 6428 5b22  lf.bcomm.send(["
+0004a130: 6164 6422 2c20 7b22 776f 726b 6572 7322  add", {"workers"
+0004a140: 3a20 7b77 6f72 6b65 723a 2069 6465 6e74  : {worker: ident
+0004a150: 7d7d 5d29 0a20 2020 2020 2020 2065 7863  }}]).        exc
+0004a160: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
+0004a170: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0004a180: 2073 6368 6564 756c 6572 2e72 656d 6f76   scheduler.remov
+0004a190: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
+0004a1a0: 6c66 2e6e 616d 6529 0a0a 2020 2020 6465  lf.name)..    de
+0004a1b0: 6620 7265 6d6f 7665 5f77 6f72 6b65 7228  f remove_worker(
+0004a1c0: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
+0004a1d0: 2053 6368 6564 756c 6572 2c20 776f 726b   Scheduler, work
+0004a1e0: 6572 3a20 7374 7229 202d 3e20 4e6f 6e65  er: str) -> None
+0004a1f0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+0004a200: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004a210: 6263 6f6d 6d2e 7365 6e64 285b 2272 656d  bcomm.send(["rem
+0004a220: 6f76 6522 2c20 776f 726b 6572 5d29 0a20  ove", worker]). 
+0004a230: 2020 2020 2020 2065 7863 6570 7420 436f         except Co
+0004a240: 6d6d 436c 6f73 6564 4572 726f 723a 0a20  mmClosedError:. 
+0004a250: 2020 2020 2020 2020 2020 2073 6368 6564             sched
+0004a260: 756c 6572 2e72 656d 6f76 655f 706c 7567  uler.remove_plug
+0004a270: 696e 286e 616d 653d 7365 6c66 2e6e 616d  in(name=self.nam
+0004a280: 6529 0a0a 2020 2020 6465 6620 7465 6172  e)..    def tear
+0004a290: 646f 776e 2873 656c 6629 202d 3e20 4e6f  down(self) -> No
+0004a2a0: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+0004a2b0: 2e62 636f 6d6d 2e63 6c6f 7365 2829 0a0a  .bcomm.close()..
+0004a2c0: 0a63 6c61 7373 2043 6f6c 6c65 6374 5461  .class CollectTa
+0004a2d0: 736b 4d65 7461 4461 7461 506c 7567 696e  skMetaDataPlugin
+0004a2e0: 2853 6368 6564 756c 6572 506c 7567 696e  (SchedulerPlugin
+0004a2f0: 293a 0a20 2020 2073 6368 6564 756c 6572  ):.    scheduler
+0004a300: 3a20 5363 6865 6475 6c65 720a 2020 2020  : Scheduler.    
+0004a310: 6e61 6d65 3a20 7374 720a 2020 2020 6b65  name: str.    ke
+0004a320: 7973 3a20 7365 745b 7374 725d 0a20 2020  ys: set[str].   
+0004a330: 206d 6574 6164 6174 613a 2064 6963 745b   metadata: dict[
+0004a340: 7374 722c 2041 6e79 5d0a 2020 2020 7374  str, Any].    st
+0004a350: 6174 653a 2064 6963 745b 7374 722c 2073  ate: dict[str, s
+0004a360: 7472 5d0a 0a20 2020 2064 6566 205f 5f69  tr]..    def __i
+0004a370: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
+0004a380: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
+0004a390: 2c20 6e61 6d65 3a20 7374 7229 3a0a 2020  , name: str):.  
+0004a3a0: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+0004a3b0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+0004a3c0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
+0004a3d0: 6d65 203d 206e 616d 650a 2020 2020 2020  me = name.      
+0004a3e0: 2020 7365 6c66 2e6b 6579 7320 3d20 7365    self.keys = se
+0004a3f0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+0004a400: 2e6d 6574 6164 6174 6120 3d20 7b7d 0a20  .metadata = {}. 
+0004a410: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
+0004a420: 6520 3d20 7b7d 0a0a 2020 2020 6465 6620  e = {}..    def 
+0004a430: 7570 6461 7465 5f67 7261 7068 280a 2020  update_graph(.  
+0004a440: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0004a450: 2020 2020 7363 6865 6475 6c65 723a 2053      scheduler: S
+0004a460: 6368 6564 756c 6572 2c0a 2020 2020 2020  cheduler,.      
+0004a470: 2020 2a2c 0a20 2020 2020 2020 206b 6579    *,.        key
+0004a480: 733a 2073 6574 5b73 7472 5d2c 0a20 2020  s: set[str],.   
+0004a490: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+0004a4a0: 6e79 2c0a 2020 2020 2920 2d3e 204e 6f6e  ny,.    ) -> Non
+0004a4b0: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
+0004a4c0: 6b65 7973 2e75 7064 6174 6528 6b65 7973  keys.update(keys
+0004a4d0: 290a 0a20 2020 2064 6566 2074 7261 6e73  )..    def trans
+0004a4e0: 6974 696f 6e28 0a20 2020 2020 2020 2073  ition(.        s
+0004a4f0: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+0004a500: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+0004a510: 7461 7274 3a20 5461 736b 5374 6174 6553  tart: TaskStateS
+0004a520: 7461 7465 2c0a 2020 2020 2020 2020 6669  tate,.        fi
+0004a530: 6e69 7368 3a20 5461 736b 5374 6174 6553  nish: TaskStateS
+0004a540: 7461 7465 2c0a 2020 2020 2020 2020 2a61  tate,.        *a
+0004a550: 7267 733a 2041 6e79 2c0a 2020 2020 2020  rgs: Any,.      
+0004a560: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+0004a570: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+0004a580: 2020 2020 2020 2020 6966 2066 696e 6973          if finis
+0004a590: 6820 696e 2028 226d 656d 6f72 7922 2c20  h in ("memory", 
+0004a5a0: 2265 7272 6564 2229 3a0a 2020 2020 2020  "erred"):.      
+0004a5b0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+0004a5c0: 7363 6865 6475 6c65 722e 7461 736b 732e  scheduler.tasks.
+0004a5d0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0004a5e0: 2020 2020 2069 6620 7473 2069 7320 6e6f       if ts is no
+0004a5f0: 7420 4e6f 6e65 2061 6e64 2074 732e 6b65  t None and ts.ke
+0004a600: 7920 696e 2073 656c 662e 6b65 7973 3a0a  y in self.keys:.
+0004a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a620: 7365 6c66 2e6d 6574 6164 6174 615b 6b65  self.metadata[ke
+0004a630: 795d 203d 2074 732e 6d65 7461 6461 7461  y] = ts.metadata
+0004a640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a650: 2073 656c 662e 7374 6174 655b 6b65 795d   self.state[key]
+0004a660: 203d 2066 696e 6973 680a 2020 2020 2020   = finish.      
+0004a670: 2020 2020 2020 2020 2020 7365 6c66 2e6b            self.k
+0004a680: 6579 732e 6469 7363 6172 6428 6b65 7929  eys.discard(key)
+0004a690: 0a                                       .
```

### Comparing `distributed-2023.5.1/distributed/security.py` & `distributed-2023.6.0/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/semaphore.py` & `distributed-2023.6.0/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/__init__.py` & `distributed-2023.6.0/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_buffer.py` & `distributed-2023.6.0/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_comms.py` & `distributed-2023.6.0/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_disk.py` & `distributed-2023.6.0/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_limiter.py` & `distributed-2023.6.0/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_merge.py` & `distributed-2023.6.0/distributed/shuffle/_merge.py`

 * *Files 6% similar despite different names*

```diff
@@ -104,17 +104,19 @@
     meta = _lhs_meta.merge(_rhs_meta, **merge_kwargs)
     lhs = _calculate_partitions(lhs, left_on, npartitions)
     rhs = _calculate_partitions(rhs, right_on, npartitions)
     merge_name = "hash-join-" + tokenize(lhs, rhs, **merge_kwargs)
     join_layer = HashJoinP2PLayer(
         name=merge_name,
         name_input_left=lhs._name,
+        meta_input_left=lhs._meta,
         left_on=left_on,
         n_partitions_left=lhs.npartitions,
         name_input_right=rhs._name,
+        meta_input_right=rhs._meta,
         right_on=right_on,
         n_partitions_right=rhs.npartitions,
         meta_output=meta,
         how=how,
         npartitions=npartitions,
         suffixes=suffixes,
         indicator=indicator,
@@ -154,26 +156,29 @@
     shuffle_id_right: ShuffleId,
     output_partition: int,
     barrier_left: int,
     barrier_right: int,
     how: MergeHow,
     left_on: IndexLabel,
     right_on: IndexLabel,
+    meta_left: pd.DataFrame,
+    meta_right: pd.DataFrame,
     result_meta: pd.DataFrame,
     suffixes: Suffixes,
 ):
     from dask.dataframe.multi import merge_chunk
 
     ext = _get_worker_extension()
+    # If the partition is empty, it doesn't contain the hash column name
     left = ext.get_output_partition(
-        shuffle_id_left, barrier_left, output_partition
-    ).drop(columns=_HASH_COLUMN_NAME)
+        shuffle_id_left, barrier_left, output_partition, meta=meta_left
+    ).drop(columns=_HASH_COLUMN_NAME, errors="ignore")
     right = ext.get_output_partition(
-        shuffle_id_right, barrier_right, output_partition
-    ).drop(columns=_HASH_COLUMN_NAME)
+        shuffle_id_right, barrier_right, output_partition, meta=meta_right
+    ).drop(columns=_HASH_COLUMN_NAME, errors="ignore")
     return merge_chunk(
         left,
         right,
         how=how,
         result_meta=result_meta,
         left_on=left_on,
         right_on=right_on,
@@ -182,33 +187,37 @@
 
 
 class HashJoinP2PLayer(Layer):
     def __init__(
         self,
         name: str,
         name_input_left: str,
+        meta_input_left: pd.DataFrame,
         left_on,
         n_partitions_left: int,
         n_partitions_right: int,
         name_input_right: str,
+        meta_input_right: pd.DataFrame,
         right_on,
         meta_output: pd.DataFrame,
         left_index: bool,
         right_index: bool,
         how: MergeHow = "inner",
         npartitions: int | None = None,
         suffixes: Suffixes = ("_x", "_y"),
         indicator: bool = False,
         parts_out: Sequence | None = None,
         annotations: dict | None = None,
     ) -> None:
         self.name = name
         self.name_input_left = name_input_left
+        self.meta_input_left = meta_input_left
         self.left_on = left_on
         self.name_input_right = name_input_right
+        self.meta_input_right = meta_input_right
         self.right_on = right_on
         self.how = how
         self.npartitions = npartitions
         self.suffixes = suffixes
         self.indicator = indicator
         self.meta_output = meta_output
         self.parts_out = parts_out or list(range(npartitions))
@@ -281,16 +290,18 @@
             self._cached_dict = dsk
         return self._cached_dict
 
     def _cull(self, parts_out: Sequence[str]):
         return HashJoinP2PLayer(
             name=self.name,
             name_input_left=self.name_input_left,
+            meta_input_left=self.meta_input_left,
             left_on=self.left_on,
             name_input_right=self.name_input_right,
+            meta_input_right=self.meta_input_right,
             right_on=self.right_on,
             how=self.how,
             npartitions=self.npartitions,
             suffixes=self.suffixes,
             indicator=self.indicator,
             meta_output=self.meta_output,
             parts_out=parts_out,
@@ -369,11 +380,13 @@
                 token_right,
                 part_out,
                 _barrier_key_left,
                 _barrier_key_right,
                 self.how,
                 self.left_on,
                 self.right_on,
+                self.meta_input_left,
+                self.meta_input_right,
                 self.meta_output,
                 self.suffixes,
             )
         return dsk
```

### Comparing `distributed-2023.5.1/distributed/shuffle/_rechunk.py` & `distributed-2023.6.0/distributed/shuffle/_rechunk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/shuffle/_scheduler_extension.py` & `distributed-2023.6.0/distributed/shuffle/_scheduler_extension.py`

 * *Files 2% similar despite different names*

```diff
@@ -46,25 +46,23 @@
         """Transform the shuffle state into a JSON-serializable message"""
 
 
 @dataclass
 class DataFrameShuffleState(ShuffleState):
     type: ClassVar[ShuffleType] = ShuffleType.DATAFRAME
     worker_for: dict[int, str]
-    schema: bytes
     column: str
 
     def to_msg(self) -> dict[str, Any]:
         return {
             "status": "OK",
             "type": DataFrameShuffleState.type,
             "run_id": self.run_id,
             "worker_for": self.worker_for,
             "column": self.column,
-            "schema": self.schema,
             "output_workers": self.output_workers,
         }
 
 
 @dataclass
 class ArrayRechunkState(ShuffleState):
     type: ClassVar[ShuffleType] = ShuffleType.ARRAY_RECHUNK
@@ -182,33 +180,30 @@
                 "task fusion during graph generation. Please let us know that you ran "
                 "into this by leaving a comment at distributed#7816."
             )
 
     def _create_dataframe_shuffle_state(
         self, id: ShuffleId, spec: dict[str, Any]
     ) -> DataFrameShuffleState:
-        schema = spec["schema"]
         column = spec["column"]
         npartitions = spec["npartitions"]
         parts_out = spec["parts_out"]
-        assert schema is not None
         assert column is not None
         assert npartitions is not None
         assert parts_out is not None
 
         pick_worker = partial(get_worker_for_range_sharding, npartitions)
 
         mapping = self._pin_output_workers(id, parts_out, pick_worker)
         output_workers = set(mapping.values())
 
         return DataFrameShuffleState(
             id=id,
             run_id=next(ShuffleState._run_id_iterator),
             worker_for=mapping,
-            schema=schema,
             column=column,
             output_workers=output_workers,
             participating_workers=output_workers.copy(),
         )
 
     def _pin_output_workers(
         self,
```

### Comparing `distributed-2023.5.1/distributed/shuffle/_shuffle.py` & `distributed-2023.6.0/distributed/shuffle/_shuffle.py`

 * *Files 12% similar despite different names*

```diff
@@ -70,19 +70,19 @@
             parts_out=parts_out,
         )
     except Exception as e:
         raise RuntimeError(f"shuffle_transfer failed during shuffle {id}") from e
 
 
 def shuffle_unpack(
-    id: ShuffleId, output_partition: int, barrier_run_id: int
+    id: ShuffleId, output_partition: int, barrier_run_id: int, meta: pd.DataFrame
 ) -> pd.DataFrame:
     try:
         return _get_worker_extension().get_output_partition(
-            id, barrier_run_id, output_partition
+            id, barrier_run_id, output_partition, meta=meta
         )
     except Reschedule as e:
         raise e
     except Exception as e:
         raise RuntimeError(f"shuffle_unpack failed during shuffle {id}") from e
 
 
@@ -96,37 +96,38 @@
 def rearrange_by_column_p2p(
     df: DataFrame,
     column: str,
     npartitions: int | None = None,
 ) -> DataFrame:
     from dask.dataframe import DataFrame
 
-    check_dtype_support(df._meta)
+    meta = df._meta
+    check_dtype_support(meta)
     npartitions = npartitions or df.npartitions
     token = tokenize(df, column, npartitions)
 
-    empty = df._meta.copy()
-    if any(not isinstance(c, str) for c in empty.columns):
-        unsupported = {c: type(c) for c in empty.columns if not isinstance(c, str)}
+    if any(not isinstance(c, str) for c in meta.columns):
+        unsupported = {c: type(c) for c in meta.columns if not isinstance(c, str)}
         raise TypeError(
             f"p2p requires all column names to be str, found: {unsupported}",
         )
 
     name = f"shuffle-p2p-{token}"
     layer = P2PShuffleLayer(
         name,
         column,
         npartitions,
         npartitions_input=df.npartitions,
         name_input=df._name,
+        meta_input=meta,
     )
     return DataFrame(
         HighLevelGraph.from_collections(name, layer, [df]),
         name,
-        empty,
+        meta,
         [None] * (npartitions + 1),
     )
 
 
 _T_Key: TypeAlias = Union[tuple[str, int], str]
 _T_LowLevelGraph: TypeAlias = dict[_T_Key, tuple]
 
@@ -135,22 +136,24 @@
     def __init__(
         self,
         name: str,
         column: str,
         npartitions: int,
         npartitions_input: int,
         name_input: str,
+        meta_input: pd.DataFrame,
         parts_out: Iterable | None = None,
         annotations: dict | None = None,
     ):
         check_minimal_arrow_version()
         self.name = name
         self.column = column
         self.npartitions = npartitions
         self.name_input = name_input
+        self.meta_input = meta_input
         if parts_out:
             self.parts_out = set(parts_out)
         else:
             self.parts_out = set(range(self.npartitions))
         self.npartitions_input = npartitions_input
         annotations = annotations or {}
         annotations.update({"shuffle": lambda key: key[1]})
@@ -191,14 +194,15 @@
     def _cull(self, parts_out: Iterable[int]) -> P2PShuffleLayer:
         return P2PShuffleLayer(
             self.name,
             self.column,
             self.npartitions,
             self.npartitions_input,
             self.name_input,
+            self.meta_input,
             parts_out=parts_out,
         )
 
     def _keys_to_parts(self, keys: Iterable[_T_Key]) -> set[int]:
         """Simple utility to convert keys to partition indices."""
         parts = set()
         for key in keys:
@@ -247,15 +251,21 @@
                 self.parts_out,
             )
 
         dsk[_barrier_key] = (shuffle_barrier, token, transfer_keys)
 
         name = self.name
         for part_out in self.parts_out:
-            dsk[(name, part_out)] = (shuffle_unpack, token, part_out, _barrier_key)
+            dsk[(name, part_out)] = (
+                shuffle_unpack,
+                token,
+                part_out,
+                _barrier_key,
+                self.meta_input,
+            )
         return dsk
 
 
 _BARRIER_PREFIX = "shuffle-barrier-"
 
 
 def barrier_key(shuffle_id: ShuffleId) -> str:
```

### Comparing `distributed-2023.5.1/distributed/shuffle/_worker_extension.py` & `distributed-2023.6.0/distributed/shuffle/_worker_extension.py`

 * *Files 4% similar despite different names*

```diff
@@ -19,15 +19,14 @@
 from dask.utils import parse_bytes
 
 from distributed.core import PooledRPCCall
 from distributed.exceptions import Reschedule
 from distributed.protocol import to_serialize
 from distributed.shuffle._arrow import (
     convert_partition,
-    deserialize_schema,
     list_of_buffers_to_table,
     serialize_table,
 )
 from distributed.shuffle._comms import CommShardsBuffer
 from distributed.shuffle._disk import DiskShardsBuffer
 from distributed.shuffle._limiter import ResourceLimiter
 from distributed.shuffle._rechunk import ChunkedAxes, NIndex
@@ -231,15 +230,15 @@
     async def add_partition(
         self, data: T_partition_type, input_partition: T_partition_id
     ) -> int:
         """Add an input partition to the shuffle run"""
 
     @abc.abstractmethod
     async def get_output_partition(
-        self, i: T_partition_id, key: str
+        self, i: T_partition_id, key: str, meta: pd.DataFrame | None = None
     ) -> T_partition_type:
         """Get an output partition to the shuffle run"""
 
 
 class ArrayRechunkRun(ShuffleRun[ArrayRechunkShardID, NIndex, "np.ndarray"]):
     """State for a single active rechunk execution
 
@@ -377,16 +376,19 @@
                 )
             return out
 
         out = await self.offload(_)
         await self._write_to_comm(out)
         return self.run_id
 
-    async def get_output_partition(self, i: NIndex, key: str) -> np.ndarray:
+    async def get_output_partition(
+        self, i: NIndex, key: str, meta: pd.DataFrame | None = None
+    ) -> np.ndarray:
         self.raise_if_closed()
+        assert meta is None
         assert self.transferred, "`get_output_partition` called before barrier task"
 
         await self._ensure_output_worker(i, key)
 
         await self.flush_receive()
 
         data = self._read_from_disk(i)
@@ -417,16 +419,14 @@
     ----------
     worker_for:
         A mapping partition_id -> worker_address.
     output_workers:
         A set of all participating worker (addresses).
     column:
         The data column we split the input partition by.
-    schema:
-        The schema of the payload data.
     id:
         A unique `ShuffleID` this belongs to.
     run_id:
         A unique identifier of the specific execution of the shuffle this belongs to.
     local_address:
         The local address this Shuffle can be contacted by using `rpc`.
     directory:
@@ -447,15 +447,14 @@
     """
 
     def __init__(
         self,
         worker_for: dict[int, str],
         output_workers: set,
         column: str,
-        schema: pa.Schema,
         id: ShuffleId,
         run_id: int,
         local_address: str,
         directory: str,
         executor: ThreadPoolExecutor,
         rpc: Callable[[str], PooledRPCCall],
         scheduler: PooledRPCCall,
@@ -473,15 +472,14 @@
             executor=executor,
             rpc=rpc,
             scheduler=scheduler,
             memory_limiter_comms=memory_limiter_comms,
             memory_limiter_disk=memory_limiter_disk,
         )
         self.column = column
-        self.schema = schema
         partitions_of = defaultdict(list)
         for part, addr in worker_for.items():
             partitions_of[addr].append(part)
         self.partitions_of = dict(partitions_of)
         self.worker_for = pd.Series(worker_for, name="_workers").astype("category")
 
     async def receive(self, data: list[tuple[int, bytes]]) -> None:
@@ -528,31 +526,33 @@
             out = {k: [(input_partition, serialize_table(t))] for k, t in out.items()}
             return out
 
         out = await self.offload(_)
         await self._write_to_comm(out)
         return self.run_id
 
-    async def get_output_partition(self, i: int, key: str) -> pd.DataFrame:
+    async def get_output_partition(
+        self, i: int, key: str, meta: pd.DataFrame | None = None
+    ) -> pd.DataFrame:
         self.raise_if_closed()
+        assert meta is not None
         assert self.transferred, "`get_output_partition` called before barrier task"
 
         await self._ensure_output_worker(i, key)
 
         await self.flush_receive()
         try:
             data = self._read_from_disk((i,))
 
             def _() -> pd.DataFrame:
-                df = convert_partition(data)
-                return df.to_pandas()
+                return convert_partition(data, meta)  # type: ignore
 
             out = await self.offload(_)
         except KeyError:
-            out = self.schema.empty_table().to_pandas()
+            out = meta.copy()
         return out
 
     def _get_assigned_worker(self, i: int) -> str:
         return self.worker_for[i]
 
 
 class ShuffleWorkerExtension:
@@ -645,16 +645,14 @@
         self,
         data: Any,
         input_partition: int | tuple[int, ...],
         shuffle_id: ShuffleId,
         type: ShuffleType,
         **kwargs: Any,
     ) -> int:
-        if type == ShuffleType.DATAFRAME:
-            kwargs["empty"] = data
         shuffle = self.get_or_create_shuffle(shuffle_id, type=type, **kwargs)
         return sync(
             self.worker.loop,
             shuffle.add_partition,
             data=data,
             input_partition=input_partition,
         )
@@ -719,20 +717,16 @@
     ) -> ShuffleRun:
         """Get or create a shuffle matching the ID and data spec.
 
         Parameters
         ----------
         shuffle_id
             Unique identifier of the shuffle
-        empty
-            Empty metadata of input collection
-        column
-            Column to be used to map rows to output partitions (by hashing)
-        npartitions
-            Number of output partitions
+        type:
+            Type of the shuffle operation
         """
         shuffle = self.shuffles.get(shuffle_id, None)
         if shuffle is None:
             shuffle = await self._refresh_shuffle(
                 shuffle_id=shuffle_id,
                 type=type,
                 kwargs=kwargs,
@@ -770,24 +764,19 @@
     ) -> ShuffleRun:
         if type is None:
             result = await self.worker.scheduler.shuffle_get(
                 id=shuffle_id,
                 worker=self.worker.address,
             )
         elif type == ShuffleType.DATAFRAME:
-            import pyarrow as pa
-
             assert kwargs is not None
             result = await self.worker.scheduler.shuffle_get_or_create(
                 id=shuffle_id,
                 type=type,
                 spec={
-                    "schema": pa.Schema.from_pandas(kwargs["empty"])
-                    .serialize()
-                    .to_pybytes(),
                     "npartitions": kwargs["npartitions"],
                     "column": kwargs["column"],
                     "parts_out": kwargs["parts_out"],
                 },
                 worker=self.worker.address,
             )
         elif type == ShuffleType.ARRAY_RECHUNK:
@@ -825,15 +814,14 @@
                 self.worker._ongoing_background_tasks.call_soon(_, self, existing)
         shuffle: ShuffleRun
         if result["type"] == ShuffleType.DATAFRAME:
             shuffle = DataFrameShuffleRun(
                 column=result["column"],
                 worker_for=result["worker_for"],
                 output_workers=result["output_workers"],
-                schema=deserialize_schema(result["schema"]),
                 id=shuffle_id,
                 run_id=result["run_id"],
                 directory=os.path.join(
                     self.worker.local_directory,
                     f"shuffle-{shuffle_id}-{result['run_id']}",
                 ),
                 executor=self._executor,
@@ -912,25 +900,33 @@
             self._get_or_create_shuffle,
             shuffle_id,
             type,
             **kwargs,
         )
 
     def get_output_partition(
-        self, shuffle_id: ShuffleId, run_id: int, output_partition: int | NIndex
+        self,
+        shuffle_id: ShuffleId,
+        run_id: int,
+        output_partition: int | NIndex,
+        meta: pd.DataFrame | None = None,
     ) -> Any:
         """
         Task: Retrieve a shuffled output partition from the ShuffleExtension.
 
         Calling this for a ``shuffle_id`` which is unknown or incomplete is an error.
         """
         shuffle = self.get_shuffle_run(shuffle_id, run_id)
         key = thread_state.key
         return sync(
-            self.worker.loop, shuffle.get_output_partition, output_partition, key
+            self.worker.loop,
+            shuffle.get_output_partition,
+            output_partition,
+            key,
+            meta=meta,
         )
 
 
 def split_by_worker(
     df: pd.DataFrame,
     column: str,
     worker_for: pd.Series,
```

### Comparing `distributed-2023.5.1/distributed/sizeof.py` & `distributed-2023.6.0/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/spill.py` & `distributed-2023.6.0/distributed/spill.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/stealing.py` & `distributed-2023.6.0/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/system.py` & `distributed-2023.6.0/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/system_monitor.py` & `distributed-2023.6.0/distributed/system_monitor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/threadpoolexecutor.py` & `distributed-2023.6.0/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/utils.py` & `distributed-2023.6.0/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/utils_comm.py` & `distributed-2023.6.0/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/utils_perf.py` & `distributed-2023.6.0/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/utils_test.py` & `distributed-2023.6.0/distributed/utils_test.py`

 * *Files 0% similar despite different names*

```diff
@@ -2573,7 +2573,28 @@
     def __sizeof__(self) -> int:
         return self._nbytes
 
 
 def gen_nbytes(nbytes: int) -> SizeOf:
     """A function that emulates exactly nbytes on the worker data structure."""
     return SizeOf(nbytes)
+
+
+def relative_frame_linenumber(frame):
+    """Line number of call relative to the frame"""
+    return inspect.getframeinfo(frame).lineno - frame.f_code.co_firstlineno
+
+
+class NoSchedulerDelayWorker(Worker):
+    """Custom worker class which does not update `scheduler_delay`.
+
+    This worker class is useful for some tests which make time
+    comparisons using times reported from workers.
+    """
+
+    @property
+    def scheduler_delay(self):
+        return 0
+
+    @scheduler_delay.setter
+    def scheduler_delay(self, value):
+        pass
```

### Comparing `distributed-2023.5.1/distributed/variable.py` & `distributed-2023.6.0/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/versions.py` & `distributed-2023.6.0/distributed/versions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/client.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/cluster.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/computation.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/future.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/has_what.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/log.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/process_interface.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2023.6.0/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/worker.py` & `distributed-2023.6.0/distributed/worker.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 from __future__ import annotations
 
 import asyncio
 import bisect
 import builtins
 import contextlib
+import contextvars
 import errno
 import logging
 import math
 import os
 import pathlib
 import random
 import sys
@@ -88,14 +89,15 @@
 from distributed.proctitle import setproctitle
 from distributed.protocol import pickle, to_serialize
 from distributed.protocol.serialize import _is_dumpable
 from distributed.pubsub import PubSubWorkerExtension
 from distributed.security import Security
 from distributed.shuffle import ShuffleWorkerExtension
 from distributed.sizeof import safe_sizeof as sizeof
+from distributed.spans import SpansWorkerExtension
 from distributed.threadpoolexecutor import ThreadPoolExecutor
 from distributed.threadpoolexecutor import secede as tpe_secede
 from distributed.utils import (
     TimeoutError,
     _maybe_complex,
     get_ip,
     has_arg,
@@ -167,14 +169,15 @@
 logger = logging.getLogger(__name__)
 
 LOG_PDB = dask.config.get("distributed.admin.pdb-on-err")
 
 DEFAULT_EXTENSIONS: dict[str, type] = {
     "pubsub": PubSubWorkerExtension,
     "shuffle": ShuffleWorkerExtension,
+    "spans": SpansWorkerExtension,
 }
 
 DEFAULT_METRICS: dict[str, Callable[[Worker], Any]] = {}
 
 DEFAULT_STARTUP_INFORMATION: dict[str, Callable[[Worker], Any]] = {}
 
 WORKER_ANY_RUNNING = {
@@ -1051,16 +1054,14 @@
                 "outgoing_bytes": self.transfer_outgoing_bytes,
                 "outgoing_count": self.transfer_outgoing_count,
                 "outgoing_count_total": self.transfer_outgoing_count_total,
             },
             event_loop_interval=self._tick_interval_observed,
         )
 
-        self.digests_total_since_heartbeat.clear()
-
         monitor_recent = self.monitor.recent()
         # Convert {foo.bar: 123} to {foo: {bar: 123}}
         for k, v in monitor_recent.items():
             if "." in k:
                 k0, _, k1 = k.partition(".")
                 out.setdefault(k0, {})[k1] = v
             else:
@@ -1246,14 +1247,16 @@
                 },
                 extensions={
                     name: extension.heartbeat()
                     for name, extension in self.extensions.items()
                     if hasattr(extension, "heartbeat")
                 },
             )
+            self.digests_total_since_heartbeat.clear()
+
             end = time()
             middle = (start + end) / 2
 
             self._update_latency(end - start)
 
             if response["status"] == "missing":
                 # Scheduler thought we left. Reconnection is not supported, so just shut down.
@@ -2140,29 +2143,37 @@
         key = actor
         actor = self.state.actors[key]
         func = getattr(actor, function)
         name = key_split(key) + "." + function
 
         try:
             if iscoroutinefunction(func):
-                result = await func(*args, **kwargs)
+                token = _worker_cvar.set(self)
+                try:
+                    result = await func(*args, **kwargs)
+                finally:
+                    _worker_cvar.reset(token)
             elif separate_thread:
                 result = await self.loop.run_in_executor(
                     self.executors["actor"],
                     apply_function_actor,
                     func,
                     args,
                     kwargs,
                     self.execution_state,
                     name,
                     self.active_threads,
                     self.active_threads_lock,
                 )
             else:
-                result = func(*args, **kwargs)
+                token = _worker_cvar.set(self)
+                try:
+                    result = func(*args, **kwargs)
+                finally:
+                    _worker_cvar.reset(token)
             return {"status": "OK", "result": to_serialize(result)}
         except Exception as ex:
             return {"status": "error", "exception": to_serialize(ex)}
 
     def actor_attribute(self, actor=None, attribute=None) -> dict[str, Any]:
         try:
             value = getattr(self.state.actors[actor], attribute)
@@ -2234,20 +2245,24 @@
                     f"expected one of: {sorted(self.executors)}"
                 )
 
             self.active_keys.add(key)
             try:
                 ts.start_time = time()
                 if iscoroutinefunction(function):
-                    result = await apply_function_async(
-                        function,
-                        args2,
-                        kwargs2,
-                        self.scheduler_delay,
-                    )
+                    token = _worker_cvar.set(self)
+                    try:
+                        result = await apply_function_async(
+                            function,
+                            args2,
+                            kwargs2,
+                            self.scheduler_delay,
+                        )
+                    finally:
+                        _worker_cvar.reset(token)
                 elif "ThreadPoolExecutor" in str(type(e)):
                     # The 'executor' time metric should be almost zero most of the time,
                     # e.g. thread synchronization overhead only, since thread-noncpu and
                     # thread-cpu inside the thread detract from it. However, it may
                     # become substantial in case of misalignment between the size of the
                     # thread pool and the number of running tasks in the worker state
                     # machine (e.g. https://github.com/dask/distributed/issues/5882)
@@ -2661,14 +2676,17 @@
             "`Worker.transfer_outgoing_count_limit`",
             DeprecationWarning,
             stacklevel=2,
         )
         return self.transfer_outgoing_count_limit
 
 
+_worker_cvar: contextvars.ContextVar[Worker] = contextvars.ContextVar("_worker_cvar")
+
+
 def get_worker() -> Worker:
     """Get the worker currently running this task
 
     Examples
     --------
     >>> def f():
     ...     worker = get_worker()  # The worker on which this task is running
@@ -2680,16 +2698,16 @@
 
     See Also
     --------
     get_client
     worker_client
     """
     try:
-        return thread_state.execution_state["worker"]
-    except AttributeError:
+        return _worker_cvar.get()
+    except LookupError:
         raise ValueError("No worker found") from None
 
 
 def get_client(address=None, timeout=None, resolve_address=True) -> Client:
     """Get a client while within a task.
 
     This client connects to the same scheduler to which the worker is connected
@@ -3008,15 +3026,19 @@
     with active_threads_lock:
         active_threads[ident] = key
     with set_thread_state(
         start_time=time(),
         execution_state=execution_state,
         key=key,
     ):
-        msg = apply_function_simple(function, args, kwargs, time_delay)
+        token = _worker_cvar.set(execution_state["worker"])
+        try:
+            msg = apply_function_simple(function, args, kwargs, time_delay)
+        finally:
+            _worker_cvar.reset(token)
 
     with active_threads_lock:
         del active_threads[ident]
     return msg
 
 
 def apply_function_simple(
@@ -3141,15 +3163,19 @@
 
     with set_thread_state(
         start_time=time(),
         execution_state=execution_state,
         key=key,
         actor=True,
     ):
-        result = function(*args, **kwargs)
+        token = _worker_cvar.set(execution_state["worker"])
+        try:
+            result = function(*args, **kwargs)
+        finally:
+            _worker_cvar.reset(token)
 
         with active_threads_lock:
             del active_threads[ident]
 
         return result
```

### Comparing `distributed-2023.5.1/distributed/worker_client.py` & `distributed-2023.6.0/distributed/worker_client.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 from __future__ import annotations
 
+import contextlib
 import warnings
-from contextlib import contextmanager
 
 import dask
 
 from distributed.metrics import time
 from distributed.threadpoolexecutor import rejoin, secede
 from distributed.worker import get_client, get_worker, thread_state
 from distributed.worker_state_machine import SecedeEvent
 
 
-@contextmanager
+@contextlib.contextmanager
 def worker_client(timeout=None, separate_thread=True):
     """Get client for this thread
 
     This context manager is intended to be called within functions that we run
     on workers.  When run as a context manager it delivers a client
     ``Client`` object that can submit other tasks directly from that worker.
 
@@ -49,28 +49,32 @@
     if timeout is None:
         timeout = dask.config.get("distributed.comm.timeouts.connect")
 
     timeout = dask.utils.parse_timedelta(timeout, "s")
 
     worker = get_worker()
     client = get_client(timeout=timeout)
-    if separate_thread:
-        duration = time() - thread_state.start_time
-        secede()  # have this thread secede from the thread pool
-        worker.loop.add_callback(
-            worker.handle_stimulus,
-            SecedeEvent(
-                key=thread_state.key,
-                compute_duration=duration,
-                stimulus_id=f"worker-client-secede-{time()}",
-            ),
-        )
+    with contextlib.ExitStack() as stack:
+        if separate_thread:
+            try:
+                thread_state.start_time
+            except AttributeError:  # not in a synchronous task, can't secede
+                pass
+            else:
+                duration = time() - thread_state.start_time
+                secede()  # have this thread secede from the thread pool
+                stack.callback(rejoin)
+                worker.loop.add_callback(
+                    worker.handle_stimulus,
+                    SecedeEvent(
+                        key=thread_state.key,
+                        compute_duration=duration,
+                        stimulus_id=f"worker-client-secede-{time()}",
+                    ),
+                )
 
-    yield client
-
-    if separate_thread:
-        rejoin()
+        yield client
 
 
 def local_client(*args, **kwargs):
     warnings.warn("local_client has moved to worker_client")
     return worker_client(*args, **kwargs)
```

### Comparing `distributed-2023.5.1/distributed/worker_memory.py` & `distributed-2023.6.0/distributed/worker_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/distributed/worker_state_machine.py` & `distributed-2023.6.0/distributed/worker_state_machine.py`

 * *Files 1% similar despite different names*

```diff
@@ -293,14 +293,17 @@
     #: Metadata related to the task.
     #: Stored metadata should be msgpack serializable (e.g. int, string, list, dict).
     metadata: dict = field(default_factory=dict)
     #: The size of the value of the task, if in memory
     nbytes: int | None = None
     #: Arbitrary task annotations
     annotations: dict | None = None
+    #: unique span id (see ``distributed.spans``).
+    #: Matches ``distributed.scheduler.TaskState.group.span_id``.
+    span_id: str | None = None
     #: True if the :meth:`~WorkerBase.execute` or :meth:`~WorkerBase.gather_dep`
     #: coroutine servicing this task completed; False otherwise. This flag changes
     #: the behaviour of transitions out of the ``executing``, ``flight`` etc. states.
     done: bool = False
 
     _instances: ClassVar[weakref.WeakSet[TaskState]] = weakref.WeakSet()
 
@@ -761,14 +764,15 @@
     run_spec: SerializedTask | None
     function: bytes | None
     args: bytes | tuple | list | None | None
     kwargs: bytes | dict[str, Any] | None
     resource_restrictions: dict[str, float]
     actor: bool
     annotations: dict
+    span_id: str | None
 
     __slots__ = tuple(__annotations__)
 
     def __post_init__(self) -> None:
         # Fixes after msgpack decode
         if isinstance(self.priority, list):  # type: ignore[unreachable]
             self.priority = tuple(self.priority)  # type: ignore[unreachable]
@@ -827,14 +831,15 @@
             run_spec=None,
             function=None,
             args=None,
             kwargs=None,
             resource_restrictions=resource_restrictions or {},
             actor=actor,
             annotations=annotations or {},
+            span_id=None,
             stimulus_id=stimulus_id,
         )
 
 
 @dataclass
 class ExecuteDoneEvent(StateMachineEvent):
     """Abstract base event for all the possible outcomes of a :class:`Compute`
@@ -2873,14 +2878,15 @@
             ts.exception = None
             ts.traceback = None
             ts.exception_text = ""
             ts.traceback_text = ""
             ts.priority = priority
             ts.duration = ev.duration
             ts.annotations = ev.annotations
+            ts.span_id = ev.span_id
 
             # If we receive ComputeTaskEvent twice for the same task, resources may have
             # changed, but the task is still running. Preserve the previous resource
             # restrictions so that they can be properly released when it eventually
             # completes.
             if not (
                 ts.state in ("cancelled", "resumed")
@@ -3594,38 +3600,42 @@
     state: WorkerState
     _async_instructions: set[asyncio.Task]
 
     def __init__(self, state: WorkerState):
         self.state = state
         self._async_instructions = set()
 
-    def _start_async_instruction(
+    def _start_async_instruction(  # type: ignore[valid-type]
         self,
         task_name: str,
         func: Callable[P, Awaitable[StateMachineEvent]],
         /,
         *args: P.args,
+        span_id: str | None = None,
         **kwargs: P.kwargs,
     ) -> None:
         """Execute an asynchronous instruction inside an asyncio task"""
         ledger = DelayedMetricsLedger()
 
         @wraps(func)
         async def wrapper() -> StateMachineEvent:
             with ledger.record():
                 return await func(*args, **kwargs)
 
         task = asyncio.create_task(wrapper(), name=task_name)
         self._async_instructions.add(task)
-        task.add_done_callback(partial(self._finish_async_instruction, ledger=ledger))
+        task.add_done_callback(
+            partial(self._finish_async_instruction, ledger=ledger, span_id=span_id)
+        )
 
     def _finish_async_instruction(
         self,
         task: asyncio.Task[StateMachineEvent],
         ledger: DelayedMetricsLedger,
+        span_id: str | None,
     ) -> None:
         """The asynchronous instruction just completed; process the returned
         stimulus.
         """
         self._async_instructions.remove(task)
         try:
             # This *should* never raise any other exceptions
@@ -3637,24 +3647,28 @@
             logger.exception("async instruction handlers should never raise!")
             raise
 
         with ledger.record():
             # Capture metric events in _transition_to_memory()
             self.handle_stimulus(stim)
 
-        self._finalize_metrics(stim, ledger)
+        self._finalize_metrics(stim, ledger, span_id)
 
     def _finalize_metrics(
         self,
         stim: StateMachineEvent,
         ledger: DelayedMetricsLedger,
+        span_id: str | None = None,
     ) -> None:
-        activity: tuple[str, ...]
+        activity: tuple[str | None, ...]
         coarse_time: str | Literal[False]
 
+        if not isinstance(stim, ExecuteDoneEvent):
+            assert span_id is None
+
         if isinstance(stim, GatherDepSuccessEvent):
             activity = ("gather-dep",)
             for key in stim.data:
                 ts = self.state.tasks.get(key)
                 if ts and ts.state == "memory":
                     # At least one key was fetched and stored in memory
                     coarse_time = False
@@ -3667,34 +3681,32 @@
             coarse_time = "failed"
 
         elif isinstance(stim, GatherDepBusyEvent):
             activity = ("gather-dep",)
             coarse_time = "busy"
 
         elif isinstance(stim, ExecuteSuccessEvent):
-            activity = ("execute", key_split(stim.key))
+            activity = ("execute", span_id, key_split(stim.key))
             ts = self.state.tasks.get(stim.key)
             coarse_time = False if ts and ts.state == "memory" else "cancelled"
 
         elif isinstance(stim, ExecuteFailureEvent):
-            activity = ("execute", key_split(stim.key))
+            activity = ("execute", span_id, key_split(stim.key))
             coarse_time = "failed"
 
         elif isinstance(stim, RescheduleEvent):
-            activity = ("execute", key_split(stim.key))
+            activity = ("execute", span_id, key_split(stim.key))
             coarse_time = "cancelled"
 
         else:
             assert isinstance(stim, RetryBusyWorkerEvent), stim
             return
 
         for label, value, unit in ledger.finalize(coarse_time=coarse_time):
-            if not isinstance(label, tuple):
-                label = (label,)
-            self.digest_metric((*activity, *label, unit), value)
+            self.digest_metric((*activity, label, unit), value)
 
     def handle_stimulus(self, *stims: StateMachineEvent) -> None:
         """Forward one or more external stimuli to :meth:`WorkerState.handle_stimulus`
         and process the returned instructions, invoking the relevant Worker callbacks
         (``@abc.abstractmethod`` methods below).
 
         Spawn asyncio tasks for all asynchronous instructions and start tracking them.
@@ -3721,18 +3733,20 @@
                     inst.worker,
                     inst.to_gather,
                     total_nbytes=inst.total_nbytes,
                     stimulus_id=inst.stimulus_id,
                 )
 
             elif isinstance(inst, Execute):
+                ts = self.state.tasks[inst.key]
                 self._start_async_instruction(
                     f"execute({inst.key})",
                     self.execute,
                     inst.key,
+                    span_id=ts.span_id,
                     stimulus_id=inst.stimulus_id,
                 )
 
             elif isinstance(inst, RetryBusyWorkerLater):
                 self._start_async_instruction(
                     f"retry_busy_worker_later({inst.worker})",
                     self.retry_busy_worker_later,
```

### Comparing `distributed-2023.5.1/distributed.egg-info/PKG-INFO` & `distributed-2023.6.0/distributed.egg-info/PKG-INFO`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.5.1
+Version: 2023.6.0
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.5.1/distributed.egg-info/SOURCES.txt` & `distributed-2023.6.0/distributed.egg-info/SOURCES.txt`

 * *Files 0% similar despite different names*

```diff
@@ -42,14 +42,15 @@
 distributed/py.typed
 distributed/queues.py
 distributed/recreate_tasks.py
 distributed/scheduler.py
 distributed/security.py
 distributed/semaphore.py
 distributed/sizeof.py
+distributed/spans.py
 distributed/spill.py
 distributed/stealing.py
 distributed/system.py
 distributed/system_monitor.py
 distributed/threadpoolexecutor.py
 distributed/utils.py
 distributed/utils_comm.py
```

### Comparing `distributed-2023.5.1/docs/source/active_memory_manager.rst` & `distributed-2023.6.0/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/actors.rst` & `distributed-2023.6.0/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/api.rst` & `distributed-2023.6.0/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/asynchronous.rst` & `distributed-2023.6.0/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/changelog.rst` & `distributed-2023.6.0/docs/source/changelog.rst`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,49 @@
 Changelog
 =========
 
+.. _v2023.6.0:
+
+2023.6.0
+--------
+
+Released on June 9, 2023
+
+Enhancements
+^^^^^^^^^^^^
+- Post fine performance metrics to spans (:pr:`7885`) `crusaderky`_
+- Unique Spans (:pr:`7882`) `crusaderky`_
+- Add a ``timeout`` to ``client.as_completed`` that mirrors ``concurrent.futures.as_completed`` ``timeout`` (:pr:`7811`) `Thomas Grainger`_
+- Enforce dtypes in P2P shuffle (:pr:`7879`) `Hendrik Makait`_
+- Support ``load=`` keyword for ``Client.upload_file`` (:pr:`7873`) `James Bourbeau`_
+- Support ``get_worker()`` and ``worker_client()`` in async tasks (:pr:`7844`) `Thomas Grainger`_
+- Capture line number for code frames (:pr:`7786`) `Miles`_
+
+Bug Fixes
+^^^^^^^^^
+- Avoid meta roundtrip in P2P shuffle (:pr:`7895`) `Hendrik Makait`_
+- Fix Fine Performance Metrics mis-aligned ``ColumnData`` lengths (:pr:`7893`) `Miles`_
+- Fix Fine Performance Metrics spilling crash (:pr:`7878`) `Miles`_
+- Fix spans bug when ``scatter`` or ``client_desires_new_key`` creates a task (:pr:`7886`) `crusaderky`_
+- Fix Fine Performance Metrics w/ Bokeh 3 (:pr:`7874`) `Miles`_
+- ``TaskGroup.start`` can move backwards (:pr:`7867`) `crusaderky`_
+- Use properly imported ``MatDescriptor`` for ``cupy`` dispatch registration (:pr:`7868`) `Charles Blackmon-Luca`_
+- Ensure ``retire_workers`` works if AMM extension hasn't been loaded (:pr:`7863`) `crusaderky`_
+
+Maintenance
+^^^^^^^^^^^
+- Review user-defined fine performance metrics (:pr:`7894`) `crusaderky`_
+- Fix tests that disable the shuffle extension (:pr:`7883`) `crusaderky`_
+- Refactor ``Scheduler.is_idle`` (:pr:`7881`) `crusaderky`_
+- Link TaskGroups to Spans (:pr:`7869`) `crusaderky`_
+- Spans skeleton (:pr:`7862`) `crusaderky`_
+- Update gpuCI ``RAPIDS_VER`` to ``23.08`` (:pr:`7855`)
+- Bump ``JamesIves/github-pages-deploy-action`` from 4.4.1 to 4.4.2 (:pr:`7865`)
+
+
 .. _v2023.5.1:
 
 2023.5.1
 --------
 
 Released on May 26, 2023
```

### Comparing `distributed-2023.5.1/docs/source/client.rst` & `distributed-2023.6.0/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/communications.rst` & `distributed-2023.6.0/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/develop.rst` & `distributed-2023.6.0/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/diagnosing-performance.rst` & `distributed-2023.6.0/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/efficiency.rst` & `distributed-2023.6.0/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/examples/word-count.rst` & `distributed-2023.6.0/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/faq.rst` & `distributed-2023.6.0/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/foundations.rst` & `distributed-2023.6.0/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/http_services.rst` & `distributed-2023.6.0/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/index.rst` & `distributed-2023.6.0/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/install.rst` & `distributed-2023.6.0/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/journey.rst` & `distributed-2023.6.0/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/killed.rst` & `distributed-2023.6.0/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/limitations.rst` & `distributed-2023.6.0/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/locality.rst` & `distributed-2023.6.0/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/logging.rst` & `distributed-2023.6.0/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/manage-computation.rst` & `distributed-2023.6.0/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/memory.rst` & `distributed-2023.6.0/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/plugins.rst` & `distributed-2023.6.0/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/priority.rst` & `distributed-2023.6.0/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/prometheus.rst` & `distributed-2023.6.0/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/protocol.rst` & `distributed-2023.6.0/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/publish.rst` & `distributed-2023.6.0/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/quickstart.rst` & `distributed-2023.6.0/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/related-work.rst` & `distributed-2023.6.0/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/resilience.rst` & `distributed-2023.6.0/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/resources.rst` & `distributed-2023.6.0/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/scheduling-policies.rst` & `distributed-2023.6.0/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/scheduling-state.rst` & `distributed-2023.6.0/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/serialization.rst` & `distributed-2023.6.0/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/task-launch.rst` & `distributed-2023.6.0/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/tls.rst` & `distributed-2023.6.0/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/work-stealing.rst` & `distributed-2023.6.0/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/worker-memory.rst` & `distributed-2023.6.0/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/worker-state.rst` & `distributed-2023.6.0/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/docs/source/worker.rst` & `distributed-2023.6.0/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.5.1/pyproject.toml` & `distributed-2023.6.0/pyproject.toml`

 * *Files 1% similar despite different names*

```diff
@@ -23,15 +23,15 @@
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
 requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2023.5.1",
+    "dask == 2023.6.0",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
     "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
@@ -182,14 +182,15 @@
 module = ["distributed.client", "distributed.worker"]
 allow_incomplete_defs = true
 
 [[tool.mypy.overrides]]
 # Recent or recently overhauled modules featuring stricter validation
 module = [
     "distributed.active_memory_manager",
+    "distributed.spans",
     "distributed.system_monitor",
     "distributed.worker_memory",
     "distributed.worker_state_machine",
     "distributed.config",
     "distributed.shuffle.*",
 ]
 allow_untyped_defs = false
```

